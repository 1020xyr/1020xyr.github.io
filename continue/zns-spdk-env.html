

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg">
  <link rel="icon" href="/img/nano-1.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="最佳损友1020">
  <meta name="keywords" content="">
  
    <meta name="description" content="开发步骤相似代码： leveldb-direct ZapRAID论文代码 leveldb自定义env 代码仓库： zns-spdk-env 参考文档： SPDK Libraries Linking SPDK applications with pkg-config 1 熟悉API使用目标：使用spdk bdev接口清空ZNS SSD，写满若干个zone并读取验证，熟悉基本的API">
<meta property="og:type" content="article">
<meta property="og:title" content="zns-spdk-env">
<meta property="og:url" content="https://www.jiasun.top/continue/zns-spdk-env.html">
<meta property="og:site_name" content="最佳损友1020’s Blog">
<meta property="og:description" content="开发步骤相似代码： leveldb-direct ZapRAID论文代码 leveldb自定义env 代码仓库： zns-spdk-env 参考文档： SPDK Libraries Linking SPDK applications with pkg-config 1 熟悉API使用目标：使用spdk bdev接口清空ZNS SSD，写满若干个zone并读取验证，熟悉基本的API">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141703690.png">
<meta property="article:published_time" content="2023-11-09T08:23:38.414Z">
<meta property="article:modified_time" content="2024-01-05T07:01:01.191Z">
<meta property="article:author" content="最佳损友1020">
<meta property="article:tag" content="zns ssd spdk leveldb env">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141703690.png">
  
  
  
  <title>zns-spdk-env - 最佳损友1020’s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn.css">
<link rel="stylesheet" href="/css/top.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.jiasun.top","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz","app_key":"ljkRZDiTtVmjn5mpaQmpFqgv","server_url":"https://n227fxnj.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>最佳损友1020</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="zns-spdk-env"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-09 16:23" pubdate>
          2023年11月9日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          125k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1042 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">zns-spdk-env</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />







<h2 id="开发步骤"><a href="#开发步骤" class="headerlink" title="开发步骤"></a>开发步骤</h2><p>相似代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ls4154/leveldb-direct">leveldb-direct</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fallfish/zapraid">ZapRAID论文代码</a></p>
<p><a href="https://www.jiasun.top/blog/leveldb%E8%87%AA%E5%AE%9A%E4%B9%89env.html">leveldb自定义env</a></p>
<p>代码仓库：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/1020xyr/zns-spdk-env">zns-spdk-env</a></p>
<p>参考文档：</p>
<p><a target="_blank" rel="noopener" href="https://spdk.io/doc/libraries.html">SPDK Libraries</a></p>
<p><a target="_blank" rel="noopener" href="https://spdk.io/doc/pkgconfig.html">Linking SPDK applications with pkg-config</a></p>
<h2 id="1-熟悉API使用"><a href="#1-熟悉API使用" class="headerlink" title="1 熟悉API使用"></a>1 熟悉API使用</h2><p><strong>目标：</strong>使用spdk bdev接口清空ZNS SSD，写满若干个zone并读取验证，熟悉基本的API</p>
<h3 id="如何编译？"><a href="#如何编译？" class="headerlink" title="如何编译？"></a>如何编译？</h3><p>拷贝examples&#x2F;bdev&#x2F;hello_world&#x2F;hello_bdev.c代码，在外部编译</p>
<p>刚开始参考官方文档：<a target="_blank" rel="noopener" href="https://spdk.io/doc/libraries.html">SPDK Libraries</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 An application can <span class="hljs-built_in">link</span> to the top level shared object library as follows:<br>gcc -o my_app ./my_app.c -lspdk -lspdk_env_dpdk -ldpdk<br>2 An application can <span class="hljs-built_in">link</span> to only a subset of libraries by linking directly to the ones it relies on:<br>gcc -o my_app ./my_app.c -lpassthru_external -lspdk_event_bdev -lspdk_bdev -lspdk_bdev_malloc<br>-lspdk_log -lspdk_thread -lspdk_util -lspdk_event -lspdk_env_dpdk -ldpdk<br></code></pre></td></tr></table></figure>

<p>显示&#x2F;usr&#x2F;bin&#x2F;ld: cannot find -ldpdk</p>
<p>阅读leveldb-direct与ZapRAID相关编译文件</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-comment"># leveldb-direct</span><br><span class="hljs-keyword">target_link_libraries</span>(leveldb<br>  spdk_nvme spdk_thread spdk_util spdk_log spdk_sock spdk_vmd spdk_env_dpdk<br>  dpdk rte_bus_pci rte_bus_vdev rte_cmdline rte_compressdev rte_cryptodev rte_eal rte_ethdev<br>  rte_fib rte_hash rte_kvargs rte_mbuf rte_mempool rte_mempool_bucket rte_mempool_ring rte_meter<br>  rte_net rte_pci rte_rib rte_ring rte_vhost<br>  numa dl uuid<br>)<br><span class="hljs-comment"># ZapRAID</span><br><span class="hljs-keyword">target_link_libraries</span>(zapraid -L<span class="hljs-variable">$&#123;SPDK_DIR&#125;</span>/build/lib -L<span class="hljs-variable">$&#123;SPDK_DIR&#125;</span>/dpdk/build/lib<br>	-Wl,--whole-archive -Wl,--no-as-needed -Wl,-Bstatic <br>	spdk_json spdk_jsonrpc spdk_rpc<br>	spdk_log spdk_sock spdk_util spdk_trace<br>	spdk_thread spdk_nvme<br>        spdk_init spdk_env_dpdk_rpc spdk_event<br>	-Wl,--no-whole-archive -Wl,-Bdynamic <br>	spdk_env_dpdk rte_mempool rte_telemetry<br>	rte_eal rte_kvargs rte_pci rte_bus_pci rte_ring rte_mempool_ring<br>	pthread uuid rt isal dl)<br></code></pre></td></tr></table></figure>

<p>发现都是采用链接rte_xxx的方式，不知道-ldpdk是否真的能用</p>
<p>在github上搜索spdk demo，找到了<a target="_blank" rel="noopener" href="https://github.com/KinderRiven/spdk-demo">spdk-demo</a>，参考它的方式编写Makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CC := g++<br><br><span class="hljs-comment"># All libs</span><br>ALL_SPDK_LIBS := spdk_accel_ioat spdk_blobfs spdk_jsonrpc \<br>spdk_accel_modules     spdk_blob           spdk_log \<br>spdk_accel             spdk_conf           spdk_lvol \<br>spdk_bdev_aio          spdk_dpdklibs       spdk_nbd \<br>spdk_bdev_delay        spdk_env_dpdk       spdk_net \<br>spdk_bdev_error        spdk_env_dpdk_rpc   spdk_notify \<br>spdk_bdev_ftl          spdk_event_accel    spdk_nvme \<br>spdk_bdev_gpt          spdk_event_bdev     spdk_nvmf \<br>spdk_bdev_lvol         spdk_event_iscsi    spdk_rpc \<br>spdk_bdev_malloc       spdk_event_nbd      spdk_scsi \<br>spdk_bdev_modules      spdk_event_net      spdk_sock_modules \<br>spdk_bdev_null         spdk_event_nvmf     spdk_sock \<br>spdk_bdev_nvme         spdk_event          spdk_sock_posix \<br>spdk_bdev_passthru     spdk_event_scsi     spdk_syslibs \<br>spdk_bdev              spdk_event_sock     spdk_thread \<br>spdk_bdev_raid         spdk_event_vhost    spdk_trace \<br>spdk_bdev_split        spdk_event_vmd      spdk_util \<br>spdk_bdev_virtio       spdk_ftl            \<br>spdk_bdev_zone_block   spdk_ioat           spdk_vhost \<br>spdk_blob_bdev         spdk_iscsi          spdk_virtio \<br>spdk_blobfs_bdev       spdk_json           spdk_vmd	\<br>spdk_thread<br><br><span class="hljs-comment"># PKG-CONFIG</span><br>SPDK_BUILD_DIR=/home/hanshukai/import_libs/spdk/build/lib<br>SPDK_PKG_CONFIG_PATH=<span class="hljs-variable">$(SPDK_BUILD_DIR)</span>/pkgconfig<br>SPDK_LINK_FLAGS := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> PKG_CONFIG_PATH=&quot;<span class="hljs-variable">$(SPDK_PKG_CONFIG_PATH)</span>&quot; pkg-config --cflags --libs <span class="hljs-variable">$(ALL_SPDK_LIBS)</span>)</span><br>SPDK_SYSLIB_FLAGS := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> PKG_CONFIG_PATH=&quot;<span class="hljs-variable">$(SPDK_PKG_CONFIG_PATH)</span>&quot; pkg-config --cflags --libs --static spdk_syslibs)</span><br><br><br>DPDK_BUILD_DIR=/home/hanshukai/import_libs/spdk/dpdk/build/lib<br>DPDK_PKG_CONFIG_PATH=<span class="hljs-variable">$(DPDK_BUILD_DIR)</span>/pkgconfig<br>DPDK_LINK_FLAGS := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> PKG_CONFIG_PATH=&quot;<span class="hljs-variable">$(DPDK_PKG_CONFIG_PATH)</span>&quot; pkg-config --cflags --libs libdpdk)</span><br><br>LINK_FLAGS := -lpthread -lrt -lnuma -ldl -luuid -lm -lisal<br><br><span class="hljs-section">all: reactor_demo bdev_demo</span><br><br><span class="hljs-section">reactor_demo: clean</span><br>	<span class="hljs-variable">$(CC)</span> --std=c++11 reactor_demo.cc -o reactor_demo  <span class="hljs-variable">$(LINK_FLAGS)</span> -Wl,--whole-archive <span class="hljs-variable">$(SPDK_LINK_FLAGS)</span>  <span class="hljs-variable">$(DPDK_LINK_FLAGS)</span> -Wl,--no-whole-archive <span class="hljs-variable">$(SPDK_SYSLIB_FLAGS)</span><br><br><span class="hljs-section">bdev_demo: clean</span><br>	<span class="hljs-variable">$(CC)</span> --std=c++11 bdev_demo.cc -o bdev_demo  <span class="hljs-variable">$(LINK_FLAGS)</span> -Wl,--whole-archive <span class="hljs-variable">$(SPDK_LINK_FLAGS)</span>  <span class="hljs-variable">$(DPDK_LINK_FLAGS)</span> -Wl,--no-whole-archive <span class="hljs-variable">$(SPDK_SYSLIB_FLAGS)</span><br><br><span class="hljs-section">clean:</span><br>	rm -rf reactor_demo bdev_demo<br><br><span class="hljs-section">export:</span><br>    <span class="hljs-keyword">export</span> LD_LIBRARY_PATH=/home/hanshukai/import_libs/spdk/build/lib:/home/hanshukai/import_libs/spdk/dpdk/build/lib<br><br></code></pre></td></tr></table></figure>



<p>pkconfig中的pc示例，简要了解pkconfig命令原理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># build/lib/pkgconfig/spdk_bdev.pc</span><br>Description: SPDK bdev library<br>Name: spdk_bdev<br>Version: 13.0<br>Libs: -L/root/xxx/spdk/build/lib  -lspdk_bdev<br>Requires: spdk_accel spdk_log spdk_util spdk_thread spdk_json spdk_jsonrpc spdk_rpc spdk_notify spdk_trace spdk_dma spdk_bdev_modules<br>Libs.private: <br>Cflags: -I/root/xxx/spdk/build/include<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://spdk.io/doc/pkgconfig.html">Linking SPDK applications with pkg-config</a></p>
<p>相关编译选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">-Wl,--whole-archive<br><br>gcc<br>-Wl,&lt;options&gt;            Pass comma-separated &lt;options&gt; on to the linker.<br>-llibrary	制定编译的时候使用的库<br>-Ldir 制定编译的时候，搜索库的路径。比如你自己的库，可以用它制定目录，不然编译器将只在标准库的目录找。这个<span class="hljs-built_in">dir</span>就是目录的名称。<br><br>ld<br>  --whole-archive             Include all objects from following archives<br>  --no-whole-archive          Turn off --whole-archive<br><br>  --as-needed                 Only <span class="hljs-built_in">set</span> DT_NEEDED <span class="hljs-keyword">for</span> following dynamic libs <span class="hljs-keyword">if</span> used<br>  --no-as-needed              Always <span class="hljs-built_in">set</span> DT_NEEDED <span class="hljs-keyword">for</span> dynamic libraries mentioned on<br>  -rpath PATH                 Set runtime shared library search path<br>  -rpath-link PATH            Set <span class="hljs-built_in">link</span> time shared library search path<br></code></pre></td></tr></table></figure>

<h4 id="静态库编译"><a href="#静态库编译" class="headerlink" title="静态库编译"></a>静态库编译</h4><p>运行时出现以下问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[2023-11-14 09:43:32.184966] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-11-14 09:43:32.185063] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid1610101 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-11-14 09:43:32.193459] app.c: 657:claim_cpu_cores: *ERROR*: Cannot create lock on core 0, probably process 1609753 has claimed it.<br>[2023-11-14 09:43:32.193488] app.c: 779:spdk_app_start: *ERROR*: Unable to acquire lock on assigned core mask - exiting.<br>[2023-11-14 09:43:32.193495] test.c: 308:main: *ERROR*: ERROR starting application<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">Thread 1 <span class="hljs-string">&quot;test&quot;</span> hit Breakpoint 4, rte_mempool_set_ops_byname (mp=0x7fffffffd970, name=0x340048 &lt;error: Cannot access memory at address 0x340048&gt;, pool_config=0x7fffffffdb10) at ../lib/mempool/rte_mempool_ops.c:167<br>167     &#123;<br>(gdb) bt<br><span class="hljs-comment">#0  rte_mempool_set_ops_byname (mp=0x7fffffffd970, name=0x340048 &lt;error: Cannot access memory at address 0x340048&gt;, pool_config=0x7fffffffdb10) at ../lib/mempool/rte_mempool_ops.c:167</span><br><span class="hljs-comment">#1  0x00007ffff7e7fe5c in rte_mempool_create (name=0x7fffffffdb10 &quot;evtpool_1608924&quot;, n=262143, elt_size=32, cache_size=512, private_data_size=0, mp_init=0x0, mp_init_arg=0x0, obj_init=0x0, obj_init_arg=0x0, socket_id=-1, flags=0) at ../lib/mempool/rte_mempool.c:976</span><br><span class="hljs-comment">#2  0x0000555555569ed8 in spdk_mempool_create_ctor (name=0x7fffffffdb10 &quot;evtpool_1608924&quot;, count=262143, ele_size=32, cache_size=512, socket_id=-1, obj_init=0x0, obj_init_arg=0x0) at env.c:182</span><br><span class="hljs-comment">#3  0x0000555555569f34 in spdk_mempool_create (name=0x7fffffffdb10 &quot;evtpool_1608924&quot;, count=262143, ele_size=32, cache_size=18446744073709551615, socket_id=-1) at env.c:194</span><br><span class="hljs-comment">#4  0x000055555569edc8 in spdk_reactors_init (msg_mempool_size=262143) at reactor.c:217</span><br><span class="hljs-comment">#5  0x000055555569cf52 in spdk_app_start (opts_user=0x7fffffffdeb0, start_fn=0x555555569017 &lt;hello_start&gt;, arg1=0x7fffffffde50) at app.c:788</span><br><span class="hljs-comment">#6  0x0000555555569408 in main (argc=1, argv=0x7fffffffe0a8) at test.c:306</span><br>(gdb) s<br>168             struct rte_mempool_ops *ops = NULL;<br>(gdb) p name<br><span class="hljs-variable">$5</span> = 0x7ffff7e84176 <span class="hljs-string">&quot;ring_mp_mc&quot;</span><br>(gdb) p c<br><span class="hljs-variable">$6</span> = &#123;sl = &#123;locked = 0&#125;, num_ops = 0, ops = &#123;&#123;name = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 31 <span class="hljs-built_in">times</span>&gt;, alloc = 0x0, free = 0x0, enqueue = 0x0, dequeue = 0x0, get_count = 0x0, calc_mem_size = 0x0, populate = 0x0, get_info = 0x0, dequeue_contig_blocks = 0x0&#125; &lt;repeats 16 <span class="hljs-built_in">times</span>&gt;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>通过gdb调试发现rte_mempool_ops_table为空</p>
<p>对比标准的hello_bdev程序显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">gdb) bt<br><span class="hljs-comment">#0  rte_mempool_set_ops_byname (mp=0x7fffffffd970, name=0x1720048 &lt;error: Cannot access memory at address 0x1720048&gt;, pool_config=0x7fffffffdb10) at ../lib/mempool/rte_mempool_ops.c:167</span><br><span class="hljs-comment">#1  0x00005555557e3e31 in rte_mempool_create (name=0x7fffffffdb10 &quot;evtpool_1609753&quot;, n=262143, elt_size=32, cache_size=512, private_data_size=0, mp_init=0x0, mp_init_arg=0x0, obj_init=0x0, obj_init_arg=0x0, socket_id=-1, </span><br>    flags=0) at ../lib/mempool/rte_mempool.c:976<br><span class="hljs-comment">#2  0x0000555555657766 in spdk_mempool_create_ctor (name=0x7fffffffdb10 &quot;evtpool_1609753&quot;, count=262143, ele_size=32, cache_size=512, socket_id=-1, obj_init=0x0, obj_init_arg=0x0) at env.c:182</span><br><span class="hljs-comment">#3  0x00005555556577c2 in spdk_mempool_create (name=0x7fffffffdb10 &quot;evtpool_1609753&quot;, count=262143, ele_size=32, cache_size=18446744073709551615, socket_id=-1) at env.c:194</span><br><span class="hljs-comment">#4  0x0000555555677811 in spdk_reactors_init (msg_mempool_size=262143) at reactor.c:217</span><br><span class="hljs-comment">#5  0x000055555567599b in spdk_app_start (opts_user=0x7fffffffdeb0, start_fn=0x555555570317 &lt;hello_start&gt;, arg1=0x7fffffffde50) at app.c:788</span><br><span class="hljs-comment">#6  0x00005555555706f9 in main (argc=1, argv=0x7fffffffe098) at hello_bdev.c:306</span><br>(gdb) s<br>168             struct rte_mempool_ops *ops = NULL;<br>(gdb) p name<br><span class="hljs-variable">$1</span> = 0x555555a07a36 <span class="hljs-string">&quot;ring_mp_mc&quot;</span><br>(gdb) p rte_mempool_ops_table<br><span class="hljs-variable">$2</span> = &#123;sl = &#123;locked = 0&#125;, num_ops = 6, ops = &#123;&#123;name = <span class="hljs-string">&quot;ring_mp_mc&quot;</span>, <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 21 <span class="hljs-built_in">times</span>&gt;, alloc = 0x5555557ef19e &lt;common_ring_alloc&gt;, free = 0x5555557ef232 &lt;common_ring_free&gt;, <br><span class="hljs-comment"># 以下省略</span><br></code></pre></td></tr></table></figure>

<p>对应的源码文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rte_mempool_ring.c</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The following 4 declarations of mempool ops structs address</span><br><span class="hljs-comment"> * the need for the backward compatible mempool handlers for</span><br><span class="hljs-comment"> * single/multi producers and single/multi consumers as dictated by the</span><br><span class="hljs-comment"> * flags provided to the rte_mempool_create function</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_mp_mc</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_mp_mc&quot;</span>,<br>	.alloc = common_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = common_ring_mp_enqueue,<br>	.dequeue = common_ring_mc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_sp_sc</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_sp_sc&quot;</span>,<br>	.alloc = common_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = common_ring_sp_enqueue,<br>	.dequeue = common_ring_sc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_mp_sc</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_mp_sc&quot;</span>,<br>	.alloc = common_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = common_ring_mp_enqueue,<br>	.dequeue = common_ring_sc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_sp_mc</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_sp_mc&quot;</span>,<br>	.alloc = common_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = common_ring_sp_enqueue,<br>	.dequeue = common_ring_mc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br><br><span class="hljs-comment">/* ops for mempool with ring in MT_RTS sync mode */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_mt_rts</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_mt_rts&quot;</span>,<br>	.alloc = rts_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = rts_ring_mp_enqueue,<br>	.dequeue = rts_ring_mc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br><br><span class="hljs-comment">/* ops for mempool with ring in MT_HTS sync mode */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rte_mempool_ops</span> <span class="hljs-title">ops_mt_hts</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;ring_mt_hts&quot;</span>,<br>	.alloc = hts_ring_alloc,<br>	.<span class="hljs-built_in">free</span> = common_ring_free,<br>	.enqueue = hts_ring_mp_enqueue,<br>	.dequeue = hts_ring_mc_dequeue,<br>	.get_count = common_ring_get_count,<br>&#125;;<br>RTE_MEMPOOL_REGISTER_OPS(ops_mp_mc);<br>RTE_MEMPOOL_REGISTER_OPS(ops_sp_sc);<br>RTE_MEMPOOL_REGISTER_OPS(ops_mp_sc);<br>RTE_MEMPOOL_REGISTER_OPS(ops_sp_mc);<br>RTE_MEMPOOL_REGISTER_OPS(ops_mt_rts);<br>RTE_MEMPOOL_REGISTER_OPS(ops_mt_hts);<br></code></pre></td></tr></table></figure>



<p>通过nm ldd命令对比test与hello_bdev不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash"> <span class="hljs-comment"># test与标准hello_bdev对比 </span><br> nm <span class="hljs-built_in">test</span> | grep ops_mt_hts<br><span class="hljs-comment"># 结果为空</span><br>nm hello_bdev | grep ops_mt_hts<br>000000000029b2c8 t mp_hdlr_init_ops_mt_hts<br>000000000052a3c0 d ops_mt_hts<br><br>ldd hello_bdev <br>        linux-vdso.so.1 (0x00007ffe33ff6000)<br>        libnuma.so.1 =&gt; /lib/x86_64-linux-gnu/libnuma.so.1 (0x00007f300a76b000)<br>        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f300a765000)<br>        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f300a75b000)<br>        libuuid.so.1 =&gt; /lib/x86_64-linux-gnu/libuuid.so.1 (0x00007f300a752000)<br>        libssl.so.1.1 =&gt; /lib/x86_64-linux-gnu/libssl.so.1.1 (0x00007f300a6bf000)<br>        libcrypto.so.1.1 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007f300a3e9000)<br>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f300a298000)<br>        libaio.so.1 =&gt; /lib/x86_64-linux-gnu/libaio.so.1 (0x00007f300a293000)<br>        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f300a270000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f300a07e000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007f300aeed000)<br>        <br> ldd <span class="hljs-built_in">test</span><br>        linux-vdso.so.1 (0x00007ffe55687000)<br>        librte_eal.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_eal.so.23 (0x00007f19b437f000)<br>        librte_mempool.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_mempool.so.23 (0x00007f19b436f000)<br>        librte_ring.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_ring.so.23 (0x00007f19b436a000)<br>        librte_bus_pci.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_bus_pci.so.23 (0x00007f19b4356000)<br>        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f19b434c000)<br>        libuuid.so.1 =&gt; /lib/x86_64-linux-gnu/libuuid.so.1 (0x00007f19b4343000)<br>        libssl.so.1.1 =&gt; /lib/x86_64-linux-gnu/libssl.so.1.1 (0x00007f19b42ae000)<br>        libcrypto.so.1.1 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007f19b3fd8000)<br>        libaio.so.1 =&gt; /lib/x86_64-linux-gnu/libaio.so.1 (0x00007f19b3fd3000)<br>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f19b3e84000)<br>        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f19b3e69000)<br>        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f19b3e46000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f19b3c52000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007f19b4799000)<br>        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f19b3c4c000)<br>        libnuma.so.1 =&gt; /lib/x86_64-linux-gnu/libnuma.so.1 (0x00007f19b3c3f000)<br>        librte_kvargs.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_kvargs.so.23 (0x00007f19b3c3a000)<br>        librte_telemetry.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_telemetry.so.23 (0x00007f19b3c2e000)<br>        librte_pci.so.23 =&gt; /root/xxx/spdk/dpdk/build/lib/librte_pci.so.23 (0x00007f19b3c27000)<br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong>编译时未将rte_mempool_ring包含进来，dpdk相关库仍然采用动态库编译</p>
<p>加上-Wl,-Bstatic强制链接静态库（由于是g++，故加上-fpermissive允许void*类型转换）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">g++ test.c  -fpermissive -pthread -g  -o <span class="hljs-built_in">test</span>  -Wl,--whole-archive -Wl,-Bstatic  -I/root/xxx/spdk/build/include -L/root/xxx/spdk/build/lib -L/root/xxx/spdk/dpdk/build/lib -L/root/xxx/spdk/build/lib -lspdk_env_dpdk -lrte_eal -lrte_mempool -lrte_ring -lrte_mbuf -lrte_bus_pci -lrte_pci -lrte_mempool_ring -lrte_telemetry -lrte_kvargs -lrte_rcu -lrte_power -lrte_ethdev -lrte_net -lrte_vhost -lrte_net -lrte_dmadev -lrte_cryptodev -lrte_hash -lspdk_bdev -lspdk_notify -lspdk_bdev_malloc -lspdk_bdev_null -lspdk_bdev_nvme -lspdk_bdev_passthru -lspdk_bdev_lvol -lspdk_bdev_raid -lspdk_accel -lspdk_accel_ioat -lspdk_ioat -lspdk_bdev_error -lspdk_bdev_gpt -lspdk_bdev_split -lspdk_bdev_delay -lspdk_bdev_zone_block -lspdk_blobfs_bdev -lspdk_blobfs -lspdk_blob_bdev -lspdk_lvol -lspdk_blob -lspdk_dma -lspdk_vmd -lspdk_nvme -lspdk_sock -lspdk_sock_posix -lspdk_bdev_aio -lspdk_bdev_ftl -lspdk_ftl -lspdk_bdev_virtio -lspdk_virtio -lspdk_thread -lspdk_trace -lspdk_rpc -lspdk_jsonrpc -lspdk_json -lspdk_util -lspdk_vfio_user -lspdk_log  -Wl,--no-whole-archive   -L/root/xxx/spdk/isa-l/.libs -L/root/xxx/spdk/isa-l-crypto/.libs -lisal -lisal_crypto -pthread -lrt -luuid -lssl -lcrypto -lm -laio -lnuma -ldl  <br>test.c:15:28: warning: ISO C++ forbids converting a string constant to ‘char*’ [-Wwrite-strings]<br>   15 | static char *g_bdev_name = <span class="hljs-string">&quot;Malloc0&quot;</span>;<br>      |                            ^~~~~~~~~<br>test.c: In <span class="hljs-keyword">function</span> ‘void read_complete(spdk_bdev_io*, bool, void*)’:<br>test.c:62:42: warning: invalid conversion from ‘void*’ to ‘hello_context_t*’ [-fpermissive]<br>   62 |  struct hello_context_t *hello_context = cb_arg;<br>      |                                          ^~~~~~<br>      |                                          |<br>      |                                          void*<br><span class="hljs-comment"># 省略一部分输出</span><br>/usr/bin/ld: /root/xxx/spdk/dpdk/build/lib/librte_net.a(net_rte_arp.c.o): <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> `rte_net_make_rarp_packet<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">/root/xxx/spdk/dpdk/build-tmp/../lib/net/rte_arp.c:11: multiple definition of `rte_net_make_rarp_packet&#x27;</span>; /root/xxx/spdk/dpdk/build/lib/librte_net.a(net_rte_arp.c.o):/root/xxx/spdk/dpdk/build-tmp/../lib/net/rte_arp.c:11: first defined here<br><span class="hljs-comment"># 省略一部分输出</span><br>/root/xxx/spdk/dpdk/build/lib/librte_net.a(net_crc_avx512.c.o):/root/xxx/spdk/dpdk/build-tmp/../lib/net/net_crc_avx512.c:414: first defined here<br>/usr/bin/ld: /root/xxx/spdk/dpdk/build/lib/librte_eal.a(eal_common_eal_common_options.c.o): <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> `eal_dlopen<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">/root/xxx/spdk/dpdk/build-tmp/../lib/eal/common/eal_common_options.c:466: warning: Using &#x27;</span>dlopen<span class="hljs-string">&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="hljs-string">/usr/bin/ld: cannot find -lgcc_s</span><br><span class="hljs-string">/usr/bin/ld: /root/xxx/spdk/dpdk/build/lib/librte_eal.a(eal_common_eal_common_trace_utils.c.o): in function `trace_dir_default_path_get&#x27;</span>:<br>/root/xxx/spdk/dpdk/build-tmp/../lib/eal/common/eal_common_trace_utils.c:288: warning: Using <span class="hljs-string">&#x27;getpwuid&#x27;</span> <span class="hljs-keyword">in</span> statically linked applications requires at runtime the shared libraries from the glibc version used <span class="hljs-keyword">for</span> linking<br>/usr/bin/ld: /root/xxx/spdk/build/lib/libspdk_nvme.a(nvme_tcp.o): <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> `nvme_tcp_parse_addr<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">/root/xxx/spdk/lib/nvme/nvme_tcp.c:277: warning: Using &#x27;</span>getaddrinfo<span class="hljs-string">&#x27; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</span><br><span class="hljs-string">/usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/libcrypto.a(b_sock.o): in function `BIO_gethostbyname&#x27;</span>:<br>(.text+0x75): warning: Using <span class="hljs-string">&#x27;gethostbyname&#x27;</span> <span class="hljs-keyword">in</span> statically linked applications requires at runtime the shared libraries from the glibc version used <span class="hljs-keyword">for</span> linking<br>/usr/bin/ld: cannot find -lgcc_s<br>collect2: error: ld returned 1 <span class="hljs-built_in">exit</span> status<br>make: *** [Makefile:9: <span class="hljs-built_in">test</span>] Error 1<br></code></pre></td></tr></table></figure>

<p>编译时出现重定义问题，未能解决，放弃静态库编译方式</p>
<h4 id="动态库编译"><a href="#动态库编译" class="headerlink" title="动态库编译"></a>动态库编译</h4><p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141100525.png" srcset="/img/loading.gif" lazyload></p>
<p>加上–with-shared选项重新编译spdk库</p>
<p>ubuntu下直接在&#x2F;etc&#x2F;ld.so.conf.d下加入spdk.conf，添加spdk与dpdk动态库搜索路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/xxx/spdk/dpdk/build/lib<br>/root/xxx/spdk/build/lib<br></code></pre></td></tr></table></figure>

<p>使用ldconfig更新，并使用ldconfig -v查看路径是否添加成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/xxx/spdk/dpdk/build/lib:<br>        librte_compressdev.so.23 -&gt; librte_compressdev.so.23.2<br>        librte_mempool_ring.so.23 -&gt; librte_mempool_ring.so.23.2<br>        librte_eal.so.23 -&gt; librte_eal.so.23.2<br>        librte_kvargs.so.23 -&gt; librte_kvargs.so.23.2<br>        librte_rcu.so.23 -&gt; librte_rcu.so.23.2<br>        librte_mempool.so.23 -&gt; librte_mempool.so.23.2<br>        librte_mbuf.so.23 -&gt; librte_mbuf.so.23.2<br>        librte_dmadev.so.23 -&gt; librte_dmadev.so.23.2<br>        librte_cryptodev.so.23 -&gt; librte_cryptodev.so.23.2<br>        librte_bus_vdev.so.23 -&gt; librte_bus_vdev.so.23.2<br>        librte_ethdev.so.23 -&gt; librte_ethdev.so.23.2<br>        librte_pci.so.23 -&gt; librte_pci.so.23.2<br>        librte_bus_pci.so.23 -&gt; librte_bus_pci.so.23.2<br>        librte_vhost.so.23 -&gt; librte_vhost.so.23.2<br>        librte_telemetry.so.23 -&gt; librte_telemetry.so.23.2<br>        librte_meter.so.23 -&gt; librte_meter.so.23.2<br>        librte_timer.so.23 -&gt; librte_timer.so.23.2<br>        librte_net.so.23 -&gt; librte_net.so.23.2<br>        librte_security.so.23 -&gt; librte_security.so.23.2<br>        librte_reorder.so.23 -&gt; librte_reorder.so.23.2<br>        librte_hash.so.23 -&gt; librte_hash.so.23.2<br>        librte_ring.so.23 -&gt; librte_ring.so.23.2<br>        librte_power.so.23 -&gt; librte_power.so.23.2<br>        librte_cmdline.so.23 -&gt; librte_cmdline.so.23.2<br>/root/xxx/spdk/build/lib:<br>        libspdk_conf.so.5.0 -&gt; libspdk_conf.so.5.0<br>        libspdk_vfio_user.so.4.0 -&gt; libspdk_vfio_user.so.4.0<br>        libspdk_blobfs.so.9.0 -&gt; libspdk_blobfs.so.9.0<br>        libspdk_bdev_gpt.so.5.0 -&gt; libspdk_bdev_gpt.so.5.0<br>        libspdk_event_sock.so.4.0 -&gt; libspdk_event_sock.so.4.0<br>        libspdk_nvme.so.11.0 -&gt; libspdk_nvme.so.11.0<br>        libspdk_nvmf.so.16.0 -&gt; libspdk_nvmf.so.16.0<br><span class="hljs-comment"># 省略部分输出</span><br></code></pre></td></tr></table></figure>



<p>运行时出现问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">./test -c zns.json   -b Nvme0n1<br>[2023-11-14 11:05:37.380098] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-11-14 11:05:37.380137] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid1653437 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-11-14 11:05:37.386954] app.c: 786:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-11-14 11:05:37.413012] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-11-14 11:05:37.614963] thread.c:2277:spdk_get_io_channel: *ERROR*: could not find io_device 0x7f37758c51e0<br>[2023-11-14 11:05:37.614980] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0 (0x55fafe79e6d0): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.614984] bdev_nvme.c: 651:_bdev_nvme_add_io_path: *ERROR*: Failed to alloc io_channel.<br>[2023-11-14 11:05:37.614988] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0n1 (0x55fafe79f7d0): Cannot allocate memory (rc=-12)<br>[2023-11-14 11:05:37.614991] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device bdev_Nvme0n1 (0x55fafe79f7d1): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.614994] blobstore.c:3334:bs_channel_create: *ERROR*: Failed to create device channel.<br>[2023-11-14 11:05:37.614997] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device blobstore (0x55fafe7a0380): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.615000] blobstore.c:5807:bs_register_md_thread: *ERROR*: Failed to get IO channel.<br>[2023-11-14 11:05:37.615040] thread.c:2277:spdk_get_io_channel: *ERROR*: could not find io_device 0x7f37758c51e0<br>[2023-11-14 11:05:37.615045] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0 (0x55fafe79e6d0): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.615048] bdev_nvme.c: 651:_bdev_nvme_add_io_path: *ERROR*: Failed to alloc io_channel.<br>[2023-11-14 11:05:37.615051] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0n1 (0x55fafe79f7d0): Cannot allocate memory (rc=-12)<br>[2023-11-14 11:05:37.615054] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device bdev_Nvme0n1 (0x55fafe79f7d1): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.615057] vbdev_gpt.c: 531:vbdev_gpt_read_gpt: *ERROR*: Failed to get an io_channel.<br>[2023-11-14 11:05:37.615063] vbdev_gpt.c: 584:vbdev_gpt_examine: *ERROR*: Failed to <span class="hljs-built_in">read</span> info from bdev Nvme0n1<br>[2023-11-14 11:05:37.617497] test.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-11-14 11:05:37.617504] test.c: 231:hello_start: *NOTICE*: Opening the bdev Nvme0n1<br>[2023-11-14 11:05:37.617507] test.c: 244:hello_start: *NOTICE*: Opening io channel<br>[2023-11-14 11:05:37.617511] thread.c:2277:spdk_get_io_channel: *ERROR*: could not find io_device 0x7f37758c51e0<br>[2023-11-14 11:05:37.617514] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0 (0x55fafe79e6d0): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.617517] bdev_nvme.c: 651:_bdev_nvme_add_io_path: *ERROR*: Failed to alloc io_channel.<br>[2023-11-14 11:05:37.617519] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device Nvme0n1 (0x55fafe79f7d0): Cannot allocate memory (rc=-12)<br>[2023-11-14 11:05:37.617522] thread.c:2339:spdk_get_io_channel: *ERROR*: could not create io_channel <span class="hljs-keyword">for</span> io_device bdev_Nvme0n1 (0x55fafe79f7d1): Operation not permitted (rc=-1)<br>[2023-11-14 11:05:37.617525] test.c: 248:hello_start: *ERROR*: Could not create bdev I/O channel!!<br>[2023-11-14 11:05:37.617528] app.c: 898:spdk_app_stop: *WARNING*: spdk_app_stop<span class="hljs-string">&#x27;d on non-zero</span><br><span class="hljs-string">[2023-11-14 11:05:42.617801] thread.c: 628:thread_exit: *ERROR*: thread app_thread got timeout, and move it to the exited state forcefully</span><br><span class="hljs-string">[2023-11-14 11:05:42.617818] test.c: 308:main: *ERROR*: ERROR starting application</span><br><span class="hljs-string">[2023-11-14 11:05:42.617856] thread.c: 464:spdk_thread_lib_fini: *ERROR*: io_device Nvme0 not unregistered</span><br><span class="hljs-string">[2023-11-14 11:05:42.617860] thread.c: 464:spdk_thread_lib_fini: *ERROR*: io_device Nvme0n1 not unregistered</span><br><span class="hljs-string">[2023-11-14 11:05:42.617863] thread.c: 464:spdk_thread_lib_fini: *ERROR*: io_device bdev_Nvme0n1 not unregistered</span><br><span class="hljs-string">[2023-11-14 11:05:42.617867] thread.c: 379:_free_thread: *WARNING*: timed_poller bdev_nvme_poll_adminq still registered at thread exit</span><br><span class="hljs-string">[2023-11-14 11:05:42.649495] pci.c: 353:pci_env_fini: *ERROR*: Device 0000:01:00.0 is still attached at shutdown!</span><br></code></pre></td></tr></table></figure>



<p><strong>问题原因：</strong>nvme_if模块未能成功加载，g_nvme_bdev_ctrlrs未注册</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_library_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	g_bdev_nvme_init_thread = spdk_get_thread();<br><br>	spdk_io_device_register(&amp;g_nvme_bdev_ctrlrs, bdev_nvme_create_poll_group_cb,<br>				bdev_nvme_destroy_poll_group_cb,<br>				<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nvme_poll_group),  <span class="hljs-string">&quot;nvme_poll_groups&quot;</span>);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_module</span> <span class="hljs-title">nvme_if</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;nvme&quot;</span>,<br>	.async_fini = <span class="hljs-literal">true</span>,<br>	.module_init = bdev_nvme_library_init,<br>	.module_fini = bdev_nvme_library_fini,<br>	.config_json = bdev_nvme_config_json,<br>	.get_ctx_size = bdev_nvme_get_ctx_size,<br><br>&#125;;<br>SPDK_BDEV_MODULE_REGISTER(nvme, &amp;nvme_if)<br></code></pre></td></tr></table></figure>

<p>对比标准hello_bdev调用栈</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  bdev_nvme_library_init () at bdev_nvme.c:6805</span><br><span class="hljs-comment">#1  0x00007ffff7d375b8 in bdev_modules_init () at bdev.c:2059</span><br><span class="hljs-comment">#2  0x00007ffff7d37845 in spdk_bdev_initialize (cb_fn=0x7ffff7d5e1d9 &lt;bdev_initialize_complete&gt;, cb_arg=0x0) at bdev.c:2128</span><br><span class="hljs-comment">#3  0x00007ffff7d5e212 in bdev_subsystem_initialize () at bdev.c:24</span><br><span class="hljs-comment">#4  0x00007ffff7c0c3fa in spdk_subsystem_init_next (rc=0) at subsystem.c:166</span><br><span class="hljs-comment">#5  0x00007ffff7ce11d7 in accel_subsystem_initialize () at accel.c:20</span><br><span class="hljs-comment">#6  0x00007ffff7c0c3fa in spdk_subsystem_init_next (rc=0) at subsystem.c:166</span><br><span class="hljs-comment">#7  0x00007ffff7c365d8 in vmd_subsystem_init () at vmd.c:63</span><br><span class="hljs-comment">#8  0x00007ffff7c0c3fa in spdk_subsystem_init_next (rc=0) at subsystem.c:166</span><br><span class="hljs-comment">#9  0x00007ffff7c2218b in sock_subsystem_init () at sock.c:13</span><br><span class="hljs-comment">#10 0x00007ffff7c0c3fa in spdk_subsystem_init_next (rc=0) at subsystem.c:166</span><br><span class="hljs-comment">#11 0x00007ffff7c143e6 in iobuf_subsystem_initialize () at iobuf.c:22</span><br><span class="hljs-comment">#12 0x00007ffff7c0c3fa in spdk_subsystem_init_next (rc=0) at subsystem.c:166</span><br><span class="hljs-comment">#13 0x00007ffff7c0c572 in spdk_subsystem_init (cb_fn=0x7ffff7c0b6ea &lt;subsystem_init_done&gt;, cb_arg=0x555555583700) at subsystem.c:199</span><br><span class="hljs-comment">#14 0x00007ffff7c0b836 in app_json_config_load_subsystem (_ctx=0x555555583700) at json_config.c:471</span><br><span class="hljs-comment">#15 0x00007ffff7bfa0d2 in msg_queue_run_batch (thread=0x555555583370, max_msgs=8) at thread.c:841</span><br><span class="hljs-comment">#16 0x00007ffff7bfaa2b in thread_poll (thread=0x555555583370, max_msgs=0, now=6000572509297613) at thread.c:1063</span><br><span class="hljs-comment">#17 0x00007ffff7bfad3a in spdk_thread_poll (thread=0x555555583370, max_msgs=0, now=6000572509297613) at thread.c:1156</span><br><span class="hljs-comment">#18 0x00007ffff7d6e3da in _reactor_run (reactor=0x555555585440) at reactor.c:914</span><br><span class="hljs-comment">#19 0x00007ffff7d6e4cc in reactor_run (arg=0x555555585440) at reactor.c:952</span><br><span class="hljs-comment">#20 0x00007ffff7d6e953 in spdk_reactors_start () at reactor.c:1068</span><br><span class="hljs-comment">#21 0x00007ffff7d6aa79 in spdk_app_start (opts_user=0x7fffffffde50, start_fn=0x555555556be7 &lt;hello_start&gt;, arg1=0x7fffffffddf0) at app.c:827</span><br><span class="hljs-comment">#22 0x0000555555556fc9 in main (argc=5, argv=0x7fffffffe038) at hello_bdev.c:306</span><br><br>(gdb) p g_subsystems<br><span class="hljs-variable">$2</span> = &#123;tqh_first = 0x7ffff7c17020 &lt;g_subsystem_iobuf&gt;, tqh_last = 0x7ffff7d61040 &lt;g_spdk_subsystem_bdev+32&gt;&#125;<br></code></pre></td></tr></table></figure>



<p>test程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) p g_subsystems<br><span class="hljs-variable">$2</span> = &#123;tqh_first = 0x0, tqh_last = 0x7ffff774a0c0 &lt;g_subsystems&gt;&#125;<br></code></pre></td></tr></table></figure>



<p>追踪到spdk_add_subsystem</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_add_subsystem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_subsystem *subsystem)</span><br>&#123;<br>	TAILQ_INSERT_TAIL(&amp;g_subsystems, subsystem, tailq);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * \brief Register a new subsystem</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPDK_SUBSYSTEM_REGISTER(_name) \</span><br><span class="hljs-meta">	__attribute__((constructor)) static void _name ## _register(void)	\</span><br><span class="hljs-meta">	&#123;									\</span><br><span class="hljs-meta">		spdk_add_subsystem(&amp;_name);					\</span><br><span class="hljs-meta">	&#125;</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_subsystem</span> <span class="hljs-title">g_spdk_subsystem_bdev</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;bdev&quot;</span>,<br>	.init = bdev_subsystem_initialize,<br>	.fini = bdev_subsystem_finish,<br>	.write_config_json = bdev_subsystem_config_json,<br>&#125;;<br><br>SPDK_SUBSYSTEM_REGISTER(g_spdk_subsystem_bdev);<br>SPDK_SUBSYSTEM_DEPEND(bdev, accel)<br>SPDK_SUBSYSTEM_DEPEND(bdev, vmd)<br>SPDK_SUBSYSTEM_DEPEND(bdev, sock)<br>SPDK_SUBSYSTEM_DEPEND(bdev, iobuf)<br></code></pre></td></tr></table></figure>



<p>通过对比hello_bdev与test链接动态库的区别</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">ldd <span class="hljs-built_in">test</span> |  <span class="hljs-built_in">wc</span> -l<br>75<br><br>ldd hello_bdev |  <span class="hljs-built_in">wc</span> -l<br>82<br></code></pre></td></tr></table></figure>

<p>发现test少链接了一些动态库(例如一些event_xxx)的库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">libspdk_event_bdev.so.5.0 =&gt; /root/xxx/spdk/build/lib/libspdk_event_bdev.so.5.0 (0x00007f95a6bd0000)<br>libspdk_bdev.so.13.0 =&gt; /root/xxx/spdk/build/lib/libspdk_bdev.so.13.0 (0x00007f95a6b9d000)<br>libspdk_notify.so.5.0 =&gt; /root/xxx/spdk/build/lib/libspdk_notify.so.5.0 (0x00007f95a6b58000)<br>libspdk_event_accel.so.5.0 =&gt; /root/xxx/spdk/build/lib/libspdk_event_accel.so.5.0 (0x00007f95a6b53000)<br>libspdk_accel.so.13.0 =&gt; /root/xxx/spdk/build/lib/libspdk_accel.so.13.0 (0x00007f95a6ab4000)<br>libspdk_dma.so.3.0 =&gt; /root/xxx/spdk/build/lib/libspdk_dma.so.3.0 (0x00007f95a6aad000)<br>libspdk_event_vmd.so.5.0 =&gt; /root/xxx/spdk/build/lib/libspdk_event_vmd.so.5.0 (0x00007f95a6aa8000)<br>libspdk_vmd.so.5.0 =&gt; /root/xxx/spdk/build/lib/libspdk_vmd.so.5.0 (0x00007f95a6a99000)<br>libspdk_event_sock.so.4.0 =&gt; /root/xxx/spdk/build/lib/libspdk_event_sock.so.4.0 (0x00007f95a6a94000)<br>libspdk_sock.so.8.0 =&gt; /root/xxx/spdk/build/lib/libspdk_sock.so.8.0 (0x00007f95a6a8b000)<br>libspdk_event_iobuf.so.2.0 =&gt; /root/xxx/spdk/build/lib/libspdk_event_iobuf.so.2.0 (0x00007f95a6a86000)<br></code></pre></td></tr></table></figure>

<p>故像spdk-demo中一样，把所有库加上（现在意识到了这种做法聪明之处，之前我只加了几项，因为我以为其他的会一并加入，但这样做应该漏了几项）</p>
<p>感觉可以将spdk&#x2F;build&#x2F;lib&#x2F;pkgconfig中所有pc名都加上，以防万一</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span><br>spdk_accel_ioat.pc     spdk_bdev_modules.pc     spdk_blobfs_bdev.pc   spdk_event_iobuf.pc       spdk_event_vmd.pc  spdk_notify.pc                   spdk_sock.pc          spdk_vhost.pc<br>spdk_accel_modules.pc  spdk_bdev_null.pc        spdk_blobfs.pc        spdk_event_iscsi.pc       spdk_ftl.pc        spdk_nvme.pc                     spdk_sock_posix.pc    spdk_virtio.pc<br>spdk_accel.pc          spdk_bdev_nvme.pc        spdk_blob.pc          spdk_event_nbd.pc         spdk_init.pc       spdk_nvmf.pc                     spdk_syslibs.pc       spdk_vmd.pc<br>spdk_bdev_aio.pc       spdk_bdev_passthru.pc    spdk_conf.pc          spdk_event_nvmf.pc        spdk_ioat.pc       spdk_rpc.pc                      spdk_thread.pc        tmp/<br>spdk_bdev_delay.pc     spdk_bdev.pc             spdk_dma.pc           spdk_event.pc             spdk_iscsi.pc      spdk_scheduler_dpdk_governor.pc  spdk_trace_parser.pc<br>spdk_bdev_error.pc     spdk_bdev_raid.pc        spdk_dpdklibs.pc      spdk_event_scheduler.pc   spdk_json.pc       spdk_scheduler_dynamic.pc        spdk_trace.pc<br>spdk_bdev_ftl.pc       spdk_bdev_split.pc       spdk_env_dpdk.pc      spdk_event_scsi.pc        spdk_jsonrpc.pc    spdk_scheduler_gscheduler.pc     spdk_util.pc<br>spdk_bdev_gpt.pc       spdk_bdev_virtio.pc      spdk_env_dpdk_rpc.pc  spdk_event_sock.pc        spdk_log.pc        spdk_scheduler_modules.pc        spdk_ut_mock.pc<br>spdk_bdev_lvol.pc      spdk_bdev_zone_block.pc  spdk_event_accel.pc   spdk_event_vhost_blk.pc   spdk_lvol.pc       spdk_scsi.pc                     spdk_ut.pc<br>spdk_bdev_malloc.pc    spdk_blob_bdev.pc        spdk_event_bdev.pc    spdk_event_vhost_scsi.pc  spdk_nbd.pc        spdk_sock_modules.pc             spdk_vfio_user.pc<br></code></pre></td></tr></table></figure>





<h4 id="最终成果"><a href="#最终成果" class="headerlink" title="最终成果"></a>最终成果</h4><p>makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CC := g++<br>PKG_CONFIG_PATH = /root/xxx/spdk/build/lib/pkgconfig<br>ALL_SPDK_LIBS := spdk_accel_ioat spdk_blobfs spdk_jsonrpc \<br>spdk_accel_modules     spdk_blob           spdk_log \<br>spdk_accel             spdk_conf           spdk_lvol \<br>spdk_bdev_aio          spdk_dpdklibs       spdk_nbd \<br>spdk_bdev_delay        spdk_env_dpdk        \<br>spdk_bdev_error        spdk_env_dpdk_rpc   spdk_notify \<br>spdk_bdev_ftl          spdk_event_accel    spdk_nvme \<br>spdk_bdev_gpt          spdk_event_bdev     spdk_nvmf \<br>spdk_bdev_lvol         spdk_event_iscsi    spdk_rpc \<br>spdk_bdev_malloc       spdk_event_nbd      spdk_scsi \<br>spdk_bdev_modules          spdk_sock_modules \<br>spdk_bdev_null         spdk_event_nvmf     spdk_sock \<br>spdk_bdev_nvme         spdk_event          spdk_sock_posix \<br>spdk_bdev_passthru     spdk_event_scsi     spdk_syslibs \<br>spdk_bdev              spdk_event_sock     spdk_thread \<br>spdk_bdev_raid            spdk_trace \<br>spdk_bdev_split        spdk_event_vmd      spdk_util \<br>spdk_bdev_virtio       spdk_ftl            \<br>spdk_bdev_zone_block   spdk_ioat           spdk_vhost \<br>spdk_blob_bdev         spdk_iscsi          spdk_virtio \<br>spdk_blobfs_bdev       spdk_json           spdk_vmd	\<br>spdk_thread<br>SPDK_LIB := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> PKG_CONFIG_PATH=&quot;<span class="hljs-variable">$(PKG_CONFIG_PATH)</span>&quot; pkg-config --cflags  --libs  <span class="hljs-variable">$(ALL_SPDK_LIBS)</span>)</span><br><br><br><br><span class="hljs-section">test:</span><br>	<span class="hljs-variable">$(CC)</span> test.c  -fpermissive -pthread -g  -o test  -Wl,--no-as-needed  <span class="hljs-variable">$(SPDK_LIB)</span>  -Wl,--as-needed<br><br><span class="hljs-section">clean:</span><br>	rm test <br></code></pre></td></tr></table></figure>

<p>编译输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">g++ test.c  -fpermissive -pthread -g  -o <span class="hljs-built_in">test</span>  -Wl,--no-as-needed  -I/root/xxx/spdk/build/include -L/root/xxx/spdk/build/lib -L/root/xxx/spdk/dpdk/build/lib -L/root/xxx/spdk/build/lib -lspdk_env_dpdk -lrte_eal -lrte_mempool -lrte_ring -lrte_mbuf -lrte_bus_pci -lrte_pci -lrte_mempool_ring -lrte_telemetry -lrte_kvargs -lrte_rcu -lrte_power -lrte_ethdev -lrte_net -lrte_vhost -lrte_net -lrte_dmadev -lrte_cryptodev -lrte_hash -lspdk_event_iscsi -lspdk_event_nbd -lspdk_nbd -lspdk_event_nvmf -lspdk_nvmf -lspdk_event_scheduler -lspdk_event -lspdk_env_dpdk_rpc -lspdk_event_scsi -lspdk_event_bdev -lspdk_event_accel -lspdk_event_iobuf -lspdk_event_sock -lspdk_event_vmd -lspdk_init -lspdk_vhost -lspdk_iscsi -lspdk_conf -lspdk_scsi -lspdk_blobfs_bdev -lspdk_blob_bdev -lspdk_bdev -lspdk_notify -lspdk_bdev_malloc -lspdk_bdev_null -lspdk_bdev_nvme -lspdk_bdev_passthru -lspdk_bdev_lvol -lspdk_bdev_raid -lspdk_accel -lspdk_accel_ioat -lspdk_ioat -lspdk_bdev_error -lspdk_bdev_gpt -lspdk_bdev_split -lspdk_bdev_delay -lspdk_bdev_zone_block -lspdk_lvol -lspdk_nvme -lspdk_sock -lspdk_sock_posix -lspdk_bdev_aio -lspdk_bdev_ftl -lspdk_ftl -lspdk_bdev_virtio -lspdk_virtio -lspdk_vfio_user -lspdk_blobfs -lspdk_blob -lspdk_dma -lspdk_vmd -lspdk_thread -lspdk_trace -lspdk_rpc -lspdk_jsonrpc -lspdk_json -lspdk_util -lspdk_log  -Wl,--as-needed<br>test.c:15:28: warning: ISO C++ forbids converting a string constant to ‘char*’ [-Wwrite-strings]<br>   15 | static char *g_bdev_name = <span class="hljs-string">&quot;Malloc0&quot;</span>;<br>      |                            ^~~~~~~~~<br>test.c: In <span class="hljs-keyword">function</span> ‘void read_complete(spdk_bdev_io*, bool, void*)’:<br>test.c:62:42: warning: invalid conversion from ‘void*’ to ‘hello_context_t*’ [-fpermissive]<br>   62 |  struct hello_context_t *hello_context = cb_arg;<br>      |                                          ^~~~~~<br>      |                                          |<br>      |                                          void*<br><span class="hljs-comment"># 省略部分输出</span><br></code></pre></td></tr></table></figure>

<p>运行时输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@osd-node0 ~/l/s/zns-api-test (v23.09.x)<span class="hljs-comment"># ./test -c zns.json   -b Nvme0n1</span><br>[2023-11-14 15:54:54.808886] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-11-14 15:54:54.808932] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid1673133 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-11-14 15:54:54.815662] app.c: 786:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-11-14 15:54:54.841394] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-11-14 15:54:55.129643] test.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-11-14 15:54:55.129663] test.c: 231:hello_start: *NOTICE*: Opening the bdev Nvme0n1<br>[2023-11-14 15:54:55.129668] test.c: 244:hello_start: *NOTICE*: Opening io channel<br>[2023-11-14 15:54:55.149196] test.c: 138:hello_write: *NOTICE*: Writing to the bdev<br>[2023-11-14 15:54:55.149228] test.c: 117:write_complete: *NOTICE*: bdev io write completed successfully<br>[2023-11-14 15:54:55.149231] test.c:  84:hello_read: *NOTICE*: Reading io<br>[2023-11-14 15:54:55.149246] test.c:  65:read_complete: *NOTICE*: Read string from bdev : Hello World!<br><br>[2023-11-14 15:54:55.149250] test.c:  74:read_complete: *NOTICE*: Stopping app<br></code></pre></td></tr></table></figure>



<p><strong>弄了好久终于成功了！！！</strong></p>
<h4 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h4><blockquote>
<p>Note that SPDK libraries use constructor functions liberally, so you must surround the library list with extra linker options to ensure these functions are not dropped from the resulting application binary.</p>
</blockquote>
<p>SPDK Libraries文档中这句话的意思是什么呢？ 按理来说主程序使用库头文件中的函数，静态库&#x2F;动态库为其提供对应函数的定义，也就是说主程序用到哪些函数，库提供这些函数的全部递归实现，完全未涉及到的函数就不需要链接进来，那么为什么需要设置–whole-archive 或者–no-as-needed 链接选项呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ld<br>  --whole-archive             Include all objects from following archives<br>  --no-as-needed              Always <span class="hljs-built_in">set</span> DT_NEEDED <span class="hljs-keyword">for</span> dynamic libraries mentioned on<br></code></pre></td></tr></table></figure>

<p>以module&#x2F;event&#x2F;subsystems&#x2F;bdev&#x2F;bdev.c文件为例分析原因</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// module/event/subsystems/bdev/bdev.c</span><br><span class="hljs-comment">/*   SPDX-License-Identifier: BSD-3-Clause</span><br><span class="hljs-comment"> *   Copyright (C) 2016 Intel Corporation.</span><br><span class="hljs-comment"> *   All rights reserved.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/stdinc.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/bdev.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/env.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/thread.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk_internal/init.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/env.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_initialize_complete</span><span class="hljs-params">(<span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> rc)</span><br>&#123;<br>	spdk_subsystem_init_next(rc);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_subsystem_initialize</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	spdk_bdev_initialize(bdev_initialize_complete, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_subsystem_finish_done</span><span class="hljs-params">(<span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	spdk_subsystem_fini_next();<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_subsystem_finish</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	spdk_bdev_finish(bdev_subsystem_finish_done, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_subsystem_config_json</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_json_write_ctx *w)</span><br>&#123;<br>	spdk_bdev_subsystem_config_json(w);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_subsystem</span> <span class="hljs-title">g_spdk_subsystem_bdev</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;bdev&quot;</span>,<br>	.init = bdev_subsystem_initialize,<br>	.fini = bdev_subsystem_finish,<br>	.write_config_json = bdev_subsystem_config_json,<br>&#125;;<br><br>SPDK_SUBSYSTEM_REGISTER(g_spdk_subsystem_bdev);<br>SPDK_SUBSYSTEM_DEPEND(bdev, accel)<br>SPDK_SUBSYSTEM_DEPEND(bdev, vmd)<br>SPDK_SUBSYSTEM_DEPEND(bdev, sock)<br>SPDK_SUBSYSTEM_DEPEND(bdev, iobuf)<br><br></code></pre></td></tr></table></figure>

<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141620340.png" srcset="/img/loading.gif" lazyload></p>
<p>这些函数只在本文件被引用，故主程序不可能直接&#x2F;间接引用到它，g_spdk_subsystem_bdev加上了static修饰符，只在本文件可见，故关键点在于SPDK_SUBSYSTEM_REGISTER宏</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * \brief Register a new subsystem</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPDK_SUBSYSTEM_REGISTER(_name) \</span><br><span class="hljs-meta">	__attribute__((constructor)) static void _name ## _register(void)	\</span><br><span class="hljs-meta">	&#123;									\</span><br><span class="hljs-meta">		spdk_add_subsystem(&amp;_name);					\</span><br><span class="hljs-meta">	&#125;</span><br></code></pre></td></tr></table></figure>

<p>由于主程序无法引用该文件的内容，故它的执行与_<em>attribute</em>_((constructor))有关</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dd425b9dc9db"><strong>attribute</strong>((constructor))用法解析</a></p>
<p><code>constructor</code>参数让系统执行<code>main()</code>函数之前调用函数(被<code>__attribute__((constructor))</code>修饰的函数).同理, <code>destructor</code>让系统在<code>main()</code>函数退出或者调用了<code>exit()</code>之后,调用我们的函数.带有这些修饰属性的函数,对于我们初始化一些在程序中使用的数据非常有用.</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2053029/how-exactly-does-attribute-constructor-work">How exactly does <strong>attribute</strong>((constructor)) work?</a></p>
<blockquote>
<p>So, the way the constructors and destructors work is that the shared object file contains special sections (.ctors and .dtors on ELF) which contain references to the functions marked with the constructor and destructor attributes, respectively. When the library is loaded&#x2F;unloaded the dynamic loader program (ld.so or somesuch) checks whether such sections exist, and if so, calls the functions referenced therein.</p>
<p>Come to think of it, there is probably some similar magic in the normal static linker so that the same code is run on startup&#x2F;shutdown regardless if the user chooses static or dynamic linking.</p>
</blockquote>
<p><strong>结论：</strong>可以看出bdev.c是一个自成一体的文件，包含或不包含都不会对主程序产生影响，编译与链接都不会有问题，但运行时主程序逻辑上预设这些模块应该被导入&#x2F;加载，故执行出错。</p>
<p><a target="_blank" rel="noopener" href="https://spdk.io/doc/libraries.html">SPDK Libraries</a></p>
<p><a target="_blank" rel="noopener" href="https://spdk.io/doc/pkgconfig.html">Linking SPDK applications with pkg-config</a></p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141646354.png" srcset="/img/loading.gif" lazyload></p>
<p>lib目录内容</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141646250.png" srcset="/img/loading.gif" lazyload></p>
<p>module目录内容</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311141647632.png" srcset="/img/loading.gif" lazyload></p>
<p>通过spdk_event_xxx库导入问题，有点懂了为什么module是instance了</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># 以上分析文件为module/event/subsystems/bdev/bdev.c</span><br><span class="hljs-comment"># module/event/subsystems/bdev/Makefile文件内容</span><br><span class="hljs-comment">#  SPDX-License-Identifier: BSD-3-Clause</span><br><span class="hljs-comment">#  Copyright (C) 2015 Intel Corporation.</span><br><span class="hljs-comment">#  All rights reserved.</span><br><span class="hljs-comment">#</span><br><br>SPDK_ROOT_DIR := <span class="hljs-variable">$(<span class="hljs-built_in">abspath</span> <span class="hljs-variable">$(CURDIR)</span>/../../../..)</span><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(SPDK_ROOT_DIR)</span>/mk/spdk.common.mk<br><br>SO_VER := 5<br>SO_MINOR := 0<br><br>C_SRCS = bdev.c<br>LIBNAME = event_bdev<br><br>SPDK_MAP_FILE = <span class="hljs-variable">$(SPDK_ROOT_DIR)</span>/mk/spdk_blank.map<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(SPDK_ROOT_DIR)</span>/mk/spdk.lib.mk<br></code></pre></td></tr></table></figure>



<h3 id="demo编写"><a href="#demo编写" class="headerlink" title="demo编写"></a>demo编写</h3><p><strong>zone id误解</strong></p>
<p>zone_id就是zslba，而不是0,1,2,3,这种序号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Get the first logical block of a zone (known as zone_id or zslba)</span><br><span class="hljs-comment"> * for a given offset.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param bdev Block device to query.</span><br><span class="hljs-comment"> * \param offset_blocks The offset, in blocks, from the start of the block device.</span><br><span class="hljs-comment"> * \return The zone_id (also known as zslba) for the given offset.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">spdk_bdev_get_zone_id</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_bdev *bdev, <span class="hljs-type">uint64_t</span> offset_blocks)</span><br>&#123;<br>	<span class="hljs-type">uint64_t</span> zslba;<br><br>	<span class="hljs-keyword">if</span> (spdk_likely(spdk_u64_is_pow2(bdev-&gt;zone_size))) &#123;<br>		<span class="hljs-type">uint64_t</span> zone_mask = bdev-&gt;zone_size - <span class="hljs-number">1</span>;<br>		zslba = offset_blocks &amp; ~zone_mask;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* integer division */</span><br>		zslba = (offset_blocks / bdev-&gt;zone_size) * bdev-&gt;zone_size;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> zslba;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>active zone限制</strong></p>
<p>注意不能超过 active zone限制（同时操作的zone数目）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[2023-11-15 11:43:48.482631] nvme_qpair.c: 255:nvme_io_qpair_print_command: *NOTICE*: IO COMMAND (7d) sqid:1 cid:61 nsid:1<br>[2023-11-15 11:43:48.482636] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: TOO MANY ACTIVE ZONES (01/bd) qid:1 cid:61 cdw0:80792b80 sqhd:00aa p:1 m:0 dnr:0<br>[2023-11-15 11:43:48.482641] nvme_qpair.c: 255:nvme_io_qpair_print_command: *NOTICE*: IO COMMAND (7d) sqid:1 cid:60 nsid:1<br>[2023-11-15 11:43:48.482644] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: TOO MANY ACTIVE ZONES (01/bd) qid:1 cid:60 cdw0:80797540 sqhd:00aa p:1 m:0 dnr:0<br>[2023-11-15 11:43:48.482647] nvme_qpair.c: 255:nvme_io_qpair_print_command: *NOTICE*: IO COMMAND (7d) sqid:1 cid:62 nsid:1<br>[2023-11-15 11:43:48.482650] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: TOO MANY ACTIVE ZONES (01/bd) qid:1 cid:62 cdw0:80798440 sqhd:00aa p:1 m:0 dnr:0<br></code></pre></td></tr></table></figure>



<h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// rw_test.cc</span><br><span class="hljs-comment">/*   SPDX-License-Identifier: BSD-3-Clause</span><br><span class="hljs-comment"> *   Copyright (C) 2018 Intel Corporation.</span><br><span class="hljs-comment"> *   All rights reserved.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/stdinc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/bdev.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/env.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/event.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/log.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;spdk/bdev_zone.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *g_bdev_name = <span class="hljs-string">&quot;Nvme0n1&quot;</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> &#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">spdk_bdev</span> *bdev;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">spdk_bdev_desc</span> *bdev_desc;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">spdk_io_channel</span> *bdev_io_channel;<br>  <span class="hljs-type">char</span> *write_buff;<br>  <span class="hljs-type">char</span> *read_buff;<br>  <span class="hljs-type">uint32_t</span> buff_size;<br>  <span class="hljs-type">char</span> *bdev_name;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">spdk_bdev_io_wait_entry</span> bdev_io_wait;<br><br>  std::atomic&lt;<span class="hljs-type">int</span>&gt; count;  <span class="hljs-comment">// 原子变量，避免并发修改冲突</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">read_zone_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io, <span class="hljs-type">bool</span> success, <span class="hljs-type">void</span> *cb_arg)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(cb_arg);<br>  <span class="hljs-built_in">spdk_bdev_free_io</span>(bdev_io);<br><br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;bdev io read zone error: %d\n&quot;</span>, EIO);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 比对读缓冲区与写缓冲区内容</span><br>  <span class="hljs-type">int</span> cmp_res = <span class="hljs-built_in">memcmp</span>(test_context-&gt;write_buff, test_context-&gt;read_buff, test_context-&gt;buff_size);<br>  <span class="hljs-keyword">if</span> (cmp_res != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;read zone data error.\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;count.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (test_context-&gt;count.<span class="hljs-built_in">load</span>() == <span class="hljs-number">4</span> * <span class="hljs-number">0x100</span>) &#123;  <span class="hljs-comment">// 读取测试完成，结束测试</span><br>    <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;read zone complete.\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">memset</span>(test_context-&gt;read_buff, <span class="hljs-number">0x34</span>, test_context-&gt;buff_size);<br>  <span class="hljs-comment">// 循环读取，直至读到最后一个测试LBA</span><br>  <span class="hljs-type">uint64_t</span> lba = test_context-&gt;count.<span class="hljs-built_in">load</span>() / <span class="hljs-number">0x100</span> * <span class="hljs-built_in">spdk_bdev_get_zone_size</span>(test_context-&gt;bdev) +<br>                 test_context-&gt;count.<span class="hljs-built_in">load</span>() % <span class="hljs-number">0x100</span>;  <span class="hljs-comment">// 计算对应的LBA</span><br><br>  <span class="hljs-type">int</span> rc = <span class="hljs-built_in">spdk_bdev_read_blocks</span>(test_context-&gt;bdev_desc, test_context-&gt;bdev_io_channel, test_context-&gt;read_buff, lba,<br>                                 <span class="hljs-number">1</span>, read_zone_complete, test_context);<br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;read lba:0x%lx\n&quot;</span>, lba);<br>  <span class="hljs-keyword">if</span> (rc != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;%s error while reading from bdev: %d\n&quot;</span>, <span class="hljs-built_in">spdk_strerror</span>(-rc), rc);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">read_zone</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>&#123;<br>  <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(arg);<br>  test_context-&gt;count = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(test_context-&gt;read_buff, <span class="hljs-number">0x34</span>, test_context-&gt;buff_size);  <span class="hljs-comment">// 读取前缓冲区内容为0x34</span><br>  rc = <span class="hljs-built_in">spdk_bdev_read_blocks</span>(test_context-&gt;bdev_desc, test_context-&gt;bdev_io_channel, test_context-&gt;read_buff, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>,<br>                             read_zone_complete, test_context);<br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;read lba:0x%x\n&quot;</span>, <span class="hljs-number">0x0</span>);<br>  <span class="hljs-keyword">if</span> (rc == -ENOMEM) &#123;<br>    <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Queueing io\n&quot;</span>);<br>    <span class="hljs-comment">/* In case we cannot perform I/O now, queue I/O */</span><br>    test_context-&gt;bdev_io_wait.bdev = test_context-&gt;bdev;<br>    test_context-&gt;bdev_io_wait.cb_fn = read_zone;<br>    test_context-&gt;bdev_io_wait.cb_arg = test_context;<br>    <span class="hljs-built_in">spdk_bdev_queue_io_wait</span>(test_context-&gt;bdev, test_context-&gt;bdev_io_channel, &amp;test_context-&gt;bdev_io_wait);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rc) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;%s error while reading from bdev: %d\n&quot;</span>, <span class="hljs-built_in">spdk_strerror</span>(-rc), rc);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">write_zone_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io, <span class="hljs-type">bool</span> success, <span class="hljs-type">void</span> *cb_arg)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(cb_arg);<br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;append lba:0x%lx\n&quot;</span>, <span class="hljs-built_in">spdk_bdev_io_get_append_location</span>(bdev_io));  <span class="hljs-comment">// 打印成功append位置</span><br>  <span class="hljs-built_in">spdk_bdev_free_io</span>(bdev_io);<br><br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;bdev io write zone error: %d\n&quot;</span>, EIO);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;count.<span class="hljs-built_in">fetch_sub</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (test_context-&gt;count.<span class="hljs-built_in">load</span>() == <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">// zone写入完成，开始读取数据验证</span><br>    <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;write zone complete.\n&quot;</span>);<br>    <span class="hljs-built_in">read_zone</span>(test_context);<br>  &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">write_zone</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>&#123;<br>  <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(arg);<br>  <span class="hljs-type">uint64_t</span> zone_size = <span class="hljs-built_in">spdk_bdev_get_zone_size</span>(test_context-&gt;bdev);<br>  <span class="hljs-comment">// 往4个zone的前0x100个block李写入0x12</span><br>  <span class="hljs-type">int</span> zone_num = <span class="hljs-number">4</span>;<br>  <span class="hljs-type">int</span> append_times = <span class="hljs-number">0x100</span>;<br>  test_context-&gt;count = zone_num * append_times;<br>  <span class="hljs-built_in">memset</span>(test_context-&gt;write_buff, <span class="hljs-number">0x12</span>, test_context-&gt;buff_size);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint64_t</span> slba = <span class="hljs-number">0</span>; slba &lt; zone_num * zone_size; slba += zone_size) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; append_times; i++) &#123;<br>      rc = <span class="hljs-built_in">spdk_bdev_zone_append</span>(test_context-&gt;bdev_desc, test_context-&gt;bdev_io_channel, test_context-&gt;write_buff, slba,<br>                                 <span class="hljs-number">1</span>, write_zone_complete, test_context);<br>      <span class="hljs-keyword">if</span> (rc != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;%s error while write_zone: %d\n&quot;</span>, <span class="hljs-built_in">spdk_strerror</span>(-rc), rc);<br>        <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>        <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>        <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">reset_zone_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io, <span class="hljs-type">bool</span> success, <span class="hljs-type">void</span> *cb_arg)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(cb_arg);<br>  <span class="hljs-built_in">spdk_bdev_free_io</span>(bdev_io);<br><br>  <span class="hljs-keyword">if</span> (!success) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;bdev io reset zone error: %d\n&quot;</span>, EIO);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;count.<span class="hljs-built_in">fetch_sub</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (test_context-&gt;count.<span class="hljs-built_in">load</span>() == <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">// zone重置完成，开始写入数据</span><br>    <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;reset zone complete.\n&quot;</span>);<br>    <span class="hljs-built_in">write_zone</span>(test_context);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">reset_zone</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(arg);<br>  <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// 重置前10个zone</span><br>  <span class="hljs-type">int</span> zone_num = <span class="hljs-number">10</span>;<br>  test_context-&gt;count = zone_num;<br>  <span class="hljs-type">uint64_t</span> zone_size = <span class="hljs-built_in">spdk_bdev_get_zone_size</span>(test_context-&gt;bdev);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">uint64_t</span> slba = <span class="hljs-number">0</span>; slba &lt; zone_num * zone_size; slba += zone_size) &#123;<br>    rc = <span class="hljs-built_in">spdk_bdev_zone_management</span>(test_context-&gt;bdev_desc, test_context-&gt;bdev_io_channel, slba, SPDK_BDEV_ZONE_RESET,<br>                                   reset_zone_complete, test_context);<br>    <span class="hljs-keyword">if</span> (rc == -ENOMEM) &#123;<br>      <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Queueing io\n&quot;</span>);<br>      <span class="hljs-comment">/* In case we cannot perform I/O now, queue I/O */</span><br>      test_context-&gt;bdev_io_wait.bdev = test_context-&gt;bdev;<br>      test_context-&gt;bdev_io_wait.cb_fn = reset_zone;<br>      test_context-&gt;bdev_io_wait.cb_arg = test_context;<br>      <span class="hljs-built_in">spdk_bdev_queue_io_wait</span>(test_context-&gt;bdev, test_context-&gt;bdev_io_channel, &amp;test_context-&gt;bdev_io_wait);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rc) &#123;<br>      <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;%s error while resetting zone: %d\n&quot;</span>, <span class="hljs-built_in">spdk_strerror</span>(-rc), rc);<br>      <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>      <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>      <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">test_bdev_event_cb</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> spdk_bdev_event_type type, <span class="hljs-keyword">struct</span> spdk_bdev *bdev, <span class="hljs-type">void</span> *event_ctx)</span> </span>&#123;<br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Unsupported bdev event: type %d\n&quot;</span>, type);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">test_start</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg1)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> *test_context = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-keyword">struct</span> <span class="hljs-type">rwtest_context_t</span> *&gt;(arg1);<br>  <span class="hljs-type">uint32_t</span> buf_align;<br>  <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>  test_context-&gt;bdev = <span class="hljs-literal">NULL</span>;<br>  test_context-&gt;bdev_desc = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Successfully started the application\n&quot;</span>);<br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Opening the bdev %s\n&quot;</span>, test_context-&gt;bdev_name);<br>  rc = <span class="hljs-built_in">spdk_bdev_open_ext</span>(test_context-&gt;bdev_name, <span class="hljs-literal">true</span>, test_bdev_event_cb, <span class="hljs-literal">NULL</span>, &amp;test_context-&gt;bdev_desc);<br>  <span class="hljs-keyword">if</span> (rc) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;Could not open bdev: %s\n&quot;</span>, test_context-&gt;bdev_name);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;bdev = <span class="hljs-built_in">spdk_bdev_desc_get_bdev</span>(test_context-&gt;bdev_desc);<br><br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<span class="hljs-string">&quot;Opening io channel\n&quot;</span>);<br>  <span class="hljs-comment">/* Open I/O channel */</span><br>  test_context-&gt;bdev_io_channel = <span class="hljs-built_in">spdk_bdev_get_io_channel</span>(test_context-&gt;bdev_desc);<br>  <span class="hljs-keyword">if</span> (test_context-&gt;bdev_io_channel == <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;Could not create bdev I/O channel!!\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;buff_size =<br>      <span class="hljs-built_in">spdk_bdev_get_block_size</span>(test_context-&gt;bdev) * <span class="hljs-built_in">spdk_bdev_get_write_unit_size</span>(test_context-&gt;bdev);<br>  buf_align = <span class="hljs-built_in">spdk_bdev_get_buf_align</span>(test_context-&gt;bdev);<br>  test_context-&gt;write_buff = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-built_in">spdk_dma_zmalloc</span>(test_context-&gt;buff_size, buf_align, <span class="hljs-literal">NULL</span>));<br>  <span class="hljs-keyword">if</span> (!test_context-&gt;write_buff) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;Failed to allocate buffer\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  test_context-&gt;read_buff = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(<span class="hljs-built_in">spdk_dma_zmalloc</span>(test_context-&gt;buff_size, buf_align, <span class="hljs-literal">NULL</span>));<br>  <span class="hljs-keyword">if</span> (!test_context-&gt;read_buff) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;Failed to allocate buffer\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">spdk_bdev_is_zoned</span>(test_context-&gt;bdev)) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;not a ZNS SSD\n&quot;</span>);<br>    <span class="hljs-built_in">spdk_put_io_channel</span>(test_context-&gt;bdev_io_channel);<br>    <span class="hljs-built_in">spdk_bdev_close</span>(test_context-&gt;bdev_desc);<br>    <span class="hljs-built_in">spdk_app_stop</span>(<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 打印ZNS SSD一些信息</span><br>  <span class="hljs-built_in">SPDK_NOTICELOG</span>(<br>      <span class="hljs-string">&quot;block size:%d write unit:%d zone size:%lx zone num:%ld max append size:%d max open zone:%d max active &quot;</span><br>      <span class="hljs-string">&quot;zone:%d\n&quot;</span>,<br>      <span class="hljs-built_in">spdk_bdev_get_block_size</span>(test_context-&gt;bdev), <span class="hljs-built_in">spdk_bdev_get_write_unit_size</span>(test_context-&gt;bdev),<br>      <span class="hljs-built_in">spdk_bdev_get_zone_size</span>(test_context-&gt;bdev), <span class="hljs-built_in">spdk_bdev_get_num_zones</span>(test_context-&gt;bdev),<br>      <span class="hljs-built_in">spdk_bdev_get_max_zone_append_size</span>(test_context-&gt;bdev), <span class="hljs-built_in">spdk_bdev_get_max_open_zones</span>(test_context-&gt;bdev),<br>      <span class="hljs-built_in">spdk_bdev_get_max_active_zones</span>(test_context-&gt;bdev));<br>  <span class="hljs-built_in">reset_zone</span>(test_context);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> </span>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">spdk_app_opts</span> opts = &#123;&#125;;<br>  <span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rwtest_context_t</span> test_context = &#123;&#125;;<br><br>  <span class="hljs-built_in">spdk_app_opts_init</span>(&amp;opts, <span class="hljs-built_in">sizeof</span>(opts));<br>  opts.name = <span class="hljs-string">&quot;test_bdev&quot;</span>;<br><br>  <span class="hljs-keyword">if</span> ((rc = <span class="hljs-built_in">spdk_app_parse_args</span>(argc, argv, &amp;opts, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) != SPDK_APP_PARSE_ARGS_SUCCESS) &#123;<br>    <span class="hljs-built_in">exit</span>(rc);<br>  &#125;<br>  test_context.bdev_name = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(g_bdev_name);<br><br>  rc = <span class="hljs-built_in">spdk_app_start</span>(&amp;opts, test_start, &amp;test_context);<br>  <span class="hljs-keyword">if</span> (rc) &#123;<br>    <span class="hljs-built_in">SPDK_ERRLOG</span>(<span class="hljs-string">&quot;ERROR starting application\n&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">spdk_dma_free</span>(test_context.write_buff);<br>  <span class="hljs-built_in">spdk_dma_free</span>(test_context.read_buff);<br><br>  <span class="hljs-built_in">spdk_app_fini</span>();<br>  <span class="hljs-keyword">return</span> rc;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>注意采用上文<strong>动态库编译</strong>方法（实际上静态库包含所有的pkg-config估计也可以，只是我懒得再试了），traddr为测试设备的地址</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// zns.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;subsystems&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;subsystem&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bdev&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;config&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bdev_nvme_attach_controller&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;trtype&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PCIe&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Nvme0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;traddr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0000:01:00.0&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># makefile</span><br>CC := g++<br>PKG_CONFIG_PATH = /root/xxx/spdk/build/lib/pkgconfig<br>ALL_SPDK_LIBS := spdk_accel_ioat spdk_blobfs spdk_jsonrpc \<br>spdk_accel_modules     spdk_blob           spdk_log \<br>spdk_accel             spdk_conf           spdk_lvol \<br>spdk_bdev_aio          spdk_dpdklibs       spdk_nbd \<br>spdk_bdev_delay        spdk_env_dpdk        \<br>spdk_bdev_error        spdk_env_dpdk_rpc   spdk_notify \<br>spdk_bdev_ftl          spdk_event_accel    spdk_nvme \<br>spdk_bdev_gpt          spdk_event_bdev     spdk_nvmf \<br>spdk_bdev_lvol         spdk_event_iscsi    spdk_rpc \<br>spdk_bdev_malloc       spdk_event_nbd      spdk_scsi \<br>spdk_bdev_modules          spdk_sock_modules \<br>spdk_bdev_null         spdk_event_nvmf     spdk_sock \<br>spdk_bdev_nvme         spdk_event          spdk_sock_posix \<br>spdk_bdev_passthru     spdk_event_scsi     spdk_syslibs \<br>spdk_bdev              spdk_event_sock     spdk_thread \<br>spdk_bdev_raid            spdk_trace \<br>spdk_bdev_split        spdk_event_vmd      spdk_util \<br>spdk_bdev_virtio       spdk_ftl            \<br>spdk_bdev_zone_block   spdk_ioat           spdk_vhost \<br>spdk_blob_bdev         spdk_iscsi          spdk_virtio \<br>spdk_blobfs_bdev       spdk_json           spdk_vmd	\<br>spdk_thread<br>SPDK_LIB := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> PKG_CONFIG_PATH=&quot;<span class="hljs-variable">$(PKG_CONFIG_PATH)</span>&quot; pkg-config --cflags  --libs  <span class="hljs-variable">$(ALL_SPDK_LIBS)</span>)</span><br><br><br><br><span class="hljs-section">rw_test:rw_test.cc</span><br>	<span class="hljs-variable">$(CC)</span> rw_test.cc -pthread -g  -o rw_test  -Wl,--no-as-needed  <span class="hljs-variable">$(SPDK_LIB)</span>  -Wl,--as-needed<br><br><span class="hljs-section">clean:</span><br>	rm rw_test<br></code></pre></td></tr></table></figure>

<p>运行时输出（注意-c 指定json文件名）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash">./rw_test -c zns.json<br>[2023-11-15 20:06:59.192639] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-11-15 20:06:59.192690] [ DPDK EAL parameters: test_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid1725836 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-11-15 20:06:59.199605] app.c: 786:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-11-15 20:06:59.225503] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-11-15 20:06:59.528947] rw_test.cc: 196:test_start: *NOTICE*: Successfully started the application<br>[2023-11-15 20:06:59.528977] rw_test.cc: 197:test_start: *NOTICE*: Opening the bdev Nvme0n1<br>[2023-11-15 20:06:59.528982] rw_test.cc: 206:test_start: *NOTICE*: Opening io channel<br>[2023-11-15 20:06:59.529413] rw_test.cc: 243:test_start: *NOTICE*: block size:4096 write unit:1 zone size:100000 zone num:2712 max append size:32 max open zone:8 max active zone:8<br>[2023-11-15 20:06:59.568018] rw_test.cc: 154:reset_zone_complete: *NOTICE*: reset zone complete.<br>[2023-11-15 20:06:59.568371] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x0<br>[2023-11-15 20:06:59.568379] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x1<br>[2023-11-15 20:06:59.568383] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x2<br>[2023-11-15 20:06:59.568386] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x3<br>[2023-11-15 20:06:59.568389] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x4<br>[2023-11-15 20:06:59.568392] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x5<br>[2023-11-15 20:06:59.568395] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x6<br>[2023-11-15 20:06:59.568413] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x7<br>[2023-11-15 20:06:59.568416] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x8<br>[2023-11-15 20:06:59.568419] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x9<br>[2023-11-15 20:06:59.568422] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xa<br>[2023-11-15 20:06:59.568426] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xb<br>[2023-11-15 20:06:59.568429] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xc<br>[2023-11-15 20:06:59.568432] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xd<br>[2023-11-15 20:06:59.568436] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xe<br>[2023-11-15 20:06:59.568440] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0xf<br>[2023-11-15 20:06:59.568444] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x10<br><span class="hljs-comment"># 省略部分输出</span><br>[2023-11-15 20:06:59.584544] rw_test.cc: 103:write_zone_complete: *NOTICE*: append lba:0x3000ff<br>[2023-11-15 20:06:59.584547] rw_test.cc: 115:write_zone_complete: *NOTICE*: write zone complete.<br>[2023-11-15 20:06:59.584555] rw_test.cc:  85:read_zone: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x0<br>[2023-11-15 20:06:59.584572] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x1<br>[2023-11-15 20:06:59.584589] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x2<br>[2023-11-15 20:06:59.584607] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x3<br>[2023-11-15 20:06:59.584624] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x4<br>[2023-11-15 20:06:59.584641] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x5<br>[2023-11-15 20:06:59.584658] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x6<br>[2023-11-15 20:06:59.584674] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x7<br>[2023-11-15 20:06:59.584690] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x8<br>[2023-11-15 20:06:59.584706] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x9<br>[2023-11-15 20:06:59.584721] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xa<br>[2023-11-15 20:06:59.584738] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xb<br>[2023-11-15 20:06:59.584754] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xc<br>[2023-11-15 20:06:59.584770] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xd<br>[2023-11-15 20:06:59.584786] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xe<br>[2023-11-15 20:06:59.584804] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0xf<br>[2023-11-15 20:06:59.584819] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x10<br><span class="hljs-comment"># 省略部分输出</span><br>[2023-11-15 20:06:59.605052] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x3000fd<br>[2023-11-15 20:06:59.605069] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x3000fe<br>[2023-11-15 20:06:59.605085] rw_test.cc:  68:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> lba:0x3000ff<br>[2023-11-15 20:06:59.605101] rw_test.cc:  54:read_zone_complete: *NOTICE*: <span class="hljs-built_in">read</span> zone complete.<br></code></pre></td></tr></table></figure>



<h2 id="2-实现env基本功能"><a href="#2-实现env基本功能" class="headerlink" title="2 实现env基本功能"></a>2 实现env基本功能</h2><p><strong>目标：</strong>利用SPDK使能ZNS SSD，使用SPDK的Bdev接口实现LevelDB Env，但只为了简单模拟测试，并不进行任何持久化，错误处理，并发保护的开发。简而言之，能跑起来就行，有bug也无所谓！</p>
<p><strong>基本思路：</strong> 将helpers&#x2F;memenv&#x2F;memenv.cc代码照搬过来，只是额外记录数据对应的ZNS LBA，在读文件前将数据从ZNS读取到内存缓冲区，写文件完成后将数据由内存缓冲区写入到ZNS SSD并记录对应LBA。SPDK相关的实现与之前demo类似。</p>
<p><strong>实现方式：</strong>同步接口调用SPDK异步的API，传递参数中包含信号量，接口调用API后调用信号量P操作，SPDK回调函数中调用信号量V操作，以此完成两者的同步。数据通路为读者&#x2F;写者$\Longleftrightarrow$内存缓冲区$\Longleftrightarrow$ZNS SSD，需要注意的是，如果调用异步接口的参数类型为指针类型，那么需保证在异步执行过程中<strong>指针指向内存区域不失效</strong>（要么指向堆区，要么指向栈区，但待异步执行完后再退出）</p>
<p>编译时leveldb的CMakeLists.txt只需要加上新增文件名，并不需要加上spdk相关的动态库，编写测试demo的时候链接leveldb与spdk相关库，为了省事，直接复制粘贴之前demo make时生成的一长串库名而不是使用pkg-config</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="Unref中互斥锁卡死"><a href="#Unref中互斥锁卡死" class="headerlink" title="Unref中互斥锁卡死"></a>Unref中互斥锁卡死</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) r<br>Starting program: /root/xxx/spdk_env/leveldb-spdk-env/test_env/test <br>[Thread debugging using libthread_db enabled]<br>Using host libthread_db library <span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.<br>[New Thread 0x7ffff6a35700 (LWP 57227)]<br>[2023-11-23 07:02:39.573057] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-11-23 07:02:39.573113] [ DPDK EAL parameters: test_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid57223 ]<br>[New Thread 0x7ffff6234700 (LWP 57228)]<br>[New Thread 0x7ffff5a33700 (LWP 57229)]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-11-23 07:02:39.580418] app.c: 786:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-11-23 07:02:39.606681] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-11-23 07:02:39.930868] /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:  23:start_fn: *NOTICE*: Successfully started the application<br>[2023-11-23 07:02:39.930889] /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:  24:start_fn: *NOTICE*: Opening the bdev Nvme0n1<br>[2023-11-23 07:02:39.930895] /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:  34:start_fn: *NOTICE*: Opening io channel<br>[2023-11-23 07:02:39.931095] /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:  45:start_fn: *NOTICE*: block size:4096 write unit:1 zone size:100000 zone num:2712 max append size:32 max open zone:8 max active zone:8<br>[2023-11-23 07:02:39.931103] /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:  57:start_fn: *NOTICE*: spdk init success.<br>ZNS SPDK Env init complete<br>^C<br>Thread 1 <span class="hljs-string">&quot;test&quot;</span> received signal SIGINT, Interrupt.<br>__lll_lock_wait (futex=futex@entry=0x555555600f20, private=0) at lowlevellock.c:52<br>52      lowlevellock.c: No such file or directory.<br>(gdb) bt<br><span class="hljs-comment">#0  __lll_lock_wait (futex=futex@entry=0x555555600f20, private=0) at lowlevellock.c:52</span><br><span class="hljs-comment">#1  0x00007ffff71340a3 in __GI___pthread_mutex_lock (mutex=0x555555600f20) at ../nptl/pthread_mutex_lock.c:80</span><br><span class="hljs-comment">#2  0x0000555555565809 in __gthread_mutex_lock (__mutex=0x555555600f20) at /usr/include/x86_64-linux-gnu/c++/9/bits/gthr-default.h:749</span><br><span class="hljs-comment">#3  0x0000555555565cee in std::mutex::lock (this=0x555555600f20) at /usr/include/c++/9/bits/std_mutex.h:100</span><br><span class="hljs-comment">#4  0x0000555555565d40 in leveldb::port::Mutex::Lock (this=0x555555600f20) at /root/xxx/spdk_env/leveldb-spdk-env/./port/port_stdcxx.h:59</span><br><span class="hljs-comment">#5  0x0000555555566ffa in leveldb::MutexLock::MutexLock (this=0x7fffffffdac0, mu=0x555555600f20) at /root/xxx/spdk_env/leveldb-spdk-env/./util/mutexlock.h:26</span><br><span class="hljs-comment">#6  0x00005555555910fe in leveldb::FileState::Unref (this=0x555555600f20) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:21</span><br><span class="hljs-comment">#7  0x000055555559247b in leveldb::ZnsSpdkEnv::RemoveFileInternal (this=0x5555555fdd60, fname=&quot;./testdb/000001.dbtmp&quot;) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:237</span><br><span class="hljs-comment">#8  0x0000555555592582 in leveldb::ZnsSpdkEnv::RemoveFile (this=0x5555555fdd60, fname=&quot;./testdb/000001.dbtmp&quot;) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:247</span><br><span class="hljs-comment">#9  0x000055555555ed31 in leveldb::DBImpl::RemoveObsoleteFiles (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:287</span><br><span class="hljs-comment">#10 0x0000555555564fe3 in leveldb::DB::Open (options=..., dbname=&quot;./testdb&quot;, dbptr=0x7fffffffde30) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:1527</span><br><span class="hljs-comment">#11 0x000055555555b5b0 in main () at test.cpp:39</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>解决思路</p>
</blockquote>
<p>①查看其他线程是否正在占用互斥锁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) info thread<br>  Id   Target Id                                           Frame <br>* 1    Thread 0x7ffff6a399c0 (LWP 70027) <span class="hljs-string">&quot;test&quot;</span>            __lll_lock_wait (futex=futex@entry=0x555555600f20, private=0) at lowlevellock.c:52<br>  2    Thread 0x7ffff6a35700 (LWP 70031) <span class="hljs-string">&quot;reactor_0&quot;</span>       __tls_get_addr () at ../sysdeps/x86_64/tls_get_addr.S:38<br>  3    Thread 0x7ffff6234700 (LWP 70032) <span class="hljs-string">&quot;eal-intr-thread&quot;</span> 0x00007ffff705646e <span class="hljs-keyword">in</span> epoll_wait (epfd=6, events=0x7ffff6232b80, maxevents=1, <span class="hljs-built_in">timeout</span>=-1) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30<br>  4    Thread 0x7ffff5a33700 (LWP 70033) <span class="hljs-string">&quot;telemetry-v2&quot;</span>    0x00007ffff713c4ff <span class="hljs-keyword">in</span> __libc_accept (fd=9, addr=..., len=0x0) at ../sysdeps/unix/sysv/linux/accept.c:26<br></code></pre></td></tr></table></figure>

<p><strong>结果：</strong>并未发现占用refs_mutex_的线程</p>
<p>参考博客：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6958378692754014222">GDB多线程调试-发现卡死的线程</a></p>
<p>②将代码中的port::Mutex MutexLock换成未封装的api std::mutex std::lock_guard</p>
<p><strong>结果：</strong>报错仍然发生，不是封装api的问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FileState::Unref</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">bool</span> do_delete = <span class="hljs-literal">false</span>;<br><br>  &#123;<br>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lk</span><span class="hljs-params">(refs_mutex_)</span></span>;<br>    --refs_;<br>    <span class="hljs-built_in">assert</span>(refs_ &gt;= <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (refs_ &lt;= <span class="hljs-number">0</span>) &#123;<br>      do_delete = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (do_delete) &#123;<br>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>③ 怀疑对应数据已被释放</p>
<p><strong>卡死时变量值</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">Thread 1 <span class="hljs-string">&quot;test&quot;</span> received signal SIGINT, Interrupt.<br>__lll_lock_wait (futex=futex@entry=0x555555600f20, private=0) at lowlevellock.c:52<br>52      lowlevellock.c: No such file or directory.<br>(gdb) bt<br><span class="hljs-comment">#0  __lll_lock_wait (futex=futex@entry=0x555555600f20, private=0) at lowlevellock.c:52</span><br><span class="hljs-comment">#1  0x00007ffff71340a3 in __GI___pthread_mutex_lock (mutex=0x555555600f20) at ../nptl/pthread_mutex_lock.c:80</span><br><span class="hljs-comment">#2  0x0000555555565809 in __gthread_mutex_lock (__mutex=0x555555600f20) at /usr/include/x86_64-linux-gnu/c++/9/bits/gthr-default.h:749</span><br><span class="hljs-comment">#3  0x0000555555565cee in std::mutex::lock (this=0x555555600f20) at /usr/include/c++/9/bits/std_mutex.h:100</span><br><span class="hljs-comment">#4  0x000055555559397c in std::lock_guard&lt;std::mutex&gt;::lock_guard (this=0x7fffffffdac0, __m=...) at /usr/include/c++/9/bits/std_mutex.h:159</span><br><span class="hljs-comment">#5  0x00005555555910fe in leveldb::FileState::Unref (this=0x555555600f20) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:21</span><br><span class="hljs-comment">#6  0x000055555559247b in leveldb::ZnsSpdkEnv::RemoveFileInternal (this=0x5555555fdd60, fname=&quot;./testdb/000001.dbtmp&quot;) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:237</span><br><span class="hljs-comment">#7  0x0000555555592582 in leveldb::ZnsSpdkEnv::RemoveFile (this=0x5555555fdd60, fname=&quot;./testdb/000001.dbtmp&quot;) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:247</span><br><span class="hljs-comment">#8  0x000055555555ed31 in leveldb::DBImpl::RemoveObsoleteFiles (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:287</span><br><span class="hljs-comment">#9  0x0000555555564fe3 in leveldb::DB::Open (options=..., dbname=&quot;./testdb&quot;, dbptr=0x7fffffffde30) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:1527</span><br><span class="hljs-comment">#10 0x000055555555b5b0 in main () at test.cpp:39</span><br>(gdb) f 5<br><span class="hljs-comment">#5  0x00005555555910fe in leveldb::FileState::Unref (this=0x555555600f20) at /root/xxx/spdk_env/leveldb-spdk-env/zns_spdk_env/filesystem.cc:21</span><br>21          std::lock_guard&lt;std::mutex&gt; lk(refs_mutex_);<br>(gdb) p *this<br><span class="hljs-variable">$1</span> = &#123;refs_mutex_ = &#123;&lt;std::__mutex_base&gt; = &#123;_M_mutex = &#123;__data = &#123;__lock = 2, __count = 32767, __owner = -149799840, __nusers = 32767, __kind = 0, __spins = 0, __elision = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, <br>        __size = <span class="hljs-string">&quot;\002\000\000\000\377\177\000\000`&lt;\022\367\377\177&quot;</span>, <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 25 <span class="hljs-built_in">times</span>&gt;, __align = 140733193388034&#125;&#125;, &lt;No data fields&gt;&#125;, refs_ = 0, blocks_mutex_ = &#123;&lt;std::__mutex_base&gt; = &#123;_M_mutex = &#123;__data = &#123;__lock = 0, <br>          __count = 0, __owner = 0, __nusers = 0, __kind = 0, __spins = 0, __elision = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, __size = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 39 <span class="hljs-built_in">times</span>&gt;, __align = 0&#125;&#125;, &lt;No data fields&gt;&#125;, buffer_ = 0x200033a00000 <span class="hljs-string">&quot;&quot;</span>, <br>  size_ = 0, block_addrs_ = std::vector of length 1, capacity 1 = &#123;&#123;start_block = 93824992725104, num_block = 1432137744&#125;&#125;&#125;<br>(gdb) p refs_<br><span class="hljs-variable">$2</span> = 0<br></code></pre></td></tr></table></figure>

<p>引用计数在获取锁时已变成0，_M_mutex数据构成也很奇怪</p>
<p><strong>正常this输出</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) p *this<br><span class="hljs-variable">$5</span> = &#123;refs_mutex_ = &#123;&lt;std::__mutex_base&gt; = &#123;_M_mutex = &#123;__data = &#123;__lock = 0, __count = 0, __owner = 0, __nusers = 0, __kind = 0, __spins = 0, __elision = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, <br>        __size = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 39 <span class="hljs-built_in">times</span>&gt;, __align = 0&#125;&#125;, &lt;No data fields&gt;&#125;, refs_ = 2, blocks_mutex_ = &#123;&lt;std::__mutex_base&gt; = &#123;_M_mutex = &#123;__data = &#123;__lock = 0, __count = 0, __owner = 0, __nusers = 0, __kind = 0, __spins = 0, <br>          __elision = 0, __list = &#123;__prev = 0x0, __next = 0x0&#125;&#125;, __size = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 39 <span class="hljs-built_in">times</span>&gt;, __align = 0&#125;&#125;, &lt;No data fields&gt;&#125;, buffer_ = 0x200033600000 <span class="hljs-string">&quot;\225|\271\305\&quot;&quot;</span>, size_ = 41, <br>  block_addrs_ = std::vector of length 1, capacity 1 = &#123;&#123;start_block = 292, num_block = 1&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>故追踪每一个Unref调用，找到对应文件名（.&#x2F;testdb&#x2F;000001.dbtmp）的上一个Unref，记录出错文件的引用计数变化</p>
<p>gdb时显示变量值的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">p ((leveldb::ZnsSpdkEnv*) options.env)-&gt;file_map_<br> p *(leveldb::FileState*)<span class="hljs-number">0</span>x555555600f20<br></code></pre></td></tr></table></figure>



<p><strong>问题关键</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"> p file_map_<br><span class="hljs-variable">$46</span> = std::map with 6 elements = &#123;[<span class="hljs-string">&quot;./testdb/000001.dbtmp&quot;</span>] = 0x555555600f20, [<span class="hljs-string">&quot;./testdb/000002.dbtmp&quot;</span>] = 0x555555603180, [<span class="hljs-string">&quot;./testdb/000003.log&quot;</span>] = 0x5555555fca40, [<span class="hljs-string">&quot;./testdb/CURRENT&quot;</span>] = 0x555555600f20, <br>  [<span class="hljs-string">&quot;./testdb/MANIFEST-000001&quot;</span>] = 0x555555602bd0, [<span class="hljs-string">&quot;./testdb/MANIFEST-000002&quot;</span>] = 0x555555603040&#125;<br> <br><span class="hljs-comment"># ./testdb/000001.dbtmp与./testdb/CURRENT指向同一个文件</span><br></code></pre></td></tr></table></figure>



<p><strong>错误原因：</strong>写代码时误删了file_map_.erase(src)这行，导致GetChildren方法返回了已被析构的文件名，导致调用锁时卡死。所以当线程因为互斥锁卡死时，一种可能是另一个线程持有这把锁没有释放，一种可能是<strong>互斥锁对应的空间已被析构，其数据为随机脏数据</strong>。</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311241731162.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311241756233.png" srcset="/img/loading.gif" lazyload></p>
<p>ps：时常用git提交已经更改的代码并加上简单注释，避免误删代码debug很久的情况</p>
<h4 id="leveldb单个文件大小"><a href="#leveldb单个文件大小" class="headerlink" title="leveldb单个文件大小"></a>leveldb单个文件大小</h4><p>write_buffer_size参数如何影响log文件大小</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-comment">// Amount of data to build up in memory (backed by an unsorted log</span><br>  <span class="hljs-comment">// on disk) before converting to a sorted on-disk file.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Larger values increase performance, especially during bulk loads.</span><br>  <span class="hljs-comment">// Up to two write buffers may be held in memory at the same time,</span><br>  <span class="hljs-comment">// so you may wish to adjust this parameter to control memory usage.</span><br>  <span class="hljs-comment">// Also, a larger write buffer will result in a longer recovery time</span><br>  <span class="hljs-comment">// the next time the database is opened.</span><br>  <span class="hljs-type">size_t</span> write_buffer_size = <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br><span class="hljs-function">Status <span class="hljs-title">DBImpl::MakeRoomForWrite</span><span class="hljs-params">(<span class="hljs-type">bool</span> force)</span> </span>&#123;<br>  mutex_.<span class="hljs-built_in">AssertHeld</span>();<br>  <span class="hljs-built_in">assert</span>(!writers_.<span class="hljs-built_in">empty</span>());<br>  <span class="hljs-type">bool</span> allow_delay = !force;<br>  Status s;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!bg_error_.<span class="hljs-built_in">ok</span>()) &#123;<br>      <span class="hljs-comment">// Yield previous error</span><br>      s = bg_error_;<br>      <span class="hljs-keyword">break</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allow_delay &amp;&amp; versions_-&gt;<span class="hljs-built_in">NumLevelFiles</span>(<span class="hljs-number">0</span>) &gt;=<br>                                  config::kL0_SlowdownWritesTrigger) &#123;<br>      <span class="hljs-comment">// We are getting close to hitting a hard limit on the number of</span><br>      <span class="hljs-comment">// L0 files.  Rather than delaying a single write by several</span><br>      <span class="hljs-comment">// seconds when we hit the hard limit, start delaying each</span><br>      <span class="hljs-comment">// individual write by 1ms to reduce latency variance.  Also,</span><br>      <span class="hljs-comment">// this delay hands over some CPU to the compaction thread in</span><br>      <span class="hljs-comment">// case it is sharing the same core as the writer.</span><br>      mutex_.<span class="hljs-built_in">Unlock</span>();<br>      env_-&gt;<span class="hljs-built_in">SleepForMicroseconds</span>(<span class="hljs-number">1000</span>);<br>      allow_delay = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// Do not delay a single write more than once</span><br>      mutex_.<span class="hljs-built_in">Lock</span>();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!force &amp;&amp;<br>               (mem_-&gt;<span class="hljs-built_in">ApproximateMemoryUsage</span>() &lt;= options_.write_buffer_size)) &#123;<br>              <span class="hljs-comment">// There is room in current memtable</span><br>      <span class="hljs-comment">// memtable未达到空间限制，仍可以写入</span><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br>  <span class="hljs-comment">// May temporarily unlock and wait.</span><br>  Status status = <span class="hljs-built_in">MakeRoomForWrite</span>(updates == <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-type">uint64_t</span> last_sequence = versions_-&gt;<span class="hljs-built_in">LastSequence</span>();<br>  Writer* last_writer = &amp;w;<br>  <span class="hljs-keyword">if</span> (status.<span class="hljs-built_in">ok</span>() &amp;&amp; updates != <span class="hljs-literal">nullptr</span>) &#123;  <span class="hljs-comment">// nullptr batch is for compactions</span><br>    WriteBatch* write_batch = <span class="hljs-built_in">BuildBatchGroup</span>(&amp;last_writer);<br>    WriteBatchInternal::<span class="hljs-built_in">SetSequence</span>(write_batch, last_sequence + <span class="hljs-number">1</span>);<br>    last_sequence += WriteBatchInternal::<span class="hljs-built_in">Count</span>(write_batch);<br><br>    <span class="hljs-comment">// Add to log and apply to memtable.  We can release the lock</span><br>    <span class="hljs-comment">// during this phase since &amp;w is currently responsible for logging</span><br>    <span class="hljs-comment">// and protects against concurrent loggers and concurrent writes</span><br>    <span class="hljs-comment">// into mem_.</span><br>    &#123;<br>      mutex_.<span class="hljs-built_in">Unlock</span>();<br>      status = log_-&gt;<span class="hljs-built_in">AddRecord</span>(WriteBatchInternal::<span class="hljs-built_in">Contents</span>(write_batch));<br> <br><span class="hljs-comment">// 若达到空间限制，在将memtable写入sst文件后删除log，创建新的log文件</span><br> <span class="hljs-comment">// Attempt to switch to a new memtable and trigger compaction of old</span><br>      <span class="hljs-built_in">assert</span>(versions_-&gt;<span class="hljs-built_in">PrevLogNumber</span>() == <span class="hljs-number">0</span>);<br>      <span class="hljs-type">uint64_t</span> new_log_number = versions_-&gt;<span class="hljs-built_in">NewFileNumber</span>();<br>      WritableFile* lfile = <span class="hljs-literal">nullptr</span>;<br>      s = env_-&gt;<span class="hljs-built_in">NewWritableFile</span>(<span class="hljs-built_in">LogFileName</span>(dbname_, new_log_number), &amp;lfile);<br>      <span class="hljs-keyword">if</span> (!s.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-comment">// Avoid chewing through file number space in a tight loop.</span><br>        versions_-&gt;<span class="hljs-built_in">ReuseFileNumber</span>(new_log_number);<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">delete</span> log_;<br><br>      s = logfile_-&gt;<span class="hljs-built_in">Close</span>();<br>      <span class="hljs-keyword">if</span> (!s.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-comment">// We may have lost some data written to the previous log file.</span><br>        <span class="hljs-comment">// Switch to the new log file anyway, but record as a background</span><br>        <span class="hljs-comment">// error so we do not attempt any more writes.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// We could perhaps attempt to save the memtable corresponding</span><br>        <span class="hljs-comment">// to log file and suppress the error if that works, but that</span><br>        <span class="hljs-comment">// would add more complexity in a critical code path.</span><br>        <span class="hljs-built_in">RecordBackgroundError</span>(s);<br>      &#125;<br>      <span class="hljs-keyword">delete</span> logfile_;<br><br>      logfile_ = lfile;<br>      logfile_number_ = new_log_number;<br>      log_ = <span class="hljs-keyword">new</span> log::<span class="hljs-built_in">Writer</span>(lfile);<br>      imm_ = mem_;<br>      has_imm_.<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>, std::memory_order_release);<br>      mem_ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MemTable</span>(internal_comparator_);<br>      mem_-&gt;<span class="hljs-built_in">Ref</span>();<br>      force = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// Do not force another compaction if have room</span><br>      <span class="hljs-built_in">MaybeScheduleCompaction</span>();<br></code></pre></td></tr></table></figure>



<p>max_file_size参数如何影响compaction输出文件大小</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-comment">// Leveldb will write up to this amount of bytes to a file before</span><br>  <span class="hljs-comment">// switching to a new one.</span><br>  <span class="hljs-comment">// Most clients should leave this parameter alone.  However if your</span><br>  <span class="hljs-comment">// filesystem is more efficient with larger files, you could</span><br>  <span class="hljs-comment">// consider increasing the value.  The downside will be longer</span><br>  <span class="hljs-comment">// compactions and hence longer latency/performance hiccups.</span><br>  <span class="hljs-comment">// Another reason to increase this parameter might be when you are</span><br>  <span class="hljs-comment">// initially populating a large database.</span><br>  <span class="hljs-type">size_t</span> max_file_size = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title">TargetFileSize</span><span class="hljs-params">(<span class="hljs-type">const</span> Options* options)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> options-&gt;max_file_size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span> <span class="hljs-title">MaxFileSizeForLevel</span><span class="hljs-params">(<span class="hljs-type">const</span> Options* options, <span class="hljs-type">int</span> level)</span> </span>&#123;<br>  <span class="hljs-comment">// We could vary per level to reduce number of files?</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">TargetFileSize</span>(options);<br>&#125;<br><br>Compaction::<span class="hljs-built_in">Compaction</span>(<span class="hljs-type">const</span> Options* options, <span class="hljs-type">int</span> level)<br>    : <span class="hljs-built_in">level_</span>(level),<br>      <span class="hljs-built_in">max_output_file_size_</span>(<span class="hljs-built_in">MaxFileSizeForLevel</span>(options, level)),<br>      <span class="hljs-built_in">input_version_</span>(<span class="hljs-literal">nullptr</span>),<br>      <span class="hljs-built_in">grandparent_index_</span>(<span class="hljs-number">0</span>),<br>      <span class="hljs-built_in">seen_key_</span>(<span class="hljs-literal">false</span>),<br>      <span class="hljs-built_in">overlapped_bytes_</span>(<span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; config::kNumLevels; i++) &#123;<br>    level_ptrs_[i] = <span class="hljs-number">0</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">MaxOutputFileSize</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> max_output_file_size_; &#125;<br><br><br><span class="hljs-comment">// Close output file if it is big enough</span><br><span class="hljs-keyword">if</span> (compact-&gt;builder-&gt;<span class="hljs-built_in">FileSize</span>() &gt;=<br>    compact-&gt;compaction-&gt;<span class="hljs-built_in">MaxOutputFileSize</span>()) &#123;<br>    status = <span class="hljs-built_in">FinishCompactionOutputFile</span>(compact, input);<br>    <span class="hljs-keyword">if</span> (!status.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="not-an-sstable-bad-magic-number"><a href="#not-an-sstable-bad-magic-number" class="headerlink" title="not an sstable (bad magic number)"></a>not an sstable (bad magic number)</h4><p><strong>出错代码</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Status <span class="hljs-title">Footer::DecodeFrom</span><span class="hljs-params">(Slice* input)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (input-&gt;<span class="hljs-built_in">size</span>() &lt; kEncodedLength) &#123;<br>    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">&quot;not an sstable (footer too short)&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* magic_ptr = input-&gt;<span class="hljs-built_in">data</span>() + kEncodedLength - <span class="hljs-number">8</span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> magic_lo = <span class="hljs-built_in">DecodeFixed32</span>(magic_ptr);<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> magic_hi = <span class="hljs-built_in">DecodeFixed32</span>(magic_ptr + <span class="hljs-number">4</span>);<br>  <span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> magic = ((<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(magic_hi) &lt;&lt; <span class="hljs-number">32</span>) |<br>                          (<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(magic_lo)));<br>  <span class="hljs-keyword">if</span> (magic != kTableMagicNumber) &#123;<br>    <span class="hljs-keyword">return</span> Status::<span class="hljs-built_in">Corruption</span>(<span class="hljs-string">&quot;not an sstable (bad magic number)&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// 省略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>以Corruption函数为断点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">Thread 5 <span class="hljs-string">&quot;test&quot;</span> hit Breakpoint 1, leveldb::Status::Corruption (msg=..., msg2=...) at /root/xxx/spdk_env/leveldb-spdk-env/include/leveldb/status.h:43<br>43        static Status Corruption(const Slice&amp; msg, const Slice&amp; msg2 = Slice()) &#123;<br>(gdb) bt<br><span class="hljs-comment">#0  leveldb::Status::Corruption (msg=..., msg2=...) at /root/xxx/spdk_env/leveldb-spdk-env/include/leveldb/status.h:43</span><br><span class="hljs-comment">#1  0x00005555555a2e62 in leveldb::Footer::DecodeFrom (this=0x7fffefffd4a0, input=0x7fffefffd460) at /root/xxx/spdk_env/leveldb-spdk-env/table/format.cc:54</span><br><span class="hljs-comment">#2  0x000055555558a03c in leveldb::Table::Open (options=..., file=0x7fffe8000cd0, size=2838930, table=0x7fffefffd558) at /root/xxx/spdk_env/leveldb-spdk-env/table/table.cc:52</span><br><span class="hljs-comment">#3  0x0000555555577acc in leveldb::TableCache::FindTable (this=0x5555555fcb20, file_number=5, file_size=2838930, handle=0x7fffefffd628) at /root/xxx/spdk_env/leveldb-spdk-env/db/table_cache.cc:60</span><br><span class="hljs-comment">#4  0x0000555555577c5b in leveldb::TableCache::NewIterator (this=0x5555555fcb20, options=..., file_number=5, file_size=2838930, tableptr=0x0) at /root/xxx/spdk_env/leveldb-spdk-env/db/table_cache.cc:86</span><br><span class="hljs-comment">#5  0x000055555559ec06 in leveldb::BuildTable (dbname=&quot;./testdb&quot;, env=0x5555555fdd60, options=..., table_cache=0x5555555fcb20, iter=0x7fffe8000b90, meta=0x7fffefffd7f0)</span><br>    at /root/xxx/spdk_env/leveldb-spdk-env/db/builder.cc:62<br><span class="hljs-comment">#6  0x0000555555560245 in leveldb::DBImpl::WriteLevel0Table (this=0x5555555f4620, mem=0x555555603240, edit=0x7fffefffd8b0, base=0x5555555fa2e0) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:519</span><br><span class="hljs-comment">#7  0x0000555555560586 in leveldb::DBImpl::CompactMemTable (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:557</span><br><span class="hljs-comment">#8  0x0000555555560f5b in leveldb::DBImpl::BackgroundCompaction (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:706</span><br><span class="hljs-comment">#9  0x0000555555560ea9 in leveldb::DBImpl::BackgroundCall (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:691</span><br><span class="hljs-comment">#10 0x0000555555560dfe in leveldb::DBImpl::BGWork (db=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:680</span><br><span class="hljs-comment">#11 0x0000555555599e7e in leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadMain (this=0x5555555ca1a0 &lt;leveldb::Env::Default()::env_container&gt;)</span><br>    at /root/xxx/spdk_env/leveldb-spdk-env/util/env_posix.cc:850<br><span class="hljs-comment">#12 0x0000555555599af0 in leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint (env=0x5555555ca1a0 &lt;leveldb::Env::Default()::env_container&gt;)</span><br>    at /root/xxx/spdk_env/leveldb-spdk-env/util/env_posix.cc:751<br><span class="hljs-comment">#13 0x000055555559bc19 in std::__invoke_impl&lt;void, void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; (</span><br>    __f=@0x5555555e9c10: 0x555555599ad4 &lt;leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint(leveldb::(anonymous namespace)::PosixEnv*)&gt;) at /usr/include/c++/9/bits/invoke.h:60<br><span class="hljs-comment">#14 0x000055555559bb79 in std::__invoke&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; (</span><br>    __fn=@0x5555555e9c10: 0x555555599ad4 &lt;leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint(leveldb::(anonymous namespace)::PosixEnv*)&gt;) at /usr/include/c++/9/bits/invoke.h:95<br><span class="hljs-comment">#15 0x000055555559bad9 in std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt;::_M_invoke&lt;0, 1&gt; (this=0x5555555e9c08)</span><br>    at /usr/include/c++/9/thread:244<br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#16 0x000055555559ba7f in std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt;::operator() (this=0x5555555e9c08)</span><br>    at /usr/include/c++/9/thread:251<br><span class="hljs-comment">#17 0x000055555559ba54 in std::thread::_State_impl&lt;std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt; &gt;::_M_run (</span><br>    this=0x5555555e9c00) at /usr/include/c++/9/thread:195<br><span class="hljs-comment">#18 0x00007ffff723fdf4 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="hljs-comment">#19 0x00007ffff7131609 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:477</span><br><span class="hljs-comment">#20 0x00007ffff7056133 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95</span><br>(gdb) f 1<br><span class="hljs-comment">#1  0x00005555555a2e62 in leveldb::Footer::DecodeFrom (this=0x7fffefffd4a0, input=0x7fffefffd460) at /root/xxx/spdk_env/leveldb-spdk-env/table/format.cc:54</span><br>warning: Source file is more recent than executable.<br>54          <span class="hljs-built_in">return</span> Status::Corruption(<span class="hljs-string">&quot;not an sstable (bad magic number)&quot;</span>);<br>(gdb) p/x magic<br><span class="hljs-variable">$1</span> = 0x62686878637a6462<br>(gdb) p/x kTableMagicNumber<br><span class="hljs-variable">$2</span> = 0xdb4775248b80fb57<br></code></pre></td></tr></table></figure>

<p>思路：文件内容读取出错，首先追踪对应文件的写入过程，查看写入数据是否正常，而后再检查读取过程是否正常。</p>
<p>不过gdb调试时瞅了瞅代码找到了错误：将乘号写成了加号</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311261007491.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="assert-internal-key-size-8"><a href="#assert-internal-key-size-8" class="headerlink" title="assert(internal_key.size() &gt;&#x3D; 8)"></a>assert(internal_key.size() &gt;&#x3D; 8)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">test</span>: /root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h:96: leveldb::Slice leveldb::ExtractUserKey(const leveldb::Slice&amp;): Assertion `internal_key.size() &gt;= 8<span class="hljs-string">&#x27; failed.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Thread 5 &quot;test&quot; received signal SIGABRT, Aborted.</span><br><span class="hljs-string">[Switching to Thread 0x7fffeffff700 (LWP 213089)]</span><br><span class="hljs-string">__GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50</span><br><span class="hljs-string">50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.</span><br><span class="hljs-string">(gdb) bt</span><br><span class="hljs-string">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50</span><br><span class="hljs-string">#1  0x00007ffff6f59859 in __GI_abort () at abort.c:79</span><br><span class="hljs-string">#2  0x00007ffff6f59729 in __assert_fail_base (fmt=0x7ffff70ef588 &quot;%s%s%s:%u: %s%sAssertion `%s&#x27;</span> failed.\n%n<span class="hljs-string">&quot;, assertion=0x5555555a4380 &quot;</span>internal_key.size() &gt;= 8<span class="hljs-string">&quot;, </span><br><span class="hljs-string">    file=0x5555555a4348 &quot;</span>/root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h<span class="hljs-string">&quot;, line=96, function=&lt;optimized out&gt;) at assert.c:92</span><br><span class="hljs-string">#3  0x00007ffff6f6afd6 in __GI___assert_fail (assertion=0x5555555a4380 &quot;</span>internal_key.size() &gt;= 8<span class="hljs-string">&quot;, file=0x5555555a4348 &quot;</span>/root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h<span class="hljs-string">&quot;, line=96, </span><br><span class="hljs-string">    function=0x5555555a4308 &quot;</span>leveldb::Slice leveldb::ExtractUserKey(const leveldb::Slice&amp;)<span class="hljs-string">&quot;) at assert.c:101</span><br><span class="hljs-string">#4  0x0000555555566024 in leveldb::ExtractUserKey (internal_key=...) at /root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h:96</span><br><span class="hljs-string">#5  0x00005555555737f8 in leveldb::InternalKeyComparator::Compare (this=0x5555555f58b8, akey=..., bkey=...) at /root/xxx/spdk_env/leveldb-spdk-env/db/dbformat.cc:52</span><br><span class="hljs-string">#6  0x0000555555587d5a in leveldb::(anonymous namespace)::MergingIterator::FindSmallest (this=0x7fffe80029f0) at /root/xxx/spdk_env/leveldb-spdk-env/table/merger.cc:155</span><br><span class="hljs-string">#7  0x00005555555879b1 in leveldb::(anonymous namespace)::MergingIterator::Next (this=0x7fffe80029f0) at /root/xxx/spdk_env/leveldb-spdk-env/table/merger.cc:78</span><br><span class="hljs-string">#8  0x000055555556280a in leveldb::DBImpl::DoCompactionWork (this=0x5555555f4620, compact=0x55559a388600) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:1013</span><br><span class="hljs-string">#9  0x00005555555614a5 in leveldb::DBImpl::BackgroundCompaction (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:750</span><br><span class="hljs-string">#10 0x0000555555560ea9 in leveldb::DBImpl::BackgroundCall (this=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:691</span><br><span class="hljs-string">#11 0x0000555555560dfe in leveldb::DBImpl::BGWork (db=0x5555555f4620) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:680</span><br><span class="hljs-string">#12 0x0000555555599e7c in leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadMain (this=0x5555555ca1a0 &lt;leveldb::Env::Default()::env_container&gt;)</span><br><span class="hljs-string">    at /root/xxx/spdk_env/leveldb-spdk-env/util/env_posix.cc:850</span><br><span class="hljs-string">#13 0x0000555555599aee in leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint (env=0x5555555ca1a0 &lt;leveldb::Env::Default()::env_container&gt;)</span><br><span class="hljs-string">    at /root/xxx/spdk_env/leveldb-spdk-env/util/env_posix.cc:751</span><br><span class="hljs-string">#14 0x000055555559bc17 in std::__invoke_impl&lt;void, void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; (</span><br><span class="hljs-string">    __f=@0x5555555e9c10: 0x555555599ad2 &lt;leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint(leveldb::(anonymous namespace)::PosixEnv*)&gt;) at /usr/include/c++/9/bits/invoke.h:60</span><br><span class="hljs-string">#15 0x000055555559bb77 in std::__invoke&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; (</span><br><span class="hljs-string">    __fn=@0x5555555e9c10: 0x555555599ad2 &lt;leveldb::(anonymous namespace)::PosixEnv::BackgroundThreadEntryPoint(leveldb::(anonymous namespace)::PosixEnv*)&gt;) at /usr/include/c++/9/bits/invoke.h:95</span><br><span class="hljs-string">#16 0x000055555559bad7 in std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt;::_M_invoke&lt;0, 1&gt; (this=0x5555555e9c08)</span><br><span class="hljs-string">--Type &lt;RET&gt; for more, q to quit, c to continue without paging--</span><br><span class="hljs-string">    at /usr/include/c++/9/thread:244</span><br><span class="hljs-string">#17 0x000055555559ba7d in std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt;::operator() (this=0x5555555e9c08)</span><br><span class="hljs-string">    at /usr/include/c++/9/thread:251</span><br><span class="hljs-string">#18 0x000055555559ba52 in std::thread::_State_impl&lt;std::thread::_Invoker&lt;std::tuple&lt;void (*)(leveldb::(anonymous namespace)::PosixEnv*), leveldb::(anonymous namespace)::PosixEnv*&gt; &gt; &gt;::_M_run (</span><br><span class="hljs-string">    this=0x5555555e9c00) at /usr/include/c++/9/thread:195</span><br><span class="hljs-string">#19 0x00007ffff723fdf4 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="hljs-string">#20 0x00007ffff7131609 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:477</span><br><span class="hljs-string">#21 0x00007ffff7056133 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95</span><br><span class="hljs-string">(gdb) f 3</span><br><span class="hljs-string">#3  0x00007ffff6f6afd6 in __GI___assert_fail (assertion=0x5555555a4380 &quot;</span>internal_key.size() &gt;= 8<span class="hljs-string">&quot;, file=0x5555555a4348 &quot;</span>/root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h<span class="hljs-string">&quot;, line=96, </span><br><span class="hljs-string">    function=0x5555555a4308 &quot;</span>leveldb::Slice leveldb::ExtractUserKey(const leveldb::Slice&amp;)<span class="hljs-string">&quot;) at assert.c:101</span><br><span class="hljs-string">101     assert.c: No such file or directory.</span><br><span class="hljs-string">(gdb) f 4</span><br><span class="hljs-string">#4  0x0000555555566024 in leveldb::ExtractUserKey (internal_key=...) at /root/xxx/spdk_env/leveldb-spdk-env/./db/dbformat.h:96</span><br><span class="hljs-string">96        assert(internal_key.size() &gt;= 8);</span><br><span class="hljs-string">(gdb) p internal_key.size()</span><br><span class="hljs-string"><span class="hljs-variable">$1</span> = 0</span><br><span class="hljs-string">(gdb) f 5</span><br><span class="hljs-string">#5  0x00005555555737f8 in leveldb::InternalKeyComparator::Compare (this=0x5555555f58b8, akey=..., bkey=...) at /root/xxx/spdk_env/leveldb-spdk-env/db/dbformat.cc:52</span><br><span class="hljs-string">52        int r = user_comparator_-&gt;Compare(ExtractUserKey(akey), ExtractUserKey(bkey));</span><br><span class="hljs-string">(gdb) p  akey</span><br><span class="hljs-string"><span class="hljs-variable">$2</span> = (const leveldb::Slice &amp;) @0x7fffefffd730: &#123;data_ = 0x7fffe8027030 &quot;</span>xlyzwbbnghkunsusoox\001&gt;\257<span class="hljs-string">&quot;, size_ = 27&#125;</span><br><span class="hljs-string">(gdb) p bkey</span><br><span class="hljs-string"><span class="hljs-variable">$3</span> = (const leveldb::Slice &amp;) @0x7fffefffd740: &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;</span><br><span class="hljs-string">(gdb) f 6</span><br><span class="hljs-string">#6  0x0000555555587d5a in leveldb::(anonymous namespace)::MergingIterator::FindSmallest (this=0x7fffe80029f0) at /root/xxx/spdk_env/leveldb-spdk-env/table/merger.cc:155</span><br><span class="hljs-string">155           &#125; else if (comparator_-&gt;Compare(child-&gt;key(), smallest-&gt;key()) &lt; 0) &#123;</span><br><span class="hljs-string">(gdb) p smallest</span><br><span class="hljs-string"><span class="hljs-variable">$4</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p children_</span><br><span class="hljs-string"><span class="hljs-variable">$5</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p *children_</span><br><span class="hljs-string"><span class="hljs-variable">$6</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p smallest</span><br><span class="hljs-string"><span class="hljs-variable">$7</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p *smallest</span><br><span class="hljs-string"><span class="hljs-variable">$8</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p i</span><br><span class="hljs-string"><span class="hljs-variable">$9</span> = 1</span><br><span class="hljs-string">(gdb) p children_ </span><br><span class="hljs-string"><span class="hljs-variable">$10</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p children_[0] </span><br><span class="hljs-string"><span class="hljs-variable">$11</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p children_[1] </span><br><span class="hljs-string"><span class="hljs-variable">$12</span> = &#123;iter_ = 0x7fffe8023310, valid_ = true, key_ = &#123;data_ = 0x7fffe8027030 &quot;</span>xlyzwbbnghkunsusoox\001&gt;\257<span class="hljs-string">&quot;, size_ = 27&#125;&#125;</span><br><span class="hljs-string">(gdb) p children_[2] </span><br><span class="hljs-string"><span class="hljs-variable">$13</span> = &#123;iter_ = 0x25, valid_ = 232, key_ = &#123;data_ = 0x7fffe80295f0 &quot;</span><span class="hljs-string">&quot;, size_ = 124249108909781&#125;&#125;</span><br><span class="hljs-string">(gdb) p children_[3] </span><br><span class="hljs-string"><span class="hljs-variable">$14</span> = &#123;iter_ = 0x25, valid_ = false, key_ = &#123;data_ = 0x7fffe8039380 &quot;</span>\260\351\002\350\377\177<span class="hljs-string">&quot;, size_ = 32&#125;&#125;</span><br><span class="hljs-string">(gdb) p children_[4] </span><br><span class="hljs-string"><span class="hljs-variable">$15</span> = &#123;iter_ = 0x25, valid_ = 144, key_ = &#123;data_ = 0x3f48 &lt;error: Cannot access memory at address 0x3f48&gt;, size_ = 4294981456&#125;&#125;</span><br><span class="hljs-string">(gdb) p n_</span><br><span class="hljs-string"><span class="hljs-variable">$16</span> = 2</span><br><span class="hljs-string">(gdb) p smallest </span><br><span class="hljs-string"><span class="hljs-variable">$17</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p *smallest </span><br><span class="hljs-string"><span class="hljs-variable">$18</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p current_</span><br><span class="hljs-string"><span class="hljs-variable">$19</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p *current_</span><br><span class="hljs-string"><span class="hljs-variable">$20</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) f 8</span><br><span class="hljs-string">#8  0x000055555556280a in leveldb::DBImpl::DoCompactionWork (this=0x5555555f4620, compact=0x55559a388600) at /root/xxx/spdk_env/leveldb-spdk-env/db/db_impl.cc:1013</span><br><span class="hljs-string">1013        input-&gt;Next();</span><br><span class="hljs-string">(gdb) p input</span><br><span class="hljs-string"><span class="hljs-variable">$21</span> = (leveldb::Iterator *) 0x7fffe80029f0</span><br><span class="hljs-string">(gdb) p *input</span><br><span class="hljs-string"><span class="hljs-variable">$22</span> = &#123;_vptr.Iterator = 0x5555555c89f8 &lt;vtable for leveldb::(anonymous namespace)::MergingIterator+16&gt;, cleanup_head_ = &#123;function = 0x0, arg1 = 0x2b5028, arg2 = 0x7fffe8003550, next = 0x0&#125;&#125;</span><br><span class="hljs-string">(gdb) p *(MergingIterator*)input</span><br><span class="hljs-string">No symbol &quot;</span>MergingIterator<span class="hljs-string">&quot; in current context.</span><br><span class="hljs-string">(gdb) p *(leveldb::MergingIterator*)input</span><br><span class="hljs-string">A syntax error in expression, near `)input&#x27;.</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction</span><br><span class="hljs-string"><span class="hljs-variable">$23</span> = (leveldb::Compaction * const) 0x7fffe80231b0</span><br><span class="hljs-string">(gdb) p *compact-&gt;compaction</span><br><span class="hljs-string"><span class="hljs-variable">$24</span> = &#123;level_ = 1, max_output_file_size_ = 2097152, input_version_ = 0x7fffe8002370, edit_ = &#123;comparator_ = &quot;</span><span class="hljs-string">&quot;, log_number_ = 0, prev_log_number_ = 0, next_file_number_ = 0, last_sequence_ = 0, </span><br><span class="hljs-string">    has_comparator_ = false, has_log_number_ = false, has_prev_log_number_ = false, has_next_file_number_ = false, has_last_sequence_ = false, compact_pointers_ = std::vector of length 1, capacity 1 = &#123;&#123;</span><br><span class="hljs-string">        first = 1, second = &#123;rep_ = &quot;</span>zzzxdjxeeqwfcfipiriuoztlqehs\001wh\001\000\000\000<span class="hljs-string">&quot;&#125;&#125;&#125;, deleted_files_ = std::set with 0 elements, new_files_ = std::vector of length 0, capacity 0&#125;, inputs_ = &#123;</span><br><span class="hljs-string">    std::vector of length 7, capacity 7 = &#123;0x7fffe8023670, 0x7fffe8023550, 0x7fffe802ee10, 0x7fffe802ea60, 0x7fffe8025e50, 0x7fffe8025f30, 0x7fffe8026010&#125;, std::vector of length 1, capacity 1 = &#123;</span><br><span class="hljs-string">      0x7fffe8000b90&#125;&#125;, grandparents_ = std::vector of length 0, capacity 0, grandparent_index_ = 0, seen_key_ = true, overlapped_bytes_ = 0, level_ptrs_ = &#123;0, 0, 0, 0, 0, 0, 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction-&gt;input</span><br><span class="hljs-string"><span class="hljs-variable">$25</span> = &#123;leveldb::FileMetaData *(const leveldb::Compaction * const, int, int)&#125; 0x555555566f2c &lt;leveldb::Compaction::input(int, int) const&gt;</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction-&gt;input[0]</span><br><span class="hljs-string">cannot subscript requested type</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction-&gt;inputs_</span><br><span class="hljs-string"><span class="hljs-variable">$26</span> = &#123;std::vector of length 7, capacity 7 = &#123;0x7fffe8023670, 0x7fffe8023550, 0x7fffe802ee10, 0x7fffe802ea60, 0x7fffe8025e50, 0x7fffe8025f30, 0x7fffe8026010&#125;, std::vector of length 1, capacity 1 = &#123;</span><br><span class="hljs-string">    0x7fffe8000b90&#125;&#125;</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction-&gt;inputs_[0]</span><br><span class="hljs-string"><span class="hljs-variable">$27</span> = std::vector of length 7, capacity 7 = &#123;0x7fffe8023670, 0x7fffe8023550, 0x7fffe802ee10, 0x7fffe802ea60, 0x7fffe8025e50, 0x7fffe8025f30, 0x7fffe8026010&#125;</span><br><span class="hljs-string">(gdb) p compact-&gt;compaction-&gt;inputs_[1]</span><br><span class="hljs-string"><span class="hljs-variable">$28</span> = std::vector of length 1, capacity 1 = &#123;0x7fffe8000b90&#125;</span><br><span class="hljs-string">(gdb) f 6</span><br><span class="hljs-string">#6  0x0000555555587d5a in leveldb::(anonymous namespace)::MergingIterator::FindSmallest (this=0x7fffe80029f0) at /root/xxx/spdk_env/leveldb-spdk-env/table/merger.cc:155</span><br><span class="hljs-string">155           &#125; else if (comparator_-&gt;Compare(child-&gt;key(), smallest-&gt;key()) &lt; 0) &#123;</span><br><span class="hljs-string">(gdb) p child</span><br><span class="hljs-string"><span class="hljs-variable">$29</span> = (leveldb::IteratorWrapper *) 0x7fffe802e848</span><br><span class="hljs-string">(gdb) p *child</span><br><span class="hljs-string"><span class="hljs-variable">$30</span> = &#123;iter_ = 0x7fffe8023310, valid_ = true, key_ = &#123;data_ = 0x7fffe8027030 &quot;</span>xlyzwbbnghkunsusoox\001&gt;\257<span class="hljs-string">&quot;, size_ = 27&#125;&#125;</span><br><span class="hljs-string">(gdb) p smallest</span><br><span class="hljs-string"><span class="hljs-variable">$31</span> = (leveldb::IteratorWrapper *) 0x7fffe802e828</span><br><span class="hljs-string">(gdb) p *smallest</span><br><span class="hljs-string"><span class="hljs-variable">$32</span> = &#123;iter_ = 0x7fffe8002240, valid_ = true, key_ = &#123;data_ = 0x7fffe8003448 &quot;</span><span class="hljs-string">&quot;, size_ = 0&#125;&#125;</span><br><span class="hljs-string">(gdb) p smallest-&gt;iter</span><br><span class="hljs-string"><span class="hljs-variable">$33</span> = &#123;leveldb::Iterator *(const leveldb::IteratorWrapper * const)&#125; 0x55555558bd80 &lt;leveldb::IteratorWrapper::iter() const&gt;</span><br><span class="hljs-string">(gdb) p *smallest-&gt;iter</span><br><span class="hljs-string">Attempt to take contents of a non-pointer value.</span><br></code></pre></td></tr></table></figure>





<h4 id="转换思路"><a href="#转换思路" class="headerlink" title="转换思路"></a>转换思路</h4><p>使用自定义的env后，出现各式各样的问题，通过打印调用栈显现的问题原因也大不一样，一个一个调试起来非常麻烦，不如转换思路，问题的原因一定出在自定义env的实现上，故直接增加测试代码，比对写入前的数据与读取出来的数据是否一致，同时更改实现方式，将文件数据先写入普通的内存缓冲区，而后拷贝到spdk申请的缓冲区并写入ZNS设备，读取前清空spdk内存缓冲区，读取后比对普通缓冲区与spdk缓冲区数据。特别的是，env只使用普通内存缓冲区中的数据，spdk缓冲区数据只做一个测试用途，这样就不会影响leveldb的正常运行，因为即使设备返回数据为错误的数据，文件读取时照样从普通内存数据中读取数据。</p>
<h4 id="spdk-app的结束"><a href="#spdk-app的结束" class="headerlink" title="spdk app的结束"></a>spdk app的结束</h4><p>env的申请与注销</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">options.env = leveldb::Env::NewZnsSpdk(leveldb::Env::Default());  <span class="hljs-comment">// spdk env实现</span><br>delete options.env;<br></code></pre></td></tr></table></figure>



<p>析构函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ZnsSpdkEnv::~ZnsSpdkEnv() &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; kvp : file_map_) &#123;<br>    kvp.second-&gt;Unref();<br>  &#125;<br>  SpdkApi::AppStop();<br>  spdk_app_thread_.join();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ZNS SPDK Env destroy complete\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 释放之前申请的资源并停止app例程</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">close_bdev</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span> &#123;<br>  SPDK_NOTICELOG(<span class="hljs-string">&quot;close spdk bdev.\n&quot;</span>);<br>  SpdkInfo* spdk_info = static_cast&lt;SpdkInfo*&gt;(arg);<br>  spdk_put_io_channel(spdk_info-&gt;bdev_io_channel);<br>  spdk_bdev_close(spdk_info-&gt;bdev_desc);<br>  spdk_app_stop(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">// 结束app线程生命周期</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">SpdkApi::AppStop</span><span class="hljs-params">()</span> &#123;<br>  spdk_thread_send_msg(spdk_thread_get_app_thread(), close_bdev, &amp;g_spdk_info);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>特别注意的是，有一些函数只能在特定线程运行，故需借助spdk_thread_send_msg函数在app_thread运行，并创建辅助函数close_bdev完成指针类型转换</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Release a reference to an I/O channel. This happens asynchronously.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This must be called on the same thread that called spdk_get_io_channel()</span><br><span class="hljs-comment"> * for the specified I/O channel. If this releases the last reference to the</span><br><span class="hljs-comment"> * I/O channel, The destroy_cb function specified in spdk_io_device_register()</span><br><span class="hljs-comment"> * will be invoked to release any associated resources.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param ch I/O channel to release a reference.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spdk_put_io_channel</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_io_channel *ch</span><br><span class="hljs-params">                         </span><br><span class="hljs-params"><span class="hljs-comment">/**</span></span><br><span class="hljs-comment"><span class="hljs-params"> * Close a previously opened block device.</span></span><br><span class="hljs-comment"><span class="hljs-params"> *</span></span><br><span class="hljs-comment"><span class="hljs-params"> * Must be called on the same thread that the spdk_bdev_open_ext()</span></span><br><span class="hljs-comment"><span class="hljs-params"> * was performed on.</span></span><br><span class="hljs-comment"><span class="hljs-params"> *</span></span><br><span class="hljs-comment"><span class="hljs-params"> * \param desc Block device descriptor to close.</span></span><br><span class="hljs-comment"><span class="hljs-params"> */</span></span><br><span class="hljs-params"><span class="hljs-type">void</span> spdk_bdev_close(<span class="hljs-keyword">struct</span> spdk_bdev_desc *desc);                        </span><br></code></pre></td></tr></table></figure>

<p>注意结束app前需释放之前申请的一系列资源，关闭设备。</p>
<h4 id="奇怪的问题"><a href="#奇怪的问题" class="headerlink" title="奇怪的问题"></a>奇怪的问题</h4><p>问题表征</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 问题1</span><br>bdev.c:1027: bdev_io_decrement_outstanding: Assertion `bdev_ch-&gt;io_outstanding &gt; 0<span class="hljs-string">&#x27; failed.</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 问题2</span><br><span class="hljs-string">[2023-12-27 15:13:30.040118] nvme_pcie_common.c: 927:nvme_pcie_qpair_process_completions: *ERROR*: cpl does not map to outstanding cmd</span><br><span class="hljs-string">[2023-12-27 15:13:30.040142] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: SUCCESS (00/00) qid:1 cid:152 cdw0:35a57 sqhd:00f5 p:0 m:0 dnr:0</span><br><span class="hljs-string">test: nvme_pcie_common.c:929: nvme_pcie_qpair_process_completions: Assertion `0&#x27;</span> failed.<br><br><span class="hljs-comment"># 问题3</span><br>nvme_pcie_common.c:694: nvme_pcie_qpair_complete_tracker: Assertion `cpl-&gt;cid == req-&gt;cmd.cid<span class="hljs-string">&#x27; failed.</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 问题4  </span><br><span class="hljs-string">[2023-12-27 15:24:40.111945] nvme_qpair.c: 255:nvme_io_qpair_print_command: *NOTICE*: IO COMMAND (7d) sqid:1 cid:191 nsid:2</span><br><span class="hljs-string">[2023-12-27 15:24:40.111962] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: DATA SGL LENGTH INVALID (00/0f) qid:1 cid:191 cdw0:0 sqhd:000c p:1 m:1 dnr:1</span><br><span class="hljs-string">append lba:0  </span><br><span class="hljs-string">[2023-12-27 15:24:40.111969] /root/leveldb-spdk-env/zns_spdk_env/spdk_api.cc: 159:WriteCpl: *ERROR*: bdev io write zone error: 5</span><br></code></pre></td></tr></table></figure>

<p>这些问题的出错位置都在spdk，阅读自定义env使用spdk接口的代码，也没发现啥问题，所以问题原因比较难找到。</p>
<p>由于问题是随机出现的，感觉是并发导致的问题，故在自定义env操作前后加上锁，保证操作的原子性，不过并没有啥效果，所以直接在spdk库代码中加入一些辅助变量，通过调试spdk找到问题的原因。</p>
<h5 id="Assertion-cpl-cid-req-cmd-cid’-failed-分析"><a href="#Assertion-cpl-cid-req-cmd-cid’-failed-分析" class="headerlink" title="Assertion &#96;cpl-&gt;cid &#x3D;&#x3D; req-&gt;cmd.cid’ failed. 分析"></a>Assertion &#96;cpl-&gt;cid &#x3D;&#x3D; req-&gt;cmd.cid’ failed. 分析</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p pqpair-&gt;tr[<span class="hljs-number">157</span>].req<br>$<span class="hljs-number">20</span> = (<span class="hljs-keyword">struct</span> nvme_request *) <span class="hljs-number">0x200032037300</span><br>(gdb) p pqpair-&gt;tr[<span class="hljs-number">158</span>].req<br>$<span class="hljs-number">21</span> = (<span class="hljs-keyword">struct</span> nvme_request *) <span class="hljs-number">0x200032037300</span><br>(gdb) p pqpair-&gt;tr[<span class="hljs-number">158</span>]<br>$<span class="hljs-number">22</span> = &#123;tq_list = &#123;tqe_next = <span class="hljs-number">0x2000070da000</span>, tqe_prev = <span class="hljs-number">0x2000320fe5f0</span>&#125;, req = <span class="hljs-number">0x200032037300</span>, cid = <span class="hljs-number">158</span>, bad_vtophys = <span class="hljs-number">0</span>, rsvd0 = <span class="hljs-number">0</span>, rsvd1 = <span class="hljs-number">0</span>, <br>  cb_fn = <span class="hljs-number">0x7ffff75e3938</span> &lt;bdev_nvme_zone_appendv_done&gt;, cb_arg = <span class="hljs-number">0x200013a97d98</span>, prp_sgl_bus_addr = <span class="hljs-number">13498167368</span>, meta_sgl = &#123;address = <span class="hljs-number">0</span>, &#123;generic = &#123;<br>        reserved = <span class="hljs-string">&quot;\000\000\000\000\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">0</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, <br>      keyed = &#123;length = <span class="hljs-number">0</span>, key = <span class="hljs-number">0</span>, subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125;, u = &#123;prp = &#123;<span class="hljs-number">12132417536</span>, <span class="hljs-number">131072</span>, <span class="hljs-number">0</span> &lt;repeats <span class="hljs-number">501</span> times&gt;&#125;, sgl = &#123;&#123;address = <span class="hljs-number">12132417536</span>, &#123;generic = &#123;<br>            reserved = <span class="hljs-string">&quot;\000\000\002\000\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">131072</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, <br>            type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, keyed = &#123;length = <span class="hljs-number">131072</span>, key = <span class="hljs-number">0</span>, subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125;, &#123;address = <span class="hljs-number">0</span>, &#123;generic = &#123;reserved = <span class="hljs-string">&quot;\000\000\000\000\000\000&quot;</span>, <br>            subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">0</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, keyed = &#123;length = <span class="hljs-number">0</span>, key = <span class="hljs-number">0</span>, <br>            subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125; &lt;repeats <span class="hljs-number">249</span> times&gt;&#125;&#125;&#125;<br>(gdb) p pqpair-&gt;tr[<span class="hljs-number">157</span>]<br>$<span class="hljs-number">23</span> = &#123;tq_list = &#123;tqe_next = <span class="hljs-number">0x2000070fb000</span>, tqe_prev = <span class="hljs-number">0x2000070db000</span>&#125;, req = <span class="hljs-number">0x200032037300</span>, cid = <span class="hljs-number">157</span>, bad_vtophys = <span class="hljs-number">0</span>, rsvd0 = <span class="hljs-number">0</span>, rsvd1 = <span class="hljs-number">0</span>, <br>  cb_fn = <span class="hljs-number">0x7ffff75e3938</span> &lt;bdev_nvme_zone_appendv_done&gt;, cb_arg = <span class="hljs-number">0x200013a97858</span>, prp_sgl_bus_addr = <span class="hljs-number">13498163272</span>, meta_sgl = &#123;address = <span class="hljs-number">0</span>, &#123;generic = &#123;<br>        reserved = <span class="hljs-string">&quot;\000\000\000\000\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">0</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, <br>      keyed = &#123;length = <span class="hljs-number">0</span>, key = <span class="hljs-number">0</span>, subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125;, u = &#123;prp = &#123;<span class="hljs-number">12132548608</span>, <span class="hljs-number">131072</span>, <span class="hljs-number">0</span> &lt;repeats <span class="hljs-number">501</span> times&gt;&#125;, sgl = &#123;&#123;address = <span class="hljs-number">12132548608</span>, &#123;generic = &#123;<br>            reserved = <span class="hljs-string">&quot;\000\000\002\000\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">131072</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, <br>            type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, keyed = &#123;length = <span class="hljs-number">131072</span>, key = <span class="hljs-number">0</span>, subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125;, &#123;address = <span class="hljs-number">0</span>, &#123;generic = &#123;reserved = <span class="hljs-string">&quot;\000\000\000\000\000\000&quot;</span>, <br>            subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, unkeyed = &#123;length = <span class="hljs-number">0</span>, reserved = <span class="hljs-string">&quot;\000\000&quot;</span>, subtype = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, type = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>&#125;, keyed = &#123;length = <span class="hljs-number">0</span>, key = <span class="hljs-number">0</span>, <br>            subtype = <span class="hljs-number">0</span>, type = <span class="hljs-number">0</span>&#125;&#125;&#125; &lt;repeats <span class="hljs-number">249</span> times&gt;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>不同cid对应的tracker req却一致</p>
<p>cid的赋值代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">nvme_pcie_qpair_submit_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair, <span class="hljs-keyword">struct</span> nvme_request *req)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_tracker</span>	*<span class="hljs-title">tr</span>;</span><br>	<span class="hljs-type">int</span>			rc = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr</span>	*<span class="hljs-title">ctrlr</span> =</span> qpair-&gt;ctrlr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_pcie_qpair</span>	*<span class="hljs-title">pqpair</span> =</span> nvme_pcie_qpair(qpair);<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">nvme_payload_type</span>	<span class="hljs-title">payload_type</span>;</span><br>	<span class="hljs-type">bool</span>			sgl_supported;<br>	<span class="hljs-type">bool</span>			mptr_sgl_supported;<br>	<span class="hljs-type">bool</span>			dword_aligned = <span class="hljs-literal">true</span>;<br><br>	<span class="hljs-keyword">if</span> (spdk_unlikely(nvme_qpair_is_admin_queue(qpair))) &#123;<br>		nvme_robust_mutex_lock(&amp;ctrlr-&gt;ctrlr_lock);<br>	&#125;<br><br>	tr = TAILQ_FIRST(&amp;pqpair-&gt;free_tr);<br><br>	<span class="hljs-keyword">if</span> (tr == <span class="hljs-literal">NULL</span>) &#123;<br>		pqpair-&gt;stat-&gt;queued_requests++;<br>		<span class="hljs-comment">/* Inform the upper layer to try again later. */</span><br>		rc = -EAGAIN;<br>		<span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;<br>	&#125;<br><br>	pqpair-&gt;stat-&gt;submitted_requests++;<br>	TAILQ_REMOVE(&amp;pqpair-&gt;free_tr, tr, tq_list); <span class="hljs-comment">/* remove tr from free_tr */</span><br>	TAILQ_INSERT_TAIL(&amp;pqpair-&gt;outstanding_tr, tr, tq_list);<br>	tr-&gt;req = req;<br>	tr-&gt;cb_fn = req-&gt;cb_fn;<br>	tr-&gt;cb_arg = req-&gt;cb_arg;<br>	req-&gt;cmd.cid = tr-&gt;cid;	<span class="hljs-comment">// req的cid即为tracker的cid</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_transport_ops</span> <span class="hljs-title">pcie_ops</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;PCIE&quot;</span>,<br><br>	.qpair_submit_request = nvme_pcie_qpair_submit_request,<br>	.qpair_process_completions = nvme_pcie_qpair_process_completions,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h5 id="bdev-ch-io-outstanding-0-分析"><a href="#bdev-ch-io-outstanding-0-分析" class="headerlink" title="bdev_ch-&gt;io_outstanding &gt; 0 分析"></a>bdev_ch-&gt;io_outstanding &gt; 0 分析</h5><p>调用栈</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202312291522138.png" srcset="/img/loading.gif" lazyload></p>
<p>spdk_bdev_channel增加成员变量call_inc_times,call_dec_times，进行spdk库的调试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_io_increment_outstanding</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_channel *bdev_ch,</span><br><span class="hljs-params">			      <span class="hljs-keyword">struct</span> spdk_bdev_shared_resource *shared_resource)</span><br>&#123;<br>	bdev_ch-&gt;call_inc_times++;<br>	bdev_ch-&gt;io_outstanding++;<br>	shared_resource-&gt;io_outstanding++;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_io_decrement_outstanding</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_channel *bdev_ch,</span><br><span class="hljs-params">			      <span class="hljs-keyword">struct</span> spdk_bdev_shared_resource *shared_resource)</span><br>&#123;<br>	bdev_ch-&gt;call_dec_times++;<br>	assert(bdev_ch-&gt;io_outstanding &gt; <span class="hljs-number">0</span>);<br>	assert(shared_resource-&gt;io_outstanding &gt; <span class="hljs-number">0</span>);<br>	bdev_ch-&gt;io_outstanding--;<br>	shared_resource-&gt;io_outstanding--;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) p *bdev_ch<br><span class="hljs-variable">$3</span> = &#123;bdev = 0x7ffff02422d0, channel = 0x7ffff0242b60, accel_channel = 0x7ffff00ae960, shared_resource = 0x7ffff02418d0, <span class="hljs-built_in">stat</span> = 0x7ffff00053a0, io_outstanding = 0, call_inc_times = 976, call_dec_times = 975, io_submitted = &#123;<br>    tqh_first = 0x200013a99e80, tqh_last = 0x200013a9a1e8&#125;, io_locked = &#123;tqh_first = 0x0, tqh_last = 0x7ffff0242ae0&#125;, io_accel_exec = &#123;tqh_first = 0x0, tqh_last = 0x7ffff0242af0&#125;, io_memory_domain = &#123;tqh_first = 0x0, <br>    tqh_last = 0x7ffff0242b00&#125;, flags = 0, histogram = 0x0, queued_resets = &#123;tqh_first = 0x0, tqh_last = 0x7ffff0242b20&#125;, locked_ranges = &#123;tqh_first = 0x0, tqh_last = 0x7ffff0242b30&#125;, qos_queued_io = &#123;tqh_first = 0x0, <br>    tqh_last = 0x7ffff0242b40&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>发现执行次数没啥大问题</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202312300938367.png" srcset="/img/loading.gif" lazyload></p>
<p>阅读代码，产生疑问，修改bdev_ch-&gt;io_outstanding是线程安全的吗？</p>
<p>阅读bdev_io_do_submit函数代码与spdk_bdev_io_complete函数代码，并没有发现锁，原子变量的机制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_io_do_submit</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_channel *bdev_ch, <span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span> *<span class="hljs-title">bdev</span> =</span> bdev_io-&gt;bdev;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *<span class="hljs-title">ch</span> =</span> bdev_ch-&gt;channel;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_shared_resource</span> *<span class="hljs-title">shared_resource</span> =</span> bdev_ch-&gt;shared_resource;<br><br>	<span class="hljs-keyword">if</span> (spdk_likely(TAILQ_EMPTY(&amp;shared_resource-&gt;nomem_io))) &#123;<br>		bdev_io_increment_outstanding(bdev_ch, shared_resource);	<span class="hljs-comment">// 增加计数</span><br>		bdev_io-&gt;internal.in_submit_request = <span class="hljs-literal">true</span>;<br>		bdev_submit_request(bdev, ch, bdev_io);<br>		bdev_io-&gt;internal.in_submit_request = <span class="hljs-literal">false</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		bdev_queue_nomem_io_tail(shared_resource, bdev_io, BDEV_IO_RETRY_STATE_SUBMIT);<br>		<span class="hljs-keyword">if</span> (shared_resource-&gt;nomem_threshold == <span class="hljs-number">0</span> &amp;&amp; shared_resource-&gt;io_outstanding == <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-comment">/* Special case when we have nomem IOs and no outstanding IOs which completions</span><br><span class="hljs-comment">			 * could trigger retry of queued IOs */</span><br>			bdev_shared_ch_retry_io(shared_resource);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_bdev_io_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io, <span class="hljs-keyword">enum</span> spdk_bdev_io_status status)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span> *<span class="hljs-title">bdev</span> =</span> bdev_io-&gt;bdev;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_channel</span> *<span class="hljs-title">bdev_ch</span> =</span> bdev_io-&gt;internal.ch;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_shared_resource</span> *<span class="hljs-title">shared_resource</span> =</span> bdev_ch-&gt;shared_resource;<br><br>    bdev_io_decrement_outstanding(bdev_ch, shared_resource);	<span class="hljs-comment">// 减少计数</span><br>    <span class="hljs-keyword">if</span> (spdk_likely(status == SPDK_BDEV_IO_STATUS_SUCCESS)) &#123;<br>        <span class="hljs-keyword">if</span> (bdev_io_needs_sequence_exec(bdev_io-&gt;internal.desc, bdev_io)) &#123;<br>            bdev_io_exec_sequence(bdev_io, bdev_io_complete_sequence_cb);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (spdk_unlikely(bdev_io-&gt;internal.orig_iovcnt != <span class="hljs-number">0</span> &amp;&amp;<br>                                 !bdev_io_use_accel_sequence(bdev_io))) &#123;<br>            _bdev_io_push_bounce_data_buffer(bdev_io,<br>                                             _bdev_io_complete_push_bounce_done);<br>            <span class="hljs-comment">/* bdev IO will be completed in the callback */</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>	bdev_io_complete(bdev_io);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>推论：</strong>两函数想要保证对bdev_ch成员访问的正确性，这两个函数就必须运行在同一线程中</p>
<p>以这个观点回顾之前自定义env的代码，发现我是直接用main线程调用spdk bdev接口，最重要的是，接口使用的是app thread获取的channel而不是本线程的，可能是这个原因导致了这些问题。</p>
<h4 id="channel代码分析"><a href="#channel代码分析" class="headerlink" title="channel代码分析"></a>channel代码分析</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * \brief Represents a per-thread channel for accessing an I/O device.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * An I/O device may be a physical entity (i.e. NVMe controller) or a software</span><br><span class="hljs-comment"> *  entity (i.e. a blobstore).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This structure is not part of the API - all accesses should be done through</span><br><span class="hljs-comment"> *  spdk_io_channel function calls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span>		*<span class="hljs-title">thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_device</span>		*<span class="hljs-title">dev</span>;</span><br>	<span class="hljs-type">uint32_t</span>			ref;<br>	<span class="hljs-type">uint32_t</span>			destroy_ref;<br>	RB_ENTRY(spdk_io_channel)	node;<br>	spdk_io_channel_destroy_cb	destroy_cb;<br><br>	<span class="hljs-type">uint8_t</span>				_padding[<span class="hljs-number">40</span>];<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Modules will allocate extra memory off the end of this structure</span><br><span class="hljs-comment">	 *  to store references to hardware-specific references (i.e. NVMe queue</span><br><span class="hljs-comment">	 *  pairs, or references to child device spdk_io_channels (i.e.</span><br><span class="hljs-comment">	 *  virtual bdevs).</span><br><span class="hljs-comment">	 */</span><br>&#125;;<br><br>SPDK_STATIC_ASSERT(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_io_channel) == SPDK_IO_CHANNEL_STRUCT_SIZE, <span class="hljs-string">&quot;incorrect size&quot;</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* SPDK_THREAD_INTERNAL_H_ */</span></span><br></code></pre></td></tr></table></figure>

<p>以它的用法可以看出，channel在spdk线程安全上起到很大的作用（per-thread），即保证发送请求的函数与完成请求的函数在同一个spdk_thread上执行，那么这是怎样实现的呢？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> spdk_io_channel *<br><span class="hljs-title function_">spdk_get_io_channel</span><span class="hljs-params">(<span class="hljs-type">void</span> *io_device)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *<span class="hljs-title">ch</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span> *<span class="hljs-title">thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_device</span> *<span class="hljs-title">dev</span>;</span><br>	<span class="hljs-type">int</span> rc;<br><br>	pthread_mutex_lock(&amp;g_devlist_mutex);<br>	dev = io_device_get(io_device);	<span class="hljs-comment">// 获取对应的设备抽象</span><br>	<span class="hljs-keyword">if</span> (dev == <span class="hljs-literal">NULL</span>) &#123;<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;could not find io_device %p\n&quot;</span>, io_device);<br>		pthread_mutex_unlock(&amp;g_devlist_mutex);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	thread = _get_thread();	<span class="hljs-comment">// 获取线程专属变量tls_thread</span><br>	<span class="hljs-keyword">if</span> (!thread) &#123;<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;No thread allocated\n&quot;</span>);<br>		pthread_mutex_unlock(&amp;g_devlist_mutex);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	ch = thread_get_io_channel(thread, dev);	<span class="hljs-comment">// 尝试获取对应spdk_thread的channel</span><br>	<span class="hljs-keyword">if</span> (ch != <span class="hljs-literal">NULL</span>) &#123;	<span class="hljs-comment">// 存在对应channel，增加引用计数并返回</span><br>		ch-&gt;ref++;<br>		<span class="hljs-keyword">return</span> ch;<br>	&#125;<br>	<span class="hljs-comment">// 创建新channel</span><br>	ch = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*ch) + dev-&gt;ctx_size);<br><br>	ch-&gt;dev = dev;<br>	ch-&gt;destroy_cb = dev-&gt;destroy_cb;<br>	ch-&gt;thread = thread;<br>	ch-&gt;ref = <span class="hljs-number">1</span>;<br>	ch-&gt;destroy_ref = <span class="hljs-number">0</span>;<br>	RB_INSERT(io_channel_tree, &amp;thread-&gt;io_channels, ch);<br><br>	dev-&gt;refcnt++;<br><br>	pthread_mutex_unlock(&amp;g_devlist_mutex);<br>	<span class="hljs-comment">// 调用io_device创建时注册的初始化函数</span><br>	rc = dev-&gt;create_cb(io_device, (<span class="hljs-type">uint8_t</span> *)ch + <span class="hljs-keyword">sizeof</span>(*ch));<br>	<span class="hljs-keyword">return</span> ch;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上都是一些通用操作，重点看dev-&gt;create_cb函数调用</p>
<p>回溯找到对应的io_device注册代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">g_spdk_info.bdev_io_channel = spdk_bdev_get_io_channel(g_spdk_info.bdev_desc);<br><br><span class="hljs-keyword">struct</span> spdk_io_channel *<br><span class="hljs-title function_">spdk_bdev_get_io_channel</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_desc *desc)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> spdk_get_io_channel(__bdev_to_io_dev(spdk_bdev_desc_get_bdev(desc)));<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __bdev_to_io_dev(bdev)		(((char *)bdev) + 1)</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span> &#123;</span><br>	<span class="hljs-comment">/** User context passed in by the backend */</span><br>	<span class="hljs-type">void</span> *ctxt;<br><br>	<span class="hljs-comment">/** Unique name for this block device. */</span><br>	<span class="hljs-type">char</span> *name;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出io_device就是spdk_bdev结构体的ctxt指针</p>
<p>找到对应ctxt赋值代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nvme_disk_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev *disk, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *base_name,</span><br><span class="hljs-params">		 <span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr, <span class="hljs-keyword">struct</span> spdk_nvme_ns *ns,</span><br><span class="hljs-params">		 <span class="hljs-type">uint32_t</span> prchk_flags, <span class="hljs-type">void</span> *ctx)</span><br>&#123;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_uuid</span>		*<span class="hljs-title">uuid</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *nguid;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr_data</span> *<span class="hljs-title">cdata</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ns_data</span>	*<span class="hljs-title">nsdata</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr_opts</span> *<span class="hljs-title">opts</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">spdk_nvme_csi</span>		<span class="hljs-title">csi</span>;</span><br>	<span class="hljs-type">uint32_t</span> atomic_bs, phys_bs, bs;<br>	<span class="hljs-type">char</span> sn_tmp[SPDK_NVME_CTRLR_SN_LEN + <span class="hljs-number">1</span>] = &#123;<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br><br>	cdata = spdk_nvme_ctrlr_get_data(ctrlr);<br>	csi = spdk_nvme_ns_get_csi(ns);<br>	opts = spdk_nvme_ctrlr_get_opts(ctrlr);<br><br><br>	disk-&gt;ctxt = ctx;	<span class="hljs-comment">// ctxt赋值操作</span><br>	disk-&gt;fn_table = &amp;nvmelib_fn_table;<br>	disk-&gt;module = &amp;nvme_if;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nvme_bdev_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nvme_ctrlr *nvme_ctrlr, <span class="hljs-keyword">struct</span> nvme_ns *nvme_ns)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_bdev</span> *<span class="hljs-title">bdev</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_bdev_ctrlr</span> *<span class="hljs-title">nbdev_ctrlr</span> =</span> nvme_ctrlr-&gt;nbdev_ctrlr;<br>	<span class="hljs-type">int</span> rc;<br><br>	bdev = nvme_bdev_alloc();<br><br>	rc = nvme_disk_create(&amp;bdev-&gt;disk, nbdev_ctrlr-&gt;name, nvme_ctrlr-&gt;ctrlr,<br>			      nvme_ns-&gt;ns, nvme_ctrlr-&gt;opts.prchk_flags, bdev);<br><br>	spdk_io_device_register(bdev,<br>				bdev_nvme_create_bdev_channel_cb,<br>				bdev_nvme_destroy_bdev_channel_cb,<br>				<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nvme_bdev_channel),<br>				bdev-&gt;disk.name);<br><br>	nvme_ns-&gt;bdev = bdev;<br>	bdev-&gt;nsid = nvme_ns-&gt;id;<br>	TAILQ_INSERT_TAIL(&amp;bdev-&gt;nvme_ns_list, nvme_ns, tailq);<br><br>	bdev-&gt;nbdev_ctrlr = nbdev_ctrlr;<br>	TAILQ_INSERT_TAIL(&amp;nbdev_ctrlr-&gt;bdevs, bdev, tailq);<br><br>	rc = spdk_bdev_register(&amp;bdev-&gt;disk);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出create_cb即为bdev_nvme_create_bdev_channel_cb</p>
<p>阅读代码并没有发现啥重要的信息，再次倒退</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br>_bdev_io_complete(<span class="hljs-type">void</span> *ctx)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_io</span> *<span class="hljs-title">bdev_io</span> =</span> ctx;<br>	assert(bdev_io-&gt;internal.cb != <span class="hljs-literal">NULL</span>);<br>	assert(spdk_get_thread() == spdk_bdev_io_get_thread(bdev_io));<br><br>	bdev_io-&gt;internal.cb(bdev_io, bdev_io-&gt;internal.status == SPDK_BDEV_IO_STATUS_SUCCESS,<br>			     bdev_io-&gt;internal.caller_ctx);<br>&#125;<br><br><br><span class="hljs-keyword">struct</span> spdk_thread *<br><span class="hljs-title function_">spdk_bdev_io_get_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> spdk_io_channel_get_thread(bdev_io-&gt;internal.ch-&gt;channel);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出，确实有发送bdev_io与完成bdev_io存在同一个spdk_thread限制（不过不知道为什么之前有些请求照样能运行，没有触发断言）</p>
<p>对照调用栈寻找原因</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202401021312106.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  _bdev_io_complete (ctx=0x200013a964c0) at bdev.c:7136</span><br><span class="hljs-comment">#1  0x00007ffff79277bc in bdev_io_complete (ctx=0x200013a964c0) at bdev.c:7171</span><br><span class="hljs-comment">#2  0x00007ffff7927d2b in spdk_bdev_io_complete (bdev_io=0x200013a964c0, status=SPDK_BDEV_IO_STATUS_SUCCESS) at bdev.c:7299</span><br><span class="hljs-comment">#3  0x00007ffff7928133 in spdk_bdev_io_complete_nvme_status (bdev_io=0x200013a964c0, cdw0=0, sct=0, sc=0) at bdev.c:7408</span><br><span class="hljs-comment">#4  0x00007ffff75d4050 in __bdev_nvme_io_complete (bdev_io=0x200013a964c0, status=SPDK_BDEV_IO_STATUS_PENDING, cpl=0x20003200a160) at bdev_nvme.c:779</span><br><span class="hljs-comment">#5  0x00007ffff75d5484 in bdev_nvme_io_complete_nvme_status (bio=0x200013a96898, cpl=0x20003200a160) at bdev_nvme.c:1391</span><br><span class="hljs-comment">#6  0x00007ffff75e3850 in bdev_nvme_readv_done (ref=0x200013a96898, cpl=0x20003200a160) at bdev_nvme.c:7094</span><br><span class="hljs-comment">#7  0x00007ffff749d35d in nvme_complete_request (cb_fn=0x7ffff75e36a4 &lt;bdev_nvme_readv_done&gt;, cb_arg=0x200013a96898, qpair=0x2000320fe620, req=0x200032036e00, cpl=0x20003200a160) at /root/spdk/lib/nvme/nvme_internal.h:1412</span><br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#8  0x00007ffff749f574 in nvme_pcie_qpair_complete_tracker (qpair=0x2000320fe620, tr=0x2000070d7000, cpl=0x20003200a160, print_on_error=true) at nvme_pcie_common.c:706</span><br><span class="hljs-comment">#9  0x00007ffff749fcc4 in nvme_pcie_qpair_process_completions (qpair=0x2000320fe620, max_completions=64) at nvme_pcie_common.c:925</span><br><span class="hljs-comment">#10 0x00007ffff74ad888 in nvme_transport_qpair_process_completions (qpair=0x2000320fe620, max_completions=0) at nvme_transport.c:610</span><br><span class="hljs-comment">#11 0x00007ffff74a6b52 in spdk_nvme_qpair_process_completions (qpair=0x2000320fe620, max_completions=0) at nvme_qpair.c:791</span><br><span class="hljs-comment">#12 0x00007ffff74a1ae3 in nvme_pcie_poll_group_process_completions (tgroup=0x7ffff00ae8d0, completions_per_qpair=0, disconnected_qpair_cb=0x7ffff75d58b4 &lt;bdev_nvme_disconnected_qpair_cb&gt;) at nvme_pcie_common.c:1763</span><br><span class="hljs-comment">#13 0x00007ffff74add37 in nvme_transport_poll_group_process_completions (tgroup=0x7ffff00ae8d0, completions_per_qpair=0, disconnected_qpair_cb=0x7ffff75d58b4 &lt;bdev_nvme_disconnected_qpair_cb&gt;) at nvme_transport.c:714</span><br><span class="hljs-comment">#14 0x00007ffff74c1599 in spdk_nvme_poll_group_process_completions (group=0x7ffff00977c0, completions_per_qpair=0, disconnected_qpair_cb=0x7ffff75d58b4 &lt;bdev_nvme_disconnected_qpair_cb&gt;) at nvme_poll_group.c:157</span><br><span class="hljs-comment">#15 0x00007ffff75d5b99 in bdev_nvme_poll (arg=0x7ffff0008c50) at bdev_nvme.c:1616</span><br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#16 0x00007ffff7379748 in thread_execute_poller (thread=0x7ffff00093e0, poller=0x7ffff0097820) at thread.c:953</span><br><span class="hljs-comment">#17 0x00007ffff7379cff in thread_poll (thread=0x7ffff00093e0, max_msgs=0, now=1635704191540816) at thread.c:1079</span><br><span class="hljs-comment">#18 0x00007ffff7379fb7 in spdk_thread_poll (thread=0x7ffff00093e0, max_msgs=0, now=1635704191540816) at thread.c:1163</span><br><span class="hljs-comment">#19 0x00007ffff79ed97f in _reactor_run (reactor=0x7ffff0008e00) at reactor.c:914</span><br><span class="hljs-comment">#20 0x00007ffff79eda77 in reactor_run (arg=0x7ffff0008e00) at reactor.c:952</span><br><span class="hljs-comment">#21 0x00007ffff79edf25 in spdk_reactors_start () at reactor.c:1068</span><br><span class="hljs-comment">#22 0x00007ffff79e9d7c in spdk_app_start (opts_user=0x7ffff65fd9f0, start_fn=0x5555555a3504 &lt;leveldb::start_fn(void*)&gt;, arg1=0x5555555fce10) at app.c:839</span><br><span class="hljs-comment">#23 0x00005555555a391e in leveldb::AppStart (context=0x5555555fce10) at /root/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:83</span><br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#24 0x0000555555593023 in operator() (__closure=0x5555555ca9a8) at /root/leveldb-spdk-env/zns_spdk_env/filesystem.cc:194</span><br><span class="hljs-comment">#25 0x000055555559419c in std::__invoke_impl&lt;void, leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt;(std::__invoke_other, struct &#123;...&#125; &amp;&amp;) (__f=...) at /usr/include/c++/11/bits/invoke.h:61</span><br><span class="hljs-comment">#26 0x0000555555594151 in std::__invoke&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt;(struct &#123;...&#125; &amp;&amp;) (__fn=...) at /usr/include/c++/11/bits/invoke.h:96</span><br><span class="hljs-comment">#27 0x00005555555940fe in std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt;::_M_invoke&lt;0&gt;(std::_Index_tuple&lt;0&gt;) (this=0x5555555ca9a8) at /usr/include/c++/11/bits/std_thread.h:259</span><br><span class="hljs-comment">#28 0x00005555555940d2 in std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt;::operator()(void) (this=0x5555555ca9a8) at /usr/include/c++/11/bits/std_thread.h:266</span><br><span class="hljs-comment">#29 0x00005555555940b6 in std::thread::_State_impl&lt;std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt; &gt;::_M_run(void) (this=0x5555555ca9a0) at /usr/include/c++/11/bits/std_thread.h:211</span><br><span class="hljs-comment">#30 0x00007ffff70dc253 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="hljs-comment">#31 0x00007ffff6c94ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span><br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#32 0x00007ffff6d26660 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span><br></code></pre></td></tr></table></figure>

<p>通过bdev_nvme_poll轮询函数倒退找到注册poller过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_create_poll_group_cb</span><span class="hljs-params">(<span class="hljs-type">void</span> *io_device, <span class="hljs-type">void</span> *ctx_buf)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_poll_group</span> *<span class="hljs-title">group</span> =</span> ctx_buf;<br><br>	TAILQ_INIT(&amp;group-&gt;qpair_list);<br><br>	group-&gt;group = spdk_nvme_poll_group_create(group, &amp;g_bdev_nvme_accel_fn_table);<br>	group-&gt;poller = SPDK_POLLER_REGISTER(bdev_nvme_poll, group, g_opts.nvme_ioq_poll_period_us);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_library_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	g_bdev_nvme_init_thread = spdk_get_thread();<br><br>	spdk_io_device_register(&amp;g_nvme_bdev_ctrlrs, bdev_nvme_create_poll_group_cb,<br>				bdev_nvme_destroy_poll_group_cb,<br>				<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> nvme_poll_group),  <span class="hljs-string">&quot;nvme_poll_groups&quot;</span>);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过在bdev_nvme_create_poll_group_cb函数打断点，找到调用栈</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202401021328915.png" srcset="/img/loading.gif" lazyload></p>
<p>冗长的调用栈</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  bdev_nvme_create_poll_group_cb (io_device=0x7ffff75ff1e0 &lt;g_nvme_bdev_ctrlrs&gt;, ctx_buf=0x7ffff00ae9e0) at bdev_nvme.c:3383</span><br><span class="hljs-comment">#1  0x00007ffff737cea1 in spdk_get_io_channel (io_device=0x7ffff75ff1e0 &lt;g_nvme_bdev_ctrlrs&gt;) at thread.c:2353</span><br><span class="hljs-comment">#2  0x00007ffff75d91da in nvme_qpair_create (nvme_ctrlr=0x7ffff00957c0, ctrlr_ch=0x7ffff00ae900) at bdev_nvme.c:3181</span><br><span class="hljs-comment">#3  0x00007ffff75d9359 in bdev_nvme_create_ctrlr_channel_cb (io_device=0x7ffff00957c0, ctx_buf=0x7ffff00ae900) at bdev_nvme.c:3235</span><br><span class="hljs-comment">#4  0x00007ffff737cea1 in spdk_get_io_channel (io_device=0x7ffff00957c0) at thread.c:2353</span><br><span class="hljs-comment">#5  0x00007ffff75d3ab2 in _bdev_nvme_add_io_path (nbdev_ch=0x7ffff00ae810, nvme_ns=0x7ffff0096f80) at bdev_nvme.c:651</span><br><span class="hljs-comment">#6  0x00007ffff75d3f46 in bdev_nvme_create_bdev_channel_cb (io_device=0x7ffff0097000, ctx_buf=0x7ffff00ae810) at bdev_nvme.c:756</span><br><span class="hljs-comment">#7  0x00007ffff737cea1 in spdk_get_io_channel (io_device=0x7ffff0097000) at thread.c:2353</span><br><span class="hljs-comment">#8  0x00007ffff75d99f1 in bdev_nvme_get_io_channel (ctx=0x7ffff0097000) at bdev_nvme.c:3425</span><br><span class="hljs-comment">#9  0x00007ffff79202cc in bdev_channel_create (io_device=0x7ffff0097001, ctx_buf=0x7ffff00ae6e0) at bdev.c:4024</span><br><span class="hljs-comment">#10 0x00007ffff737cea1 in spdk_get_io_channel (io_device=0x7ffff0097001) at thread.c:2353</span><br><span class="hljs-comment">#11 0x00007ffff7921d5a in spdk_bdev_get_io_channel (desc=0x7ffff0097b50) at bdev.c:4643</span><br><span class="hljs-comment">#12 0x00007ffff79442dd in bdev_blob_create_channel (dev=0x7ffff0097a70) at blob_bdev.c:353</span><br><span class="hljs-comment">#13 0x00007ffff73aabf9 in bs_channel_create (io_device=0x7ffff00980c0, ctx_buf=0x7ffff0099600) at blobstore.c:3331</span><br><span class="hljs-comment">#14 0x00007ffff737cea1 in spdk_get_io_channel (io_device=0x7ffff00980c0) at thread.c:2353</span><br><span class="hljs-comment">#15 0x00007ffff73b18a8 in bs_register_md_thread (bs=0x7ffff00980c0) at blobstore.c:5805</span><br><span class="hljs-comment">#16 0x00007ffff73aba72 in bs_alloc (dev=0x7ffff0097a70, opts=0x7ffff65fcf90, _bs=0x7ffff65fcf50, _ctx=0x7ffff65fcf58) at blobstore.c:3684</span><br><span class="hljs-comment">#17 0x00007ffff73aea8c in spdk_bs_load (dev=0x7ffff0097a70, o=0x7ffff65fd040, cb_fn=0x7ffff74e3a35 &lt;lvs_load_cb&gt;, cb_arg=0x7ffff0097f60) at blobstore.c:4797</span><br><span class="hljs-comment">#18 0x00007ffff74e3e73 in lvs_load (bs_dev=0x7ffff0097a70, _lvs_opts=0x7ffff65fd160, cb_fn=0x7ffff788ece8 &lt;_vbdev_lvs_examine_cb&gt;, cb_arg=0x7ffff0097a30) at lvol.c:474</span><br><span class="hljs-comment">#19 0x00007ffff74e3ef1 in spdk_lvs_load_ext (bs_dev=0x7ffff0097a70, opts=0x7ffff65fd160, cb_fn=0x7ffff788ece8 &lt;_vbdev_lvs_examine_cb&gt;, cb_arg=0x7ffff0097a30) at lvol.c:487</span><br><span class="hljs-comment">#20 0x00007ffff788f21d in vbdev_lvs_load (bs_dev=0x7ffff0097a70, cb_fn=0x7ffff788ece8 &lt;_vbdev_lvs_examine_cb&gt;, cb_arg=0x7ffff0097a30) at vbdev_lvol.c:1719</span><br><span class="hljs-comment">#21 0x00007ffff788f18c in _vbdev_lvs_examine (bdev=0x7ffff0097000, ori_req=0x7ffff0097790, action=0x7ffff788f1c7 &lt;vbdev_lvs_load&gt;) at vbdev_lvol.c:1700</span><br><span class="hljs-comment">#22 0x00007ffff788f33f in vbdev_lvs_examine_disk (bdev=0x7ffff0097000) at vbdev_lvol.c:1744</span><br><span class="hljs-comment">#23 0x00007ffff7917e09 in bdev_examine (bdev=0x7ffff0097000) at bdev.c:716</span><br><span class="hljs-comment">#24 0x00007ffff792a940 in spdk_bdev_register (bdev=0x7ffff0097000) at bdev.c:8378</span><br><span class="hljs-comment">#25 0x00007ffff75db8e6 in nvme_bdev_create (nvme_ctrlr=0x7ffff00957c0, nvme_ns=0x7ffff0096f80) at bdev_nvme.c:4180</span><br><span class="hljs-comment">#26 0x00007ffff75dc56b in nvme_ctrlr_populate_namespace (nvme_ctrlr=0x7ffff00957c0, nvme_ns=0x7ffff0096f80) at bdev_nvme.c:4480</span><br><span class="hljs-comment">#27 0x00007ffff75dcac1 in nvme_ctrlr_populate_namespaces (nvme_ctrlr=0x7ffff00957c0, ctx=0x7ffff0086c00) at bdev_nvme.c:4639</span><br><span class="hljs-comment">#28 0x00007ffff75ddb43 in nvme_ctrlr_create_done (nvme_ctrlr=0x7ffff00957c0, ctx=0x7ffff0086c00) at bdev_nvme.c:5115</span><br><span class="hljs-comment">#29 0x00007ffff75de586 in nvme_ctrlr_create (ctrlr=0x20000b21fa00, name=0x7ffff000d480 &quot;Nvme0&quot;, trid=0x7ffff0086c28, ctx=0x7ffff0086c00) at bdev_nvme.c:5357</span><br><span class="hljs-comment">#30 0x00007ffff75df676 in connect_attach_cb (cb_ctx=0x7ffff0087e70, trid=0x20000b21fa28, ctrlr=0x20000b21fa00, opts=0x20000b221008) at bdev_nvme.c:5805</span><br><span class="hljs-comment">#31 0x00007ffff74a9510 in nvme_ctrlr_poll_internal (ctrlr=0x20000b21fa00, probe_ctx=0x7ffff00881d0) at nvme.c:743</span><br><span class="hljs-comment">#32 0x00007ffff74ab7bc in spdk_nvme_probe_poll_async (probe_ctx=0x7ffff00881d0) at nvme.c:1516</span><br><span class="hljs-comment">#33 0x00007ffff75df763 in bdev_nvme_async_poll (arg=0x7ffff0086c00) at bdev_nvme.c:5842</span><br><span class="hljs-comment">#34 0x00007ffff7379a5f in thread_execute_timed_poller (thread=0x7ffff00093e0, poller=0x7ffff00955f0, now=1638652381357701) at thread.c:1014</span><br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-built_in">continue</span> without paging--<br><span class="hljs-comment">#35 0x00007ffff7379d8a in thread_poll (thread=0x7ffff00093e0, max_msgs=0, now=1638652381357701) at thread.c:1104</span><br><span class="hljs-comment">#36 0x00007ffff7379fb7 in spdk_thread_poll (thread=0x7ffff00093e0, max_msgs=0, now=1638652381357701) at thread.c:1163</span><br><span class="hljs-comment">#37 0x00007ffff79ed97f in _reactor_run (reactor=0x7ffff0008e00) at reactor.c:914</span><br><span class="hljs-comment">#38 0x00007ffff79eda77 in reactor_run (arg=0x7ffff0008e00) at reactor.c:952</span><br><span class="hljs-comment">#39 0x00007ffff79edf25 in spdk_reactors_start () at reactor.c:1068</span><br><span class="hljs-comment">#40 0x00007ffff79e9d7c in spdk_app_start (opts_user=0x7ffff65fd9f0, start_fn=0x5555555a3504 &lt;leveldb::start_fn(void*)&gt;, arg1=0x5555555fce10) at app.c:839</span><br><span class="hljs-comment">#41 0x00005555555a391e in leveldb::AppStart (context=0x5555555fce10) at /root/leveldb-spdk-env/zns_spdk_env/spdk_api.cc:83</span><br><span class="hljs-comment">#42 0x0000555555593023 in operator() (__closure=0x5555555ca9a8) at /root/leveldb-spdk-env/zns_spdk_env/filesystem.cc:194</span><br><span class="hljs-comment">#43 0x000055555559419c in std::__invoke_impl&lt;void, leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt;(std::__invoke_other, struct &#123;...&#125; &amp;&amp;) (__f=...) at /usr/include/c++/11/bits/invoke.h:61</span><br><span class="hljs-comment">#44 0x0000555555594151 in std::__invoke&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt;(struct &#123;...&#125; &amp;&amp;) (__fn=...) at /usr/include/c++/11/bits/invoke.h:96</span><br><span class="hljs-comment">#45 0x00005555555940fe in std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt;::_M_invoke&lt;0&gt;(std::_Index_tuple&lt;0&gt;) (this=0x5555555ca9a8) at /usr/include/c++/11/bits/std_thread.h:259</span><br><span class="hljs-comment">#46 0x00005555555940d2 in std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt;::operator()(void) (this=0x5555555ca9a8) at /usr/include/c++/11/bits/std_thread.h:266</span><br><span class="hljs-comment">#47 0x00005555555940b6 in std::thread::_State_impl&lt;std::thread::_Invoker&lt;std::tuple&lt;leveldb::ZnsSpdkEnv::ZnsSpdkEnv(leveldb::Env*)::&lt;lambda()&gt; &gt; &gt; &gt;::_M_run(void) (this=0x5555555ca9a0) at /usr/include/c++/11/bits/std_thread.h:211</span><br><span class="hljs-comment">#48 0x00007ffff70dc253 in ?? () from /lib/x86_64-linux-gnu/libstdc++.so.6</span><br><span class="hljs-comment">#49 0x00007ffff6c94ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span><br><span class="hljs-comment">#50 0x00007ffff6d26660 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span><br></code></pre></td></tr></table></figure>



<p>只看前面部分的调用栈</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202401021331437.png" srcset="/img/loading.gif" lazyload></p>
<p>根据调用栈找到如下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_create_bdev_channel_cb</span><span class="hljs-params">(<span class="hljs-type">void</span> *io_device, <span class="hljs-type">void</span> *ctx_buf)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_bdev_channel</span> *<span class="hljs-title">nbdev_ch</span> =</span> ctx_buf;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_bdev</span> *<span class="hljs-title">nbdev</span> =</span> io_device;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_ns</span> *<span class="hljs-title">nvme_ns</span>;</span><br>	<span class="hljs-type">int</span> rc;<br><br>	STAILQ_INIT(&amp;nbdev_ch-&gt;io_path_list);<br>	TAILQ_INIT(&amp;nbdev_ch-&gt;retry_io_list);<br><br>	pthread_mutex_lock(&amp;nbdev-&gt;mutex);<br><br>	nbdev_ch-&gt;mp_policy = nbdev-&gt;mp_policy;<br>	nbdev_ch-&gt;mp_selector = nbdev-&gt;mp_selector;<br>	nbdev_ch-&gt;rr_min_io = nbdev-&gt;rr_min_io;<br><br>	TAILQ_FOREACH(nvme_ns, &amp;nbdev-&gt;nvme_ns_list, tailq) &#123;<br>		rc = _bdev_nvme_add_io_path(nbdev_ch, nvme_ns);<br>	&#125;<br>	pthread_mutex_unlock(&amp;nbdev-&gt;mutex);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br>_bdev_nvme_add_io_path(<span class="hljs-keyword">struct</span> nvme_bdev_channel *nbdev_ch, <span class="hljs-keyword">struct</span> nvme_ns *nvme_ns)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_io_path</span> *<span class="hljs-title">io_path</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *<span class="hljs-title">ch</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_ctrlr_channel</span> *<span class="hljs-title">ctrlr_ch</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_qpair</span> *<span class="hljs-title">nvme_qpair</span>;</span><br><br>	io_path = nvme_io_path_alloc();<br><br><br>	io_path-&gt;nvme_ns = nvme_ns;<br><br>	ch = spdk_get_io_channel(nvme_ns-&gt;ctrlr);	<span class="hljs-comment">// 调用spdk_get_io_channel函数</span><br><br>	ctrlr_ch = spdk_io_channel_get_ctx(ch);<br><br>	nvme_qpair = ctrlr_ch-&gt;qpair;<br>	assert(nvme_qpair != <span class="hljs-literal">NULL</span>);<br><br>	io_path-&gt;qpair = nvme_qpair;<br>	TAILQ_INSERT_TAIL(&amp;nvme_qpair-&gt;io_path_list, io_path, tailq);<br><br>	io_path-&gt;nbdev_ch = nbdev_ch;<br>	STAILQ_INSERT_TAIL(&amp;nbdev_ch-&gt;io_path_list, io_path, stailq);<br><br>	bdev_nvme_clear_current_io_path(nbdev_ch);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>spdk_get_io_channel的create_cb为bdev_nvme_create_ctrlr_channel_cb函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_create_ctrlr_channel_cb</span><span class="hljs-params">(<span class="hljs-type">void</span> *io_device, <span class="hljs-type">void</span> *ctx_buf)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_ctrlr</span> *<span class="hljs-title">nvme_ctrlr</span> =</span> io_device;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_ctrlr_channel</span> *<span class="hljs-title">ctrlr_ch</span> =</span> ctx_buf;<br><br>	TAILQ_INIT(&amp;ctrlr_ch-&gt;pending_resets);<br><br>	<span class="hljs-keyword">return</span> nvme_qpair_create(nvme_ctrlr, ctrlr_ch);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nvme_qpair_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> nvme_ctrlr *nvme_ctrlr, <span class="hljs-keyword">struct</span> nvme_ctrlr_channel *ctrlr_ch)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_qpair</span> *<span class="hljs-title">nvme_qpair</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *<span class="hljs-title">pg_ch</span>;</span><br>	<span class="hljs-type">int</span> rc;<br><br>	nvme_qpair = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*nvme_qpair));<br><br>	TAILQ_INIT(&amp;nvme_qpair-&gt;io_path_list);<br><br>	nvme_qpair-&gt;ctrlr = nvme_ctrlr;<br>	nvme_qpair-&gt;ctrlr_ch = ctrlr_ch;<br><br>	pg_ch = spdk_get_io_channel(&amp;g_nvme_bdev_ctrlrs);	<span class="hljs-comment">// 在此调用spdk_get_io_channel，从而调用bdev_nvme_create_poll_group_cb函数</span><br><br>	nvme_qpair-&gt;group = spdk_io_channel_get_ctx(pg_ch);<br><br><br>	<span class="hljs-keyword">if</span> (!nvme_ctrlr-&gt;disabled) &#123;<br>		<span class="hljs-comment">/* If a nvme_ctrlr is disabled, don&#x27;t try to create qpair for it. Qpair will</span><br><span class="hljs-comment">		 * be created when it&#x27;s enabled.</span><br><span class="hljs-comment">		 */</span><br>		rc = bdev_nvme_create_qpair(nvme_qpair);	<span class="hljs-comment">// 创建qpair，连接poll group</span><br>	&#125;<br><br>	TAILQ_INSERT_TAIL(&amp;nvme_qpair-&gt;group-&gt;qpair_list, nvme_qpair, tailq);<br><br>	ctrlr_ch-&gt;qpair = nvme_qpair;<br><br>	pthread_mutex_lock(&amp;nvme_qpair-&gt;ctrlr-&gt;mutex);<br>	nvme_qpair-&gt;ctrlr-&gt;ref++;<br>	pthread_mutex_unlock(&amp;nvme_qpair-&gt;ctrlr-&gt;mutex);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据以上函数可以看出，每个channel都有对应的poll group，并且有对应的qpair，所以不同thread的收发命令互不干扰</p>
<p>回看最开始的poll函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_nvme_poll</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_poll_group</span> *<span class="hljs-title">group</span> =</span> arg;<br>	<span class="hljs-type">int64_t</span> num_completions;<br>	num_completions = spdk_nvme_poll_group_process_completions(group-&gt;group, <span class="hljs-number">0</span>,<br>			  bdev_nvme_disconnected_qpair_cb);<br>	<span class="hljs-keyword">return</span> num_completions &gt; <span class="hljs-number">0</span> ? SPDK_POLLER_BUSY : SPDK_POLLER_IDLE;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>相关博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42835519/article/details/111049067">spdk-20.10 io_channel 和 轮询 group的机制分析</a></p>
<h4 id="spdk-thread分析"><a href="#spdk-thread分析" class="headerlink" title="spdk_thread分析"></a>spdk_thread分析</h4><p>对照博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yi-mu-xi/p/12821103.html">[转]spdk线程模型 spdk_thread</a>简单看看reactor thread的相关代码</p>
<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202401011641011.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_reactors_start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_reactor</span> *<span class="hljs-title">reactor</span>;</span><br>	<span class="hljs-type">uint32_t</span> i, current_core;<br>	<span class="hljs-type">int</span> rc;<br><br>	g_rusage_period = (CONTEXT_SWITCH_MONITOR_PERIOD * spdk_get_ticks_hz()) / SPDK_SEC_TO_USEC;<br>	g_reactor_state = SPDK_REACTOR_STATE_RUNNING;<br>	<span class="hljs-comment">/* Reinitialize to false, in case the app framework is restarting in the same process. */</span><br>	g_stopping_reactors = <span class="hljs-literal">false</span>;<br><br>	current_core = spdk_env_get_current_core();<br>	SPDK_ENV_FOREACH_CORE(i) &#123;<br>		<span class="hljs-keyword">if</span> (i != current_core) &#123;<br>			reactor = spdk_reactor_get(i);<br>			<span class="hljs-keyword">if</span> (reactor == <span class="hljs-literal">NULL</span>) &#123;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			rc = spdk_env_thread_launch_pinned(reactor-&gt;lcore, reactor_run, reactor);<br>		&#125;<br>		spdk_cpuset_set_cpu(&amp;g_reactor_core_mask, i, <span class="hljs-literal">true</span>);<br>	&#125;<br><br>	<span class="hljs-comment">/* Start the main reactor */</span><br>	reactor = spdk_reactor_get(current_core);<br>	reactor_run(reactor);	<span class="hljs-comment">// 主要运行的函数</span><br><br>	spdk_env_thread_wait_all();<br><br>	g_reactor_state = SPDK_REACTOR_STATE_SHUTDOWN;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>每个reactor都运行reactor_run函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 只看频繁运行的代码，不看spdk_unlikely分支与结束处理代码</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">reactor_run</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_reactor</span>	*<span class="hljs-title">reactor</span> =</span> arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span>	*<span class="hljs-title">thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_lw_thread</span>	*<span class="hljs-title">lw_thread</span>, *<span class="hljs-title">tmp</span>;</span><br>	<span class="hljs-type">char</span>			thread_name[<span class="hljs-number">32</span>];<br>	<span class="hljs-type">uint64_t</span>		last_sched = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>		_reactor_run(reactor);	<span class="hljs-comment">// 进入实际执行函数</span><br>		<span class="hljs-keyword">if</span> (g_reactor_state != SPDK_REACTOR_STATE_RUNNING) &#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br><br>	TAILQ_FOREACH(lw_thread, &amp;reactor-&gt;threads, link) &#123;<br>		thread = spdk_thread_get_from_ctx(lw_thread);<br>		<span class="hljs-comment">/* All threads should have already had spdk_thread_exit() called on them, except</span><br><span class="hljs-comment">		 * for the app thread.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (spdk_thread_is_running(thread)) &#123;<br>			spdk_set_thread(thread);<br>			spdk_thread_exit(thread);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_reactor</span> &#123;</span><br>	<span class="hljs-comment">/* Lightweight threads running on this reactor */</span><br>	TAILQ_HEAD(, spdk_lw_thread)			threads;<br>	<span class="hljs-type">uint32_t</span>					thread_count;<br><br>	<span class="hljs-comment">/* Logical core number for this reactor. */</span><br>	<span class="hljs-type">uint32_t</span>					lcore;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_ring</span>				*<span class="hljs-title">events</span>;</span><br><br>&#125; __attribute__((aligned(SPDK_CACHE_LINE_SIZE)));<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_reactor_run(<span class="hljs-keyword">struct</span> spdk_reactor *reactor)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span>	*<span class="hljs-title">thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_lw_thread</span>	*<span class="hljs-title">lw_thread</span>, *<span class="hljs-title">tmp</span>;</span><br>	<span class="hljs-type">uint64_t</span>		now;<br>	<span class="hljs-type">int</span>			rc;<br><br>	event_queue_run_batch(reactor);	<span class="hljs-comment">// 处理reactor相应事件</span><br><br>	TAILQ_FOREACH_SAFE(lw_thread, &amp;reactor-&gt;threads, link, tmp) &#123;<br>		thread = spdk_thread_get_from_ctx(lw_thread);<br>		rc = spdk_thread_poll(thread, <span class="hljs-number">0</span>, reactor-&gt;tsc_last); <span class="hljs-comment">// 运行reactor上各个thread的事件（msg，poller）</span><br>		reactor_post_process_lw_thread(reactor, lw_thread);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">spdk_thread_poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_thread *thread, <span class="hljs-type">uint32_t</span> max_msgs, <span class="hljs-type">uint64_t</span> now)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span> *<span class="hljs-title">orig_thread</span>;</span><br>	<span class="hljs-type">int</span> rc;<br><br>	orig_thread = _get_thread();<br>	tls_thread = thread;<br><br>	rc = thread_poll(thread, max_msgs, now);	<span class="hljs-comment">// 进入实际的执行函数</span><br><br>	thread_update_stats(thread, spdk_get_ticks(), now, rc);<br><br>	tls_thread = orig_thread;<br><br>	<span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span> &#123;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Contains pollers actively running on this thread.  Pollers</span><br><span class="hljs-comment">	 *  are run round-robin. The thread takes one poller from the head</span><br><span class="hljs-comment">	 *  of the ring, executes it, then puts it back at the tail of</span><br><span class="hljs-comment">	 *  the ring.</span><br><span class="hljs-comment">	 */</span><br>	TAILQ_HEAD(active_pollers_head, spdk_poller)	active_pollers;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Contains pollers running on this thread with a periodic timer.</span><br><span class="hljs-comment">	 */</span><br>	RB_HEAD(timed_pollers_tree, spdk_poller)	timed_pollers;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_poller</span>				*<span class="hljs-title">first_timed_poller</span>;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Contains paused pollers.  Pollers on this queue are waiting until</span><br><span class="hljs-comment">	 * they are resumed (in which case they&#x27;re put onto the active/timer</span><br><span class="hljs-comment">	 * queues) or unregistered.</span><br><span class="hljs-comment">	 */</span><br>	TAILQ_HEAD(paused_pollers_head, spdk_poller)	paused_pollers;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_ring</span>		*<span class="hljs-title">messages</span>;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">thread_poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_thread *thread, <span class="hljs-type">uint32_t</span> max_msgs, <span class="hljs-type">uint64_t</span> now)</span><br>&#123;<br>	<span class="hljs-type">uint32_t</span> msg_count;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_poller</span> *<span class="hljs-title">poller</span>, *<span class="hljs-title">tmp</span>;</span><br>	spdk_msg_fn critical_msg;<br>	<span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br><br>	thread-&gt;tsc_last = now;<br>	<span class="hljs-comment">// 先处理msg</span><br>	msg_count = msg_queue_run_batch(thread, max_msgs);<br>	<span class="hljs-keyword">if</span> (msg_count) &#123;<br>		rc = <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-comment">// 再处理活跃poller</span><br>	TAILQ_FOREACH_REVERSE_SAFE(poller, &amp;thread-&gt;active_pollers,<br>				   active_pollers_head, tailq, tmp) &#123;<br>		<span class="hljs-type">int</span> poller_rc;<br><br>		poller_rc = thread_execute_poller(thread, poller);<br>		<span class="hljs-keyword">if</span> (poller_rc &gt; rc) &#123;<br>			rc = poller_rc;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 最后处理定时poller</span><br>	poller = thread-&gt;first_timed_poller;<br>	<span class="hljs-keyword">while</span> (poller != <span class="hljs-literal">NULL</span>) &#123;<br>		<span class="hljs-type">int</span> timer_rc = <span class="hljs-number">0</span>;<br><br>		<span class="hljs-keyword">if</span> (now &lt; poller-&gt;next_run_tick) &#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		tmp = RB_NEXT(timed_pollers_tree, &amp;thread-&gt;timed_pollers, poller);<br>		RB_REMOVE(timed_pollers_tree, &amp;thread-&gt;timed_pollers, poller);<br><br>		<span class="hljs-comment">/* Update the cache to the next timed poller in the list</span><br><span class="hljs-comment">		 * only if the current poller is still the closest, otherwise,</span><br><span class="hljs-comment">		 * do nothing because the cache has been already updated.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (thread-&gt;first_timed_poller == poller) &#123;<br>			thread-&gt;first_timed_poller = tmp;<br>		&#125;<br><br>		timer_rc = thread_execute_timed_poller(thread, poller, now);<br>		<span class="hljs-keyword">if</span> (timer_rc &gt; rc) &#123;<br>			rc = timer_rc;<br>		&#125;<br><br>		poller = tmp;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> rc;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202401012214787.png" srcset="/img/loading.gif" lazyload></p>
<p>再看看spdk_thread如何绑定到reactor上的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> spdk_thread *<br><span class="hljs-title function_">spdk_thread_create</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_cpuset *cpumask)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span> *<span class="hljs-title">thread</span>, *<span class="hljs-title">null_thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_msg</span> *<span class="hljs-title">msgs</span>[<span class="hljs-title">SPDK_MSG_MEMPOOL_CACHE_SIZE</span>];</span><br>	<span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>, i;<br><br>	thread = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*thread) + g_ctx_sz);<br>	<span class="hljs-keyword">if</span> (cpumask) &#123;<br>		spdk_cpuset_copy(&amp;thread-&gt;cpumask, cpumask);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		spdk_cpuset_negate(&amp;thread-&gt;cpumask);<br>	&#125;<br><br>	RB_INIT(&amp;thread-&gt;io_channels);<br>	TAILQ_INIT(&amp;thread-&gt;active_pollers);<br>	RB_INIT(&amp;thread-&gt;timed_pollers);<br>	TAILQ_INIT(&amp;thread-&gt;paused_pollers);<br>	SLIST_INIT(&amp;thread-&gt;msg_cache);<br>	thread-&gt;msg_cache_count = <span class="hljs-number">0</span>;<br><br>	thread-&gt;tsc_last = spdk_get_ticks();<br><br>	<span class="hljs-comment">/* Monotonic increasing ID is set to each created poller beginning at 1. Once the</span><br><span class="hljs-comment">	 * ID exceeds UINT64_MAX a warning message is logged</span><br><span class="hljs-comment">	 */</span><br>	thread-&gt;next_poller_id = <span class="hljs-number">1</span>;<br><br>	thread-&gt;messages = spdk_ring_create(SPDK_RING_TYPE_MP_SC, <span class="hljs-number">65536</span>, SPDK_ENV_SOCKET_ID_ANY);<br><br><br>	<span class="hljs-keyword">if</span> (name) &#123;<br>		<span class="hljs-built_in">snprintf</span>(thread-&gt;name, <span class="hljs-keyword">sizeof</span>(thread-&gt;name), <span class="hljs-string">&quot;%s&quot;</span>, name);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">snprintf</span>(thread-&gt;name, <span class="hljs-keyword">sizeof</span>(thread-&gt;name), <span class="hljs-string">&quot;%p&quot;</span>, thread);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (g_new_thread_fn) &#123;<br>		rc = g_new_thread_fn(thread);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (g_thread_op_supported_fn &amp;&amp; g_thread_op_supported_fn(SPDK_THREAD_OP_NEW)) &#123;<br>		rc = g_thread_op_fn(thread, SPDK_THREAD_OP_NEW);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (rc != <span class="hljs-number">0</span>) &#123;<br>		_free_thread(thread);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	thread-&gt;state = SPDK_THREAD_STATE_RUNNING;<br><br>	<span class="hljs-comment">/* If this is the first thread, save it as the app thread.  Use an atomic</span><br><span class="hljs-comment">	 * compare + exchange to guard against crazy users who might try to</span><br><span class="hljs-comment">	 * call spdk_thread_create() simultaneously on multiple threads.</span><br><span class="hljs-comment">	 */</span><br>	null_thread = <span class="hljs-literal">NULL</span>;<br>	__atomic_compare_exchange_n(&amp;g_app_thread, &amp;null_thread, thread, <span class="hljs-literal">false</span>,<br>				    __ATOMIC_SEQ_CST, __ATOMIC_SEQ_CST);<br><br>	<span class="hljs-keyword">return</span> thread;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>只需关注以下代码片段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (g_new_thread_fn) &#123;<br>    rc = g_new_thread_fn(thread);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (g_thread_op_supported_fn &amp;&amp; g_thread_op_supported_fn(SPDK_THREAD_OP_NEW)) &#123;<br>    rc = g_thread_op_fn(thread, SPDK_THREAD_OP_NEW);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>倒退找到g_thread_op_fn赋值过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">spdk_thread_lib_init_ext</span><span class="hljs-params">(spdk_thread_op_fn thread_op_fn,</span><br><span class="hljs-params">			 spdk_thread_op_supported_fn thread_op_supported_fn,</span><br><span class="hljs-params">			 <span class="hljs-type">size_t</span> ctx_sz, <span class="hljs-type">size_t</span> msg_mempool_sz)</span><br>&#123;<br>	g_thread_op_fn = thread_op_fn;<br>	g_thread_op_supported_fn = thread_op_supported_fn;<br><br>	<span class="hljs-keyword">return</span> _thread_lib_init(ctx_sz, msg_mempool_sz);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">spdk_reactors_init</span><span class="hljs-params">(<span class="hljs-type">size_t</span> msg_mempool_size)</span><br>&#123;<br><br>	rc = spdk_thread_lib_init_ext(reactor_thread_op, reactor_thread_op_supported,<br>				      <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_lw_thread), msg_mempool_size);<br>	g_reactor_state = SPDK_REACTOR_STATE_INITIALIZED;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>g_thread_op_fn即为reactor_thread_op函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">reactor_thread_op</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_thread *thread, <span class="hljs-keyword">enum</span> spdk_thread_op op)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_lw_thread</span> *<span class="hljs-title">lw_thread</span>;</span><br><br>	<span class="hljs-keyword">switch</span> (op) &#123;<br>	<span class="hljs-keyword">case</span> SPDK_THREAD_OP_NEW:<br>		lw_thread = spdk_thread_get_ctx(thread);<br>		lw_thread-&gt;lcore = SPDK_ENV_LCORE_ID_ANY;<br>		<span class="hljs-keyword">return</span> _reactor_schedule_thread(thread);<br>	<span class="hljs-keyword">case</span> SPDK_THREAD_OP_RESCHED:<br>		_reactor_request_thread_reschedule(thread);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> -ENOTSUP;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br>_reactor_schedule_thread(<span class="hljs-keyword">struct</span> spdk_thread *thread)<br>&#123;<br>	<span class="hljs-type">uint32_t</span> core;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_lw_thread</span> *<span class="hljs-title">lw_thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_event</span> *<span class="hljs-title">evt</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_cpuset</span> *<span class="hljs-title">cpumask</span>;</span><br>	<span class="hljs-type">uint32_t</span> i;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_reactor</span> *<span class="hljs-title">local_reactor</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">uint32_t</span> current_lcore = spdk_env_get_current_core();<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_cpuset</span> <span class="hljs-title">polling_cpumask</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_cpuset</span> <span class="hljs-title">valid_cpumask</span>;</span><br><br>	cpumask = spdk_thread_get_cpumask(thread);<br><br>	lw_thread = spdk_thread_get_ctx(thread);<br>	assert(lw_thread != <span class="hljs-literal">NULL</span>);<br>	core = lw_thread-&gt;lcore;<br>	<span class="hljs-built_in">memset</span>(lw_thread, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*lw_thread));<br><br>	<span class="hljs-keyword">if</span> (current_lcore != SPDK_ENV_LCORE_ID_ANY) &#123;<br>		local_reactor = spdk_reactor_get(current_lcore);<br>		assert(local_reactor);<br>	&#125;<br><br>	<span class="hljs-comment">/* When interrupt ability of spdk_thread is not enabled and the current</span><br><span class="hljs-comment">	 * reactor runs on DPDK thread, skip reactors which are in interrupt mode.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!spdk_interrupt_mode_is_enabled() &amp;&amp; local_reactor != <span class="hljs-literal">NULL</span>) &#123;<br>		<span class="hljs-comment">/* Get the cpumask of all reactors in polling */</span><br>		spdk_cpuset_zero(&amp;polling_cpumask);<br>		SPDK_ENV_FOREACH_CORE(i) &#123;<br>			spdk_cpuset_set_cpu(&amp;polling_cpumask, i, <span class="hljs-literal">true</span>);<br>		&#125;<br>		spdk_cpuset_xor(&amp;polling_cpumask, &amp;local_reactor-&gt;notify_cpuset);<br><br>		<span class="hljs-keyword">if</span> (core == SPDK_ENV_LCORE_ID_ANY) &#123;<br>			<span class="hljs-comment">/* Get the cpumask of all valid reactors which are suggested and also in polling */</span><br>			spdk_cpuset_copy(&amp;valid_cpumask, &amp;polling_cpumask);<br>			spdk_cpuset_and(&amp;valid_cpumask, spdk_thread_get_cpumask(thread));<br><br>			<span class="hljs-comment">/* If there are any valid reactors, spdk_thread should be scheduled</span><br><span class="hljs-comment">			 * into one of the valid reactors.</span><br><span class="hljs-comment">			 * If there is no valid reactors, spdk_thread should be scheduled</span><br><span class="hljs-comment">			 * into one of the polling reactors.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (spdk_cpuset_count(&amp;valid_cpumask) != <span class="hljs-number">0</span>) &#123;<br>				cpumask = &amp;valid_cpumask;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				cpumask = &amp;polling_cpumask;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!spdk_cpuset_get_cpu(&amp;polling_cpumask, core)) &#123;<br>			<span class="hljs-comment">/* If specified reactor is not in polling, spdk_thread should be scheduled</span><br><span class="hljs-comment">			 * into one of the polling reactors.</span><br><span class="hljs-comment">			 */</span><br>			core = SPDK_ENV_LCORE_ID_ANY;<br>			cpumask = &amp;polling_cpumask;<br>		&#125;<br>	&#125;<br><br>	pthread_mutex_lock(&amp;g_scheduler_mtx);<br>	<span class="hljs-keyword">if</span> (core == SPDK_ENV_LCORE_ID_ANY) &#123;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; spdk_env_get_core_count(); i++) &#123;<br>			<span class="hljs-keyword">if</span> (g_next_core &gt;= g_reactor_count) &#123;<br>				g_next_core = spdk_env_get_first_core();<br>			&#125;<br>			core = g_next_core;<br>			g_next_core = spdk_env_get_next_core(g_next_core);<br><br>			<span class="hljs-keyword">if</span> (spdk_cpuset_get_cpu(cpumask, core)) &#123;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 创建事件</span><br>	evt = spdk_event_allocate(core, _schedule_thread, lw_thread, <span class="hljs-literal">NULL</span>);<br><br>	pthread_mutex_unlock(&amp;g_scheduler_mtx);<br><br>	assert(evt != <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (evt == <span class="hljs-literal">NULL</span>) &#123;<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Unable to schedule thread on requested core mask.\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br><br>	lw_thread-&gt;tsc_start = spdk_get_ticks();<br>	<span class="hljs-comment">// 将event发送到对应的reactor，到时候由_reactor_run函数中的event_queue_run_batch取出并执行</span><br>	spdk_event_call(evt);	<span class="hljs-comment">// Pass the given event to the associated lcore and call the function.</span><br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点放在_schedule_thread函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_schedule_thread(<span class="hljs-type">void</span> *arg1, <span class="hljs-type">void</span> *arg2)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_lw_thread</span> *<span class="hljs-title">lw_thread</span> =</span> arg1;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span> *<span class="hljs-title">thread</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_reactor</span> *<span class="hljs-title">reactor</span>;</span><br>	<span class="hljs-type">uint32_t</span> current_core;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_fd_group</span> *<span class="hljs-title">grp</span>;</span><br><br>	current_core = spdk_env_get_current_core();<br>	reactor = spdk_reactor_get(current_core);<br>	assert(reactor != <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-comment">/* Update total_stats to reflect state of thread</span><br><span class="hljs-comment">	* at the end of the move. */</span><br>	thread = spdk_thread_get_from_ctx(lw_thread);<br>	spdk_set_thread(thread);<br>	spdk_thread_get_stats(&amp;lw_thread-&gt;total_stats);<br>	spdk_set_thread(<span class="hljs-literal">NULL</span>);<br><br>	lw_thread-&gt;lcore = current_core;<br><br>	TAILQ_INSERT_TAIL(&amp;reactor-&gt;threads, lw_thread, link);	<span class="hljs-comment">// 插入reactor对应的thread列表</span><br>	reactor-&gt;thread_count++;<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/" class="category-chain-item">踩坑日记</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" class="category-chain-item">学习记录</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/zns-ssd-femu-nvme-spdk-dpdk/" class="category-chain-item">zns ssd-femu-nvme-spdk-dpdk</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/zns-ssd-spdk-leveldb-env/" class="print-no-link">#zns ssd spdk leveldb env</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/continue/%E9%9B%B6%E7%A2%8E%E7%AC%94%E8%AE%B0.html" title="零碎笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">零碎笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/continue/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95.html" title="个人博客搭建记录">
                        <span class="hidden-mobile">个人博客搭建记录</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz","appKey":"0e2MMh7ddBCGGytOe9UEy5NP","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://uu0wegco.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
