<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/main.jpg"><link rel="icon" href="/img/main.jpg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="最佳损友1020"><meta name="keywords" content=""><meta name="description" content="往期文章：spdk环境搭建 hello_bdev代码路径：examples&#x2F;bdev&#x2F;hello_world&#x2F;hello_bdev.c可执行文件路径：build&#x2F;examples&#x2F;hello_bdev 刚开始直接执行hello_bdev显示找不到Malloc0 12345678910111213.&#x2F;build&#x2F;examples&#x2F;hello_"><meta property="og:type" content="article"><meta property="og:title" content="spdk学习记录"><meta property="og:url" content="https://www.jiasun.top/blog/spdk%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95.html"><meta property="og:site_name" content="最佳损友1020’s Blog"><meta property="og:description" content="往期文章：spdk环境搭建 hello_bdev代码路径：examples&#x2F;bdev&#x2F;hello_world&#x2F;hello_bdev.c可执行文件路径：build&#x2F;examples&#x2F;hello_bdev 刚开始直接执行hello_bdev显示找不到Malloc0 12345678910111213.&#x2F;build&#x2F;examples&#x2F;hello_"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311020913270.png"><meta property="article:published_time" content="2023-11-02T01:16:17.579Z"><meta property="article:modified_time" content="2023-11-04T02:34:03.420Z"><meta property="article:author" content="最佳损友1020"><meta property="article:tag" content="spdk bdev"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311020913270.png"><title>spdk学习记录 - 最佳损友1020’s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/csdn.css"><link rel="stylesheet" href="/css/top.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.jiasun.top",root:"/",version:"1.9.5-a",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:4},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz",app_key:"ljkRZDiTtVmjn5mpaQmpFqgv",server_url:"https://n227fxnj.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>最佳损友1020</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/bg.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="spdk学习记录"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-11-02 09:16" pubdate>2023年11月2日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 93k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 772 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">spdk学习记录</h1><div class="markdown-body"><meta name="referrer" content="no-referrer"><p>往期文章：<br><a href="https://www.jiasun.top/blog/spdk%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html">spdk环境搭建</a></p><h1 id="hello-bdev"><a href="#hello-bdev" class="headerlink" title="hello_bdev"></a>hello_bdev</h1><p>代码路径：examples&#x2F;bdev&#x2F;hello_world&#x2F;hello_bdev.c<br>可执行文件路径：build&#x2F;examples&#x2F;hello_bdev</p><p>刚开始直接执行hello_bdev显示找不到Malloc0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build/examples/hello_bdev<br>[2023-05-30 20:27:02.389489] Starting SPDK v23.05-pre git sha1 ee06693c3 / DPDK 22.11.1 initialization...<br>[2023-05-30 20:27:02.390910] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid11584 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-05-30 20:27:02.511380] app.c: 738:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-05-30 20:27:02.561201] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-05-30 20:27:02.600284] accel_sw.c: 601:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>[2023-05-30 20:27:02.621229] hello_bdev.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-05-30 20:27:02.621612] hello_bdev.c: 231:hello_start: *NOTICE*: Opening the bdev Malloc0<br>[2023-05-30 20:27:02.621691] bdev.c:7681:spdk_bdev_open_ext: *NOTICE*: Currently unable to find bdev with name: Malloc0<br>[2023-05-30 20:27:02.621761] hello_bdev.c: 235:hello_start: *ERROR*: Could not open bdev: Malloc0<br>[2023-05-30 20:27:02.621852] app.c: 844:spdk_app_stop: *WARNING*: spdk_app_stop<span class="hljs-string">&#x27;d on non-zero</span><br><span class="hljs-string">[2023-05-30 20:27:02.691191] hello_bdev.c: 308:main: *ERROR*: ERROR starting application</span><br></code></pre></td></tr></table></figure><p>在网上找到了相应issue，<a target="_blank" rel="noopener" href="https://github.com/spdk/spdk/issues/1550">https://github.com/spdk/spdk/issues/1550</a><br><img src="https://img-blog.csdnimg.cn/d61e13f0cbad4bd68da4d18966772076.png" srcset="/img/loading.gif" lazyload><br>正确的执行方式为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build/examples/hello_bdev -c ./examples/bdev/hello_world/bdev.json -b Malloc0<br><br><br>[2023-05-30 20:25:59.131197] Starting SPDK v23.05-pre git sha1 ee06693c3 / DPDK 22.11.1 initialization...<br>[2023-05-30 20:25:59.132037] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid11462 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-05-30 20:25:59.252268] app.c: 738:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-05-30 20:25:59.303646] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-05-30 20:25:59.359161] accel_sw.c: 601:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>[2023-05-30 20:25:59.387635] hello_bdev.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-05-30 20:25:59.388053] hello_bdev.c: 231:hello_start: *NOTICE*: Opening the bdev Malloc0<br>[2023-05-30 20:25:59.388153] hello_bdev.c: 244:hello_start: *NOTICE*: Opening io channel<br>[2023-05-30 20:25:59.388529] hello_bdev.c: 138:hello_write: *NOTICE*: Writing to the bdev<br>[2023-05-30 20:25:59.388757] hello_bdev.c: 117:write_complete: *NOTICE*: bdev io write completed successfully<br>[2023-05-30 20:25:59.388931] hello_bdev.c:  84:hello_read: *NOTICE*: Reading io<br>[2023-05-30 20:25:59.389019] hello_bdev.c:  65:read_complete: *NOTICE*: Read string from bdev : Hello World!<br><br>[2023-05-30 20:25:59.389128] hello_bdev.c:  74:read_complete: *NOTICE*: Stopping app<br></code></pre></td></tr></table></figure><h2 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h2><p>-b参数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *g_bdev_name = <span class="hljs-string">&quot;Malloc0&quot;</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Usage function for printing parameters that are specific to this application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">hello_bdev_usage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; -b &lt;bdev&gt;                 name of the bdev to use\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This function is called to parse the parameters that are specific to this application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">hello_bdev_parse_arg</span><span class="hljs-params">(<span class="hljs-type">int</span> ch, <span class="hljs-type">char</span> *arg)</span><br>&#123;<br>	<span class="hljs-keyword">switch</span> (ch) &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>:<br>		g_bdev_name = arg;<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>spdk_app_parse_args(argc, argv, &amp;opts, <span class="hljs-string">&quot;b:&quot;</span>, <span class="hljs-literal">NULL</span>, hello_bdev_parse_arg, hello_bdev_usage)<br>hello_context.bdev_name = g_bdev_name;<br></code></pre></td></tr></table></figure><p>可以看出，g_bdev_name本来就是Malloc0，-b Malloc0没啥用</p><p>-c参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">static void<br>usage(void (*app_usage)(void))<br>&#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s [options]\n&quot;</span>, g_executable_name);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;options:\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; -c, --config &lt;config&gt;     JSON config file (default %s)\n&quot;</span>,<br>	       g_default_opts.json_config_file != NULL ? g_default_opts.json_config_file : <span class="hljs-string">&quot;none&quot;</span>);<br></code></pre></td></tr></table></figure><p>-c后加json配置文件名，bdev.json文件内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">&#123;<br>  <span class="hljs-string">&quot;subsystems&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;subsystem&quot;</span>: <span class="hljs-string">&quot;bdev&quot;</span>,<br>      <span class="hljs-string">&quot;config&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;bdev_malloc_create&quot;</span>,<br>          <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Malloc0&quot;</span>,<br>            <span class="hljs-string">&quot;num_blocks&quot;</span>: 32768,<br>            <span class="hljs-string">&quot;block_size&quot;</span>: 512<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>简要看json的解析过程，全局查询json_config_file，找到spdk_subsystem_init_from_json_config函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_subsystem_init_from_json_config</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *json_config_file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *rpc_addr,</span><br><span class="hljs-params">				     spdk_subsystem_init_fn cb_fn, <span class="hljs-type">void</span> *cb_arg,</span><br><span class="hljs-params">				     <span class="hljs-type">bool</span> stop_on_error)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">load_json_config_ctx</span> *<span class="hljs-title">ctx</span> =</span> <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*ctx));<br>	<span class="hljs-type">int</span> rc;<br><br>	assert(cb_fn);<br>	<span class="hljs-keyword">if</span> (!ctx) &#123;<br>		cb_fn(-ENOMEM, cb_arg);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	ctx-&gt;cb_fn = cb_fn;<br>	ctx-&gt;cb_arg = cb_arg;<br>	ctx-&gt;stop_on_error = stop_on_error;<br>	ctx-&gt;thread = spdk_get_thread();<br><br>	rc = app_json_config_read(json_config_file, ctx);<br>	<span class="hljs-keyword">if</span> (rc) &#123;<br>		<span class="hljs-keyword">goto</span> fail;<br>	&#125;<br><br>	<span class="hljs-comment">/* Capture subsystems array */</span><br>	rc = spdk_json_find_array(ctx-&gt;values, <span class="hljs-string">&quot;subsystems&quot;</span>, <span class="hljs-literal">NULL</span>, &amp;ctx-&gt;subsystems);<br>	<span class="hljs-keyword">switch</span> (rc) &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>		<span class="hljs-comment">/* Get first subsystem */</span><br>		ctx-&gt;subsystems_it = spdk_json_array_first(ctx-&gt;subsystems);<br>		<span class="hljs-keyword">if</span> (ctx-&gt;subsystems_it == <span class="hljs-literal">NULL</span>) &#123;<br>			SPDK_NOTICELOG(<span class="hljs-string">&quot;&#x27;subsystems&#x27; configuration is empty\n&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> -EPROTOTYPE:<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Invalid JSON configuration: not enclosed in &#123;&#125;.\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> fail;<br>	<span class="hljs-keyword">case</span> -ENOENT:<br>		SPDK_WARNLOG(<span class="hljs-string">&quot;No &#x27;subsystems&#x27; key JSON configuration file.\n&quot;</span>);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> -EDOM:<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Invalid JSON configuration: &#x27;subsystems&#x27; should be an array.\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> fail;<br>	<span class="hljs-keyword">default</span>:<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Failed to parse JSON configuration.\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> fail;<br>	&#125;<br><br>	<span class="hljs-comment">/* If rpc_addr is not an Unix socket use default address as prefix. */</span><br>	<span class="hljs-keyword">if</span> (rpc_addr == <span class="hljs-literal">NULL</span> || rpc_addr[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span>) &#123;<br>		rpc_addr = SPDK_DEFAULT_RPC_ADDR;<br>	&#125;<br><br>	<span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> rpc client should use socketpair() instead of this temporary socket nonsense */</span><br>	rc = <span class="hljs-built_in">snprintf</span>(ctx-&gt;rpc_socket_path_temp, <span class="hljs-keyword">sizeof</span>(ctx-&gt;rpc_socket_path_temp), <span class="hljs-string">&quot;%s.%d_config&quot;</span>,<br>		      rpc_addr, getpid());<br>	<span class="hljs-keyword">if</span> (rc &gt;= (<span class="hljs-type">int</span>)<span class="hljs-keyword">sizeof</span>(ctx-&gt;rpc_socket_path_temp)) &#123;<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Socket name create failed\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> fail;<br>	&#125;<br><br>	rc = spdk_rpc_initialize(ctx-&gt;rpc_socket_path_temp);<br>	<span class="hljs-keyword">if</span> (rc) &#123;<br>		<span class="hljs-keyword">goto</span> fail;<br>	&#125;<br><br>	ctx-&gt;client_conn = spdk_jsonrpc_client_connect(ctx-&gt;rpc_socket_path_temp, AF_UNIX);<br>	<span class="hljs-keyword">if</span> (ctx-&gt;client_conn == <span class="hljs-literal">NULL</span>) &#123;<br>		SPDK_ERRLOG(<span class="hljs-string">&quot;Failed to connect to &#x27;%s&#x27;\n&quot;</span>, ctx-&gt;rpc_socket_path_temp);<br>		<span class="hljs-keyword">goto</span> fail;<br>	&#125;<br><br>	rpc_client_set_timeout(ctx, RPC_CLIENT_CONNECT_TIMEOUT_US);<br>	ctx-&gt;client_conn_poller = SPDK_POLLER_REGISTER(rpc_client_connect_poller, ctx, <span class="hljs-number">100</span>);<br>	<span class="hljs-keyword">return</span>;<br><br>fail:<br>	app_json_config_load_done(ctx, -EINVAL);<br>&#125;<br></code></pre></td></tr></table></figure><p>全局查询bdev_malloc_create，找到rpc_bdev_malloc_create函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">rpc_bdev_malloc_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_jsonrpc_request *request,</span><br><span class="hljs-params">		       <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_json_val *params)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_bdev_opts</span> <span class="hljs-title">req</span> =</span> &#123;<span class="hljs-literal">NULL</span>&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_json_write_ctx</span> *<span class="hljs-title">w</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span> *<span class="hljs-title">bdev</span>;</span><br>	<span class="hljs-type">int</span> rc = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (spdk_json_decode_object(params, rpc_construct_malloc_decoders,<br>				    SPDK_COUNTOF(rpc_construct_malloc_decoders),<br>				    &amp;req)) &#123;<br>		SPDK_DEBUGLOG(bdev_malloc, <span class="hljs-string">&quot;spdk_json_decode_object failed\n&quot;</span>);<br>		spdk_jsonrpc_send_error_response(request, SPDK_JSONRPC_ERROR_INTERNAL_ERROR,<br>						 <span class="hljs-string">&quot;spdk_json_decode_object failed&quot;</span>);<br>		<span class="hljs-keyword">goto</span> cleanup;<br>	&#125;<br><br>	rc = create_malloc_disk(&amp;bdev, &amp;req);<br>	<span class="hljs-keyword">if</span> (rc) &#123;<br>		spdk_jsonrpc_send_error_response(request, rc, spdk_strerror(-rc));<br>		<span class="hljs-keyword">goto</span> cleanup;<br>	&#125;<br><br>	free_rpc_construct_malloc(&amp;req);<br><br>	w = spdk_jsonrpc_begin_result(request);<br>	spdk_json_write_string(w, spdk_bdev_get_name(bdev));<br>	spdk_jsonrpc_end_result(request, w);<br>	<span class="hljs-keyword">return</span>;<br><br>cleanup:<br>	free_rpc_construct_malloc(&amp;req);<br>&#125;<br>SPDK_RPC_REGISTER(<span class="hljs-string">&quot;bdev_malloc_create&quot;</span>, rpc_bdev_malloc_create, SPDK_RPC_RUNTIME)  <br></code></pre></td></tr></table></figure><p>运行到该函数的回溯栈为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  rpc_bdev_malloc_create (request=<span class="hljs-number">0xcac1f474c379e400</span>, params=<span class="hljs-number">0x555555cc9570</span>) at bdev_malloc_rpc.c:<span class="hljs-number">49</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x00005555556b0a53</span> in <span class="hljs-title function_">jsonrpc_handler</span> <span class="hljs-params">(request=<span class="hljs-number">0x555555cc04e0</span>, method=<span class="hljs-number">0x555555c648e0</span>, params=<span class="hljs-number">0x555555c64900</span>)</span> at rpc.c:124<br>#2  0x00005555556b2c5e in <span class="hljs-title function_">jsonrpc_server_handle_request</span> <span class="hljs-params">(request=<span class="hljs-number">0x555555cc04e0</span>, method=<span class="hljs-number">0x555555c648e0</span>, params=<span class="hljs-number">0x555555c64900</span>)</span> at jsonrpc_server_tcp.c:222<br>#3  0x00005555556b1665 in <span class="hljs-title function_">parse_single_request</span> <span class="hljs-params">(request=<span class="hljs-number">0x555555cc04e0</span>, values=<span class="hljs-number">0x555555c64880</span>)</span> at jsonrpc_server.c:75<br>#4  0x00005555556b1c68 in <span class="hljs-title function_">jsonrpc_parse_request</span> <span class="hljs-params">(conn=<span class="hljs-number">0x7ffff5f7e040</span>, json=<span class="hljs-number">0x7ffff5f7e058</span>, size=<span class="hljs-number">172</span>)</span> at jsonrpc_server.c:205<br>#5  0x00005555556b2eaa in <span class="hljs-title function_">jsonrpc_server_conn_recv</span> <span class="hljs-params">(conn=<span class="hljs-number">0x7ffff5f7e040</span>)</span> at jsonrpc_server_tcp.c:284<br>#6  0x00005555556b3297 in <span class="hljs-title function_">spdk_jsonrpc_server_poll</span> <span class="hljs-params">(server=<span class="hljs-number">0x7ffff5f7e010</span>)</span> at jsonrpc_server_tcp.c:402<br>#7  0x00005555556b0d59 in <span class="hljs-title function_">spdk_rpc_accept</span> <span class="hljs-params">()</span> at rpc.c:213<br>#8  0x00005555556a13c4 in <span class="hljs-title function_">rpc_subsystem_poll</span> <span class="hljs-params">(arg=<span class="hljs-number">0x0</span>)</span> at rpc.c:21<br>#9  0x00005555556a82fd in <span class="hljs-title function_">thread_execute_timed_poller</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, poller=<span class="hljs-number">0x555555cbf2c0</span>, now=<span class="hljs-number">41542509569737</span>)</span> at thread.c:970<br>#10 0x00005555556a8613 in <span class="hljs-title function_">thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">41542509569737</span>)</span> at thread.c:1060<br>#11 0x00005555556a8837 in <span class="hljs-title function_">spdk_thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">41542509569737</span>)</span> at thread.c:1119<br>#12 0x000055555566d309 in _<span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(reactor=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:914<br>#13 0x000055555566d3fb in <span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:952<br>#14 0x000055555566d887 in <span class="hljs-title function_">spdk_reactors_start</span> <span class="hljs-params">()</span> at reactor.c:1068<br>#15 0x0000555555669c5d in <span class="hljs-title function_">spdk_app_start</span> <span class="hljs-params">(opts_user=<span class="hljs-number">0x7fffffffdea0</span>, start_fn=<span class="hljs-number">0x55555556e1fb</span> &lt;hello_start&gt;, arg1=<span class="hljs-number">0x7fffffffde40</span>)</span> at app.c:779<br>#16 0x000055555556e5d9 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">5</span>, argv=<span class="hljs-number">0x7fffffffe078</span>)</span> at hello_bdev.c:306<br><br>p req<br>$19 = &#123;name = <span class="hljs-number">0x555555cc9580</span> <span class="hljs-string">&quot;Malloc0&quot;</span>, uuid = &#123;u = &#123;raw = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">15</span> times&gt;&#125;&#125;, num_blocks = <span class="hljs-number">32768</span>, block_size = <span class="hljs-number">512</span>, physical_block_size = <span class="hljs-number">0</span>, optimal_io_boundary = <span class="hljs-number">0</span>, md_size = <span class="hljs-number">0</span>, <br>  md_interleave = <span class="hljs-literal">false</span>, dif_type = SPDK_DIF_DISABLE, dif_is_head_of_md = <span class="hljs-literal">false</span>&#125;<br></code></pre></td></tr></table></figure><p>猜测rpc_bdev_malloc_create函数与spdk_subsystem_init_from_json_config中的<br>SPDK_POLLER_REGISTER(rpc_client_connect_poller, ctx, 100);有关。</p><p>有兴趣的可以继续研究rpc_bdev_malloc_create函数中的create_malloc_disk函数</p><h2 id="示例函数"><a href="#示例函数" class="headerlink" title="示例函数"></a>示例函数</h2><p>hello_bdev.c中的代码逻辑比较简单，执行顺序为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">spdk_app_start<br>	hello_start<br>		hello_write<br>			write_complete<br>				hello_read<br>					read_complete<br></code></pre></td></tr></table></figure><p>与spdk&#x2F;examples&#x2F;nvme&#x2F;hello_world&#x2F;hello_world.c中做的事情类似</p><p>hello_start函数首先通过spdk_bdev_open_ext得到文件描述符，而后获取bdev设备，IO通道，申请缓冲区，写入”Hello World!\n”，调用spdk_bdev_write将缓冲区数据写入Malloc0设备，偏移量为0，写完成后重置缓冲区数据，调用spdk_bdev_read读取相同位置数据，读完成后打印返回数据，释放之前申请的IO通道，块设备描述符。</p><p>简要分析hello_write的调用过程</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 函数调用栈</span><br>(gdb) bt<br>#<span class="hljs-number">0</span>  _sw_accel_copy_iovs (dst_iovs=<span class="hljs-number">0x555555cca0b8</span>, dst_iovcnt=<span class="hljs-number">1</span>, src_iovs=<span class="hljs-number">0x555555cca0a8</span>, src_iovcnt=<span class="hljs-number">1</span>) at accel_sw.c:<span class="hljs-number">115</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000555555696577</span> in <span class="hljs-title function_">sw_accel_submit_tasks</span> <span class="hljs-params">(ch=<span class="hljs-number">0x555555dadfd0</span>, accel_task=<span class="hljs-number">0x555555cc9fb0</span>)</span> at accel_sw.c:455<br>#2  0x000055555568e5a2 in <span class="hljs-title function_">accel_submit_task</span> <span class="hljs-params">(accel_ch=<span class="hljs-number">0x555555e51190</span>, task=<span class="hljs-number">0x555555cc9fb0</span>)</span> at accel.c:305<br>#3  0x000055555568e723 in <span class="hljs-title function_">spdk_accel_submit_copy</span> <span class="hljs-params">(ch=<span class="hljs-number">0x555555e51130</span>, dst=<span class="hljs-number">0x200016600000</span>, src=<span class="hljs-number">0x2000162efd00</span>, nbytes=<span class="hljs-number">512</span>, flags=<span class="hljs-number">0</span>, cb_fn=<span class="hljs-number">0x55555556e83f</span> &lt;malloc_done&gt;, cb_arg=<span class="hljs-number">0x200010aa2ae0</span>)</span> at accel.c:340<br>#4  0x000055555556eec4 in <span class="hljs-title function_">bdev_malloc_writev</span> <span class="hljs-params">(mdisk=<span class="hljs-number">0x555555cc95c0</span>, ch=<span class="hljs-number">0x555555e51130</span>, task=<span class="hljs-number">0x200010aa2ae0</span>, iov=<span class="hljs-number">0x200010aa2710</span>, iovcnt=<span class="hljs-number">1</span>, len=<span class="hljs-number">512</span>, offset=<span class="hljs-number">0</span>, md_buf=<span class="hljs-number">0x0</span>, md_len=<span class="hljs-number">0</span>, md_offset=<span class="hljs-number">0</span>)</span> at bdev_malloc.c:277<br>#5  0x000055555556f43b in _<span class="hljs-title function_">bdev_malloc_submit_request</span> <span class="hljs-params">(mch=<span class="hljs-number">0x555555e50e60</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev_malloc.c:382<br>#6  0x000055555556f69c in <span class="hljs-title function_">bdev_malloc_submit_request</span> <span class="hljs-params">(ch=<span class="hljs-number">0x555555e50e00</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev_malloc.c:457<br>#7  0x0000555555674c66 in <span class="hljs-title function_">bdev_submit_request</span> <span class="hljs-params">(bdev=<span class="hljs-number">0x555555cc95c0</span>, ioch=<span class="hljs-number">0x555555e50e00</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev.c:1297<br>#8  0x000055555567784d in <span class="hljs-title function_">bdev_io_do_submit</span> <span class="hljs-params">(bdev_ch=<span class="hljs-number">0x555555e50d50</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev.c:2477<br>#9  0x000055555567947a in _<span class="hljs-title function_">bdev_io_submit</span> <span class="hljs-params">(ctx=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev.c:3173<br>#10 0x0000555555679a48 in <span class="hljs-title function_">bdev_io_submit</span> <span class="hljs-params">(bdev_io=<span class="hljs-number">0x200010aa2700</span>)</span> at bdev.c:3293<br>#11 0x000055555567e0f7 in <span class="hljs-title function_">bdev_write_blocks_with_md</span> <span class="hljs-params">(desc=<span class="hljs-number">0x555555e50b60</span>, ch=<span class="hljs-number">0x555555e50cf0</span>, buf=<span class="hljs-number">0x2000162efd00</span>, md_buf=<span class="hljs-number">0x0</span>, offset_blocks=<span class="hljs-number">0</span>, num_blocks=<span class="hljs-number">1</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>)</span> at bdev.c:5195<br>#12 0x000055555567e1df in <span class="hljs-title function_">spdk_bdev_write_blocks</span> <span class="hljs-params">(desc=<span class="hljs-number">0x555555e50b60</span>, ch=<span class="hljs-number">0x555555e50cf0</span>, buf=<span class="hljs-number">0x2000162efd00</span>, offset_blocks=<span class="hljs-number">0</span>, num_blocks=<span class="hljs-number">1</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>)</span> at bdev.c:5219<br>#13 0x000055555567e188 in <span class="hljs-title function_">spdk_bdev_write</span> <span class="hljs-params">(desc=<span class="hljs-number">0x555555e50b60</span>, ch=<span class="hljs-number">0x555555e50cf0</span>, buf=<span class="hljs-number">0x2000162efd00</span>, offset=<span class="hljs-number">0</span>, nbytes=<span class="hljs-number">512</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>)</span> at bdev.c:5211<br>#14 0x000055555556decc in <span class="hljs-title function_">hello_write</span> <span class="hljs-params">(arg=<span class="hljs-number">0x7fffffffde40</span>)</span> at hello_bdev.c:139<br>#15 0x000055555556e4d3 in <span class="hljs-title function_">hello_start</span> <span class="hljs-params">(arg1=<span class="hljs-number">0x7fffffffde40</span>)</span> at hello_bdev.c:276<br>#16 0x00005555556683f7 in <span class="hljs-title function_">app_start_application</span> <span class="hljs-params">()</span> at app.c:264<br>#17 0x0000555555668478 in <span class="hljs-title function_">app_start_rpc</span> <span class="hljs-params">(rc=<span class="hljs-number">0</span>, arg1=<span class="hljs-number">0x0</span>)</span> at app.c:285<br>#18 0x000055555569f259 in <span class="hljs-title function_">app_json_config_load_done</span> <span class="hljs-params">(ctx=<span class="hljs-number">0x555555c9f000</span>, rc=<span class="hljs-number">0</span>)</span> at json_config.c:111<br>#19 0x000055555569ffa6 in <span class="hljs-title function_">app_json_config_load_subsystem</span> <span class="hljs-params">(_ctx=<span class="hljs-number">0x555555c9f000</span>)</span> at json_config.c:473<br>#20 0x00005555556a7bd0 in <span class="hljs-title function_">msg_queue_run_batch</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">8</span>)</span> at thread.c:804<br>#21 0x00005555556a8528 in <span class="hljs-title function_">thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">121496004745246</span>)</span> at thread.c:1026<br>#22 0x00005555556a8837 in <span class="hljs-title function_">spdk_thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">121496004745246</span>)</span> at thread.c:1119<br>#23 0x000055555566d309 in _<span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(reactor=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:914<br>#24 0x000055555566d3fb in <span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:952<br>#25 0x000055555566d887 in <span class="hljs-title function_">spdk_reactors_start</span> <span class="hljs-params">()</span> at reactor.c:1068<br>#26 0x0000555555669c5d in <span class="hljs-title function_">spdk_app_start</span> <span class="hljs-params">(opts_user=<span class="hljs-number">0x7fffffffdea0</span>, start_fn=<span class="hljs-number">0x55555556e1fb</span> &lt;hello_start&gt;, arg1=<span class="hljs-number">0x7fffffffde40</span>)</span> at app.c:779<br>#27 0x000055555556e5d9 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">5</span>, argv=<span class="hljs-number">0x7fffffffe078</span>)</span> at hello_bdev.c:306<br></code></pre></td></tr></table></figure><p>追溯到最后，就是使用memcpy拷贝数据，那么src与dst分别是什么呢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_sw_accel_copy_iovs(<span class="hljs-keyword">struct</span> iovec *dst_iovs, <span class="hljs-type">uint32_t</span> dst_iovcnt,<br>		    <span class="hljs-keyword">struct</span> iovec *src_iovs, <span class="hljs-type">uint32_t</span> src_iovcnt)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_ioviter</span> <span class="hljs-title">iter</span>;</span><br>	<span class="hljs-type">void</span> *src, *dst;<br>	<span class="hljs-type">size_t</span> len;<br><br>	<span class="hljs-keyword">for</span> (len = spdk_ioviter_first(&amp;iter, src_iovs, src_iovcnt,<br>				      dst_iovs, dst_iovcnt, &amp;src, &amp;dst);<br>	     len != <span class="hljs-number">0</span>;<br>	     len = spdk_ioviter_next(&amp;iter, &amp;src, &amp;dst)) &#123;<br>		<span class="hljs-built_in">memcpy</span>(dst, src, len);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>src为hello_context-&gt;buff，dst为mdisk-&gt;malloc_buf + offset，故在Malloc bdev中写入数据只是简单地将数据拷贝到bdev相应的缓冲区，没看到sq cq之类的操作。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p src<br>$<span class="hljs-number">11</span> = (<span class="hljs-type">void</span> *) <span class="hljs-number">0x2000162efd00</span><br>(gdb) p dst<br>$<span class="hljs-number">12</span> = (<span class="hljs-type">void</span> *) <span class="hljs-number">0x200016600000</span><br>(gdb) p len<br>$<span class="hljs-number">13</span> = <span class="hljs-number">512</span><br>(gdb) f <span class="hljs-number">4</span><br>#<span class="hljs-number">4</span>  <span class="hljs-number">0x000055555556eec4</span> in bdev_malloc_writev (mdisk=<span class="hljs-number">0x555555cc95c0</span>, ch=<span class="hljs-number">0x555555e51130</span>, task=<span class="hljs-number">0x200010aa2ae0</span>, iov=<span class="hljs-number">0x200010aa2710</span>, iovcnt=<span class="hljs-number">1</span>, len=<span class="hljs-number">512</span>, offset=<span class="hljs-number">0</span>, md_buf=<span class="hljs-number">0x0</span>, md_len=<span class="hljs-number">0</span>, md_offset=<span class="hljs-number">0</span>) at bdev_malloc.c:<span class="hljs-number">277</span><br><span class="hljs-number">277</span>                     res = spdk_accel_submit_copy(ch, dst, iov[i].iov_base,<br>(gdb) p mdisk-&gt;malloc_buf + offset<br>$<span class="hljs-number">14</span> = (<span class="hljs-type">void</span> *) <span class="hljs-number">0x200016600000</span><br>(gdb) f <span class="hljs-number">13</span><br>#<span class="hljs-number">13</span> <span class="hljs-number">0x000055555567e188</span> in spdk_bdev_write (desc=<span class="hljs-number">0x555555e50b60</span>, ch=<span class="hljs-number">0x555555e50cf0</span>, buf=<span class="hljs-number">0x2000162efd00</span>, offset=<span class="hljs-number">0</span>, nbytes=<span class="hljs-number">512</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>) at bdev.c:<span class="hljs-number">5211</span><br><span class="hljs-number">5211</span>            <span class="hljs-keyword">return</span> spdk_bdev_write_blocks(desc, ch, buf, offset_blocks, num_blocks, cb, cb_arg);<br>(gdb) p buf<br>$<span class="hljs-number">15</span> = (<span class="hljs-type">void</span> *) <span class="hljs-number">0x2000162efd00</span><br></code></pre></td></tr></table></figure><p>在调用栈需要特别关注的就是bdev_write_blocks_with_md函数，在这个函数中创建了spdk_bdev_io结构体，当一个IO请求完成，都会调用spdk_bdev_free_io释放对应空间</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bdev_write_blocks_with_md</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev_desc *desc, <span class="hljs-keyword">struct</span> spdk_io_channel *ch,</span><br><span class="hljs-params">			  <span class="hljs-type">void</span> *buf, <span class="hljs-type">void</span> *md_buf, <span class="hljs-type">uint64_t</span> offset_blocks, <span class="hljs-type">uint64_t</span> num_blocks,</span><br><span class="hljs-params">			  spdk_bdev_io_completion_cb cb, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span> *<span class="hljs-title">bdev</span> =</span> spdk_bdev_desc_get_bdev(desc);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_io</span> *<span class="hljs-title">bdev_io</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_channel</span> *<span class="hljs-title">channel</span> =</span> __io_ch_to_bdev_ch(ch);<br><br>	<span class="hljs-keyword">if</span> (!desc-&gt;write) &#123;<br>		<span class="hljs-keyword">return</span> -EBADF;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!bdev_io_valid_blocks(bdev, offset_blocks, num_blocks)) &#123;<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	&#125;<br><br>	bdev_io = bdev_channel_get_io(channel);<br>	<span class="hljs-keyword">if</span> (!bdev_io) &#123;<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>	&#125;<br>	<span class="hljs-comment">// 设置IO请求信息</span><br>	bdev_io-&gt;internal.ch = channel;<br>	bdev_io-&gt;internal.desc = desc;<br>	bdev_io-&gt;type = SPDK_BDEV_IO_TYPE_WRITE;<br>	bdev_io-&gt;u.bdev.iovs = &amp;bdev_io-&gt;iov;<br>	bdev_io-&gt;u.bdev.iovs[<span class="hljs-number">0</span>].iov_base = buf;<br>	bdev_io-&gt;u.bdev.iovs[<span class="hljs-number">0</span>].iov_len = num_blocks * bdev-&gt;blocklen;<br>	bdev_io-&gt;u.bdev.iovcnt = <span class="hljs-number">1</span>;<br>	bdev_io-&gt;u.bdev.md_buf = md_buf;<br>	bdev_io-&gt;u.bdev.num_blocks = num_blocks;<br>	bdev_io-&gt;u.bdev.offset_blocks = offset_blocks;<br>	bdev_io-&gt;u.bdev.memory_domain = <span class="hljs-literal">NULL</span>;<br>	bdev_io-&gt;u.bdev.memory_domain_ctx = <span class="hljs-literal">NULL</span>;<br>	bdev_io-&gt;u.bdev.accel_sequence = <span class="hljs-literal">NULL</span>;<br>	bdev_io_init(bdev_io, bdev, cb_arg, cb); <span class="hljs-comment">// 设置回调函数</span><br><br>	bdev_io_submit(bdev_io);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>函数调用中有几次都通过函数指针跳转，最关键的即为bdev_submit_request-&gt;bdev_malloc_submit_reques</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bdev_submit_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev *bdev, <span class="hljs-keyword">struct</span> spdk_io_channel *ioch,</span><br><span class="hljs-params">		    <span class="hljs-keyword">struct</span> spdk_bdev_io *bdev_io)</span><br>&#123;<br>	<span class="hljs-comment">/* After a request is submitted to a bdev module, the ownership of an accel sequence</span><br><span class="hljs-comment">	 * associated with that bdev_io is transferred to the bdev module. So, clear the internal</span><br><span class="hljs-comment">	 * sequence pointer to make sure we won&#x27;t touch it anymore. */</span><br>	<span class="hljs-keyword">if</span> ((bdev_io-&gt;type == SPDK_BDEV_IO_TYPE_WRITE ||<br>	     bdev_io-&gt;type == SPDK_BDEV_IO_TYPE_READ) &amp;&amp; bdev_io-&gt;u.bdev.accel_sequence != <span class="hljs-literal">NULL</span>) &#123;<br>		assert(!bdev_io_needs_sequence_exec(bdev_io-&gt;internal.desc, bdev_io));<br>		bdev_io-&gt;internal.accel_sequence = <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	bdev-&gt;fn_table-&gt;submit_request(ioch, bdev_io);<br>&#125;<br></code></pre></td></tr></table></figure><p>其中spdk_bdev_fn_table结构体定义为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Function table for a block device backend.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The backend block device function table provides a set of APIs to allow</span><br><span class="hljs-comment"> * communication with a backend. The main commands are read/write API</span><br><span class="hljs-comment"> * calls for I/O via submit_request.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_fn_table</span> &#123;</span><br>	<span class="hljs-comment">/** Destroy the backend block device object */</span><br>	<span class="hljs-type">int</span> (*destruct)(<span class="hljs-type">void</span> *ctx);<br><br>	<span class="hljs-comment">/** Process the IO. */</span><br>	<span class="hljs-type">void</span> (*submit_request)(<span class="hljs-keyword">struct</span> spdk_io_channel *ch, <span class="hljs-keyword">struct</span> spdk_bdev_io *);<br><br>	<span class="hljs-comment">/** Check if the block device supports a specific I/O type. */</span><br>	<span class="hljs-type">bool</span> (*io_type_supported)(<span class="hljs-type">void</span> *ctx, <span class="hljs-keyword">enum</span> spdk_bdev_io_type);<br><br>	<span class="hljs-comment">/** Get an I/O channel for the specific bdev for the calling thread. */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *(*<span class="hljs-title">get_io_channel</span>)(<span class="hljs-title">void</span> *<span class="hljs-title">ctx</span>);</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Output driver-specific information to a JSON stream. Optional - may be NULL.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * The JSON write context will be initialized with an open object, so the bdev</span><br><span class="hljs-comment">	 * driver should write a name (based on the driver name) followed by a JSON value</span><br><span class="hljs-comment">	 * (most likely another nested object).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> (*dump_info_json)(<span class="hljs-type">void</span> *ctx, <span class="hljs-keyword">struct</span> spdk_json_write_ctx *w);<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Output bdev-specific RPC configuration to a JSON stream. Optional - may be NULL.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This function should only be implemented for bdevs which can be configured</span><br><span class="hljs-comment">	 * independently of other bdevs.  For example, RPCs to create a bdev for an NVMe</span><br><span class="hljs-comment">	 * namespace may not be generated by this function, since enumerating an NVMe</span><br><span class="hljs-comment">	 * namespace requires attaching to an NVMe controller, and that controller may</span><br><span class="hljs-comment">	 * contain multiple namespaces.  The spdk_bdev_module&#x27;s config_json function should</span><br><span class="hljs-comment">	 * be used instead for these cases.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * The JSON write context will be initialized with an open object, so the bdev</span><br><span class="hljs-comment">	 * driver should write all data necessary to recreate this bdev by invoking</span><br><span class="hljs-comment">	 * constructor method. No other data should be written.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*write_config_json)(<span class="hljs-keyword">struct</span> spdk_bdev *bdev, <span class="hljs-keyword">struct</span> spdk_json_write_ctx *w);<br><br>	<span class="hljs-comment">/** Get spin-time per I/O channel in microseconds.</span><br><span class="hljs-comment">	 *  Optional - may be NULL.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint64_t</span> (*get_spin_time)(<span class="hljs-keyword">struct</span> spdk_io_channel *ch);<br><br>	<span class="hljs-comment">/** Get bdev module context. */</span><br>	<span class="hljs-type">void</span> *(*get_module_ctx)(<span class="hljs-type">void</span> *ctx);<br><br>	<span class="hljs-comment">/** Get memory domains used by bdev. Optional - may be NULL.</span><br><span class="hljs-comment">	 * Vbdev module implementation should call \ref spdk_bdev_get_memory_domains for underlying bdev.</span><br><span class="hljs-comment">	 * Vbdev module must inspect types of memory domains returned by base bdev and report only those</span><br><span class="hljs-comment">	 * memory domains that it can work with. */</span><br>	<span class="hljs-type">int</span> (*get_memory_domains)(<span class="hljs-type">void</span> *ctx, <span class="hljs-keyword">struct</span> spdk_memory_domain **domains, <span class="hljs-type">int</span> array_size);<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Reset I/O statistics specific for this bdev context.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*reset_device_stat)(<span class="hljs-type">void</span> *ctx);<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Dump I/O statistics specific for this bdev context.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*dump_device_stat_json)(<span class="hljs-type">void</span> *ctx, <span class="hljs-keyword">struct</span> spdk_json_write_ctx *w);<br><br>	<span class="hljs-comment">/** Check if bdev can handle spdk_accel_sequence to handle I/O of specific type. */</span><br>	<span class="hljs-type">bool</span> (*accel_sequence_supported)(<span class="hljs-type">void</span> *ctx, <span class="hljs-keyword">enum</span> spdk_bdev_io_type type);<br>&#125;;<br></code></pre></td></tr></table></figure><p>在命令行参数解析时的rpc_bdev_malloc_create函数中调用了create_malloc_disk，在该函数中设置了相关信息</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_disk</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev</span>		<span class="hljs-title">disk</span>;</span><br>	<span class="hljs-type">void</span>				*malloc_buf;<br>	<span class="hljs-type">void</span>				*malloc_md_buf;<br>	TAILQ_ENTRY(malloc_disk)	link;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_fn_table</span> <span class="hljs-title">malloc_fn_table</span> =</span> &#123;<br>	.destruct		= bdev_malloc_destruct,<br>	.submit_request		= bdev_malloc_submit_request,<br>	.io_type_supported	= bdev_malloc_io_type_supported,<br>	.get_io_channel		= bdev_malloc_get_io_channel,<br>	.write_config_json	= bdev_malloc_write_json_config,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_module</span> <span class="hljs-title">malloc_if</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;malloc&quot;</span>,<br>	.module_init = bdev_malloc_initialize,<br>	.module_fini = bdev_malloc_deinitialize,<br>	.get_ctx_size = bdev_malloc_get_ctx_size,<br><br>&#125;;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">create_malloc_disk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev **bdev, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> malloc_bdev_opts *opts)</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Allocate the large backend memory buffer from pinned memory.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">TODO:</span> need to pass a hint so we know which socket to allocate</span><br><span class="hljs-comment">	 *  from on multi-socket systems.</span><br><span class="hljs-comment">	 */</span><br>	mdisk-&gt;malloc_buf = spdk_zmalloc(opts-&gt;num_blocks * block_size, <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-literal">NULL</span>,<br>					 SPDK_ENV_LCORE_ID_ANY, SPDK_MALLOC_DMA);<br>	mdisk-&gt;disk.max_copy = <span class="hljs-number">0</span>;<br>	mdisk-&gt;disk.ctxt = mdisk;<br>	mdisk-&gt;disk.fn_table = &amp;malloc_fn_table;<br>	mdisk-&gt;disk.module = &amp;malloc_if;<br><br>	rc = spdk_bdev_register(&amp;mdisk-&gt;disk);<br>	TAILQ_INSERT_TAIL(&amp;g_malloc_disks, mdisk, link);<br>&#125;<br></code></pre></td></tr></table></figure><p>spdk文档中有关于自定义块设备的介绍 <a target="_blank" rel="noopener" href="https://spdk.io/doc/bdev_module.html">Writing a Custom Block Device Module</a></p><p><img src="https://img-blog.csdnimg.cn/5cd676d392734977a635763153a6ca52.png" srcset="/img/loading.gif" lazyload></p><p>spdk bdev的用户指南：<a target="_blank" rel="noopener" href="https://spdk.io/doc/bdev.html">Block Device User Guide</a><br><img src="https://img-blog.csdnimg.cn/9f9365593bb24e5fadcb8b986ab5be69.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/7b0083b3450f4996b3b81ec0c6e9d903.png" srcset="/img/loading.gif" lazyload><br>malloc bdev设备申请的malloc_buf没看见有持久化操作，故malloc bdev数据只存在于内存之中</p><h1 id="nvme-bdev"><a href="#nvme-bdev" class="headerlink" title="nvme bdev"></a>nvme bdev</h1><p>刚开始一直不知道怎么生成类似于Malloc dev的json配置文件，在集成rocksdb的时候看到了gen_nvme.sh脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">scripts/gen_nvme.sh --json-with-subsystems<br><span class="hljs-comment"># 内容</span><br>&#123;<br>    <span class="hljs-string">&quot;subsystems&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;subsystem&quot;</span>: <span class="hljs-string">&quot;bdev&quot;</span>,<br>            <span class="hljs-string">&quot;config&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;bdev_nvme_attach_controller&quot;</span>,<br>                    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme0&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:03:00.0&quot;</span><br>                    &#125;<br>                &#125;,<br>                &#123;<br>                    <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;bdev_nvme_attach_controller&quot;</span>,<br>                    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme1&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:0b:00.0&quot;</span><br>                    &#125;<br>                &#125;,<br>                &#123;<br>                    <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;bdev_nvme_attach_controller&quot;</span>,<br>                    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme2&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:13:00.0&quot;</span><br>                    &#125;<br>                &#125;<br>            ]<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>照猫画虎执行以下命令却执行失败</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build/examples/hello_bdev -c ./examples/bdev/hello_world/nvme.json -b Nvme0<br>[2023-06-23 10:19:01.096287] Starting SPDK v23.05-pre git sha1 ee06693c3 / DPDK 22.11.1 initialization...<br>[2023-06-23 10:19:01.096442] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid6092 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-06-23 10:19:01.215133] app.c: 738:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-06-23 10:19:01.267987] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-06-23 10:19:01.311606] accel_sw.c: 601:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>[2023-06-23 10:19:01.476591] hello_bdev.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-06-23 10:19:01.476916] hello_bdev.c: 231:hello_start: *NOTICE*: Opening the bdev Nvme0<br>[2023-06-23 10:19:01.477001] bdev.c:7681:spdk_bdev_open_ext: *NOTICE*: Currently unable to find bdev with name: Nvme0<br>[2023-06-23 10:19:01.477110] hello_bdev.c: 235:hello_start: *ERROR*: Could not open bdev: Nvme0<br>[2023-06-23 10:19:01.477180] app.c: 844:spdk_app_stop: *WARNING*: spdk_app_stop<span class="hljs-string">&#x27;d on non-zero</span><br><span class="hljs-string">[2023-06-23 10:19:01.553524] hello_bdev.c: 308:main: *ERROR*: ERROR starting application</span><br></code></pre></td></tr></table></figure><p>查看rpc_bdev_nvme_attach_controller函数出现的名字确实是Nvme0，全局搜索-b Nvme0</p><p><strong>spdk&#x2F;doc&#x2F;bdev.md</strong><br>There are two ways to create block device based on NVMe device in SPDK. First way is to connect local PCIe drive and second one is to connect NVMe-oF device. In both cases user should use <code>bdev_nvme_attach_controller</code> RPC command to achieve that.</p><p>Example commands<br><code>rpc.py bdev_nvme_attach_controller -b NVMe1 -t PCIe -a 0000:01:00.0</code><br>This command will create NVMe bdev of physical device in the system.<br><code>rpc.py bdev_nvme_attach_controller -b Nvme0 -t RDMA -a 192.168.100.1 -f IPv4 -s 4420 -n nqn.2016-06.io.spdk:cnode1</code><br>This command will create NVMe bdev of NVMe-oF resource.</p><p>To remove an NVMe controller use the bdev_nvme_detach_controller command.<br><code>rpc.py bdev_nvme_detach_controller Nvme0</code><br>This command will remove NVMe bdev named Nvme0.</p><p><strong>spdk&#x2F;scripts&#x2F;vagrant&#x2F;README.md</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo scripts/setup.sh<br>$ sudo scripts/gen_nvme.sh --json-with-subsystems &gt; ./build/examples/hello_bdev.json<br>$ sudo ./build/examples/hello_bdev --json ./build/examples/hello_bdev.json -b Nvme0n1<br></code></pre></td></tr></table></figure><p>故使用Nvme0n1试一试，发现成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">./build/examples/hello_bdev -c examples/bdev/hello_world/nvme.json -b Nvme0n1<br>[2023-06-23 11:15:10.141844] Starting SPDK v23.05-pre git sha1 ee06693c3 / DPDK 22.11.1 initialization...<br>[2023-06-23 11:15:10.141985] [ DPDK EAL parameters: hello_bdev --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid12910 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-06-23 11:15:10.265816] app.c: 738:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-06-23 11:15:10.320068] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-06-23 11:15:10.373112] accel_sw.c: 601:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>[2023-06-23 11:15:10.542735] hello_bdev.c: 222:hello_start: *NOTICE*: Successfully started the application<br>[2023-06-23 11:15:10.543367] hello_bdev.c: 231:hello_start: *NOTICE*: Opening the bdev Nvme0n1<br>[2023-06-23 11:15:10.543648] hello_bdev.c: 244:hello_start: *NOTICE*: Opening io channel<br>[2023-06-23 11:15:10.544289] hello_bdev.c: 138:hello_write: *NOTICE*: Writing to the bdev<br>[2023-06-23 11:15:10.545329] hello_bdev.c: 117:write_complete: *NOTICE*: bdev io write completed successfully<br>[2023-06-23 11:15:10.546495] hello_bdev.c:  84:hello_read: *NOTICE*: Reading io<br>[2023-06-23 11:15:10.546975] hello_bdev.c:  65:read_complete: *NOTICE*: Read string from bdev : Hello World!<br><br>[2023-06-23 11:15:10.548061] hello_bdev.c:  74:read_complete: *NOTICE*: Stopping app<br></code></pre></td></tr></table></figure><p>简要看一下nvme bdev的一些不同，直接到分叉点bdev_submit_request函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">Thread <span class="hljs-number">1</span> <span class="hljs-string">&quot;reactor_0&quot;</span> hit Breakpoint <span class="hljs-number">1</span>, bdev_submit_request (bdev=<span class="hljs-number">0x555555cd8350</span>, ioch=<span class="hljs-number">0x555555cca200</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>) at bdev.c:<span class="hljs-number">1291</span><br><span class="hljs-number">1291</span>            <span class="hljs-keyword">if</span> ((bdev_io-&gt;type == SPDK_BDEV_IO_TYPE_WRITE ||<br>(gdb) bt<br>#<span class="hljs-number">0</span>  bdev_submit_request (bdev=<span class="hljs-number">0x555555cd8350</span>, ioch=<span class="hljs-number">0x555555cca200</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>) at bdev.c:<span class="hljs-number">1291</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x000055555567784d</span> in bdev_io_do_submit (bdev_ch=<span class="hljs-number">0x555555cca150</span>, bdev_io=<span class="hljs-number">0x200010aa2700</span>) at bdev.c:<span class="hljs-number">2477</span><br>#<span class="hljs-number">2</span>  <span class="hljs-number">0x000055555567947a</span> in _bdev_io_submit (ctx=<span class="hljs-number">0x200010aa2700</span>) at bdev.c:<span class="hljs-number">3173</span><br>#<span class="hljs-number">3</span>  <span class="hljs-number">0x0000555555679a48</span> in bdev_io_submit (bdev_io=<span class="hljs-number">0x200010aa2700</span>) at bdev.c:<span class="hljs-number">3293</span><br>#<span class="hljs-number">4</span>  <span class="hljs-number">0x000055555567e0f7</span> in bdev_write_blocks_with_md (desc=<span class="hljs-number">0x555555e600d0</span>, ch=<span class="hljs-number">0x555555cca0f0</span>, buf=<span class="hljs-number">0x200003aeb340</span>, md_buf=<span class="hljs-number">0x0</span>, offset_blocks=<span class="hljs-number">0</span>, num_blocks=<span class="hljs-number">1</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>) at bdev.c:<span class="hljs-number">5195</span><br>#<span class="hljs-number">5</span>  <span class="hljs-number">0x000055555567e1df</span> in spdk_bdev_write_blocks (desc=<span class="hljs-number">0x555555e600d0</span>, ch=<span class="hljs-number">0x555555cca0f0</span>, buf=<span class="hljs-number">0x200003aeb340</span>, offset_blocks=<span class="hljs-number">0</span>, num_blocks=<span class="hljs-number">1</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>) at bdev.c:<span class="hljs-number">5219</span><br>#<span class="hljs-number">6</span>  <span class="hljs-number">0x000055555567e188</span> in spdk_bdev_write (desc=<span class="hljs-number">0x555555e600d0</span>, ch=<span class="hljs-number">0x555555cca0f0</span>, buf=<span class="hljs-number">0x200003aeb340</span>, offset=<span class="hljs-number">0</span>, nbytes=<span class="hljs-number">512</span>, cb=<span class="hljs-number">0x55555556dd5e</span> &lt;write_complete&gt;, cb_arg=<span class="hljs-number">0x7fffffffde40</span>) at bdev.c:<span class="hljs-number">5211</span><br>#<span class="hljs-number">7</span>  <span class="hljs-number">0x000055555556decc</span> in hello_write (arg=<span class="hljs-number">0x7fffffffde40</span>) at hello_bdev.c:<span class="hljs-number">139</span><br>#<span class="hljs-number">8</span>  <span class="hljs-number">0x000055555556e4d3</span> in hello_start (arg1=<span class="hljs-number">0x7fffffffde40</span>) at hello_bdev.c:<span class="hljs-number">276</span><br>#<span class="hljs-number">9</span>  <span class="hljs-number">0x00005555556683f7</span> in app_start_application () at app.c:<span class="hljs-number">264</span><br>#<span class="hljs-number">10</span> <span class="hljs-number">0x0000555555668478</span> in app_start_rpc (rc=<span class="hljs-number">0</span>, arg1=<span class="hljs-number">0x0</span>) at app.c:<span class="hljs-number">285</span><br>#<span class="hljs-number">11</span> <span class="hljs-number">0x000055555569f259</span> in app_json_config_load_done (ctx=<span class="hljs-number">0x555555c9f000</span>, rc=<span class="hljs-number">0</span>) at json_config.c:<span class="hljs-number">111</span><br>#<span class="hljs-number">12</span> <span class="hljs-number">0x000055555569ffa6</span> in app_json_config_load_subsystem (_ctx=<span class="hljs-number">0x555555c9f000</span>) at json_config.c:<span class="hljs-number">473</span><br>#<span class="hljs-number">13</span> <span class="hljs-number">0x00005555556a7bd0</span> in msg_queue_run_batch (thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">8</span>) at thread.c:<span class="hljs-number">804</span><br>#<span class="hljs-number">14</span> <span class="hljs-number">0x00005555556a8528</span> in thread_poll (thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">9579853985352</span>) at thread.c:<span class="hljs-number">1026</span><br>#<span class="hljs-number">15</span> <span class="hljs-number">0x00005555556a8837</span> in spdk_thread_poll (thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">9579853985352</span>) at thread.c:<span class="hljs-number">1119</span><br>#<span class="hljs-number">16</span> <span class="hljs-number">0x000055555566d309</span> in _reactor_run (reactor=<span class="hljs-number">0x555555c7b780</span>) at reactor.c:<span class="hljs-number">914</span><br>#<span class="hljs-number">17</span> <span class="hljs-number">0x000055555566d3fb</span> in reactor_run (arg=<span class="hljs-number">0x555555c7b780</span>) at reactor.c:<span class="hljs-number">952</span><br>#<span class="hljs-number">18</span> <span class="hljs-number">0x000055555566d887</span> in spdk_reactors_start () at reactor.c:<span class="hljs-number">1068</span><br>#<span class="hljs-number">19</span> <span class="hljs-number">0x0000555555669c5d</span> in spdk_app_start (opts_user=<span class="hljs-number">0x7fffffffdea0</span>, start_fn=<span class="hljs-number">0x55555556e1fb</span> &lt;hello_start&gt;, arg1=<span class="hljs-number">0x7fffffffde40</span>) at app.c:<span class="hljs-number">779</span><br>#<span class="hljs-number">20</span> <span class="hljs-number">0x000055555556e5d9</span> in main (argc=<span class="hljs-number">5</span>, argv=<span class="hljs-number">0x7fffffffe078</span>) at hello_bdev.c:<span class="hljs-number">306</span><br>(gdb) n<br><span class="hljs-number">1292</span>                 bdev_io-&gt;type == SPDK_BDEV_IO_TYPE_READ) &amp;&amp; bdev_io-&gt;u.bdev.accel_sequence != <span class="hljs-literal">NULL</span>) &#123;<br>(gdb) n<br><span class="hljs-number">1297</span>            bdev-&gt;fn_table-&gt;submit_request(ioch, bdev_io);<br>(gdb) p bdev-&gt;fn_table<br>$<span class="hljs-number">1</span> = (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_bdev_fn_table *) <span class="hljs-number">0x555555a10c80</span> &lt;nvmelib_fn_table&gt;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/b0960caf7fdb45a7a19de4abfea9a9a2.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_fn_table</span> <span class="hljs-title">nvmelib_fn_table</span> =</span> &#123;<br>	.destruct		= bdev_nvme_destruct,<br>	.submit_request		= bdev_nvme_submit_request,<br>	.io_type_supported	= bdev_nvme_io_type_supported,<br>	.get_io_channel		= bdev_nvme_get_io_channel,<br>	.dump_info_json		= bdev_nvme_dump_info_json,<br>	.write_config_json	= bdev_nvme_write_config_json,<br>	.get_spin_time		= bdev_nvme_get_spin_time,<br>	.get_module_ctx		= bdev_nvme_get_module_ctx,<br>	.get_memory_domains	= bdev_nvme_get_memory_domains,<br>	.reset_device_stat	= bdev_nvme_reset_device_stat,<br>	.dump_device_stat_json	= bdev_nvme_dump_device_stat_json,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bdev_module</span> <span class="hljs-title">nvme_if</span> =</span> &#123;<br>	.name = <span class="hljs-string">&quot;nvme&quot;</span>,<br>	.async_fini = <span class="hljs-literal">true</span>,<br>	.module_init = bdev_nvme_library_init,<br>	.module_fini = bdev_nvme_library_fini,<br>	.config_json = bdev_nvme_config_json,<br>	.get_ctx_size = bdev_nvme_get_ctx_size,<br><br>&#125;;<br><span class="hljs-comment">// 省略大部分代码</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">nvme_disk_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bdev *disk, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *base_name,</span><br><span class="hljs-params">		 <span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr, <span class="hljs-keyword">struct</span> spdk_nvme_ns *ns,</span><br><span class="hljs-params">		 <span class="hljs-type">uint32_t</span> prchk_flags, <span class="hljs-type">void</span> *ctx)</span><br>&#123;<br>	disk-&gt;name = spdk_sprintf_alloc(<span class="hljs-string">&quot;%sn%d&quot;</span>, base_name, spdk_nvme_ns_get_id(ns));<br>	disk-&gt;blocklen = spdk_nvme_ns_get_extended_sector_size(ns);<br>	disk-&gt;blockcnt = spdk_nvme_ns_get_num_sectors(ns);<br>	disk-&gt;max_segment_size = spdk_nvme_ctrlr_get_max_xfer_size(ctrlr);<br>	disk-&gt;ctxt = ctx;<br>	disk-&gt;fn_table = &amp;nvmelib_fn_table;<br>	disk-&gt;module = &amp;nvme_if;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>Thread <span class="hljs-number">1</span> <span class="hljs-string">&quot;reactor_0&quot;</span> hit Breakpoint <span class="hljs-number">2</span>, nvme_disk_create (disk=<span class="hljs-number">0x770000007c</span>, base_name=<span class="hljs-number">0x0</span>, ctrlr=<span class="hljs-number">0x0</span>, ns=<span class="hljs-number">0x1</span>, prchk_flags=<span class="hljs-number">57</span>, ctx=<span class="hljs-number">0x9</span>) at bdev_nvme.c:<span class="hljs-number">3274</span><br><span class="hljs-number">3274</span>    &#123;<br>(gdb) bt<br>#<span class="hljs-number">0</span>  nvme_disk_create (disk=<span class="hljs-number">0x770000007c</span>, base_name=<span class="hljs-number">0x0</span>, ctrlr=<span class="hljs-number">0x0</span>, ns=<span class="hljs-number">0x1</span>, prchk_flags=<span class="hljs-number">57</span>, ctx=<span class="hljs-number">0x9</span>) at bdev_nvme.c:<span class="hljs-number">3274</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x000055555557ab49</span> in <span class="hljs-title function_">nvme_bdev_create</span> <span class="hljs-params">(nvme_ctrlr=<span class="hljs-number">0x555555cd7b10</span>, nvme_ns=<span class="hljs-number">0x555555cd82d0</span>)</span> at bdev_nvme.c:3429<br>#2  0x000055555557b883 in <span class="hljs-title function_">nvme_ctrlr_populate_namespace</span> <span class="hljs-params">(nvme_ctrlr=<span class="hljs-number">0x555555cd7b10</span>, nvme_ns=<span class="hljs-number">0x555555cd82d0</span>)</span> at bdev_nvme.c:3752<br>#3  0x000055555557bdac in <span class="hljs-title function_">nvme_ctrlr_populate_namespaces</span> <span class="hljs-params">(nvme_ctrlr=<span class="hljs-number">0x555555cd7b10</span>, ctx=<span class="hljs-number">0x555555cc9f50</span>)</span> at bdev_nvme.c:3911<br>#4  0x000055555557cdcf in <span class="hljs-title function_">nvme_ctrlr_create_done</span> <span class="hljs-params">(nvme_ctrlr=<span class="hljs-number">0x555555cd7b10</span>, ctx=<span class="hljs-number">0x555555cc9f50</span>)</span> at bdev_nvme.c:4387<br>#5  0x000055555557d7cd in <span class="hljs-title function_">nvme_ctrlr_create</span> <span class="hljs-params">(ctrlr=<span class="hljs-number">0x2000162ec0c0</span>, name=<span class="hljs-number">0x555555cc0650</span> <span class="hljs-string">&quot;Nvme0&quot;</span>, trid=<span class="hljs-number">0x555555cc9f78</span>, ctx=<span class="hljs-number">0x555555cc9f50</span>)</span> at bdev_nvme.c:4628<br>#6  0x000055555557e779 in <span class="hljs-title function_">connect_attach_cb</span> <span class="hljs-params">(cb_ctx=<span class="hljs-number">0x555555cca1c0</span>, trid=<span class="hljs-number">0x2000162ec0e8</span>, ctrlr=<span class="hljs-number">0x2000162ec0c0</span>, opts=<span class="hljs-number">0x2000162ed6c8</span>)</span> at bdev_nvme.c:5054<br>#7  0x00005555555f5271 in <span class="hljs-title function_">nvme_ctrlr_poll_internal</span> <span class="hljs-params">(ctrlr=<span class="hljs-number">0x2000162ec0c0</span>, probe_ctx=<span class="hljs-number">0x555555cca520</span>)</span> at nvme.c:737<br>#8  0x00005555555f743a in <span class="hljs-title function_">spdk_nvme_probe_poll_async</span> <span class="hljs-params">(probe_ctx=<span class="hljs-number">0x555555cca520</span>)</span> at nvme.c:1510<br>#9  0x000055555557e856 in <span class="hljs-title function_">bdev_nvme_async_poll</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555cc9f50</span>)</span> at bdev_nvme.c:5089<br>#10 0x00005555556a82fd in <span class="hljs-title function_">thread_execute_timed_poller</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, poller=<span class="hljs-number">0x555555cd7940</span>, now=<span class="hljs-number">13419228290350</span>)</span> at thread.c:970<br>#11 0x00005555556a8613 in <span class="hljs-title function_">thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">13419228290350</span>)</span> at thread.c:1060<br>#12 0x00005555556a8837 in <span class="hljs-title function_">spdk_thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555c9ec00</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">13419228290350</span>)</span> at thread.c:1119<br>#13 0x000055555566d309 in _<span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(reactor=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:914<br>#14 0x000055555566d3fb in <span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555c7b780</span>)</span> at reactor.c:952<br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-keyword">continue</span> without paging--<br>#15 0x000055555566d887 in <span class="hljs-title function_">spdk_reactors_start</span> <span class="hljs-params">()</span> at reactor.c:1068<br>#16 0x0000555555669c5d in <span class="hljs-title function_">spdk_app_start</span> <span class="hljs-params">(opts_user=<span class="hljs-number">0x7fffffffdea0</span>, start_fn=<span class="hljs-number">0x55555556e1fb</span> &lt;hello_start&gt;, arg1=<span class="hljs-number">0x7fffffffde40</span>)</span> at app.c:779<br>#17 0x000055555556e5d9 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">5</span>, argv=<span class="hljs-number">0x7fffffffe078</span>)</span> at hello_bdev.c:306<br><br><span class="hljs-comment">// -b Nvme0n1的原因</span><br><span class="hljs-params">(gdb)</span> p disk-&gt;name<br>$2 = <span class="hljs-number">0x555555c7a0f0</span> <span class="hljs-string">&quot;Nvme0n1&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash"> ./build/examples/hello_bdev -c examples/bdev/hello_world/nvme.json -b Nvme0n1 -L all<br>[2023-06-23 11:54:08.054234] json_config.c: 383:app_json_config_load_subsystem_config_entry: *DEBUG*:   params: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme0&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:03:00.0&quot;</span><br>                    &#125;<br> <br> [2023-06-23 11:54:08.111049] jsonrpc_client.c:  67:jsonrpc_parse_response: *DEBUG*: JSON string is :<br>&#123;<span class="hljs-string">&quot;jsonrpc&quot;</span>:<span class="hljs-string">&quot;2.0&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>:0,<span class="hljs-string">&quot;result&quot;</span>:[<span class="hljs-string">&quot;Nvme0n1&quot;</span>]&#125; <br><br>[2023-06-23 11:54:08.111082] json_config.c: 383:app_json_config_load_subsystem_config_entry: *DEBUG*:   params: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme1&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:0b:00.0&quot;</span><br>                    &#125;    <br>&#123;<span class="hljs-string">&quot;jsonrpc&quot;</span>:<span class="hljs-string">&quot;2.0&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>:0,<span class="hljs-string">&quot;result&quot;</span>:[]&#125;<br>[2023-06-23 11:54:08.160526] json_config.c: 383:app_json_config_load_subsystem_config_entry: *DEBUG*:   params: &#123;<br>                        <span class="hljs-string">&quot;trtype&quot;</span>: <span class="hljs-string">&quot;PCIe&quot;</span>,<br>                        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Nvme2&quot;</span>,<br>                        <span class="hljs-string">&quot;traddr&quot;</span>: <span class="hljs-string">&quot;0000:13:00.0&quot;</span><br>                    &#125;    <br>&#123;<span class="hljs-string">&quot;jsonrpc&quot;</span>:<span class="hljs-string">&quot;2.0&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>:0,<span class="hljs-string">&quot;result&quot;</span>:[]&#125;<br><br>[2023-06-23 11:54:08.211102] hello_bdev.c: 138:hello_write: *NOTICE*: Writing to the bdev<br>[2023-06-23 11:54:08.211328] bdev_nvme.c:6613:bdev_nvme_writev: *DEBUG*: write 1 blocks with offset 0<br>[2023-06-23 11:54:08.211363] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: SUCCESS (00/00) qid:0 cid:186 cdw0:0 sqhd:000d p:1 m:0 dnr:0<br>[2023-06-23 11:54:08.211496] nvme_qpair.c: 223:nvme_admin_qpair_print_command: *NOTICE*: CREATE IO SQ (01) qid:0 cid:191 nsid:0 cdw10:00ff0001 cdw11:00010001 PRP1 0x18a608000 PRP2 0x0<br>[2023-06-23 11:54:08.213185] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: SUCCESS (00/00) qid:0 cid:191 cdw0:0 sqhd:000e p:1 m:0 dnr:0<br>[2023-06-23 11:54:08.213517] nvme_pcie_common.c:1207:nvme_pcie_prp_list_append: *DEBUG*: prp_index:0 virt_addr:0x200003aec0c0 len:512<br>[2023-06-23 11:54:08.213555] nvme_pcie_common.c:1235:nvme_pcie_prp_list_append: *DEBUG*: prp1 = 0x190cec0c0<br>[2023-06-23 11:54:08.213573] nvme_qpair.c: 243:nvme_io_qpair_print_command: *NOTICE*: WRITE sqid:1 cid:191 nsid:1 lba:0 len:1 PRP1 0x190cec0c0 PRP2 0x0<br>[2023-06-23 11:54:08.213836] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: SUCCESS (00/00) qid:1 cid:191 cdw0:0 sqhd:0001 p:1 m:0 dnr:0<br>[2023-06-23 11:54:08.213967] hello_bdev.c: 117:write_complete: *NOTICE*: bdev io write completed successfully<br>[2023-06-23 11:54:08.214070] hello_bdev.c:  84:hello_read: *NOTICE*: Reading io<br>[2023-06-23 11:54:08.214150] bdev_nvme.c:6567:bdev_nvme_readv: *DEBUG*: <span class="hljs-built_in">read</span> 1 blocks with offset 0<br>[2023-06-23 11:54:08.214177] nvme_pcie_common.c:1207:nvme_pcie_prp_list_append: *DEBUG*: prp_index:0 virt_addr:0x200003aec0c0 len:512<br>[2023-06-23 11:54:08.214187] nvme_pcie_common.c:1235:nvme_pcie_prp_list_append: *DEBUG*: prp1 = 0x190cec0c0<br>[2023-06-23 11:54:08.214200] nvme_qpair.c: 243:nvme_io_qpair_print_command: *NOTICE*: READ sqid:1 cid:190 nsid:1 lba:0 len:1 PRP1 0x190cec0c0 PRP2 0x0<br>[2023-06-23 11:54:08.214363] nvme_qpair.c: 474:spdk_nvme_print_completion: *NOTICE*: SUCCESS (00/00) qid:1 cid:190 cdw0:0 sqhd:0002 p:1 m:0 dnr:0<br>[2023-06-23 11:54:08.214492] hello_bdev.c:  65:read_complete: *NOTICE*: Read string from bdev : Hello World!       <br></code></pre></td></tr></table></figure><h1 id="文档摘录"><a href="#文档摘录" class="headerlink" title="文档摘录"></a>文档摘录</h1><p>spdk采用轮询而不是中断的原因：<br>1）大部分硬件设计不支持用户空间中断机制<br>2）中断会引发上下文切换，产生比较大的开销，轮询由于只需通过主机内存而不是MMIO查看相应位是否发生翻转，一些技术例如intel的DDIO可以保证这部分主机内存在于CPU缓存中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 4.19版本nvme 驱动</span><br><span class="hljs-number">152</span>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">153   * An NVM Express queue.  Each device has at least two (one for admin</span><br><span class="hljs-comment">154   * commands and one for I/O commands).</span><br><span class="hljs-comment">155   */</span><br><span class="hljs-number">156</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_queue</span> &#123;</span><br><span class="hljs-number">157</span>  	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">q_dmadev</span>;</span><br><span class="hljs-number">158</span>  	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_dev</span> *<span class="hljs-title">dev</span>;</span><br><span class="hljs-number">159</span>  	<span class="hljs-type">spinlock_t</span> sq_lock;<br><span class="hljs-number">160</span>  	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_command</span> *<span class="hljs-title">sq_cmds</span>;</span>	<span class="hljs-comment">// SQ内存地址</span><br><span class="hljs-number">161</span>  	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_command</span> __<span class="hljs-title">iomem</span> *<span class="hljs-title">sq_cmds_io</span>;</span> <span class="hljs-comment">// 使用CMB的SQ IO地址</span><br><span class="hljs-number">162</span>  	<span class="hljs-type">spinlock_t</span> cq_lock ____cacheline_aligned_in_smp;<br><span class="hljs-number">163</span>  	<span class="hljs-keyword">volatile</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_completion</span> *<span class="hljs-title">cqes</span>;</span> <span class="hljs-comment">// CQ内存地址</span><br><span class="hljs-number">164</span>  	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_mq_tags</span> **<span class="hljs-title">tags</span>;</span><br><span class="hljs-number">165</span>  	<span class="hljs-type">dma_addr_t</span> sq_dma_addr;		<span class="hljs-comment">// SQ总线地址</span><br><span class="hljs-number">166</span>  	<span class="hljs-type">dma_addr_t</span> cq_dma_addr;		<span class="hljs-comment">// CQ总线地址</span><br><span class="hljs-number">167</span>  	u32 __iomem *q_db;			<span class="hljs-comment">// DB寄存器 IO地址</span><br><span class="hljs-number">168</span>  	u16 q_depth;<br><span class="hljs-number">169</span>  	s16 cq_vector;<br><span class="hljs-number">170</span>  	u16 sq_tail;			   <span class="hljs-comment">// 主机能写的两个DB寄存器的值</span><br><span class="hljs-number">171</span>  	u16 cq_head;<br><span class="hljs-number">172</span>  	u16 last_cq_head;<br><span class="hljs-number">173</span>  	u16 qid;<br><span class="hljs-number">174</span>  	u8 cq_phase;<br><span class="hljs-number">175</span>  	u32 *dbbuf_sq_db;		  	<br><span class="hljs-number">176</span>  	u32 *dbbuf_cq_db;<br><span class="hljs-number">177</span>  	u32 *dbbuf_sq_ei;<br><span class="hljs-number">178</span>  	u32 *dbbuf_cq_ei;<br><span class="hljs-number">179</span>  &#125;;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/6f5db08cae7247c4b009c0d6b8dc74c4.png" srcset="/img/loading.gif" lazyload><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_43629962/article/details/123985710">可乐学习NVMe之二：三只熊SQ&#x2F;CQ&#x2F;DB</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// spdk相关的CQ轮询代码</span><br><span class="hljs-type">int32_t</span><br><span class="hljs-title function_">nvme_pcie_qpair_process_completions</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair, <span class="hljs-type">uint32_t</span> max_completions)</span><br>&#123;<br>	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>		cpl = &amp;pqpair-&gt;cpl[pqpair-&gt;cq_head];<br><br>		<span class="hljs-keyword">if</span> (!next_is_valid &amp;&amp; cpl-&gt;status.p != pqpair-&gt;flags.phase) &#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (spdk_likely(pqpair-&gt;cq_head + <span class="hljs-number">1</span> != pqpair-&gt;num_entries)) &#123;<br>			next_cq_head = pqpair-&gt;cq_head + <span class="hljs-number">1</span>;<br>			next_phase = pqpair-&gt;flags.phase;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			next_cq_head = <span class="hljs-number">0</span>;<br>			next_phase = !pqpair-&gt;flags.phase;<br>		&#125;<br>		next_cpl = &amp;pqpair-&gt;cpl[next_cq_head];<br>		next_is_valid = (next_cpl-&gt;status.p == next_phase);<br>		<span class="hljs-keyword">if</span> (next_is_valid) &#123;<br>			__builtin_prefetch(&amp;pqpair-&gt;tr[next_cpl-&gt;cid]);<br>		&#125;<br><br>		tr = &amp;pqpair-&gt;tr[cpl-&gt;cid];<br>		pqpair-&gt;sq_head = cpl-&gt;sqhd;<br>		__builtin_prefetch(&amp;tr-&gt;req-&gt;stailq);<br>		nvme_pcie_qpair_complete_tracker(qpair, tr, cpl, <span class="hljs-literal">true</span>);<br>		<span class="hljs-keyword">if</span> (++num_completions == max_completions) &#123;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2dad6b6ac1a147b19320c22fd6c6d478.png" srcset="/img/loading.gif" lazyload></p><p>SPDK 驱动程序选择将硬件队列直接暴露给应用程序，并要求一次只能从一个线程访问硬件队列。实际上，应用程序为每个线程分配一个硬件队列（而不是内核驱动程序中每个核心一个硬件队列）。这保证了线程可以提交请求，而不必与系统中的其他线程执行任何类型的协调（即锁定）。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/whl320124/p/11398951.html#:~:text=SPDK%EF%BC%88%E5%AD%98%E5%82%A8%E6%80%A7%E8%83%BD%E5%BC%80%E5%8F%91%E5%A5%97%E4%BB%B6%EF%BC%89%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%96%87%E7%89%88,%EF%BC%882019%E5%B9%B48%E6%9C%88%E7%89%88%EF%BC%8C%E8%AF%91%EF%BC%9A%E7%8E%8B%E6%B5%B7%E4%BA%AE%EF%BC%89">SPDK（存储性能开发套件）官方文档中文版</a></p><p><img src="https://img-blog.csdnimg.cn/09daeff41d3a4e99b525e3462f110ed1.png" srcset="/img/loading.gif" lazyload></p><h1 id="SDC摘录"><a href="#SDC摘录" class="headerlink" title="SDC摘录"></a>SDC摘录</h1><p><img src="https://img-blog.csdnimg.cn/d942d64a463941a18ccdcba7bdcb3705.png" srcset="/img/loading.gif" lazyload><br><a target="_blank" rel="noopener" href="https://www.snia.org/educational-library?search=spdk&field_edu_content_type_tid=All&field_assoc_event_name_tid=All&field_release_date_value_2%5Bvalue%5D%5Byear%5D=&field_focus_areas_tid=All&field_author_tid=&field_release_date_value=All&items_per_page=20&captcha_sid=2529762&captcha_token=6c10ffa172586a5741aa802ca34ae1d7&captcha_cacheable=1&page=2">Educational Library</a></p><h2 id="SPDK-NVMe-An-In-depth-Look-at-its-Architecture-and-Design"><a href="#SPDK-NVMe-An-In-depth-Look-at-its-Architecture-and-Design" class="headerlink" title="SPDK NVMe: An In-depth Look at its Architecture and Design"></a>SPDK NVMe: An In-depth Look at its Architecture and Design</h2><p>PPT与SPDK代码简单对应<br><img src="https://img-blog.csdnimg.cn/69113a499d9648b2882d58b352cfdd1a.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// env.h</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Enumerate all PCI devices supported by the provided driver and try to</span><br><span class="hljs-comment"> * attach those that weren&#x27;t attached yet. The provided callback will be</span><br><span class="hljs-comment"> * called for each such device and its return code will decide whether that</span><br><span class="hljs-comment"> * device is attached or not. Attached devices have to be manually detached</span><br><span class="hljs-comment"> * with spdk_pci_device_detach() to be attach-able again.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * During enumeration all registered pci devices with exposed access to</span><br><span class="hljs-comment"> * userspace are getting probed internally unless not explicitly specified</span><br><span class="hljs-comment"> * on denylist. Because of that it becomes not possible to either use such</span><br><span class="hljs-comment"> * devices with another application or unbind the driver (e.g. vfio).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 2s asynchronous delay is introduced to avoid race conditions between</span><br><span class="hljs-comment"> * user space software initialization and in-kernel device handling for</span><br><span class="hljs-comment"> * newly inserted devices. Subsequent enumerate call after the delay</span><br><span class="hljs-comment"> * shall allow for a successful device attachment.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param driver Driver for a specific device type.</span><br><span class="hljs-comment"> * \param enum_cb Callback to be called for each non-attached PCI device.</span><br><span class="hljs-comment"> * \param enum_ctx Additional context passed to the callback function.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return -1 if an internal error occurred or the provided callback returned -1,</span><br><span class="hljs-comment"> *         0 otherwise</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">spdk_pci_enumerate</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_pci_driver *driver, spdk_pci_enum_cb enum_cb, <span class="hljs-type">void</span> *enum_ctx)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Allocate dma/sharable memory based on a given dma_flg. It is a memory buffer</span><br><span class="hljs-comment"> * with the given size, alignment and socket id.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param size Size in bytes.</span><br><span class="hljs-comment"> * \param align If non-zero, the allocated buffer is aligned to a multiple of</span><br><span class="hljs-comment"> * align. In this case, it must be a power of two. The returned buffer is always</span><br><span class="hljs-comment"> * aligned to at least cache line size.</span><br><span class="hljs-comment"> * \param phys_addr **Deprecated**. Please use spdk_vtophys() for retrieving physical</span><br><span class="hljs-comment"> * addresses. A pointer to the variable to hold the physical address of</span><br><span class="hljs-comment"> * the allocated buffer is passed. If NULL, the physical address is not returned.</span><br><span class="hljs-comment"> * \param socket_id Socket ID to allocate memory on, or SPDK_ENV_SOCKET_ID_ANY</span><br><span class="hljs-comment"> * for any socket.</span><br><span class="hljs-comment"> * \param flags Combination of SPDK_MALLOC flags (\ref SPDK_MALLOC_DMA, \ref SPDK_MALLOC_SHARE).</span><br><span class="hljs-comment"> * At least one flag must be specified.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return a pointer to the allocated memory buffer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">spdk_malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> align, <span class="hljs-type">uint64_t</span> *phys_addr, <span class="hljs-type">int</span> socket_id, <span class="hljs-type">uint32_t</span> flags)</span>;<br><br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/5664e42dd65e48cc8d9ee1870e79a382.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 省略一些成员</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_transport_ops</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr</span> *(*<span class="hljs-title">ctrlr_construct</span>)(<span class="hljs-title">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_transport_id</span> *<span class="hljs-title">trid</span>,</span><br><span class="hljs-class">			<span class="hljs-title">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr_opts</span> *<span class="hljs-title">opts</span>,</span><br><span class="hljs-class">			<span class="hljs-title">void</span> *<span class="hljs-title">devhandle</span>);</span>			<br>	<span class="hljs-type">int</span> (*ctrlr_destruct)(<span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr);<br><br>	<span class="hljs-type">int</span> (*ctrlr_set_reg_4)(<span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr, <span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> value);<br><br>	<span class="hljs-type">int</span> (*ctrlr_get_reg_4)(<span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr, <span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> *value);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_qpair</span> *(*<span class="hljs-title">ctrlr_create_io_qpair</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ctrlr</span> *<span class="hljs-title">ctrlr</span>, <span class="hljs-title">uint16_t</span> <span class="hljs-title">qid</span>,</span><br><span class="hljs-class">			<span class="hljs-title">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_io_qpair_opts</span> *<span class="hljs-title">opts</span>);</span><br><br>	<span class="hljs-type">int</span> (*ctrlr_delete_io_qpair)(<span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr, <span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair);<br><br>	<span class="hljs-type">int</span> (*qpair_submit_request)(<span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair, <span class="hljs-keyword">struct</span> nvme_request *req);<br><br>	<span class="hljs-type">int32_t</span> (*qpair_process_completions)(<span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair, <span class="hljs-type">uint32_t</span> max_completions);<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/ee799ff98acf44d9b43d077b6cc44ad2.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Enumerate the bus indicated by the transport ID and attach the userspace NVMe</span><br><span class="hljs-comment"> * driver to each device found if desired.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function is not thread safe and should only be called from one thread at</span><br><span class="hljs-comment"> * a time while no other threads are actively using any NVMe devices.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If called from a secondary process, only devices that have been attached to</span><br><span class="hljs-comment"> * the userspace driver in the primary process will be probed.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If called more than once, only devices that are not already attached to the</span><br><span class="hljs-comment"> * SPDK NVMe driver will be reported.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * To stop using the the controller and release its associated resources,</span><br><span class="hljs-comment"> * call spdk_nvme_detach() with the spdk_nvme_ctrlr instance from the attach_cb()</span><br><span class="hljs-comment"> * function.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param trid The transport ID indicating which bus to enumerate. If the trtype</span><br><span class="hljs-comment"> * is PCIe or trid is NULL, this will scan the local PCIe bus. If the trtype is</span><br><span class="hljs-comment"> * RDMA, the traddr and trsvcid must point at the location of an NVMe-oF discovery</span><br><span class="hljs-comment"> * service.</span><br><span class="hljs-comment"> * \param cb_ctx Opaque value which will be passed back in cb_ctx parameter of</span><br><span class="hljs-comment"> * the callbacks.</span><br><span class="hljs-comment"> * \param probe_cb will be called once per NVMe device found in the system.</span><br><span class="hljs-comment"> * \param attach_cb will be called for devices for which probe_cb returned true</span><br><span class="hljs-comment"> * once that NVMe controller has been attached to the userspace driver.</span><br><span class="hljs-comment"> * \param remove_cb will be called for devices that were attached in a previous</span><br><span class="hljs-comment"> * spdk_nvme_probe() call but are no longer attached to the system. Optional;</span><br><span class="hljs-comment"> * specify NULL if removal notices are not desired.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return 0 on success, -1 on failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">spdk_nvme_probe</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_nvme_transport_id *trid,</span><br><span class="hljs-params">		    <span class="hljs-type">void</span> *cb_ctx,</span><br><span class="hljs-params">		    spdk_nvme_probe_cb probe_cb,</span><br><span class="hljs-params">		    spdk_nvme_attach_cb attach_cb,</span><br><span class="hljs-params">		    spdk_nvme_remove_cb remove_cb)</span>;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/6f8cbd246db94fb3b7fa6d33f81a103b.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Allocate an I/O queue pair (submission and completion queue).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function by default also performs any connection activities required for</span><br><span class="hljs-comment"> * a newly created qpair. To avoid that behavior, the user should set the create_only</span><br><span class="hljs-comment"> * flag in the opts structure to true.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Each queue pair should only be used from a single thread at a time (mutual</span><br><span class="hljs-comment"> * exclusion must be enforced by the user).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param ctrlr NVMe controller for which to allocate the I/O queue pair.</span><br><span class="hljs-comment"> * \param opts I/O qpair creation options, or NULL to use the defaults as returned</span><br><span class="hljs-comment"> * by spdk_nvme_ctrlr_get_default_io_qpair_opts().</span><br><span class="hljs-comment"> * \param opts_size Must be set to sizeof(struct spdk_nvme_io_qpair_opts), or 0</span><br><span class="hljs-comment"> * if opts is NULL.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return a pointer to the allocated I/O queue pair.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> spdk_nvme_qpair *<span class="hljs-title function_">spdk_nvme_ctrlr_alloc_io_qpair</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_ctrlr *ctrlr,</span><br><span class="hljs-params">		<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_nvme_io_qpair_opts *opts,</span><br><span class="hljs-params">		<span class="hljs-type">size_t</span> opts_size)</span>;<br><br><span class="hljs-comment">// 省略一些成员		</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * NVMe I/O queue pair initialization options.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * These options may be passed to spdk_nvme_ctrlr_alloc_io_qpair() to configure queue pair</span><br><span class="hljs-comment"> * options at queue creation time.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The user may retrieve the default I/O queue pair creation options for a controller using</span><br><span class="hljs-comment"> * spdk_nvme_ctrlr_get_default_io_qpair_opts().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_io_qpair_opts</span> &#123;</span><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Queue priority for weighted round robin arbitration.  If a different arbitration</span><br><span class="hljs-comment">	 * method is in use, pass 0.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">spdk_nvme_qprio</span> <span class="hljs-title">qprio</span>;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The queue depth of this NVMe I/O queue. Overrides spdk_nvme_ctrlr_opts::io_queue_size.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint32_t</span> io_queue_size;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The number of requests to allocate for this NVMe I/O queue.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * Overrides spdk_nvme_ctrlr_opts::io_queue_requests.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * This should be at least as large as io_queue_size.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * A single I/O may allocate more than one request, since splitting may be</span><br><span class="hljs-comment">	 * necessary to conform to the device&#x27;s maximum transfer size, PRP list</span><br><span class="hljs-comment">	 * compatibility requirements, or driver-assisted striping.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint32_t</span> io_queue_requests;<br><br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/25115eed85f944318a5e603745373fd0.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * \brief Submits a read I/O to the specified NVMe namespace.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The command is submitted to a qpair allocated by spdk_nvme_ctrlr_alloc_io_qpair().</span><br><span class="hljs-comment"> * The user must ensure that only one thread submits I/O on a given qpair at any</span><br><span class="hljs-comment"> * given time.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param ns NVMe namespace to submit the read I/O.</span><br><span class="hljs-comment"> * \param qpair I/O queue pair to submit the request.</span><br><span class="hljs-comment"> * \param payload Virtual address pointer to the data payload.</span><br><span class="hljs-comment"> * \param lba Starting LBA to read the data.</span><br><span class="hljs-comment"> * \param lba_count Length (in sectors) for the read operation.</span><br><span class="hljs-comment"> * \param cb_fn Callback function to invoke when the I/O is completed.</span><br><span class="hljs-comment"> * \param cb_arg Argument to pass to the callback function.</span><br><span class="hljs-comment"> * \param io_flags Set flags, defined in nvme_spec.h, for this I/O.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return 0 if successfully submitted, negated errnos on the following error conditions:</span><br><span class="hljs-comment"> * -EINVAL: The request is malformed.</span><br><span class="hljs-comment"> * -ENOMEM: The request cannot be allocated.</span><br><span class="hljs-comment"> * -ENXIO: The qpair is failed at the transport level.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">spdk_nvme_ns_cmd_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_ns *ns, <span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair, <span class="hljs-type">void</span> *payload,</span><br><span class="hljs-params">			  <span class="hljs-type">uint64_t</span> lba, <span class="hljs-type">uint32_t</span> lba_count, spdk_nvme_cmd_cb cb_fn,</span><br><span class="hljs-params">			  <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">uint32_t</span> io_flags)</span>;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/b61a2023ebb9406b8f8ac4db150731be.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Process any outstanding completions for I/O submitted on a queue pair.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This call is non-blocking, i.e. it only processes completions that are ready</span><br><span class="hljs-comment"> * at the time of this function call. It does not wait for outstanding commands</span><br><span class="hljs-comment"> * to finish.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * For each completed command, the request&#x27;s callback function will be called if</span><br><span class="hljs-comment"> * specified as non-NULL when the request was submitted.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The caller must ensure that each queue pair is only used from one thread at a</span><br><span class="hljs-comment"> * time.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function may be called at any point while the controller is attached to</span><br><span class="hljs-comment"> * the SPDK NVMe driver.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \sa spdk_nvme_cmd_cb</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param qpair Queue pair to check for completions.</span><br><span class="hljs-comment"> * \param max_completions Limit the number of completions to be processed in one</span><br><span class="hljs-comment"> * call, or 0 for unlimited.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return number of completions processed (may be 0) or negated on error. -ENXIO</span><br><span class="hljs-comment"> * in the special case that the qpair is failed at the transport layer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">spdk_nvme_qpair_process_completions</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair,</span><br><span class="hljs-params">		<span class="hljs-type">uint32_t</span> max_completions)</span>;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/c1346376aff2463c8d09e3684c5a2ad8.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// qpair-&gt;transport-&gt;ops.qpair_submit_request(qpair, req);</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_request</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_cmd</span>		<span class="hljs-title">cmd</span>;</span><br><br>	<span class="hljs-type">uint8_t</span>				retries;<br><br>	<span class="hljs-type">uint8_t</span>				timed_out : <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * True if the request is in the queued_req list.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint8_t</span>				queued : <span class="hljs-number">1</span>;<br>	<span class="hljs-type">uint8_t</span>				reserved : <span class="hljs-number">6</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Number of children requests still outstanding for this</span><br><span class="hljs-comment">	 *  request which was split into multiple child requests.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint16_t</span>			num_children;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Offset in bytes from the beginning of payload for this request.</span><br><span class="hljs-comment">	 * This is used for I/O commands that are split into multiple requests.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint32_t</span>			payload_offset;<br>	<span class="hljs-type">uint32_t</span>			md_offset;<br><br>	<span class="hljs-type">uint32_t</span>			payload_size;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Timeout ticks for error injection requests, can be extended in future</span><br><span class="hljs-comment">	 * to support per-request timeout feature.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint64_t</span>			timeout_tsc;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Data payload for this request&#x27;s command.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_payload</span>		<span class="hljs-title">payload</span>;</span><br><br>	spdk_nvme_cmd_cb		cb_fn;<br>	<span class="hljs-type">void</span>				*cb_arg;<br>	STAILQ_ENTRY(nvme_request)	stailq;<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_qpair</span>		*<span class="hljs-title">qpair</span>;</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The value of spdk_get_ticks() when the request was submitted to the hardware.</span><br><span class="hljs-comment">	 * Only set if ctrlr-&gt;timeout_enabled is true.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">uint64_t</span>			submit_tick;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The active admin request can be moved to a per process pending</span><br><span class="hljs-comment">	 *  list based on the saved pid to tell which process it belongs</span><br><span class="hljs-comment">	 *  to. The cpl saves the original completion information which</span><br><span class="hljs-comment">	 *  is used in the completion callback.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">NOTE:</span> these below two fields are only used for admin request.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">pid_t</span>				pid;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_cpl</span>		<span class="hljs-title">cpl</span>;</span><br><br>	<span class="hljs-type">uint32_t</span>			md_size;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The following members should not be reordered with members</span><br><span class="hljs-comment">	 *  above.  These members are only needed when splitting</span><br><span class="hljs-comment">	 *  requests which is done rarely, and the driver is careful</span><br><span class="hljs-comment">	 *  to not touch the following fields until a split operation is</span><br><span class="hljs-comment">	 *  needed, to avoid touching an extra cacheline.</span><br><span class="hljs-comment">	 */</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Points to the outstanding child requests for a parent request.</span><br><span class="hljs-comment">	 *  Only valid if a request was split into multiple children</span><br><span class="hljs-comment">	 *  requests, and is not initialized for non-split requests.</span><br><span class="hljs-comment">	 */</span><br>	TAILQ_HEAD(, nvme_request)	children;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Linked-list pointers for a child request in its parent&#x27;s list.</span><br><span class="hljs-comment">	 */</span><br>	TAILQ_ENTRY(nvme_request)	child_tailq;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Points to a parent request if part of a split request,</span><br><span class="hljs-comment">	 *   NULL otherwise.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_request</span>		*<span class="hljs-title">parent</span>;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Completion status for a parent request.  Initialized to all 0&#x27;s</span><br><span class="hljs-comment">	 *  (SUCCESS) before child requests are submitted.  If a child</span><br><span class="hljs-comment">	 *  request completes with error, the error status is copied here,</span><br><span class="hljs-comment">	 *  to ensure that the parent request is also completed with error</span><br><span class="hljs-comment">	 *  status once all child requests are completed.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_cpl</span>		<span class="hljs-title">parent_status</span>;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The user_cb_fn and user_cb_arg fields are used for holding the original</span><br><span class="hljs-comment">	 * callback data when using nvme_allocate_request_user_copy.</span><br><span class="hljs-comment">	 */</span><br>	spdk_nvme_cmd_cb		user_cb_fn;<br>	<span class="hljs-type">void</span>				*user_cb_arg;<br>	<span class="hljs-type">void</span>				*user_buffer;<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/5e19774af1fd4bfeb4a26e2b1cdad2a7.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span>((<span class="hljs-title">packed</span>)) <span class="hljs-title">spdk_nvme_ctrlr_data</span> &#123;</span><br>	<span class="hljs-comment">/* bytes 0-255: controller capabilities and features */</span><br><br>	<span class="hljs-comment">/** maximum data transfer size */</span><br>	<span class="hljs-type">uint8_t</span>			mdts;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_nvme_ns_data</span> &#123;</span><br>	<span class="hljs-comment">/** namespace optimal I/O boundary in logical blocks */</span><br>	<span class="hljs-type">uint16_t</span>		noiob;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/7ed2cec387604c48a68d66be43775e23.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Submit a write I/O to the specified NVMe namespace.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The command is submitted to a qpair allocated by spdk_nvme_ctrlr_alloc_io_qpair().</span><br><span class="hljs-comment"> * The user must ensure that only one thread submits I/O on a given qpair at any</span><br><span class="hljs-comment"> * given time.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param ns NVMe namespace to submit the write I/O.</span><br><span class="hljs-comment"> * \param qpair I/O queue pair to submit the request.</span><br><span class="hljs-comment"> * \param lba Starting LBA to write the data.</span><br><span class="hljs-comment"> * \param lba_count Length (in sectors) for the write operation.</span><br><span class="hljs-comment"> * \param cb_fn Callback function to invoke when the I/O is completed.</span><br><span class="hljs-comment"> * \param cb_arg Argument to pass to the callback function.</span><br><span class="hljs-comment"> * \param io_flags Set flags, defined in nvme_spec.h, for this I/O.</span><br><span class="hljs-comment"> * \param reset_sgl_fn Callback function to reset scattered payload.</span><br><span class="hljs-comment"> * \param next_sge_fn Callback function to iterate each scattered payload memory</span><br><span class="hljs-comment"> * segment.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return 0 if successfully submitted, negated errnos on the following error conditions:</span><br><span class="hljs-comment"> * -EINVAL: The request is malformed.</span><br><span class="hljs-comment"> * -ENOMEM: The request cannot be allocated.</span><br><span class="hljs-comment"> * -ENXIO: The qpair is failed at the transport level.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">spdk_nvme_ns_cmd_writev</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_ns *ns, <span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair,</span><br><span class="hljs-params">			    <span class="hljs-type">uint64_t</span> lba, <span class="hljs-type">uint32_t</span> lba_count,</span><br><span class="hljs-params">			    spdk_nvme_cmd_cb cb_fn, <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">uint32_t</span> io_flags,</span><br><span class="hljs-params">			    spdk_nvme_req_reset_sgl_cb reset_sgl_fn,</span><br><span class="hljs-params">			    spdk_nvme_req_next_sge_cb next_sge_fn)</span>;<br><br></code></pre></td></tr></table></figure><h2 id="SPDK-Blobstore-A-Look-Inside-the-NVM-Optimized-Allocator"><a href="#SPDK-Blobstore-A-Look-Inside-the-NVM-Optimized-Allocator" class="headerlink" title="SPDK Blobstore: A Look Inside the NVM Optimized Allocator"></a>SPDK Blobstore: A Look Inside the NVM Optimized Allocator</h2><p>PPT中介绍的代码：spdk&#x2F;examples&#x2F;blob&#x2F;hello_world&#x2F;hello_blob.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">./build/examples/hello_blob  ./examples/blob/hello_world/hello_blob.json<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">03.591974</span>] Starting SPDK v23<span class="hljs-number">.05</span>-pre git sha1 ee06693c3 / DPDK <span class="hljs-number">22.11</span><span class="hljs-number">.1</span> initialization...<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">03.592772</span>] [ DPDK EAL parameters: hello_blob --no-shconf -c <span class="hljs-number">0x1</span> --huge-unlink --<span class="hljs-built_in">log</span>-level=lib.eal:<span class="hljs-number">6</span> --<span class="hljs-built_in">log</span>-level=lib.cryptodev:<span class="hljs-number">5</span> --<span class="hljs-built_in">log</span>-level=user1:<span class="hljs-number">6</span> --iova-mode=pa --base-virtaddr=<span class="hljs-number">0x200000000000</span> --match-allocations --file-prefix=spdk_pid59413 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">03.732576</span>] app.c: <span class="hljs-number">738</span>:spdk_app_start: *NOTICE*: Total cores available: <span class="hljs-number">1</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.022598</span>] reactor.c: <span class="hljs-number">937</span>:reactor_run: *NOTICE*: Reactor started on core <span class="hljs-number">0</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.420790</span>] accel_sw.c: <span class="hljs-number">601</span>:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.692072</span>] hello_blob.c: <span class="hljs-number">386</span>:hello_start: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.695777</span>] hello_blob.c: <span class="hljs-number">345</span>:bs_init_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696207</span>] hello_blob.c: <span class="hljs-number">353</span>:bs_init_complete: *NOTICE*: blobstore: <span class="hljs-number">0x563aa7539de0</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696298</span>] hello_blob.c: <span class="hljs-number">332</span>:create_blob: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696457</span>] hello_blob.c: <span class="hljs-number">311</span>:blob_create_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696579</span>] hello_blob.c: <span class="hljs-number">319</span>:blob_create_complete: *NOTICE*: new blob id <span class="hljs-number">4294967296</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696689</span>] hello_blob.c: <span class="hljs-number">280</span>:open_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696801</span>] hello_blob.c: <span class="hljs-number">290</span>:open_complete: *NOTICE*: blobstore has FREE clusters of <span class="hljs-number">15</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.696911</span>] hello_blob.c: <span class="hljs-number">256</span>:resize_complete: *NOTICE*: resized blob now has USED clusters of <span class="hljs-number">15</span><br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697014</span>] hello_blob.c: <span class="hljs-number">233</span>:sync_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697098</span>] hello_blob.c: <span class="hljs-number">195</span>:blob_write: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697263</span>] hello_blob.c: <span class="hljs-number">178</span>:write_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697386</span>] hello_blob.c: <span class="hljs-number">153</span>:read_blob: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697475</span>] hello_blob.c: <span class="hljs-number">126</span>:read_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697568</span>] hello_blob.c: <span class="hljs-number">140</span>:read_complete: *NOTICE*: read SUCCESS and data matches!<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.697703</span>] hello_blob.c: <span class="hljs-number">106</span>:delete_blob: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.699957</span>] hello_blob.c:  <span class="hljs-number">87</span>:delete_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.700400</span>] hello_blob.c:  <span class="hljs-number">50</span>:unload_complete: *NOTICE*: entry<br>[<span class="hljs-number">2023</span><span class="hljs-number">-06</span><span class="hljs-number">-20</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">04.783541</span>] hello_blob.c: <span class="hljs-number">459</span>:main: *NOTICE*: SUCCESS!<br></code></pre></td></tr></table></figure><p>配置文件并不用-c指定而是硬编码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Setup a few specifics before we init, for most SPDK cmd line</span><br><span class="hljs-comment"> * apps, the config file will be passed in as an arg but to make</span><br><span class="hljs-comment"> * this example super simple we just hardcode it. We also need to</span><br><span class="hljs-comment"> * specify a name for the app.</span><br><span class="hljs-comment"> */</span><br>opts.name = <span class="hljs-string">&quot;hello_blob&quot;</span>;<br>opts.json_config_file = argv[<span class="hljs-number">1</span>];<br></code></pre></td></tr></table></figure><p>hello_blob.c简单易懂，全都是回调函数，由下至上看过去就可以了，主要就是看看各个api的使用</p><p>&emsp; Message passing is efficient, but it results in asynchronous code. Unfortunately, asynchronous code is a challenge in C. It’s often implemented by passing function pointers that are called when an operation completes. This chops up the code so that it isn’t easy to follow, especially through logic branches. The best solution is to use a language with support for futures and promises, such as C++, Rust, Go, or almost any other higher level language. However, SPDK is a low level library and requires very wide compatibility and portability, so we’ve elected to stay with plain old C.<br>&emsp; We do have a few recommendations to share, though. For simple callback chains, it’s easiest if you write the functions from bottom to top. By that we mean if function foo performs some asynchronous operation and when that completes function bar is called, then function bar performs some operation that calls function baz on completion, a good way to write it is as such:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">baz</span><span class="hljs-params">(<span class="hljs-type">void</span> *ctx)</span> &#123;<br>        ...<br>&#125;<br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">bar</span><span class="hljs-params">(<span class="hljs-type">void</span> *ctx)</span> &#123;<br>        async_op(baz, ctx);<br>&#125;<br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span> *ctx)</span> &#123;<br>        async_op(bar, ctx);<br>&#125;<br></code></pre></td></tr></table></figure><p>&emsp; Don’t split these functions up - keep them as a nice unit that can be read from bottom to top.</p><p>看了event的代码与文档<br>spdk&#x2F;include&#x2F;spdk&#x2F;env.h<br>&#x2F;spdk&#x2F;doc&#x2F;event.md</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Start the framework.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Before calling this function, opts must be initialized by</span><br><span class="hljs-comment"> * spdk_app_opts_init(). Once started, the framework will call start_fn on</span><br><span class="hljs-comment"> * an spdk_thread running on the current system thread with the</span><br><span class="hljs-comment"> * argument provided.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If opts-&gt;delay_subsystem_init is set</span><br><span class="hljs-comment"> * (e.g. through --wait-for-rpc flag in spdk_app_parse_args())</span><br><span class="hljs-comment"> * this function will only start a limited RPC server accepting</span><br><span class="hljs-comment"> * only a few RPC commands - mostly related to pre-initialization.</span><br><span class="hljs-comment"> * With this option, the framework won&#x27;t be started and start_fn</span><br><span class="hljs-comment"> * won&#x27;t be called until the user sends an `rpc_framework_start_init`</span><br><span class="hljs-comment"> * RPC command, which marks the pre-initialization complete and</span><br><span class="hljs-comment"> * allows start_fn to be finally called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This call will block until spdk_app_stop() is called. If an error</span><br><span class="hljs-comment"> * condition occurs during the initialization code within spdk_app_start(),</span><br><span class="hljs-comment"> * this function will immediately return before invoking start_fn.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param opts_user Initialization options used for this application. It should not be</span><br><span class="hljs-comment"> *             NULL. And the opts_size value inside the opts structure should not be zero.</span><br><span class="hljs-comment"> * \param start_fn Entry point that will execute on an internally created thread</span><br><span class="hljs-comment"> *                 once the framework has been started.</span><br><span class="hljs-comment"> * \param ctx Argument passed to function start_fn.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \return 0 on success or non-zero on failure.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">spdk_app_start</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_app_opts *opts_user, spdk_msg_fn start_fn,</span><br><span class="hljs-params">		   <span class="hljs-type">void</span> *ctx)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Perform final shutdown operations on an application using the event framework.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spdk_app_fini</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Start shutting down the framework.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Typically this function is not called directly, and the shutdown process is</span><br><span class="hljs-comment"> * started implicitly by a process signal. But in applications that are using</span><br><span class="hljs-comment"> * SPDK for a subset of its process threads, this function can be called in lieu</span><br><span class="hljs-comment"> * of a signal.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spdk_app_start_shutdown</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Stop the framework.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not wait for all threads to exit. Instead, it kicks off the shutdown</span><br><span class="hljs-comment"> * process and returns. Once the shutdown process is complete, spdk_app_start()</span><br><span class="hljs-comment"> * will return.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * \param rc The rc value specified here will be returned to caller of spdk_app_start().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spdk_app_stop</span><span class="hljs-params">(<span class="hljs-type">int</span> rc)</span>;<br></code></pre></td></tr></table></figure><h3 id="spdk-rocksdb"><a href="#spdk-rocksdb" class="headerlink" title="spdk+rocksdb"></a>spdk+rocksdb</h3><p>参考：<a target="_blank" rel="noopener" href="https://spdk.io/doc/blobfs.html">RocksDB Integration</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 需安装gflags后再编译rocksdb</span><br>git <span class="hljs-built_in">clone</span> https://github.com/gflags/gflags.git <br><span class="hljs-built_in">cd</span> gflags<br><span class="hljs-built_in">mkdir</span> build <br><span class="hljs-built_in">cd</span> build<br>cmake -DBUILD_SHARED_LIBS=ON -DBUILD_STATIC_LIBS=ON -DINSTALL_HEADERS=ON -DINSTALL_SHARED_LIBS=ON -DINSTALL_STATIC_LIBS=ON ..<br>make &amp;&amp; make install<br><span class="hljs-comment"># 编译生成db_bench可执行文件</span><br><span class="hljs-built_in">cd</span> ../..<br>git <span class="hljs-built_in">clone</span> -b 6.15.fb https://github.com/spdk/rocksdb.git<br><span class="hljs-built_in">cd</span> rocksdb<br>make db_bench SPDK_DIR=../spdk<br><br><span class="hljs-comment"># 创建blobfs</span><br>scripts/gen_nvme.sh --json-with-subsystems &gt; ../rocksdb.json<br><span class="hljs-built_in">test</span>/blobfs/mkfs/mkfs ../rocksdb.json Nvme0n1<br></code></pre></td></tr></table></figure><p>文件夹示意图<br><img src="https://img-blog.csdnimg.cn/7badc3117f2146e5b829650b10f8302a.png" srcset="/img/loading.gif" lazyload></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458997512">Ubuntu20.04安装gflags</a><br>若未安装gflags则执行db_bench显示如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"> ./db_bench <br>Please install gflags to run rocksdb tools<br><br><span class="hljs-comment">// 相关代码:db_bench.cc</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> GFLAGS</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Please install gflags to run rocksdb tools\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;rocksdb/db_bench_tool.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> &#123;<br>  <span class="hljs-keyword">return</span> ROCKSDB_NAMESPACE::db_bench_tool(argc, argv);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// GFLAGS</span></span><br></code></pre></td></tr></table></figure><h4 id="libgflags-so-2-2-cannot-open-shared-object-file-No-such-file-or-directory"><a href="#libgflags-so-2-2-cannot-open-shared-object-file-No-such-file-or-directory" class="headerlink" title="libgflags.so.2.2: cannot open shared object file: No such file or directory"></a>libgflags.so.2.2: cannot open shared object file: No such file or directory</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">./db_bench<br>./db_bench: error <span class="hljs-keyword">while</span> loading shared libraries: libgflags.so.2.2: cannot open shared object file: No such file or directory<br>ldd db_bench <br>        linux-vdso.so.1 (0x00007fff14f4b000)<br>        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fda223f7000)<br>        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fda223d4000)<br>        libgflags.so.2.2 =&gt; not found  <br>        libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007fda223b8000)<br>        libnuma.so.1 =&gt; /lib/x86_64-linux-gnu/libnuma.so.1 (0x00007fda223ab000)<br>        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007fda223a1000)<br>        libuuid.so.1 =&gt; /lib/x86_64-linux-gnu/libuuid.so.1 (0x00007fda22396000)<br>        libssl.so.1.1 =&gt; /lib/x86_64-linux-gnu/libssl.so.1.1 (0x00007fda22303000)<br>        libcrypto.so.1.1 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007fda2202d000)<br>        libaio.so.1 =&gt; /lib/x86_64-linux-gnu/libaio.so.1 (0x00007fda22028000)<br>        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007fda21e46000)<br>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007fda21cf7000)<br>        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007fda21cda000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fda21ae8000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007fda23113000)<br></code></pre></td></tr></table></figure><p>libgflags.so.2.2路径未知，查看gflags make install输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"> make install<br>[ 25%] Built target gflags_nothreads_shared<br>[ 50%] Built target gflags_shared<br>[ 75%] Built target gflags_nothreads_static<br>[100%] Built target gflags_static<br>Install the project...<br>-- Install configuration: <span class="hljs-string">&quot;Release&quot;</span><br>-- Installing: /usr/local/lib/libgflags.so.2.2.2<br>-- Installing: /usr/local/lib/libgflags.so.2.2<br>-- Installing: /usr/local/lib/libgflags.so<br>-- Installing: /usr/local/lib/libgflags_nothreads.so.2.2.2<br>-- Installing: /usr/local/lib/libgflags_nothreads.so.2.2<br>-- Installing: /usr/local/lib/libgflags_nothreads.so<br>-- Installing: /usr/local/lib/libgflags.a<br>-- Installing: /usr/local/lib/libgflags_nothreads.a<br>-- Installing: /usr/local/include/gflags/gflags.h<br>-- Installing: /usr/local/include/gflags/gflags_declare.h<br>-- Installing: /usr/local/include/gflags/gflags_completions.h<br>-- Installing: /usr/local/include/gflags/gflags_gflags.h<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-config.cmake<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-config-version.cmake<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-targets.cmake<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-targets-release.cmake<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-nonamespace-targets.cmake<br>-- Installing: /usr/local/lib/cmake/gflags/gflags-nonamespace-targets-release.cmake<br>-- Installing: /usr/local/bin/gflags_completions.sh<br>-- Installing: /usr/local/lib/pkgconfig/gflags.pc<br>-- Installing: /root/.cmake/packages/gflags/e5f7ce61772240490d3164df06f58ce9<br></code></pre></td></tr></table></figure><p>增加动态库搜索路径：&#x2F;usr&#x2F;local&#x2F;lib</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$LD_LIBRARY_PATH</span>:/usr/local/lib<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">ldd db_bench <br>        linux-vdso.so.1 (0x00007ffcdeff2000)<br>        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f6cfa436000)<br>        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f6cfa413000)<br>        libgflags.so.2.2 =&gt; /usr/local/lib/libgflags.so.2.2 (0x00007f6cfa3e6000)<br>        libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f6cfa3ca000)<br>        libnuma.so.1 =&gt; /lib/x86_64-linux-gnu/libnuma.so.1 (0x00007f6cfa3bd000)<br>        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f6cfa3b3000)<br>        libuuid.so.1 =&gt; /lib/x86_64-linux-gnu/libuuid.so.1 (0x00007f6cfa3a8000)<br>        libssl.so.1.1 =&gt; /lib/x86_64-linux-gnu/libssl.so.1.1 (0x00007f6cfa315000)<br>        libcrypto.so.1.1 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007f6cfa03f000)<br>        libaio.so.1 =&gt; /lib/x86_64-linux-gnu/libaio.so.1 (0x00007f6cfa03a000)<br>        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f6cf9e58000)<br>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f6cf9d09000)<br>        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f6cf9cec000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f6cf9afa000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007f6cfb152000)<br></code></pre></td></tr></table></figure><p><strong>spdk与内核文件系统简单对比</strong><br>db_bench spdk相关参数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rocksdb/tools/db_bench_tool.cc</span><br>DEFINE_string(spdk, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;Name of SPDK configuration file&quot;</span>);<br>DEFINE_string(spdk_bdev, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;Name of SPDK blockdev to load&quot;</span>);<br>DEFINE_uint64(spdk_cache_size, <span class="hljs-number">4096</span>, <span class="hljs-string">&quot;Size of SPDK filesystem cache (in MB)&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@driver-virtual-machine ~/s/rocksdb (6.15.fb)<span class="hljs-comment"># ./db_bench --spdk=../rocksdb.json --spdk_bdev=Nvme0n1  --benchmarks=fillrandom --num=1000000 --compression_type=none --spdk_cache_size=1024</span><br>[2023-06-20 22:18:35.512845] Starting SPDK v23.05-pre git sha1 ee06693c3 / DPDK 22.11.1 initialization...<br>[2023-06-20 22:18:35.513502] [ DPDK EAL parameters: rocksdb --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid136961 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-06-20 22:18:35.634516] app.c: 738:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-06-20 22:18:35.685057] app.c: 447:app_setup_trace: *NOTICE*: Tracepoint Group Mask 0x80 specified.<br>[2023-06-20 22:18:35.685576] app.c: 448:app_setup_trace: *NOTICE*: Use <span class="hljs-string">&#x27;spdk_trace -s rocksdb -p 136961&#x27;</span> to capture a snapshot of events at runtime.<br>[2023-06-20 22:18:35.687013] app.c: 453:app_setup_trace: *NOTICE*: Or copy /dev/shm/rocksdb_trace.pid136961 <span class="hljs-keyword">for</span> offline analysis/debug.<br>[2023-06-20 22:18:35.687997] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-06-20 22:18:35.736796] accel_sw.c: 601:sw_accel_module_init: *NOTICE*: Accel framework software module initialized.<br>using bdev Nvme0n1<br>Initializing RocksDB Options from the specified file<br>Initializing RocksDB Options from command-line flags<br>RocksDB:    version 6.15<br>Date:       Tue Jun 20 22:18:36 2023<br>CPU:        2 * AMD Ryzen 5 4600U with Radeon Graphics<br>CPUCache:   512 KB<br>Keys:       16 bytes each (+ 0 bytes user-defined timestamp)<br>Values:     100 bytes each (50 bytes after compression)<br>Entries:    1000000<br>Prefix:    0 bytes<br>Keys per prefix:    0<br>RawSize:    110.6 MB (estimated)<br>FileSize:   62.9 MB (estimated)<br>Write rate: 0 bytes/second<br>Read rate: 0 ops/second<br>Compression: NoCompression<br>Compression sampling rate: 0<br>Memtablerep: skip_list<br>Perf Level: 1<br>WARNING: Assertions are enabled; benchmarks unnecessarily slow<br>------------------------------------------------<br>Initializing RocksDB Options from the specified file<br>Initializing RocksDB Options from command-line flags<br>DB path: [/tmp/rocksdbtest-0/dbbench]<br>fillrandom   :       6.511 micros/op 153577 ops/sec;   17.0 MB/s<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@driver-virtual-machine ~/s/rocksdb (6.15.fb)<span class="hljs-comment"># ./db_bench   --benchmarks=fillrandom --num=1000000 --compression_type=none </span><br>Initializing RocksDB Options from the specified file<br>Initializing RocksDB Options from command-line flags<br>RocksDB:    version 6.15<br>Date:       Tue Jun 20 22:47:23 2023<br>CPU:        2 * AMD Ryzen 5 4600U with Radeon Graphics<br>CPUCache:   512 KB<br>Keys:       16 bytes each (+ 0 bytes user-defined timestamp)<br>Values:     100 bytes each (50 bytes after compression)<br>Entries:    1000000<br>Prefix:    0 bytes<br>Keys per prefix:    0<br>RawSize:    110.6 MB (estimated)<br>FileSize:   62.9 MB (estimated)<br>Write rate: 0 bytes/second<br>Read rate: 0 ops/second<br>Compression: NoCompression<br>Compression sampling rate: 0<br>Memtablerep: skip_list<br>Perf Level: 1<br>WARNING: Assertions are enabled; benchmarks unnecessarily slow<br>------------------------------------------------<br>Initializing RocksDB Options from the specified file<br>Initializing RocksDB Options from command-line flags<br>DB path: [/tmp/rocksdbtest-0/dbbench]<br>fillrandom   :       8.553 micros/op 116911 ops/sec;   12.9 MB/s<br></code></pre></td></tr></table></figure><h1 id="hello-blob"><a href="#hello-blob" class="headerlink" title="hello_blob"></a>hello_blob</h1><h2 id="文档与源码简要阅读"><a href="#文档与源码简要阅读" class="headerlink" title="文档与源码简要阅读"></a>文档与源码简要阅读</h2><p>分支切到23.09，阅读<a target="_blank" rel="noopener" href="https://spdk.io/doc/blob.html">Blobstore Programmer’s Guide</a></p><p><img src="https://img-blog.csdnimg.cn/5f20c324ddbb4fdb903f52d9a2f15181.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://img-blog.csdnimg.cn/05933bb0f16b4a0fa3aaabb6e3ffbe56.png" srcset="/img/loading.gif" lazyload></p><p><strong>运行hello_blob程序，查看输出</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@osd-node0 ~/l/s/b/examples (v23.09.x)<span class="hljs-comment"># ./hello_blob /root/xxx/spdk/examples/blob/hello_world/hello_blob.json</span><br>[2023-10-30 10:42:55.201033] Starting SPDK v23.09.1-pre git sha1 aa8059716 / DPDK 23.07.0 initialization...<br>[2023-10-30 10:42:55.201151] [ DPDK EAL parameters: hello_blob --no-shconf -c 0x1 --huge-unlink --log-level=lib.eal:6 --log-level=lib.cryptodev:5 --log-level=user1:6 --iova-mode=pa --base-virtaddr=0x200000000000 --match-allocations --file-prefix=spdk_pid247614 ]<br>TELEMETRY: No legacy callbacks, legacy socket not created<br>[2023-10-30 10:42:55.209967] app.c: 786:spdk_app_start: *NOTICE*: Total cores available: 1<br>[2023-10-30 10:42:55.237068] reactor.c: 937:reactor_run: *NOTICE*: Reactor started on core 0<br>[2023-10-30 10:42:55.307336] hello_blob.c: 386:hello_start: *NOTICE*: entry<br>[2023-10-30 10:42:55.308734] hello_blob.c: 345:bs_init_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308751] hello_blob.c: 353:bs_init_complete: *NOTICE*: blobstore: 0x560b5be05540<br>[2023-10-30 10:42:55.308755] hello_blob.c: 332:create_blob: *NOTICE*: entry<br>[2023-10-30 10:42:55.308763] hello_blob.c: 311:blob_create_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308766] hello_blob.c: 319:blob_create_complete: *NOTICE*: new blob <span class="hljs-built_in">id</span> 4294967296<br>[2023-10-30 10:42:55.308772] hello_blob.c: 280:open_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308775] hello_blob.c: 290:open_complete: *NOTICE*: blobstore has FREE clusters of 15<br>[2023-10-30 10:42:55.308781] hello_blob.c: 256:resize_complete: *NOTICE*: resized blob now has USED clusters of 15<br>[2023-10-30 10:42:55.308786] hello_blob.c: 233:sync_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308789] hello_blob.c: 195:blob_write: *NOTICE*: entry<br>[2023-10-30 10:42:55.308794] hello_blob.c: 178:write_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308797] hello_blob.c: 153:read_blob: *NOTICE*: entry<br>[2023-10-30 10:42:55.308800] hello_blob.c: 126:read_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.308803] hello_blob.c: 140:read_complete: *NOTICE*: <span class="hljs-built_in">read</span> SUCCESS and data matches!<br>[2023-10-30 10:42:55.308807] hello_blob.c: 106:delete_blob: *NOTICE*: entry<br>[2023-10-30 10:42:55.309275] hello_blob.c:  87:delete_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.309289] hello_blob.c:  50:unload_complete: *NOTICE*: entry<br>[2023-10-30 10:42:55.374886] hello_blob.c: 459:main: *NOTICE*: SUCCESS!<br></code></pre></td></tr></table></figure><p><strong>调用API顺序</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Create a blobstore block device from a bdev.</span><br>rc = spdk_bdev_create_bs_dev_ext(<span class="hljs-string">&quot;Malloc0&quot;</span>, base_bdev_event_cb, <span class="hljs-literal">NULL</span>, &amp;bs_dev);<br><br><span class="hljs-comment">// Initialize a blobstore on the given device.</span><br>spdk_bs_init(bs_dev, <span class="hljs-literal">NULL</span>, bs_init_complete, hello_context);<br><br><span class="hljs-comment">// Create a new blob with default option values on the given blobstore. The new blob id will be passed to the callback function.</span><br>spdk_bs_create_blob(hello_context-&gt;bs, blob_create_complete, hello_context);<br><br><span class="hljs-comment">// Open a blob from the given blobstore.</span><br>spdk_bs_open_blob(hello_context-&gt;bs, hello_context-&gt;blobid, open_complete, hello_context);<br><br><span class="hljs-comment">// Resize a blob to &#x27;sz&#x27; clusters. These changes are not persisted to disk until spdk_bs_md_sync_blob() is called. If called before previous resize finish, it will fail with errno -EBUSY</span><br>spdk_blob_resize(hello_context-&gt;blob, <span class="hljs-built_in">free</span>, resize_complete, hello_context);<br><br><span class="hljs-comment">// Sync a blob. Make a blob persistent. This applies to open, resize, set xattr, and remove xattr. These operations will not be persistent until the blob has been synced.</span><br>spdk_blob_sync_md(hello_context-&gt;blob, sync_complete, hello_context);<br><br><span class="hljs-comment">// Allocate an I/O channel for the given blobstore.</span><br>hello_context-&gt;channel = spdk_bs_alloc_io_channel(hello_context-&gt;bs);<br><br><span class="hljs-comment">// Write data to a blob.</span><br>spdk_blob_io_write(hello_context-&gt;blob, hello_context-&gt;channel, hello_context-&gt;write_buff, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, write_complete, hello_context);<br><br><span class="hljs-comment">// Read data from a blob.</span><br>spdk_blob_io_read(hello_context-&gt;blob, hello_context-&gt;channel, hello_context-&gt;read_buff, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, read_complete, hello_context);<br><br><span class="hljs-comment">// Close a blob. This will automatically sync.</span><br>spdk_blob_close(hello_context-&gt;blob, delete_blob, hello_context);<br><br><span class="hljs-comment">// Delete an existing blob from the given blobstore.</span><br>spdk_bs_delete_blob(hello_context-&gt;bs, hello_context-&gt;blobid, delete_complete, hello_context);<br><br><span class="hljs-comment">// Free the I/O channel.</span><br>spdk_bs_free_io_channel(hello_context-&gt;channel);<br><br><span class="hljs-comment">// Unload the blobstore. It will flush all volatile data to disk.</span><br>spdk_bs_unload(hello_context-&gt;bs, unload_complete, hello_context);<br><br><br><span class="hljs-comment">// 其他API</span><br><br><span class="hljs-comment">// Get the io unit size in bytes.</span><br>hello_context-&gt;io_unit_size = spdk_bs_get_io_unit_size(hello_context-&gt;bs);<br><br><span class="hljs-comment">// Get the number of free clusters.</span><br><span class="hljs-built_in">free</span> = spdk_bs_free_cluster_count(hello_context-&gt;bs);<br><br><span class="hljs-comment">// Get the number of clusters allocated to the blob.</span><br>total = spdk_blob_get_num_clusters(hello_context-&gt;blob);<br><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hello_context_t</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_store</span> *<span class="hljs-title">bs</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span> *<span class="hljs-title">blob</span>;</span><br>	spdk_blob_id blobid;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span> *<span class="hljs-title">channel</span>;</span><br>	<span class="hljs-type">uint8_t</span> *read_buff;<br>	<span class="hljs-type">uint8_t</span> *write_buff;<br>	<span class="hljs-type">uint64_t</span> io_unit_size;<br>	<span class="hljs-type">int</span> rc;<br>&#125;;<br></code></pre></td></tr></table></figure><p>更改打印级别，查看debug输出</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">./configure --enable-debug<br>    <br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">hello_start</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg1)</span> &#123;<br>  spdk_log_set_flag(<span class="hljs-string">&quot;all&quot;</span>);<br>  spdk_log_set_print_level(SPDK_LOG_DEBUG);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="问题研究"><a href="#问题研究" class="headerlink" title="问题研究"></a>问题研究</h2><h3 id="blob-id相关"><a href="#blob-id相关" class="headerlink" title="blob id相关"></a>blob id相关</h3><p><strong>blob id的分配</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">spdk_bs_create_blob(hello_context-&gt;bs, blob_create_complete, hello_context);<br>	bs_create_blob(bs, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, cb_fn, cb_arg);<br><span class="hljs-comment">// 相关代码 </span><br>	spdk_spin_lock(&amp;bs-&gt;used_lock);<br>	<span class="hljs-comment">// 找到第一个为0的位置</span><br>	page_idx = spdk_bit_array_find_first_clear(bs-&gt;used_md_pages, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (page_idx == UINT32_MAX) &#123;<br>		spdk_spin_unlock(&amp;bs-&gt;used_lock);<br>		cb_fn(cb_arg, <span class="hljs-number">0</span>, -ENOMEM);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-comment">// 将对应位置位</span><br>	spdk_bit_array_set(bs-&gt;used_blobids, page_idx);<br>	bs_claim_md_page(bs, page_idx);<br>	spdk_spin_unlock(&amp;bs-&gt;used_lock);<br>	<span class="hljs-comment">// 计算索引对应id</span><br>	id = bs_page_to_blobid(page_idx);<br><br>	SPDK_DEBUGLOG(blob, <span class="hljs-string">&quot;Creating blob with id 0x%&quot;</span> PRIx64 <span class="hljs-string">&quot; at page %u\n&quot;</span>, id, page_idx);<br><br><span class="hljs-comment">// 输出</span><br>blobstore.c:<span class="hljs-number">5989</span>:bs_create_blob: *DEBUG*: Creating blob with id <span class="hljs-number">0x100000000</span> at page <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 涉及的成员变量（两个bitmap）</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_store</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bit_array</span>		*<span class="hljs-title">used_md_pages</span>;</span>		<span class="hljs-comment">/* Protected by used_lock */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bit_array</span>		*<span class="hljs-title">used_blobids</span>;</span><br>&#125;<br><br><span class="hljs-comment">// used_md_pages的大小</span><br>	<span class="hljs-keyword">if</span> (opts.num_md_pages == SPDK_BLOB_OPTS_NUM_MD_PAGES) &#123;<br>		<span class="hljs-comment">/* By default, allocate 1 page per cluster.</span><br><span class="hljs-comment">		 * Technically, this over-allocates metadata</span><br><span class="hljs-comment">		 * because more metadata will reduce the number</span><br><span class="hljs-comment">		 * of usable clusters. This can be addressed with</span><br><span class="hljs-comment">		 * more complex math in the future.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">// 一个cluster一个元数据页</span><br>		bs-&gt;md_len = bs-&gt;total_clusters;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		bs-&gt;md_len = opts.num_md_pages;<br>	&#125;<br>	rc = spdk_bit_array_resize(&amp;bs-&gt;used_md_pages, bs-&gt;md_len);<br>	rc = spdk_bit_array_resize(&amp;bs-&gt;used_blobids, bs-&gt;md_len);<br></code></pre></td></tr></table></figure><p><strong>页索引与blob id的匹配</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 元数据页索引&amp; (1&lt;&lt;32)即为对应blob id，之所以这样操作是为了避免程序将元数据索引与blob id混用</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">bs_blobid_to_page</span><span class="hljs-params">(spdk_blob_id id)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> id &amp; <span class="hljs-number">0xFFFFFFFF</span>;<br>&#125;<br><br><span class="hljs-comment">/* The blob id is a 64 bit number. The lower 32 bits are the page_idx. The upper</span><br><span class="hljs-comment"> * 32 bits are not currently used. Stick a 1 there just to catch bugs where the</span><br><span class="hljs-comment"> * code assumes blob id == page_idx.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> spdk_blob_id<br><span class="hljs-title function_">bs_page_to_blobid</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> page_idx)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (page_idx &gt; UINT32_MAX) &#123;<br>		<span class="hljs-keyword">return</span> SPDK_BLOBID_INVALID;<br>	&#125;<br>	<span class="hljs-keyword">return</span> SPDK_BLOB_BLOBID_HIGH_BIT | page_idx;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>由blob id找到对应blob</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">spdk_bs_open_blob(hello_context-&gt;bs, hello_context-&gt;blobid, open_complete, hello_context);<br>	bs_open_blob(bs, blobid, <span class="hljs-literal">NULL</span>, cb_fn, cb_arg);<br><span class="hljs-comment">// 相关代码</span><br>	<span class="hljs-comment">// 预先检查blob id是否为之前分配的合法id</span><br>	page_num = bs_blobid_to_page(blobid);<br>	<span class="hljs-keyword">if</span> (spdk_bit_array_get(bs-&gt;used_blobids, page_num) == <span class="hljs-literal">false</span>) &#123;<br>		<span class="hljs-comment">/* Invalid blobid */</span><br>		cb_fn(cb_arg, <span class="hljs-literal">NULL</span>, -ENOENT);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-comment">// 该blob是否已打开</span><br>	blob = blob_lookup(bs, blobid);<br>	<span class="hljs-keyword">if</span> (blob) &#123; <span class="hljs-comment">// blob已存在，增加引用计数并返回</span><br>		blob-&gt;open_ref++;<br>		cb_fn(cb_arg, blob, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-comment">// 申请blob空间</span><br>	blob = blob_alloc(bs, blobid);<br>	<span class="hljs-comment">// 从磁盘读取数据填充blob,略过</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 相关成员变量</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_store</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bit_array</span>		*<span class="hljs-title">open_blobids</span>;</span>  <br>    RB_HEAD(spdk_blob_tree, spdk_blob) open_blobs;  <span class="hljs-comment">// 红黑树</span><br>&#125;;<br><span class="hljs-comment">// 初始化</span><br>rc = spdk_bit_array_resize(&amp;bs-&gt;open_blobids, bs-&gt;md_len);<br>RB_INIT(&amp;bs-&gt;open_blobs);<br><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> spdk_blob *<br><span class="hljs-title function_">blob_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs, spdk_blob_id blobid)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span> <span class="hljs-title">find</span>;</span><br>	<span class="hljs-comment">// 在open_blobids位图中查找特定id，0表示不存在</span><br>	<span class="hljs-keyword">if</span> (spdk_bit_array_get(bs-&gt;open_blobids, blobid) == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br>	<span class="hljs-comment">// 从红黑树中查找对应blob并返回</span><br>	find.id = blobid;<br>	<span class="hljs-keyword">return</span> RB_FIND(spdk_blob_tree, &amp;bs-&gt;open_blobs, &amp;find);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> spdk_blob *<br><span class="hljs-title function_">blob_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs, spdk_blob_id id)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span> *<span class="hljs-title">blob</span>;</span><br><br>	blob = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*blob));<br><br>	blob-&gt;id = id;<br>	blob-&gt;bs = bs;<br><br>	blob-&gt;parent_id = SPDK_BLOBID_INVALID;<br><br>	blob-&gt;state = SPDK_BLOB_STATE_DIRTY;<br>	blob-&gt;extent_rle_found = <span class="hljs-literal">false</span>;<br>	blob-&gt;extent_table_found = <span class="hljs-literal">false</span>;<br>	blob-&gt;active.num_pages = <span class="hljs-number">1</span>;<br>	blob-&gt;active.pages = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*blob-&gt;active.pages));<br><br>	blob-&gt;active.pages[<span class="hljs-number">0</span>] = bs_blobid_to_page(id);<br><br>	TAILQ_INIT(&amp;blob-&gt;xattrs);<br>	TAILQ_INIT(&amp;blob-&gt;xattrs_internal);<br>	TAILQ_INIT(&amp;blob-&gt;pending_persists);<br>	TAILQ_INIT(&amp;blob-&gt;persists_to_complete);<br><br>	<span class="hljs-keyword">return</span> blob;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 磁盘读取相关函数</span><br>bs_sequence_read_dev(seq, &amp;ctx-&gt;pages[<span class="hljs-number">0</span>], lba, bs_byte_to_lba(bs, SPDK_BS_PAGE_SIZE), blob_load_cpl, ctx);  <span class="hljs-comment">// 不用研究读取过程，直接当读取已完成，数据已在ctx-&gt;pages[0]中，阅读回调函数实现即可</span><br><br><span class="hljs-comment">// LBA计算方式</span><br>page_num = bs_blobid_to_page(blob-&gt;id);<br>lba = bs_md_page_to_lba(blob-&gt;bs, page_num);<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">bs_md_page_to_lba</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs, <span class="hljs-type">uint32_t</span> page)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> bs_page_to_lba(bs, page + bs-&gt;md_start);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">bs_page_to_lba</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs, <span class="hljs-type">uint64_t</span> page)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> page * SPDK_BS_PAGE_SIZE / bs-&gt;dev-&gt;blocklen;<br>&#125;<br><span class="hljs-comment">// 读回调函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">blob_load_cpl</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> bserrno)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_load_ctx</span>	*<span class="hljs-title">ctx</span> =</span> cb_arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span>		*<span class="hljs-title">blob</span> =</span> ctx-&gt;blob;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_md_page</span>	*<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">int</span>				rc;<br>	<span class="hljs-type">uint32_t</span>			crc;<br>	<span class="hljs-type">uint32_t</span>			current_page;<br><br>	<span class="hljs-keyword">if</span> (ctx-&gt;num_pages == <span class="hljs-number">1</span>) &#123;<br>		current_page = bs_blobid_to_page(blob-&gt;id);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		assert(ctx-&gt;num_pages != <span class="hljs-number">0</span>);<br>		page = &amp;ctx-&gt;pages[ctx-&gt;num_pages - <span class="hljs-number">2</span>];<br>		current_page = page-&gt;next;<br>	&#125;<br><br>	<span class="hljs-comment">/* Parse the pages */</span><br>	rc = blob_parse(ctx-&gt;pages, ctx-&gt;num_pages, blob);<br><br>	<span class="hljs-keyword">if</span> (blob-&gt;extent_table_found == <span class="hljs-literal">true</span>) &#123;<br>		<span class="hljs-comment">/* If EXTENT_TABLE was found, that means support for it should be enabled. */</span><br>		assert(blob-&gt;extent_rle_found == <span class="hljs-literal">false</span>);<br>		blob-&gt;use_extent_table = <span class="hljs-literal">true</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* If EXTENT_RLE or no extent_* descriptor was found disable support</span><br><span class="hljs-comment">		 * for extent table. No extent_* descriptors means that blob has length of 0</span><br><span class="hljs-comment">		 * and no extent_rle descriptors were persisted for it.</span><br><span class="hljs-comment">		 * EXTENT_TABLE if used, is always present in metadata regardless of length. */</span><br>		blob-&gt;use_extent_table = <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* Check the clear_method stored in metadata vs what may have been passed</span><br><span class="hljs-comment">	 * via spdk_bs_open_blob_ext() and update accordingly.</span><br><span class="hljs-comment">	 */</span><br>	blob_update_clear_method(blob);<br><br>	spdk_free(ctx-&gt;pages);<br>	ctx-&gt;pages = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (blob-&gt;extent_table_found) &#123;<br>		blob_load_cpl_extents_cpl(seq, ctx, <span class="hljs-number">0</span>);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		blob_load_backing_dev(seq, ctx);<br>	&#125;<br>&#125;<br><br>blob_load(seq, blob, bs_open_blob_cpl, blob);	<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_open_blob_cpl</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> bserrno)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span> *<span class="hljs-title">blob</span> =</span> cb_arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span> *<span class="hljs-title">existing</span>;</span><br><br>	existing = blob_lookup(blob-&gt;bs, blob-&gt;id);<br>	<span class="hljs-keyword">if</span> (existing) &#123;<br>		blob_free(blob);<br>		existing-&gt;open_ref++;<br>		seq-&gt;cpl.u.blob_handle.blob = existing;<br>		bs_sequence_finish(seq, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	blob-&gt;open_ref++;<br>	<span class="hljs-comment">// 更新open_blobids与open_blobs变量</span><br>	spdk_bit_array_set(blob-&gt;bs-&gt;open_blobids, blob-&gt;id);<br>	RB_INSERT(spdk_blob_tree, &amp;blob-&gt;bs-&gt;open_blobs, blob);<br><br>	bs_sequence_finish(seq, bserrno);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="元数据相关"><a href="#元数据相关" class="headerlink" title="元数据相关"></a>元数据相关</h3><p><strong>元数据线程</strong></p><p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311021134223.png" srcset="/img/loading.gif" lazyload alt="image-20231102113424114"></p><p><img src="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202311021133642.png" srcset="/img/loading.gif" lazyload></p><p>简而言之，blob层采用了独立的元数据线程来处理元数据相关请求避免加锁</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_store</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_thread</span>		*<span class="hljs-title">md_thread</span>;</span><br>&#125;;<br><br><span class="hljs-comment">// 初始化</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_bs_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bs_dev *dev, <span class="hljs-keyword">struct</span> spdk_bs_opts *o,</span><br><span class="hljs-params">	     spdk_bs_op_with_handle_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>    rc = bs_alloc(dev, &amp;opts, &amp;bs, &amp;ctx);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bs_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bs_dev *dev, <span class="hljs-keyword">struct</span> spdk_bs_opts *opts, <span class="hljs-keyword">struct</span> spdk_blob_store **_bs,</span><br><span class="hljs-params">	 <span class="hljs-keyword">struct</span> spdk_bs_load_ctx **_ctx)</span><br>&#123;<br>    bs-&gt;md_thread = spdk_get_thread();<br>&#125;<br><br><span class="hljs-comment">// 元数据线程判断</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_create_blob</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs,</span><br><span class="hljs-params">	       <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_blob_opts *opts,</span><br><span class="hljs-params">	       <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_blob_xattr_opts *internal_xattrs,</span><br><span class="hljs-params">	       spdk_blob_op_with_id_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>    assert(spdk_get_thread() == bs-&gt;md_thread);<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_bs_delete_blob</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs, spdk_blob_id blobid,</span><br><span class="hljs-params">		    spdk_blob_op_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	assert(spdk_get_thread() == bs-&gt;md_thread);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_open_blob</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob_store *bs,</span><br><span class="hljs-params">	     spdk_blob_id blobid,</span><br><span class="hljs-params">	     <span class="hljs-keyword">struct</span> spdk_blob_open_opts *opts,</span><br><span class="hljs-params">	     spdk_blob_op_with_handle_complete cb_fn,</span><br><span class="hljs-params">	     <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	assert(spdk_get_thread() == bs-&gt;md_thread);<br>&#125;<br><br><span class="hljs-comment">// 向元数据线程发送消息</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">blob_insert_cluster_on_md_thread</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_blob *blob, <span class="hljs-type">uint32_t</span> cluster_num,</span><br><span class="hljs-params">				 <span class="hljs-type">uint64_t</span> cluster, <span class="hljs-type">uint32_t</span> extent_page, <span class="hljs-keyword">struct</span> spdk_blob_md_page *page,</span><br><span class="hljs-params">				 spdk_blob_op_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_insert_cluster_ctx</span> *<span class="hljs-title">ctx</span>;</span><br><br>	ctx = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*ctx));<br>	<span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">NULL</span>) &#123;<br>		cb_fn(cb_arg, -ENOMEM);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	ctx-&gt;thread = spdk_get_thread();<br>	ctx-&gt;blob = blob;<br>	ctx-&gt;cluster_num = cluster_num;<br>	ctx-&gt;cluster = cluster;<br>	ctx-&gt;extent_page = extent_page;<br>	ctx-&gt;page = page;<br>	ctx-&gt;cb_fn = cb_fn;<br>	ctx-&gt;cb_arg = cb_arg;<br>	<span class="hljs-comment">// Send a message to the given thread. The message will be sent asynchronously - i.e. spdk_thread_send_msg will always return prior to fn being called.</span><br>	spdk_thread_send_msg(blob-&gt;bs-&gt;md_thread, blob_insert_cluster_msg, ctx);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>blob store元数据</strong></p><p>阅读元数据相关代码的入口点</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_bs_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bs_dev *dev, <span class="hljs-keyword">struct</span> spdk_bs_opts *o,</span><br><span class="hljs-params">	     spdk_bs_op_with_handle_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	<span class="hljs-comment">/* Calculate how many pages the metadata consumes at the front</span><br><span class="hljs-comment">	 * of the disk.</span><br><span class="hljs-comment">	 */</span><br><br>	<span class="hljs-comment">/* The super block uses 1 page */</span><br>	num_md_pages = <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/* The used_md_pages mask requires 1 bit per metadata page, rounded</span><br><span class="hljs-comment">	 * up to the nearest page, plus a header.</span><br><span class="hljs-comment">	 */</span><br>	ctx-&gt;super-&gt;used_page_mask_start = num_md_pages;<br>	ctx-&gt;super-&gt;used_page_mask_len = spdk_divide_round_up(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) +spdk_divide_round_up(bs-&gt;md_len, <span class="hljs-number">8</span>),SPDK_BS_PAGE_SIZE);<br>	num_md_pages += ctx-&gt;super-&gt;used_page_mask_len;<br><br>	<span class="hljs-comment">/* The used_clusters mask requires 1 bit per cluster, rounded</span><br><span class="hljs-comment">	 * up to the nearest page, plus a header.</span><br><span class="hljs-comment">	 */</span><br>	ctx-&gt;super-&gt;used_cluster_mask_start = num_md_pages;<br>	ctx-&gt;super-&gt;used_cluster_mask_len = spdk_divide_round_up(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) + spdk_divide_round_up(bs-&gt;total_clusters, <span class="hljs-number">8</span>), SPDK_BS_PAGE_SIZE);<br>	<span class="hljs-comment">/* The blobstore might be extended, then the used_cluster bitmap will need more space.</span><br><span class="hljs-comment">	 * Here we calculate the max clusters we can support according to the</span><br><span class="hljs-comment">	 * num_md_pages (bs-&gt;md_len).</span><br><span class="hljs-comment">	 */</span><br>	max_used_cluster_mask_len = spdk_divide_round_up(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) + spdk_divide_round_up(bs-&gt;md_len, <span class="hljs-number">8</span>), SPDK_BS_PAGE_SIZE);<br>	max_used_cluster_mask_len = spdk_max(max_used_cluster_mask_len, ctx-&gt;super-&gt;used_cluster_mask_len);<br>	num_md_pages += max_used_cluster_mask_len;<br><br>	<span class="hljs-comment">/* The used_blobids mask requires 1 bit per metadata page, rounded</span><br><span class="hljs-comment">	 * up to the nearest page, plus a header.</span><br><span class="hljs-comment">	 */</span><br>	ctx-&gt;super-&gt;used_blobid_mask_start = num_md_pages;<br>	ctx-&gt;super-&gt;used_blobid_mask_len = spdk_divide_round_up(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) + spdk_divide_round_up(bs-&gt;md_len, <span class="hljs-number">8</span>), SPDK_BS_PAGE_SIZE);<br>	num_md_pages += ctx-&gt;super-&gt;used_blobid_mask_len;<br><br>	<span class="hljs-comment">/* The metadata region size was chosen above */</span><br>	ctx-&gt;super-&gt;md_start = bs-&gt;md_start = num_md_pages;<br>	ctx-&gt;super-&gt;md_len = bs-&gt;md_len;<br>	num_md_pages += bs-&gt;md_len;<br><br>	num_md_lba = bs_page_to_lba(bs, num_md_pages);<br><br>	ctx-&gt;super-&gt;size = dev-&gt;blockcnt * dev-&gt;blocklen;<br><br>	ctx-&gt;super-&gt;crc = blob_md_page_calc_crc(ctx-&gt;super);<br><br>	num_md_clusters = spdk_divide_round_up(num_md_pages, bs-&gt;pages_per_cluster);<br>	<span class="hljs-comment">/* Claim all of the clusters used by the metadata */</span><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num_md_clusters; i++) &#123;<br>		spdk_bit_array_set(ctx-&gt;used_clusters, i);<br>	&#125;<br><br>	bs-&gt;num_free_clusters -= num_md_clusters;<br>	bs-&gt;total_data_clusters = bs-&gt;num_free_clusters;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出硬盘头部的元数据格式基本如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">|super block|used_page_mask|used_cluster_mask|used_blobid_mask|metadata page|data cluster|<br></code></pre></td></tr></table></figure><p><strong>super block</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_super_block</span> &#123;</span><br>	<span class="hljs-type">uint8_t</span>		signature[<span class="hljs-number">8</span>];<br>	<span class="hljs-type">uint32_t</span>	version;<br>	<span class="hljs-type">uint32_t</span>	length;<br>	<span class="hljs-type">uint32_t</span>	clean; <span class="hljs-comment">/* If there was a clean shutdown, this is 1. */</span><br>	spdk_blob_id	super_blob;<br><br>	<span class="hljs-type">uint32_t</span>	cluster_size; <span class="hljs-comment">/* In bytes */</span><br><br>	<span class="hljs-type">uint32_t</span>	used_page_mask_start; <span class="hljs-comment">/* Offset from beginning of disk, in pages */</span><br>	<span class="hljs-type">uint32_t</span>	used_page_mask_len; <span class="hljs-comment">/* Count, in pages */</span><br><br>	<span class="hljs-type">uint32_t</span>	used_cluster_mask_start; <span class="hljs-comment">/* Offset from beginning of disk, in pages */</span><br>	<span class="hljs-type">uint32_t</span>	used_cluster_mask_len; <span class="hljs-comment">/* Count, in pages */</span><br><br>	<span class="hljs-type">uint32_t</span>	md_start; <span class="hljs-comment">/* Offset from beginning of disk, in pages */</span><br>	<span class="hljs-type">uint32_t</span>	md_len; <span class="hljs-comment">/* Count, in pages */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_type</span>	<span class="hljs-title">bstype</span>;</span> <span class="hljs-comment">/* blobstore type */</span><br><br>	<span class="hljs-type">uint32_t</span>	used_blobid_mask_start; <span class="hljs-comment">/* Offset from beginning of disk, in pages */</span><br>	<span class="hljs-type">uint32_t</span>	used_blobid_mask_len; <span class="hljs-comment">/* Count, in pages */</span><br><br>	<span class="hljs-type">uint64_t</span>	size; <span class="hljs-comment">/* size of blobstore in bytes */</span><br>	<span class="hljs-type">uint32_t</span>	io_unit_size; <span class="hljs-comment">/* Size of io unit in bytes */</span><br><br>	<span class="hljs-type">uint8_t</span>		reserved[<span class="hljs-number">4000</span>];<br>	<span class="hljs-type">uint32_t</span>	crc;<br>&#125;;<br>SPDK_STATIC_ASSERT(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_super_block) == <span class="hljs-number">0x1000</span>, <span class="hljs-string">&quot;Invalid super block size&quot;</span>);<br></code></pre></td></tr></table></figure><p>成员初始化</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ctx-&gt;super-&gt;version = SPDK_BS_VERSION;<br>ctx-&gt;super-&gt;length = <span class="hljs-keyword">sizeof</span>(*ctx-&gt;super);<br>ctx-&gt;super-&gt;super_blob = bs-&gt;super_blob;<br>ctx-&gt;super-&gt;clean = <span class="hljs-number">0</span>;<br>ctx-&gt;super-&gt;cluster_size = bs-&gt;cluster_sz;<br>ctx-&gt;super-&gt;io_unit_size = bs-&gt;io_unit_size;<br>ctx-&gt;super-&gt;size = dev-&gt;blockcnt * dev-&gt;blocklen;<br>ctx-&gt;super-&gt;crc = blob_md_page_calc_crc(ctx-&gt;super);<br></code></pre></td></tr></table></figure><p><strong>mask</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">used_page_mask与used_md_pages对应<br>used_cluster_mask与used_clusters对应<br>used_blobid_mask与used_blobids对应<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c">之所以长度需加上<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) <br><span class="hljs-comment">/* The used_md_pages mask requires 1 bit per metadata page, rounded</span><br><span class="hljs-comment">	 * up to the nearest page, plus a header.</span><br><span class="hljs-comment">	 */</span><br>	ctx-&gt;super-&gt;used_page_mask_start = num_md_pages;<br>	ctx-&gt;super-&gt;used_page_mask_len = spdk_divide_round_up(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> spdk_bs_md_mask) +<br>					 spdk_divide_round_up(bs-&gt;md_len, <span class="hljs-number">8</span>),<br>					 SPDK_BS_PAGE_SIZE);<br>	num_md_pages += ctx-&gt;super-&gt;used_page_mask_len;<br><br>原因：<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_md_mask</span> &#123;</span><br>	<span class="hljs-type">uint8_t</span>		type;<br>	<span class="hljs-type">uint32_t</span>	length; <span class="hljs-comment">/* In bits */</span><br>	<span class="hljs-type">uint8_t</span>		mask[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_write_used_md</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, <span class="hljs-type">void</span> *arg, spdk_bs_sequence_cpl cb_fn)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_load_ctx</span>	*<span class="hljs-title">ctx</span> =</span> arg;<br>	<span class="hljs-type">uint64_t</span>	mask_size, lba, lba_count;<br><br>	mask_size = ctx-&gt;super-&gt;used_page_mask_len * SPDK_BS_PAGE_SIZE;<br>	ctx-&gt;mask = spdk_zmalloc(mask_size, <span class="hljs-number">0x1000</span>, <span class="hljs-literal">NULL</span>,<br>				 SPDK_ENV_SOCKET_ID_ANY, SPDK_MALLOC_DMA);<br><br>	ctx-&gt;mask-&gt;type = SPDK_MD_MASK_TYPE_USED_PAGES;<br>	ctx-&gt;mask-&gt;length = ctx-&gt;super-&gt;md_len;<br>	assert(ctx-&gt;mask-&gt;length == spdk_bit_array_capacity(ctx-&gt;bs-&gt;used_md_pages));<br>    <span class="hljs-comment">// 将used_md_pages位图数据写入mask数组</span><br>	spdk_bit_array_store_mask(ctx-&gt;bs-&gt;used_md_pages, ctx-&gt;mask-&gt;mask);<br>	lba = bs_page_to_lba(ctx-&gt;bs, ctx-&gt;super-&gt;used_page_mask_start);<br>	lba_count = bs_page_to_lba(ctx-&gt;bs, ctx-&gt;super-&gt;used_page_mask_len);<br>	bs_sequence_write_dev(seq, ctx-&gt;mask, lba, lba_count, cb_fn, arg);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>之后的元数据落盘简述</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">spdk_bs_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_bs_dev *dev, <span class="hljs-keyword">struct</span> spdk_bs_opts *o,</span><br><span class="hljs-params">	     spdk_bs_op_with_handle_complete cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	cpl.type = SPDK_BS_CPL_TYPE_BS_HANDLE;<br>	cpl.u.bs_handle.cb_fn = cb_fn;<br>	cpl.u.bs_handle.cb_arg = cb_arg;<br>	cpl.u.bs_handle.bs = bs;<br><br>	seq = bs_sequence_start_bs(bs-&gt;md_channel, &amp;cpl);<br><br>	batch = bs_sequence_to_batch(seq, bs_init_trim_cpl, ctx);<br><br>	<span class="hljs-comment">/* Clear metadata space */</span><br>	bs_batch_write_zeroes_dev(batch, <span class="hljs-number">0</span>, num_md_lba);<br><br>	lba = num_md_lba;<br>	lba_count = ctx-&gt;bs-&gt;dev-&gt;blockcnt - lba;<br>	<span class="hljs-keyword">switch</span> (opts.clear_method) &#123;<br>	<span class="hljs-keyword">case</span> BS_CLEAR_WITH_UNMAP:<br>		<span class="hljs-comment">/* Trim data clusters */</span><br>		bs_batch_unmap_dev(batch, lba, lba_count);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> BS_CLEAR_WITH_WRITE_ZEROES:<br>		<span class="hljs-comment">/* Write_zeroes to data clusters */</span><br>		bs_batch_write_zeroes_dev(batch, lba, lba_count);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> BS_CLEAR_WITH_NONE:<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	bs_batch_close(batch);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 相关结构体</span><br><span class="hljs-comment">// 同一个结构体3种别名表示3种用法</span><br><span class="hljs-comment">/* Use a sequence to submit a set of requests serially */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span> <span class="hljs-title">spdk_bs_sequence_t</span>;</span>  <span class="hljs-comment">// 串行执行</span><br><br><span class="hljs-comment">/* Use a batch to submit a set of requests in parallel */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span> <span class="hljs-title">spdk_bs_batch_t</span>;</span>  <span class="hljs-comment">// 并行执行</span><br><br><span class="hljs-comment">/* Use a user_op to queue a user operation for later execution */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span> <span class="hljs-title">spdk_bs_user_op_t</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">spdk_bs_cpl_type</span> &#123;</span><br>	SPDK_BS_CPL_TYPE_NONE,<br>	SPDK_BS_CPL_TYPE_BS_BASIC,<br>	SPDK_BS_CPL_TYPE_BS_HANDLE,<br>	SPDK_BS_CPL_TYPE_BLOB_BASIC,<br>	SPDK_BS_CPL_TYPE_BLOBID,<br>	SPDK_BS_CPL_TYPE_BLOB_HANDLE,<br>	SPDK_BS_CPL_TYPE_NESTED_SEQUENCE,<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_cpl</span> &#123;</span> <span class="hljs-comment">// 操作类型不同，需要的参数不同，回调函数也不同</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">spdk_bs_cpl_type</span> <span class="hljs-title">type</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_bs_op_complete     cb_fn;<br>			<span class="hljs-type">void</span>                    *cb_arg;<br>		&#125; bs_basic;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_bs_op_with_handle_complete cb_fn;<br>			<span class="hljs-type">void</span>                            *cb_arg;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_store</span>          *<span class="hljs-title">bs</span>;</span><br>		&#125; bs_handle;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_blob_op_complete   cb_fn;<br>			<span class="hljs-type">void</span>                    *cb_arg;<br>		&#125; blob_basic;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_blob_op_with_id_complete   cb_fn;<br>			<span class="hljs-type">void</span>                            *cb_arg;<br>			spdk_blob_id                     blobid;<br>		&#125; blobid;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_blob_op_with_handle_complete       cb_fn;<br>			<span class="hljs-type">void</span>                                    *cb_arg;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span>                        *<span class="hljs-title">blob</span>;</span><br>			<span class="hljs-type">void</span>					*esnap_ctx;<br>		&#125; blob_handle;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_bs_nested_seq_complete	cb_fn;<br>			<span class="hljs-type">void</span>				*cb_arg;<br>			<span class="hljs-type">spdk_bs_sequence_t</span>		*parent;<br>		&#125; nested_seq;<br>	&#125; u;<br>&#125;;<br><br><span class="hljs-comment">/* A generic request set. Can be a sequence, batch or a user_op. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_cpl</span>      <span class="hljs-title">cpl</span>;</span><br><br>	<span class="hljs-type">int</span>                     bserrno;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The blobstore&#x27;s channel, obtained by blobstore consumers via</span><br><span class="hljs-comment">	 * spdk_bs_alloc_io_channel(). Used for IO to the blobstore.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_channel</span>		*<span class="hljs-title">channel</span>;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The channel used by the blobstore to perform IO on back_bs_dev. Unless the blob</span><br><span class="hljs-comment">	 * is an esnap clone, back_channel == spdk_io_channel_get_ctx(set-&gt;channel).</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_io_channel</span>		*<span class="hljs-title">back_channel</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_dev_cb_args</span>	<span class="hljs-title">cb_args</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>		<span class="hljs-comment">// 用途不同，参数也不同</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			spdk_bs_sequence_cpl    cb_fn;<br>			<span class="hljs-type">void</span>                    *cb_arg;<br>		&#125; sequence;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-type">uint32_t</span>		outstanding_ops;<br>			<span class="hljs-type">uint32_t</span>		batch_closed;<br>			spdk_bs_sequence_cpl	cb_fn;<br>			<span class="hljs-type">void</span>			*cb_arg;<br>		&#125; batch;<br><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_user_op_args</span> &#123;</span><br>			<span class="hljs-type">int</span>			type;<br>			<span class="hljs-type">int</span>			iovcnt;<br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob</span>	*<span class="hljs-title">blob</span>;</span><br>			<span class="hljs-type">uint64_t</span>		offset;<br>			<span class="hljs-type">uint64_t</span>		length;<br>			spdk_blob_op_complete	cb_fn;<br>			<span class="hljs-type">void</span>			*cb_arg;<br>			<span class="hljs-type">void</span>			*payload; <span class="hljs-comment">/* cast to iov for readv/writev */</span><br>		&#125; user_op;<br>	&#125; u;<br>	<span class="hljs-comment">/* Pointer to ext_io_opts passed by the user */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_blob_ext_io_opts</span> *<span class="hljs-title">ext_io_opts</span>;</span><br>	TAILQ_ENTRY(spdk_bs_request_set) link;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 相关函数</span><br>outstanding_ops <span class="hljs-comment">// 未完成任务数</span><br>batch_closed <span class="hljs-comment">// 任务通道是否关闭</span><br><br>    <br>batch = bs_sequence_to_batch(seq, bs_init_trim_cpl, ctx);<br><span class="hljs-type">spdk_bs_batch_t</span> *<br><span class="hljs-title function_">bs_sequence_to_batch</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, spdk_bs_sequence_cpl cb_fn, <span class="hljs-type">void</span> *cb_arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span> *<span class="hljs-title">set</span> =</span> (<span class="hljs-keyword">struct</span> spdk_bs_request_set *)seq;<br><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.cb_fn = cb_fn;  <span class="hljs-comment">// 任务全部完成的回调函数</span><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.cb_arg = cb_arg;<br>	<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops = <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">set</span>-&gt;u.batch.batch_closed = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-built_in">set</span>-&gt;cb_args.cb_fn = bs_batch_completion; <span class="hljs-comment">// 每一个任务完成的回调函数</span><br><br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">set</span>;<br>&#125;<br><span class="hljs-comment">// 添加任务</span><br><span class="hljs-comment">/* Clear metadata space */</span><br>bs_batch_write_zeroes_dev(batch, <span class="hljs-number">0</span>, num_md_lba);<br><span class="hljs-type">void</span><br><span class="hljs-title function_">bs_batch_write_zeroes_dev</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_batch_t</span> *batch,</span><br><span class="hljs-params">			  <span class="hljs-type">uint64_t</span> lba, <span class="hljs-type">uint64_t</span> lba_count)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span>	*<span class="hljs-title">set</span> =</span> (<span class="hljs-keyword">struct</span> spdk_bs_request_set *)batch;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_channel</span>		*<span class="hljs-title">channel</span> =</span> <span class="hljs-built_in">set</span>-&gt;channel;<br><br>	SPDK_DEBUGLOG(blob_rw, <span class="hljs-string">&quot;Zeroing %&quot;</span> PRIu64 <span class="hljs-string">&quot; blocks at LBA %&quot;</span> PRIu64 <span class="hljs-string">&quot;\n&quot;</span>, lba_count, lba);<br><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops++;  <span class="hljs-comment">// 未完成任务数加一</span><br>	channel-&gt;dev-&gt;write_zeroes(channel-&gt;dev, channel-&gt;dev_channel, lba, lba_count,<br>				   &amp;<span class="hljs-built_in">set</span>-&gt;cb_args);<br>&#125;<br><br><span class="hljs-comment">/* Trim data clusters */</span><br>bs_batch_unmap_dev(batch, lba, lba_count);<br><span class="hljs-type">void</span><br><span class="hljs-title function_">bs_batch_unmap_dev</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_batch_t</span> *batch,</span><br><span class="hljs-params">		   <span class="hljs-type">uint64_t</span> lba, <span class="hljs-type">uint64_t</span> lba_count)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span>	*<span class="hljs-title">set</span> =</span> (<span class="hljs-keyword">struct</span> spdk_bs_request_set *)batch;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_channel</span>		*<span class="hljs-title">channel</span> =</span> <span class="hljs-built_in">set</span>-&gt;channel;<br><br>	SPDK_DEBUGLOG(blob_rw, <span class="hljs-string">&quot;Unmapping %&quot;</span> PRIu64 <span class="hljs-string">&quot; blocks at LBA %&quot;</span> PRIu64 <span class="hljs-string">&quot;\n&quot;</span>, lba_count,<br>		      lba);<br><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops++;  <span class="hljs-comment">// 未完成任务数加一</span><br>	channel-&gt;dev-&gt;unmap(channel-&gt;dev, channel-&gt;dev_channel, lba, lba_count,<br>			    &amp;<span class="hljs-built_in">set</span>-&gt;cb_args);<br>&#125;<br><br><span class="hljs-comment">// 任务添加完毕</span><br>bs_batch_close(batch);<br><span class="hljs-type">void</span><br><span class="hljs-title function_">bs_batch_close</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_batch_t</span> *batch)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span>	*<span class="hljs-title">set</span> =</span> (<span class="hljs-keyword">struct</span> spdk_bs_request_set *)batch;<br><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.batch_closed = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 任务通道关闭</span><br><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops == <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">// 此时任务全部完成</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">set</span>-&gt;u.batch.cb_fn) &#123;  <span class="hljs-comment">// 调用预先设置好的回调函数</span><br>			<span class="hljs-built_in">set</span>-&gt;cb_args.cb_fn = bs_sequence_completion;<br>			<span class="hljs-built_in">set</span>-&gt;u.batch.cb_fn((<span class="hljs-type">spdk_bs_sequence_t</span> *)<span class="hljs-built_in">set</span>, <span class="hljs-built_in">set</span>-&gt;u.batch.cb_arg, <span class="hljs-built_in">set</span>-&gt;bserrno);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			bs_request_set_complete(<span class="hljs-built_in">set</span>);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 每一个任务执行完成的回调函数</span><br><span class="hljs-comment">// 调用路径（以bs_batch_write_zeroes_dev为例）</span><br>bs_batch_write_zeroes_dev<br>    channel-&gt;dev-&gt;write_zeroes<br>		bdev_blob_write_zeroes<br>			bdev_blob_io_complete<br>    			cb_args-&gt;cb_fn	<span class="hljs-comment">// set-&gt;cb_args.cb_fn = bs_batch_completion; </span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_batch_completion</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_io_channel *_channel,</span><br><span class="hljs-params">		    <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> bserrno)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_request_set</span>	*<span class="hljs-title">set</span> =</span> cb_arg;<br><br>	<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops--; <span class="hljs-comment">// 未完成任务数减一</span><br>	<span class="hljs-keyword">if</span> (bserrno != <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">set</span>-&gt;bserrno = bserrno;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">set</span>-&gt;u.batch.outstanding_ops == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">set</span>-&gt;u.batch.batch_closed) &#123;  <span class="hljs-comment">// 任务全部完成且任务通道关闭</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">set</span>-&gt;u.batch.cb_fn) &#123;  <span class="hljs-comment">// 调用预先设置的回调函数</span><br>			<span class="hljs-built_in">set</span>-&gt;cb_args.cb_fn = bs_sequence_completion;<br>			<span class="hljs-built_in">set</span>-&gt;u.batch.cb_fn((<span class="hljs-type">spdk_bs_sequence_t</span> *)<span class="hljs-built_in">set</span>, <span class="hljs-built_in">set</span>-&gt;u.batch.cb_arg, bserrno);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			bs_request_set_complete(<span class="hljs-built_in">set</span>);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 全部任务完成回调函数</span><br>batch = bs_sequence_to_batch(seq, bs_init_trim_cpl, ctx);<br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_init_trim_cpl</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> bserrno)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_load_ctx</span> *<span class="hljs-title">ctx</span> =</span> cb_arg;<br><br>	<span class="hljs-comment">/* Write super block */</span><br>	bs_sequence_write_dev(seq, ctx-&gt;super, bs_page_to_lba(ctx-&gt;bs, <span class="hljs-number">0</span>),<br>			      bs_byte_to_lba(ctx-&gt;bs, <span class="hljs-keyword">sizeof</span>(*ctx-&gt;super)),<br>			      bs_init_persist_super_cpl, ctx);<br>&#125;<br><span class="hljs-comment">// 超级块持久化完成回调函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bs_init_persist_super_cpl</span><span class="hljs-params">(<span class="hljs-type">spdk_bs_sequence_t</span> *seq, <span class="hljs-type">void</span> *cb_arg, <span class="hljs-type">int</span> bserrno)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bs_load_ctx</span> *<span class="hljs-title">ctx</span> =</span> cb_arg;<br><br>	ctx-&gt;bs-&gt;used_clusters = spdk_bit_pool_create_from_array(ctx-&gt;used_clusters);<br>	spdk_free(ctx-&gt;super);<br>	<span class="hljs-built_in">free</span>(ctx);<br><br>	bs_sequence_finish(seq, bserrno);<br>&#125;<br><br><span class="hljs-comment">// spdk_bit_pool与spdk_bit_array</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bit_pool</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spdk_bit_array</span>	*<span class="hljs-title">array</span>;</span><br>	<span class="hljs-type">uint32_t</span>		lowest_free_bit;<br>	<span class="hljs-type">uint32_t</span>		free_count;<br>&#125;;<br><br><span class="hljs-comment">// 继续看回调函数</span><br>bs_init_persist_super_cpl<br>    bs_sequence_finish<br>    	bs_request_set_complete<br>    		bs_call_cpl<br><span class="hljs-comment">// spdk_bs_init中cpl.type = SPDK_BS_CPL_TYPE_BS_HANDLE</span><br>cpl.type = SPDK_BS_CPL_TYPE_BS_HANDLE;<br>cpl.u.bs_handle.cb_fn = cb_fn;<br>cpl.u.bs_handle.cb_arg = cb_arg;<br>cpl.u.bs_handle.bs = bs;  <br>			<span class="hljs-keyword">case</span> SPDK_BS_CPL_TYPE_BS_HANDLE:<br>		cpl-&gt;u.bs_handle.cb_fn(cpl-&gt;u.bs_handle.cb_arg, bserrno == <span class="hljs-number">0</span> ? cpl-&gt;u.bs_handle.bs : <span class="hljs-literal">NULL</span>, bserrno);<br>				bs_init_complete<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 使用gdb显示bs_init_complete调用栈</span><br>Thread <span class="hljs-number">1</span> <span class="hljs-string">&quot;reactor_0&quot;</span> hit Breakpoint <span class="hljs-number">4</span>, bs_init_complete (cb_arg=<span class="hljs-number">0xf19affa87bdd2000</span>, <br>    bs=<span class="hljs-number">0x7fffffffd5a0</span>, bserrno=<span class="hljs-number">8192</span>) at hello_blob.c:<span class="hljs-number">287</span><br><span class="hljs-number">287</span>     <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">bs_init_complete</span><span class="hljs-params">(<span class="hljs-type">void</span> *cb_arg, <span class="hljs-keyword">struct</span> spdk_blob_store *bs, <span class="hljs-type">int</span> bserrno)</span> &#123;<br>(gdb) bt<br>#<span class="hljs-number">0</span>  bs_init_complete (cb_arg=<span class="hljs-number">0xf19affa87bdd2000</span>, bs=<span class="hljs-number">0x7fffffffd5a0</span>, bserrno=<span class="hljs-number">8192</span>)<br>    at hello_blob.c:<span class="hljs-number">287</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x00005555555d6bb0</span> in <span class="hljs-title function_">bs_call_cpl</span> <span class="hljs-params">(cpl=<span class="hljs-number">0x7fffffffd5e0</span>, bserrno=<span class="hljs-number">0</span>)</span> at request.c:26<br>#2  0x00005555555d6d0d in <span class="hljs-title function_">bs_request_set_complete</span> <span class="hljs-params">(<span class="hljs-built_in">set</span>=<span class="hljs-number">0x555555d48c20</span>)</span> at request.c:63<br>#3  0x00005555555d77ec in <span class="hljs-title function_">bs_sequence_finish</span> <span class="hljs-params">(seq=<span class="hljs-number">0x555555d48c20</span>, bserrno=<span class="hljs-number">0</span>)</span> at request.c:295<br>#4  0x00005555555cd558 in <span class="hljs-title function_">bs_init_persist_super_cpl</span> <span class="hljs-params">(seq=<span class="hljs-number">0x555555d48c20</span>, cb_arg=<span class="hljs-number">0x555555ecfa20</span>, </span><br><span class="hljs-params">    bserrno=<span class="hljs-number">0</span>)</span> at blobstore.c:5217<br>#5  0x00005555555d6d5e in <span class="hljs-title function_">bs_sequence_completion</span> <span class="hljs-params">(channel=<span class="hljs-number">0x555555cd4480</span>, </span><br><span class="hljs-params">    cb_arg=<span class="hljs-number">0x555555d48c20</span>, bserrno=<span class="hljs-number">0</span>)</span> at request.c:72<br>#6  0x00005555555b3b8e in <span class="hljs-title function_">bdev_blob_io_complete</span> <span class="hljs-params">(bdev_io=<span class="hljs-number">0x200013aa2700</span>, success=<span class="hljs-literal">true</span>, </span><br><span class="hljs-params">    arg=<span class="hljs-number">0x555555d48c60</span>)</span> at blob_bdev.c:64<br>#7  0x000055555568e23c in _<span class="hljs-title function_">bdev_io_complete</span> <span class="hljs-params">(ctx=<span class="hljs-number">0x200013aa2700</span>)</span> at bdev.c:6970<br>#8  0x000055555568e3dc in <span class="hljs-title function_">bdev_io_complete</span> <span class="hljs-params">(ctx=<span class="hljs-number">0x200013aa2700</span>)</span> at bdev.c:7003<br>#9  0x000055555568e900 in <span class="hljs-title function_">spdk_bdev_io_complete</span> <span class="hljs-params">(bdev_io=<span class="hljs-number">0x200013aa2700</span>, </span><br><span class="hljs-params">    status=SPDK_BDEV_IO_STATUS_SUCCESS)</span> at bdev.c:7131<br>#10 0x0000555555570c6c in <span class="hljs-title function_">malloc_done</span> <span class="hljs-params">(ref=<span class="hljs-number">0x200013aa2ae0</span>, status=<span class="hljs-number">0</span>)</span> at bdev_malloc.c:130<br>#11 0x0000555555570f05 in <span class="hljs-title function_">malloc_sequence_done</span> <span class="hljs-params">(ctx=<span class="hljs-number">0x200013aa2ae0</span>, status=<span class="hljs-number">0</span>)</span><br>    at bdev_malloc.c:225<br>#12 0x000055555569df8b in <span class="hljs-title function_">accel_sequence_complete</span> <span class="hljs-params">(seq=<span class="hljs-number">0x555555e1dc40</span>)</span> at accel.c:1250<br>#13 0x000055555569f43c in <span class="hljs-title function_">accel_process_sequence</span> <span class="hljs-params">(seq=<span class="hljs-number">0x555555e1dc40</span>)</span> at accel.c:1675<br>#14 0x000055555569f749 in <span class="hljs-title function_">accel_sequence_task_cb</span> <span class="hljs-params">(cb_arg=<span class="hljs-number">0x555555e1dc40</span>, status=<span class="hljs-number">0</span>)</span><br>    at accel.c:1750<br>#15 0x000055555569b67d in <span class="hljs-title function_">spdk_accel_task_complete</span> <span class="hljs-params">(accel_task=<span class="hljs-number">0x555555d5ddb0</span>, status=<span class="hljs-number">0</span>)</span><br>    at accel.c:292<br>#16 0x00005555556a4d66 in <span class="hljs-title function_">accel_comp_poll</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555e75cc0</span>)</span> at accel_sw.c:525<br>#17 0x00005555556b6511 in <span class="hljs-title function_">thread_execute_poller</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555ce17e0</span>, poller=<span class="hljs-number">0x555555cd7b10</span>)</span><br>    at thread.c:946<br>#18 0x00005555556b6a95 in <span class="hljs-title function_">thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555ce17e0</span>, max_msgs=<span class="hljs-number">0</span>, now=<span class="hljs-number">3835790851557406</span>)</span><br>    at thread.c:1072<br>#19 0x00005555556b6d44 in <span class="hljs-title function_">spdk_thread_poll</span> <span class="hljs-params">(thread=<span class="hljs-number">0x555555ce17e0</span>, max_msgs=<span class="hljs-number">0</span>, </span><br><span class="hljs-params">    now=<span class="hljs-number">3835790851557406</span>)</span> at thread.c:1156<br>#20 0x0000555555679572 in _<span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(reactor=<span class="hljs-number">0x555555ce14c0</span>)</span> at reactor.c:914<br>#21 0x0000555555679664 in <span class="hljs-title function_">reactor_run</span> <span class="hljs-params">(arg=<span class="hljs-number">0x555555ce14c0</span>)</span> at reactor.c:952<br>#22 0x0000555555679aeb in <span class="hljs-title function_">spdk_reactors_start</span> <span class="hljs-params">()</span> at reactor.c:1068<br>#23 0x0000555555675c11 in <span class="hljs-title function_">spdk_app_start</span> <span class="hljs-params">(opts_user=<span class="hljs-number">0x7fffffffde70</span>, </span><br><span class="hljs-params">    start_fn=<span class="hljs-number">0x5555555705cc</span> &lt;hello_start&gt;, arg1=<span class="hljs-number">0x555555cce4c0</span>)</span> at app.c:827<br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-keyword">continue</span> without paging--<br>#24 0x00005555555707a7 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">2</span>, argv=<span class="hljs-number">0x7fffffffe058</span>)</span> at hello_blob.c:390<br></code></pre></td></tr></table></figure><p>blob 元数据格式</p><p>写数据流程</p><p>读数据流程</p><h1 id="SPDK接口使用方式"><a href="#SPDK接口使用方式" class="headerlink" title="SPDK接口使用方式"></a>SPDK接口使用方式</h1><p>代码来自：<a target="_blank" rel="noopener" href="https://github.com/ls4154/leveldb-direct">leveldb-direct</a>，使用spdk底层驱动接口实现leveldb env接口</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write_complete</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> spdk_nvme_cpl *completion)</span>  <span class="hljs-comment">// 写回调函数</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span>* compl_status = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>*&gt;(arg);<br>  *compl_status = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">spdk_nvme_cpl_is_error</span>(completion)) &#123;<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;spdk write cpl error\n&quot;</span>);<br>    *compl_status = <span class="hljs-number">2</span>;<br>  &#125;<br>&#125;<br><span class="hljs-comment">// 同步调用时chk_compl为nullptr，异步调用时chk_compl指向int变量compl_status_</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write_from_buf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spdk_nvme_ns *ns, <span class="hljs-keyword">struct</span> spdk_nvme_qpair *qpair,</span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">void</span> *buf, <span class="hljs-type">uint64_t</span> lba, <span class="hljs-type">uint32_t</span> cnt, <span class="hljs-type">int</span>* chk_compl)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> rc;<br><br>  <span class="hljs-keyword">if</span> (chk_compl != <span class="hljs-literal">nullptr</span>) &#123;  <span class="hljs-comment">// 异步调用，调用spdk_nvme_ns_cmd_write后不需要阻塞等待，直接返回</span><br>    rc = <span class="hljs-built_in">spdk_nvme_ns_cmd_write</span>(ns, qpair, buf, lba, cnt, write_complete, chk_compl, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (rc != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;spdk cmd wirte failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 同步调用，调用spdk_nvme_ns_cmd_write接口后轮询CQ，直到执行完成</span><br>  <span class="hljs-type">int</span> l_chk_cpl = <span class="hljs-number">0</span>;<br>  rc = <span class="hljs-built_in">spdk_nvme_ns_cmd_write</span>(ns, qpair, buf, lba, cnt, write_complete, &amp;l_chk_cpl, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (rc != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;spdk write failed\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">while</span> (!l_chk_cpl)<br>    <span class="hljs-built_in">spdk_nvme_qpair_process_completions</span>(qpair, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><p><a target="_blank" rel="noopener" href="https://ieeexplore.ieee.org/abstract/document/8241103">SPDK: A Development Kit to Build High Performance Storage Applications</a></p><p><a target="_blank" rel="noopener" href="https://www.snia.org/educational-library/spdk-nvme-depth-look-its-architecture-and-design-2018">SPDK NVMe: An In-depth Look at its Architecture and Design</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Memblaze_2011/article/details/88635993">硬核虚拟化技术 SR-IOV的原理及探索</a><br><a target="_blank" rel="noopener" href="https://aijishu.com/a/1060000000228117#item-2">DPU和CPU互联的接口之争：Virtio还是SR-IOV？</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ZVAyIVqt0UFji/article/details/119396007?spm=1001.2014.3001.5502">SPDK概览</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ZVAyIVqt0UFji/article/details/121279191?spm=1001.2014.3001.5502">SPDK bdev详解</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" class="category-chain-item">学习记录</a> </span><span class="category-chain"><a href="/categories/zns-ssd-femu-nvme-spdk-dpdk/" class="category-chain-item">zns ssd-femu-nvme-spdk-dpdk</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/spdk-bdev/" class="print-no-link">#spdk bdev</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/continue/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95.html" title="个人博客搭建记录"><span class="hidden-mobile">个人博客搭建记录</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var e=Object.assign({appId:"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz",appKey:"0e2MMh7ddBCGGytOe9UEy5NP",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://uu0wegco.lc-cn-n1-shared.com",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(e),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var e="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(e),Fluid.plugins.fancyBox(e)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>