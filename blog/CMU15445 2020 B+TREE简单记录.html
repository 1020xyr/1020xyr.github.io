<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg"><link rel="icon" href="/img/nano-1.jpg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="最佳损友1020"><meta name="keywords" content=""><meta name="description" content="lab地址CMU15445 2021博客地址 前期准备做完了2021的15445，想做一下2020的b+ tree。按照2020 c++ primer assignment步骤一样拉取仓库，安装依赖包，但拉取的代码已经是最新的2021，所以需要将commit回滚到之前的版本。用pro1做测试，回滚到有buffer_pool_manager.cpp的版本。commit：f92ef74d8fb"><meta property="og:type" content="article"><meta property="og:title" content="CMU15445 2020 B+TREE简单记录"><meta property="og:url" content="https://www.jiasun.top/blog/CMU15445%202020%20B+TREE%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95.html"><meta property="og:site_name" content="最佳损友1020’s Blog"><meta property="og:description" content="lab地址CMU15445 2021博客地址 前期准备做完了2021的15445，想做一下2020的b+ tree。按照2020 c++ primer assignment步骤一样拉取仓库，安装依赖包，但拉取的代码已经是最新的2021，所以需要将commit回滚到之前的版本。用pro1做测试，回滚到有buffer_pool_manager.cpp的版本。commit：f92ef74d8fb"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img-blog.csdnimg.cn/8f85360206b7436d8cfdce35447afb16.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/d82e36f0933d4e04a3b66f6fc73a4eb5.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/9b95deaca1bd47fe9f8d8c0a74e1034c.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/dd071380a8364727861c492256c73dbe.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/f6fed3878d7a41bd92c8fd55d3615628.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/8b59f2a738a44fb2b009b48e3b27f201.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/a586d8aa04ba4109bc0b923aadb97628.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/e936a7cec0344a91b9da5e56e8bd7afa.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/4b62811a533c41f3ace5153c46c7bd38.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/f6c30f8f4978476e811937a64fb43572.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/b1ab2f5f0f76413097bdcd73243b0893.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/65999fd72bb34c5ba79156d529e9a4d5.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/d6277389cf9d4074a042776893848295.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/8ed9f7c64a8d428c89a646f00c81a3c3.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/bd2bc2b811aa48958ac9bf8c49500d60.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/b8764f04017b476494d5f51443a89448.png"><meta property="article:published_time" content="2022-08-31T08:31:46.000Z"><meta property="article:modified_time" content="2023-10-31T14:45:58.755Z"><meta property="article:author" content="最佳损友1020"><meta property="article:tag" content="15445 B+树"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://img-blog.csdnimg.cn/8f85360206b7436d8cfdce35447afb16.png"><title>CMU15445 2020 B+TREE简单记录 - 最佳损友1020’s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/csdn.css"><link rel="stylesheet" href="/css/top.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.jiasun.top",root:"/",version:"1.9.5-a",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:4},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz",app_key:"ljkRZDiTtVmjn5mpaQmpFqgv",server_url:"https://n227fxnj.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>最佳损友1020</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/bg.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="CMU15445 2020 B+TREE简单记录"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-08-31 16:31" pubdate>2022年8月31日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 22k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 187 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">CMU15445 2020 B+TREE简单记录</h1><div class="markdown-body"><meta name="referrer" content="no-referrer"><p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2020/project2/">lab地址</a><br><a href="https://www.jiasun.top/blog/CMU15445%202021.html">CMU15445 2021博客地址</a></p><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>做完了2021的15445，想做一下2020的b+ tree。按照2020 c++ primer assignment步骤一样拉取仓库，安装依赖包，但拉取的代码已经是最新的2021，所以需要将commit回滚到之前的版本。用pro1做测试，回滚到有buffer_pool_manager.cpp的版本。<br><img src="https://img-blog.csdnimg.cn/8f85360206b7436d8cfdce35447afb16.png" srcset="/img/loading.gif" lazyload><br>commit：f92ef74d8fb0d20d2038495b83b3ad0535b25f2c<br>图中为vscode插件git graph<br>回滚完之后cmake报以下错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">fatal: invalid reference: master<br>CMake Error at googletest-download/googletest-prefix/tmp/googletest-gitclone.cmake:40 (message):<br>  Failed to checkout tag: <span class="hljs-string">&#x27;master&#x27;</span><br></code></pre></td></tr></table></figure><p>将 build_support中gtest_CMakeLists.txt.in的master改成main<br><img src="https://img-blog.csdnimg.cn/d82e36f0933d4e04a3b66f6fc73a4eb5.png" srcset="/img/loading.gif" lazyload><br>完整的流程为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">git init 空文件夹中初始化仓库<br>git remote add public https://github.com/cmu-db/bustub.git<br>git fetch public<br>git merge public/master<br>git reset --hard f92ef74d8fb0d20d2038495b83b3ad0535b25f2c<br>sudo ./build_support/packages.sh<br><span class="hljs-built_in">mkdir</span> build<br><span class="hljs-built_in">cd</span> build<br>修改gtest_CMakeLists.txt.in<br>cmake ..<br>make<br></code></pre></td></tr></table></figure><p>2020 buffer pool只需实现lru replacement policy和buffer pool manager，涉及的文件有：</p><blockquote><p>src&#x2F;include&#x2F;buffer&#x2F;lru_replacer.h<br>src&#x2F;buffer&#x2F;lru_replacer.cpp<br>src&#x2F;include&#x2F;buffer&#x2F;buffer_pool_manager.h<br>src&#x2F;buffer&#x2F;buffer_pool_manager.cpp</p></blockquote><p>而2021需实现 lru replacement policy，buffer pool manager instance，parallel buffer pool manager，涉及的文件有：</p><blockquote><p>src&#x2F;include&#x2F;buffer&#x2F;lru_replacer.h<br>src&#x2F;buffer&#x2F;lru_replacer.cpp<br>src&#x2F;include&#x2F;buffer&#x2F;buffer_pool_manager_instance.h<br>src&#x2F;buffer&#x2F;buffer_pool_manager_instance.cpp<br>src&#x2F;include&#x2F;buffer&#x2F;parallel_buffer_pool_manager.h<br>src&#x2F;buffer&#x2F;parallel_buffer_pool_manager.cpp</p></blockquote><p>复制粘贴2021代码，简单修改AllocatePage DeallocatePage使用方式就可以通过本地测试了。<br>通过课程代码：5VX7JZ添加2020的课程进行在线测试<br><img src="https://img-blog.csdnimg.cn/9b95deaca1bd47fe9f8d8c0a74e1034c.png" srcset="/img/loading.gif" lazyload></p><blockquote><p>All of the source code for the projects are available on Github. There is a Gradescope submission site available to non-CMU students (Entry Code: 5VX7JZ). We will make the auto-grader for each assignment available to non-CMU students on Gradescope after their due date for CMU students. In exchange for making this available to the public, we ask that you do not make your project implementations public on Github or other source code repositories.</p></blockquote><p>参考：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mlmz/p/15906948.html">CMU15445 lab0 C++ PRIMER</a><br><a target="_blank" rel="noopener" href="https://github.com/google/highway/issues/457">googletest pull fails</a><br><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/fall2020/faq.html">FAQ</a></p><h2 id="check-point1简单记录"><a href="#check-point1简单记录" class="headerlink" title="check point1简单记录"></a>check point1简单记录</h2><p><img src="https://img-blog.csdnimg.cn/dd071380a8364727861c492256c73dbe.png" srcset="/img/loading.gif" lazyload></p><p>因为听说这个实验很难，所以先在b站看完</p><ul><li>Lecture #07: Trees Indexes I</li><li>Lecture #08: Trees Indexes II</li><li>Lecture #09: Index Concurrency Control</li></ul><p>然后对照着schedule中note系统学一下b+ tree，实际上这也是我第一次看15445的课。<br>刚开始的时候不急着实现各个page类的方法，先实现b_plus_tree类的方法，这样就能知道各个page中的方法的作用了，然后再一一实现，实际上通过各类中的API就能看出各个操作的大致流程了。<br>在模板方法中使用auto自动推导类型的变量，在vscode就不能自动补全，非常不方便，所以尽量用明确的类型了。<br>在check point1中也不知道啥时候可以unpin，故直接记录所有new或者fetch的页，操作结束前全部释放。（错误的方法）</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BPlusTree</span> &#123;<br>	std::vector&lt;<span class="hljs-type">page_id_t</span>&gt; dirty_id_;<br>&#125;<br><br><br><br><span class="hljs-comment">//在各个Create/Fetch api中记录访问的page id</span><br><span class="hljs-comment">// helper function</span><br><span class="hljs-function">InternalPage *<span class="hljs-title">CreateInternalPage</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> *page_id, <span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;parent_id)</span></span>;<br><br><span class="hljs-function">InternalPage *<span class="hljs-title">FetchInternalPage</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;page_id)</span></span>;<br><br><span class="hljs-function">LeafPage *<span class="hljs-title">CreateLeafPage</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> *page_id, <span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;parent_id)</span></span>;<br><br><span class="hljs-function">LeafPage *<span class="hljs-title">FetchLeafPage</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;page_id)</span></span>;<br><br><span class="hljs-function">BPlusTreePage *<span class="hljs-title">FetchTreePage</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;page_id)</span></span>;<br><br><span class="hljs-function">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BPLUSTREE_TYPE::ReleaseAllPage</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">page_id_t</span> id : dirty_id_) &#123;<br>    buffer_pool_manager_-&gt;<span class="hljs-built_in">UnpinPage</span>(id, <span class="hljs-literal">true</span>);<br>  &#125;<br>  dirty_id_.<span class="hljs-built_in">clear</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>check point2应该是需要改这个的，但现在无所谓，先实现基本的代码逻辑再考虑优化的问题。<br>不知道为什么，提交到gradescope显示以下错误，就直接使用本地的grading_b_plus_tree_checkpoint_1_test.cpp进行测试了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">/autograder/bustub/test/storage/b_plus_tree_insert_test.cpp:127:64: error: no member named <span class="hljs-string">&#x27;end&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;bustub::BPlusTree&lt;bustub::GenericKey&lt;8&gt;, bustub::RID, bustub::GenericComparator&lt;8&gt; &gt;&#x27;</span>; did you mean <span class="hljs-string">&#x27;End&#x27;</span>? [clang-diagnostic-error]<br>  <span class="hljs-keyword">for</span> (auto iterator = tree.Begin(index_key); iterator != tree.end(); ++iterator) &#123;<br>                                                               ^~~<br>                                                               End<br>/autograder/bustub/src/include/storage/index/b_plus_tree.h:67:22: note: <span class="hljs-string">&#x27;End&#x27;</span> declared here<br>  INDEXITERATOR_TYPE End();<br>                     ^<br><br> Checking: /autograder/bustub/test/storage/grading_b_plus_tree_checkpoint_1_test.cpp<br> Checking: /autograder/bustub/test/storage/grading_b_plus_tree_checkpoint_2_sequential_test.cpp<br> Checking: /autograder/bustub/test/storage/grading_b_plus_tree_memory_test.cpp<br> Checking: /autograder/bustub/test/storage/tmp_tuple_page_test.cpp<br> Checking: /autograder/bustub/test/type/type_test.cpp<br>/autograder/bustub/test/storage/grading_b_plus_tree_checkpoint_2_sequential_test.cpp:60:18: error: invalid range expression of <span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;bustub::BPlusTree&lt;bustub::GenericKey&lt;8&gt;, bustub::RID, bustub::GenericComparator&lt;8&gt; &gt;&#x27;</span>; no viable <span class="hljs-string">&#x27;begin&#x27;</span> <span class="hljs-keyword">function</span> available [clang-diagnostic-error]<br>  <span class="hljs-keyword">for</span> (auto pair : tree) &#123;<br><br>/autograder/bustub/test/storage/grading_b_plus_tree_checkpoint_2_sequential_test.cpp:135:57: error: no member named <span class="hljs-string">&#x27;isEnd&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;bustub::IndexIterator&lt;bustub::GenericKey&lt;8&gt;, bustub::RID, bustub::GenericComparator&lt;8&gt; &gt;&#x27;</span>; did you mean <span class="hljs-string">&#x27;IsEnd&#x27;</span>? [clang-diagnostic-error]<br>  <span class="hljs-keyword">for</span> (auto iterator = tree.Begin(index_key); !iterator.isEnd(); ++iterator) &#123;<br>                                                        ^~~~~<br>                                                        IsEnd<br>/autograder/bustub/src/include/storage/index/index_iterator.h:31:8: note: <span class="hljs-string">&#x27;IsEnd&#x27;</span> declared here<br>  bool IsEnd();<br><br>/autograder/bustub/build/googletest-src/googletest/include/gtest/gtest.h:1358:11: error: The left operand of <span class="hljs-string">&#x27;==&#x27;</span> is a garbage value [clang-analyzer-core.UndefinedBinaryOperatorResult,-warnings-as-errors]<br>  <span class="hljs-keyword">if</span> (lhs == rhs) &#123;<br></code></pre></td></tr></table></figure><p><strong>解决</strong>：后面发现只需要把begin end isEnd Begin End IsEnd方法全部定义一下就可以了，<strong>不需要考虑语法风格检查问题。</strong> The left operand of ‘&#x3D;&#x3D;’ is a garbage value问题可以通过将src&#x2F;include&#x2F;storage&#x2F;page&#x2F;tmp_tuple_page.h 加入压缩包解决，不过需要注意的是，tmp_tuple_page.h有可能需要修改<br><img src="https://img-blog.csdnimg.cn/f6fed3878d7a41bd92c8fd55d3615628.png" srcset="/img/loading.gif" lazyload></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// tmp_tuple_page.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;storage/page/page.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;storage/table/tmp_tuple.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;storage/table/tuple.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> bustub &#123;<br><br><span class="hljs-comment">// To pass the test cases for this class, you must follow the existing TmpTuplePage format and implement the</span><br><span class="hljs-comment">// existing functions exactly as they are! It may be helpful to look at TablePage.</span><br><span class="hljs-comment">// Remember that this task is optional, you get full credit if you finish the next task.</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TmpTuplePage format:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Sizes are in bytes.</span><br><span class="hljs-comment"> * | PageId (4) | LSN (4) | FreeSpace (4) | (free space) | TupleSize2 | TupleData2 | TupleSize1 | TupleData1 |</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We choose this format because DeserializeExpression expects to read Size followed by Data.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TmpTuplePage</span> : <span class="hljs-keyword">public</span> Page &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> page_id, <span class="hljs-type">uint32_t</span> page_size)</span> </span>&#123;<br>    <span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">GetData</span>(), &amp;page_id, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">page_id_t</span>));<br>    <span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">GetData</span>() + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">page_id_t</span>), &amp;page_size, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">GetTablePageId</span><span class="hljs-params">()</span> -&gt; <span class="hljs-type">page_id_t</span> </span>&#123; <span class="hljs-keyword">return</span> INVALID_PAGE_ID; &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Insert</span><span class="hljs-params">(<span class="hljs-type">const</span> Tuple &amp;tuple, TmpTuple *out)</span> -&gt; <span class="hljs-type">bool</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; &#125;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">page_id_t</span>) == <span class="hljs-number">4</span>);<br>&#125;;<br><br>&#125;  <span class="hljs-comment">// namespace bustub</span><br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># proj2.sh</span><br> zip project2-submission.zip \<br>    src/include/buffer/lru_replacer.h \<br>    src/buffer/lru_replacer.cpp \<br>    src/include/buffer/buffer_pool_manager.h \<br>    src/buffer/buffer_pool_manager.cpp \<br>    src/include/storage/page/b_plus_tree_page.h \<br>    src/storage/page/b_plus_tree_page.cpp \<br>    src/include/storage/page/b_plus_tree_internal_page.h \<br>    src/storage/page/b_plus_tree_internal_page.cpp \<br>    src/include/storage/page/b_plus_tree_leaf_page.h \<br>    src/storage/page/b_plus_tree_leaf_page.cpp \<br>    src/include/storage/index/b_plus_tree.h \<br>    src/storage/index/b_plus_tree.cpp \<br>    src/include/storage/index/index_iterator.h \<br>    src/storage/index/index_iterator.cpp \<br>    src/include/storage/page/tmp_tuple_page.h <br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/8b59f2a738a44fb2b009b48e3b27f201.png" srcset="/img/loading.gif" lazyload></p><p>实现的时候对照着可视化网站写比较容易想出相应的代码步骤<a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">B+ Tree Visualization (usfca.edu)</a>，我觉得挺巧妙的一点就是：内部节点第一个key不用，在分裂的时候移动一半的kv到新节点，正好这个key可以插入到父节点。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">InternalPage *new_inner = <span class="hljs-built_in">Split</span>(parent_page);<br>KeyType comp = new_inner-&gt;<span class="hljs-built_in">KeyAt</span>(<span class="hljs-number">0</span>);<br><span class="hljs-built_in">InsertIntoParent</span>(parent_page, comp, new_inner, transaction);<br></code></pre></td></tr></table></figure><p><strong>遇到的问题：</strong><br>一 git下载gtest总是会出现各种问题，可能的解决方法有</p><ol><li>关闭电脑代理，重置git代理<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global --<span class="hljs-built_in">unset</span> http.proxy <br>git config --global --<span class="hljs-built_in">unset</span> https.proxy<br></code></pre></td></tr></table></figure></li><li>修改hosts文件，添加github与ip地址映射</li><li>重启网络或主机</li></ol><p>相关链接：<a target="_blank" rel="noopener" href="https://github.com/521xueweihan/GitHub520">https://github.com/521xueweihan/GitHub520</a><br>二 定义辅助方法创建新的叶子节点</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">INDEX_TEMPLATE_ARGUMENTS<br>BPlusTree&lt;KeyType, ValueType, KeyComparator&gt;::<span class="hljs-function">LeafPage *<span class="hljs-title">BPLUSTREE_TYPE::CreateLeafPage</span><span class="hljs-params">(<span class="hljs-type">page_id_t</span> *page_id, <span class="hljs-type">const</span> <span class="hljs-type">page_id_t</span> &amp;parent_id)</span> </span>&#123;<br>  Page *page = buffer_pool_manager_-&gt;<span class="hljs-built_in">NewPage</span>(page_id);<br>  <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Exception</span>(ExceptionType::OUT_OF_MEMORY, <span class="hljs-string">&quot;out memory when create leaf page&quot;</span>);<br>  &#125;<br>  LeafPage *leaf_page = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br>  leaf_page-&gt;<span class="hljs-built_in">Init</span>(*page_id, parent_id, leaf_max_size_);<br>  <span class="hljs-keyword">return</span> leaf_page;<br>&#125;<br></code></pre></td></tr></table></figure><p>报错need ‘typename’ before because is a dependent scope<br>原因在于编译器无法识别BPlusTree&lt;KeyType, ValueType, KeyComparator&gt;::LeafPage这个名称是一个成员变量还是一个类型.<br>故定义宏当做函数返回类型</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTERNAL_PAGE_TYPE typename BPlusTree<span class="hljs-string">&lt;KeyType, ValueType, KeyComparator&gt;</span>::InternalPage</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAF_PAGE_TYPE typename BPlusTree<span class="hljs-string">&lt;KeyType, ValueType, KeyComparator&gt;</span>::LeafPage</span><br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pb1995/article/details/49532285">编译错误need ‘typename’ before *** because *** is a dependent scope 浅析</a></p><p>三 在CopyNFrom函数中，我想直接调用memcpy函数进行拷贝，但报以下错误：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">CopyNFrom</span><br><span class="hljs-function"><span class="hljs-title">memcpy</span><span class="hljs-params">(&amp;array_, items, size * <span class="hljs-keyword">sizeof</span>(MappingType))</span></span>;<br>error: undefined behavior, source object type <span class="hljs-string">&#x27;std::pair&lt;GenericKey&lt;32&gt;, int&gt;&#x27;</span> is <span class="hljs-keyword">not</span> TriviallyCopyable [bugprone-undefined-memory-manipulation,-warnings-as-errors]<br></code></pre></td></tr></table></figure><p>也就是说std::pair&lt;GenericKey&lt;32&gt;, int&gt;类型不是拷贝不变（trivially copyable）类型，对该类型数据拷贝结果未定义<br>对于未定义行为这篇博客<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/391088391">浅谈 C++ Undefined Behavior</a>讲的很好。</p><blockquote><p>undefined behavior 是那些标准没有明确规定、不要求每个 C++ implementation 在其文档中明确规定、且标准也没有对具体的 behavior 施加任何限制的行为。从 abstract machine 的角度考虑，undefined behavior 与 unspecified behavior 也类似，它规定了 abstract machine 的非确定性状态转移：abstract machine 从一个初始的状态开始，执行一个包含 undefined behavior 的程序，abstract machine 的最终状态可能是任何一个状态。标准没有对 abstract machine 的最终状态施加任何限制。经典的 undefined behavior 包括：数组索引越界、null pointer &#x2F; dangling pointer 解引用、有符号整数上下溢等。</p></blockquote><blockquote><p>综上所述，规定 undefined behavior 的原因归根结底就是现实世界太复杂了。Undefined behavior 是极度简洁的语言设计和极其复杂的真实世界之间的不可调和的矛盾的产物。</p></blockquote><p>四：默认参数问题<br>BPlusTree类的构造函数中叶节点和内部节点都使用了宏，但内部节点的MappingType不应该是std::pair&lt;KeyType, ValueType&gt;，而是std::pair&lt;KeyType, page_id_t&gt;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MappingType std::pair<span class="hljs-string">&lt;KeyType, ValueType&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> B_PLUS_TREE_LEAF_PAGE_TYPE BPlusTreeLeafPage<span class="hljs-string">&lt;KeyType, ValueType, KeyComparator&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAF_PAGE_HEADER_SIZE 28</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAF_PAGE_SIZE ((PAGE_SIZE - LEAF_PAGE_HEADER_SIZE) / sizeof(MappingType))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> B_PLUS_TREE_INTERNAL_PAGE_TYPE BPlusTreeInternalPage<span class="hljs-string">&lt;KeyType, ValueType, KeyComparator&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTERNAL_PAGE_HEADER_SIZE 24</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTERNAL_PAGE_SIZE ((PAGE_SIZE - INTERNAL_PAGE_HEADER_SIZE) / (sizeof(MappingType)))</span><br><span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">BPlusTree</span><span class="hljs-params">(std::string name, BufferPoolManager *buffer_pool_manager, <span class="hljs-type">const</span> KeyComparator &amp;comparator,</span></span><br><span class="hljs-params"><span class="hljs-function">                     <span class="hljs-type">int</span> leaf_max_size = LEAF_PAGE_SIZE, <span class="hljs-type">int</span> internal_max_size = INTERNAL_PAGE_SIZE)</span></span>;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/a586d8aa04ba4109bc0b923aadb97628.png" srcset="/img/loading.gif" lazyload><br>故定义常量</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> LEAF_PAGE_MAX_SIZE = (PAGE_SIZE - LEAF_PAGE_HEADER_SIZE) / <span class="hljs-built_in">sizeof</span>(std::pair&lt;KeyType, ValueType&gt;);<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> INTERNAL_PAGE_MAX_SIZE = (PAGE_SIZE - INTERNAL_PAGE_HEADER_SIZE) / (<span class="hljs-built_in">sizeof</span>(std::pair&lt;KeyType, <span class="hljs-type">page_id_t</span>&gt;));<br><span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">BPlusTree</span><span class="hljs-params">(std::string name, BufferPoolManager *buffer_pool_manager, <span class="hljs-type">const</span> KeyComparator &amp;comparator,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-type">int</span> leaf_max_size = LEAF_PAGE_MAX_SIZE, <span class="hljs-type">int</span> internal_max_size = INTERNAL_PAGE_MAX_SIZE)</span></span>;<br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/e936a7cec0344a91b9da5e56e8bd7afa.png" srcset="/img/loading.gif" lazyload></p><h2 id="check-point2简单记录"><a href="#check-point2简单记录" class="headerlink" title="check point2简单记录"></a>check point2简单记录</h2><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>在实现删除操作时，突出一个不知道在写啥，也不知道提供的接口各参数如何使用，特别是Coalesce函数的双重指针，后面才知道原来15445还有教材，也就是《数据库系统概念》，这本书上已经有了插入删除的伪码，对着伪码实现起来就非常简单了。不过中文版有些错误，对照英文版比较好。<br><a target="_blank" rel="noopener" href="https://github.com/omarhosny206/Database-System-Concepts-7th-edition/blob/master/Book/Database%20System%20Concepts.pdf">《Database-System-Concepts》</a><br><img src="https://img-blog.csdnimg.cn/4b62811a533c41f3ace5153c46c7bd38.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/f6c30f8f4978476e811937a64fb43572.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/b1ab2f5f0f76413097bdcd73243b0893.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/65999fd72bb34c5ba79156d529e9a4d5.png" srcset="/img/loading.gif" lazyload><br>注意的点：<br>根节点：首先处理目标节点为根节点的情况<br>叶子节点：注意this与recipient的位置关系，更新next id<br>内部节点：注意在移动时mid key的处理，维持不变量，另外对更改移动节点的parent id（创建辅助函数封装该过程）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">不变量<br>* Store n indexed keys and n+1 child pointers (page_id) within internal page.<br>* Pointer PAGE_ID(i) points to a subtree <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> all keys K satisfy:<br>* K(i) &lt;= K &lt; K(i+1).<br></code></pre></td></tr></table></figure><p>父节点：对应key的更新与删除</p><h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>为避免多次访问叶子节点，直接一次读取叶子节点所有数据项</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// add your own private member variables here</span><br>BufferPoolManager *buffer_pool_manager_;<br>Page *page_;<br>LeafPage *leaf_;<br>std::vector&lt;MappingType&gt; data_;<br><span class="hljs-type">int</span> index_;<br><br>Page *page = <span class="hljs-built_in">FindLeafPage</span>(key, <span class="hljs-literal">false</span>);<br>LeafPage *leaf = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br><span class="hljs-type">int</span> index = leaf-&gt;<span class="hljs-built_in">KeyIndex</span>(key, comparator_);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">INDEXITERATOR_TYPE</span>(buffer_pool_manager_, page, leaf-&gt;<span class="hljs-built_in">GetAllItem</span>(), index);<br><br><span class="hljs-function">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="hljs-function"><span class="hljs-title">INDEXITERATOR_TYPE::IndexIterator</span><span class="hljs-params">(BufferPoolManager *buffer_pool_manager, Page *page, std::vector&lt;MappingType&gt; &amp;&amp;data,<span class="hljs-type">int</span> index)</span></span><br><span class="hljs-function">    : buffer_pool_manager_(buffer_pool_manager), page_(page), data_(std::move(data)), index_(index) &#123;</span><br>  leaf_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(page_-&gt;<span class="hljs-built_in">GetData</span>());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>写这部分代码我主要参考了：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/382244184">CMU 15445 Project2 B+TREE | 简单的谈一谈B+树</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b83272f7684b">CMU 15445 Project 2C 实现B+树并发INDEX</a></p><p>实际上也就是用到了第一篇博客中的虚拟根节点与第二篇博客中对unpin与delete加上断言的思路。</p><p><strong>虚拟根节点：</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">ReaderWriterLatch virtual_root_;  <span class="hljs-comment">// 虚拟根节点</span><br><span class="hljs-comment">// 释放请求节点的锁并unpin</span><br>INDEX_TEMPLATE_ARGUMENTS<br><span class="hljs-type">void</span> <span class="hljs-title function_">BPLUSTREE_TYPE::ReleaseAncestorsPage</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">stack</span>&lt;Page *&gt; *ancestors, <span class="hljs-type">bool</span> is_dirty)</span> &#123;<br>  <span class="hljs-keyword">while</span> (!ancestors-&gt;empty()) &#123;<br>    Page *page = ancestors-&gt;top();<br>    <span class="hljs-keyword">if</span> (page != nullptr) &#123;<br>      BPlusTreePage *tree_page = reinterpret_cast&lt;BPlusTreePage *&gt;(page-&gt;GetData());<br>      <span class="hljs-type">page_id_t</span> page_id = tree_page-&gt;GetPageId();<br>      page-&gt;WUnlatch();<br>      buffer_pool_manager_-&gt;UnpinPage(page_id, is_dirty);<br>    &#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// 虚拟根节点处理</span><br>      virtual_root_.WUnlock();<br>    &#125;<br><br>    ancestors-&gt;pop();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>想象根节点之上还有一个虚拟根节点，读操作时先获取虚拟根节点的读锁再访问根节点，获取到根节点的读锁后再释放虚拟根节点。插入操作时先获取虚拟根节点的写锁再访问根节点，待子节点安全后统一释放，可压入一个空指针作为虚拟根节点的标记，一个非常巧妙的思路。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 读操作</span><br>virtual_root_.<span class="hljs-built_in">RLock</span>();  <span class="hljs-comment">// 获取虚拟根节点读锁</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsEmpty</span>()) &#123;<br>  virtual_root_.<span class="hljs-built_in">RUnlock</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-comment">// 递归查询，找到相应的叶节点</span><br><span class="hljs-type">page_id_t</span> page_id;<br><span class="hljs-type">page_id_t</span> parent_id;<br>Page *page;<br>Page *parent;<br>BPlusTreePage *tree_page;<br><br>page_id = root_page_id_;<br>page = buffer_pool_manager_-&gt;<span class="hljs-built_in">FetchPage</span>(page_id);<br>page-&gt;<span class="hljs-built_in">RLatch</span>();<br>virtual_root_.<span class="hljs-built_in">RUnlock</span>();<br>tree_page = <span class="hljs-built_in">reinterpret_cast</span>&lt;BPlusTreePage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br> <br><span class="hljs-comment">// 插入操作</span><br>virtual_root_.<span class="hljs-built_in">WLock</span>();  <span class="hljs-comment">// 获取虚拟根节点的写锁</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsEmpty</span>()) &#123;<br>  <span class="hljs-built_in">StartNewTree</span>(key, value);<br>  virtual_root_.<span class="hljs-built_in">WUnlock</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">// 在该函数中对virtual_root_解锁</span><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">InsertIntoLeaf</span>(key, value, transaction);<br><br><br><span class="hljs-comment">// 删除操作</span><br>virtual_root_.<span class="hljs-built_in">WLock</span>();  <span class="hljs-comment">// 获取虚拟根节点的写锁</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsEmpty</span>()) &#123;<br>  virtual_root_.<span class="hljs-built_in">WUnlock</span>();<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">// 递归查询，找到相应的叶节点</span><br><span class="hljs-type">page_id_t</span> page_id;<br>Page *page;<br>BPlusTreePage *tree_page;<br>std::stack&lt;Page *&gt; ancestors;<br><br>ancestors.<span class="hljs-built_in">emplace</span>(<span class="hljs-literal">nullptr</span>);  <span class="hljs-comment">// 表示压入虚拟根节点</span><br>page_id = root_page_id_;<br>page = buffer_pool_manager_-&gt;<span class="hljs-built_in">FetchPage</span>(page_id);<br>page-&gt;<span class="hljs-built_in">WLatch</span>();<br>tree_page = <span class="hljs-built_in">reinterpret_cast</span>&lt;BPlusTreePage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br></code></pre></td></tr></table></figure><p>而第二篇分析太多了，懒得看，主要是借鉴了断言的用法来验证实现的正确性</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp">UnpinPageImpl函数<br><span class="hljs-keyword">if</span> (page.pin_count_ &lt;= <span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unping page failed  id:%d  count:%d\n&quot;</span>, page_id, page.pin_count_);<br>  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-function">DeletePageImpl</span><br><span class="hljs-function"><span class="hljs-title">if</span> <span class="hljs-params">(delete_page.pin_count_ != <span class="hljs-number">0</span>)</span> </span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;delete page failed  id:%d  count:%d\n&quot;</span>, page_id, delete_page.pin_count_);<br>  <span class="hljs-built_in">assert</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>之前实现没怎么考虑unpin的问题，直接在辅助函数中记录create或fetch的页，而后统一unpin。这给我这部分的实现埋了许多的坑。</p><p>读取操作与插入操作实现起来没有太大的问题，而删除操作中可能发生页的删除，故修改CoalesceOrRedistribute函数定义，传递std::stack&lt;Page *&gt; *ancestors参数，每发生一次节点的删除就将当前页弹出，表示当前页的解锁与unpin不再由Remove函数负责，而由AdjustRoot函数或Coalesce函数负责（Coalesce函数可能发生节点交换，故不一定删除当前页，有可能删除其兄弟节点，故职责传递给函该函数编写代码比较方便）。<strong>写代码时调用fetch或create时一定要明确由哪个函数负责unpin</strong>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ancestors.<span class="hljs-built_in">emplace</span>(page);<br><span class="hljs-comment">// 进行删除操作，必要时进行节点重组</span><br>LeafPage *leaf = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(tree_page);<br><span class="hljs-type">int</span> size = leaf-&gt;<span class="hljs-built_in">RemoveAndDeleteRecord</span>(key, comparator_);<br><span class="hljs-comment">// 小于阈值则执行重分布或删除操作</span><br><span class="hljs-keyword">if</span> (size &lt; leaf-&gt;<span class="hljs-built_in">GetMinSize</span>()) &#123;<br>  <span class="hljs-comment">// 若删除发生，弹出部分节点，这些节点由CoalesceOrRedistribute负责解锁 unpin 删除</span><br>  <span class="hljs-built_in">CoalesceOrRedistribute</span>(leaf, &amp;ancestors, transaction);<br>&#125;<br><span class="hljs-built_in">ReleaseAncestorsPage</span>(&amp;ancestors, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>可在创建页或删除页时打印相关信息，便于了解程序的执行状态；也可以利用BPlusTree的Print方法输出b+树的数据构成。加锁实现完后可以跑一遍单线程的程序，保证代码基本的正确性。<br><img src="https://img-blog.csdnimg.cn/d6277389cf9d4074a042776893848295.png" srcset="/img/loading.gif" lazyload></p><p><strong>遇到的问题：</strong></p><p>1 在基本实现后运行顺序执行的测试程序时删除根节点的pin_count总是等于1。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  std::vector&lt;RID&gt; rids;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> key : keys) &#123;<br>    rids.<span class="hljs-built_in">clear</span>();<br>    index_key.<span class="hljs-built_in">SetFromInteger</span>(key);<br>    tree.<span class="hljs-built_in">GetValue</span>(index_key, &amp;rids);<br>    <span class="hljs-built_in">EXPECT_EQ</span>(rids.<span class="hljs-built_in">size</span>(), <span class="hljs-number">1</span>);<br><br>    <span class="hljs-type">int64_t</span> value = key &amp; <span class="hljs-number">0xFFFFFFFF</span>;<br>    <span class="hljs-built_in">EXPECT_EQ</span>(rids[<span class="hljs-number">0</span>].<span class="hljs-built_in">GetSlotNum</span>(), value);<br>  &#125;<br><span class="hljs-comment">// 此时pin count==0</span><br>  <span class="hljs-type">int64_t</span> start_key = <span class="hljs-number">1</span>;<br>  <span class="hljs-type">int64_t</span> current_key = start_key;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> pair : tree) &#123;<br>    (<span class="hljs-type">void</span>)pair;<br>    current_key = current_key + <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(current_key, keys.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>);<br><span class="hljs-comment">// 此时pin count==1</span><br>  <span class="hljs-type">int64_t</span> remove_scale = <span class="hljs-number">9900</span>;<br>  std::vector&lt;<span class="hljs-type">int64_t</span>&gt; remove_keys;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int64_t</span> key = <span class="hljs-number">1</span>; key &lt; remove_scale; key++) &#123;<br>    remove_keys.<span class="hljs-built_in">push_back</span>(key);<br>  &#125;<br>  <span class="hljs-comment">// std::random_shuffle(remove_keys.begin(), remove_keys.end());</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> key : remove_keys) &#123;<br>    index_key.<span class="hljs-built_in">SetFromInteger</span>(key);<br>    tree.<span class="hljs-built_in">Remove</span>(index_key, transaction);<br>  &#125;<br><br>  start_key = <span class="hljs-number">9900</span>;<br>  current_key = start_key;<br>  <span class="hljs-type">int64_t</span> size = <span class="hljs-number">0</span>;<br>  index_key.<span class="hljs-built_in">SetFromInteger</span>(start_key);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> pair : tree) &#123;<br>    (<span class="hljs-type">void</span>)pair;<br>    current_key = current_key + <span class="hljs-number">1</span>;<br>    size = size + <span class="hljs-number">1</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><p>在GetValue时pin count等于0，Remove时就变成1。后面才发现for (auto pair : tree) 隐含调用了begin方法，而在FindLeafPage方法中使用了FetchInternalPage方法，忘了unpin。</p><p>2 unpin时is_dirty问题<br>在顺序测试时，如果顺序删除，则结果正确，如果打乱，则结果错误。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::<span class="hljs-built_in">random_shuffle</span>(remove_keys.<span class="hljs-built_in">begin</span>(), remove_keys.<span class="hljs-built_in">end</span>());<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> key : remove_keys) &#123;<br>  index_key.<span class="hljs-built_in">SetFromInteger</span>(key);<br>  tree.<span class="hljs-built_in">Remove</span>(index_key, transaction);<br>&#125;<br></code></pre></td></tr></table></figure><p>后面发现在ReleaseAncestorsPage函数中UnpinPage我一律设置为了false，实际上当由于子节点安全调用的ReleaseAncestorsPage，is_dirty应该是false，因为当前操作并不会修改这些节点的值，但在插入或删除之后调用的ReleaseAncestorsPage应该设置为true。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BPLUSTREE_TYPE::InsertIntoLeaf</span><span class="hljs-params">(<span class="hljs-type">const</span> KeyType &amp;key, <span class="hljs-type">const</span> ValueType &amp;value, Transaction *transaction)</span> </span>&#123;<br>  <span class="hljs-comment">// 递归查询，找到相应的叶节点</span><br>  <span class="hljs-type">page_id_t</span> page_id;<br>  Page *page;<br>  BPlusTreePage *tree_page;<br>  std::stack&lt;Page *&gt; ancestors;<br><br>  ancestors.<span class="hljs-built_in">emplace</span>(<span class="hljs-literal">nullptr</span>);  <span class="hljs-comment">// 表示压入虚拟根节点</span><br>  page_id = root_page_id_;<br>  page = buffer_pool_manager_-&gt;<span class="hljs-built_in">FetchPage</span>(page_id);<br>  page-&gt;<span class="hljs-built_in">WLatch</span>();<br>  tree_page = <span class="hljs-built_in">reinterpret_cast</span>&lt;BPlusTreePage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br><br>  <span class="hljs-keyword">while</span> (!tree_page-&gt;<span class="hljs-built_in">IsLeafPage</span>()) &#123;<br>    ancestors.<span class="hljs-built_in">emplace</span>(page);  <span class="hljs-comment">// 压入父节点</span><br>    InternalPage *inner = <span class="hljs-built_in">reinterpret_cast</span>&lt;InternalPage *&gt;(tree_page);<br>    page_id = inner-&gt;<span class="hljs-built_in">Lookup</span>(key, comparator_);<br>    page = buffer_pool_manager_-&gt;<span class="hljs-built_in">FetchPage</span>(page_id);<br>    page-&gt;<span class="hljs-built_in">WLatch</span>();<br>    tree_page = <span class="hljs-built_in">reinterpret_cast</span>&lt;BPlusTreePage *&gt;(page-&gt;<span class="hljs-built_in">GetData</span>());<br>    <span class="hljs-keyword">if</span> (tree_page-&gt;<span class="hljs-built_in">GetSize</span>() &lt; tree_page-&gt;<span class="hljs-built_in">GetMaxSize</span>() - <span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">// 该节点安全，可释放父节点锁并unpin</span><br>      <span class="hljs-built_in">ReleaseAncestorsPage</span>(&amp;ancestors, <span class="hljs-literal">false</span>);                 <span class="hljs-comment">// 未修改父节点，is_dirty为false</span><br>    &#125;<br>  &#125;<br>  ancestors.<span class="hljs-built_in">emplace</span>(page);  <span class="hljs-comment">// 压入目标节点</span><br>  LeafPage *leaf = <span class="hljs-built_in">reinterpret_cast</span>&lt;LeafPage *&gt;(tree_page);<br>  <span class="hljs-type">int</span> old_size = leaf-&gt;<span class="hljs-built_in">GetSize</span>();<br>  <span class="hljs-type">int</span> new_size = leaf-&gt;<span class="hljs-built_in">Insert</span>(key, value, comparator_);<br>  <span class="hljs-keyword">if</span> (new_size &gt;= leaf_max_size_) &#123;  <span class="hljs-comment">// 节点已满，需进行分裂操作</span><br>    LeafPage *new_leaf = <span class="hljs-built_in">Split</span>(leaf);<br>    KeyType comp = new_leaf-&gt;<span class="hljs-built_in">KeyAt</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">InsertIntoParent</span>(leaf, comp, new_leaf, transaction);<br>    buffer_pool_manager_-&gt;<span class="hljs-built_in">UnpinPage</span>(new_leaf-&gt;<span class="hljs-built_in">GetPageId</span>(), <span class="hljs-literal">true</span>);  <span class="hljs-comment">// unpin新的叶子节点</span><br>  &#125;<br>  <span class="hljs-built_in">ReleaseAncestorsPage</span>(&amp;ancestors, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 解锁并unpin</span><br>  <span class="hljs-keyword">return</span> new_size &gt; old_size;<br>&#125;<br></code></pre></td></tr></table></figure><p>3： 节点安全问题</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Print输出结果</span><br>Internal Page: <span class="hljs-number">3</span> parent: <span class="hljs-number">-1</span><br><span class="hljs-number">0</span>: <span class="hljs-number">1</span>,<span class="hljs-number">128</span>: <span class="hljs-number">2</span>,<span class="hljs-number">255</span>: <span class="hljs-number">4</span>,<span class="hljs-number">382</span>: <span class="hljs-number">5</span>,<span class="hljs-number">509</span>: <span class="hljs-number">6</span>,<span class="hljs-number">638</span>: <span class="hljs-number">7</span>,<span class="hljs-number">766</span>: <span class="hljs-number">8</span>,<br><br>Leaf Page: <span class="hljs-number">1</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">2</span><br><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>,<span class="hljs-number">18</span>,<span class="hljs-number">19</span>,<span class="hljs-number">20</span>,<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>,<span class="hljs-number">24</span>,<span class="hljs-number">25</span>,<span class="hljs-number">26</span>,<span class="hljs-number">27</span>,<span class="hljs-number">28</span>,<span class="hljs-number">29</span>,<span class="hljs-number">30</span>,<span class="hljs-number">31</span>,<span class="hljs-number">32</span>,<span class="hljs-number">33</span>,<span class="hljs-number">34</span>,<span class="hljs-number">35</span>,<span class="hljs-number">36</span>,<span class="hljs-number">37</span>,<span class="hljs-number">38</span>,<span class="hljs-number">39</span>,<span class="hljs-number">40</span>,<span class="hljs-number">41</span>,<span class="hljs-number">42</span>,<span class="hljs-number">43</span>,<span class="hljs-number">44</span>,<span class="hljs-number">45</span>,<span class="hljs-number">46</span>,<span class="hljs-number">47</span>,<span class="hljs-number">48</span>,<span class="hljs-number">49</span>,<span class="hljs-number">50</span>,<span class="hljs-number">51</span>,<span class="hljs-number">52</span>,<span class="hljs-number">53</span>,<span class="hljs-number">54</span>,<span class="hljs-number">55</span>,<span class="hljs-number">56</span>,<span class="hljs-number">57</span>,<span class="hljs-number">58</span>,<span class="hljs-number">59</span>,<span class="hljs-number">60</span>,<span class="hljs-number">61</span>,<span class="hljs-number">62</span>,<span class="hljs-number">63</span>,<span class="hljs-number">64</span>,<span class="hljs-number">65</span>,<span class="hljs-number">66</span>,<span class="hljs-number">67</span>,<span class="hljs-number">68</span>,<span class="hljs-number">69</span>,<span class="hljs-number">70</span>,<span class="hljs-number">71</span>,<span class="hljs-number">72</span>,<span class="hljs-number">73</span>,<span class="hljs-number">74</span>,<span class="hljs-number">75</span>,<span class="hljs-number">76</span>,<span class="hljs-number">77</span>,<span class="hljs-number">78</span>,<span class="hljs-number">79</span>,<span class="hljs-number">80</span>,<span class="hljs-number">81</span>,<span class="hljs-number">82</span>,<span class="hljs-number">83</span>,<span class="hljs-number">84</span>,<span class="hljs-number">85</span>,<span class="hljs-number">86</span>,<span class="hljs-number">87</span>,<span class="hljs-number">88</span>,<span class="hljs-number">89</span>,<span class="hljs-number">90</span>,<span class="hljs-number">91</span>,<span class="hljs-number">92</span>,<span class="hljs-number">93</span>,<span class="hljs-number">94</span>,<span class="hljs-number">95</span>,<span class="hljs-number">96</span>,<span class="hljs-number">97</span>,<span class="hljs-number">98</span>,<span class="hljs-number">99</span>,<span class="hljs-number">100</span>,<span class="hljs-number">101</span>,<span class="hljs-number">102</span>,<span class="hljs-number">103</span>,<span class="hljs-number">104</span>,<span class="hljs-number">105</span>,<span class="hljs-number">106</span>,<span class="hljs-number">107</span>,<span class="hljs-number">108</span>,<span class="hljs-number">109</span>,<span class="hljs-number">110</span>,<span class="hljs-number">111</span>,<span class="hljs-number">112</span>,<span class="hljs-number">113</span>,<span class="hljs-number">114</span>,<span class="hljs-number">115</span>,<span class="hljs-number">116</span>,<span class="hljs-number">117</span>,<span class="hljs-number">118</span>,<span class="hljs-number">119</span>,<span class="hljs-number">120</span>,<span class="hljs-number">121</span>,<span class="hljs-number">122</span>,<span class="hljs-number">123</span>,<span class="hljs-number">124</span>,<span class="hljs-number">125</span>,<span class="hljs-number">126</span>,<span class="hljs-number">127</span>,<br><br>Leaf Page: <span class="hljs-number">2</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">4</span><br><span class="hljs-number">128</span>,<span class="hljs-number">129</span>,<span class="hljs-number">130</span>,<span class="hljs-number">131</span>,<span class="hljs-number">132</span>,<span class="hljs-number">133</span>,<span class="hljs-number">134</span>,<span class="hljs-number">135</span>,<span class="hljs-number">136</span>,<span class="hljs-number">137</span>,<span class="hljs-number">138</span>,<span class="hljs-number">139</span>,<span class="hljs-number">140</span>,<span class="hljs-number">141</span>,<span class="hljs-number">142</span>,<span class="hljs-number">143</span>,<span class="hljs-number">144</span>,<span class="hljs-number">145</span>,<span class="hljs-number">146</span>,<span class="hljs-number">147</span>,<span class="hljs-number">148</span>,<span class="hljs-number">149</span>,<span class="hljs-number">150</span>,<span class="hljs-number">151</span>,<span class="hljs-number">152</span>,<span class="hljs-number">153</span>,<span class="hljs-number">154</span>,<span class="hljs-number">155</span>,<span class="hljs-number">156</span>,<span class="hljs-number">157</span>,<span class="hljs-number">158</span>,<span class="hljs-number">159</span>,<span class="hljs-number">160</span>,<span class="hljs-number">161</span>,<span class="hljs-number">162</span>,<span class="hljs-number">163</span>,<span class="hljs-number">164</span>,<span class="hljs-number">165</span>,<span class="hljs-number">166</span>,<span class="hljs-number">167</span>,<span class="hljs-number">168</span>,<span class="hljs-number">169</span>,<span class="hljs-number">170</span>,<span class="hljs-number">171</span>,<span class="hljs-number">172</span>,<span class="hljs-number">173</span>,<span class="hljs-number">174</span>,<span class="hljs-number">175</span>,<span class="hljs-number">176</span>,<span class="hljs-number">177</span>,<span class="hljs-number">178</span>,<span class="hljs-number">179</span>,<span class="hljs-number">180</span>,<span class="hljs-number">181</span>,<span class="hljs-number">182</span>,<span class="hljs-number">183</span>,<span class="hljs-number">184</span>,<span class="hljs-number">185</span>,<span class="hljs-number">186</span>,<span class="hljs-number">187</span>,<span class="hljs-number">188</span>,<span class="hljs-number">189</span>,<span class="hljs-number">190</span>,<span class="hljs-number">191</span>,<span class="hljs-number">192</span>,<span class="hljs-number">193</span>,<span class="hljs-number">194</span>,<span class="hljs-number">195</span>,<span class="hljs-number">196</span>,<span class="hljs-number">197</span>,<span class="hljs-number">198</span>,<span class="hljs-number">199</span>,<span class="hljs-number">200</span>,<span class="hljs-number">201</span>,<span class="hljs-number">202</span>,<span class="hljs-number">203</span>,<span class="hljs-number">204</span>,<span class="hljs-number">205</span>,<span class="hljs-number">206</span>,<span class="hljs-number">207</span>,<span class="hljs-number">208</span>,<span class="hljs-number">209</span>,<span class="hljs-number">210</span>,<span class="hljs-number">211</span>,<span class="hljs-number">212</span>,<span class="hljs-number">213</span>,<span class="hljs-number">214</span>,<span class="hljs-number">215</span>,<span class="hljs-number">216</span>,<span class="hljs-number">217</span>,<span class="hljs-number">218</span>,<span class="hljs-number">219</span>,<span class="hljs-number">220</span>,<span class="hljs-number">221</span>,<span class="hljs-number">222</span>,<span class="hljs-number">223</span>,<span class="hljs-number">224</span>,<span class="hljs-number">225</span>,<span class="hljs-number">226</span>,<span class="hljs-number">227</span>,<span class="hljs-number">228</span>,<span class="hljs-number">229</span>,<span class="hljs-number">230</span>,<span class="hljs-number">231</span>,<span class="hljs-number">232</span>,<span class="hljs-number">233</span>,<span class="hljs-number">234</span>,<span class="hljs-number">235</span>,<span class="hljs-number">236</span>,<span class="hljs-number">237</span>,<span class="hljs-number">238</span>,<span class="hljs-number">239</span>,<span class="hljs-number">240</span>,<span class="hljs-number">241</span>,<span class="hljs-number">242</span>,<span class="hljs-number">243</span>,<span class="hljs-number">244</span>,<span class="hljs-number">245</span>,<span class="hljs-number">246</span>,<span class="hljs-number">247</span>,<span class="hljs-number">248</span>,<span class="hljs-number">249</span>,<span class="hljs-number">250</span>,<span class="hljs-number">251</span>,<span class="hljs-number">252</span>,<span class="hljs-number">253</span>,<span class="hljs-number">254</span>,<br><br>Leaf Page: <span class="hljs-number">4</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">5</span><br><span class="hljs-number">255</span>,<span class="hljs-number">256</span>,<span class="hljs-number">257</span>,<span class="hljs-number">258</span>,<span class="hljs-number">259</span>,<span class="hljs-number">260</span>,<span class="hljs-number">261</span>,<span class="hljs-number">262</span>,<span class="hljs-number">263</span>,<span class="hljs-number">264</span>,<span class="hljs-number">265</span>,<span class="hljs-number">266</span>,<span class="hljs-number">267</span>,<span class="hljs-number">268</span>,<span class="hljs-number">269</span>,<span class="hljs-number">270</span>,<span class="hljs-number">271</span>,<span class="hljs-number">272</span>,<span class="hljs-number">273</span>,<span class="hljs-number">274</span>,<span class="hljs-number">275</span>,<span class="hljs-number">276</span>,<span class="hljs-number">277</span>,<span class="hljs-number">278</span>,<span class="hljs-number">279</span>,<span class="hljs-number">280</span>,<span class="hljs-number">281</span>,<span class="hljs-number">282</span>,<span class="hljs-number">283</span>,<span class="hljs-number">284</span>,<span class="hljs-number">285</span>,<span class="hljs-number">286</span>,<span class="hljs-number">287</span>,<span class="hljs-number">288</span>,<span class="hljs-number">289</span>,<span class="hljs-number">290</span>,<span class="hljs-number">291</span>,<span class="hljs-number">292</span>,<span class="hljs-number">293</span>,<span class="hljs-number">294</span>,<span class="hljs-number">295</span>,<span class="hljs-number">296</span>,<span class="hljs-number">297</span>,<span class="hljs-number">298</span>,<span class="hljs-number">299</span>,<span class="hljs-number">300</span>,<span class="hljs-number">301</span>,<span class="hljs-number">302</span>,<span class="hljs-number">303</span>,<span class="hljs-number">304</span>,<span class="hljs-number">305</span>,<span class="hljs-number">306</span>,<span class="hljs-number">307</span>,<span class="hljs-number">308</span>,<span class="hljs-number">309</span>,<span class="hljs-number">310</span>,<span class="hljs-number">311</span>,<span class="hljs-number">312</span>,<span class="hljs-number">313</span>,<span class="hljs-number">314</span>,<span class="hljs-number">315</span>,<span class="hljs-number">316</span>,<span class="hljs-number">317</span>,<span class="hljs-number">318</span>,<span class="hljs-number">319</span>,<span class="hljs-number">320</span>,<span class="hljs-number">321</span>,<span class="hljs-number">322</span>,<span class="hljs-number">323</span>,<span class="hljs-number">324</span>,<span class="hljs-number">325</span>,<span class="hljs-number">326</span>,<span class="hljs-number">327</span>,<span class="hljs-number">328</span>,<span class="hljs-number">329</span>,<span class="hljs-number">330</span>,<span class="hljs-number">331</span>,<span class="hljs-number">332</span>,<span class="hljs-number">333</span>,<span class="hljs-number">334</span>,<span class="hljs-number">335</span>,<span class="hljs-number">336</span>,<span class="hljs-number">337</span>,<span class="hljs-number">338</span>,<span class="hljs-number">339</span>,<span class="hljs-number">340</span>,<span class="hljs-number">341</span>,<span class="hljs-number">342</span>,<span class="hljs-number">343</span>,<span class="hljs-number">344</span>,<span class="hljs-number">345</span>,<span class="hljs-number">346</span>,<span class="hljs-number">347</span>,<span class="hljs-number">348</span>,<span class="hljs-number">349</span>,<span class="hljs-number">350</span>,<span class="hljs-number">351</span>,<span class="hljs-number">352</span>,<span class="hljs-number">353</span>,<span class="hljs-number">354</span>,<span class="hljs-number">355</span>,<span class="hljs-number">356</span>,<span class="hljs-number">357</span>,<span class="hljs-number">358</span>,<span class="hljs-number">359</span>,<span class="hljs-number">360</span>,<span class="hljs-number">361</span>,<span class="hljs-number">362</span>,<span class="hljs-number">363</span>,<span class="hljs-number">364</span>,<span class="hljs-number">365</span>,<span class="hljs-number">366</span>,<span class="hljs-number">367</span>,<span class="hljs-number">368</span>,<span class="hljs-number">369</span>,<span class="hljs-number">370</span>,<span class="hljs-number">371</span>,<span class="hljs-number">372</span>,<span class="hljs-number">373</span>,<span class="hljs-number">374</span>,<span class="hljs-number">375</span>,<span class="hljs-number">376</span>,<span class="hljs-number">377</span>,<span class="hljs-number">378</span>,<span class="hljs-number">379</span>,<span class="hljs-number">380</span>,<span class="hljs-number">381</span>,<span class="hljs-number">512</span>,<br><br>Leaf Page: <span class="hljs-number">5</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">6</span><br><span class="hljs-number">382</span>,<span class="hljs-number">383</span>,<span class="hljs-number">384</span>,<span class="hljs-number">385</span>,<span class="hljs-number">386</span>,<span class="hljs-number">387</span>,<span class="hljs-number">388</span>,<span class="hljs-number">389</span>,<span class="hljs-number">390</span>,<span class="hljs-number">391</span>,<span class="hljs-number">392</span>,<span class="hljs-number">393</span>,<span class="hljs-number">394</span>,<span class="hljs-number">395</span>,<span class="hljs-number">396</span>,<span class="hljs-number">397</span>,<span class="hljs-number">398</span>,<span class="hljs-number">399</span>,<span class="hljs-number">400</span>,<span class="hljs-number">401</span>,<span class="hljs-number">402</span>,<span class="hljs-number">403</span>,<span class="hljs-number">404</span>,<span class="hljs-number">405</span>,<span class="hljs-number">406</span>,<span class="hljs-number">407</span>,<span class="hljs-number">408</span>,<span class="hljs-number">409</span>,<span class="hljs-number">410</span>,<span class="hljs-number">411</span>,<span class="hljs-number">412</span>,<span class="hljs-number">413</span>,<span class="hljs-number">414</span>,<span class="hljs-number">415</span>,<span class="hljs-number">416</span>,<span class="hljs-number">417</span>,<span class="hljs-number">418</span>,<span class="hljs-number">419</span>,<span class="hljs-number">420</span>,<span class="hljs-number">421</span>,<span class="hljs-number">422</span>,<span class="hljs-number">423</span>,<span class="hljs-number">424</span>,<span class="hljs-number">425</span>,<span class="hljs-number">426</span>,<span class="hljs-number">427</span>,<span class="hljs-number">428</span>,<span class="hljs-number">429</span>,<span class="hljs-number">430</span>,<span class="hljs-number">431</span>,<span class="hljs-number">432</span>,<span class="hljs-number">433</span>,<span class="hljs-number">434</span>,<span class="hljs-number">435</span>,<span class="hljs-number">436</span>,<span class="hljs-number">437</span>,<span class="hljs-number">438</span>,<span class="hljs-number">439</span>,<span class="hljs-number">440</span>,<span class="hljs-number">441</span>,<span class="hljs-number">442</span>,<span class="hljs-number">443</span>,<span class="hljs-number">444</span>,<span class="hljs-number">445</span>,<span class="hljs-number">446</span>,<span class="hljs-number">447</span>,<span class="hljs-number">448</span>,<span class="hljs-number">449</span>,<span class="hljs-number">450</span>,<span class="hljs-number">451</span>,<span class="hljs-number">452</span>,<span class="hljs-number">453</span>,<span class="hljs-number">454</span>,<span class="hljs-number">455</span>,<span class="hljs-number">456</span>,<span class="hljs-number">457</span>,<span class="hljs-number">458</span>,<span class="hljs-number">459</span>,<span class="hljs-number">460</span>,<span class="hljs-number">461</span>,<span class="hljs-number">462</span>,<span class="hljs-number">463</span>,<span class="hljs-number">464</span>,<span class="hljs-number">465</span>,<span class="hljs-number">466</span>,<span class="hljs-number">467</span>,<span class="hljs-number">468</span>,<span class="hljs-number">469</span>,<span class="hljs-number">470</span>,<span class="hljs-number">471</span>,<span class="hljs-number">472</span>,<span class="hljs-number">473</span>,<span class="hljs-number">474</span>,<span class="hljs-number">475</span>,<span class="hljs-number">476</span>,<span class="hljs-number">477</span>,<span class="hljs-number">478</span>,<span class="hljs-number">479</span>,<span class="hljs-number">480</span>,<span class="hljs-number">481</span>,<span class="hljs-number">482</span>,<span class="hljs-number">483</span>,<span class="hljs-number">484</span>,<span class="hljs-number">485</span>,<span class="hljs-number">486</span>,<span class="hljs-number">487</span>,<span class="hljs-number">488</span>,<span class="hljs-number">489</span>,<span class="hljs-number">490</span>,<span class="hljs-number">491</span>,<span class="hljs-number">492</span>,<span class="hljs-number">493</span>,<span class="hljs-number">494</span>,<span class="hljs-number">495</span>,<span class="hljs-number">496</span>,<span class="hljs-number">497</span>,<span class="hljs-number">498</span>,<span class="hljs-number">499</span>,<span class="hljs-number">500</span>,<span class="hljs-number">501</span>,<span class="hljs-number">502</span>,<span class="hljs-number">503</span>,<span class="hljs-number">504</span>,<span class="hljs-number">505</span>,<span class="hljs-number">506</span>,<span class="hljs-number">507</span>,<span class="hljs-number">508</span>,<span class="hljs-number">632</span>,<br><br>Leaf Page: <span class="hljs-number">6</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">7</span><br><span class="hljs-number">509</span>,<span class="hljs-number">510</span>,<span class="hljs-number">511</span>,<span class="hljs-number">513</span>,<span class="hljs-number">514</span>,<span class="hljs-number">515</span>,<span class="hljs-number">516</span>,<span class="hljs-number">517</span>,<span class="hljs-number">518</span>,<span class="hljs-number">519</span>,<span class="hljs-number">520</span>,<span class="hljs-number">521</span>,<span class="hljs-number">522</span>,<span class="hljs-number">523</span>,<span class="hljs-number">524</span>,<span class="hljs-number">525</span>,<span class="hljs-number">526</span>,<span class="hljs-number">527</span>,<span class="hljs-number">528</span>,<span class="hljs-number">529</span>,<span class="hljs-number">530</span>,<span class="hljs-number">531</span>,<span class="hljs-number">532</span>,<span class="hljs-number">533</span>,<span class="hljs-number">534</span>,<span class="hljs-number">535</span>,<span class="hljs-number">536</span>,<span class="hljs-number">537</span>,<span class="hljs-number">538</span>,<span class="hljs-number">539</span>,<span class="hljs-number">540</span>,<span class="hljs-number">541</span>,<span class="hljs-number">542</span>,<span class="hljs-number">543</span>,<span class="hljs-number">544</span>,<span class="hljs-number">545</span>,<span class="hljs-number">546</span>,<span class="hljs-number">547</span>,<span class="hljs-number">548</span>,<span class="hljs-number">549</span>,<span class="hljs-number">550</span>,<span class="hljs-number">551</span>,<span class="hljs-number">552</span>,<span class="hljs-number">553</span>,<span class="hljs-number">554</span>,<span class="hljs-number">555</span>,<span class="hljs-number">556</span>,<span class="hljs-number">557</span>,<span class="hljs-number">558</span>,<span class="hljs-number">559</span>,<span class="hljs-number">560</span>,<span class="hljs-number">561</span>,<span class="hljs-number">562</span>,<span class="hljs-number">563</span>,<span class="hljs-number">564</span>,<span class="hljs-number">565</span>,<span class="hljs-number">566</span>,<span class="hljs-number">567</span>,<span class="hljs-number">568</span>,<span class="hljs-number">569</span>,<span class="hljs-number">570</span>,<span class="hljs-number">571</span>,<span class="hljs-number">572</span>,<span class="hljs-number">573</span>,<span class="hljs-number">574</span>,<span class="hljs-number">575</span>,<span class="hljs-number">576</span>,<span class="hljs-number">577</span>,<span class="hljs-number">578</span>,<span class="hljs-number">579</span>,<span class="hljs-number">580</span>,<span class="hljs-number">581</span>,<span class="hljs-number">582</span>,<span class="hljs-number">583</span>,<span class="hljs-number">584</span>,<span class="hljs-number">585</span>,<span class="hljs-number">586</span>,<span class="hljs-number">587</span>,<span class="hljs-number">588</span>,<span class="hljs-number">589</span>,<span class="hljs-number">590</span>,<span class="hljs-number">591</span>,<span class="hljs-number">592</span>,<span class="hljs-number">593</span>,<span class="hljs-number">594</span>,<span class="hljs-number">595</span>,<span class="hljs-number">596</span>,<span class="hljs-number">597</span>,<span class="hljs-number">598</span>,<span class="hljs-number">599</span>,<span class="hljs-number">600</span>,<span class="hljs-number">601</span>,<span class="hljs-number">602</span>,<span class="hljs-number">603</span>,<span class="hljs-number">604</span>,<span class="hljs-number">605</span>,<span class="hljs-number">606</span>,<span class="hljs-number">607</span>,<span class="hljs-number">608</span>,<span class="hljs-number">609</span>,<span class="hljs-number">610</span>,<span class="hljs-number">611</span>,<span class="hljs-number">612</span>,<span class="hljs-number">613</span>,<span class="hljs-number">614</span>,<span class="hljs-number">615</span>,<span class="hljs-number">616</span>,<span class="hljs-number">617</span>,<span class="hljs-number">618</span>,<span class="hljs-number">619</span>,<span class="hljs-number">620</span>,<span class="hljs-number">621</span>,<span class="hljs-number">622</span>,<span class="hljs-number">623</span>,<span class="hljs-number">624</span>,<span class="hljs-number">625</span>,<span class="hljs-number">626</span>,<span class="hljs-number">627</span>,<span class="hljs-number">628</span>,<span class="hljs-number">629</span>,<span class="hljs-number">630</span>,<span class="hljs-number">631</span>,<span class="hljs-number">633</span>,<span class="hljs-number">634</span>,<span class="hljs-number">635</span>,<span class="hljs-number">636</span>,<span class="hljs-number">637</span>,<span class="hljs-number">749</span>,<br><br>Leaf Page: <span class="hljs-number">7</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">8</span><br><span class="hljs-number">638</span>,<span class="hljs-number">639</span>,<span class="hljs-number">640</span>,<span class="hljs-number">641</span>,<span class="hljs-number">642</span>,<span class="hljs-number">643</span>,<span class="hljs-number">644</span>,<span class="hljs-number">645</span>,<span class="hljs-number">646</span>,<span class="hljs-number">647</span>,<span class="hljs-number">648</span>,<span class="hljs-number">649</span>,<span class="hljs-number">650</span>,<span class="hljs-number">651</span>,<span class="hljs-number">652</span>,<span class="hljs-number">653</span>,<span class="hljs-number">654</span>,<span class="hljs-number">655</span>,<span class="hljs-number">656</span>,<span class="hljs-number">657</span>,<span class="hljs-number">658</span>,<span class="hljs-number">659</span>,<span class="hljs-number">660</span>,<span class="hljs-number">661</span>,<span class="hljs-number">662</span>,<span class="hljs-number">663</span>,<span class="hljs-number">664</span>,<span class="hljs-number">665</span>,<span class="hljs-number">666</span>,<span class="hljs-number">667</span>,<span class="hljs-number">668</span>,<span class="hljs-number">669</span>,<span class="hljs-number">670</span>,<span class="hljs-number">671</span>,<span class="hljs-number">672</span>,<span class="hljs-number">673</span>,<span class="hljs-number">674</span>,<span class="hljs-number">675</span>,<span class="hljs-number">676</span>,<span class="hljs-number">677</span>,<span class="hljs-number">678</span>,<span class="hljs-number">679</span>,<span class="hljs-number">680</span>,<span class="hljs-number">681</span>,<span class="hljs-number">682</span>,<span class="hljs-number">683</span>,<span class="hljs-number">684</span>,<span class="hljs-number">685</span>,<span class="hljs-number">686</span>,<span class="hljs-number">687</span>,<span class="hljs-number">688</span>,<span class="hljs-number">689</span>,<span class="hljs-number">690</span>,<span class="hljs-number">691</span>,<span class="hljs-number">692</span>,<span class="hljs-number">693</span>,<span class="hljs-number">694</span>,<span class="hljs-number">695</span>,<span class="hljs-number">696</span>,<span class="hljs-number">697</span>,<span class="hljs-number">698</span>,<span class="hljs-number">699</span>,<span class="hljs-number">700</span>,<span class="hljs-number">701</span>,<span class="hljs-number">702</span>,<span class="hljs-number">703</span>,<span class="hljs-number">704</span>,<span class="hljs-number">705</span>,<span class="hljs-number">706</span>,<span class="hljs-number">707</span>,<span class="hljs-number">708</span>,<span class="hljs-number">709</span>,<span class="hljs-number">710</span>,<span class="hljs-number">711</span>,<span class="hljs-number">712</span>,<span class="hljs-number">713</span>,<span class="hljs-number">714</span>,<span class="hljs-number">715</span>,<span class="hljs-number">716</span>,<span class="hljs-number">717</span>,<span class="hljs-number">718</span>,<span class="hljs-number">719</span>,<span class="hljs-number">720</span>,<span class="hljs-number">721</span>,<span class="hljs-number">722</span>,<span class="hljs-number">723</span>,<span class="hljs-number">724</span>,<span class="hljs-number">725</span>,<span class="hljs-number">726</span>,<span class="hljs-number">727</span>,<span class="hljs-number">728</span>,<span class="hljs-number">729</span>,<span class="hljs-number">730</span>,<span class="hljs-number">731</span>,<span class="hljs-number">732</span>,<span class="hljs-number">733</span>,<span class="hljs-number">734</span>,<span class="hljs-number">735</span>,<span class="hljs-number">736</span>,<span class="hljs-number">737</span>,<span class="hljs-number">738</span>,<span class="hljs-number">739</span>,<span class="hljs-number">740</span>,<span class="hljs-number">741</span>,<span class="hljs-number">742</span>,<span class="hljs-number">743</span>,<span class="hljs-number">744</span>,<span class="hljs-number">745</span>,<span class="hljs-number">746</span>,<span class="hljs-number">747</span>,<span class="hljs-number">748</span>,<span class="hljs-number">750</span>,<span class="hljs-number">751</span>,<span class="hljs-number">752</span>,<span class="hljs-number">753</span>,<span class="hljs-number">754</span>,<span class="hljs-number">755</span>,<span class="hljs-number">756</span>,<span class="hljs-number">757</span>,<span class="hljs-number">758</span>,<span class="hljs-number">759</span>,<span class="hljs-number">760</span>,<span class="hljs-number">761</span>,<span class="hljs-number">762</span>,<span class="hljs-number">763</span>,<span class="hljs-number">764</span>,<span class="hljs-number">765</span>,<br><br>Leaf Page: <span class="hljs-number">8</span> parent: <span class="hljs-number">3</span> next: <span class="hljs-number">-1</span><br><span class="hljs-number">766</span>,<span class="hljs-number">767</span>,<span class="hljs-number">768</span>,<span class="hljs-number">769</span>,<span class="hljs-number">770</span>,<span class="hljs-number">771</span>,<span class="hljs-number">772</span>,<span class="hljs-number">773</span>,<span class="hljs-number">774</span>,<span class="hljs-number">775</span>,<span class="hljs-number">776</span>,<span class="hljs-number">777</span>,<span class="hljs-number">778</span>,<span class="hljs-number">779</span>,<span class="hljs-number">780</span>,<span class="hljs-number">781</span>,<span class="hljs-number">782</span>,<span class="hljs-number">783</span>,<span class="hljs-number">784</span>,<span class="hljs-number">785</span>,<span class="hljs-number">786</span>,<span class="hljs-number">787</span>,<span class="hljs-number">788</span>,<span class="hljs-number">789</span>,<span class="hljs-number">790</span>,<span class="hljs-number">791</span>,<span class="hljs-number">792</span>,<span class="hljs-number">793</span>,<span class="hljs-number">794</span>,<span class="hljs-number">795</span>,<span class="hljs-number">796</span>,<span class="hljs-number">797</span>,<span class="hljs-number">798</span>,<span class="hljs-number">799</span>,<span class="hljs-number">800</span>,<span class="hljs-number">801</span>,<span class="hljs-number">802</span>,<span class="hljs-number">803</span>,<span class="hljs-number">804</span>,<span class="hljs-number">805</span>,<span class="hljs-number">806</span>,<span class="hljs-number">807</span>,<span class="hljs-number">808</span>,<span class="hljs-number">809</span>,<span class="hljs-number">810</span>,<span class="hljs-number">811</span>,<span class="hljs-number">812</span>,<span class="hljs-number">813</span>,<span class="hljs-number">814</span>,<span class="hljs-number">815</span>,<span class="hljs-number">816</span>,<span class="hljs-number">817</span>,<span class="hljs-number">818</span>,<span class="hljs-number">819</span>,<span class="hljs-number">820</span>,<span class="hljs-number">821</span>,<span class="hljs-number">822</span>,<span class="hljs-number">823</span>,<span class="hljs-number">824</span>,<span class="hljs-number">825</span>,<span class="hljs-number">826</span>,<span class="hljs-number">827</span>,<span class="hljs-number">828</span>,<span class="hljs-number">829</span>,<span class="hljs-number">830</span>,<span class="hljs-number">831</span>,<span class="hljs-number">832</span>,<span class="hljs-number">833</span>,<span class="hljs-number">834</span>,<span class="hljs-number">835</span>,<span class="hljs-number">836</span>,<span class="hljs-number">837</span>,<span class="hljs-number">838</span>,<span class="hljs-number">839</span>,<span class="hljs-number">840</span>,<span class="hljs-number">841</span>,<span class="hljs-number">842</span>,<span class="hljs-number">843</span>,<span class="hljs-number">844</span>,<span class="hljs-number">845</span>,<span class="hljs-number">846</span>,<span class="hljs-number">847</span>,<span class="hljs-number">848</span>,<span class="hljs-number">849</span>,<span class="hljs-number">850</span>,<span class="hljs-number">851</span>,<span class="hljs-number">852</span>,<span class="hljs-number">853</span>,<span class="hljs-number">854</span>,<span class="hljs-number">855</span>,<span class="hljs-number">856</span>,<span class="hljs-number">857</span>,<span class="hljs-number">858</span>,<span class="hljs-number">859</span>,<span class="hljs-number">860</span>,<span class="hljs-number">861</span>,<span class="hljs-number">862</span>,<span class="hljs-number">863</span>,<span class="hljs-number">864</span>,<span class="hljs-number">865</span>,<span class="hljs-number">866</span>,<span class="hljs-number">867</span>,<span class="hljs-number">868</span>,<span class="hljs-number">869</span>,<span class="hljs-number">870</span>,<span class="hljs-number">871</span>,<span class="hljs-number">872</span>,<span class="hljs-number">873</span>,<span class="hljs-number">874</span>,<span class="hljs-number">875</span>,<span class="hljs-number">876</span>,<span class="hljs-number">877</span>,<span class="hljs-number">878</span>,<span class="hljs-number">879</span>,<span class="hljs-number">880</span>,<span class="hljs-number">881</span>,<span class="hljs-number">882</span>,<span class="hljs-number">883</span>,<span class="hljs-number">884</span>,<span class="hljs-number">885</span>,<span class="hljs-number">886</span>,<span class="hljs-number">887</span>,<span class="hljs-number">888</span>,<span class="hljs-number">889</span>,<span class="hljs-number">890</span>,<span class="hljs-number">891</span>,<span class="hljs-number">892</span>,<span class="hljs-number">893</span>,<span class="hljs-number">894</span>,<span class="hljs-number">895</span>,<span class="hljs-number">896</span>,<span class="hljs-number">897</span>,<span class="hljs-number">898</span>,<span class="hljs-number">899</span>,<span class="hljs-number">900</span>,<span class="hljs-number">901</span>,<span class="hljs-number">902</span>,<span class="hljs-number">903</span>,<span class="hljs-number">904</span>,<span class="hljs-number">905</span>,<span class="hljs-number">906</span>,<span class="hljs-number">907</span>,<span class="hljs-number">908</span>,<span class="hljs-number">909</span>,<span class="hljs-number">910</span>,<span class="hljs-number">911</span>,<span class="hljs-number">912</span>,<span class="hljs-number">913</span>,<span class="hljs-number">914</span>,<span class="hljs-number">915</span>,<span class="hljs-number">916</span>,<span class="hljs-number">917</span>,<span class="hljs-number">918</span>,<span class="hljs-number">919</span>,<span class="hljs-number">920</span>,<span class="hljs-number">921</span>,<span class="hljs-number">922</span>,<span class="hljs-number">923</span>,<span class="hljs-number">924</span>,<span class="hljs-number">925</span>,<span class="hljs-number">926</span>,<span class="hljs-number">927</span>,<span class="hljs-number">928</span>,<span class="hljs-number">929</span>,<span class="hljs-number">930</span>,<span class="hljs-number">931</span>,<span class="hljs-number">932</span>,<span class="hljs-number">933</span>,<span class="hljs-number">934</span>,<span class="hljs-number">935</span>,<span class="hljs-number">936</span>,<span class="hljs-number">937</span>,<span class="hljs-number">938</span>,<span class="hljs-number">939</span>,<span class="hljs-number">940</span>,<span class="hljs-number">941</span>,<span class="hljs-number">942</span>,<span class="hljs-number">943</span>,<span class="hljs-number">944</span>,<span class="hljs-number">945</span>,<span class="hljs-number">946</span>,<span class="hljs-number">947</span>,<span class="hljs-number">948</span>,<span class="hljs-number">949</span>,<span class="hljs-number">950</span>,<span class="hljs-number">951</span>,<span class="hljs-number">952</span>,<span class="hljs-number">953</span>,<span class="hljs-number">954</span>,<span class="hljs-number">955</span>,<span class="hljs-number">956</span>,<span class="hljs-number">957</span>,<span class="hljs-number">958</span>,<span class="hljs-number">959</span>,<span class="hljs-number">960</span>,<span class="hljs-number">961</span>,<span class="hljs-number">962</span>,<span class="hljs-number">963</span>,<span class="hljs-number">964</span>,<span class="hljs-number">965</span>,<span class="hljs-number">966</span>,<span class="hljs-number">967</span>,<span class="hljs-number">968</span>,<span class="hljs-number">969</span>,<span class="hljs-number">970</span>,<span class="hljs-number">971</span>,<span class="hljs-number">972</span>,<span class="hljs-number">973</span>,<span class="hljs-number">974</span>,<span class="hljs-number">975</span>,<span class="hljs-number">976</span>,<span class="hljs-number">977</span>,<span class="hljs-number">978</span>,<span class="hljs-number">979</span>,<span class="hljs-number">980</span>,<span class="hljs-number">981</span>,<span class="hljs-number">982</span>,<span class="hljs-number">983</span>,<span class="hljs-number">984</span>,<span class="hljs-number">985</span>,<span class="hljs-number">986</span>,<span class="hljs-number">987</span>,<span class="hljs-number">988</span>,<span class="hljs-number">989</span>,<span class="hljs-number">990</span>,<span class="hljs-number">991</span>,<span class="hljs-number">992</span>,<span class="hljs-number">993</span>,<span class="hljs-number">994</span>,<span class="hljs-number">995</span>,<span class="hljs-number">996</span>,<span class="hljs-number">997</span>,<span class="hljs-number">998</span>,<span class="hljs-number">999</span>,<br></code></pre></td></tr></table></figure><p>并行执行执行时，总有一些数组（512）会出现在较小的节点上，通过在每次分裂时打印B+树的信息发现，错误总是发生在分裂前后，而后检查InsertIntoLeaf函数代码，发生判断节点是否安全的代码存在问题：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (tree_page-&gt;<span class="hljs-built_in">GetSize</span>() &lt; tree_page-&gt;<span class="hljs-built_in">GetMaxSize</span>()) &#123;<br>  <span class="hljs-built_in">ReleaseAncestorsPage</span>(&amp;ancestors, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>如果当前节点大小恰好为max_size-1，在插入一元素后将会发生分裂，进而修改父节点的值，故在这个时候不应该释放父节点的锁。<br>故修改为：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (tree_page-&gt;<span class="hljs-built_in">GetSize</span>() &lt; tree_page-&gt;<span class="hljs-built_in">GetMaxSize</span>()<span class="hljs-number">-1</span>) &#123;<br>  <span class="hljs-built_in">ReleaseAncestorsPage</span>(&amp;ancestors, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>4 MixTest测试时unpin和delete的断言失败<br><img src="https://img-blog.csdnimg.cn/8ed9f7c64a8d428c89a646f00c81a3c3.png" srcset="/img/loading.gif" lazyload><br>后面发现Page的id与TreePage的id有时候会不一样（例如上面的id 0），故unpin一律用TreePage的page id<br><img src="https://img-blog.csdnimg.cn/bd2bc2b811aa48958ac9bf8c49500d60.png" srcset="/img/loading.gif" lazyload><br>但还是没有彻底解决整个问题，Page的数据很奇怪，id&#x3D;0，is_dirty为123<br><img src="https://img-blog.csdnimg.cn/b8764f04017b476494d5f51443a89448.png" srcset="/img/loading.gif" lazyload><br>暂时没找到原因，以后有时间再看看。不过还是能通过所有测试</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%9B%BD%E5%A4%96%E8%AF%BE%E7%A8%8B%E5%AE%9E%E9%AA%8C/" class="category-chain-item">国外课程实验</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/15445-B-%E6%A0%91/" class="print-no-link">#15445 B+树</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/blog/%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95.html" title="内核驱动开发记录"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">内核驱动开发记录</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/blog/MIT6.S081%202021%20locks.html" title="MIT6.S081 2021 locks"><span class="hidden-mobile">MIT6.S081 2021 locks</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var e=Object.assign({appId:"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz",appKey:"0e2MMh7ddBCGGytOe9UEy5NP",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://uu0wegco.lc-cn-n1-shared.com",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(e),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var e="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(e),Fluid.plugins.fancyBox(e)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>