

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg">
  <link rel="icon" href="/img/nano-1.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="最佳损友1020">
  <meta name="keywords" content="">
  
    <meta name="description" content="汇总博客：MIT6.824 2022 Raftleader election不论是访问还是修改Raft可变类成员，都需要加锁 1234567rf.mu.Lock()if rf.state !&#x3D; Leader &amp;#123;	rf.mu.Unlock()	return&amp;#125;args :&#x3D; AppendEntriesArgs&amp;#123;Term: rf.currentTerm, Leade">
<meta property="og:type" content="article">
<meta property="og:title" content="mit6.824 2022 lab2">
<meta property="og:url" content="https://www.jiasun.top/blog/mit6.824%202022%20lab2.html">
<meta property="og:site_name" content="最佳损友1020’s Blog">
<meta property="og:description" content="汇总博客：MIT6.824 2022 Raftleader election不论是访问还是修改Raft可变类成员，都需要加锁 1234567rf.mu.Lock()if rf.state !&#x3D; Leader &amp;#123;	rf.mu.Unlock()	return&amp;#125;args :&#x3D; AppendEntriesArgs&amp;#123;Term: rf.currentTerm, Leade">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2189d1d34b6b48b09d5def1cba291f16.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/9919d13eaa954ecdaa8c3d91354a7c35.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/dc440bb8bbc045fb968d02a7e2db63cd.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a4411c3f559743afac952145f1b11608.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/b9b70d97e2044817911064486638f742.png">
<meta property="article:published_time" content="2022-11-22T12:32:59.000Z">
<meta property="article:modified_time" content="2023-10-31T14:45:59.315Z">
<meta property="article:author" content="最佳损友1020">
<meta property="article:tag" content="raft mit6.824 lab2">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/2189d1d34b6b48b09d5def1cba291f16.png">
  
  
  
  <title>mit6.824 2022 lab2 - 最佳损友1020’s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn.css">
<link rel="stylesheet" href="/css/top.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.jiasun.top","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz","app_key":"ljkRZDiTtVmjn5mpaQmpFqgv","server_url":"https://n227fxnj.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>最佳损友1020</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="mit6.824 2022 lab2"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-22 20:32" pubdate>
          2022年11月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">mit6.824 2022 lab2</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />



<p>汇总博客：<a href="https://www.jiasun.top/blog/mit6.824%202022.html">MIT6.824 2022</a></p>
<h1 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h1><h2 id="leader-election"><a href="#leader-election" class="headerlink" title="leader election"></a>leader election</h2><p>不论是访问还是修改Raft可变类成员，都需要加锁</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">rf.mu.Lock()<br><span class="hljs-keyword">if</span> rf.state != Leader &#123;<br>	rf.mu.Unlock()<br>	<span class="hljs-keyword">return</span><br>&#125;<br>args := AppendEntriesArgs&#123;Term: rf.currentTerm, LeaderId: rf.me&#125;<br>rf.mu.Unlock()<br></code></pre></td></tr></table></figure>
<p>可以改为</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">rf.mu.Lock()<br>flag := (rf.state == Leader)<br>args := AppendEntriesArgs&#123;Term: rf.currentTerm, LeaderId: rf.me&#125;<br>rf.mu.Unlock()<br><span class="hljs-keyword">if</span> !flag &#123;<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>2A时就尽可能实现更多功能，而不是仅仅通过测试，中文版论文用来大致了解raft算法，对照英文版论文编写代码。<br><strong>问题：</strong><br>RequestVote RPC中 at least as up-to-date对应于：</p>
<blockquote>
<p>Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs. If the logs have last entries with different terms, then the log with the later term is more up-to-date. If the logs end with the same term, then whichever log is longer is more up-to-date.</p>
</blockquote>
<p>由于是at least as，还包括相等的情况。</p>
<p>votedFor：candidateId that received vote in current term (or null if none)<br>当前任期接受到的选票的候选者 ID（初值为 null）<br>这意味着每当term改变，votedFor都需要重置。</p>
<p>If election timeout elapses without receiving AppendEntries RPC from current leader or granting vote to candidate: convert to candidate<br> 如果选举定时器超时时，没有收到 leader 的的追加日志请求 或者没有投票给候选者，该机器转化为候选者。<br> 注意不要忽略granting vote to candidate这一条<br>参考：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/142493568">MIT 6.824 Spring 2020 Lab2 Raft 实现笔记</a></p>
<h2 id="log"><a href="#log" class="headerlink" title="log"></a>log</h2><p>2B阶段实现起来没用多久，但一直在调试。发现vscode自带的调试功能挺好用的（go test插件？）<br><img src="https://img-blog.csdnimg.cn/2189d1d34b6b48b09d5def1cba291f16.png" srcset="/img/loading.gif" lazyload><br>一些细节：<br><strong>currentTerm</strong>： latest term server has seen (initialized to 0 on first boot, increases monotonically)<br>当前看到的最新任期，所以每当看到更大的任期，都需设置为该任期<br>If RPC request or response contains term T &gt; currentTerm: set currentTerm &#x3D; T, convert to follower<br><strong>votedFor</strong>：candidateId that received vote in current term (or null if none)<br>当前任期接收投票的候选者ID，所以任期改变时，votedFor也需要重置<br>**log[]**：log entries; each entry contains command for state machine, and term when entry was received by leader (first index is 1)<br>日志记录，起始索引为1，可以在初始化时加入term为0的假日志，便于程序统一处理（lastLogTerm  prevLogTerm）<br><strong>commitIndex</strong>：将被提交的日志记录索引，可以通过matchIndex拷贝后排序来得到新的commitIndex<br><strong>AppendEntries RPC</strong>：<br>rule3：只有现有条目与entries中的条目才需要删除其后所有日志，如果不冲突则不需要删除，注意比较时取二者索引较小值，以免数组越界<br>rule 5：index of last new entry而不是本地日志最大索引值，prevLogIndex+len（entries）<br>注意不需要对空日志进行特殊处理<br><strong>RequestVote RPC</strong>：<br>rule2两个条件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">condition1 := (rf.votedFor == InvalidId) || (rf.votedFor == args.CandidateId)<br>condition2 := (args.LastLogTerm &gt; lastLogTerm) || ((args.LastLogTerm == lastLogTerm) &amp;&amp; (args.LastLogIndex &gt;= lastLogIndex))<br></code></pre></td></tr></table></figure>
<p>遇到的一些问题：<br>问题表现：各节点一直在选举，却迟迟没有选出leader<br><img src="https://img-blog.csdnimg.cn/9919d13eaa954ecdaa8c3d91354a7c35.png" srcset="/img/loading.gif" lazyload><br>问题原因：写2A的时候没有对lastLogIndex lastLogTerm赋值，RequestVote在对比时一直通不过。</p>
<p>问题表现：测试刚显示通过，然后程序就runtime error，单独运行某个测试样例又无法复现<br>问题原因：没有考虑RPC调用的返回值就直接对reply结果进行处理</p>
<p>偶发性问题：<br>在明显的问题解决完后后，运行一次go test -run 2B -race显示全部通过，但执行脚本运行100次有时候却出现了几次错误。这种一定几率出现的问题就比较麻烦了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;1..100&#125;; <span class="hljs-keyword">do</span> go <span class="hljs-built_in">test</span> -run 2B -race; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Test (2B): concurrent Start()s ...<br>--- FAIL: TestConcurrentStarts2B (31.27s)<br>    config.go:549: only 1 decided <span class="hljs-keyword">for</span> index 6; wanted 3<br>Test (2B): RPC counts aren<span class="hljs-string">&#x27;t too high ...</span><br><span class="hljs-string">--- FAIL: TestCount2B (32.34s)</span><br><span class="hljs-string">    config.go:549: only 2 decided for index 11; wanted 3</span><br></code></pre></td></tr></table></figure>
<p>这种的一遍就需要先阅读一遍测试样例，并在样例合适的地方添加一些打印（有可能打印语句也会影响测试结果），并一次次点击测试按钮，思考问题原因了。</p>
<p>不过我另辟蹊径，懒得debug，直接把lab2前面建议的一些文章认真看了一遍（之前看太长就只是粗略地看了一遍）<br><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students’ Guide to Raft</a><br><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/raft-qa/">Raft Q&amp;A</a><br><a target="_blank" rel="noopener" href="https://blog.josejg.com/debugging-pretty/">Debugging by Pretty Printing</a><br><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/instructors-guide-to-raft/">Instructors’ Guide to Raft</a><br>发现我遇到的一些问题都在Students’ Guide to Raft提到了，不过我也对这些点记忆深刻了。<br><strong>Students’ Guide to Raft记录</strong><br>1 论文中的表述大多时候是must而不是should，例如不是说每当server接收RPC调用时都应该重置选举定时器，而是在receiving AppendEntries RPC from <strong>current leader</strong> or <strong>granting</strong> vote to candidate时候才重置选举定时器。<br>2 心跳信息不应该被视作特殊的一种消息，当follower接收了该心跳消息，则隐式地表明当前日志已于该server匹配，而后进行错误的提交。<br>3 当接收心跳消息后，简单地切断server日志prevLogIndex的部分，这同样是不对的，论文中的表述为<strong>If</strong> an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it，以上为一个条件语句。<br>4 当选举定时器过期后，即使上一任选举尚未完成，也应该进行下次的选举。<br>5 reply false意味着立即返回<br>6 AppendEntries处理过程中即使prevLogIndex对应位置条目不存在，同样视作日志不匹配<br>7 检查AppendEntries函数，即使entries为空也同样能执行成功，同样考虑本地日志越界的情况<br>8 认真理解last new entry与at least as up-to-date的含义<br>9 注意更新commitIndex时log[N].term &#x3D;&#x3D; currentTerm<br>10 nextIndex是乐观估计，matchIndex是悲观估计，即使在很多时候赋值都为nextIndex &#x3D; matchIndex + 1<br>11 在接收的旧的RPC回复时，比较当前term与arg中term，如果不一样，则直接返回，不进行处理</p>
<p>看完一遍文章后发现我的代码存在四个问题：<br>1：对心跳消息的回复进行特殊处理，只检查返回的term是否大于当前term，没有涉及到nextIndex与matchIndex的设置与重试。<br>2：对旧的RPC回复没有处理。<br>3：matchIndex没有保证单调递增<br>4：对于RPC调用失败直接返回而不是重试（return而不是continue）</p>
<p>1 对于心跳消息可以直接复用Start调用的日志协商函数，心跳消息同样可以用来同步各server的日志<br>2 在判断RPC是否成功之后，reply处理之前比对当前Term与参数Term，如果不一致则直接返回<br>3 避免matchIndex的后退</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">rf.matchIndex[server] = Max(rf.matchIndex[server], args.PrevLogIndex+<span class="hljs-built_in">len</span>(args.Entries))<br>rf.nextIndex[server] = rf.matchIndex[server] + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p>4 我认为论文中重试不是立即重试，而是等到定时器过期时再进行重试。<br>选举时RPC失败，则选举定时器过期，进行下一次选举时重试RequestVote RPC<br>协商时RPC失败，则心跳定时器过期，同步日志时重试AppendEntries RPC<br>故我认为应该直接返回，而且写成continue也会变成无限循环，不符合实际情况。</p>
<p>在执行1000次go test时，以上的两个问题都没再出现，而是出现data race的警告</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go">Test (<span class="hljs-number">2</span>B): leader backs up quickly over incorrect follower logs ...<br>==================<br>WARNING: DATA RACE<br>Write at <span class="hljs-number">0x00c0005b0988</span> by goroutine <span class="hljs-number">277</span>:<br>  runtime.slicecopy()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/runtime/slice.<span class="hljs-keyword">go</span>:<span class="hljs-number">197</span> +<span class="hljs-number">0x0</span><br>  <span class="hljs-number">6.824</span>/raft.(*Raft).AppendEntries()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">291</span> +<span class="hljs-number">0x663</span><br>  runtime.call32()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/runtime/asm_amd64.s:<span class="hljs-number">539</span> +<span class="hljs-number">0x3a</span><br>  reflect.Value.Call()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/reflect/value.<span class="hljs-keyword">go</span>:<span class="hljs-number">321</span> +<span class="hljs-number">0xd3</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Service).dispatch()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">496</span> +<span class="hljs-number">0x811</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Server).dispatch()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">420</span> +<span class="hljs-number">0x607</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Network).processReq.func1()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">240</span> +<span class="hljs-number">0x93</span><br><br>Previous read at <span class="hljs-number">0x00c0005b0988</span> by goroutine <span class="hljs-number">323</span>:<br>  encoding/gob.encInt()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/reflect/value.<span class="hljs-keyword">go</span>:<span class="hljs-number">976</span> +<span class="hljs-number">0x1df</span><br>  encoding/gob.(*Encoder).encodeStruct()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">328</span> +<span class="hljs-number">0x436</span><br>  encoding/gob.encOpFor.func4()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">581</span> +<span class="hljs-number">0xf0</span><br>  encoding/gob.(*Encoder).encodeArray()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">351</span> +<span class="hljs-number">0x26f</span><br>  encoding/gob.encOpFor.func1()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">551</span> +<span class="hljs-number">0x1a3</span><br>  encoding/gob.(*Encoder).encodeStruct()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">328</span> +<span class="hljs-number">0x436</span><br>  encoding/gob.(*Encoder).encode()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">701</span> +<span class="hljs-number">0x1fe</span><br>  encoding/gob.(*Encoder).EncodeValue()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encoder.<span class="hljs-keyword">go</span>:<span class="hljs-number">251</span> +<span class="hljs-number">0x666</span><br>  encoding/gob.(*Encoder).Encode()<br>      /usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/encoding/gob/encoder.<span class="hljs-keyword">go</span>:<span class="hljs-number">176</span> +<span class="hljs-number">0x5b</span><br>  <span class="hljs-number">6.824</span>/labgob.(*LabEncoder).Encode()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labgob/labgob.<span class="hljs-keyword">go</span>:<span class="hljs-number">36</span> +<span class="hljs-number">0x7b</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*ClientEnd).Call()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">93</span> +<span class="hljs-number">0x198</span><br>  <span class="hljs-number">6.824</span>/raft.(*Raft).sendAppendEntries()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">336</span> +<span class="hljs-number">0xd5</span><br>  <span class="hljs-number">6.824</span>/raft.(*Raft).agreementTask.func1()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">388</span> +<span class="hljs-number">0x562</span><br><br>Goroutine <span class="hljs-number">277</span> (running) created at:<br>  <span class="hljs-number">6.824</span>/labrpc.(*Network).processReq()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">239</span> +<span class="hljs-number">0x174</span><br><br>Goroutine <span class="hljs-number">323</span> (running) created at:<br>  <span class="hljs-number">6.824</span>/raft.(*Raft).agreementTask()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">376</span> +<span class="hljs-number">0xa3</span><br>==================<br>--- FAIL: TestBackup2B (<span class="hljs-number">16.85</span>s)<br>    testing.<span class="hljs-keyword">go</span>:<span class="hljs-number">853</span>: race detected during execution of test<br></code></pre></td></tr></table></figure>
<p>这个问题在于构建AppendEntries时entries对rf.log进行浅拷贝，在远程调用过程中会读取arg，如果该server一直为leader，其日志不会被更改，倒不会引发竞态问题。但当leader下台，日志就可以被更改，此时AppendEntries对日志进行修改，远程调用Call函数中读取该参数且未加rf.mu.lock，就引发了竞态问题，故应该对log进行深拷贝。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 错误的</span><br>args.Entries = rf.log[rf.nextIndex[server]:]<br><span class="hljs-comment">// 正确的</span><br>args.Entries = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[rf.nextIndex[server]:]...) <br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45901764/article/details/114703578">go语言为什么空切片，nil切片可以继续使用？append()函数</a><br>可以直接在bash脚本中设置次数为10000，啥时候不想跑crtl+z就可以了。</p>
<h2 id="persistence"><a href="#persistence" class="headerlink" title="persistence"></a>persistence</h2><p>2C编写的代码比较简单，只需要照着persist&#x2F;readPersist的example实现对应函数，然后在3个持久状态改变后调用persist函数。AppendEntries RPC的next index优化参照guidance中提供的方法</p>
<blockquote>
<p>The accelerated log backtracking optimization is very underspecified, probably because the authors do not see it as being necessary for most deployments. It is not clear from the text exactly how the conflicting index and term sent back from the client should be used by the leader to determine what nextIndex to use. We believe the protocol the authors probably want you to follow is:<br>If a follower does not have prevLogIndex in its log, it should return with conflictIndex &#x3D; len(log) and conflictTerm &#x3D; None.<br>If a follower does have prevLogIndex in its log, but the term does not match, it should return conflictTerm &#x3D; log[prevLogIndex].Term, and then search its log for <strong>the first index</strong> whose entry has term equal to conflictTerm.<br>Upon receiving a conflict response, the leader should first search its log for conflictTerm. If it finds an entry in its log with that term, it should set nextIndex to be the one beyond the index of <strong>the last entry</strong> in that term in its log.<br>If it does not find an entry with that term, it should set nextIndex &#x3D; conflictIndex.</p>
</blockquote>
<p>the one beyond the index不怎么能理解，就直接设置成最后一个等于该term的索引。next index只影响效率，不怎么影响正确性。如果2B没啥问题，2C也应该没啥问题，如果2C有问题，就应该运行几千次2B测试，验证一下。</p>
<p>问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">Test (2C): basic persistence ...<br>  ... Passed --   4.1  3  216   46172    6<br>Test (2C): more persistence ...<br>2022/10/30 06:44:20 next index retry. cur term:5 me:3 server:1 value:2   reply：term：-1  index:2<br>2022/10/30 06:44:20 next index retry. cur term:5 me:3 server:2 value:2   reply：term：-1  index:2<br>2022/10/30 06:44:22 next index retry. cur term:9 me:1 server:4 value:5   reply：term：-1  index:5<br>2022/10/30 06:44:22 next index retry. cur term:9 me:1 server:0 value:5   reply：term：-1  index:5<br>2022/10/30 06:44:24 next index retry. cur term:13 me:4 server:3 value:8   reply：term：-1  index:8<br>2022/10/30 06:44:24 next index retry. cur term:13 me:4 server:2 value:8   reply：term：-1  index:8<br>2022/10/30 06:44:29 next index retry. cur term:16 me:2 server:1 value:11   reply：term：-1  index:11<br>2022/10/30 06:44:29 next index retry. cur term:16 me:2 server:0 value:11   reply：term：-1  index:11<br>2022/10/30 06:44:31 next index retry. cur term:20 me:0 server:4 value:14   reply：term：-1  index:14<br>2022/10/30 06:44:31 next index retry. cur term:20 me:0 server:3 value:14   reply：term：-1  index:14<br>  ... Passed --  16.0  5  982  207944   16<br>Test (2C): partitioned leader and one follower crash, leader restarts ...<br>2022/10/30 06:44:35 next index retry. cur term:3 me:2 server:1 value:2   reply：term：-1  index:2<br>  ... Passed --   1.9  3   51   12120    4<br>Test (2C): Figure 8 ...<br>2022/10/30 06:44:37 next index retry. cur term:4 me:0 server:1 value:3   reply：term：-1  index:3<br>2022/10/30 06:44:41 next index retry. cur term:11 me:2 server:1 value:9   reply：term：-1  index:9<br>2022/10/30 06:44:41 next index retry. cur term:12 me:1 server:4 value:4   reply：term：-1  index:4<br>2022/10/30 06:44:41 next index retry. cur term:12 me:1 server:3 value:5   reply：term：-1  index:5<br>2022/10/30 06:44:43 next index retry. cur term:13 me:3 server:2 value:9   reply：term：8  index:9<br>2022/10/30 06:44:43 next index retry. cur term:14 me:4 server:1 value:10   reply：term：-1  index:10<br>2022/10/30 06:44:44 next index retry. cur term:15 me:2 server:3 value:11   reply：term：-1  index:11<br>2022/10/30 06:44:45 next index retry. cur term:16 me:3 server:0 value:10   reply：term：-1  index:10<br>2022/10/30 06:44:45 next index retry. cur term:16 me:3 server:0 value:9   reply：term：8  index:9<br>2022/10/30 06:44:46 next index retry. cur term:17 me:0 server:2 value:13   reply：term：-1  index:13<br>2022/10/30 06:44:47 next index retry. cur term:19 me:1 server:4 value:12   reply：term：-1  index:12<br>2022/10/30 06:44:48 next index retry. cur term:20 me:2 server:3 value:14   reply：term：-1  index:14<br>2022/10/30 06:44:49 next index retry. cur term:22 me:4 server:0 value:16   reply：term：-1  index:16<br>2022/10/30 06:44:50 next index retry. cur term:24 me:3 server:2 value:19   reply：term：-1  index:19<br>2022/10/30 06:44:52 next index retry. cur term:27 me:3 server:0 value:23   reply：term：-1  index:23<br>2022/10/30 06:44:52 next index retry. cur term:27 me:3 server:2 value:23   reply：term：-1  index:23<br>2022/10/30 06:44:53 next index retry. cur term:29 me:3 server:2 value:25   reply：term：-1  index:25<br>2022/10/30 06:44:53 next index retry. cur term:29 me:3 server:0 value:25   reply：term：-1  index:25<br>2022/10/30 06:44:54 next index retry. cur term:30 me:0 server:1 value:17   reply：term：-1  index:17<br>2022/10/30 06:44:54 next index retry. cur term:31 me:2 server:4 value:21   reply：term：-1  index:21<br>2022/10/30 06:44:55 next index retry. cur term:34 me:4 server:2 value:29   reply：term：-1  index:29<br>2022/10/30 06:44:55 next index retry. cur term:34 me:4 server:1 value:29   reply：term：-1  index:29<br>2022/10/30 06:44:57 next index retry. cur term:36 me:2 server:0 value:28   reply：term：-1  index:28<br>2022/10/30 06:44:58 next index retry. cur term:37 me:1 server:3 value:27   reply：term：-1  index:27<br>2022/10/30 06:44:58 next index retry. cur term:39 me:3 server:0 value:33   reply：term：-1  index:33<br>2022/10/30 06:44:58 next index retry. cur term:39 me:3 server:4 value:32   reply：term：-1  index:32<br>2022/10/30 06:44:59 next index retry. cur term:40 me:4 server:2 value:33   reply：term：-1  index:33<br>2022/10/30 06:45:00 next index retry. cur term:41 me:2 server:1 value:34   reply：term：-1  index:34<br>2022/10/30 06:45:01 next index retry. cur term:42 me:0 server:3 value:35   reply：term：-1  index:35<br>2022/10/30 06:45:02 next index retry. cur term:43 me:1 server:4 value:35   reply：term：40  index:35<br>2022/10/30 06:45:02 next index retry. cur term:43 me:1 server:3 value:35   reply：term：-1  index:35<br>race: <span class="hljs-built_in">limit</span> on 8128 simultaneously alive goroutines is exceeded, dying<br></code></pre></td></tr></table></figure>
<p>协程数目超出限制，参照Kill函数的注释，在每个定时任务中加入 !rf.killed()判断，以便在测试完成后退出协程。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//</span><br><span class="hljs-comment">// the tester doesn&#x27;t halt goroutines created by Raft after each test,</span><br><span class="hljs-comment">// but it does call the Kill() method. your code can use killed() to</span><br><span class="hljs-comment">// check whether Kill() has been called. the use of atomic avoids the</span><br><span class="hljs-comment">// need for a lock.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the issue is that long-running goroutines use memory and may chew</span><br><span class="hljs-comment">// up CPU time, perhaps causing later tests to fail and generating</span><br><span class="hljs-comment">// confusing debug output. any goroutine with a long-running loop</span><br><span class="hljs-comment">// should call killed() to check whether it should stop.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Kill() &#123;<br>	atomic.StoreInt32(&amp;rf.dead, <span class="hljs-number">1</span>)<br>	<span class="hljs-comment">// Your code here, if desired.</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 向各节点发送心跳消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> heartBeatTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		rf.mu.Lock()<br>		flag := (rf.state == Leader)<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> !flag &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-keyword">go</span> rf.agreementTask()<br>		time.Sleep(HeartBeatInterval)<br>	&#125;<br>&#125;<br><span class="hljs-comment">// 向server提交命令（存在错误，见下文）</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Submitter() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		rf.mu.Lock()<br>		<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.commitIndex &#123;<br>			rf.lastApplied++<br>			msg := ApplyMsg&#123;CommandValid: <span class="hljs-literal">true</span>, Command: rf.log[rf.lastApplied].Command, CommandIndex: rf.lastApplied&#125;<br>			rf.applyCh &lt;- msg<br>		&#125;<br>		rf.mu.Unlock()<br>		time.Sleep(<span class="hljs-number">10</span> * time.Millisecond)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="log-compaction"><a href="#log-compaction" class="headerlink" title="log compaction"></a>log compaction</h2><p>2D实现起来更多的是细节问题，是否将所有访问log的操作，访问log长度都修改为以某个数为起点的操作</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">访问index位置上的日志<br>rf.log[index]    -&gt;  rf.log[index-X]<br>日志长度/nextIndex<br><span class="hljs-built_in">len</span>(rf.log)      -&gt;  X+<span class="hljs-built_in">len</span>(rf.log)<br>本地日志最大索引<br><span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span>  -&gt;  X+<span class="hljs-built_in">len</span>(rf.log)<span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure>
<p>在2B实现中，我在log[0]处放置了一条term为0的假日志，便于统一处理。在2D修改日志起点的时候一直出问题，我突然想到可以直接在日志0位放置快照的最后一条记录，也就是X&#x3D;lastIncludeIndex，这样程序处理起来也比较一致。也就是说，快照为空时对应的lastInclude日志是初始化加入的假日志，其余时候均为真实快照的lastInclude日志（command成员不关心）。<br>我实现的2D的一些约束为</p>
<ol>
<li>日志永远不能为空</li>
<li>follower日志lastIncludeIndex&#x2F;commitIndex之前的term默认与leader的term匹配</li>
<li>在AppendEntries函数中ConflictIndex应大于lastIncludedIndex</li>
<li>在AppendEntriesRPC处理重传时，find same term的范围应该大于lastIncludedIndex</li>
<li>在同一个协程中apply快照与日志</li>
</ol>
<p>第一条很容易理解，无论如何，日志都应该存在一条lastIncludeIndex日志，故在InstallSnapshot的step7中虽然写的是discard the entire log，也要加上一条快照对应的lastIncludeIndex日志，Snapshot函数中，少删除一条日志，保证0位为lastIncludeIndex日志。</p>
<p>第二条 leader拥有所有已提交的日志，对于已提交日志相同索引的日志内容一致，所以没必要检查term（可用于AppendEntries中step2 preLogIndex 匹配与step3 different term），要时时刻刻想到这一点。</p>
<blockquote>
<p>Leader Completeness: if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.</p>
</blockquote>
<p>第三第四条实际上描述的事情差不多，日志0位的term最好只在RequestVote RPC相关的LastLogTerm被用到，preLogTerm可根据第二条规则默认匹配，nextIndex相关的操作不访问日志0位。</p>
<p>第五条实际上和以下这段提示有关，我刚开始虽然没实现一个CondInstallSnapshot，但实现了一个单独提交快照的函数，在接收到其他server的快照或重新Make时直接发送快照至service。在crash之前的测试还可以通过，一到crash测试就直接卡死，其他server一直无法访问crash的主机，显示RPC调用失败。</p>
<blockquote>
<p>Previously, this lab recommended that you implement a function called CondInstallSnapshot to avoid the requirement that snapshots and log entries sent on applyCh are coordinated. This vestigal API interface remains, but you are discouraged from implementing it: instead, we suggest that you simply have it return true.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// crash test测试函数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">snapcommon</span><span class="hljs-params">(t *testing.T, name <span class="hljs-type">string</span>, disconnect <span class="hljs-type">bool</span>, reliable <span class="hljs-type">bool</span>, crash <span class="hljs-type">bool</span>)</span></span> &#123;<br>	iters := <span class="hljs-number">30</span><br>	servers := <span class="hljs-number">3</span><br>	cfg := make_config(t, servers, !reliable, <span class="hljs-literal">true</span>)<br>	<span class="hljs-keyword">defer</span> cfg.cleanup()<br><br>	cfg.begin(name)<br><br>	cfg.one(rand.Int(), servers, <span class="hljs-literal">true</span>)<br>	leader1 := cfg.checkOneLeader()<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; iters; i++ &#123;<br>		victim := (leader1 + <span class="hljs-number">1</span>) % servers<br>		sender := leader1<br>		<span class="hljs-keyword">if</span> i%<span class="hljs-number">3</span> == <span class="hljs-number">1</span> &#123;<br>			sender = (leader1 + <span class="hljs-number">1</span>) % servers<br>			victim = leader1<br>		&#125;<br>		DPrintf(<span class="hljs-string">&quot;%v time,vicitm is %v\n&quot;</span>, i, victim)<br>		<span class="hljs-keyword">if</span> disconnect &#123;<br>			cfg.disconnect(victim)<br>			cfg.one(rand.Int(), servers<span class="hljs-number">-1</span>, <span class="hljs-literal">true</span>)<br>		&#125;<br>		<span class="hljs-keyword">if</span> crash &#123;<br>			cfg.crash1(victim)<br>			DPrintf(<span class="hljs-string">&quot;%v crash&quot;</span>, victim)<br>			cfg.one(rand.Int(), servers<span class="hljs-number">-1</span>, <span class="hljs-literal">true</span>)<br>		&#125;<br><br>		<span class="hljs-comment">// perhaps send enough to get a snapshot</span><br>		nn := (SnapShotInterval / <span class="hljs-number">2</span>) + (rand.Int() % SnapShotInterval)<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; nn; i++ &#123;<br>			cfg.rafts[sender].Start(rand.Int())<br>		&#125;<br><br>		<span class="hljs-comment">// let applier threads catch up with the Start()&#x27;s</span><br>		<span class="hljs-keyword">if</span> disconnect == <span class="hljs-literal">false</span> &amp;&amp; crash == <span class="hljs-literal">false</span> &#123;<br>			<span class="hljs-comment">// make sure all followers have caught up, so that</span><br>			<span class="hljs-comment">// an InstallSnapshot RPC isn&#x27;t required for</span><br>			<span class="hljs-comment">// TestSnapshotBasic2D().</span><br>			cfg.one(rand.Int(), servers, <span class="hljs-literal">true</span>)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			cfg.one(rand.Int(), servers<span class="hljs-number">-1</span>, <span class="hljs-literal">true</span>)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> cfg.LogSize() &gt;= MAXLOGSIZE &#123;<br>			cfg.t.Fatalf(<span class="hljs-string">&quot;Log size too large&quot;</span>)<br>		&#125;<br>		<span class="hljs-keyword">if</span> disconnect &#123;<br>			<span class="hljs-comment">// reconnect a follower, who maybe behind and</span><br>			<span class="hljs-comment">// needs to rceive a snapshot to catch up.</span><br>			cfg.connect(victim)<br>			cfg.one(rand.Int(), servers, <span class="hljs-literal">true</span>)<br>			leader1 = cfg.checkOneLeader()<br>		&#125;<br>		<span class="hljs-keyword">if</span> crash &#123;<br>			cfg.start1(victim, cfg.applierSnap)<br>			DPrintf(<span class="hljs-string">&quot;%v restart\n&quot;</span>, victim)<br>			cfg.connect(victim)<br>			cfg.one(rand.Int(), servers, <span class="hljs-literal">true</span>)<br>			leader1 = cfg.checkOneLeader()<br>		&#125;<br>	&#125;<br>	cfg.end()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在test_test.go添加打印后发现，vicitm server一直卡在crash和restart中间阶段，检查代码发现卡死在Make函数中发送快照至service的操作。故修改实现，接收到 InstallSnapshot RPC调用或重启时只修改commitIndex，不提交至service，只在一个协程中修改lastApplied。</p>
<p><strong>遇到的问题：</strong><br>一： 快照编码错误<br>在刚开始实现的时候，我将lastIncludeIndex和lastIncludeTerm持久化到Persister的snapshot成员中，一到crash测试就显示snapshot decode error。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Test (2D): install snapshots (crash) ...<br>2022/11/19 05:26:22 0 become leader<br>2022/11/19 05:26:24 2 become leader<br>2022/11/19 05:26:24 snapshot decode error<br><span class="hljs-built_in">exit</span> status 1<br></code></pre></td></tr></table></figure>
<p>阅读config.go相关代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 生成快照</span><br><span class="hljs-keyword">if</span> (m.CommandIndex+<span class="hljs-number">1</span>)%SnapShotInterval == <span class="hljs-number">0</span> &#123;<br>	w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>	e := labgob.NewEncoder(w)<br>	e.Encode(m.CommandIndex)<br>	<span class="hljs-keyword">var</span> xlog []<span class="hljs-keyword">interface</span>&#123;&#125;<br>	<span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt;= m.CommandIndex; j++ &#123;<br>		xlog = <span class="hljs-built_in">append</span>(xlog, cfg.logs[i][j])<br>	&#125;<br>	e.Encode(xlog)<br>	rf.Snapshot(m.CommandIndex, w.Bytes())<br>&#125;<br><span class="hljs-comment">// 读取快照</span><br><span class="hljs-keyword">if</span> cfg.saved[i] != <span class="hljs-literal">nil</span> &#123;<br>	cfg.saved[i] = cfg.saved[i].Copy()<br><br>	snapshot := cfg.saved[i].ReadSnapshot()<br>	<span class="hljs-keyword">if</span> snapshot != <span class="hljs-literal">nil</span> &amp;&amp; <span class="hljs-built_in">len</span>(snapshot) &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// mimic KV server and process snapshot now.</span><br>		<span class="hljs-comment">// ideally Raft should send it up on applyCh...</span><br>		err := cfg.ingestSnap(i, snapshot, <span class="hljs-number">-1</span>)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-string">&quot;&quot;</span> &#123;<br>			cfg.t.Fatal(err)<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cfg *config)</span></span> ingestSnap(i <span class="hljs-type">int</span>, snapshot []<span class="hljs-type">byte</span>, index <span class="hljs-type">int</span>) <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">if</span> snapshot == <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;nil snapshot&quot;</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nil snapshot&quot;</span><br>	&#125;<br>	r := bytes.NewBuffer(snapshot)<br>	d := labgob.NewDecoder(r)<br>	<span class="hljs-keyword">var</span> lastIncludedIndex <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> xlog []<span class="hljs-keyword">interface</span>&#123;&#125;<br>	<span class="hljs-keyword">if</span> d.Decode(&amp;lastIncludedIndex) != <span class="hljs-literal">nil</span> ||<br>		d.Decode(&amp;xlog) != <span class="hljs-literal">nil</span> &#123;<br>		log.Panic()<br>		log.Fatalf(<span class="hljs-string">&quot;snapshot decode error&quot;</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;snapshot Decode() error&quot;</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> index != <span class="hljs-number">-1</span> &amp;&amp; index != lastIncludedIndex &#123;<br>		err := fmt.Sprintf(<span class="hljs-string">&quot;server %v snapshot doesn&#x27;t match m.SnapshotIndex&quot;</span>, i)<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	cfg.logs[i] = <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>	<span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(xlog); j++ &#123;<br>		cfg.logs[i][j] = xlog[j]<br>	&#125;<br>	cfg.lastApplied[i] = lastIncludedIndex<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看出snapshot成员只应该是上层生成的快照，不应该加上其他状态，所有的状态都编码到raftstate成员中；另外快照中还额外编码了lastIncludedIndex。</p>
<p>二：InstallSnapshot RPC理解错误</p>
<blockquote>
<p>If existing log entry has same index and term as snapshot’s last included entry, retain log entries following it and reply</p>
</blockquote>
<p>对于InstallSnapshot RPC的step 6理解错误，理解成是否存在相同的快照，比对lastIncludeIndex与lastIncludeTerm去了。实际上直接检查相同index term是否一致即可，commit之前默认一致。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">logIndex := args.LastIncludedIndex - rf.lastIncludedIndex<br><span class="hljs-keyword">if</span> logIndex &lt; <span class="hljs-number">0</span> &#123;<br>	WPrintf(<span class="hljs-string">&quot;server snapshot is newer. server id:%v lastIncludedIndex:%v  log len:%v\n&quot;</span>, rf.me, rf.lastIncludedIndex, <span class="hljs-built_in">len</span>(rf.log))<br>	<span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> logIndex &lt; <span class="hljs-built_in">len</span>(rf.log) &amp;&amp; rf.log[logIndex].Term == args.LastIncludedTerm &#123; <span class="hljs-comment">// step 5</span><br>	DPrintf(<span class="hljs-string">&quot;same log entry. server id:%v lastIncludedIndex:%v  log len:%v\n&quot;</span>, rf.me, rf.lastIncludedIndex, <span class="hljs-built_in">len</span>(rf.log))<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>第一个分支从来没打印过</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">DPrintf打印一些普通信息<br>WPrintf打印一些异常情况<br>log.Panicf打印一些逻辑错误情况<br></code></pre></td></tr></table></figure>
<p>记得时不时commit一下，便于查看代码修改情况。</p>
<p>三：没看出具体作用的修改<br>1 垃圾回收</p>
<blockquote>
<p>Raft must discard old log entries in a way that allows the Go garbage collector to free and re-use the memory; this requires that there be no reachable references (pointers) to the discarded log entries.</p>
</blockquote>
<p>进行如下语句的替换</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// rf.log = rf.log[index-rf.lastIncludedIndex:]</span><br>rf.log = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[index-rf.lastIncludedIndex:]...)<br></code></pre></td></tr></table></figure>
<p>很多博客都使用copy来实现深拷贝，以指向不同的底层数组，但我觉得用append更方便一点。<br><a target="_blank" rel="noopener" href="https://geektutu.com/post/hpg-slice.html">切片(slice)性能及陷阱</a></p>
<p>2 </p>
<blockquote>
<p>If, when the server comes back up, it reads the updated snapshot, but the outdated log, it may end up applying some log entries that are already contained within the snapshot. This happens since the commitIndex and lastApplied are not persisted, and so Raft doesn’t know that those log entries have already been applied. The fix for this is to introduce a piece of persistent state to Raft that records what “real” index the first entry in Raft’s persisted log corresponds to. This can then be compared to the loaded snapshot’s lastIncludedIndex to determine what elements at the head of the log to discard.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students’ Guide to Raft</a><br>比对快照编码的lastIncludeIndex与state中的lastIncludeIndex，去掉一些日志</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> compareStateAndSnapshot() &#123;<br>	<span class="hljs-keyword">if</span> rf.snapshot == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(rf.snapshot) &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	r := bytes.NewBuffer(rf.snapshot)<br>	d := labgob.NewDecoder(r)<br>	<span class="hljs-keyword">var</span> lastIncludedIndex <span class="hljs-type">int</span><br>	<span class="hljs-keyword">if</span> d.Decode(&amp;lastIncludedIndex) != <span class="hljs-literal">nil</span> &#123;<br>		log.Panicf(<span class="hljs-string">&quot;compareStateAndSnapshot: snapshot decode error&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> rf.lastIncludedIndex != lastIncludedIndex &#123;<br>		WPrintf(<span class="hljs-string">&quot;snapshot lastIncludedIndex is different. snapshot:%v  state:%v\n&quot;</span>, lastIncludedIndex, rf.lastIncludedIndex)<br>		rf.log = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[lastIncludedIndex-rf.lastIncludedIndex:]...)<br>		rf.lastIncludedIndex = lastIncludedIndex<br>		rf.lastIncludedTerm = rf.log[<span class="hljs-number">0</span>].Term <span class="hljs-comment">// 日志0位的term</span><br>		rf.commitIndex = rf.lastIncludedIndex<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>没啥用，WPrintf语句没打印过</p>
<p><strong>由于3B在快照中编码了其他数据，也就不再做这个比较了</strong><br>四：不知道有没有用的修改<br>在2D测试跑通后跑全部的测试，其中几次在2D的各个测试出现了panic: test timed out after 10m0s问题，看了看打印的goroutine堆栈，发现许多goroutine都在获取锁，并且apply协程阻塞在通道发送那一步（在当时实现中此时该线程持有锁），觉得有可能是service没有接收ApplyMsg，导致server一直无法推进，故修改提交协程实现，在发送消息时不持有锁。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 向service发送命令（仍然存在问题，见下文）</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> applyTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		<span class="hljs-keyword">var</span> msg ApplyMsg<br>		sendMsg := <span class="hljs-literal">false</span><br>		rf.mu.Lock()<br>		<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.commitIndex &#123;<br>			sendMsg = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.lastIncludedIndex &#123;<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">false</span>, SnapshotValid: <span class="hljs-literal">true</span>, Snapshot: rf.snapshot, SnapshotIndex: rf.lastIncludedIndex, SnapshotTerm: rf.lastIncludedTerm&#125;<br>				DPrintf(<span class="hljs-string">&quot;applySnapshot. server id:%v commitIndex:%v  lastApplied:%v  lastIncludedIndex:%v\n&quot;</span>, rf.me, rf.commitIndex, rf.lastApplied, rf.lastIncludedIndex)<br>				rf.lastApplied = rf.lastIncludedIndex<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				rf.lastApplied++<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">true</span>, Command: rf.log[rf.lastApplied-rf.lastIncludedIndex].Command, CommandIndex: rf.lastApplied&#125;<br>			&#125;<br>		&#125;<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> sendMsg &#123;<br>			rf.applyCh &lt;- msg<br>		&#125;<br>		time.Sleep(<span class="hljs-number">10</span> * time.Millisecond)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>不过有没有真的解决问题我也不知道，反正之后测试没再出现这个问题了。<br><strong>这个实验最麻烦的一点就在于永远不知道是否真正解决了某个问题</strong>，在2B阶段有时候测试到一千多次才出现错误，都有点无从调试，只能看看raft论文，Students’ Guide，自我完善一下代码，并时时检查一些关键变量，打印一些异常情况。</p>
<h2 id="整体测试"><a href="#整体测试" class="headerlink" title="整体测试"></a>整体测试</h2><p>在基本写完ABCD阶段后，再看一遍相关文章，重新看一遍代码，写一些注释，跑上一天全部测试，如果没有错就当lab2实现完成了（有限的正确性保证）。<br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-raft.html">6.824 Lab 2: Raft</a><br><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students’ Guide to Raft</a><br><a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/raft-qa/">Raft Q&amp;A</a><br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt">Raft Locking Advice</a><br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/raft-structure.txt">Raft Structure Advice</a><br><a target="_blank" rel="noopener" href="https://blog.josejg.com/debugging-pretty/">Debugging by Pretty Printing</a><br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/guidance.html">Lab guidance</a></p>
<p>摘录一些片段加深印象：</p>
<blockquote>
<p>Rule 1: Whenever you have data that more than one goroutine uses, and at least one goroutine might modify the data, the goroutines should use locks to prevent simultaneous use of the data.</p>
<p>Rule 2: Whenever code makes a sequence of modifications to shared data, and other goroutines might malfunction if they looked at the data midway through the sequence, you should use a lock around the whole sequence.<br>Rule 3: Whenever code does a sequence of reads of shared data (orreads and writes), and would malfunction if another goroutine modified the data midway through the sequence, you should use a lock around the whole sequence.<br>Rule 4: It’s usually a bad idea to hold a lock while doing anything that might wait: reading a Go channel, sending on a channel, waiting for a timer, calling time.Sleep(), or sending an RPC (and waiting for the reply).<br>Rule 5: Be careful about assumptions across a drop and re-acquire of a lock. One place this can arise is when avoiding waiting with locks held.</p>
</blockquote>
<blockquote>
<p>commitIndex is volatile because Raft can figure out a correct value for it after a reboot using just the persistent state. Once a leader successfully gets a new log entry committed, it knows everything before that point is also committed. A follower that crashes and comes back up will be told about the right commitIndex whenever the current leader sends it an AppendEntries RPC.</p>
</blockquote>
<blockquote>
<p>lastApplied starts at zero after a reboot because <strong>the Figure 2 design assumes the service (e.g., a key&#x2F;value database) doesn’t keep any persistent state.</strong> Thus its state needs to be completely recreated by replaying all log entries. If the service does keep persistent state, it is expected to persistently remember how far in the log it has executed, and to ignore entries before that point. Either way it’s safe to start with lastApplied &#x3D; 0 after a reboot.</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/dc440bb8bbc045fb968d02a7e2db63cd.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/a4411c3f559743afac952145f1b11608.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img-blog.csdnimg.cn/b9b70d97e2044817911064486638f742.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>Instead, the best approach is usually to work backwards and narrow down the size of phase 2 until it is as small as possible, so that the location of the fault is readily apparent. This is done by expanding the instrumentation of your code to surface errors sooner, and thereby spend less time in phase 2. This generally involves adding additional debugging statements and&#x2F;or assertions to your code.</p>
</blockquote>
<blockquote>
<p>When possible, consider writing your code to “fail loudly”. Instead of trying to tolerate unexpected states, try to explicitly detect states that should never be allowed to happen, and immediately report these errors. Consider even immediately calling the Go ‘panic’ function in these cases to fail especially loudly. See also the Wikipedia page on Offensive programming techniques. Remember that the longer you allow errors to remain latent, the longer it will take to narrow down the true underlying fault.</p>
</blockquote>
<blockquote>
<p>When you’re failing a test, and it’s not obvious why, it’s usually worth taking the time to understand what the test is actually doing, and which part of the test is observing the problem. It can be helpful to add print statements to the test code so that you know when events are happening.</p>
</blockquote>
<p>注意检查是否所有持久状态改变时都调用了persist函数，快照改变时都调用了SaveStateAndSnapshot函数。<br>每个server commit index之前的日志都一模一样且无法更改</p>
<p><strong>遇到的问题：</strong><br>2D时为解决panic: test timed out after 10m0s问题，向service发送消息时不再持有锁</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 向service发送命令</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> applyTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		<span class="hljs-keyword">var</span> msg ApplyMsg<br>		sendMsg := <span class="hljs-literal">false</span><br>		rf.mu.Lock()<br>		<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.commitIndex &#123;<br>			sendMsg = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.lastIncludedIndex &#123;<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">false</span>, SnapshotValid: <span class="hljs-literal">true</span>, Snapshot: rf.snapshot, SnapshotIndex: rf.lastIncludedIndex, SnapshotTerm: rf.lastIncludedTerm&#125;<br>				DPrintf(<span class="hljs-string">&quot;applySnapshot. server id:%v commitIndex:%v  lastApplied:%v  lastIncludedIndex:%v\n&quot;</span>, rf.me, rf.commitIndex, rf.lastApplied, rf.lastIncludedIndex)<br>				rf.lastApplied = rf.lastIncludedIndex<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				rf.lastApplied++<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">true</span>, Command: rf.log[rf.lastApplied-rf.lastIncludedIndex].Command, CommandIndex: rf.lastApplied&#125;<br>			&#125;<br>		&#125;<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> sendMsg &#123;<br>			rf.applyCh &lt;- msg<br>		&#125;<br>		time.Sleep(<span class="hljs-number">10</span> * time.Millisecond)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后运行所有测试样例，TestReliableChurn2C时不时报以下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">config.go:628: one(6739062427422661052) failed to reach agreement<br></code></pre></td></tr></table></figure>
<p>在相应的语句前面加上log.Panicf语句，显示调用栈</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go">goroutine <span class="hljs-number">19</span> [running]:<br>testing.tRunner.func1(<span class="hljs-number">0xc0000e6100</span>)<br>	/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/testing/testing.<span class="hljs-keyword">go</span>:<span class="hljs-number">874</span> +<span class="hljs-number">0x3a3</span><br><span class="hljs-built_in">panic</span>(<span class="hljs-number">0x5b28c0</span>, <span class="hljs-number">0xc00031ec50</span>)<br>	/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/runtime/<span class="hljs-built_in">panic</span>.<span class="hljs-keyword">go</span>:<span class="hljs-number">679</span> +<span class="hljs-number">0x1b2</span><br>log.Panicf(<span class="hljs-number">0x604122</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0xc000127d70</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x1</span>)<br>	/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/log/log.<span class="hljs-keyword">go</span>:<span class="hljs-number">345</span> +<span class="hljs-number">0xc0</span><br><span class="hljs-number">6.824</span>/raft.(*config).one(<span class="hljs-number">0xc0000e2140</span>, <span class="hljs-number">0x5b1d40</span>, <span class="hljs-number">0xc0002c7188</span>, <span class="hljs-number">0x5</span>, <span class="hljs-number">0x301</span>, <span class="hljs-number">0xc0009f2000</span>)<br>	/root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/config.<span class="hljs-keyword">go</span>:<span class="hljs-number">628</span> +<span class="hljs-number">0x73b</span><br><span class="hljs-number">6.824</span>/raft.internalChurn(<span class="hljs-number">0xc0000e6100</span>, <span class="hljs-number">0xbf8db3b4c200</span>)<br>	/root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/test_test.<span class="hljs-keyword">go</span>:<span class="hljs-number">1079</span> +<span class="hljs-number">0xace</span><br><span class="hljs-number">6.824</span>/raft.TestReliableChurn2C(<span class="hljs-number">0xc0000e6100</span>)<br>	/root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/test_test.<span class="hljs-keyword">go</span>:<span class="hljs-number">1107</span> +<span class="hljs-number">0x30</span><br>testing.tRunner(<span class="hljs-number">0xc0000e6100</span>, <span class="hljs-number">0x609aa8</span>)<br>	/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/testing/testing.<span class="hljs-keyword">go</span>:<span class="hljs-number">909</span> +<span class="hljs-number">0xc9</span><br>created by testing.(*T).Run<br>	/usr/lib/<span class="hljs-keyword">go</span><span class="hljs-number">-1.13</span>/src/testing/testing.<span class="hljs-keyword">go</span>:<span class="hljs-number">960</span> +<span class="hljs-number">0x350</span><br>exit status <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 测试函数 协商某项日志</span><br><span class="hljs-comment">// do a complete agreement.</span><br><span class="hljs-comment">// it might choose the wrong leader initially,</span><br><span class="hljs-comment">// and have to re-submit after giving up.</span><br><span class="hljs-comment">// entirely gives up after about 10 seconds.</span><br><span class="hljs-comment">// indirectly checks that the servers agree on the</span><br><span class="hljs-comment">// same value, since nCommitted() checks this,</span><br><span class="hljs-comment">// as do the threads that read from applyCh.</span><br><span class="hljs-comment">// returns index.</span><br><span class="hljs-comment">// if retry==true, may submit the command multiple</span><br><span class="hljs-comment">// times, in case a leader fails just after Start().</span><br><span class="hljs-comment">// if retry==false, calls Start() only once, in order</span><br><span class="hljs-comment">// to simplify the early Lab 2B tests.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cfg *config)</span></span> one(cmd <span class="hljs-keyword">interface</span>&#123;&#125;, expectedServers <span class="hljs-type">int</span>, retry <span class="hljs-type">bool</span>) <span class="hljs-type">int</span> &#123;<br>	t0 := time.Now()<br>	starts := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> time.Since(t0).Seconds() &lt; <span class="hljs-number">10</span> &amp;&amp; cfg.checkFinished() == <span class="hljs-literal">false</span> &#123;<br>		<span class="hljs-comment">// try all the servers, maybe one is the leader.</span><br>		index := <span class="hljs-number">-1</span><br>		<span class="hljs-keyword">for</span> si := <span class="hljs-number">0</span>; si &lt; cfg.n; si++ &#123;<br>			starts = (starts + <span class="hljs-number">1</span>) % cfg.n<br>			<span class="hljs-keyword">var</span> rf *Raft<br>			cfg.mu.Lock()<br>			<span class="hljs-keyword">if</span> cfg.connected[starts] &#123;<br>				rf = cfg.rafts[starts]<br>			&#125;<br>			cfg.mu.Unlock()<br>			<span class="hljs-keyword">if</span> rf != <span class="hljs-literal">nil</span> &#123;<br>				index1, _, ok := rf.Start(cmd)<br>				<span class="hljs-keyword">if</span> ok &#123;<br>					index = index1<br>					<span class="hljs-keyword">break</span><br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">if</span> index != <span class="hljs-number">-1</span> &#123;<br>			<span class="hljs-comment">// somebody claimed to be the leader and to have</span><br>			<span class="hljs-comment">// submitted our command; wait a while for agreement.</span><br>			t1 := time.Now()<br>			<span class="hljs-keyword">for</span> time.Since(t1).Seconds() &lt; <span class="hljs-number">2</span> &#123;<br>				nd, cmd1 := cfg.nCommitted(index)<br>				<span class="hljs-keyword">if</span> nd &gt; <span class="hljs-number">0</span> &amp;&amp; nd &gt;= expectedServers &#123;<br>					<span class="hljs-comment">// committed</span><br>					<span class="hljs-keyword">if</span> cmd1 == cmd &#123;<br>						<span class="hljs-comment">// and it was the command we submitted.</span><br>						<span class="hljs-keyword">return</span> index<br>					&#125;<br>				&#125;<br>				time.Sleep(<span class="hljs-number">20</span> * time.Millisecond)<br>			&#125;<br>			<span class="hljs-keyword">if</span> retry == <span class="hljs-literal">false</span> &#123;<br>				cfg.t.Fatalf(<span class="hljs-string">&quot;one(%v) failed to reach agreement&quot;</span>, cmd)<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			time.Sleep(<span class="hljs-number">50</span> * time.Millisecond)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> cfg.checkFinished() == <span class="hljs-literal">false</span> &#123;<br>		<span class="hljs-keyword">for</span> si := <span class="hljs-number">0</span>; si &lt; cfg.n; si++ &#123;<br>			starts = (starts + <span class="hljs-number">1</span>) % cfg.n<br>			<span class="hljs-keyword">var</span> rf *Raft<br>			cfg.mu.Lock()<br>			<span class="hljs-keyword">if</span> cfg.connected[starts] &#123;<br>				rf = cfg.rafts[starts]<br>			&#125;<br>			cfg.mu.Unlock()<br>			<span class="hljs-keyword">if</span> rf != <span class="hljs-literal">nil</span> &#123;<br>				rf.mu.Lock()<br>				DPrintf(<span class="hljs-string">&quot;%+v&quot;</span>, rf)<br>				rf.mu.Unlock()<br>			&#125;<br>		&#125;<br>		log.Panicf(<span class="hljs-string">&quot;one(%v) failed to reach agreement&quot;</span>, cmd)<br>		cfg.t.Fatalf(<span class="hljs-string">&quot;one(%v) failed to reach agreement&quot;</span>, cmd)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">internalChurn</span><span class="hljs-params">(t *testing.T, unreliable <span class="hljs-type">bool</span>)</span></span> &#123;<br><br>	servers := <span class="hljs-number">5</span><br>	cfg := make_config(t, servers, unreliable, <span class="hljs-literal">false</span>)<br>	<span class="hljs-keyword">defer</span> cfg.cleanup()<br><br>	<span class="hljs-keyword">if</span> unreliable &#123;<br>		cfg.begin(<span class="hljs-string">&quot;Test (2C): unreliable churn&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		cfg.begin(<span class="hljs-string">&quot;Test (2C): churn&quot;</span>)<br>	&#125;<br><br>	stop := <span class="hljs-type">int32</span>(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment">// create concurrent clients</span><br>	cfn := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(me <span class="hljs-type">int</span>, ch <span class="hljs-keyword">chan</span> []<span class="hljs-type">int</span>)</span></span> &#123;<br>		<span class="hljs-keyword">var</span> ret []<span class="hljs-type">int</span><br>		ret = <span class="hljs-literal">nil</span><br>		<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; ch &lt;- ret &#125;()<br>		values := []<span class="hljs-type">int</span>&#123;&#125;<br>		<span class="hljs-keyword">for</span> atomic.LoadInt32(&amp;stop) == <span class="hljs-number">0</span> &#123;<br>			x := rand.Int()<br>			index := <span class="hljs-number">-1</span><br>			ok := <span class="hljs-literal">false</span><br>			<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; servers; i++ &#123;<br>				<span class="hljs-comment">// try them all, maybe one of them is a leader</span><br>				cfg.mu.Lock()<br>				rf := cfg.rafts[i]<br>				cfg.mu.Unlock()<br>				<span class="hljs-keyword">if</span> rf != <span class="hljs-literal">nil</span> &#123;<br>					index1, _, ok1 := rf.Start(x)<br>					<span class="hljs-keyword">if</span> ok1 &#123;<br>						ok = ok1<br>						index = index1<br>					&#125;<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">if</span> ok &#123;<br>				<span class="hljs-comment">// maybe leader will commit our value, maybe not.</span><br>				<span class="hljs-comment">// but don&#x27;t wait forever.</span><br>				<span class="hljs-keyword">for</span> _, to := <span class="hljs-keyword">range</span> []<span class="hljs-type">int</span>&#123;<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>&#125; &#123;<br>					nd, cmd := cfg.nCommitted(index)<br>					<span class="hljs-keyword">if</span> nd &gt; <span class="hljs-number">0</span> &#123;<br>						<span class="hljs-keyword">if</span> xx, ok := cmd.(<span class="hljs-type">int</span>); ok &#123;<br>							<span class="hljs-keyword">if</span> xx == x &#123;<br>								values = <span class="hljs-built_in">append</span>(values, x)<br>							&#125;<br>						&#125; <span class="hljs-keyword">else</span> &#123;<br>							cfg.t.Fatalf(<span class="hljs-string">&quot;wrong command type&quot;</span>)<br>						&#125;<br>						<span class="hljs-keyword">break</span><br>					&#125;<br>					time.Sleep(time.Duration(to) * time.Millisecond)<br>				&#125;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				time.Sleep(time.Duration(<span class="hljs-number">79</span>+me*<span class="hljs-number">17</span>) * time.Millisecond)<br>			&#125;<br>		&#125;<br>		ret = values<br>	&#125;<br><br>	ncli := <span class="hljs-number">3</span><br>	cha := []<span class="hljs-keyword">chan</span> []<span class="hljs-type">int</span>&#123;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; ncli; i++ &#123;<br>		cha = <span class="hljs-built_in">append</span>(cha, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-type">int</span>))<br>		<span class="hljs-keyword">go</span> cfn(i, cha[i])<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> iters := <span class="hljs-number">0</span>; iters &lt; <span class="hljs-number">20</span>; iters++ &#123;<br>		<span class="hljs-keyword">if</span> (rand.Int() % <span class="hljs-number">1000</span>) &lt; <span class="hljs-number">200</span> &#123;<br>			i := rand.Int() % servers<br>			cfg.disconnect(i)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (rand.Int() % <span class="hljs-number">1000</span>) &lt; <span class="hljs-number">500</span> &#123;<br>			i := rand.Int() % servers<br>			<span class="hljs-keyword">if</span> cfg.rafts[i] == <span class="hljs-literal">nil</span> &#123;<br>				cfg.start1(i, cfg.applier)<br>			&#125;<br>			cfg.connect(i)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (rand.Int() % <span class="hljs-number">1000</span>) &lt; <span class="hljs-number">200</span> &#123;<br>			i := rand.Int() % servers<br>			<span class="hljs-keyword">if</span> cfg.rafts[i] != <span class="hljs-literal">nil</span> &#123;<br>				cfg.crash1(i)<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Make crash/restart infrequent enough that the peers can often</span><br>		<span class="hljs-comment">// keep up, but not so infrequent that everything has settled</span><br>		<span class="hljs-comment">// down from one change to the next. Pick a value smaller than</span><br>		<span class="hljs-comment">// the election timeout, but not hugely smaller.</span><br>		time.Sleep((RaftElectionTimeout * <span class="hljs-number">7</span>) / <span class="hljs-number">10</span>)<br>	&#125;<br><br>	time.Sleep(RaftElectionTimeout)<br>	cfg.setunreliable(<span class="hljs-literal">false</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; servers; i++ &#123;<br>		<span class="hljs-keyword">if</span> cfg.rafts[i] == <span class="hljs-literal">nil</span> &#123;<br>			cfg.start1(i, cfg.applier)<br>		&#125;<br>		cfg.connect(i)<br>	&#125;<br><br>	atomic.StoreInt32(&amp;stop, <span class="hljs-number">1</span>)<br><br>	values := []<span class="hljs-type">int</span>&#123;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; ncli; i++ &#123;<br>		vv := &lt;-cha[i]<br>		<span class="hljs-keyword">if</span> vv == <span class="hljs-literal">nil</span> &#123;<br>			t.Fatal(<span class="hljs-string">&quot;client failed&quot;</span>)<br>		&#125;<br>		values = <span class="hljs-built_in">append</span>(values, vv...)<br>	&#125;<br><br>	time.Sleep(RaftElectionTimeout)<br><br>	lastIndex := cfg.one(rand.Int(), servers, <span class="hljs-literal">true</span>)<br></code></pre></td></tr></table></figure>
<p>发现停留在lastIndex这行语句中，其中的expectedServers参数为servers，即所有server都需提交命令成功。<br>在出错前打印的DPrintf(“%+v”, rf)语句显示信息中可以看到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">commitIndex:1153 lastApplied:996 nextIndex:[] matchIndex:[] state:0 leaderId:2<br>commitIndex:1153 lastApplied:1153 nextIndex:[] matchIndex:[] state:0 leaderId:2<br>commitIndex:1153 lastApplied:1153 nextIndex:[] matchIndex:[] state:0 leaderId:2<br>commitIndex:1153 lastApplied:1153 nextIndex:[] matchIndex:[] state:0 leaderId:2<br>commitIndex:1153 lastApplied:1153 nextIndex:[1154 1154 1154 1154 1154] matchIndex:[1153 1153 1153 1153 1153] state:2 leaderId:2<br></code></pre></td></tr></table></figure>
<p>实际上有一个server commitIndex已经变成了1153，只不过还没来得及发送至service，故简单修改一下applyTask，不再是发送一次就休眠，变成本次成功发送则再进行一次尝试。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 向service发送命令</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> applyTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		<span class="hljs-keyword">var</span> msg ApplyMsg<br>		sendMsg := <span class="hljs-literal">false</span><br>		rf.mu.Lock()<br>		<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.commitIndex &#123;<br>			sendMsg = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.lastIncludedIndex &#123; <span class="hljs-comment">// 发送快照</span><br>				rf.lastApplied = rf.lastIncludedIndex<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">false</span>, SnapshotValid: <span class="hljs-literal">true</span>, Snapshot: rf.snapshot, SnapshotIndex: rf.lastIncludedIndex, SnapshotTerm: rf.lastIncludedTerm&#125;<br>				DPrintf(<span class="hljs-string">&quot;applySnapshot. server id:%v commitIndex:%v  lastApplied:%v  lastIncludedIndex:%v\n&quot;</span>, rf.me, rf.commitIndex, rf.lastApplied, rf.lastIncludedIndex)<br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 发送日志</span><br>				rf.lastApplied++<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">true</span>, Command: rf.log[rf.lastApplied-rf.lastIncludedIndex].Command, CommandIndex: rf.lastApplied&#125;<br>			&#125;<br>		&#125;<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> sendMsg &#123; <span class="hljs-comment">// 向service发送消息</span><br>			rf.applyCh &lt;- msg<br>		&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 此次未发送消息，休眠10ms后再次查询</span><br>			time.Sleep(<span class="hljs-number">10</span> * time.Millisecond)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>跑了一天测试，233次PASS，lab2基本正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">Test (2A): initial election ...<br>  ... Passed --   3.0  3   58   15996    0<br>Test (2A): election after network failure ...<br>  ... Passed --   5.1  3  124   24683    0<br>Test (2A): multiple elections ...<br>  ... Passed --   7.0  7  600  120200    0<br>Test (2B): basic agreement ...<br>  ... Passed --   1.1  3   22    5338    3<br>Test (2B): RPC byte count ...<br>  ... Passed --   1.5  3   48  113842   11<br>Test (2B): agreement after follower reconnects ...<br>  ... Passed --   5.7  3  131   35047    8<br>Test (2B): no agreement <span class="hljs-keyword">if</span> too many followers disconnect ...<br>  ... Passed --   3.6  5  200   42417    3<br>Test (2B): concurrent Start()s ...<br>  ... Passed --   0.5  3   20    5838    6<br>Test (2B): rejoin of partitioned leader ...<br>  ... Passed --   6.2  3  193   46403    4<br>Test (2B): leader backs up quickly over incorrect follower logs ...<br>  ... Passed --  16.6  5 2100 1576435  102<br>Test (2B): RPC counts aren<span class="hljs-string">&#x27;t too high ...</span><br><span class="hljs-string">  ... Passed --   2.0  3   58   17896   12</span><br><span class="hljs-string">Test (2C): basic persistence ...</span><br><span class="hljs-string">  ... Passed --   4.1  3   86   21883    6</span><br><span class="hljs-string">Test (2C): more persistence ...</span><br><span class="hljs-string">  ... Passed --  15.7  5  932  198468   16</span><br><span class="hljs-string">Test (2C): partitioned leader and one follower crash, leader restarts ...</span><br><span class="hljs-string">  ... Passed --   1.7  3   37    9365    4</span><br><span class="hljs-string">Test (2C): Figure 8 ...</span><br><span class="hljs-string">  ... Passed --  31.4  5  870  188356   47</span><br><span class="hljs-string">Test (2C): unreliable agreement ...</span><br><span class="hljs-string">  ... Passed --   2.2  5 1056  348389  246</span><br><span class="hljs-string">Test (2C): Figure 8 (unreliable) ...</span><br><span class="hljs-string">  ... Passed --  29.9  5 9385 19728838  106</span><br><span class="hljs-string">Test (2C): churn ...</span><br><span class="hljs-string">  ... Passed --  16.2  5 4892 9100813 1114</span><br><span class="hljs-string">Test (2C): unreliable churn ...</span><br><span class="hljs-string">  ... Passed --  16.1  5 6409 10687659 1013</span><br><span class="hljs-string">Test (2D): snapshots basic ...</span><br><span class="hljs-string">  ... Passed --   2.1  3  480  164064  220</span><br><span class="hljs-string">Test (2D): install snapshots (disconnect) ...</span><br><span class="hljs-string">  ... Passed --  35.1  3 1442  637310  324</span><br><span class="hljs-string">Test (2D): install snapshots (disconnect+unreliable) ...</span><br><span class="hljs-string">  ... Passed --  45.8  3 1674  652143  313</span><br><span class="hljs-string">Test (2D): install snapshots (crash) ...</span><br><span class="hljs-string">  ... Passed --  28.0  3 1174  488096  339</span><br><span class="hljs-string">Test (2D): install snapshots (unreliable+crash) ...</span><br><span class="hljs-string">  ... Passed --  36.4  3 1206  602020  297</span><br><span class="hljs-string">Test (2D): crash and restart all servers ...</span><br><span class="hljs-string">  ... Passed --   8.5  3  276   79532   62</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok  	6.824/raft	325.469s</span><br></code></pre></td></tr></table></figure>


<h2 id="后面发现的问题"><a href="#后面发现的问题" class="headerlink" title="后面发现的问题"></a>后面发现的问题</h2><p>在测试3A的时候发现Leader节点自身的matchIndex为0，其余均为146，这与我的预想不符。在开始的设计中，在节点被选为Leader时matchIndex都为0，在Start函数中对自身的matchIndex赋值，在计算commitIndex时把自身的matchIndex也算进去了，这样比较便于理解。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// leader选举</span><br>	<span class="hljs-comment">// 初始化Leader专属变量</span><br>	rf.nextIndex = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rf.peerNumber)<br>	nextIndex := rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; rf.peerNumber; i++ &#123;<br>		rf.nextIndex[i] = nextIndex<br>	&#125;<br>	rf.matchIndex = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rf.peerNumber)<br><span class="hljs-comment">// Start函数</span><br>	<span class="hljs-comment">// 同时更新自身nextIndex与matchIndex，便于计算commit index</span><br>	rf.nextIndex[rf.me] = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log)<br>	rf.matchIndex[rf.me] = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span><br>	<br><span class="hljs-comment">// 重新计算提交索引</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> changeCommitIndex() &#123; <span class="hljs-comment">// leader rule 4</span><br>	matchIndex := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, rf.matchIndex...) <span class="hljs-comment">// 深拷贝</span><br>	sort.Ints(matchIndex)<br>	<span class="hljs-comment">//  If there exists an N such that N &gt; commitIndex, a majority</span><br>	<span class="hljs-comment">// of matchIndex[i] ≥ N, and log[N].term == currentTerm:</span><br>	<span class="hljs-comment">// set commitIndex = N</span><br>	<span class="hljs-keyword">for</span> i := matchIndex[rf.peerNumber-rf.majorityPeer]; i &gt; rf.commitIndex; i-- &#123;<br>		<span class="hljs-keyword">if</span> rf.log[i-rf.lastIncludedIndex].Term == rf.currentTerm &#123;<br>			<span class="hljs-comment">// DPrintf(&quot;%d change commindex from %d to %d\n&quot;, rf.me, rf.commitIndex, i)</span><br>			rf.commitIndex = i<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在绝大部分情况这种方式没啥问题，但当节点被选为leader，但一直未收到客户的命令，并且节点与半数节点在一个分区，其余节点在另一个分区，那么commit index永远无法增加。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">例子：<br>节点<span class="hljs-number">0</span>为leader，节点<span class="hljs-number">1</span> <span class="hljs-number">2</span>与leader在一个分区<br>节点<span class="hljs-number">3</span> <span class="hljs-number">4</span>在另一个分区<br>节点<span class="hljs-number">0</span>在被选举后log长度为<span class="hljs-number">10</span>，将这些日志同步到节点<span class="hljs-number">1</span> <span class="hljs-number">2</span><br>节点<span class="hljs-number">0</span>的match index[<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">10</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]  commit index永远为<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>这个的解决方法也很简单，可以在计算commit index忽略leader自身，或者保证leader自身match index永远为日志最大索引（实际上可以为无穷大值），我选择了第二种。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 重新计算提交索引</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> changeCommitIndex() &#123; <span class="hljs-comment">// leader rule 4</span><br>	rf.matchIndex[rf.me] = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span> <span class="hljs-comment">// 默认与自己匹配</span><br>	matchIndex := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, rf.matchIndex...)               <span class="hljs-comment">// 深拷贝</span><br>	sort.Ints(matchIndex)<br><br>	<span class="hljs-comment">//  If there exists an N such that N &gt; commitIndex, a majority</span><br>	<span class="hljs-comment">// of matchIndex[i] ≥ N, and log[N].term == currentTerm:</span><br>	<span class="hljs-comment">// set commitIndex = N</span><br>	<span class="hljs-keyword">for</span> i := matchIndex[rf.peerNumber-rf.majorityPeer]; i &gt; rf.commitIndex; i-- &#123;<br>		<span class="hljs-keyword">if</span> rf.log[i-rf.lastIncludedIndex].Term == rf.currentTerm &#123;<br>			<span class="hljs-comment">// DPrintf(&quot;%d change commindex from %d to %d\n&quot;, rf.me, rf.commitIndex, i)</span><br>			rf.commitIndex = i<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这说明很多时候代码实际的效果与预想的效果不太一样，另外vscode的运行调试功能真好用。</p>
<h2 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 节点状态</span><br><span class="hljs-keyword">type</span> PeerState <span class="hljs-type">int</span><br><br><span class="hljs-keyword">const</span> (<br>	Follower PeerState = <span class="hljs-literal">iota</span><br>	Candidate<br>	Leader<br>)<br><br><span class="hljs-comment">// 常量定义</span><br><span class="hljs-keyword">const</span> (<br>	InvalidId         = <span class="hljs-number">-1</span><br>	NoneTerm          = <span class="hljs-number">-1</span><br>	HeartBeatInterval = <span class="hljs-number">100</span> * time.Millisecond<br>)<br><br><span class="hljs-keyword">type</span> ApplyMsg <span class="hljs-keyword">struct</span> &#123;<br>	CommandValid <span class="hljs-type">bool</span><br>	Command      <span class="hljs-keyword">interface</span>&#123;&#125;<br>	CommandIndex <span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// For 2D:</span><br>	SnapshotValid <span class="hljs-type">bool</span><br>	Snapshot      []<span class="hljs-type">byte</span><br>	SnapshotTerm  <span class="hljs-type">int</span><br>	SnapshotIndex <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> logEntry <span class="hljs-keyword">struct</span> &#123;<br>	Command <span class="hljs-keyword">interface</span>&#123;&#125;<br>	Term    <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Raft <span class="hljs-keyword">struct</span> &#123;<br>	mu        sync.Mutex          <span class="hljs-comment">// Lock to protect shared access to this peer&#x27;s state</span><br>	peers     []*labrpc.ClientEnd <span class="hljs-comment">// RPC end points of all peers</span><br>	persister *Persister          <span class="hljs-comment">// Object to hold this peer&#x27;s persisted state</span><br>	me        <span class="hljs-type">int</span>                 <span class="hljs-comment">// this peer&#x27;s index into peers[]</span><br>	dead      <span class="hljs-type">int32</span>               <span class="hljs-comment">// set by Kill()</span><br><br>	currentTerm <span class="hljs-type">int</span><br>	votedFor    <span class="hljs-type">int</span> <span class="hljs-comment">// 当前任期接受到的选票的候选者ID</span><br>	log         []logEntry<br><br>	commitIndex <span class="hljs-type">int</span><br>	lastApplied <span class="hljs-type">int</span><br>	nextIndex   []<span class="hljs-type">int</span><br>	matchIndex  []<span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// 自定义变量</span><br>	state    PeerState<br>	leaderId <span class="hljs-type">int</span> <span class="hljs-comment">// 未用到</span><br><br>	<span class="hljs-comment">// 使用三个变量只是表示更新选举定时器的三个条件，实际上用一个就可以</span><br>	lastHeartBeat       time.Time<br>	lastVote            time.Time<br>	lastInstallSnapshot time.Time<br><br>	<span class="hljs-comment">// 快照相关变量</span><br>	snapshot          []<span class="hljs-type">byte</span><br>	lastIncludedIndex <span class="hljs-type">int</span><br>	lastIncludedTerm  <span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// 自定义常量(初始化一次后不再改变)</span><br>	applyCh      <span class="hljs-keyword">chan</span> ApplyMsg<br>	peerNumber   <span class="hljs-type">int</span><br>	majorityPeer <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Min</span><span class="hljs-params">(n1, n2 <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">if</span> n1 &gt; n2 &#123;<br>		<span class="hljs-keyword">return</span> n2<br>	&#125;<br>	<span class="hljs-keyword">return</span> n1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Max</span><span class="hljs-params">(n1, n2 <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">if</span> n1 &gt; n2 &#123;<br>		<span class="hljs-keyword">return</span> n1<br>	&#125;<br>	<span class="hljs-keyword">return</span> n2<br>&#125;<br><br><span class="hljs-comment">// 将raft当前状态持久化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> persist() &#123;<br>	w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>	e := labgob.NewEncoder(w)<br>	e.Encode(rf.currentTerm)<br>	e.Encode(rf.votedFor)<br>	e.Encode(rf.log)<br>	e.Encode(rf.lastIncludedIndex)<br>	e.Encode(rf.lastIncludedTerm)<br>	data := w.Bytes()<br>	rf.persister.SaveRaftState(data)<br>&#125;<br><br><span class="hljs-comment">// 读取raft状态</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> readPersist(data []<span class="hljs-type">byte</span>) &#123;<br>	<span class="hljs-keyword">if</span> data == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">1</span> &#123; <span class="hljs-comment">// bootstrap without any state?</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	r := bytes.NewBuffer(data)<br>	d := labgob.NewDecoder(r)<br>	<span class="hljs-keyword">var</span> currentTerm <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> votedFor <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> raftLog []logEntry<br>	<span class="hljs-keyword">var</span> lastIncludedIndex <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> lastIncludedTerm <span class="hljs-type">int</span><br>	<span class="hljs-keyword">if</span> d.Decode(&amp;currentTerm) != <span class="hljs-literal">nil</span> ||<br>		d.Decode(&amp;votedFor) != <span class="hljs-literal">nil</span> || d.Decode(&amp;raftLog) != <span class="hljs-literal">nil</span> || d.Decode(&amp;lastIncludedIndex) != <span class="hljs-literal">nil</span> || d.Decode(&amp;lastIncludedTerm) != <span class="hljs-literal">nil</span> &#123;<br>		log.Panicf(<span class="hljs-string">&quot;state decode error&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		rf.currentTerm = currentTerm<br>		rf.votedFor = votedFor<br>		rf.log = raftLog<br>		rf.lastIncludedIndex = lastIncludedIndex<br>		rf.lastIncludedTerm = lastIncludedTerm<br>		rf.commitIndex = rf.lastIncludedIndex <span class="hljs-comment">// 同时设置commitIndex</span><br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 将raft当前状态与快照持久化</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> persistStateAndSnapshot() &#123;<br>	w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>	e := labgob.NewEncoder(w)<br>	e.Encode(rf.currentTerm)<br>	e.Encode(rf.votedFor)<br>	e.Encode(rf.log)<br>	e.Encode(rf.lastIncludedIndex)<br>	e.Encode(rf.lastIncludedTerm)<br>	state := w.Bytes()<br>	rf.persister.SaveStateAndSnapshot(state, rf.snapshot)<br>&#125;<br><br><span class="hljs-comment">// 比对raft state编码的lastIncludedIndex与快照中编码的lastIncludedIndex</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> compareStateAndSnapshot() &#123;<br>	<span class="hljs-keyword">if</span> rf.snapshot == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(rf.snapshot) &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// DPrintf(&quot;exist snapshot\n&quot;)</span><br>	r := bytes.NewBuffer(rf.snapshot)<br>	d := labgob.NewDecoder(r)<br>	<span class="hljs-keyword">var</span> lastIncludedIndex <span class="hljs-type">int</span><br>	<span class="hljs-keyword">if</span> d.Decode(&amp;lastIncludedIndex) != <span class="hljs-literal">nil</span> &#123;<br>		log.Panicf(<span class="hljs-string">&quot;compareStateAndSnapshot: snapshot decode error&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> rf.lastIncludedIndex != lastIncludedIndex &#123;<br>		WPrintf(<span class="hljs-string">&quot;snapshot lastIncludedIndex is different. snapshot:%v  state:%v\n&quot;</span>, lastIncludedIndex, rf.lastIncludedIndex)<br>		<span class="hljs-comment">// 丢掉快照lastIncludedIndex之前的日志并重新设置相关变量</span><br>		rf.log = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[lastIncludedIndex-rf.lastIncludedIndex:]...)<br>		rf.lastIncludedIndex = lastIncludedIndex<br>		rf.lastIncludedTerm = rf.log[<span class="hljs-number">0</span>].Term <span class="hljs-comment">// 日志0位的term</span><br>		rf.commitIndex = rf.lastIncludedIndex<br>		rf.persist()<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> CondInstallSnapshot(lastIncludedTerm <span class="hljs-type">int</span>, lastIncludedIndex <span class="hljs-type">int</span>, snapshot []<span class="hljs-type">byte</span>) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Snapshot(index <span class="hljs-type">int</span>, snapshot []<span class="hljs-type">byte</span>) &#123;<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>	<span class="hljs-keyword">if</span> index &lt;= rf.lastIncludedIndex &#123; <span class="hljs-comment">// 至少得比当前快照更新</span><br>		WPrintf(<span class="hljs-string">&quot;server%v no use snapshot.this index:%v last index:%v\n&quot;</span>, rf.me, rf.lastIncludedIndex, index)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// rf.log = rf.log[index-rf.lastIncludedIndex:]</span><br>	rf.log = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[index-rf.lastIncludedIndex:]...)<br>	rf.lastIncludedIndex = index<br>	rf.lastIncludedTerm = rf.log[<span class="hljs-number">0</span>].Term <span class="hljs-comment">// 日志0位的term</span><br>	rf.snapshot = snapshot<br>	rf.persistStateAndSnapshot()<br>	<span class="hljs-comment">// DPrintf(&quot;generate Snapshot. server id:%v Snapshot index:%v  log len:%v   commmit index:%v apply index:%v&quot;, rf.me, index, len(rf.log), rf.commitIndex, rf.lastApplied)</span><br>&#125;<br><br><span class="hljs-keyword">type</span> RequestVoteArgs <span class="hljs-keyword">struct</span> &#123;<br>	Term         <span class="hljs-type">int</span><br>	CandidateId  <span class="hljs-type">int</span><br>	LastLogIndex <span class="hljs-type">int</span><br>	LastLogTerm  <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> RequestVoteReply <span class="hljs-keyword">struct</span> &#123;<br>	Term        <span class="hljs-type">int</span><br>	VoteGranted <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> AppendEntriesArgs <span class="hljs-keyword">struct</span> &#123;<br>	Term         <span class="hljs-type">int</span><br>	LeaderId     <span class="hljs-type">int</span><br>	PrevLogIndex <span class="hljs-type">int</span><br>	PrevLogTerm  <span class="hljs-type">int</span><br>	Entries      []logEntry<br>	LeaderCommit <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> AppendEntriesReply <span class="hljs-keyword">struct</span> &#123;<br>	Term          <span class="hljs-type">int</span><br>	Success       <span class="hljs-type">bool</span><br>	ConflictIndex <span class="hljs-type">int</span><br>	ConflictTerm  <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> InstallSnapshotArgs <span class="hljs-keyword">struct</span> &#123;<br>	Term              <span class="hljs-type">int</span><br>	LeaderId          <span class="hljs-type">int</span><br>	LastIncludedIndex <span class="hljs-type">int</span><br>	LastIncludedTerm  <span class="hljs-type">int</span><br>	Data              []<span class="hljs-type">byte</span><br>&#125;<br><br><span class="hljs-keyword">type</span> InstallSnapshotReply <span class="hljs-keyword">struct</span> &#123;<br>	Term <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) &#123;<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>	reply.Term = rf.currentTerm<br>	<span class="hljs-keyword">if</span> rf.currentTerm &gt; args.Term &#123; <span class="hljs-comment">// RequestVote rule 1</span><br>		reply.VoteGranted = <span class="hljs-literal">false</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	needPersist := <span class="hljs-literal">false</span>            <span class="hljs-comment">// 是否需要持久化</span><br>	<span class="hljs-keyword">if</span> rf.currentTerm &lt; args.Term &#123; <span class="hljs-comment">// set currentTerm = T, convert to follower</span><br>		rf.currentTerm = args.Term<br>		rf.votedFor = InvalidId <span class="hljs-comment">// 更新votedFor变量</span><br>		rf.state = Follower<br>		needPersist = <span class="hljs-literal">true</span><br>	&#125;<br><br>	lastLogIndex := rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span> <span class="hljs-comment">// 本地日志最大索引值</span><br>	lastLogTerm := rf.log[lastLogIndex-rf.lastIncludedIndex].Term<br>	<span class="hljs-comment">// votedFor is null or candidateId</span><br>	condition1 := (rf.votedFor == InvalidId) || (rf.votedFor == args.CandidateId)<br>	<span class="hljs-comment">// at least as up-to-date</span><br>	condition2 := (args.LastLogTerm &gt; lastLogTerm) || ((args.LastLogTerm == lastLogTerm) &amp;&amp; (args.LastLogIndex &gt;= lastLogIndex))<br>	<span class="hljs-comment">// DPrintf(&quot;arg:%v %v  rf:%v %v\n&quot;, args.LastLogTerm, args.LastLogIndex, lastLogTerm, lastLogIndex)</span><br>	reply.VoteGranted = condition1 &amp;&amp; condition2<br>	<span class="hljs-keyword">if</span> reply.VoteGranted &#123;<br>		rf.votedFor = args.CandidateId <span class="hljs-comment">// 设置本次选择候选者ID</span><br>		rf.lastVote = time.Now()       <span class="hljs-comment">// 更新投票时间</span><br>		needPersist = <span class="hljs-literal">true</span><br>		<span class="hljs-comment">// DPrintf(&quot;%d vote to %d\n&quot;, rf.me, args.CandidateId)</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> needPersist &#123;<br>		rf.persist()<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) &#123;<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>	reply.Term = rf.currentTerm<br>	reply.Success = <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">if</span> rf.currentTerm &gt; args.Term &#123; <span class="hljs-comment">// AppendEntries rule 1</span><br>		reply.Success = <span class="hljs-literal">false</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	needPersist := <span class="hljs-literal">false</span><br>	<span class="hljs-keyword">if</span> rf.currentTerm &lt; args.Term &#123; <span class="hljs-comment">// set currentTerm = T, convert to follower</span><br>		rf.currentTerm = args.Term<br>		rf.votedFor = InvalidId <span class="hljs-comment">// 更新votedFor变量</span><br>		rf.state = Follower<br>		needPersist = <span class="hljs-literal">true</span><br>	&#125;<br><br>	<span class="hljs-comment">// 重置Follower状态</span><br>	rf.lastHeartBeat = time.Now()<br>	rf.leaderId = args.LeaderId<br><br>	maxLocalLogIndex := rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span> <span class="hljs-comment">// 本地最大日志索引</span><br>	<span class="hljs-keyword">var</span> matchResult <span class="hljs-type">bool</span><br>	<span class="hljs-keyword">if</span> maxLocalLogIndex &lt; args.PrevLogIndex &#123; <span class="hljs-comment">// 不存在该日志项，匹配失败</span><br>		matchResult = <span class="hljs-literal">false</span><br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rf.commitIndex &gt;= args.PrevLogIndex &#123; <span class="hljs-comment">// 该日志项已提交，默认匹配成功</span><br>		<span class="hljs-comment">// DPrintf(&quot;commited log is same:  PrevLogIndex %v  lastIncludedIndex %v commitIndex %v\n&quot;, args.PrevLogIndex, rf.lastIncludedIndex, rf.commitIndex)</span><br>		matchResult = <span class="hljs-literal">true</span><br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rf.lastIncludedIndex &lt;= args.PrevLogIndex &#123; <span class="hljs-comment">// 比对PrevLogIndex处term是否一致</span><br>		matchResult = (rf.log[args.PrevLogIndex-rf.lastIncludedIndex].Term == args.PrevLogTerm)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		log.Panicf(<span class="hljs-string">&quot;unexpected condition. match error\n&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> !matchResult &#123; <span class="hljs-comment">// AppendEntries rule 2</span><br>		reply.Success = <span class="hljs-literal">false</span><br>		<span class="hljs-comment">// If a follower does not have prevLogIndex in its log, it should return with conflictIndex = len(log) and conflictTerm = None.</span><br>		<span class="hljs-comment">// If a follower does have prevLogIndex in its log, but the term does not match, it should return conflictTerm = log[prevLogIndex].Term, and then search its log for the first index whose entry has term equal to conflictTerm.</span><br>		<span class="hljs-keyword">if</span> maxLocalLogIndex &lt; args.PrevLogIndex &#123;<br>			reply.ConflictIndex = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) <span class="hljs-comment">// conflictIndex = len(log)</span><br>			reply.ConflictTerm = NoneTerm<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// next index相关，不应该涉及lastIncludedTerm</span><br>			reply.ConflictTerm = rf.log[args.PrevLogIndex-rf.lastIncludedIndex].Term<br>			reply.ConflictIndex = rf.commitIndex + <span class="hljs-number">1</span> <span class="hljs-comment">// ConflictIndex应大于commitIndex</span><br>			<span class="hljs-keyword">for</span> i := args.PrevLogIndex; i &gt; rf.commitIndex+<span class="hljs-number">1</span>; i-- &#123;<br>				<span class="hljs-keyword">if</span> rf.log[i<span class="hljs-number">-1</span>-rf.lastIncludedIndex].Term != reply.ConflictTerm &#123; <span class="hljs-comment">// 上一个entry term不匹配，该位置即为第一个为该term的entry</span><br>					reply.ConflictIndex = i<br>					<span class="hljs-keyword">break</span><br>				&#125;<br>			&#125;<br>		&#125;<br>		DPrintf(<span class="hljs-string">&quot;prelog term doesn&#x27;t match. server id:%v commit index:%d maxLocalLogIndex:%v args.PrevLogIndex:%v rf.lastIncludedIndex:%v  ConflictTerm:%v ConflictIndex:%v \n&quot;</span>, rf.me, rf.commitIndex, maxLocalLogIndex, args.PrevLogIndex, rf.lastIncludedIndex, reply.ConflictTerm, reply.ConflictIndex)<br>		<span class="hljs-keyword">if</span> needPersist &#123;<br>			rf.persist()<br>		&#125;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// DPrintf(&quot;%d preIndex %d  entry size:%d\n&quot;, rf.me, args.PrevLogIndex, len(args.Entries))</span><br>	<span class="hljs-comment">// 找到第一个term不同的索引</span><br>	lastNewEntryIndex := args.PrevLogIndex + <span class="hljs-built_in">len</span>(args.Entries)<br>	minLogIndex := Max(rf.commitIndex+<span class="hljs-number">1</span>, args.PrevLogIndex+<span class="hljs-number">1</span>) <span class="hljs-comment">// 已提交日志的term一定一致，不用检查</span><br>	maxLogIndex := Min(lastNewEntryIndex, maxLocalLogIndex)   <span class="hljs-comment">// 取本地日志与消息日志最大索引的较小值</span><br>	diffItemIndex := maxLogIndex + <span class="hljs-number">1</span><br>	<span class="hljs-keyword">for</span> i := minLogIndex; i &lt;= maxLogIndex; i++ &#123;<br>		<span class="hljs-keyword">if</span> rf.log[i-rf.lastIncludedIndex].Term != args.Entries[i-args.PrevLogIndex<span class="hljs-number">-1</span>].Term &#123;<br>			diffItemIndex = i<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// AppendEntries rule 3</span><br>	<span class="hljs-keyword">if</span> diffItemIndex != maxLogIndex+<span class="hljs-number">1</span> &#123; <span class="hljs-comment">// 只有存在不一致日志时才delete</span><br>		rf.log = rf.log[:diffItemIndex-rf.lastIncludedIndex]<br>		needPersist = <span class="hljs-literal">true</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> diffItemIndex-args.PrevLogIndex<span class="hljs-number">-1</span> &lt;= <span class="hljs-built_in">len</span>(args.Entries)<span class="hljs-number">-1</span> &#123; <span class="hljs-comment">// 起始索引小于最大索引，还有日志未加入本地日志</span><br>		rf.log = <span class="hljs-built_in">append</span>(rf.log, args.Entries[diffItemIndex-args.PrevLogIndex<span class="hljs-number">-1</span>:]...) <span class="hljs-comment">// AppendEntries rule 4</span><br>		needPersist = <span class="hljs-literal">true</span><br>	&#125;<br><br>	<span class="hljs-comment">// 取LeaderCommit与消息日志最大索引的较小值</span><br>	<span class="hljs-keyword">if</span> rf.commitIndex &lt; args.LeaderCommit &#123; <span class="hljs-comment">// AppendEntries rule 5</span><br>		rf.commitIndex = Min(args.LeaderCommit, lastNewEntryIndex)<br>		<span class="hljs-comment">// DPrintf(&quot;%d change commit index to %d  LeaderCommit:%d  lastNewEntryIndex:%d\n&quot;, rf.me, rf.commitIndex, args.LeaderCommit, lastNewEntryIndex)</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> needPersist &#123;<br>		rf.persist()<br>	&#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> InstallSnapshot(args *InstallSnapshotArgs, reply *InstallSnapshotReply) &#123;<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>	reply.Term = rf.currentTerm<br>	<span class="hljs-keyword">if</span> rf.currentTerm &gt; args.Term &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> rf.currentTerm &lt; args.Term &#123; <span class="hljs-comment">// // set currentTerm = T, convert to follower</span><br>		rf.currentTerm = args.Term<br>		rf.votedFor = InvalidId <span class="hljs-comment">// 更新votedFor变量</span><br>		rf.state = Follower<br>		rf.persist() <span class="hljs-comment">// 直接持久化</span><br>	&#125;<br><br>	rf.lastInstallSnapshot = time.Now() <span class="hljs-comment">// 更新接收快照时间</span><br>	rf.leaderId = args.LeaderId<br>	logIndex := args.LastIncludedIndex - rf.lastIncludedIndex <span class="hljs-comment">// leader快照与本地快照对比</span><br>	<span class="hljs-keyword">if</span> logIndex &lt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// WPrintf(&quot;local server snapshot is newer. server id:%v lastIncludedIndex:%v  log len:%v\n&quot;, rf.me, rf.lastIncludedIndex, len(rf.log))</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> logIndex &lt; <span class="hljs-built_in">len</span>(rf.log) &amp;&amp; rf.log[logIndex].Term == args.LastIncludedTerm &#123; <span class="hljs-comment">// step 5</span><br>		DPrintf(<span class="hljs-string">&quot;same log entry. server id:%v lastIncludedIndex:%v  log len:%v\n&quot;</span>, rf.me, rf.lastIncludedIndex, <span class="hljs-built_in">len</span>(rf.log))<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// 设置快照相关状态并持久化</span><br>	rf.snapshot = args.Data<br>	rf.lastIncludedIndex = args.LastIncludedIndex<br>	rf.lastIncludedTerm = args.LastIncludedTerm<br>	rf.log = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, logEntry&#123;Term: rf.lastIncludedTerm&#125;) <span class="hljs-comment">// 删除所有日志，重新加入0位日志</span><br>	<span class="hljs-comment">// 更新日志commitIndex</span><br>	rf.commitIndex = rf.lastIncludedIndex<br>	rf.persistStateAndSnapshot()<br>	DPrintf(<span class="hljs-string">&quot;%v recv snapshot. lastIncludedIndex:%v log len:%v commit index:%v  apply index:%v\n&quot;</span>, rf.me, rf.lastIncludedIndex, <span class="hljs-built_in">len</span>(rf.log), rf.commitIndex, rf.lastApplied)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> sendRequestVote(server <span class="hljs-type">int</span>, args *RequestVoteArgs, reply *RequestVoteReply) <span class="hljs-type">bool</span> &#123;<br>	ok := rf.peers[server].Call(<span class="hljs-string">&quot;Raft.RequestVote&quot;</span>, args, reply)<br>	<span class="hljs-keyword">return</span> ok<br>&#125;<br><br><span class="hljs-comment">// 在远程调用函数中解锁加锁，便于使用defer</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> sendAppendEntries(server <span class="hljs-type">int</span>, args *AppendEntriesArgs, reply *AppendEntriesReply) <span class="hljs-type">bool</span> &#123;<br>	rf.mu.Unlock()<br>	ok := rf.peers[server].Call(<span class="hljs-string">&quot;Raft.AppendEntries&quot;</span>, args, reply)<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">return</span> ok<br>&#125;<br><br><span class="hljs-comment">// 在远程调用函数中解锁加锁，便于使用defer</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> sendInstallSnapshot(server <span class="hljs-type">int</span>, args *InstallSnapshotArgs, reply *InstallSnapshotReply) <span class="hljs-type">bool</span> &#123;<br>	rf.mu.Unlock()<br>	ok := rf.peers[server].Call(<span class="hljs-string">&quot;Raft.InstallSnapshot&quot;</span>, args, reply)<br>	rf.mu.Lock()<br>	<span class="hljs-keyword">return</span> ok<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> GetState() (<span class="hljs-type">int</span>, <span class="hljs-type">bool</span>) &#123;<br>	rf.mu.Lock()<br>	term := rf.currentTerm<br>	isleader := (rf.state == Leader)<br>	rf.mu.Unlock()<br>	<span class="hljs-keyword">return</span> term, isleader<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Start(command <span class="hljs-keyword">interface</span>&#123;&#125;) (<span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">bool</span>) &#123;<br>	index := <span class="hljs-number">-1</span><br>	term := <span class="hljs-number">-1</span><br>	isLeader := <span class="hljs-literal">true</span><br>	rf.mu.Lock()<br>	<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>	<span class="hljs-keyword">if</span> rf.state != Leader &#123;<br>		isLeader = <span class="hljs-literal">false</span><br>		<span class="hljs-keyword">return</span> index, term, isLeader<br>	&#125;<br>	entry := logEntry&#123;Term: rf.currentTerm, Command: command&#125;<br>	rf.log = <span class="hljs-built_in">append</span>(rf.log, entry)<br>	index = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span><br>	term = rf.currentTerm<br>	<span class="hljs-comment">// // 同时更新自身nextIndex与matchIndex，便于计算commit index</span><br>	<span class="hljs-comment">// rf.nextIndex[rf.me] = rf.lastIncludedIndex + len(rf.log)</span><br>	<span class="hljs-comment">// rf.matchIndex[rf.me] = rf.lastIncludedIndex + len(rf.log) - 1</span><br>	rf.persist()<br>	<span class="hljs-keyword">go</span> rf.agreementTask() <span class="hljs-comment">// 进行一轮日志协商</span><br>	<span class="hljs-keyword">return</span> index, term, isLeader<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> Kill() &#123;<br>	atomic.StoreInt32(&amp;rf.dead, <span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> killed() <span class="hljs-type">bool</span> &#123;<br>	z := atomic.LoadInt32(&amp;rf.dead)<br>	<span class="hljs-keyword">return</span> z == <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">// 重新计算提交索引</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> changeCommitIndex() &#123; <span class="hljs-comment">// leader rule 4</span><br>	rf.matchIndex[rf.me] = rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span> <span class="hljs-comment">// 默认与自己匹配</span><br>	matchIndex := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, rf.matchIndex...)               <span class="hljs-comment">// 深拷贝</span><br>	sort.Ints(matchIndex)<br><br>	<span class="hljs-comment">//  If there exists an N such that N &gt; commitIndex, a majority</span><br>	<span class="hljs-comment">// of matchIndex[i] ≥ N, and log[N].term == currentTerm:</span><br>	<span class="hljs-comment">// set commitIndex = N</span><br>	<span class="hljs-keyword">for</span> i := matchIndex[rf.peerNumber-rf.majorityPeer]; i &gt; rf.commitIndex; i-- &#123;<br>		<span class="hljs-keyword">if</span> rf.log[i-rf.lastIncludedIndex].Term == rf.currentTerm &#123;<br>			<span class="hljs-comment">// DPrintf(&quot;%d change commindex from %d to %d\n&quot;, rf.me, rf.commitIndex, i)</span><br>			rf.commitIndex = i<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 进行一次日志协商</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> agreementTask() &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; rf.peerNumber; i++ &#123;<br>		<span class="hljs-keyword">if</span> i == rf.me &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(server <span class="hljs-type">int</span>)</span></span> &#123;<br>			rf.mu.Lock()<br>			<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>			<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>				<span class="hljs-keyword">if</span> rf.state != Leader &#123;<br>					<span class="hljs-keyword">return</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> rf.nextIndex[server] &lt;= rf.lastIncludedIndex &#123; <span class="hljs-comment">// 所需日志包含在快照中</span><br>					<span class="hljs-keyword">if</span> rf.snapshot == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(rf.snapshot) &lt; <span class="hljs-number">1</span> &#123;<br>						log.Panicf(<span class="hljs-string">&quot;agreementTask: wrong snapshot.\n&quot;</span>)<br>					&#125;<br>					DPrintf(<span class="hljs-string">&quot;%v send snapshot to %v  LastIncludedInde:%v\n&quot;</span>, rf.me, server, rf.lastIncludedIndex)<br>					args := InstallSnapshotArgs&#123;Term: rf.currentTerm, LeaderId: rf.me, LastIncludedIndex: rf.lastIncludedIndex, LastIncludedTerm: rf.lastIncludedTerm, Data: rf.snapshot&#125;<br>					reply := InstallSnapshotReply&#123;&#125;<br>					res := rf.sendInstallSnapshot(server, &amp;args, &amp;reply) <span class="hljs-comment">// 在函数中解锁加锁</span><br>					<span class="hljs-keyword">if</span> !res &#123;<br>						<span class="hljs-comment">// DPrintf(&quot;%v send InstallSnapshot to %v failed\n&quot;, server, rf.me)</span><br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> rf.state != Leader &#123;<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> args.Term != rf.currentTerm &#123; <span class="hljs-comment">// old rpc reply</span><br>						DPrintf(<span class="hljs-string">&quot;old InstallSnapshot rpc reply\n&quot;</span>)<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> rf.currentTerm &lt; reply.Term &#123; <span class="hljs-comment">// set currentTerm = T, convert to follower</span><br>						rf.currentTerm = reply.Term<br>						rf.votedFor = InvalidId<br>						rf.state = Follower<br>						rf.persist()<br>						<span class="hljs-keyword">return</span><br>					&#125;<br>					<span class="hljs-comment">// 发送快照成功</span><br>					rf.matchIndex[server] = Max(rf.matchIndex[server], args.LastIncludedIndex)<br>					rf.nextIndex[server] = rf.matchIndex[server] + <span class="hljs-number">1</span><br>					rf.changeCommitIndex()<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					args := AppendEntriesArgs&#123;Term: rf.currentTerm, LeaderId: rf.me, LeaderCommit: rf.commitIndex&#125;<br>					args.PrevLogIndex = rf.nextIndex[server] - <span class="hljs-number">1</span><br>					args.PrevLogTerm = rf.log[args.PrevLogIndex-rf.lastIncludedIndex].Term<br>					args.Entries = <span class="hljs-built_in">append</span>([]logEntry&#123;&#125;, rf.log[rf.nextIndex[server]-rf.lastIncludedIndex:]...) <span class="hljs-comment">// 深拷贝</span><br>					reply := AppendEntriesReply&#123;&#125;<br>					res := rf.sendAppendEntries(server, &amp;args, &amp;reply) <span class="hljs-comment">// 在函数中解锁加锁</span><br>					<span class="hljs-keyword">if</span> !res &#123;<br>						<span class="hljs-comment">// DPrintf(&quot;%v send AppendEntries to %v failed\n&quot;, server, rf.me)</span><br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> rf.state != Leader &#123;<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> args.Term != rf.currentTerm &#123; <span class="hljs-comment">// old rpc reply</span><br>						DPrintf(<span class="hljs-string">&quot;old AppendEntries rpc reply\n&quot;</span>)<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> reply.Success &#123;<br>						<span class="hljs-comment">// 仔细设置nextIndex与matchIndex</span><br>						rf.matchIndex[server] = Max(rf.matchIndex[server], args.PrevLogIndex+<span class="hljs-built_in">len</span>(args.Entries))<br>						rf.nextIndex[server] = rf.matchIndex[server] + <span class="hljs-number">1</span><br>						rf.changeCommitIndex()<br>						<span class="hljs-keyword">return</span><br>					&#125;<br><br>					<span class="hljs-keyword">if</span> rf.currentTerm &lt; reply.Term &#123; <span class="hljs-comment">// set currentTerm = T, convert to follower</span><br>						rf.currentTerm = reply.Term<br>						rf.votedFor = InvalidId<br>						rf.state = Follower<br>						rf.persist()<br>						<span class="hljs-keyword">return</span><br>					&#125;<br>					<span class="hljs-comment">// Upon receiving a conflict response, the leader should first search its log for conflictTerm. If it finds an entry in its log with that term, it should set nextIndex to be the one beyond the index of the last entry in that term in its log.</span><br>					<span class="hljs-comment">// If it does not find an entry with that term, it should set nextIndex = conflictIndex.</span><br>					<span class="hljs-keyword">if</span> reply.ConflictTerm == NoneTerm &#123;<br>						rf.nextIndex[server] = reply.ConflictIndex<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						rf.nextIndex[server] = reply.ConflictIndex<br>						<span class="hljs-keyword">for</span> i := args.PrevLogIndex; i &gt; rf.lastIncludedIndex; i-- &#123;<br>							<span class="hljs-keyword">if</span> rf.log[i-rf.lastIncludedIndex].Term == reply.ConflictTerm &#123;<br>								rf.nextIndex[server] = i<br>								<span class="hljs-keyword">break</span><br>							&#125;<br>						&#125;<br>					&#125;<br>					<span class="hljs-keyword">if</span> rf.nextIndex[server] &lt; <span class="hljs-number">1</span> &#123;<br>						log.Panicf(<span class="hljs-string">&quot;next index set wrong value.&quot;</span>)<br>					&#125;<br>					DPrintf(<span class="hljs-string">&quot;next index retry. cur term:%v leader:%d server:%d commit index:%d next index:%d\n&quot;</span>, rf.currentTerm, rf.me, server, rf.commitIndex, rf.nextIndex[server])<br>				&#125;<br>			&#125;<br><br>		&#125;(i)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 向各节点发送心跳消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> heartBeatTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		rf.mu.Lock()<br>		flag := (rf.state == Leader)<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> !flag &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-keyword">go</span> rf.agreementTask()<br>		time.Sleep(HeartBeatInterval)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 向各节点发送投票信息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> sendVoteTask(args RequestVoteArgs) &#123;<br>	ticket := <span class="hljs-number">1</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; rf.peerNumber; i++ &#123;<br>		<span class="hljs-keyword">if</span> i == rf.me &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(server <span class="hljs-type">int</span>)</span></span> &#123;<br>			reply := RequestVoteReply&#123;&#125;<br>			res := rf.sendRequestVote(server, &amp;args, &amp;reply)<br>			<span class="hljs-keyword">if</span> !res &#123;<br>				<span class="hljs-comment">// DPrintf(&quot;sendRequestVote failed server:%d me:%d\n&quot;, server, rf.me)</span><br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			rf.mu.Lock()<br>			<span class="hljs-keyword">defer</span> rf.mu.Unlock()<br>			<span class="hljs-keyword">if</span> rf.state != Candidate &#123; <span class="hljs-comment">// 若当前状态不是候选者则直接返回</span><br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			<span class="hljs-keyword">if</span> args.Term != rf.currentTerm &#123;<br>				DPrintf(<span class="hljs-string">&quot;old RequestVote reply\n&quot;</span>)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			<span class="hljs-keyword">if</span> reply.VoteGranted &#123;<br>				ticket++<br>				<span class="hljs-keyword">if</span> ticket &gt;= rf.majorityPeer &#123; <span class="hljs-comment">// 得到超过半数投票，转变为leader，并开启心跳任务</span><br>					rf.state = Leader<br>					rf.leaderId = rf.me<br>					<span class="hljs-comment">// 初始化Leader专属变量</span><br>					rf.nextIndex = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rf.peerNumber)<br>					nextIndex := rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log)<br>					<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; rf.peerNumber; i++ &#123;<br>						rf.nextIndex[i] = nextIndex<br>					&#125;<br>					rf.matchIndex = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rf.peerNumber)<br>					DPrintf(<span class="hljs-string">&quot;%d become leader. commit index:%d  next index:%d\n&quot;</span>, rf.me, rf.commitIndex, rf.nextIndex[<span class="hljs-number">0</span>])<br>					<span class="hljs-keyword">go</span> rf.heartBeatTask()<br>				&#125;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rf.currentTerm &lt; reply.Term &#123; <span class="hljs-comment">// 返回的任期大于本身任期，转变为Follower，更新任期</span><br>				rf.currentTerm = reply.Term<br>				rf.state = Follower<br>				rf.votedFor = InvalidId<br>				rf.persist()<br>			&#125;<br>		&#125;(i)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> ticker() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		<span class="hljs-comment">// Your code here to check if a leader election should</span><br>		<span class="hljs-comment">// be started and to randomize sleeping time using</span><br>		<span class="hljs-comment">// time.Sleep().</span><br>		sleepTime := time.Duration(rand.Intn(<span class="hljs-number">300</span>)+<span class="hljs-number">300</span>) * time.Millisecond <span class="hljs-comment">// 300~600ms</span><br>		time.Sleep(sleepTime)<br>		rf.mu.Lock() <span class="hljs-comment">// 读取状态前加锁</span><br>		<span class="hljs-comment">// &amp;&amp; time.Since(rf.lastInstallSnapshot) &gt; sleepTime  论文中没写，就不加上去了</span><br>		<span class="hljs-keyword">if</span> rf.state != Leader &amp;&amp; time.Since(rf.lastHeartBeat) &gt; sleepTime &amp;&amp; time.Since(rf.lastVote) &gt; sleepTime &#123;<br>			rf.currentTerm++<br>			rf.votedFor = rf.me<br>			rf.lastHeartBeat = time.Now()<br>			rf.state = Candidate<br>			lastLogIndex := rf.lastIncludedIndex + <span class="hljs-built_in">len</span>(rf.log) - <span class="hljs-number">1</span><br>			lastLogTerm := rf.log[lastLogIndex-rf.lastIncludedIndex].Term<br>			args := RequestVoteArgs&#123;Term: rf.currentTerm, CandidateId: rf.me, LastLogIndex: lastLogIndex, LastLogTerm: lastLogTerm&#125;<br>			<span class="hljs-comment">// DPrintf(&quot;%d join vote  term：%d\n&quot;, rf.me, rf.currentTerm)</span><br>			rf.persist()<br>			<span class="hljs-keyword">go</span> rf.sendVoteTask(args)<br>		&#125;<br>		rf.mu.Unlock()<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 向service发送命令</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span></span> applyTask() &#123;<br>	<span class="hljs-keyword">for</span> !rf.killed() &#123;<br>		<span class="hljs-keyword">var</span> msg ApplyMsg<br>		sendMsg := <span class="hljs-literal">false</span><br>		rf.mu.Lock()<br>		<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.commitIndex &#123;<br>			sendMsg = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">if</span> rf.lastApplied &lt; rf.lastIncludedIndex &#123; <span class="hljs-comment">// 发送快照</span><br>				rf.lastApplied = rf.lastIncludedIndex<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">false</span>, SnapshotValid: <span class="hljs-literal">true</span>, Snapshot: rf.snapshot, SnapshotIndex: rf.lastIncludedIndex, SnapshotTerm: rf.lastIncludedTerm&#125;<br>				DPrintf(<span class="hljs-string">&quot;applySnapshot. server id:%v commitIndex:%v  lastApplied:%v  lastIncludedIndex:%v\n&quot;</span>, rf.me, rf.commitIndex, rf.lastApplied, rf.lastIncludedIndex)<br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 发送日志</span><br>				rf.lastApplied++<br>				msg = ApplyMsg&#123;CommandValid: <span class="hljs-literal">true</span>, Command: rf.log[rf.lastApplied-rf.lastIncludedIndex].Command, CommandIndex: rf.lastApplied&#125;<br>			&#125;<br>		&#125;<br>		rf.mu.Unlock()<br>		<span class="hljs-keyword">if</span> sendMsg &#123; <span class="hljs-comment">// 向service发送消息</span><br>			rf.applyCh &lt;- msg<br>		&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 此次未发送消息，休眠10ms后再次查询</span><br>			time.Sleep(<span class="hljs-number">10</span> * time.Millisecond)<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Make</span><span class="hljs-params">(peers []*labrpc.ClientEnd, me <span class="hljs-type">int</span>, persister *Persister, applyCh <span class="hljs-keyword">chan</span> ApplyMsg)</span></span> *Raft &#123;<br>	rf := &amp;Raft&#123;&#125;<br>	rf.peers = peers<br>	rf.persister = persister<br>	rf.me = me<br><br>	<span class="hljs-comment">// Your initialization code here (2A, 2B, 2C).</span><br>	rf.currentTerm = <span class="hljs-number">0</span><br>	rf.votedFor = InvalidId<br>	rf.log = <span class="hljs-literal">nil</span><br>	rf.commitIndex = <span class="hljs-number">0</span><br>	rf.lastApplied = <span class="hljs-number">0</span><br>	rf.nextIndex = <span class="hljs-literal">nil</span><br>	rf.matchIndex = <span class="hljs-literal">nil</span><br><br>	rf.state = Follower<br>	rf.leaderId = InvalidId<br>	rf.lastHeartBeat = time.Now()<br>	rf.lastVote = time.Now()<br>	rf.lastInstallSnapshot = time.Now()<br><br>	rf.lastIncludedIndex = <span class="hljs-number">0</span><br>	rf.lastIncludedTerm = <span class="hljs-number">0</span><br>	rf.log = <span class="hljs-built_in">append</span>(rf.log, logEntry&#123;Term: <span class="hljs-number">0</span>&#125;) <span class="hljs-comment">// 增加一条无效命令，作为最开始的lastInclude项</span><br><br>	rf.applyCh = applyCh<br>	rf.peerNumber = <span class="hljs-built_in">len</span>(peers)<br>	rf.majorityPeer = (<span class="hljs-built_in">len</span>(peers) / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span><br><br>	<span class="hljs-comment">// initialize from state persisted before a crash</span><br>	rf.readPersist(persister.ReadRaftState())<br>	rf.snapshot = persister.ReadSnapshot()<br>	<span class="hljs-comment">// rf.compareStateAndSnapshot()</span><br>	rand.Seed(time.Now().Unix()) <span class="hljs-comment">// 设置随机种子</span><br>	DPrintf(<span class="hljs-string">&quot;%v start. start index:%v  log len:%v  commit index:%v term:%v&quot;</span>, rf.me, rf.lastIncludedIndex, <span class="hljs-built_in">len</span>(rf.log), rf.commitIndex, rf.currentTerm)<br><br>	<span class="hljs-comment">// start ticker goroutine to start elections</span><br>	<span class="hljs-keyword">go</span> rf.ticker()<br>	<span class="hljs-keyword">go</span> rf.applyTask()<br>	<span class="hljs-keyword">return</span> rf<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%9B%BD%E5%A4%96%E8%AF%BE%E7%A8%8B%E5%AE%9E%E9%AA%8C/" class="category-chain-item">国外课程实验</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/raft-mit6-824-lab2/" class="print-no-link">#raft mit6.824 lab2</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/mit6.824%202022%20lab3.html" title="mit6.824 2022 lab3">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">mit6.824 2022 lab3</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/mit6.824%202022%20lab1.html" title="mit6.824 2022 lab1">
                        <span class="hidden-mobile">mit6.824 2022 lab1</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz","appKey":"0e2MMh7ddBCGGytOe9UEy5NP","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://uu0wegco.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
