

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg">
  <link rel="icon" href="/img/nano-1.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="最佳损友1020">
  <meta name="keywords" content="">
  
    <meta name="description" content="xv6 book记录看pdf看困了，主要看看几张图，最后再看看real world就可以了xv6文件系统架构  The disk layer reads and writes blocks on an virtio hard drive. The buffer cache layer caches disk blocks and synchronizes access to them, ma">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.S081 2021 file system">
<meta property="og:url" content="https://www.jiasun.top/blog/MIT6.S081%202021%20file%20system.html">
<meta property="og:site_name" content="最佳损友1020’s Blog">
<meta property="og:description" content="xv6 book记录看pdf看困了，主要看看几张图，最后再看看real world就可以了xv6文件系统架构  The disk layer reads and writes blocks on an virtio hard drive. The buffer cache layer caches disk blocks and synchronizes access to them, ma">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/3281b19b5da4425d90808f4af65adfa2.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e88263d373824653b57aadd0faf179de.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/6ceb5621012642d39b5d336e20e4fe54.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/19bf0ac903f541e284558e185d9b0957.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/1c61bbdc27484c638b3e742f9d48ea9d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e8b6cb3906ce4de4986ac3528f159fc5.png">
<meta property="article:published_time" content="2022-08-21T11:41:06.000Z">
<meta property="article:modified_time" content="2023-10-31T14:45:58.860Z">
<meta property="article:author" content="最佳损友1020">
<meta property="article:tag" content="file system 6.081">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/3281b19b5da4425d90808f4af65adfa2.png">
  
  
  
  <title>MIT6.S081 2021 file system - 最佳损友1020’s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn.css">
<link rel="stylesheet" href="/css/top.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.jiasun.top","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz","app_key":"ljkRZDiTtVmjn5mpaQmpFqgv","server_url":"https://n227fxnj.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>最佳损友1020</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MIT6.S081 2021 file system"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-21 19:41" pubdate>
          2022年8月21日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          80 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MIT6.S081 2021 file system</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />


<h2 id="xv6-book记录"><a href="#xv6-book记录" class="headerlink" title="xv6 book记录"></a>xv6 book记录</h2><p>看pdf看困了，主要看看几张图，最后再看看real world就可以了<br><img src="https://img-blog.csdnimg.cn/3281b19b5da4425d90808f4af65adfa2.png" srcset="/img/loading.gif" lazyload><br><strong>xv6文件系统架构</strong></p>
<blockquote>
<p>The disk layer reads and writes blocks on an virtio hard drive. The buffer cache layer caches disk blocks and synchronizes access to them, making sure that only one kernel process at a time can modify the data stored in any particular block. The logging layer allows higher layers to wrap updates to several blocks in a transaction, and ensures that the blocks are updated atomically in the face of crashes (i.e., all of them are updated or none). The inode layer provides individual files, each represented as an inode with a unique i number and some blocks holding the file’s data. The directory layer implements each directory as a special kind of inode whose content is a sequence of directory entries, each of which contains a file’s name and i-number. The pathname layer provides hierarchical path names like &#x2F;usr&#x2F;rtm&#x2F;xv6&#x2F;fs.c, and resolves them with recursive lookup. The file descriptor layer abstracts many Unix resources (e.g., pipes, devices, files, etc.) using the file system interface, simplifying the lives of application programmers.</p>
</blockquote>
<p>buffer cache：内存数据与硬盘数据映射（caching and synchronizing access to the disk）</p>
<blockquote>
<p>buffer cache维持双向链表，头部表示最近访问，尾部表示最久未访问<br>binit：在链表头部插入buf<br>bget：正向遍历现有buf，反向遍历空余位置<br>brelse：引用计数为0时将buf插入链表头部</p>
</blockquote>
<p>logging：实现事务保证，先写入日志块，然后写入实际块（效率挺低的）（provide crash recovery）<br>inode：索引节点硬盘数据与内存数据的维护<br>directory：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> &#123;</span><br>  ushort inum;<br>  <span class="hljs-type">char</span> name[DIRSIZ];<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/e88263d373824653b57aadd0faf179de.png" srcset="/img/loading.gif" lazyload><br><strong>硬盘数据布局：</strong><br>引导块 超级块	日志块 索引节点	位图	数据块<br><img src="https://img-blog.csdnimg.cn/6ceb5621012642d39b5d336e20e4fe54.png" srcset="/img/loading.gif" lazyload><br><strong>索引节点结构：</strong><br>直接查找+一级索引</p>
<h2 id="Large-files"><a href="#Large-files" class="headerlink" title="Large files"></a>Large files</h2><blockquote>
<p>Modify bmap() so that it implements a doubly-indirect block, in addition to direct blocks and a singly-indirect block. You’ll have to have only 11 direct blocks, rather than 12, to make room for your new doubly-indirect block; you’re not allowed to change the size of an on-disk inode. The first 11 elements of ip-&gt;addrs[] should be direct blocks; the 12th should be a singly-indirect block (just like the current one); the 13th should be your new doubly-indirect block. You are done with this exercise when bigfile writes 65803 blocks and usertests runs successfully</p>
</blockquote>
<p>这部分比较简单，只需要将一个直接查找的位置变成二级索引即可，根据hint实现较为简单。<br>修改dinode结构体与inode结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NDIRECT 11</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NINDIRECT (BSIZE / sizeof(uint))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NDOUBLYINDIRECT (BSIZE / sizeof(uint)) * NINDIRECT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXFILE (NDIRECT + NINDIRECT + NDOUBLYINDIRECT)</span><br><br><span class="hljs-comment">// On-disk inode structure</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dinode</span> &#123;</span><br>  <span class="hljs-type">short</span> type;               <span class="hljs-comment">// File type</span><br>  <span class="hljs-type">short</span> major;              <span class="hljs-comment">// Major device number (T_DEVICE only)</span><br>  <span class="hljs-type">short</span> minor;              <span class="hljs-comment">// Minor device number (T_DEVICE only)</span><br>  <span class="hljs-type">short</span> nlink;              <span class="hljs-comment">// Number of links to inode in file system</span><br>  uint size;                <span class="hljs-comment">// Size of file (bytes)</span><br>  uint addrs[NDIRECT + <span class="hljs-number">2</span>];  <span class="hljs-comment">// Data block addresses</span><br>&#125;;<br><br><span class="hljs-comment">// in-memory copy of an inode</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> &#123;</span><br>  uint dev;           <span class="hljs-comment">// Device number</span><br>  uint inum;          <span class="hljs-comment">// Inode number</span><br>  <span class="hljs-type">int</span> ref;            <span class="hljs-comment">// Reference count</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sleeplock</span> <span class="hljs-title">lock</span>;</span> <span class="hljs-comment">// protects everything below here</span><br>  <span class="hljs-type">int</span> valid;          <span class="hljs-comment">// inode has been read from disk?</span><br><br>  <span class="hljs-type">short</span> type;         <span class="hljs-comment">// copy of disk inode</span><br>  <span class="hljs-type">short</span> major;<br>  <span class="hljs-type">short</span> minor;<br>  <span class="hljs-type">short</span> nlink;<br>  uint size;<br>  uint addrs[NDIRECT+<span class="hljs-number">2</span>];<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>bmap函数，仿照一级索引块处理流程即可，二级索引块-&gt;一级索引块-&gt;数据块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> uint <span class="hljs-title function_">bmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ip, uint bn)</span> &#123;<br>  uint addr, *a, *b;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>, *<span class="hljs-title">buffer</span>;</span><br>  uint blk_no, blk_index;  <span class="hljs-comment">// 一级索引块块号以及索引块下标</span><br><br>  <span class="hljs-keyword">if</span> (bn &lt; NDIRECT) &#123;<br>    <span class="hljs-keyword">if</span> ((addr = ip-&gt;addrs[bn]) == <span class="hljs-number">0</span>) ip-&gt;addrs[bn] = addr = balloc(ip-&gt;dev);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br><br>  bn -= NDIRECT;<br>  <span class="hljs-keyword">if</span> (bn &lt; NINDIRECT) &#123;<br>    <span class="hljs-comment">// Load indirect block, allocating if necessary.</span><br>    <span class="hljs-keyword">if</span> ((addr = ip-&gt;addrs[NDIRECT]) == <span class="hljs-number">0</span>) ip-&gt;addrs[NDIRECT] = addr = balloc(ip-&gt;dev);<br>    bp = bread(ip-&gt;dev, addr);<br>    a = (uint *)bp-&gt;data;<br>    <span class="hljs-keyword">if</span> ((addr = a[bn]) == <span class="hljs-number">0</span>) &#123;<br>      a[bn] = addr = balloc(ip-&gt;dev);<br>      log_write(bp);<br>    &#125;<br>    brelse(bp);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br><br>  bn -= NINDIRECT;<br>  <span class="hljs-keyword">if</span> (bn &lt; NDOUBLYINDIRECT) &#123;<br>    <span class="hljs-comment">//  载入二级索引块</span><br>    <span class="hljs-keyword">if</span> ((addr = ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>] = addr = balloc(ip-&gt;dev);<br>    bp = bread(ip-&gt;dev, addr);<br>    a = (uint *)bp-&gt;data;<br>    <span class="hljs-comment">// 计算块号与下标</span><br>    blk_no = bn / NINDIRECT;<br>    blk_index = bn % NINDIRECT;<br>    <span class="hljs-comment">// 载入一级索引块</span><br>    <span class="hljs-keyword">if</span> ((addr = a[blk_no]) == <span class="hljs-number">0</span>) &#123;<br>      a[blk_no] = addr = balloc(ip-&gt;dev);<br>      log_write(bp);<br>    &#125;<br>    buffer = bread(ip-&gt;dev, addr);<br>    b = (uint *)buffer-&gt;data;<br>    <span class="hljs-comment">// 必要时分配数据块</span><br>    <span class="hljs-keyword">if</span> ((addr = b[blk_index]) == <span class="hljs-number">0</span>) &#123;<br>      b[blk_index] = addr = balloc(ip-&gt;dev);<br>      log_write(buffer);<br>    &#125;<br>    <span class="hljs-comment">// 释放buffer，返回数据块号</span><br>    brelse(buffer);<br>    brelse(bp);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br><br>  panic(<span class="hljs-string">&quot;bmap: out of range&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p> itrunc函数，对索引块先释放buffer再free，数据块则直接free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">itrunc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ip)</span> &#123;<br>  <span class="hljs-type">int</span> i, j;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>, *<span class="hljs-title">buffer</span>;</span><br>  uint *a, *b;<br><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NDIRECT; i++) &#123;<br>    <span class="hljs-keyword">if</span> (ip-&gt;addrs[i]) &#123;<br>      bfree(ip-&gt;dev, ip-&gt;addrs[i]);<br>      ip-&gt;addrs[i] = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (ip-&gt;addrs[NDIRECT]) &#123;<br>    bp = bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);<br>    a = (uint *)bp-&gt;data;<br>    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; NINDIRECT; j++) &#123;<br>      <span class="hljs-keyword">if</span> (a[j]) bfree(ip-&gt;dev, a[j]);<br>    &#125;<br>    brelse(bp);<br>    bfree(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);<br>    ip-&gt;addrs[NDIRECT] = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>]) &#123;<br>    <span class="hljs-comment">// 载入二级索引块</span><br>    bp = bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>]);<br>    a = (uint *)bp-&gt;data;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NINDIRECT; i++) &#123;<br>      <span class="hljs-comment">// 载入一级索引块</span><br>      <span class="hljs-keyword">if</span> (a[i] == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>      buffer = bread(ip-&gt;dev, a[i]);<br>      b = (uint *)buffer-&gt;data;<br>      <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; NINDIRECT; j++) &#123;<br>        <span class="hljs-comment">// 释放数据块</span><br>        <span class="hljs-keyword">if</span> (b[j] == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>        bfree(ip-&gt;dev, b[j]);<br>      &#125;<br>      <span class="hljs-comment">// 释放一级索引块</span><br>      brelse(buffer);<br>      bfree(ip-&gt;dev, a[i]);<br>    &#125;<br>    <span class="hljs-comment">// 释放二级索引块</span><br>    brelse(bp);<br>    bfree(ip-&gt;dev, ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>]);<br>    ip-&gt;addrs[NDIRECT + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  &#125;<br>  ip-&gt;size = <span class="hljs-number">0</span>;<br>  iupdate(ip);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="Symbolic-links"><a href="#Symbolic-links" class="headerlink" title="Symbolic links"></a>Symbolic links</h2><blockquote>
<p>You will implement the symlink(char *target, char *path) system call, which creates a new symbolic link at path that refers to file named by target. For further information, see the man page symlink. To test, add symlinktest to the Makefile and run it. Your solution is complete when the tests produce the following output (including usertests succeeding).</p>
</blockquote>
<p>这部分遇到了一些小问题，通过gdb解决了（第一次真正使用gdb调试qemu，之前调试都没啥效果）<br>首先补全symlink系统调用路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 用户空间调用</span><br>r = symlink(<span class="hljs-string">&quot;/testsymlink/a&quot;</span>, <span class="hljs-string">&quot;/testsymlink/b&quot;</span>);<br><span class="hljs-comment">// user.h中添加函数声明</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">symlink</span><span class="hljs-params">(<span class="hljs-type">char</span> *, <span class="hljs-type">char</span> *)</span>;<br><span class="hljs-comment">// syscall.h中添加调用号</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYS_symlink 22</span><br><span class="hljs-comment">// usys.pl中加入函数入口点</span><br>entry(<span class="hljs-string">&quot;symlink&quot;</span>);<br>生成代码：<br>.global symlink<br>symlink:<br> li a7, SYS_symlink<br> ecall<br> ret<br><span class="hljs-comment">// syscall.c中加入symlink内核函数声明与表项，使syscall函数能够跳转到sys_symlink函数</span><br><span class="hljs-keyword">extern</span> uint64 <span class="hljs-title function_">sys_symlink</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-title function_">uint64</span> <span class="hljs-params">(*syscalls[])</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> = &#123;<br>[SYS_symlink] sys_symlink,<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>然后定义文件类型与打开标志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_DIR 1      <span class="hljs-comment">// Directory</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_FILE 2     <span class="hljs-comment">// File</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_DEVICE 3   <span class="hljs-comment">// Device</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_SYMLINK 4  <span class="hljs-comment">// Symbolic links</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_RDONLY 0x000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_WRONLY 0x001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_RDWR 0x002</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_CREATE 0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_TRUNC 0x400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> O_NOFOLLOW 0x100</span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode *<span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-type">char</span> *path, <span class="hljs-type">short</span> type, <span class="hljs-type">short</span> major, <span class="hljs-type">short</span> minor)</span> &#123;<br>  ilock(ip);<br>  ip-&gt;major = major;<br>  ip-&gt;minor = minor;<br>  ip-&gt;nlink = <span class="hljs-number">1</span>;<br>  iupdate(ip);<br>  <span class="hljs-keyword">return</span> ip;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>sys_symlink函数实际上只需在path处创建一个SYMLINK类型的文件，将target写入文件即可。需要注意的是create方法调用后已经持有了ip-&gt;lock，不需要再次加锁。另外各操作应在begin_op()——end_op()，不然会报log_write outside of trans错误。<br>sys_symlink实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64 <span class="hljs-title function_">sys_symlink</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>;</span><br>  <span class="hljs-type">int</span> ret;<br>  <span class="hljs-type">char</span> target[MAXPATH], path[MAXPATH];<br>  <span class="hljs-comment">// 读取用户参数</span><br>  <span class="hljs-keyword">if</span> (argstr(<span class="hljs-number">0</span>, target, MAXPATH) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">if</span> (argstr(<span class="hljs-number">1</span>, path, MAXPATH) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  begin_op();<br>  <span class="hljs-comment">// 创建T_SYMLINK类型文件</span><br>  ip = create(path, T_SYMLINK, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (ip == <span class="hljs-number">0</span>) &#123;<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-comment">// 将链接的路径写入文件即可</span><br>  ret = writei(ip, <span class="hljs-number">0</span>, (uint64)target, <span class="hljs-number">0</span>, MAXPATH);<br>  iunlockput(ip);<br>  end_op();<br>  <span class="hljs-keyword">if</span> (ret != MAXPATH) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>sys_open中打开文件若没有O_NOFOLLOW标志则需要将inode节点指向真正链接的文件，拥有O_NOFOLLOW标志则照常运行。函数修改如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> inode *<span class="hljs-title function_">follow_link</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file_path)</span> &#123;<br>  <span class="hljs-type">char</span> path[MAXPATH];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>;</span><br>  <span class="hljs-type">int</span> ret;<br>  <span class="hljs-type">int</span> times = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// 拷贝相应路径</span><br>  <span class="hljs-built_in">strncpy</span>(path, file_path, MAXPATH);<br>  <span class="hljs-comment">// 循环迭代符号文件，深度超出10则报错</span><br>  <span class="hljs-keyword">for</span> (times = <span class="hljs-number">0</span>; times &lt; <span class="hljs-number">10</span>; times++) &#123;<br>    <span class="hljs-keyword">if</span> ((ip = namei(path)) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 加锁，访问索引节点内容</span><br>    ilock(ip);<br>    <span class="hljs-comment">// 若不为符号链接文件则返回相应inode</span><br>    <span class="hljs-keyword">if</span> (ip-&gt;type != T_SYMLINK) &#123;<br>      iunlock(ip);<br>      <span class="hljs-keyword">return</span> ip;<br>    &#125;<br>    <span class="hljs-comment">// 读取文件中链接路径</span><br>    ret = readi(ip, <span class="hljs-number">0</span>, (uint64)path, <span class="hljs-number">0</span>, MAXPATH);<br>    iunlock(ip);<br>    <span class="hljs-keyword">if</span> (ret != MAXPATH) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>uint64 <span class="hljs-title function_">sys_open</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-keyword">if</span> (omode &amp; O_CREATE) &#123;<br>    ip = create(path, T_FILE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (ip == <span class="hljs-number">0</span>) &#123;<br>      end_op();<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (omode &amp; O_NOFOLLOW) &#123;<br>      <span class="hljs-keyword">if</span> ((ip = namei(path)) == <span class="hljs-number">0</span>) &#123;<br>        end_op();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> ((ip = follow_link(path)) == <span class="hljs-number">0</span>) &#123;<br>        end_op();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>    &#125;<br>    ilock(ip);<br></code></pre></td></tr></table></figure>

<p>在follow_link函数实现时我错误地使用了iunlockput方法，使得inode的引用计数变为0了，在sys_open函数ilock的时候就会报ilock错误，实际上我在只需要调用iunlock解锁即可，不需要降低引用计数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">ilock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ip)</span> &#123;<br>  <span class="hljs-keyword">if</span> (ip == <span class="hljs-number">0</span> || ip-&gt;ref &lt; <span class="hljs-number">1</span>) panic(<span class="hljs-string">&quot;ilock&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>gdb调试过程如下：<br>由于错误使用函数，故系统引导时就会报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">xv6 kernel is booting<br>panic: ilock<br></code></pre></td></tr></table></figure>
<p>参考博客<a target="_blank" rel="noopener" href="https://xistor.github.io/post/6.s081/xv6-gdb/">qemu xv6 使用GDB调试</a><br>1	创建～&#x2F;.gdbinit写入以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">add-auto-load-safe-path /home/x/xv6-labs-2021/.gdbinit<br><span class="hljs-built_in">set</span> auto-load safe-path /<br></code></pre></td></tr></table></figure>
<p>2 在一个终端运行make qemu-gdb，另一个终端运行gdb-multiarch</p>
<p>在lab目录下的.gdbinit文件中已经导入了内核符号表（kernel&#x2F;kernel），故不需要再次导入（调试用户程序需要导入相应的用户程序符号表）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> confirm off<br><span class="hljs-built_in">set</span> architecture riscv:rv64<br>target remote 127.0.0.1:25000<br>symbol-file kernel/kernel<br><span class="hljs-built_in">set</span> disassemble-next-line auto<br><span class="hljs-built_in">set</span> riscv use-compressed-breakpoints <span class="hljs-built_in">yes</span><br></code></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/19bf0ac903f541e284558e185d9b0957.png" srcset="/img/loading.gif" lazyload><br>此时已经可以使用普通的gdb进行调试，判断错误在follow_link函数后，将该函数设置为断点<br><img src="https://img-blog.csdnimg.cn/1c61bbdc27484c638b3e742f9d48ea9d.png" srcset="/img/loading.gif" lazyload><br>此时就能明显发现iunlockput函数的错误使用。</p>
<p>修改Makefile，加入symlinktest</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">UPROGS=\<br>	<span class="hljs-variable">$U</span>/_cat\<br>	<span class="hljs-variable">$U</span>/_echo\<br>	<span class="hljs-variable">$U</span>/_forktest\<br>	<span class="hljs-variable">$U</span>/_grep\<br>	<span class="hljs-variable">$U</span>/_init\<br>	<span class="hljs-variable">$U</span>/_kill\<br>	<span class="hljs-variable">$U</span>/_ln\<br>	<span class="hljs-variable">$U</span>/_ls\<br>	<span class="hljs-variable">$U</span>/_mkdir\<br>	<span class="hljs-variable">$U</span>/_rm\<br>	<span class="hljs-variable">$U</span>/_sh\<br>	<span class="hljs-variable">$U</span>/_stressfs\<br>	<span class="hljs-variable">$U</span>/_usertests\<br>	<span class="hljs-variable">$U</span>/_grind\<br>	<span class="hljs-variable">$U</span>/_wc\<br>	<span class="hljs-variable">$U</span>/_zombie\<br>	<span class="hljs-variable">$U</span>/_symlinktest\<br></code></pre></td></tr></table></figure>

<p>修改timeout时间，避免测试超时（全部加个0）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">40</span>, <span class="hljs-string">&quot;running bigfile&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_bigfile</span>():<br>    r.run_qemu(shell_script([<br>        <span class="hljs-string">&#x27;bigfile&#x27;</span><br>    ]), timeout=<span class="hljs-number">1800</span>)<br>    r.<span class="hljs-keyword">match</span>(<span class="hljs-string">&#x27;^wrote 65803 blocks$&#x27;</span>)<br>    r.<span class="hljs-keyword">match</span>(<span class="hljs-string">&#x27;^bigfile done; ok$&#x27;</span>)<br><br><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">0</span>, <span class="hljs-string">&quot;running symlinktest&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_symlinktest</span>():<br>    r.run_qemu(shell_script([<br>        <span class="hljs-string">&#x27;symlinktest&#x27;</span><br>    ]), timeout=<span class="hljs-number">200</span>)<br><br><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">20</span>, <span class="hljs-string">&quot;symlinktest: symlinks&quot;</span>, parent=test_symlinktest</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_symlinktest_symlinks</span>():<br>    r.<span class="hljs-keyword">match</span>(<span class="hljs-string">&quot;^test symlinks: ok$&quot;</span>)<br><br><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">20</span>, <span class="hljs-string">&quot;symlinktest: concurrent symlinks&quot;</span>, parent=test_symlinktest</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_symlinktest_symlinks</span>():<br>    r.<span class="hljs-keyword">match</span>(<span class="hljs-string">&quot;^test concurrent symlinks: ok$&quot;</span>)<br><br><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">19</span>, <span class="hljs-string">&quot;usertests&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_usertests</span>():<br>    r.run_qemu(shell_script([<br>        <span class="hljs-string">&#x27;usertests&#x27;</span><br>    ]), timeout=<span class="hljs-number">3600</span>)<br>    r.<span class="hljs-keyword">match</span>(<span class="hljs-string">&#x27;^ALL TESTS PASSED$&#x27;</span>)<br><br><span class="hljs-meta">@test(<span class="hljs-params"><span class="hljs-number">1</span>, <span class="hljs-string">&quot;time&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_time</span>():<br>    check_time()<br><br></code></pre></td></tr></table></figure>
<p>测试通过截图：<br><img src="https://img-blog.csdnimg.cn/e8b6cb3906ce4de4986ac3528f159fc5.png" srcset="/img/loading.gif" lazyload></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%9B%BD%E5%A4%96%E8%AF%BE%E7%A8%8B%E5%AE%9E%E9%AA%8C/" class="category-chain-item">国外课程实验</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/file-system-6-081/" class="print-no-link">#file system 6.081</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/MIT6.S081%202021%20mmap.html" title="MIT6.S081 2021 mmap">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MIT6.S081 2021 mmap</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8A%E6%9C%BA%E4%BD%9C%E4%B8%9A.html" title="算法分析上机作业">
                        <span class="hidden-mobile">算法分析上机作业</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz","appKey":"0e2MMh7ddBCGGytOe9UEy5NP","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://uu0wegco.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
