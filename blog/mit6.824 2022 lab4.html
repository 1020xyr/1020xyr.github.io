

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg">
  <link rel="icon" href="/img/nano-1.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="最佳损友1020">
  <meta name="keywords" content="">
  
    <meta name="description" content="汇总博客：MIT6.824 2022lab地址lab4内容比较多，建议先读几遍实验介绍，以确保完全理解实验内容  The main challenge in this lab will be handling reconfiguration – changes in the assignment of shards to groups. Within a single replica gr">
<meta property="og:type" content="article">
<meta property="og:title" content="mit6.824 2022 lab4">
<meta property="og:url" content="https://www.jiasun.top/blog/mit6.824%202022%20lab4.html">
<meta property="og:site_name" content="最佳损友1020’s Blog">
<meta property="og:description" content="汇总博客：MIT6.824 2022lab地址lab4内容比较多，建议先读几遍实验介绍，以确保完全理解实验内容  The main challenge in this lab will be handling reconfiguration – changes in the assignment of shards to groups. Within a single replica gr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/d955d5df0ba54cc59d0659803b03e434.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/aadde85ababd4372860f5ed1c985a4db.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/44f37918a6224bc6990597122783be3d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c80d5f0676d44ea29972c5c2b09ea8ad.png">
<meta property="article:published_time" content="2022-11-24T00:00:08.000Z">
<meta property="article:modified_time" content="2023-10-31T14:45:59.302Z">
<meta property="article:author" content="最佳损友1020">
<meta property="article:tag" content="Sharded kv 6.824 lab4 shardkv">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/d955d5df0ba54cc59d0659803b03e434.png">
  
  
  
  <title>mit6.824 2022 lab4 - 最佳损友1020’s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn.css">
<link rel="stylesheet" href="/css/top.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.jiasun.top","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz","app_key":"ljkRZDiTtVmjn5mpaQmpFqgv","server_url":"https://n227fxnj.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>最佳损友1020</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="mit6.824 2022 lab4"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-24 08:00" pubdate>
          2022年11月24日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          57k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          474 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">mit6.824 2022 lab4</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />



<p>汇总博客：<a href="https://www.jiasun.top/blog/mit6.824%202022.html">MIT6.824 2022</a><br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-shard.html">lab地址</a><br>lab4内容比较多，建议先读几遍实验介绍，以确保完全理解实验内容</p>
<blockquote>
<p>The main challenge in this lab will be handling reconfiguration – changes in the assignment of shards to groups. Within a single replica group, all group members must agree on when a reconfiguration occurs relative to client Put&#x2F;Append&#x2F;Get requests. For example, a Put may arrive at about the same time as a reconfiguration that causes the replica group to stop being responsible for the shard holding the Put’s key. All replicas in the group must agree on whether the Put occurred before or after the reconfiguration. If before, the Put should take effect and the new owner of the shard will see its effect; if after, the Put won’t take effect and client must re-try at the new owner. The recommended approach is to have each replica group use Raft to log not just the sequence of Puts, Appends, and Gets but also the sequence of reconfigurations. You will need to ensure that at most one replica group is serving requests for each shard at any one time.</p>
</blockquote>
<h2 id="4A"><a href="#4A" class="headerlink" title="4A"></a>4A</h2><p>4A部分的实现比较简单，把lab3的代码拿来改改就可以了，大体框架一模一样。主要的实现就是rebalance。<br>刚开始我实现了一个还算简洁的rebalance算法，前面所有测试都过了，但最后一个测试Test: Check Same config on servers …却无法通过。<br><img src="https://img-blog.csdnimg.cn/d955d5df0ba54cc59d0659803b03e434.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/aadde85ababd4372860f5ed1c985a4db.png" srcset="/img/loading.gif" lazyload><br>虽然各个节点拥有分区数一样，但具体分区的拥有者却不一致，后面才发现go中的map的遍历顺序竟然是随机的。<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7006197015319166990">【Golang】如何有序地遍历 Map</a><br>这也就是Hint中not deterministic的意思</p>
<blockquote>
<p>The code in your state machine that performs the shard rebalancing needs to be deterministic. In Go, map iteration order is not deterministic.</p>
</blockquote>
<p>然后我使用博客的第一种方法，将 Map 中的 key 拿出来，放入 slice 中做排序。<br>以Join为例，简要介绍我的reblance算法（臃肿）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">分配的原理：最后的分区分布一定是[mean,mean,...,mean+1,mean+1]<br>问题的关键是哪些节点为mean+1，哪些节点为mean<br>如果当前节点的分区数超过mean，那么将它设置为mean+1可以减少移动量<br>若还有分区未分配完，则任意找到分区数为mean的节点，将其分区数设为mean+1<br><br>通过这个原理，可以得到节点-分区数映射<br>现在已知节点-分区数映射，如何正确设置分区数组<br>复制上次的分区-节点数组，遍历两次数组<br>第一次遍历：<br>1 如果分区对应节点当前分区数大于0，同样将该分区分配给该节点，分区数-1<br>2 如果分区对应节点当前分区数等于0，将该分区标记为未分配（0）<br>第二次遍历：<br>将所有未分配的分区分配出去<br></code></pre></td></tr></table></figure>
<p>其他：<br>为简化代码，可以直接向Start函数传递RPC的arg，applyCh接收任务中将msg.Command强制类型转换各个请求参数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">index, _, isLeader := sc.rf.Start(*args)<br><br><br><span class="hljs-keyword">switch</span> op := msg.Command.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> JoinArgs:<br><span class="hljs-keyword">case</span> LeaveArgs:<br><span class="hljs-keyword">case</span> MoveArgs:<br><span class="hljs-keyword">case</span> QueryArgs:<br>&#125;			<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1072536">Go语言interface详解</a></p>
<p>NShards的疑惑：按理来说，分区数应该设的比节点数大很多，故我将其设为256，但4B的TestStaticShards测试却要求分区数为10，这样ndone才一定为5。由于节点数可能大于分区数，有些节点可能并没有相应的分区，故Leave操作中需进行一些额外的操作，加入分区数为0的节点。</p>
<h3 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h3><p><strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Clerk <span class="hljs-keyword">struct</span> &#123;<br>	servers []*labrpc.ClientEnd<br>	<span class="hljs-comment">// Your data here.</span><br>	serverNumber  <span class="hljs-type">int</span>   <span class="hljs-comment">// 服务器节点数</span><br>	clientId      <span class="hljs-type">int64</span> <span class="hljs-comment">// 随机生成的客户端ID</span><br>	currentSeqNum <span class="hljs-type">int64</span> <span class="hljs-comment">// 当前序列号</span><br>	lastLeader    <span class="hljs-type">int</span>   <span class="hljs-comment">// 上次成功连接的leader</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nrand</span><span class="hljs-params">()</span></span> <span class="hljs-type">int64</span> &#123;<br>	max := big.NewInt(<span class="hljs-type">int64</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">62</span>)<br>	bigx, _ := rand.Int(rand.Reader, max)<br>	x := bigx.Int64()<br>	<span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MakeClerk</span><span class="hljs-params">(servers []*labrpc.ClientEnd)</span></span> *Clerk &#123;<br>	ck := <span class="hljs-built_in">new</span>(Clerk)<br>	ck.servers = servers<br>	<span class="hljs-comment">// Your code here.</span><br>	ck.serverNumber = <span class="hljs-built_in">len</span>(servers)<br>	ck.clientId = nrand() <span class="hljs-comment">// 生成随机的ID</span><br>	ck.currentSeqNum = <span class="hljs-number">0</span><br>	ck.lastLeader = <span class="hljs-number">0</span><br>	<span class="hljs-keyword">return</span> ck<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Query(num <span class="hljs-type">int</span>) Config &#123;<br>	args := QueryArgs&#123;Num: num, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 首先尝试上次成功的leader</span><br>		<span class="hljs-keyword">for</span> i := ck.lastLeader; i &lt; ck.lastLeader+ck.serverNumber; i++ &#123;<br>			srv := ck.servers[i%ck.serverNumber]<br>			<span class="hljs-keyword">var</span> reply QueryReply<br>			ok := srv.Call(<span class="hljs-string">&quot;ShardCtrler.Query&quot;</span>, &amp;args, &amp;reply)<br>			<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>				ck.lastLeader = i % ck.serverNumber<br>				<span class="hljs-keyword">return</span> reply.Config<br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Join(servers <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>) &#123;<br>	args := JoinArgs&#123;Servers: servers, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 首先尝试上次成功的leader</span><br>		<span class="hljs-keyword">for</span> i := ck.lastLeader; i &lt; ck.lastLeader+ck.serverNumber; i++ &#123;<br>			srv := ck.servers[i%ck.serverNumber]<br>			<span class="hljs-keyword">var</span> reply JoinReply<br>			ok := srv.Call(<span class="hljs-string">&quot;ShardCtrler.Join&quot;</span>, &amp;args, &amp;reply)<br>			<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>				ck.lastLeader = i % ck.serverNumber<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Leave(gids []<span class="hljs-type">int</span>) &#123;<br>	args := LeaveArgs&#123;GIDs: gids, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 首先尝试上次成功的leader</span><br>		<span class="hljs-keyword">for</span> i := ck.lastLeader; i &lt; ck.lastLeader+ck.serverNumber; i++ &#123;<br>			srv := ck.servers[i%ck.serverNumber]<br>			<span class="hljs-keyword">var</span> reply LeaveReply<br>			ok := srv.Call(<span class="hljs-string">&quot;ShardCtrler.Leave&quot;</span>, &amp;args, &amp;reply)<br>			<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>				ck.lastLeader = i % ck.serverNumber<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Move(shard <span class="hljs-type">int</span>, gid <span class="hljs-type">int</span>) &#123;<br>	args := MoveArgs&#123;Shard: shard, GID: gid, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// 首先尝试上次成功的leader</span><br>		<span class="hljs-keyword">for</span> i := ck.lastLeader; i &lt; ck.lastLeader+ck.serverNumber; i++ &#123;<br>			srv := ck.servers[i%ck.serverNumber]<br>			<span class="hljs-keyword">var</span> reply MoveReply<br>			ok := srv.Call(<span class="hljs-string">&quot;ShardCtrler.Move&quot;</span>, &amp;args, &amp;reply)<br>			<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>				ck.lastLeader = i % ck.serverNumber<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>common.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// The number of shards.</span><br><span class="hljs-keyword">const</span> NShards = <span class="hljs-number">10</span> <span class="hljs-comment">// 4B测试TestStaticShards的要求</span><br><br><span class="hljs-comment">// A configuration -- an assignment of shards to groups.</span><br><span class="hljs-comment">// Please don&#x27;t change this.</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>	Num    <span class="hljs-type">int</span>              <span class="hljs-comment">// config number</span><br>	Shards [NShards]<span class="hljs-type">int</span>     <span class="hljs-comment">// shard -&gt; gid</span><br>	Groups <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span> <span class="hljs-comment">// gid -&gt; servers[]</span><br>&#125;<br><span class="hljs-keyword">type</span> Err <span class="hljs-type">string</span><br><br><span class="hljs-keyword">const</span> ( <span class="hljs-comment">// 错误类型</span><br>	OK             = <span class="hljs-string">&quot;OK&quot;</span><br>	ErrNoKey       = <span class="hljs-string">&quot;ErrNoKey&quot;</span><br>	ErrWrongLeader = <span class="hljs-string">&quot;ErrWrongLeader&quot;</span><br>	ErrTimeout     = <span class="hljs-string">&quot;ErrTimeout&quot;</span><br>	ErrOldRequest  = <span class="hljs-string">&quot;ErrOldRequest&quot;</span> <span class="hljs-comment">// 未出现</span><br>	ErrLogFull     = <span class="hljs-string">&quot;ErrLogFull&quot;</span>    <span class="hljs-comment">// 未用到</span><br>)<br><br><span class="hljs-keyword">type</span> ReqResult <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 命令执行返回</span><br>	SequenceNum <span class="hljs-type">int64</span>  <span class="hljs-comment">// 命令序列号</span><br>	Status      Err    <span class="hljs-comment">// 命令执行状态</span><br>	Config      Config <span class="hljs-comment">// 命令执行结果</span><br>&#125;<br><br><span class="hljs-keyword">type</span> JoinArgs <span class="hljs-keyword">struct</span> &#123;<br>	Servers <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span> <span class="hljs-comment">// new GID -&gt; servers mappings</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> JoinReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>&#125;<br><br><span class="hljs-keyword">type</span> LeaveArgs <span class="hljs-keyword">struct</span> &#123;<br>	GIDs []<span class="hljs-type">int</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> LeaveReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>&#125;<br><br><span class="hljs-keyword">type</span> MoveArgs <span class="hljs-keyword">struct</span> &#123;<br>	Shard <span class="hljs-type">int</span><br>	GID   <span class="hljs-type">int</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> MoveReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>&#125;<br><br><span class="hljs-keyword">type</span> QueryArgs <span class="hljs-keyword">struct</span> &#123;<br>	Num <span class="hljs-type">int</span> <span class="hljs-comment">// desired config number</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> QueryReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>	Config Config<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> Debug = <span class="hljs-literal">true</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DPrintf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> Debug &#123;<br>		log.Printf(format, a...)<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">const</span> (<br>	GeneralPollFrequency  = <span class="hljs-number">5</span> * time.Millisecond   <span class="hljs-comment">// 轮询时间</span><br>	TimeoutThreshold      = <span class="hljs-number">200</span> * time.Millisecond <span class="hljs-comment">// 超时阈值</span><br>	SnapshotPollFrequency = <span class="hljs-number">100</span> * time.Millisecond <span class="hljs-comment">// 快照轮询时间</span><br>)<br><br><span class="hljs-keyword">type</span> ShardCtrler <span class="hljs-keyword">struct</span> &#123;<br>	mu      sync.Mutex<br>	me      <span class="hljs-type">int</span><br>	rf      *raft.Raft<br>	applyCh <span class="hljs-keyword">chan</span> raft.ApplyMsg<br><br>	<span class="hljs-comment">// Your data here.</span><br><br>	configs             []Config            <span class="hljs-comment">// indexed by config num</span><br>	currentConfigNumber <span class="hljs-type">int</span>                 <span class="hljs-comment">// 当前配置编号</span><br>	clientCache         <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult <span class="hljs-comment">// 存放各个客户端最新结果</span><br>	commitIndex         <span class="hljs-type">int</span><br>	dead                <span class="hljs-type">int32</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigCopy</span><span class="hljs-params">(config Config)</span></span> Config &#123; <span class="hljs-comment">// 复制节点配置</span><br>	newConfig := config<br>	newConfig.Groups = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>)<br>	<span class="hljs-keyword">for</span> gid, name := <span class="hljs-keyword">range</span> config.Groups &#123;<br>		newConfig.Groups[gid] = name<br>	&#125;<br>	<span class="hljs-keyword">return</span> newConfig<br>&#125;<br><br><span class="hljs-comment">// Join Leave Move Query函数处理流程完全一致</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Join(args *JoinArgs, reply *JoinReply) &#123;<br>	requestBegin := time.Now()<br>	sc.mu.Lock()<br>	index, _, isLeader := sc.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>	sc.mu.Unlock()<br>	<span class="hljs-keyword">if</span> !isLeader &#123; <span class="hljs-comment">// 当前节点不是leader节点，返回错误</span><br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		sc.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := sc.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> sc.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		sc.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Leave(args *LeaveArgs, reply *LeaveReply) &#123;<br>	requestBegin := time.Now()<br>	sc.mu.Lock()<br>	index, _, isLeader := sc.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>	sc.mu.Unlock()<br>	<span class="hljs-keyword">if</span> !isLeader &#123; <span class="hljs-comment">// 当前节点不是leader节点，返回错误</span><br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		sc.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := sc.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> sc.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		sc.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Move(args *MoveArgs, reply *MoveReply) &#123;<br>	requestBegin := time.Now()<br>	sc.mu.Lock()<br>	index, _, isLeader := sc.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>	sc.mu.Unlock()<br>	<span class="hljs-keyword">if</span> !isLeader &#123; <span class="hljs-comment">// 当前节点不是leader节点，返回错误</span><br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		sc.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := sc.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> sc.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		sc.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Query(args *QueryArgs, reply *QueryReply) &#123;<br>	requestBegin := time.Now()<br>	sc.mu.Lock()<br>	index, _, isLeader := sc.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>	sc.mu.Unlock()<br>	<span class="hljs-keyword">if</span> !isLeader &#123; <span class="hljs-comment">// 当前节点不是leader节点，返回错误</span><br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		sc.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := sc.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> sc.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			reply.Config = cache.Config <span class="hljs-comment">// 返回请求配置</span><br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		sc.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Kill() &#123;<br>	sc.rf.Kill()<br>	<span class="hljs-comment">// Your code here, if desired.</span><br>	atomic.StoreInt32(&amp;sc.dead, <span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-comment">// 判断ShardCtrler生命状态</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> killed() <span class="hljs-type">bool</span> &#123;<br>	z := atomic.LoadInt32(&amp;sc.dead)<br>	<span class="hljs-keyword">return</span> z == <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">// needed by shardkv tester</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> Raft() *raft.Raft &#123;<br>	<span class="hljs-keyword">return</span> sc.rf<br>&#125;<br><br><span class="hljs-comment">// 获取各个GID对应的分区数目</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getNodeMap</span><span class="hljs-params">(Shards [NShards]<span class="hljs-type">int</span>)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span> &#123;<br>	ans := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; NShards; i++ &#123;<br>		<span class="hljs-keyword">if</span> Shards[i] != <span class="hljs-number">0</span> &#123;<br>			ans[Shards[i]]++<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ans<br>&#125;<br><br><span class="hljs-comment">// 遍历map找到当前分区数不为0的GID，number为GID-分区数，gids为GID升序序列</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findNotZeroNode</span><span class="hljs-params">(numbers <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>, gids []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> gids &#123;<br>		times := numbers[gid]<br>		<span class="hljs-keyword">if</span> times != <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-keyword">return</span> gid<br>		&#125;<br>	&#125;<br>	log.Panicf(<span class="hljs-string">&quot;findNotZeroNode: can&#x27;t find GID&quot;</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-comment">// 获取map中key的升序排列</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getSortKeys</span><span class="hljs-params">(m <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">var</span> keys []<span class="hljs-type">int</span><br>	<span class="hljs-keyword">for</span> k := <span class="hljs-keyword">range</span> m &#123;<br>		keys = <span class="hljs-built_in">append</span>(keys, k)<br>	&#125;<br>	sort.Ints(keys)<br>	<span class="hljs-keyword">return</span> keys<br>&#125;<br><br><span class="hljs-comment">// 获取新的节点-分区映射，oldShards为上次的节点-分区映射，newNode为新加入的节点，number为当前节点数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getNewShardForJoin</span><span class="hljs-params">(oldShards [NShards]<span class="hljs-type">int</span>, newNode []<span class="hljs-type">int</span>, number <span class="hljs-type">int</span>)</span></span> [NShards]<span class="hljs-type">int</span> &#123;<br>	oldShardMap := getNodeMap(oldShards)<br>	oldSortGID := getSortKeys(oldShardMap)<br><br>	newShardMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>	mean := NShards / number<br>	reminder := NShards - number*mean<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		分配的原理：最后的分区分布一定是[mean,mean,...,mean+1,mean+1]</span><br><span class="hljs-comment">		问题的关键是哪些节点为mean+1，哪些节点为mean</span><br><span class="hljs-comment">		如果当前节点的分区数超过mean，那么将它设置为mean+1可以减少移动量</span><br><span class="hljs-comment">		若还有分区未分配完，则任意找到分区数为mean的节点，将其分区数设为mean+1</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> oldSortGID &#123;<br>		times := oldShardMap[gid]<br>		<span class="hljs-keyword">if</span> times &gt; mean &amp;&amp; reminder &gt; <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 当前分区数超过mean且未分配完</span><br>			newShardMap[gid] = mean + <span class="hljs-number">1</span><br>			reminder--<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			newShardMap[gid] = mean<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> newNode &#123; <span class="hljs-comment">// 将新加入的节点设为mean</span><br>		newShardMap[gid] = mean<br>	&#125;<br>	newSortGID := getSortKeys(newShardMap)<br><br>	<span class="hljs-keyword">if</span> reminder &gt; <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 找到分区数为mean的节点，将其分区数设置为mean+1</span><br>		<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> newSortGID &#123;<br>			times := newShardMap[gid]<br>			<span class="hljs-keyword">if</span> reminder == <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> times == mean &#123;<br>				newShardMap[gid] = mean + <span class="hljs-number">1</span><br>				reminder--<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		现在已知节点-分区数映射，如何正确设置分区数组</span><br><span class="hljs-comment">		复制上次的分区-节点数组，遍历两次数组</span><br><span class="hljs-comment">		第一次遍历：</span><br><span class="hljs-comment">		1 如果分区对应节点当前分区数大于0，同样将该分区分配给该节点，分区数-1</span><br><span class="hljs-comment">		2 如果分区对应节点当前分区数等于0，将该分区标记为未分配（0）</span><br><span class="hljs-comment">		第二次遍历：</span><br><span class="hljs-comment">		将所有未分配的分区分配出去</span><br><span class="hljs-comment">	*/</span><br>	newShards := oldShards<br>	<span class="hljs-comment">// 第一次遍历</span><br>	<span class="hljs-keyword">for</span> shard, gid := <span class="hljs-keyword">range</span> newShards &#123;<br>		<span class="hljs-keyword">if</span> newShardMap[gid] &gt; <span class="hljs-number">0</span> &#123;<br>			newShardMap[gid]--<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			newShards[shard] = <span class="hljs-number">0</span><br>		&#125;<br>	&#125;<br>	newShardMap[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>	curAssignNode := <span class="hljs-number">0</span><br>	<span class="hljs-comment">// 第二次遍历</span><br>	<span class="hljs-keyword">for</span> shard, gid := <span class="hljs-keyword">range</span> newShards &#123;<br>		<span class="hljs-keyword">if</span> gid == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 未分配分区</span><br>			<span class="hljs-keyword">if</span> newShardMap[curAssignNode] == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 该节点分区为0，寻找下一个非0节点</span><br>				curAssignNode = findNotZeroNode(newShardMap, newSortGID)<br>			&#125;<br>			newShards[shard] = curAssignNode<br>			newShardMap[curAssignNode]--<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> newShards<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getNewShardForLeave</span><span class="hljs-params">(oldShards [NShards]<span class="hljs-type">int</span>, leaveNode []<span class="hljs-type">int</span>, number <span class="hljs-type">int</span>, group <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>)</span></span> [NShards]<span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">if</span> number == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> [NShards]<span class="hljs-type">int</span>&#123;&#125;<br>	&#125;<br>	oldShardMap := getNodeMap(oldShards)<br>	<span class="hljs-keyword">for</span> gid, _ := <span class="hljs-keyword">range</span> group &#123;<br>		<span class="hljs-keyword">if</span> _, exist := oldShardMap[gid]; !exist &#123; <span class="hljs-comment">// 加入尚未有任何分区的节点</span><br>			oldShardMap[gid] = <span class="hljs-number">0</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> leaveNode &#123; <span class="hljs-comment">// 删除离去节点kv项</span><br>		<span class="hljs-built_in">delete</span>(oldShardMap, gid)<br>	&#125;<br>	newShardMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>	sortGID := getSortKeys(oldShardMap)<br>	oldMean := NShards / (number + <span class="hljs-built_in">len</span>(leaveNode)) <span class="hljs-comment">// 之前的均值</span><br>	mean := NShards / number                       <span class="hljs-comment">// 当前的均值</span><br>	reminder := NShards - number*mean              <span class="hljs-comment">// 余数</span><br>	<span class="hljs-comment">// leave的原理与join类似，在确定分布为[mean,mean..mean+1,mean+1]的情况下，尽可能较小移动量</span><br>	<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> sortGID &#123;<br>		times := oldShardMap[gid]<br>		<span class="hljs-keyword">if</span> times &gt; oldMean &amp;&amp; reminder &gt; <span class="hljs-number">0</span> &#123;<br>			newShardMap[gid] = mean + <span class="hljs-number">1</span><br>			reminder--<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			newShardMap[gid] = mean<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> reminder &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">for</span> _, gid := <span class="hljs-keyword">range</span> sortGID &#123;<br>			times := newShardMap[gid]<br>			<span class="hljs-keyword">if</span> reminder == <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> times == mean &#123;<br>				newShardMap[gid] = mean + <span class="hljs-number">1</span><br>				reminder--<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 同样进行两次遍历</span><br>	newShards := oldShards<br>	<span class="hljs-comment">// 第一次遍历</span><br>	<span class="hljs-keyword">for</span> shard, gid := <span class="hljs-keyword">range</span> newShards &#123;<br>		<span class="hljs-keyword">if</span> newShardMap[gid] &gt; <span class="hljs-number">0</span> &#123;<br>			newShardMap[gid]--<br>		&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 不存在的元素为0值</span><br>			newShards[shard] = <span class="hljs-number">0</span> <span class="hljs-comment">// 标记为未分配</span><br>		&#125;<br>	&#125;<br>	newShardMap[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>	curAssignNode := <span class="hljs-number">0</span><br>	<span class="hljs-comment">// 第二次遍历</span><br>	<span class="hljs-keyword">for</span> shard, gid := <span class="hljs-keyword">range</span> newShards &#123;<br>		<span class="hljs-keyword">if</span> gid == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 未分配分区</span><br>			<span class="hljs-keyword">if</span> newShardMap[curAssignNode] == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 该节点分区为0，寻找下一个非0节点</span><br>				curAssignNode = findNotZeroNode(newShardMap, sortGID)<br>			&#125;<br>			newShards[shard] = curAssignNode<br>			newShardMap[curAssignNode]--<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> newShards<br>&#125;<br><br><span class="hljs-comment">// 接受raft消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sc *ShardCtrler)</span></span> receiveTask() &#123;<br>	<span class="hljs-keyword">for</span> !sc.killed() &#123;<br>		msg := &lt;-sc.applyCh<br>		sc.mu.Lock()<br>		<span class="hljs-keyword">if</span> msg.CommandValid &#123; <span class="hljs-comment">// 普通的日志消息</span><br>			sc.commitIndex = msg.CommandIndex<br>			<span class="hljs-keyword">switch</span> op := msg.Command.(<span class="hljs-keyword">type</span>) &#123;<br>			<span class="hljs-keyword">case</span> JoinArgs:<br>				cache := sc.clientCache[op.ClientId]    <span class="hljs-comment">// 查看相应客户端缓存</span><br>				<span class="hljs-keyword">if</span> cache.SequenceNum &lt; op.SequenceNum &#123; <span class="hljs-comment">// 执行请求，自动覆盖之前的结果</span><br>					oldConfig := sc.configs[sc.currentConfigNumber]<br>					sc.currentConfigNumber++<br>					<span class="hljs-keyword">var</span> newConfig Config<br>					newConfig.Num = sc.currentConfigNumber<br>					newConfig.Groups = <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>&#123;&#125;<br>					<span class="hljs-keyword">var</span> newNode []<span class="hljs-type">int</span><br>					<span class="hljs-comment">// 添加参数中的映射</span><br>					<span class="hljs-keyword">for</span> gid, name := <span class="hljs-keyword">range</span> op.Servers &#123;<br>						newConfig.Groups[gid] = name<br>						newNode = <span class="hljs-built_in">append</span>(newNode, gid)<br>					&#125;<br>					<span class="hljs-comment">// 添加上次配置的映射</span><br>					<span class="hljs-keyword">for</span> gid, name := <span class="hljs-keyword">range</span> oldConfig.Groups &#123;<br>						newConfig.Groups[gid] = name<br>					&#125;<br>					newConfig.Shards = getNewShardForJoin(oldConfig.Shards, newNode, <span class="hljs-built_in">len</span>(newConfig.Groups))<br>					sc.configs = <span class="hljs-built_in">append</span>(sc.configs, newConfig)<br>					sc.clientCache[op.ClientId] = ReqResult&#123;SequenceNum: op.SequenceNum, Status: OK&#125;<br>				&#125;<br>			<span class="hljs-keyword">case</span> LeaveArgs:<br>				cache := sc.clientCache[op.ClientId]    <span class="hljs-comment">// 查看相应客户端缓存</span><br>				<span class="hljs-keyword">if</span> cache.SequenceNum &lt; op.SequenceNum &#123; <span class="hljs-comment">// 执行请求，自动覆盖之前的结果</span><br>					oldConfig := sc.configs[sc.currentConfigNumber]<br>					sc.currentConfigNumber++<br>					<span class="hljs-keyword">var</span> newConfig Config<br>					newConfig.Num = sc.currentConfigNumber<br>					newConfig.Groups = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>)<br>					<span class="hljs-comment">// 添加上次的映射</span><br>					<span class="hljs-keyword">for</span> gid, name := <span class="hljs-keyword">range</span> oldConfig.Groups &#123;<br>						newConfig.Groups[gid] = name<br>					&#125;<br>					<span class="hljs-comment">// 删除离开节点的映射</span><br>					<span class="hljs-keyword">for</span> _, leaveGid := <span class="hljs-keyword">range</span> op.GIDs &#123;<br>						<span class="hljs-built_in">delete</span>(newConfig.Groups, leaveGid)<br>					&#125;<br>					newConfig.Shards = getNewShardForLeave(oldConfig.Shards, op.GIDs, <span class="hljs-built_in">len</span>(newConfig.Groups), newConfig.Groups)<br>					sc.configs = <span class="hljs-built_in">append</span>(sc.configs, newConfig)<br>					sc.clientCache[op.ClientId] = ReqResult&#123;SequenceNum: op.SequenceNum, Status: OK&#125;<br>				&#125;<br>			<span class="hljs-keyword">case</span> MoveArgs:<br>				cache := sc.clientCache[op.ClientId]    <span class="hljs-comment">// 查看相应客户端缓存</span><br>				<span class="hljs-keyword">if</span> cache.SequenceNum &lt; op.SequenceNum &#123; <span class="hljs-comment">// 执行请求，自动覆盖之前的结果</span><br>					oldConfig := sc.configs[sc.currentConfigNumber]<br>					sc.currentConfigNumber++<br>					newConfig := ConfigCopy(oldConfig)<br>					newConfig.Num = sc.currentConfigNumber<br>					newConfig.Shards[op.Shard] = op.GID<br>					sc.configs = <span class="hljs-built_in">append</span>(sc.configs, newConfig)<br>					sc.clientCache[op.ClientId] = ReqResult&#123;SequenceNum: op.SequenceNum, Status: OK&#125;<br>				&#125;<br>			<span class="hljs-keyword">case</span> QueryArgs:<br>				cache := sc.clientCache[op.ClientId]    <span class="hljs-comment">// 查看相应客户端缓存</span><br>				<span class="hljs-keyword">if</span> cache.SequenceNum &lt; op.SequenceNum &#123; <span class="hljs-comment">// 执行请求，自动覆盖之前的结果</span><br>					<span class="hljs-keyword">if</span> op.Num &lt; <span class="hljs-number">0</span> || op.Num &gt; sc.currentConfigNumber &#123;<br>						sc.clientCache[op.ClientId] = ReqResult&#123;SequenceNum: op.SequenceNum, Config: ConfigCopy(sc.configs[sc.currentConfigNumber]), Status: OK&#125;<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						sc.clientCache[op.ClientId] = ReqResult&#123;SequenceNum: op.SequenceNum, Config: ConfigCopy(sc.configs[op.Num]), Status: OK&#125;<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>		sc.mu.Unlock()<br>	&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StartServer</span><span class="hljs-params">(servers []*labrpc.ClientEnd, me <span class="hljs-type">int</span>, persister *raft.Persister)</span></span> *ShardCtrler &#123;<br>	sc := <span class="hljs-built_in">new</span>(ShardCtrler)<br>	sc.me = me<br><br>	sc.configs = <span class="hljs-built_in">make</span>([]Config, <span class="hljs-number">1</span>)<br>	sc.configs[<span class="hljs-number">0</span>].Groups = <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>&#123;&#125;<br><br>	labgob.Register(JoinArgs&#123;&#125;)<br>	labgob.Register(LeaveArgs&#123;&#125;)<br>	labgob.Register(MoveArgs&#123;&#125;)<br>	labgob.Register(QueryArgs&#123;&#125;)<br><br>	sc.applyCh = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> raft.ApplyMsg)<br>	sc.rf = raft.Make(servers, me, persister, sc.applyCh)<br><br>	<span class="hljs-comment">// Your code here.</span><br>	sc.clientCache = <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult&#123;&#125;<br>	<span class="hljs-keyword">go</span> sc.receiveTask()<br>	<span class="hljs-keyword">return</span> sc<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="4B"><a href="#4B" class="headerlink" title="4B"></a>4B</h2><p>4B比较复杂，写了几天才写出来，问题的难点在于：<br>一：有太多节点之间的交互了，当一个节点需要分区数据时，应该向哪个节点请求数据呢？<br>二：不同节点的配置版本不一样，如何处理不同版本的节点数据交互</p>
<p>即使看了<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f5c8ab9cd577">MIT 6.824 LAB 4B(分布式shard database)</a>这篇文章，还是云里雾里</p>
<p>对于第一个问题，有一个简单的解决方法便是只与leader进行交互，其他节点只通过raft日志获取数据。当然，这只是稍微缩小了问题域，当一个节点从config m 跳到了config n<br>1 它什么时候认为自己不需要向其他节点获取数据呢？<br>2 如果它认为自己需要获取数据，它向谁获取呢？<br>3 如果向前面版本config的分区数据拥有者获取数据，例如n-1的拥有者，它一定拥有这个数据吗？<br>4 即使n-1的拥有者leader回复它未拥有该分区，也不代表该集群真的没有该分区数据，leader的状态并不可信，只是拥有最长日志，但未必提交了，故状态不一定是最新的。<br>5 存在一种可能，所有集群监听的配置发生了断层，也就是说大家都没有看到0-n的配置，当前节点就是分区的第一任拥有者呢？它根本不需要向之前配置的拥有者请求数据<br>对于第二个问题，你很难确信自己已经想明白了不同配置号的请求逻辑，你无法证明这一点。</p>
<p>所以，我采用一种笨方法，拼命地加约束，以至于我能自以为解决问题。</p>
<ol>
<li>集群与集群之间只有leader进行通信</li>
<li>每次配置只加一，保证集群经历了每一次的配置</li>
<li>集群只在所有负责分区数据均已到达且其余数据均已被取走才更新配置</li>
<li>仅仅在节点配置一致时才转移分区数据</li>
<li>不直接修改ShardKV状态，通过将命令加入raft日志来进行状态的修改</li>
</ol>
<p>第二第三点的相关代码如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> completeMigrate() <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">for</span> _, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>		<span class="hljs-keyword">if</span> status == ResponsibleButNotOwn || status == IrresponsibleButOwn &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> configListenTask() &#123; <span class="hljs-comment">// 配置监听线程</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			kv.mu.Lock()<br>			<span class="hljs-keyword">if</span> isLeader &amp;&amp; kv.completeMigrate() &#123;<br>				newConfig := kv.mck.Query(kv.config.Num + <span class="hljs-number">1</span>) <span class="hljs-comment">// 只查看下一任配置</span><br>				<span class="hljs-keyword">if</span> newConfig.Num == kv.config.Num+<span class="hljs-number">1</span> &#123;<br>					DPrintf(<span class="hljs-string">&quot;%d %d add new config cmd %v &quot;</span>, kv.gid, kv.me, newConfig)<br>					kv.rf.Start(newConfig) <span class="hljs-comment">// 最多更新至下一任配置</span><br>				&#125;<br>			&#125;<br>			kv.mu.Unlock()<br>			time.Sleep(GeneralInterval)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>raft日志的操作类型有：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> AddShardCmd <span class="hljs-keyword">struct</span> &#123;<br>	ConfigNum   <span class="hljs-type">int</span>                 <span class="hljs-comment">// 配置号</span><br>	Shard       <span class="hljs-type">int</span>                 <span class="hljs-comment">// 分区号</span><br>	KVData      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>   <span class="hljs-comment">// 分区数据</span><br>	ClientCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult <span class="hljs-comment">// 客户端最新结果</span><br>&#125;<br><br><span class="hljs-keyword">type</span> DeleteShardCmd <span class="hljs-keyword">struct</span> &#123;<br>	ConfigNum <span class="hljs-type">int</span> <span class="hljs-comment">// 配置号</span><br>	Shard     <span class="hljs-type">int</span> <span class="hljs-comment">// 分区号</span><br>&#125;<br><br><span class="hljs-keyword">switch</span> data := msg.Command.(<span class="hljs-keyword">type</span>) &#123;<br>	<span class="hljs-keyword">case</span> GetArgs:<br>	<span class="hljs-keyword">case</span> PutAppendArgs:<br>	<span class="hljs-keyword">case</span> shardctrler.Config: <span class="hljs-comment">// 配置更新</span><br>	<span class="hljs-keyword">case</span> AddShardCmd: 		<span class="hljs-comment">// 增加分区数据</span><br>	<span class="hljs-keyword">case</span> DeleteShardCmd:	<span class="hljs-comment">// 删除分区数据				</span><br></code></pre></td></tr></table></figure>
<h3 id="代码介绍"><a href="#代码介绍" class="headerlink" title="代码介绍"></a>代码介绍</h3><p>简要地介绍代码结构，我的代码中有许多不必要的约束，但我也懒得去掉这些约束，首先是RPC处理函数<br><strong>Get&#x2F;PutAppend：</strong> 在处理客户端请求前判断分区状态，看是否拥有且负责该分区数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">kv.mu.Lock()<br><span class="hljs-keyword">switch</span> kv.shardStatus[shard] &#123;<br><span class="hljs-keyword">case</span> IrresponsibleAndNotOwn: <span class="hljs-comment">// 错误的组</span><br>	reply.Status = ErrWrongGroup<br><span class="hljs-keyword">case</span> IrresponsibleButOwn: <span class="hljs-comment">// 错误的组</span><br>	reply.Status = ErrWrongGroup<br><span class="hljs-keyword">case</span> ResponsibleButNotOwn: <span class="hljs-comment">// 等待分区数据到达</span><br>	reply.Status = ErrWaitShardData<br><span class="hljs-keyword">case</span> ResponsibleAndOwn:<br>	index, _, isLeader = kv.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		reply.Status = ErrWrongLeader<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		exitFunc = <span class="hljs-literal">false</span><br>	&#125;<br>&#125;<br>kv.mu.Unlock()<br><span class="hljs-keyword">if</span> exitFunc &#123;<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>Migrate：</strong> 请求分区数据的RPC处理函数，只在leader且配置相同时传递分区数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MigrateArgs <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 分区数据迁移参数</span><br>	ConfigNum <span class="hljs-type">int</span> <span class="hljs-comment">// 请求者配置号</span><br>	GID       <span class="hljs-type">int</span> <span class="hljs-comment">// 请求者ID</span><br>	Shard     <span class="hljs-type">int</span> <span class="hljs-comment">// 请求分区号</span><br>&#125;<br><br><span class="hljs-keyword">type</span> MigrateReply <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 分区数据迁移返回</span><br>	Status     Err                 <span class="hljs-comment">// 返回状态</span><br>	KVData     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>   <span class="hljs-comment">// 分区数据</span><br>	ClintCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult <span class="hljs-comment">// 客户端最新结果</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Migrate(args *MigrateArgs, reply *MigrateReply) &#123;<br>	_, isLeader := kv.rf.GetState()<br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	kv.mu.Lock()<br>	<span class="hljs-keyword">defer</span> kv.mu.Unlock()<br>	<span class="hljs-comment">// 与预期的分区数据请求者信息一致，将数据移交给该节点</span><br>	<span class="hljs-keyword">if</span> kv.config.Num == args.ConfigNum &amp;&amp; kv.config.Shards[args.Shard] == args.GID &amp;&amp; kv.shardStatus[args.Shard] == IrresponsibleButOwn &#123;<br>		DPrintf(<span class="hljs-string">&quot;%d shard migrate from %d-%d to %d success. config num is %d\n&quot;</span>, args.Shard, kv.gid, kv.me, args.GID, kv.config.Num)<br>		reply.KVData = copyMapKV(kv.kvDatas[args.Shard])<br>		reply.ClintCache = copyMapCache(kv.clientCache)<br>		reply.Status = OK<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	DPrintf(<span class="hljs-string">&quot;%d shard migrate from %d-%d to %d failed. config num is %d  arg config num is %d  shard status is %v\n&quot;</span>, args.Shard, kv.gid, kv.me, args.GID, kv.config.Num, args.ConfigNum, kv.shardStatus)<br>	reply.Status = ErrShardStatus<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以优化的点：是否一定需要leader才传递数据呢？<br><strong>Delete：</strong> 当前不负责但拥有的数据已被其他节点得到，可以不再保持该分区数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> DeleteArgs <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 删除分区参数</span><br>	ConfigNum           <span class="hljs-type">int</span>   <span class="hljs-comment">// 请求者配置号</span><br>	MigrateSuccessShard []<span class="hljs-type">int</span> <span class="hljs-comment">// 请求者拥有的分区号</span><br>&#125;<br><br><span class="hljs-keyword">type</span> DeleteReply <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 删除分区返回</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Delete(args *DeleteArgs, reply *DeleteReply) &#123;<br>	_, isLeader := kv.rf.GetState()<br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	kv.mu.Lock()<br>	<span class="hljs-keyword">defer</span> kv.mu.Unlock()<br>	<span class="hljs-keyword">if</span> kv.config.Num &lt;= args.ConfigNum &#123; <span class="hljs-comment">// 请求者配置号比当前配置号更新或一致</span><br>		<span class="hljs-keyword">for</span> _, shard := <span class="hljs-keyword">range</span> args.MigrateSuccessShard &#123;<br>			<span class="hljs-keyword">if</span> kv.shardStatus[shard] == IrresponsibleButOwn &#123; <span class="hljs-comment">// 表示该数据已成功转移至其他节点</span><br>				DPrintf(<span class="hljs-string">&quot;%d-%d send delete %d shard cmd. config num is %d&quot;</span>, kv.gid, kv.me, shard, kv.config.Num)<br>				kv.rf.Start(DeleteShardCmd&#123;ConfigNum: kv.config.Num, Shard: shard&#125;) <span class="hljs-comment">// 删除分区数据命令</span><br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果在配置更高或相等的集群发现了该分区数据，那么该分区数据一定成功传递到了另一个集群</p>
<p>StartServer起的一些定时任务<br><strong>configListenTask：</strong> 定时监听配置，在满足条件时进行配置更新</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> completeMigrate() <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">for</span> _, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>		<span class="hljs-keyword">if</span> status == ResponsibleButNotOwn || status == IrresponsibleButOwn &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> configListenTask() &#123; <span class="hljs-comment">// 配置监听线程</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			kv.mu.Lock()<br>			<span class="hljs-keyword">if</span> isLeader &amp;&amp; kv.completeMigrate() &#123;<br>				newConfig := kv.mck.Query(kv.config.Num + <span class="hljs-number">1</span>) <span class="hljs-comment">// 只查看下一任配置</span><br>				<span class="hljs-keyword">if</span> newConfig.Num == kv.config.Num+<span class="hljs-number">1</span> &#123;<br>					DPrintf(<span class="hljs-string">&quot;%d %d add new config cmd %v &quot;</span>, kv.gid, kv.me, newConfig)<br>					kv.rf.Start(newConfig) <span class="hljs-comment">// 最多更新至下一任配置</span><br>				&#125;<br>			&#125;<br>			kv.mu.Unlock()<br>			time.Sleep(GeneralInterval)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>注意配置更新的条件，每次更新只更新一个版本</p>
<p><strong>requestShardTask：</strong> 定时请求当前未获得的分区数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> requestShardTask() &#123; <span class="hljs-comment">// 请求分区线程</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			<span class="hljs-keyword">if</span> isLeader &#123;<br>				kv.mu.Lock()<br>				<span class="hljs-keyword">for</span> shard, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>					<span class="hljs-keyword">if</span> status == ResponsibleButNotOwn &#123;<br>						<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(shard <span class="hljs-type">int</span>, lastConfig shardctrler.Config)</span></span> &#123;<br>							args := MigrateArgs&#123;ConfigNum: lastConfig.Num + <span class="hljs-number">1</span>, GID: kv.gid, Shard: shard&#125;<br>							oldOwner := lastConfig.Shards[shard] <span class="hljs-comment">// 向上一任拥有者请求分区数据</span><br>							<span class="hljs-keyword">for</span> _, server := <span class="hljs-keyword">range</span> lastConfig.Groups[oldOwner] &#123;<br>								reply := MigrateReply&#123;&#125;<br>								ok := kv.make_end(server).Call(<span class="hljs-string">&quot;ShardKV.Migrate&quot;</span>, &amp;args, &amp;reply)<br>								<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>									DPrintf(<span class="hljs-string">&quot;%d %d send add %d shard cmd.&quot;</span>, kv.gid, kv.me, shard)<br>									<span class="hljs-comment">// 增加分区数据命令</span><br>									kv.rf.Start(AddShardCmd&#123;ConfigNum: lastConfig.Num + <span class="hljs-number">1</span>, Shard: shard, KVData: reply.KVData, ClientCache: reply.ClintCache&#125;)<br>									<span class="hljs-keyword">return</span><br>								&#125;<br>							&#125;<br>						&#125;(shard, kv.lastConfig)<br>					&#125;<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br>			time.Sleep(GeneralInterval)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当集群需要分区数据时，只需要向上一任拥有者请求分区数据，由于配置更新条件且每次只加一，分区数据一定会在各个版本的拥有者中传递，若请求分区失败，代表上一任拥有者配置尚未更新，需等待该集群迁移完成所有的分区数据，并实现配置同步。由于加的一些约束，几个集群配置最低的集群会拖慢所有集群，导致整个系统无法取得进展，故debug时只需要搞清楚为什么配置最低的节点没能更新配置，大部分时间是因为未收到分区数据删除的确认，无法保证自己已将分区数据成功转移出去，故卡死在当前配置。</p>
<p><strong>notifyDeleteTask：</strong>  定时提醒其他集群删除已成功传递的分区数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> notifyDeleteTask() &#123; <span class="hljs-comment">// 提醒其他分组删除相应分区</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			<span class="hljs-keyword">if</span> isLeader &#123;<br>				kv.mu.Lock()<br>				ownShards := []<span class="hljs-type">int</span>&#123;&#125;<br>				<span class="hljs-keyword">for</span> shard, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>					<span class="hljs-keyword">if</span> status == ResponsibleAndOwn || status == IrresponsibleButOwn &#123; <span class="hljs-comment">// 当前拥有这些分区数据</span><br>						ownShards = <span class="hljs-built_in">append</span>(ownShards, shard)<br>					&#125;<br>				&#125;<br>				args := DeleteArgs&#123;ConfigNum: kv.config.Num, MigrateSuccessShard: ownShards&#125;<br>				<span class="hljs-keyword">for</span> gid, servers := <span class="hljs-keyword">range</span> kv.allReplicaNode &#123;<br>					<span class="hljs-keyword">if</span> gid != kv.gid &#123;<br>						<span class="hljs-keyword">for</span> _, server := <span class="hljs-keyword">range</span> servers &#123;<br>							reply := DeleteReply&#123;&#125;<br>							<span class="hljs-keyword">go</span> kv.make_end(server).Call(<span class="hljs-string">&quot;ShardKV.Delete&quot;</span>, &amp;args, &amp;reply)<br>						&#125;<br>					&#125;<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br><br>		&#125;<br>		time.Sleep(GeneralInterval)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>notifyDeleteTask与Delete函数是配置更新的关键</p>
<p>raft日志处理函数receiveTask</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 接受raft消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> receiveTask() &#123;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">case</span> msg := &lt;-kv.applyCh:<br>			&#123;<br>				kv.mu.Lock()<br>				<span class="hljs-keyword">if</span> msg.CommandValid &#123; <span class="hljs-comment">// 普通的日志消息</span><br>					kv.commitIndex = msg.CommandIndex<br>					<span class="hljs-keyword">switch</span> data := msg.Command.(<span class="hljs-keyword">type</span>) &#123;<br>					<span class="hljs-keyword">case</span> GetArgs:<br>						shard := key2shard(data.Key)<br>						cache := kv.clientCache[data.ClientId] <span class="hljs-comment">// 查看相应客户端缓存</span><br>						<span class="hljs-keyword">if</span> cache.SequenceNum &lt; data.SequenceNum &amp;&amp; kv.shardStatus[shard] == ResponsibleAndOwn &#123;<br>							value, exist := kv.kvDatas[shard][data.Key]<br>							<span class="hljs-keyword">if</span> !exist &#123;<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: ErrNoKey&#125;<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK, Value: value&#125;<br>							&#125;<br><br>						&#125;<br>					<span class="hljs-keyword">case</span> PutAppendArgs:<br>						shard := key2shard(data.Key)<br>						cache := kv.clientCache[data.ClientId] <span class="hljs-comment">// 查看相应客户端缓存</span><br>						<span class="hljs-keyword">if</span> cache.SequenceNum &lt; data.SequenceNum &amp;&amp; kv.shardStatus[shard] == ResponsibleAndOwn &#123;<br>							<span class="hljs-keyword">if</span> data.Op == <span class="hljs-string">&quot;Put&quot;</span> &#123;<br>								kv.kvDatas[shard][data.Key] = data.Value<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK&#125;<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								kv.kvDatas[shard][data.Key] += data.Value<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK&#125;<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> shardctrler.Config:<br>						<span class="hljs-keyword">if</span> kv.config.Num &lt; data.Num &#123;<br>							DPrintf(<span class="hljs-string">&quot;%d %d update config.old config:%v new config:%v&quot;</span>, kv.gid, kv.me, kv.config, data)<br>							<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; shardctrler.NShards; i++ &#123;<br>								oldOwner := kv.config.Shards[i]<br>								newOwner := data.Shards[i]<br>								<span class="hljs-keyword">if</span> newOwner == kv.gid &amp;&amp; oldOwner != kv.gid &#123;<br>									<span class="hljs-keyword">if</span> oldOwner == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 第一任拥有者</span><br>										kv.shardStatus[i] = ResponsibleAndOwn<br>										kv.kvDatas[i] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>) <span class="hljs-comment">// 初始化map</span><br>									&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 等待上一任拥有者的分区数据</span><br>										kv.shardStatus[i] = ResponsibleButNotOwn<br>									&#125;<br>								&#125;<br>								<span class="hljs-keyword">if</span> newOwner != kv.gid &amp;&amp; oldOwner == kv.gid &#123;<br>									<span class="hljs-keyword">if</span> kv.shardStatus[i] == ResponsibleAndOwn &#123;<br>										kv.shardStatus[i] = IrresponsibleButOwn<br>									&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 不可能发生</span><br>										kv.shardStatus[i] = IrresponsibleAndNotOwn<br>									&#125;<br>								&#125;<br>							&#125;<br>							kv.lastConfig = kv.config<br>							kv.config = data<br>							<span class="hljs-keyword">for</span> gid, servers := <span class="hljs-keyword">range</span> data.Groups &#123; <span class="hljs-comment">// 更新见到的所有节点</span><br>								kv.allReplicaNode[gid] = servers<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> AddShardCmd:<br>						<span class="hljs-keyword">if</span> kv.config.Num == data.ConfigNum &amp;&amp; kv.shardStatus[data.Shard] == ResponsibleButNotOwn &#123; <span class="hljs-comment">// 预期的分区数据到达</span><br>							DPrintf(<span class="hljs-string">&quot;%d %d add new %d shard data. config num is %d&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num)<br>							kv.kvDatas[data.Shard] = copyMapKV(data.KVData)<br>							kv.shardStatus[data.Shard] = ResponsibleAndOwn<br>							<span class="hljs-keyword">for</span> id, res := <span class="hljs-keyword">range</span> data.ClientCache &#123; <span class="hljs-comment">// 更新最新客户端结果</span><br>								<span class="hljs-keyword">if</span> kv.clientCache[id].SequenceNum &lt; res.SequenceNum &#123;<br>									kv.clientCache[id] = res<br>								&#125;<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> DeleteShardCmd:<br>						DPrintf(<span class="hljs-string">&quot;before:%d %d delete %d shard data. config num is %d  shard status:%v&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num, kv.shardStatus)<br>						<span class="hljs-keyword">if</span> kv.config.Num == data.ConfigNum &amp;&amp; kv.shardStatus[data.Shard] == IrresponsibleButOwn &#123;<br>							kv.shardStatus[data.Shard] = IrresponsibleAndNotOwn<br>							kv.kvDatas[data.Shard] = <span class="hljs-literal">nil</span><br>							DPrintf(<span class="hljs-string">&quot;after: %d %d delete %d shard data. config num is %d  shard status:%v&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num, kv.shardStatus)<br>						&#125;<br>					&#125;<br><br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> msg.SnapshotValid &#123; <span class="hljs-comment">// 快照消息</span><br>					r := bytes.NewBuffer(msg.Snapshot)<br>					d := labgob.NewDecoder(r)<br>					<span class="hljs-keyword">var</span> commitIndex <span class="hljs-type">int</span><br>					<span class="hljs-keyword">var</span> clientCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult<br>					<span class="hljs-keyword">var</span> kvDatas [shardctrler.NShards]<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>					<span class="hljs-keyword">var</span> config shardctrler.Config<br>					<span class="hljs-keyword">var</span> shardStatus [shardctrler.NShards]ShardStatus<br>					<span class="hljs-keyword">var</span> allNode <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span><br>					<span class="hljs-keyword">if</span> d.Decode(&amp;commitIndex) != <span class="hljs-literal">nil</span> || d.Decode(&amp;clientCache) != <span class="hljs-literal">nil</span> || d.Decode(&amp;kvDatas) != <span class="hljs-literal">nil</span> || d.Decode(&amp;config) != <span class="hljs-literal">nil</span> || d.Decode(&amp;shardStatus) != <span class="hljs-literal">nil</span> || d.Decode(&amp;allNode) != <span class="hljs-literal">nil</span> &#123;<br>						log.Panicf(<span class="hljs-string">&quot;snapshot decode error&quot;</span>)<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						DPrintf(<span class="hljs-string">&quot;%d %d recv snapshot. shard status:%v&quot;</span>, kv.gid, kv.me, shardStatus)<br>						kv.commitIndex = commitIndex<br>						kv.clientCache = clientCache<br>						kv.kvDatas = kvDatas<br>						kv.config = config<br>						kv.lastConfig = kv.mck.Query(config.Num - <span class="hljs-number">1</span>)<br>						kv.shardStatus = shardStatus<br>						kv.allReplicaNode = allNode<br>						<span class="hljs-comment">// 更新lastSnapshotIndex</span><br>						kv.lastSnapshotIndex = commitIndex<br>					&#125;<br>				&#125;<br>				<span class="hljs-comment">// 检查raft state大小，生成快照</span><br>				<span class="hljs-keyword">if</span> kv.maxraftstate &gt; <span class="hljs-number">0</span> &amp;&amp; kv.persister.RaftStateSize() &gt; kv.maxraftstate &amp;&amp; kv.commitIndex &gt; kv.lastSnapshotIndex &#123;<br>					w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>					e := labgob.NewEncoder(w)<br>					e.Encode(kv.commitIndex)<br>					e.Encode(kv.clientCache)<br>					e.Encode(kv.kvDatas)<br>					<span class="hljs-comment">// 将以下数据编码至快照</span><br>					e.Encode(kv.config)<br>					e.Encode(kv.shardStatus)<br>					e.Encode(kv.allReplicaNode)<br>					snapshot := w.Bytes()<br>					kv.rf.Snapshot(kv.commitIndex, snapshot)<br>					kv.lastSnapshotIndex = kv.commitIndex<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>一些可以优化的点：Get不需要去重处理，同时删除多个分区数据</p>
<h3 id="debug记录"><a href="#debug记录" class="headerlink" title="debug记录"></a>debug记录</h3><p>debug经验所得：<br>1 raft日志中加入map类型数据，提交后需copy，要不然持久化与对map操作会产生竞态<br>2 leader的状态未必可信，也不一定是集群最新结果<br>3 快照需包含提交日志全部改变状态，快照效果应与正常日志迭代完全一致（最关键，最重要的一点）</p>
<p>以下简要介绍一下debug经历<br>我通过两种方法来进行debug，一个是在合适的地方加上打印语句，二是通过vscode自带的调试功能分析各个线程的状态。<br>刚开始我还是使用for !kv.killed()的方式控制goroutine的生命周期，但我在用vscode查看goroutine时，那些已经dead的receiveTask任务仍然卡在kv.applyCh这一步，导致有很多receiveTask，而我一般是通过这个任务来查看各个集群当前状态。所以我将代码改成了for select default格式，使用done管道来控制goroutine生命周期，这样receiveTask就少挺多的<br><img src="https://img-blog.csdnimg.cn/44f37918a6224bc6990597122783be3d.png" srcset="/img/loading.gif" lazyload></p>
<p>data race</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go">      /usr/local/<span class="hljs-keyword">go</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">301</span> +<span class="hljs-number">0x3be</span><br>  encoding/gob.(*Encoder).encode()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/encoding/gob/encode.<span class="hljs-keyword">go</span>:<span class="hljs-number">703</span> +<span class="hljs-number">0x2b8</span><br>  encoding/gob.(*Encoder).EncodeValue()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/encoding/gob/encoder.<span class="hljs-keyword">go</span>:<span class="hljs-number">251</span> +<span class="hljs-number">0x768</span><br>  encoding/gob.(*Encoder).Encode()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/encoding/gob/encoder.<span class="hljs-keyword">go</span>:<span class="hljs-number">176</span> +<span class="hljs-number">0x15a</span><br>  <span class="hljs-number">6.824</span>/labgob.(*LabEncoder).Encode()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labgob/labgob.<span class="hljs-keyword">go</span>:<span class="hljs-number">36</span> +<span class="hljs-number">0x5e</span><br>  <span class="hljs-number">6.824</span>/raft.(*Raft).persist()  <span class="hljs-comment">// e.Encode(rf.log)</span><br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">105</span> +<span class="hljs-number">0xf8</span><br>  <span class="hljs-number">6.824</span>/raft.(*Raft).AppendEntries()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/raft/raft.<span class="hljs-keyword">go</span>:<span class="hljs-number">358</span> +<span class="hljs-number">0x102f</span><br>  runtime.call32()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/runtime/asm_amd64.s:<span class="hljs-number">725</span> +<span class="hljs-number">0x48</span><br>  reflect.Value.Call()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/reflect/value.<span class="hljs-keyword">go</span>:<span class="hljs-number">368</span> +<span class="hljs-number">0xc7</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Service).dispatch()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">496</span> +<span class="hljs-number">0x47b</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Server).dispatch()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">420</span> +<span class="hljs-number">0x26a</span><br>  <span class="hljs-number">6.824</span>/labrpc.(*Network).processReq.func1()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/labrpc/labrpc.<span class="hljs-keyword">go</span>:<span class="hljs-number">240</span> +<span class="hljs-number">0x9c</span><br><br>Previous write at <span class="hljs-number">0x00c0001fa630</span> by goroutine <span class="hljs-number">45</span>:<br>  runtime.mapassign_faststr()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/runtime/map_faststr.<span class="hljs-keyword">go</span>:<span class="hljs-number">203</span> +<span class="hljs-number">0x0</span><br>  <span class="hljs-number">6.824</span>/shardkv.(*ShardKV).receiveTask() <span class="hljs-comment">// 对kv数据进行修改</span><br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/shardkv/server.<span class="hljs-keyword">go</span>:<span class="hljs-number">323</span> +<span class="hljs-number">0x1306</span><br>  <span class="hljs-number">6.824</span>/shardkv.StartServer.func1()<br>      /root/mit6<span class="hljs-number">.824</span>/<span class="hljs-number">6.824</span>/src/shardkv/server.<span class="hljs-keyword">go</span>:<span class="hljs-number">463</span> +<span class="hljs-number">0x39</span><br></code></pre></td></tr></table></figure>
<p>raft日志中加入map类型数据，提交后需copy，要不然持久化与对map操作会产生竞态</p>
<p>我卡了很久的bug在于TestConcurrent3测试</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestConcurrent3</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	fmt.Printf(<span class="hljs-string">&quot;Test: concurrent configuration change and restart...\n&quot;</span>)<br><br>	cfg := make_config(t, <span class="hljs-number">3</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">300</span>)<br>	<span class="hljs-keyword">defer</span> cfg.cleanup()<br><br>	ck := cfg.makeClient()<br><br>	cfg.join(<span class="hljs-number">0</span>)<br><br>	n := <span class="hljs-number">10</span><br>	ka := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, n)<br>	va := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, n)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>		ka[i] = strconv.Itoa(i)<br>		va[i] = randstring(<span class="hljs-number">1</span>)<br>		ck.Put(ka[i], va[i])<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> done <span class="hljs-type">int32</span><br>	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br><br>	ff := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>, ck1 *Clerk)</span></span> &#123;<br>		<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; ch &lt;- <span class="hljs-literal">true</span> &#125;()<br>		<span class="hljs-keyword">for</span> atomic.LoadInt32(&amp;done) == <span class="hljs-number">0</span> &#123;<br>			x := randstring(<span class="hljs-number">1</span>)<br>			ck1.Append(ka[i], x)<br>			va[i] += x<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>		ck1 := cfg.makeClient()<br>		<span class="hljs-keyword">go</span> ff(i, ck1)<br>	&#125;<br><br>	t0 := time.Now()<br>	<span class="hljs-keyword">for</span> time.Since(t0) &lt; <span class="hljs-number">12</span>*time.Second &#123;<br>		cfg.join(<span class="hljs-number">2</span>)<br>		cfg.join(<span class="hljs-number">1</span>)<br>		time.Sleep(time.Duration(rand.Int()%<span class="hljs-number">900</span>) * time.Millisecond)<br>		cfg.ShutdownGroup(<span class="hljs-number">0</span>)<br>		cfg.ShutdownGroup(<span class="hljs-number">1</span>)<br>		cfg.ShutdownGroup(<span class="hljs-number">2</span>)<br>		cfg.StartGroup(<span class="hljs-number">0</span>)<br>		cfg.StartGroup(<span class="hljs-number">1</span>)<br>		cfg.StartGroup(<span class="hljs-number">2</span>)<br><br>		time.Sleep(time.Duration(rand.Int()%<span class="hljs-number">900</span>) * time.Millisecond)<br>		cfg.leave(<span class="hljs-number">1</span>)<br>		cfg.leave(<span class="hljs-number">2</span>)<br>		time.Sleep(time.Duration(rand.Int()%<span class="hljs-number">900</span>) * time.Millisecond)<br>	&#125;<br><br>	time.Sleep(<span class="hljs-number">2</span> * time.Second)<br><br>	atomic.StoreInt32(&amp;done, <span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>		&lt;-ch<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>		check(t, ck, ka[i], va[i])<br>	&#125;<br><br>	fmt.Printf(<span class="hljs-string">&quot;  ... Passed\n&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在这个测试中进行了许多次的重启操作，测试过程中某个集群的配置总是无法更新，卡在某个版本，导致迁移分区数据一直失败。例,以下情况，100版本为26 101版本为27，102版本为25，102由于某个分区为IrresponsibleButOwn无法更新配置。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">9</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">8</span> shard from <span class="hljs-number">102</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">0</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">25</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> migrate failed: <span class="hljs-number">4</span> shard from <span class="hljs-number">100</span> to <span class="hljs-number">101</span>  shard status is  <span class="hljs-number">2</span><br><span class="hljs-number">00</span>:<span class="hljs-number">44</span>:<span class="hljs-number">58</span> request config:<span class="hljs-number">27</span>  my config:<span class="hljs-number">26</span><br></code></pre></td></tr></table></figure>
<p>&emsp;当时我的设计与现在有一些不同，关于确认分区数据已成功转移，我采用的方法是集群A向集群B请求分区数据，等待分区数据后加入raft日志，在raft日志处理函数AddShardCmd的分支里启动一个协程，该协程定时向集群A发送删除分区消息，直到集群A的分区状态改变（从IrresponsibleButOwn到IrresponsibleAndNotOwn）。<br>&emsp;实际上集群B的所有节点都会起一个协程监督集群A完成分区状态的改变，所以大部分情景下整个系统都能正常，但碰到这种多次重启的场景，有可能<strong>raft直接用快照掩盖了普通的日志，但快照处理中并不会启动协程</strong>，这就是一种不一致性，所以快照处理的效果应该与日志一条一条处理时一致。<br>&emsp;所以我就换了与现在类似的方法，定时向其他集群发送删除分区消息，但这还有一点小坑，我开始直接向config中的Groups成员广播删除分区消息，但可能节点已离开Groups，所以一直收不到消息。所以我使用allReplicaNode成员变量记录见到的所有节点地址，并在receiveTask的shardctrler.Config分支中更新该成员变量。不过我没有在快照中保存allReplicaNode的状态的值，这又是日志处理与快照处理的不一致性，所以这个实验最令我印象深刻的就是<strong>保持日志处理与快照处理的状态一致性</strong></p>
<h3 id="通过截图与代码参考"><a href="#通过截图与代码参考" class="headerlink" title="通过截图与代码参考"></a>通过截图与代码参考</h3><p>通过截图<br><img src="https://img-blog.csdnimg.cn/c80d5f0676d44ea29972c5c2b09ea8ad.png" srcset="/img/loading.gif" lazyload><br>通过396次测试，本来想跑1000次，被我随手关掉了vscode，也就懒得跑了，当作基本正确吧！</p>
<p>代码参考：<br><strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> shardkv<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// client code to talk to a sharded key/value service.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the client first talks to the shardctrler to find out</span><br><span class="hljs-comment">// the assignment of shards (keys) to groups, and then</span><br><span class="hljs-comment">// talks to the group that holds the key&#x27;s shard.</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;crypto/rand&quot;</span><br>	<span class="hljs-string">&quot;math/big&quot;</span><br>	<span class="hljs-string">&quot;sync/atomic&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;6.824/labrpc&quot;</span><br>	<span class="hljs-string">&quot;6.824/shardctrler&quot;</span><br>)<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// which shard is a key in?</span><br><span class="hljs-comment">// please use this function,</span><br><span class="hljs-comment">// and please do not change it.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">key2shard</span><span class="hljs-params">(key <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>	shard := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(key) &gt; <span class="hljs-number">0</span> &#123;<br>		shard = <span class="hljs-type">int</span>(key[<span class="hljs-number">0</span>])<br>	&#125;<br>	shard %= shardctrler.NShards<br>	<span class="hljs-keyword">return</span> shard<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nrand</span><span class="hljs-params">()</span></span> <span class="hljs-type">int64</span> &#123;<br>	max := big.NewInt(<span class="hljs-type">int64</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">62</span>)<br>	bigx, _ := rand.Int(rand.Reader, max)<br>	x := bigx.Int64()<br>	<span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-keyword">type</span> Clerk <span class="hljs-keyword">struct</span> &#123;<br>	sm       *shardctrler.Clerk<br>	config   shardctrler.Config<br>	make_end <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">string</span>)</span></span> *labrpc.ClientEnd<br>	<span class="hljs-comment">// You will have to modify this struct.</span><br>	clientId      <span class="hljs-type">int64</span> <span class="hljs-comment">// 随机生成的客户端ID</span><br>	currentSeqNum <span class="hljs-type">int64</span> <span class="hljs-comment">// 当前序列号</span><br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the tester calls MakeClerk.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ctrlers[] is needed to call shardctrler.MakeClerk().</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// make_end(servername) turns a server name from a</span><br><span class="hljs-comment">// Config.Groups[gid][i] into a labrpc.ClientEnd on which you can</span><br><span class="hljs-comment">// send RPCs.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MakeClerk</span><span class="hljs-params">(ctrlers []*labrpc.ClientEnd, make_end <span class="hljs-keyword">func</span>(<span class="hljs-type">string</span>)</span></span> *labrpc.ClientEnd) *Clerk &#123;<br>	ck := <span class="hljs-built_in">new</span>(Clerk)<br>	ck.sm = shardctrler.MakeClerk(ctrlers)<br>	ck.make_end = make_end<br>	<span class="hljs-comment">// You&#x27;ll have to add code here.</span><br>	ck.clientId = nrand() <span class="hljs-comment">// 生成随机的ID</span><br>	ck.currentSeqNum = <span class="hljs-number">1</span><br>	<span class="hljs-keyword">return</span> ck<br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// fetch the current value for a key.</span><br><span class="hljs-comment">// returns &quot;&quot; if the key does not exist.</span><br><span class="hljs-comment">// keeps trying forever in the face of all other errors.</span><br><span class="hljs-comment">// You will have to modify this function.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Get(key <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>	args := GetArgs&#123;Key: key, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		shard := key2shard(key)<br>		gid := ck.config.Shards[shard]<br>		<span class="hljs-keyword">if</span> servers, ok := ck.config.Groups[gid]; ok &#123;<br>			<span class="hljs-comment">// try each server for the shard.</span><br>			<span class="hljs-keyword">for</span> si := <span class="hljs-number">0</span>; si &lt; <span class="hljs-built_in">len</span>(servers); si++ &#123;<br>				srv := ck.make_end(servers[si])<br>				<span class="hljs-keyword">var</span> reply GetReply<br>				ok := srv.Call(<span class="hljs-string">&quot;ShardKV.Get&quot;</span>, &amp;args, &amp;reply)<br>				<span class="hljs-keyword">if</span> ok &amp;&amp; (reply.Status == OK || reply.Status == ErrNoKey) &#123;<br>					<span class="hljs-keyword">return</span> reply.Value<br>				&#125;<br>				<span class="hljs-keyword">if</span> ok &amp;&amp; (reply.Status == ErrWrongGroup) &#123;<br>					<span class="hljs-keyword">break</span><br>				&#125;<br>				<span class="hljs-comment">// ... not ok, or ErrWrongLeader</span><br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>		<span class="hljs-comment">// ask controler for the latest configuration.</span><br>		ck.config = ck.sm.Query(<span class="hljs-number">-1</span>)<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// shared by Put and Append.</span><br><span class="hljs-comment">// You will have to modify this function.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> PutAppend(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>, op <span class="hljs-type">string</span>) &#123;<br>	args := PutAppendArgs&#123;Key: key, Value: value, Op: op, ClientId: ck.clientId, SequenceNum: atomic.AddInt64(&amp;ck.currentSeqNum, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		shard := key2shard(key)<br>		gid := ck.config.Shards[shard]<br>		<span class="hljs-keyword">if</span> servers, ok := ck.config.Groups[gid]; ok &#123;<br>			<span class="hljs-keyword">for</span> si := <span class="hljs-number">0</span>; si &lt; <span class="hljs-built_in">len</span>(servers); si++ &#123;<br>				srv := ck.make_end(servers[si])<br>				<span class="hljs-keyword">var</span> reply PutAppendReply<br>				ok := srv.Call(<span class="hljs-string">&quot;ShardKV.PutAppend&quot;</span>, &amp;args, &amp;reply)<br>				<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>					<span class="hljs-keyword">return</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == ErrWrongGroup &#123;<br>					<span class="hljs-keyword">break</span><br>				&#125;<br>				<span class="hljs-comment">// ... not ok, or ErrWrongLeader</span><br>			&#125;<br>		&#125;<br>		time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>		<span class="hljs-comment">// ask controler for the latest configuration.</span><br>		ck.config = ck.sm.Query(<span class="hljs-number">-1</span>)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Put(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>) &#123;<br>	ck.PutAppend(key, value, <span class="hljs-string">&quot;Put&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> Append(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>) &#123;<br>	ck.PutAppend(key, value, <span class="hljs-string">&quot;Append&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><strong>common.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> shardkv<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Sharded key/value server.</span><br><span class="hljs-comment">// Lots of replica groups, each running Raft.</span><br><span class="hljs-comment">// Shardctrler decides which group serves each shard.</span><br><span class="hljs-comment">// Shardctrler may change shard assignment from time to time.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// You will have to modify these definitions.</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">const</span> (<br>	OK                        = <span class="hljs-string">&quot;OK&quot;</span><br>	ErrNoKey                  = <span class="hljs-string">&quot;ErrNoKey&quot;</span><br>	ErrWrongGroup             = <span class="hljs-string">&quot;ErrWrongGroup&quot;</span><br>	ErrWrongLeader            = <span class="hljs-string">&quot;ErrWrongLeader&quot;</span><br>	ErrTimeout                = <span class="hljs-string">&quot;ErrTimeout&quot;</span><br>	ErrWaitShardData          = <span class="hljs-string">&quot;ErrWaitShardData &quot;</span>         <span class="hljs-comment">// 等待分区数据</span><br>	ErrWaitTargetUpdateConfig = <span class="hljs-string">&quot;ErrWaitTargetUpdateConfig&quot;</span> <span class="hljs-comment">// 等待对方更新配置</span><br>	ErrWaitDelete             = <span class="hljs-string">&quot;ErrWaitDelete&quot;</span><br>	ErrShardStatus            = <span class="hljs-string">&quot;ErrShardStatus&quot;</span><br>	ErrUnexpectedNode         = <span class="hljs-string">&quot;ErrUnexpectedNode&quot;</span><br>	ErrOldRequest             = <span class="hljs-string">&quot;ErrOldRequest&quot;</span> <span class="hljs-comment">// 未出现</span><br>	ErrLogFull                = <span class="hljs-string">&quot;ErrLogFull&quot;</span>    <span class="hljs-comment">// 未用到</span><br><br>)<br><br><span class="hljs-keyword">type</span> Err <span class="hljs-type">string</span><br><br><span class="hljs-comment">// Put or Append</span><br><span class="hljs-keyword">type</span> PutAppendArgs <span class="hljs-keyword">struct</span> &#123;<br>	Key   <span class="hljs-type">string</span><br>	Value <span class="hljs-type">string</span><br>	Op    <span class="hljs-type">string</span> <span class="hljs-comment">// &quot;Put&quot; or &quot;Append&quot;</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> PutAppendReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>&#125;<br><br><span class="hljs-keyword">type</span> GetArgs <span class="hljs-keyword">struct</span> &#123;<br>	Key <span class="hljs-type">string</span><br>	<span class="hljs-comment">// 附带client id与序列号</span><br>	ClientId    <span class="hljs-type">int64</span><br>	SequenceNum <span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> GetReply <span class="hljs-keyword">struct</span> &#123;<br>	Status Err<br>	Value  <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ReqResult <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 命令执行返回</span><br>	SequenceNum <span class="hljs-type">int64</span>  <span class="hljs-comment">// 命令序列号</span><br>	Status      Err    <span class="hljs-comment">// 命令执行状态</span><br>	Value       <span class="hljs-type">string</span> <span class="hljs-comment">// 命令执行结果</span><br>&#125;<br><br><span class="hljs-keyword">type</span> MigrateArgs <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 分区数据迁移参数</span><br>	ConfigNum <span class="hljs-type">int</span> <span class="hljs-comment">// 请求者配置号</span><br>	GID       <span class="hljs-type">int</span> <span class="hljs-comment">// 请求者ID</span><br>	Shard     <span class="hljs-type">int</span> <span class="hljs-comment">// 请求分区号</span><br>&#125;<br><br><span class="hljs-keyword">type</span> MigrateReply <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 分区数据迁移返回</span><br>	Status     Err                 <span class="hljs-comment">// 返回状态</span><br>	KVData     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>   <span class="hljs-comment">// 分区数据</span><br>	ClintCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult <span class="hljs-comment">// 客户端最新结果</span><br>&#125;<br><br><span class="hljs-keyword">type</span> DeleteArgs <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 删除分区参数</span><br>	ConfigNum           <span class="hljs-type">int</span>   <span class="hljs-comment">// 请求者配置号</span><br>	MigrateSuccessShard []<span class="hljs-type">int</span> <span class="hljs-comment">// 请求者拥有的分区号</span><br>&#125;<br><br><span class="hljs-keyword">type</span> DeleteReply <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 删除分区返回</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> shardkv<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bytes&quot;</span><br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;6.824/labgob&quot;</span><br>	<span class="hljs-string">&quot;6.824/labrpc&quot;</span><br>	<span class="hljs-string">&quot;6.824/raft&quot;</span><br>	<span class="hljs-string">&quot;6.824/shardctrler&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> Debug = <span class="hljs-literal">true</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DPrintf</span><span class="hljs-params">(format <span class="hljs-type">string</span>, a ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> Debug &#123;<br>		log.Printf(format, a...)<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">const</span> (<br>	GeneralPollFrequency  = <span class="hljs-number">5</span> * time.Millisecond   <span class="hljs-comment">// 轮询时间</span><br>	TimeoutThreshold      = <span class="hljs-number">200</span> * time.Millisecond <span class="hljs-comment">// 超时阈值</span><br>	SnapshotPollFrequency = <span class="hljs-number">100</span> * time.Millisecond <span class="hljs-comment">// 快照轮询时间</span><br>	ConfigListenFrequency = <span class="hljs-number">100</span> * time.Millisecond <span class="hljs-comment">// 查询当前配置频率</span><br>	GeneralInterval       = <span class="hljs-number">100</span> * time.Millisecond <span class="hljs-comment">// 通用间隔</span><br>)<br><br><span class="hljs-keyword">type</span> ShardStatus <span class="hljs-type">int</span><br><br><span class="hljs-keyword">const</span> ( <span class="hljs-comment">// 分区状态</span><br>	IrresponsibleAndNotOwn ShardStatus = <span class="hljs-literal">iota</span><br>	IrresponsibleButOwn<br>	ResponsibleAndOwn<br>	ResponsibleButNotOwn<br>)<br><br><span class="hljs-keyword">type</span> AddShardCmd <span class="hljs-keyword">struct</span> &#123;<br>	ConfigNum   <span class="hljs-type">int</span>                 <span class="hljs-comment">// 配置号</span><br>	Shard       <span class="hljs-type">int</span>                 <span class="hljs-comment">// 分区号</span><br>	KVData      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>   <span class="hljs-comment">// 分区数据</span><br>	ClientCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult <span class="hljs-comment">// 客户端最新结果</span><br>&#125;<br><br><span class="hljs-keyword">type</span> DeleteShardCmd <span class="hljs-keyword">struct</span> &#123;<br>	ConfigNum <span class="hljs-type">int</span> <span class="hljs-comment">// 配置号</span><br>	Shard     <span class="hljs-type">int</span> <span class="hljs-comment">// 分区号</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ShardKV <span class="hljs-keyword">struct</span> &#123;<br>	mu           sync.Mutex<br>	me           <span class="hljs-type">int</span><br>	rf           *raft.Raft<br>	applyCh      <span class="hljs-keyword">chan</span> raft.ApplyMsg<br>	make_end     <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">string</span>)</span></span> *labrpc.ClientEnd<br>	gid          <span class="hljs-type">int</span><br>	ctrlers      []*labrpc.ClientEnd<br>	maxraftstate <span class="hljs-type">int</span> <span class="hljs-comment">// snapshot if log grows this big</span><br><br>	<span class="hljs-comment">// Your definitions here.</span><br>	done              <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>	persister         *raft.Persister<br>	mck               *shardctrler.Clerk                     <span class="hljs-comment">// 配置客户端</span><br>	lastConfig        shardctrler.Config                     <span class="hljs-comment">// 上次的配置</span><br>	config            shardctrler.Config                     <span class="hljs-comment">// 当前配置</span><br>	kvDatas           [shardctrler.NShards]<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-comment">// 各分区kv数据</span><br>	clientCache       <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult                    <span class="hljs-comment">// 存放各个客户端最新结果</span><br>	commitIndex       <span class="hljs-type">int</span>                                    <span class="hljs-comment">// server当前commit index</span><br>	lastSnapshotIndex <span class="hljs-type">int</span>                                    <span class="hljs-comment">// 上次快照的commit index</span><br>	shardStatus       [shardctrler.NShards]ShardStatus       <span class="hljs-comment">// 各分区状态</span><br>	allReplicaNode    <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>                       <span class="hljs-comment">// 见到的所有节点</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyMapKV</span><span class="hljs-params">(data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> &#123; <span class="hljs-comment">// 复制kv数据</span><br>	newData := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)<br>	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> data &#123;<br>		newData[key] = value<br>	&#125;<br>	<span class="hljs-keyword">return</span> newData<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyMapCache</span><span class="hljs-params">(data <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult &#123; <span class="hljs-comment">// 复制客户端最新结果</span><br>	newData := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult)<br>	<span class="hljs-keyword">for</span> id, res := <span class="hljs-keyword">range</span> data &#123;<br>		newData[id] = res<br>	&#125;<br>	<span class="hljs-keyword">return</span> newData<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Get(args *GetArgs, reply *GetReply) &#123;<br>	shard := key2shard(args.Key)<br>	exitFunc := <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">var</span> index <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> isLeader <span class="hljs-type">bool</span><br>	kv.mu.Lock()<br>	<span class="hljs-keyword">switch</span> kv.shardStatus[shard] &#123;<br>	<span class="hljs-keyword">case</span> IrresponsibleAndNotOwn: <span class="hljs-comment">// 错误的组</span><br>		reply.Status = ErrWrongGroup<br>	<span class="hljs-keyword">case</span> IrresponsibleButOwn: <span class="hljs-comment">// 错误的组</span><br>		reply.Status = ErrWrongGroup<br>	<span class="hljs-keyword">case</span> ResponsibleButNotOwn: <span class="hljs-comment">// 等待分区数据到达</span><br>		reply.Status = ErrWaitShardData<br>	<span class="hljs-keyword">case</span> ResponsibleAndOwn:<br>		index, _, isLeader = kv.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>		<span class="hljs-keyword">if</span> !isLeader &#123;<br>			reply.Status = ErrWrongLeader<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			exitFunc = <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;<br>	kv.mu.Unlock()<br>	<span class="hljs-keyword">if</span> exitFunc &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	requestBegin := time.Now()<br>	<span class="hljs-keyword">for</span> &#123;<br>		kv.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := kv.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> kv.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			reply.Value = cache.Value<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		kv.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> PutAppend(args *PutAppendArgs, reply *PutAppendReply) &#123;<br>	shard := key2shard(args.Key)<br>	exitFunc := <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">var</span> index <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> isLeader <span class="hljs-type">bool</span><br>	kv.mu.Lock()<br>	<span class="hljs-keyword">switch</span> kv.shardStatus[shard] &#123;<br>	<span class="hljs-keyword">case</span> IrresponsibleAndNotOwn: <span class="hljs-comment">// 错误的组</span><br>		reply.Status = ErrWrongGroup<br>	<span class="hljs-keyword">case</span> IrresponsibleButOwn: <span class="hljs-comment">// 错误的组</span><br>		reply.Status = ErrWrongGroup<br>	<span class="hljs-keyword">case</span> ResponsibleButNotOwn: <span class="hljs-comment">// 等待分区数据到达</span><br>		reply.Status = ErrWaitShardData<br>	<span class="hljs-keyword">case</span> ResponsibleAndOwn:<br>		index, _, isLeader = kv.rf.Start(*args) <span class="hljs-comment">// 开始协商用户请求</span><br>		<span class="hljs-keyword">if</span> !isLeader &#123;<br>			reply.Status = ErrWrongLeader<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			exitFunc = <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;<br>	kv.mu.Unlock()<br>	<span class="hljs-keyword">if</span> exitFunc &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	requestBegin := time.Now()<br>	<span class="hljs-keyword">for</span> &#123;<br>		kv.mu.Lock()<br>		outCycle := <span class="hljs-literal">false</span><br>		cache := kv.clientCache[args.ClientId]<br>		<span class="hljs-keyword">if</span> cache.SequenceNum &lt; args.SequenceNum &#123; <span class="hljs-comment">// 仍未执行相应请求</span><br>			<span class="hljs-keyword">if</span> kv.commitIndex &gt;= index &#123; <span class="hljs-comment">// 相应位置出现了其他的命令</span><br>				reply.Status = ErrWrongLeader<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> time.Since(requestBegin) &gt; TimeoutThreshold &#123; <span class="hljs-comment">// 等待超时</span><br>				reply.Status = ErrTimeout<br>				outCycle = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum == args.SequenceNum &#123; <span class="hljs-comment">// 请求执行成功</span><br>			reply.Status = cache.Status<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> cache.SequenceNum &gt; args.SequenceNum &#123;<br>			reply.Status = ErrOldRequest<br>			outCycle = <span class="hljs-literal">true</span><br>		&#125;<br>		kv.mu.Unlock()<br>		<span class="hljs-keyword">if</span> outCycle &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		time.Sleep(GeneralPollFrequency)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Migrate(args *MigrateArgs, reply *MigrateReply) &#123;<br>	_, isLeader := kv.rf.GetState()<br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		reply.Status = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	kv.mu.Lock()<br>	<span class="hljs-keyword">defer</span> kv.mu.Unlock()<br>	<span class="hljs-comment">// 与预期的分区数据请求者信息一致，将数据移交给该节点</span><br>	<span class="hljs-keyword">if</span> kv.config.Num == args.ConfigNum &amp;&amp; kv.config.Shards[args.Shard] == args.GID &amp;&amp; kv.shardStatus[args.Shard] == IrresponsibleButOwn &#123;<br>		DPrintf(<span class="hljs-string">&quot;%d shard migrate from %d-%d to %d success. config num is %d\n&quot;</span>, args.Shard, kv.gid, kv.me, args.GID, kv.config.Num)<br>		reply.KVData = copyMapKV(kv.kvDatas[args.Shard])<br>		reply.ClintCache = copyMapCache(kv.clientCache)<br>		reply.Status = OK<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	DPrintf(<span class="hljs-string">&quot;%d shard migrate from %d-%d to %d failed. config num is %d  arg config num is %d  shard status is %v\n&quot;</span>, args.Shard, kv.gid, kv.me, args.GID, kv.config.Num, args.ConfigNum, kv.shardStatus)<br>	reply.Status = ErrShardStatus<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Delete(args *DeleteArgs, reply *DeleteReply) &#123;<br>	_, isLeader := kv.rf.GetState()<br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	kv.mu.Lock()<br>	<span class="hljs-keyword">defer</span> kv.mu.Unlock()<br>	<span class="hljs-keyword">if</span> kv.config.Num &lt;= args.ConfigNum &#123; <span class="hljs-comment">// 请求者配置号比当前配置号更新或一致</span><br>		<span class="hljs-keyword">for</span> _, shard := <span class="hljs-keyword">range</span> args.MigrateSuccessShard &#123;<br>			<span class="hljs-keyword">if</span> kv.shardStatus[shard] == IrresponsibleButOwn &#123; <span class="hljs-comment">// 表示该数据已成功转移至其他节点</span><br>				DPrintf(<span class="hljs-string">&quot;%d-%d send delete %d shard cmd. config num is %d&quot;</span>, kv.gid, kv.me, shard, kv.config.Num)<br>				kv.rf.Start(DeleteShardCmd&#123;ConfigNum: kv.config.Num, Shard: shard&#125;) <span class="hljs-comment">// 删除分区数据命令</span><br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the tester calls Kill() when a ShardKV instance won&#x27;t</span><br><span class="hljs-comment">// be needed again. you are not required to do anything</span><br><span class="hljs-comment">// in Kill(), but it might be convenient to (for example)</span><br><span class="hljs-comment">// turn off debug output from this instance.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> Kill() &#123;<br>	kv.rf.Kill()<br>	<span class="hljs-comment">// Your code here, if desired.</span><br>	<span class="hljs-built_in">close</span>(kv.done)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> completeMigrate() <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">for</span> _, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>		<span class="hljs-keyword">if</span> status == ResponsibleButNotOwn || status == IrresponsibleButOwn &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> configListenTask() &#123; <span class="hljs-comment">// 配置监听线程</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			kv.mu.Lock()<br>			<span class="hljs-keyword">if</span> isLeader &amp;&amp; kv.completeMigrate() &#123;<br>				newConfig := kv.mck.Query(kv.config.Num + <span class="hljs-number">1</span>) <span class="hljs-comment">// 只查看下一任配置</span><br>				<span class="hljs-keyword">if</span> newConfig.Num == kv.config.Num+<span class="hljs-number">1</span> &#123;<br>					DPrintf(<span class="hljs-string">&quot;%d %d add new config cmd %v &quot;</span>, kv.gid, kv.me, newConfig)<br>					kv.rf.Start(newConfig) <span class="hljs-comment">// 最多更新至下一任配置</span><br>				&#125;<br>			&#125;<br>			kv.mu.Unlock()<br>			time.Sleep(GeneralInterval)<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> requestShardTask() &#123; <span class="hljs-comment">// 请求分区线程</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			<span class="hljs-keyword">if</span> isLeader &#123;<br>				kv.mu.Lock()<br>				<span class="hljs-keyword">for</span> shard, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>					<span class="hljs-keyword">if</span> status == ResponsibleButNotOwn &#123;<br>						<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(shard <span class="hljs-type">int</span>, lastConfig shardctrler.Config)</span></span> &#123;<br>							args := MigrateArgs&#123;ConfigNum: lastConfig.Num + <span class="hljs-number">1</span>, GID: kv.gid, Shard: shard&#125;<br>							oldOwner := lastConfig.Shards[shard] <span class="hljs-comment">// 向上一任拥有者请求分区数据</span><br>							<span class="hljs-keyword">for</span> _, server := <span class="hljs-keyword">range</span> lastConfig.Groups[oldOwner] &#123;<br>								reply := MigrateReply&#123;&#125;<br>								ok := kv.make_end(server).Call(<span class="hljs-string">&quot;ShardKV.Migrate&quot;</span>, &amp;args, &amp;reply)<br>								<span class="hljs-keyword">if</span> ok &amp;&amp; reply.Status == OK &#123;<br>									DPrintf(<span class="hljs-string">&quot;%d %d send add %d shard cmd.&quot;</span>, kv.gid, kv.me, shard)<br>									<span class="hljs-comment">// 增加分区数据命令</span><br>									kv.rf.Start(AddShardCmd&#123;ConfigNum: lastConfig.Num + <span class="hljs-number">1</span>, Shard: shard, KVData: reply.KVData, ClientCache: reply.ClintCache&#125;)<br>									<span class="hljs-keyword">return</span><br>								&#125;<br>							&#125;<br>						&#125;(shard, kv.lastConfig)<br>					&#125;<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br>			time.Sleep(GeneralInterval)<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> notifyDeleteTask() &#123; <span class="hljs-comment">// 提醒其他分组删除相应分区</span><br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">default</span>:<br>			_, isLeader := kv.rf.GetState()<br>			<span class="hljs-keyword">if</span> isLeader &#123;<br>				kv.mu.Lock()<br>				ownShards := []<span class="hljs-type">int</span>&#123;&#125;<br>				<span class="hljs-keyword">for</span> shard, status := <span class="hljs-keyword">range</span> kv.shardStatus &#123;<br>					<span class="hljs-keyword">if</span> status == ResponsibleAndOwn || status == IrresponsibleButOwn &#123; <span class="hljs-comment">// 当前拥有这些分区数据</span><br>						ownShards = <span class="hljs-built_in">append</span>(ownShards, shard)<br>					&#125;<br>				&#125;<br>				args := DeleteArgs&#123;ConfigNum: kv.config.Num, MigrateSuccessShard: ownShards&#125;<br>				<span class="hljs-keyword">for</span> gid, servers := <span class="hljs-keyword">range</span> kv.allReplicaNode &#123;<br>					<span class="hljs-keyword">if</span> gid != kv.gid &#123;<br>						<span class="hljs-keyword">for</span> _, server := <span class="hljs-keyword">range</span> servers &#123;<br>							reply := DeleteReply&#123;&#125;<br>							<span class="hljs-keyword">go</span> kv.make_end(server).Call(<span class="hljs-string">&quot;ShardKV.Delete&quot;</span>, &amp;args, &amp;reply)<br>						&#125;<br>					&#125;<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br><br>		&#125;<br>		time.Sleep(GeneralInterval)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 接受raft消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *ShardKV)</span></span> receiveTask() &#123;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-kv.done:<br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">case</span> msg := &lt;-kv.applyCh:<br>			&#123;<br>				kv.mu.Lock()<br>				<span class="hljs-keyword">if</span> msg.CommandValid &#123; <span class="hljs-comment">// 普通的日志消息</span><br>					kv.commitIndex = msg.CommandIndex<br>					<span class="hljs-keyword">switch</span> data := msg.Command.(<span class="hljs-keyword">type</span>) &#123;<br>					<span class="hljs-keyword">case</span> GetArgs:<br>						shard := key2shard(data.Key)<br>						cache := kv.clientCache[data.ClientId] <span class="hljs-comment">// 查看相应客户端缓存</span><br>						<span class="hljs-keyword">if</span> cache.SequenceNum &lt; data.SequenceNum &amp;&amp; kv.shardStatus[shard] == ResponsibleAndOwn &#123;<br>							value, exist := kv.kvDatas[shard][data.Key]<br>							<span class="hljs-keyword">if</span> !exist &#123;<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: ErrNoKey&#125;<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK, Value: value&#125;<br>							&#125;<br><br>						&#125;<br>					<span class="hljs-keyword">case</span> PutAppendArgs:<br>						shard := key2shard(data.Key)<br>						cache := kv.clientCache[data.ClientId] <span class="hljs-comment">// 查看相应客户端缓存</span><br>						<span class="hljs-keyword">if</span> cache.SequenceNum &lt; data.SequenceNum &amp;&amp; kv.shardStatus[shard] == ResponsibleAndOwn &#123;<br>							<span class="hljs-keyword">if</span> data.Op == <span class="hljs-string">&quot;Put&quot;</span> &#123;<br>								kv.kvDatas[shard][data.Key] = data.Value<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK&#125;<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								kv.kvDatas[shard][data.Key] += data.Value<br>								kv.clientCache[data.ClientId] = ReqResult&#123;SequenceNum: data.SequenceNum, Status: OK&#125;<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> shardctrler.Config:<br>						<span class="hljs-keyword">if</span> kv.config.Num &lt; data.Num &#123;<br>							DPrintf(<span class="hljs-string">&quot;%d %d update config.old config:%v new config:%v&quot;</span>, kv.gid, kv.me, kv.config, data)<br>							<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; shardctrler.NShards; i++ &#123;<br>								oldOwner := kv.config.Shards[i]<br>								newOwner := data.Shards[i]<br>								<span class="hljs-keyword">if</span> newOwner == kv.gid &amp;&amp; oldOwner != kv.gid &#123;<br>									<span class="hljs-keyword">if</span> oldOwner == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 第一任拥有者</span><br>										kv.shardStatus[i] = ResponsibleAndOwn<br>										kv.kvDatas[i] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>) <span class="hljs-comment">// 初始化map</span><br>									&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 等待上一任拥有者的分区数据</span><br>										kv.shardStatus[i] = ResponsibleButNotOwn<br>									&#125;<br>								&#125;<br>								<span class="hljs-keyword">if</span> newOwner != kv.gid &amp;&amp; oldOwner == kv.gid &#123;<br>									<span class="hljs-keyword">if</span> kv.shardStatus[i] == ResponsibleAndOwn &#123;<br>										kv.shardStatus[i] = IrresponsibleButOwn<br>									&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 不可能发生</span><br>										kv.shardStatus[i] = IrresponsibleAndNotOwn<br>									&#125;<br>								&#125;<br>							&#125;<br>							kv.lastConfig = kv.config<br>							kv.config = data<br>							<span class="hljs-keyword">for</span> gid, servers := <span class="hljs-keyword">range</span> data.Groups &#123; <span class="hljs-comment">// 更新见到的所有节点</span><br>								kv.allReplicaNode[gid] = servers<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> AddShardCmd:<br>						<span class="hljs-keyword">if</span> kv.config.Num == data.ConfigNum &amp;&amp; kv.shardStatus[data.Shard] == ResponsibleButNotOwn &#123; <span class="hljs-comment">// 预期的分区数据到达</span><br>							DPrintf(<span class="hljs-string">&quot;%d %d add new %d shard data. config num is %d&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num)<br>							kv.kvDatas[data.Shard] = copyMapKV(data.KVData)<br>							kv.shardStatus[data.Shard] = ResponsibleAndOwn<br>							<span class="hljs-keyword">for</span> id, res := <span class="hljs-keyword">range</span> data.ClientCache &#123; <span class="hljs-comment">// 更新最新客户端结果</span><br>								<span class="hljs-keyword">if</span> kv.clientCache[id].SequenceNum &lt; res.SequenceNum &#123;<br>									kv.clientCache[id] = res<br>								&#125;<br>							&#125;<br>						&#125;<br>					<span class="hljs-keyword">case</span> DeleteShardCmd:<br>						DPrintf(<span class="hljs-string">&quot;before:%d %d delete %d shard data. config num is %d  shard status:%v&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num, kv.shardStatus)<br>						<span class="hljs-keyword">if</span> kv.config.Num == data.ConfigNum &amp;&amp; kv.shardStatus[data.Shard] == IrresponsibleButOwn &#123;<br>							kv.shardStatus[data.Shard] = IrresponsibleAndNotOwn<br>							kv.kvDatas[data.Shard] = <span class="hljs-literal">nil</span><br>							DPrintf(<span class="hljs-string">&quot;after: %d %d delete %d shard data. config num is %d  shard status:%v&quot;</span>, kv.gid, kv.me, data.Shard, kv.config.Num, kv.shardStatus)<br>						&#125;<br>					&#125;<br><br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> msg.SnapshotValid &#123; <span class="hljs-comment">// 快照消息</span><br>					r := bytes.NewBuffer(msg.Snapshot)<br>					d := labgob.NewDecoder(r)<br>					<span class="hljs-keyword">var</span> commitIndex <span class="hljs-type">int</span><br>					<span class="hljs-keyword">var</span> clientCache <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult<br>					<span class="hljs-keyword">var</span> kvDatas [shardctrler.NShards]<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>					<span class="hljs-keyword">var</span> config shardctrler.Config<br>					<span class="hljs-keyword">var</span> shardStatus [shardctrler.NShards]ShardStatus<br>					<span class="hljs-keyword">var</span> allNode <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span><br>					<span class="hljs-keyword">if</span> d.Decode(&amp;commitIndex) != <span class="hljs-literal">nil</span> || d.Decode(&amp;clientCache) != <span class="hljs-literal">nil</span> || d.Decode(&amp;kvDatas) != <span class="hljs-literal">nil</span> || d.Decode(&amp;config) != <span class="hljs-literal">nil</span> || d.Decode(&amp;shardStatus) != <span class="hljs-literal">nil</span> || d.Decode(&amp;allNode) != <span class="hljs-literal">nil</span> &#123;<br>						log.Panicf(<span class="hljs-string">&quot;snapshot decode error&quot;</span>)<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						DPrintf(<span class="hljs-string">&quot;%d %d recv snapshot. shard status:%v&quot;</span>, kv.gid, kv.me, shardStatus)<br>						kv.commitIndex = commitIndex<br>						kv.clientCache = clientCache<br>						kv.kvDatas = kvDatas<br>						kv.config = config<br>						kv.lastConfig = kv.mck.Query(config.Num - <span class="hljs-number">1</span>)<br>						kv.shardStatus = shardStatus<br>						kv.allReplicaNode = allNode<br>						<span class="hljs-comment">// 更新lastSnapshotIndex</span><br>						kv.lastSnapshotIndex = commitIndex<br>					&#125;<br>				&#125;<br>				<span class="hljs-comment">// 检查raft state大小，生成快照</span><br>				<span class="hljs-keyword">if</span> kv.maxraftstate &gt; <span class="hljs-number">0</span> &amp;&amp; kv.persister.RaftStateSize() &gt; kv.maxraftstate &amp;&amp; kv.commitIndex &gt; kv.lastSnapshotIndex &#123;<br>					w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>					e := labgob.NewEncoder(w)<br>					e.Encode(kv.commitIndex)<br>					e.Encode(kv.clientCache)<br>					e.Encode(kv.kvDatas)<br>					<span class="hljs-comment">// 将以下数据编码至快照</span><br>					e.Encode(kv.config)<br>					e.Encode(kv.shardStatus)<br>					e.Encode(kv.allReplicaNode)<br>					snapshot := w.Bytes()<br>					kv.rf.Snapshot(kv.commitIndex, snapshot)<br>					kv.lastSnapshotIndex = kv.commitIndex<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// servers[] contains the ports of the servers in this group.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// me is the index of the current server in servers[].</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the k/v server should store snapshots through the underlying Raft</span><br><span class="hljs-comment">// implementation, which should call persister.SaveStateAndSnapshot() to</span><br><span class="hljs-comment">// atomically save the Raft state along with the snapshot.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// the k/v server should snapshot when Raft&#x27;s saved state exceeds</span><br><span class="hljs-comment">// maxraftstate bytes, in order to allow Raft to garbage-collect its</span><br><span class="hljs-comment">// log. if maxraftstate is -1, you don&#x27;t need to snapshot.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// gid is this group&#x27;s GID, for interacting with the shardctrler.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// pass ctrlers[] to shardctrler.MakeClerk() so you can send</span><br><span class="hljs-comment">// RPCs to the shardctrler.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// make_end(servername) turns a server name from a</span><br><span class="hljs-comment">// Config.Groups[gid][i] into a labrpc.ClientEnd on which you can</span><br><span class="hljs-comment">// send RPCs. You&#x27;ll need this to send RPCs to other groups.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// look at client.go for examples of how to use ctrlers[]</span><br><span class="hljs-comment">// and make_end() to send RPCs to the group owning a specific shard.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// StartServer() must return quickly, so it should start goroutines</span><br><span class="hljs-comment">// for any long-running work.</span><br><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StartServer</span><span class="hljs-params">(servers []*labrpc.ClientEnd, me <span class="hljs-type">int</span>, persister *raft.Persister, maxraftstate <span class="hljs-type">int</span>, gid <span class="hljs-type">int</span>, ctrlers []*labrpc.ClientEnd, make_end <span class="hljs-keyword">func</span>(<span class="hljs-type">string</span>)</span></span> *labrpc.ClientEnd) *ShardKV &#123;<br>	<span class="hljs-comment">// call labgob.Register on structures you want</span><br>	<span class="hljs-comment">// Go&#x27;s RPC library to marshall/unmarshall.</span><br>	labgob.Register(GetArgs&#123;&#125;)<br>	labgob.Register(PutAppendArgs&#123;&#125;)<br>	labgob.Register(shardctrler.Config&#123;&#125;)<br>	labgob.Register(AddShardCmd&#123;&#125;)<br>	labgob.Register(DeleteShardCmd&#123;&#125;)<br>	kv := <span class="hljs-built_in">new</span>(ShardKV)<br>	kv.me = me<br>	kv.maxraftstate = maxraftstate<br>	kv.make_end = make_end<br>	kv.gid = gid<br>	kv.ctrlers = ctrlers<br><br>	<span class="hljs-comment">// Your initialization code here.</span><br><br>	<span class="hljs-comment">// Use something like this to talk to the shardctrler:</span><br>	<span class="hljs-comment">// kv.mck = shardctrler.MakeClerk(kv.ctrlers)</span><br><br>	kv.applyCh = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> raft.ApplyMsg)<br>	kv.rf = raft.Make(servers, me, persister, kv.applyCh)<br><br>	kv.done = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>	kv.persister = persister<br>	kv.mck = shardctrler.MakeClerk(kv.ctrlers)<br>	kv.config.Num = <span class="hljs-number">0</span><br>	kv.config.Groups = <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>&#123;&#125;<br>	kv.clientCache = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]ReqResult)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; shardctrler.NShards; i++ &#123;<br>		kv.shardStatus[i] = IrresponsibleAndNotOwn<br>	&#125;<br>	kv.allReplicaNode = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>][]<span class="hljs-type">string</span>)<br>	<span class="hljs-comment">// 开启一系列线程</span><br>	<span class="hljs-keyword">go</span> kv.receiveTask()<br>	<span class="hljs-keyword">go</span> kv.configListenTask()<br>	<span class="hljs-keyword">go</span> kv.requestShardTask()<br>	<span class="hljs-keyword">go</span> kv.notifyDeleteTask()<br>	<span class="hljs-keyword">return</span> kv<br>&#125;<br><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%9B%BD%E5%A4%96%E8%AF%BE%E7%A8%8B%E5%AE%9E%E9%AA%8C/" class="category-chain-item">国外课程实验</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Sharded-kv-6-824-lab4-shardkv/" class="print-no-link">#Sharded kv 6.824 lab4 shardkv</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/%E3%80%8Ac%E4%B8%93%E5%AE%B6%E7%BC%96%E7%A8%8B%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html" title="《c专家编程》读书笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">《c专家编程》读书笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/mit6.824%202022%20lab3.html" title="mit6.824 2022 lab3">
                        <span class="hidden-mobile">mit6.824 2022 lab3</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz","appKey":"0e2MMh7ddBCGGytOe9UEy5NP","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://uu0wegco.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/chitose.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
