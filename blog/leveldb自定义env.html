<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg"><link rel="icon" href="/img/nano-1.jpg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="最佳损友1020"><meta name="keywords" content=""><meta name="description" content="由于项目需求，需要自定义LevelDB的env，也就是以块接口实现env中各个文件接口，在网上没找到类似的代码，就打算自己参照util&#x2F;env_posix.cc实现一个简单的demo，等到功能实现差不多的时候，却发现leveldb有一个类似功能的代码helpers&#x2F;memenv&#x2F;memenv.cc，且各方面都写的比我好，故这篇博客主要记录实现过程中遇到的问题"><meta property="og:type" content="article"><meta property="og:title" content="leveldb自定义env"><meta property="og:url" content="https://www.jiasun.top/blog/leveldb%E8%87%AA%E5%AE%9A%E4%B9%89env.html"><meta property="og:site_name" content="最佳损友1020’s Blog"><meta property="og:description" content="由于项目需求，需要自定义LevelDB的env，也就是以块接口实现env中各个文件接口，在网上没找到类似的代码，就打算自己参照util&#x2F;env_posix.cc实现一个简单的demo，等到功能实现差不多的时候，却发现leveldb有一个类似功能的代码helpers&#x2F;memenv&#x2F;memenv.cc，且各方面都写的比我好，故这篇博客主要记录实现过程中遇到的问题"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img-blog.csdnimg.cn/3107463f4f7a429b9ae1ecc36c764762.png"><meta property="article:published_time" content="2023-05-05T13:35:45.000Z"><meta property="article:modified_time" content="2023-10-31T14:45:59.147Z"><meta property="article:author" content="最佳损友1020"><meta property="article:tag" content="LevelDB 自定义env"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://img-blog.csdnimg.cn/3107463f4f7a429b9ae1ecc36c764762.png"><title>leveldb自定义env - 最佳损友1020’s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/csdn.css"><link rel="stylesheet" href="/css/top.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.jiasun.top",root:"/",version:"1.9.5-a",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:4},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz",app_key:"ljkRZDiTtVmjn5mpaQmpFqgv",server_url:"https://n227fxnj.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>最佳损友1020</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/bg.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="leveldb自定义env"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-05-05 21:35" pubdate>2023年5月5日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 13k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 105 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">leveldb自定义env</h1><div class="markdown-body"><meta name="referrer" content="no-referrer"><p>由于项目需求，需要自定义LevelDB的env，也就是以块接口实现env中各个文件接口，在网上没找到类似的代码，就打算自己参照<strong>util&#x2F;env_posix.cc</strong>实现一个简单的demo，等到功能实现差不多的时候，却发现leveldb有一个类似功能的代码<strong>helpers&#x2F;memenv&#x2F;memenv.cc</strong>，且各方面都写的比我好，故这篇博客主要记录实现过程中遇到的问题。<br>增加了四个文件 filesystem.h filesystem.c simple_env.h simple_env.c</p><p>代码链接：<a target="_blank" rel="noopener" href="https://github.com/1020xyr/leveldb_env">leveldb_env</a></p><h3 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h3><p>version0是自己写的版本，version1是我对照InMemoryEnv修改过的版本</p><p>主要的修改点在于：<br>1 头文件的放置<br><img src="https://img-blog.csdnimg.cn/58047506897d4e79ba5d1d9bdf9e7e89.png" srcset="/img/loading.gif" lazyload><br>刚开始我把自己定义的类都放在头文件中，而后放在include&#x2F;leveldb，想要提供给测试程序使用，后面看InMemoryEnv发现并不需要这样，在程序使用自定义env时只需要Env*就可以了，并不需要那么多的实现细节，这也是虚函数的意义所在，故将头文件放在myenv目录下，env.h中添加函数声明</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LEVELDB_EXPORT</span> Env &#123;<br>  <span class="hljs-function"><span class="hljs-type">static</span> Env* <span class="hljs-title">GetSimpleEnv</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在simle_env.cc中实现函数</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Env* <span class="hljs-title">Env::GetSimpleEnv</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> SimpleEnv::<span class="hljs-built_in">GetInstance</span>(); &#125;<br></code></pre></td></tr></table></figure><p>2 使用锁-引用计数保护数据结构</p><p>3 代码中的简单出错处理</p><p>4 不同文件类型的处理逻辑</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">NewSequentialFile: 文件不存在则返回错误<br>NewRandomAccessFile: 文件不存在则返回错误<br>NewWritableFile: 文件不存在则创建，存在则清空数据<br>NewAppendableFile: 文件不存在则创建<br></code></pre></td></tr></table></figure><h3 id="undefined-reference-to-typeinfo-for-leveldb-Env"><a href="#undefined-reference-to-typeinfo-for-leveldb-Env" class="headerlink" title="undefined reference to &#96;typeinfo for leveldb::Env"></a>undefined reference to &#96;typeinfo for leveldb::Env</h3><p>编译测试程序的时候出现以下错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/bin/ld: /tmp/ccXgrLBz.o:(.data.rel.ro._ZTIN7leveldb9SimpleEnvE[_ZTIN7leveldb9SimpleEnvE]+0x10): undefined reference to `typeinfo <span class="hljs-keyword">for</span> leveldb::Env<span class="hljs-string">&#x27;</span><br><span class="hljs-string">/usr/bin/ld: /tmp/ccXgrLBz.o:(.data.rel.ro._ZTIN7leveldb18SimpleWritableFileE[_ZTIN7leveldb18SimpleWritableFileE]+0x10): undefined reference to `typeinfo for leveldb::WritableFile&#x27;</span><br>/usr/bin/ld: /tmp/ccXgrLBz.o:(.data.rel.ro._ZTIN7leveldb22SimpleRandomAccessFileE[_ZTIN7leveldb22SimpleRandomAccessFileE]+0x10): undefined reference to `typeinfo <span class="hljs-keyword">for</span> leveldb::RandomAccessFile<span class="hljs-string">&#x27;</span><br><span class="hljs-string">/usr/bin/ld: /tmp/ccXgrLBz.o:(.data.rel.ro._ZTIN7leveldb20SimpleSequentialFileE[_ZTIN7leveldb20SimpleSequentialFileE]+0x10): undefined reference to `typeinfo for leveldb::SequentialFile&#x27;</span><br></code></pre></td></tr></table></figure><p>自然而然地，看到undefined我就使用nm命令列出了simple_env.o定义的符号，却发现没有我定义那些函数，我就认为问题出现在这里，实际上当时我将所有的实现都写在了头文件里，也就是说全都是内联函数，<strong>内联函数本来就不会出现在符号表中</strong>。<br>简单测试：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">info</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> a; &#125;  <span class="hljs-comment">// 内联函数</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>;             <span class="hljs-comment">// 非内联函数</span><br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-type">int</span> a;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Test::print</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">int</span> a;<br>  <span class="hljs-type">int</span> b = a + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu ~/l/l/test (main)<span class="hljs-comment"># g++ inline_test.cpp -c</span><br>root@ubuntu ~/l/l/test (main)<span class="hljs-comment"># nm inline_test.o</span><br>0000000000000000 T _ZN4Test5printEv<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/2018shawn/p/10851779.html">C++内联函数的使用</a></p><p>而后调转方向，查看undefined reference to &#96;typeinfo for leveldb::SequentialFile’错误信息的相关博客，找到了以下博客<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/heli200482128/article/details/80053728">Undefined Reference to Typeinfo</a><br>混用了no-RTTI代码和RTTI代码，查看LevelDB的CMakeLists.txt，发现确实禁用了RTTI</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Disable RTTI.</span><br>string(REGEX REPLACE <span class="hljs-string">&quot;-frtti&quot;</span> <span class="hljs-string">&quot;&quot;</span> CMAKE_CXX_FLAGS <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_CXX_FLAGS&#125;</span>&quot;</span>)<br><span class="hljs-built_in">set</span>(CMAKE_CXX_FLAGS <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fno-rtti&quot;</span>)<br></code></pre></td></tr></table></figure><p>故编译测试程序时加上编译选项-fno-rtti</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">g++ test.cpp -o test -g -pthread -lleveldb -fno-rtti<br></code></pre></td></tr></table></figure><p>编译成功！</p><p>阅读RTTI的相关博客<br><a target="_blank" rel="noopener" href="https://pvs-studio.com/fr/blog/posts/cpp/0998/">Is there life without RTTI or How we wrote our own dynamic_cast</a><br><a target="_blank" rel="noopener" href="https://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/others/">谷歌C++风格指南 运行时类型识别</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/techx/article/details/44462225">运行时类型信息RTTI</a></p><p><mark>后面我调整了头文件的位置，只暴露Env* GetSimpleEnv()接口，即使不加-fno-rtti也不报错。</mark></p><h3 id="cmake相关"><a href="#cmake相关" class="headerlink" title="cmake相关"></a>cmake相关</h3><p>刚开始我是手动拷贝头文件与库文件，比较麻烦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> build/libleveldb.a /usr/local/lib/<br><span class="hljs-built_in">cp</span> -r include/leveldb/ /usr/local/include/<br></code></pre></td></tr></table></figure><p>看CMakeLists.txt里发现有install，故直接make install安装头文件与库文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span>(LEVELDB_INSTALL)<br>  install(TARGETS leveldb<br>    EXPORT leveldbTargets<br>    RUNTIME DESTINATION <span class="hljs-variable">$&#123;CMAKE_INSTALL_BINDIR&#125;</span><br>    LIBRARY DESTINATION <span class="hljs-variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>    ARCHIVE DESTINATION <span class="hljs-variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br>  )<br>  install(<br>    FILES<br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/c.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/cache.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/comparator.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/db.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/dumpfile.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/env.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/export.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/filter_policy.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/iterator.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/options.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/slice.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/status.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/table_builder.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/table.h&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LEVELDB_PUBLIC_INCLUDE_DIR&#125;</span>/write_batch.h&quot;</span><br>    DESTINATION <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span>/leveldb&quot;</span><br>  )<br><br>  include(CMakePackageConfigHelpers)<br>  configure_package_config_file(<br>    <span class="hljs-string">&quot;cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>Config.cmake.in&quot;</span><br>    <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>Config.cmake&quot;</span><br>    INSTALL_DESTINATION <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>&quot;</span><br>  )<br>  write_basic_package_version_file(<br>    <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>ConfigVersion.cmake&quot;</span><br>    COMPATIBILITY SameMajorVersion<br>  )<br>  install(<br>    EXPORT leveldbTargets<br>    NAMESPACE leveldb::<br>    DESTINATION <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>&quot;</span><br>  )<br>  install(<br>    FILES<br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>Config.cmake&quot;</span><br>      <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>ConfigVersion.cmake&quot;</span><br>    DESTINATION <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>&quot;</span><br>  )<br>endif(LEVELDB_INSTALL)<br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/102955723">CMake之install方法的使用</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43862847/article/details/119762230">CMAKE 里PRIVATE、PUBLIC、INTERFACE属性示例详解</a><br><img src="https://img-blog.csdnimg.cn/698af498d1bf411eb25ac14a9afbc653.png" srcset="/img/loading.gif" lazyload></p><h3 id="InMemoryEnv中引用计数的处理"><a href="#InMemoryEnv中引用计数的处理" class="headerlink" title="InMemoryEnv中引用计数的处理"></a>InMemoryEnv中引用计数的处理</h3><p>leveldb中env 文件操作的使用示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c">Status <span class="hljs-title function_">BuildTable</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; dbname, Env* env, <span class="hljs-type">const</span> Options&amp; options,</span><br><span class="hljs-params">                  TableCache* table_cache, Iterator* iter, FileMetaData* meta)</span> &#123;<br>  Status s;<br>  meta-&gt;file_size = <span class="hljs-number">0</span>;<br>  iter-&gt;SeekToFirst();<br><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> fname = TableFileName(dbname, meta-&gt;number);<br>  <span class="hljs-keyword">if</span> (iter-&gt;Valid()) &#123;<br>    WritableFile* file;<br>    s = env-&gt;NewWritableFile(fname, &amp;file);<br>    <span class="hljs-keyword">if</span> (!s.ok()) &#123;<br>      <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    TableBuilder* builder = new TableBuilder(options, file);<br>    meta-&gt;smallest.DecodeFrom(iter-&gt;key());<br>    Slice key;<br>    <span class="hljs-keyword">for</span> (; iter-&gt;Valid(); iter-&gt;Next()) &#123;<br>      key = iter-&gt;key();<br>      builder-&gt;Add(key, iter-&gt;value());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!key.empty()) &#123;<br>      meta-&gt;largest.DecodeFrom(key);<br>    &#125;<br><br>    <span class="hljs-comment">// Finish and check for builder errors</span><br>    s = builder-&gt;Finish();<br>    <span class="hljs-keyword">if</span> (s.ok()) &#123;<br>      meta-&gt;file_size = builder-&gt;FileSize();<br>      assert(meta-&gt;file_size &gt; <span class="hljs-number">0</span>);<br>    &#125;<br>    delete builder;<br><br>    <span class="hljs-comment">// Finish and check for file errors</span><br>    <span class="hljs-keyword">if</span> (s.ok()) &#123;<br>      s = file-&gt;Sync();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (s.ok()) &#123;<br>      s = file-&gt;Close();<br>    &#125;<br>    delete file;<br>    file = nullptr;<br><br>    <span class="hljs-keyword">if</span> (s.ok()) &#123;<br>      <span class="hljs-comment">// Verify that the table is usable</span><br>      Iterator* it = table_cache-&gt;NewIterator(ReadOptions(), meta-&gt;number,<br>                                              meta-&gt;file_size);<br>      s = it-&gt;status();<br>      delete it;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Check for input iterator errors</span><br>  <span class="hljs-keyword">if</span> (!iter-&gt;status().ok()) &#123;<br>    s = iter-&gt;status();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (s.ok() &amp;&amp; meta-&gt;file_size &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// Keep it</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    env-&gt;RemoveFile(fname);<br>  &#125;<br>  <span class="hljs-keyword">return</span> s;<br>&#125;<br></code></pre></td></tr></table></figure><p>关注以下两行，阅读InMemoryEnv的相关实现</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">s = env-&gt;NewWritableFile(fname, &amp;file);<br>delete file;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileState</span> &#123;</span><br>  <span class="hljs-comment">// Increase the reference count.</span><br>  <span class="hljs-type">void</span> <span class="hljs-title function_">Ref</span><span class="hljs-params">()</span> &#123;		<span class="hljs-comment">// 增加文件引用计数</span><br>    MutexLock <span class="hljs-title function_">lock</span><span class="hljs-params">(&amp;refs_mutex_)</span>;<br>    ++refs_;<br>  &#125;<br><br>  <span class="hljs-comment">// Decrease the reference count. Delete if this is the last reference.</span><br>  <span class="hljs-type">void</span> <span class="hljs-title function_">Unref</span><span class="hljs-params">()</span> &#123;	<span class="hljs-comment">// 减小文件引用计数，为0时删除指向对象	</span><br>    <span class="hljs-type">bool</span> do_delete = <span class="hljs-literal">false</span>;<br><br>    &#123;<br>      MutexLock <span class="hljs-title function_">lock</span><span class="hljs-params">(&amp;refs_mutex_)</span>;<br>      --refs_;<br>      assert(refs_ &gt;= <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (refs_ &lt;= <span class="hljs-number">0</span>) &#123;<br>        do_delete = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (do_delete) &#123;<br>      delete this;<br>    &#125;<br>  &#125;<br> private:<br>  <span class="hljs-type">int</span> refs_ <span class="hljs-title function_">GUARDED_BY</span><span class="hljs-params">(refs_mutex_)</span>;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InMemoryEnv</span> :</span> public EnvWrapper &#123;<br> public:<br>  explicit <span class="hljs-title function_">InMemoryEnv</span><span class="hljs-params">(Env* base_env)</span> : <span class="hljs-title function_">EnvWrapper</span><span class="hljs-params">(base_env)</span> &#123;&#125;<br><br>  ~InMemoryEnv() override &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; kvp : file_map_) &#123;<br>      kvp.second-&gt;Unref();				<span class="hljs-comment">// 减小现存文件的引用计数</span><br>    &#125;<br>  &#125;<br> private:<br>  <span class="hljs-comment">// Map from filenames to FileState objects, representing a simple file system.</span><br>  <span class="hljs-keyword">typedef</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">map</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>, FileState*&gt; FileSystem;	<span class="hljs-comment">// 文件名与文件对象映射</span><br><br>  port::Mutex mutex_;<br>  FileSystem file_map_ <span class="hljs-title function_">GUARDED_BY</span><span class="hljs-params">(mutex_)</span>;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WritableFileImpl</span> :</span> public WritableFile &#123;<br> public:<br>  WritableFileImpl(FileState* file) : file_(file) &#123; file_-&gt;Ref(); &#125;<br><br>  ~WritableFileImpl() override &#123; file_-&gt;Unref(); &#125;<br>  <br> private:<br>  FileState* file_;<br>&#125;;<br><br><br>Status <span class="hljs-title function_">NewWritableFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; fname, WritableFile** result)</span> override &#123;<br>  MutexLock <span class="hljs-title function_">lock</span><span class="hljs-params">(&amp;mutex_)</span>;<br>  FileSystem::iterator it = file_map_.find(fname);<br><br>  FileState* file;<br>  <span class="hljs-keyword">if</span> (it == file_map_.end()) &#123;<br>    <span class="hljs-comment">// File is not currently open.</span><br>    file = new FileState(); <span class="hljs-comment">// 此时文件引用计数为0</span><br>    file-&gt;Ref();			  <span class="hljs-comment">// 此时文件引用计数为1</span><br>    file_map_[fname] = file;<br>  &#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// 文件已存在，引用计数为1</span><br>    file = it-&gt;second;<br>    file-&gt;Truncate();<br>  &#125;<br><br>  *result = new WritableFileImpl(file);	<span class="hljs-comment">// 此时文件引用计数为2</span><br>  <span class="hljs-keyword">return</span> Status::OK();<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出，在leveldb使用过程中，只要文件未删除（Env的RemoveFile），即使调用delete语句删除文件对象，文件对象的引用计数只是从2变成1，仍然存在于内存中</p><h3 id="单线程写入"><a href="#单线程写入" class="headerlink" title="单线程写入"></a>单线程写入</h3><p>leveldb使用单线程合并sst文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">DBImpl::MaybeScheduleCompaction</span><span class="hljs-params">()</span> &#123;<br>  mutex_.AssertHeld();<br>  <span class="hljs-keyword">if</span> (background_compaction_scheduled_) &#123;<br>    <span class="hljs-comment">// Already scheduled</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shutting_down_.load(<span class="hljs-built_in">std</span>::memory_order_acquire)) &#123;<br>    <span class="hljs-comment">// DB is being deleted; no more background compactions</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!bg_error_.ok()) &#123;<br>    <span class="hljs-comment">// Already got an error; no more changes</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (imm_ == nullptr &amp;&amp; manual_compaction_ == nullptr &amp;&amp; !versions_-&gt;NeedsCompaction()) &#123;<br>    <span class="hljs-comment">// No work to be done</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    background_compaction_scheduled_ = <span class="hljs-literal">true</span>;<br>    env_-&gt;Schedule(&amp;DBImpl::BGWork, this);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 关注Schedule posix实现</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">PosixEnv::Schedule</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">void</span> (*background_work_function)(<span class="hljs-type">void</span>* background_work_arg),</span><br><span class="hljs-params">    <span class="hljs-type">void</span>* background_work_arg)</span> &#123;<br>  background_work_mutex_.Lock();<br><br>  <span class="hljs-comment">// Start the background thread, if we haven&#x27;t done so already.</span><br>  <span class="hljs-keyword">if</span> (!started_background_thread_) &#123;  	<span class="hljs-comment">// 只开启一个线程进行合并操作</span><br>    started_background_thread_ = <span class="hljs-literal">true</span>;<br>    <span class="hljs-built_in">std</span>::thread <span class="hljs-title function_">background_thread</span><span class="hljs-params">(PosixEnv::BackgroundThreadEntryPoint, this)</span>;<br>    background_thread.detach();<br>  &#125;<br><br>  <span class="hljs-comment">// If the queue is empty, the background thread may be waiting for work.</span><br>  <span class="hljs-keyword">if</span> (background_work_queue_.empty()) &#123;<br>    background_work_cv_.Signal();<br>  &#125;<br><br>  background_work_queue_.emplace(background_work_function, background_work_arg);<br>  background_work_mutex_.Unlock();<br>&#125;<br><br><span class="hljs-comment">// 线程主函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">BackgroundThreadEntryPoint</span><span class="hljs-params">(PosixEnv* env)</span> &#123;<br>  env-&gt;BackgroundThreadMain();<br>&#125;<br><span class="hljs-comment">// 没有任务时休眠，有任务时一次执行一个任务</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">PosixEnv::BackgroundThreadMain</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    background_work_mutex_.Lock();<br><br>    <span class="hljs-comment">// Wait until there is work to be done.</span><br>    <span class="hljs-keyword">while</span> (background_work_queue_.empty()) &#123;<br>      background_work_cv_.Wait();<br>    &#125;<br><br>    assert(!background_work_queue_.empty());<br>    <span class="hljs-keyword">auto</span> background_work_function = background_work_queue_.front().function;<br>    <span class="hljs-type">void</span>* background_work_arg = background_work_queue_.front().arg;<br>    background_work_queue_.pop();<br><br>    background_work_mutex_.Unlock();<br>    background_work_function(background_work_arg);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="GetChildren"><a href="#GetChildren" class="headerlink" title="GetChildren"></a>GetChildren</h3><p>该方法返回相当于目录的相对路径</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-comment">// Store in *result the names of the children of the specified directory.</span><br>  <span class="hljs-comment">// The names are relative to &quot;dir&quot;.</span><br>  <span class="hljs-comment">// Original contents of *results are dropped.</span><br>  <span class="hljs-function"><span class="hljs-keyword">virtual</span> Status <span class="hljs-title">GetChildren</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; dir,</span></span><br><span class="hljs-params"><span class="hljs-function">                             std::vector&lt;std::string&gt;* result)</span> </span>= <span class="hljs-number">0</span>;<br> <span class="hljs-comment">// 使用场景，若GetChildren实现错误则RemoveObsoleteFiles无法移除无用文件</span><br> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DBImpl::RemoveObsoleteFiles</span><span class="hljs-params">()</span> </span>&#123;<br>  mutex_.<span class="hljs-built_in">AssertHeld</span>();<br><br>  <span class="hljs-keyword">if</span> (!bg_error_.<span class="hljs-built_in">ok</span>()) &#123;<br>    <span class="hljs-comment">// After a background error, we don&#x27;t know whether a new version may</span><br>    <span class="hljs-comment">// or may not have been committed, so we cannot safely garbage collect.</span><br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Make a set of all of the live files</span><br>  std::set&lt;<span class="hljs-type">uint64_t</span>&gt; live = pending_outputs_;<br>  versions_-&gt;<span class="hljs-built_in">AddLiveFiles</span>(&amp;live);<br><br>  std::vector&lt;std::string&gt; filenames;<br>  env_-&gt;<span class="hljs-built_in">GetChildren</span>(dbname_, &amp;filenames);  <span class="hljs-comment">// Ignoring errors on purpose</span><br>  <span class="hljs-type">uint64_t</span> number;<br>  FileType type;<br>  std::vector&lt;std::string&gt; files_to_delete;<br>  <span class="hljs-keyword">for</span> (std::string&amp; filename : filenames) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ParseFileName</span>(filename, &amp;number, &amp;type)) &#123;<br>      <span class="hljs-type">bool</span> keep = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">switch</span> (type) &#123;<br>        <span class="hljs-keyword">case</span> kLogFile:<br>          keep = ((number &gt;= versions_-&gt;<span class="hljs-built_in">LogNumber</span>()) || (number == versions_-&gt;<span class="hljs-built_in">PrevLogNumber</span>()));<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> kDescriptorFile:<br>          <span class="hljs-comment">// Keep my manifest file, and any newer incarnations&#x27;</span><br>          <span class="hljs-comment">// (in case there is a race that allows other incarnations)</span><br>          keep = (number &gt;= versions_-&gt;<span class="hljs-built_in">ManifestFileNumber</span>());<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> kTableFile:<br>          keep = (live.<span class="hljs-built_in">find</span>(number) != live.<span class="hljs-built_in">end</span>());<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> kTempFile:<br>          <span class="hljs-comment">// Any temp files that are currently being written to must</span><br>          <span class="hljs-comment">// be recorded in pending_outputs_, which is inserted into &quot;live&quot;</span><br>          keep = (live.<span class="hljs-built_in">find</span>(number) != live.<span class="hljs-built_in">end</span>());<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> kCurrentFile:<br>        <span class="hljs-keyword">case</span> kDBLockFile:<br>        <span class="hljs-keyword">case</span> kInfoLogFile:<br>          keep = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!keep) &#123;<br>        files_to_delete.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">move</span>(filename));<br>        <span class="hljs-keyword">if</span> (type == kTableFile) &#123;<br>          table_cache_-&gt;<span class="hljs-built_in">Evict</span>(number);<br>        &#125;<br>        <span class="hljs-built_in">Log</span>(options_.info_log, <span class="hljs-string">&quot;Delete type=%d #%lld\n&quot;</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(type), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt;(number));<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// While deleting all files unblock other threads. All files being deleted</span><br>  <span class="hljs-comment">// have unique names which will not collide with newly created files and</span><br>  <span class="hljs-comment">// are therefore safe to delete while allowing other threads to proceed.</span><br>  mutex_.<span class="hljs-built_in">Unlock</span>();<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> std::string&amp; filename : files_to_delete) &#123;<br>    env_-&gt;<span class="hljs-built_in">RemoveFile</span>(dbname_ + <span class="hljs-string">&quot;/&quot;</span> + filename);<br>  &#125;<br>  mutex_.<span class="hljs-built_in">Lock</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>修改leveldb实现后记得make &amp;&amp; make install，保证应用程序使用的库已更新</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/leveldb%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/" class="category-chain-item">leveldb学习日记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/LevelDB-%E8%87%AA%E5%AE%9A%E4%B9%89env/" class="print-no-link">#LevelDB 自定义env</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/blog/femu%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95.html" title="femu使用记录"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">femu使用记录</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/blog/%E3%80%8A%E9%AB%98%E6%80%A7%E8%83%BDMySQL%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html" title="《高性能MySQL》读书笔记"><span class="hidden-mobile">《高性能MySQL》读书笔记</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var e=Object.assign({appId:"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz",appKey:"0e2MMh7ddBCGGytOe9UEy5NP",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://uu0wegco.lc-cn-n1-shared.com",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(e),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var e="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(e),Fluid.plugins.fancyBox(e)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>