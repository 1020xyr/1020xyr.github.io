

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/nano-1.jpg">
  <link rel="icon" href="/img/nano-1.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="最佳损友1020">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言如果你刚接触Linux内核驱动开发，那么这篇博客应该对你有所帮助！祝你好运 推荐阅读：《C和指针》 《C专家编程》 《C陷阱与缺陷》《Linux设备驱动程序》 《linux内核设计与实现》 《深入理解linux内核》 《Linux内核源代码情景分析》 《Debug Hacks中文版—深入调试的技术和工具》第一要义：学会放弃第二要义：不要修改代码屎山第三要义：遇到无法解决的问题&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="内核驱动开发记录">
<meta property="og:url" content="https://www.jiasun.top/blog/%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95.html">
<meta property="og:site_name" content="最佳损友1020’s Blog">
<meta property="og:description" content="前言如果你刚接触Linux内核驱动开发，那么这篇博客应该对你有所帮助！祝你好运 推荐阅读：《C和指针》 《C专家编程》 《C陷阱与缺陷》《Linux设备驱动程序》 《linux内核设计与实现》 《深入理解linux内核》 《Linux内核源代码情景分析》 《Debug Hacks中文版—深入调试的技术和工具》第一要义：学会放弃第二要义：不要修改代码屎山第三要义：遇到无法解决的问题&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202312181630686.webp">
<meta property="article:published_time" content="2023-10-31T15:30:42.823Z">
<meta property="article:modified_time" content="2023-12-18T11:03:21.945Z">
<meta property="article:author" content="最佳损友1020">
<meta property="article:tag" content="块设备驱动 网卡驱动 内核驱动 踩坑">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jiasun-blog.oss-cn-hangzhou.aliyuncs.com/blog/202312181630686.webp">
  
  
  
  <title>内核驱动开发记录 - 最佳损友1020’s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn.css">
<link rel="stylesheet" href="/css/top.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.jiasun.top","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n227FxNJCTncCeI3DrGx7MnC-gzGzoHsz","app_key":"ljkRZDiTtVmjn5mpaQmpFqgv","server_url":"https://n227fxnj.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>最佳损友1020</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.webp') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内核驱动开发记录"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-10-31 23:30" pubdate>
          2023年10月31日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">内核驱动开发记录</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />


<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>如果你刚接触Linux内核驱动开发，那么这篇博客应该对你有所帮助！祝你好运</strong></p>
<p>推荐阅读：<br>《C和指针》 《C专家编程》 《C陷阱与缺陷》<br>《Linux设备驱动程序》 《linux内核设计与实现》 《深入理解linux内核》</p>
<p>《Linux内核源代码情景分析》</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wuzhouhui/misc/blob/master/Debug.Hacks%20%E6%B7%B1%E5%85%A5%E8%B0%83%E8%AF%95%E7%9A%84%E6%8A%80%E6%9C%AF%E5%92%8C%E5%B7%A5%E5%85%B7%20%E4%B8%AD%E6%96%87%E7%89%88.pdf">《Debug Hacks中文版—深入调试的技术和工具》</a><br>第一要义：学会放弃<br>第二要义：不要修改代码屎山<br>第三要义：遇到无法解决的问题&#x2F;bug，备份代码后重构代码<br>第四要义：若bug实在无法解决，尝试不同的实现方式，不过于追求简洁与优雅</p>
<p>相关驱动：<br>块设备驱动，网卡驱动<br>内核版本：5.4&#x2F;4.19</p>
<p>参考驱动代码：</p>
<p>nvme驱动 r8169网卡驱动</p>
<p>驱动开发背景：<br>块设备驱动特点：一次只能发送一条指令，需同时实现协议栈请求与自定义ioctl请求处理<br>网卡驱动特点：驱动移植，将以字符设备实现的网卡驱动移植为以网络设备实现的网卡驱动，将用户态代码移植内核态</p>
<h2 id="一：银河麒麟操作系统-飞腾处理器"><a href="#一：银河麒麟操作系统-飞腾处理器" class="headerlink" title="一：银河麒麟操作系统+飞腾处理器"></a>一：银河麒麟操作系统+飞腾处理器</h2><p>内核切换后显卡驱动失效问题<br>内核切换后网卡驱动失效问题<br>内核切换后glibc冲突问题<br>networking restart失败<br>内核切换后安装常见软件均失败</p>
<p>切换内核时make install显示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Error! Bad <span class="hljs-built_in">return</span> status <span class="hljs-keyword">for</span> module build on kernel:4.19.0(aarch64)<br>Consult /var/lib/dkms/nvidia/460.32.03/build/make.log <span class="hljs-keyword">for</span> more information.<br></code></pre></td></tr></table></figure>
<p>解决：<br>删除	&#x2F;var&#x2F;lib&#x2F;dkms&#x2F;nvidia整个文件夹即可</p>
<p>update-grub时未发现刚install的内核，只有原系统的image<br>解决：编译版本的image未被安装至&#x2F;boot文件夹，复制编译目录&#x2F;arch&#x2F;arm64中image至&#x2F;boot，并按对应格式重命名。不过看&#x2F;boot目录下原系统拥有Image和uImage文件，但arm64目录下只有一个Image，我们直接复制两份，分别改成Image和uImage。</p>
<p>国产操作系统特有的问题带来的麻烦——此处省略一万字</p>
<h2 id="二：用户空间访问问题"><a href="#二：用户空间访问问题" class="headerlink" title="二：用户空间访问问题"></a>二：用户空间访问问题</h2><p>块设备驱动提供ioctl接口供用户直接向特定扇区读写数据，在ioctl系统调用参数中传递用户缓冲区的地址。ioctl内核处理函数中直接将请求打包成相应的命令，加入SSD请求队列等待执行。由于未实现中断功能，利用定时器定时轮询对应位置查看命令执行情况并在设备空闲时发送请求。此时调用copy_from_user函数失败。这是因为定时器回调函数是异步执行的，它类似于一种“软件中断”，而且是处于非进程的上下文中，所以回调函数必须遵守以下规则：</p>
<ol>
<li><p>没有 current 指针、不允许访问用户空间。因为没有进程上下文，相关代码和被中断的进程没有任何联系。</p>
</li>
<li><p>不能执行休眠(或可能引起休眠的函数)和调度。</p>
</li>
<li><p>任何被访问的数据结构都应该针对并发访问进行保护，以防止竞争条件。</p>
</li>
</ol>
<p>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_32411919/article/details/116748367">inux内核timer执行上下文,内核定时器的使用(好几个例子add_timer)</a></p>
<p>  解决：<br>  如果是写命令，在用户空间上下文中将数据拷贝到额外申请的内核缓冲区（kmalloc而不是dma_alloc_coherent)，再将内核缓冲区的地址写入命令。如果是读命令，中断上下文中先将读到的数据拷贝到内核缓冲区，用户上下文中再将数据写入用户缓冲区。<br>  ioctl请求的一般执行过程为：①解析参数 ②申请内核缓冲区存放数据 ③ 将请求封装成命令，加入命令队列 ④等待命令执行完成，并执行必要的数据传输工作。</p>
<h2 id="三：模块卸载出错"><a href="#三：模块卸载出错" class="headerlink" title="三：模块卸载出错"></a>三：模块卸载出错</h2><p>有时候编写代码时并不会检查函数返回值等信息，有时候资源并没有申请成功，而在.remove函数中却照常进行了资源释放，或者申请了资源却忘了在remove函数中进行释放，便会造成空指针 死机等一系列的后果。<br>例如在.probe函数中注册了定时器却忘了注销，注册块设备失败却照常注销块设备，get_device与put_device数目不一致</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">add_timer(&amp;hps_dev-&gt;timer);                         <span class="hljs-comment">//注册定时器</span><br>del_timer(&amp;hps_dev-&gt;timer);                       <span class="hljs-comment">//注销定时器</span><br>device_add_disk(hps_dev-&gt;dev, hps_dev-&gt;disk, hps_attr_groups); <span class="hljs-comment">// 注册块设备</span><br>del_gendisk(hps_dev-&gt;disk);                       <span class="hljs-comment">// 移除块设备</span><br>hps_dev-&gt;dev = get_device(&amp;pdev-&gt;dev);			  <span class="hljs-comment">// 增加设备计数</span><br>put_device(hps_dev-&gt;dev);                         <span class="hljs-comment">// 减小设备计数</span><br></code></pre></td></tr></table></figure>
<p>所以比较安全的方式就是增加出错处理代码或在资源释放时判断是否持有。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = request();<br><span class="hljs-keyword">if</span>(ret!=<span class="hljs-number">0</span>)&#123;<br>	<span class="hljs-comment">// 出错处理</span><br>&#125;<br><br><span class="hljs-keyword">if</span>(hold(p)) release p;<br></code></pre></td></tr></table></figure>

<h2 id="四：DMA缓冲区大小问题"><a href="#四：DMA缓冲区大小问题" class="headerlink" title="四：DMA缓冲区大小问题"></a>四：DMA缓冲区大小问题</h2><p>dma_alloc_coherent函数一次申请超过4M的空间便会报错，配置CMA使DMA能够申请更大的空间，这可能需要需要重新编译内核（如果高版本宿主机编译内核建议先通过deb安装文件切换至相近版本的内核，再通过源码编译内核，跨大版本源码编译过程中有可能会出现一些奇奇怪怪的问题）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">dev-&gt;data_buf = dma_alloc_coherent(dev-&gt;dev, MAX_DATA_SIZE, &amp;dev-&gt;data_buf_dma_addr, GFP_KERNEL);<br></code></pre></td></tr></table></figure>
<p><strong>参考博客：</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28499879/article/details/124043179">dma_alloc_coherent 申请内存用法和问题总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/willhq/article/details/124602370?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166462998816800180631122%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=166462998816800180631122&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-124602370-null-null.nonecase&utm_term=CMA&spm=1018.2226.3001.4450">在Linux内核模块中使用CMA内存分配</a><br><img src="https://img-blog.csdnimg.cn/212319a9dc89409d8b20438cfef1381f.png" srcset="/img/loading.gif" lazyload><br>大致步骤如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /boot/config-$(<span class="hljs-built_in">uname</span> -r) | grep DMA_CMA  <span class="hljs-comment"># 查看当前内核是否开启了CMA功能</span><br>如果不存在则需要重新编译内核，建议配置内核时顺带勾选kgdb选项<br>CONFIG_DMA_CMA选项没在memuconfig找到，可直接通过vim .config修改，也可将其他的CMA选项打开<br>在编译内核是会选择CMA空间大小，后面也可以在grub配置文件中修改相应大小。<br><span class="hljs-built_in">cat</span> /proc/meminfo <span class="hljs-comment"># 查看是否修改成功</span><br>CmaTotal:        1048576 kB<br>CmaFree:         1048576 kB<br>dmesg | grep cma <span class="hljs-comment"># 显示内核启动时cma相关信息</span><br>配置成功后就能申请更大的连续物理内存<br></code></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/35e555f856fc4ec099fe3f4c3a4be3dd.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="五：linux内存页大小问题"><a href="#五：linux内存页大小问题" class="headerlink" title="五：linux内存页大小问题"></a>五：linux内存页大小问题</h2><p>在用户程序中使用mmap系统调用，传入的映射长度为32k，可是内核mmap处理函数中vm_area的长度却显示为64k。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span>* start,<span class="hljs-type">size_t</span> length,<span class="hljs-type">int</span> prot,<span class="hljs-type">int</span> flags,<span class="hljs-type">int</span> fd,<span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span>* start,<span class="hljs-type">size_t</span> length)</span>;<br></code></pre></td></tr></table></figure>
<p><strong>解决：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">getconf PAGE_SIZE <span class="hljs-comment"># 查看当前页大小</span><br>65536<br></code></pre></td></tr></table></figure>
<p>mmap 必须以PAGE_SIZE为单位进行映射，而内存也只能以页为单位进行映射，若要映射非PAGE_SIZE整数倍的地址范围，要先进行内存对齐，强行以PAGE_SIZE的倍数大小进行映射。由于传入长度小于64k，进行了一次向上取整。故重新编译内核，在menuconfig中修改page size。</p>
<h2 id="六：网络不稳定，同属于一个局域网却不能ping通"><a href="#六：网络不稳定，同属于一个局域网却不能ping通" class="headerlink" title="六：网络不稳定，同属于一个局域网却不能ping通"></a>六：网络不稳定，同属于一个局域网却不能ping通</h2><p>通过打印内核启动时的信息可以发现网卡在一直自动协商连接速度，通过ethtool工具关闭自动协商功能即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 将网卡eth2速度固定1000M，双工，且关闭自动协商</span><br>sudo ethtool -s eth2 speed 1000 duplex full autoneg off<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://vqiu.cn/linux-guan-bi-wang-luo-zi-dong-xie-shang-gong-neng/">Linux 关闭链路自动协商功能</a></p>
<h2 id="七：BUG-scheduling-while-atomic"><a href="#七：BUG-scheduling-while-atomic" class="headerlink" title="七：BUG: scheduling while atomic"></a>七：BUG: scheduling while atomic</h2><p>在定时器的回调函数中调用msleep函数，造成BUG: scheduling while atomic错误，输出一长串的警告（dump_stack,backtrace之类的），这是因为定时器回调函数处于原子上下文，不允许系统调度，调用休眠函数后就会引发这个问题。但很奇怪的是，网卡驱动中的start_xmit函数中调用休眠函数也会报这个错误，这个函数也处于原子上下文吗？可以通过preempt_count判断内核当前处于原子上下文还是进程上下文。<br><img src="https://img-blog.csdnimg.cn/fed42e42f9114f01877954cd04dcf6a6.png" srcset="/img/loading.gif" lazyload><br>如果是分配内存，可以将GFP_ KERNEL标志改成 GFP_ATOMIC</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liushuhe1990/p/9621330.html">内存申请 GFP_KERNEL GFP_ATOMIC</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/cfy_phonex/article/details/12090943">BUG: scheduling while atomic 分析</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Anker/p/3269106.html">用户空间与内核空间，进程上下文与中断上下文</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/88883239">Linux中的preempt_count</a></p>
<h2 id="八：设备名混淆错误"><a href="#八：设备名混淆错误" class="headerlink" title="八：设备名混淆错误"></a>八：设备名混淆错误</h2><p>在参照r8169驱动代码编写网卡驱动时，误以为dev变量为struct device类型的通用设备，后面才发现为struct net_device类型，但内核中全用dev来命名，比较容易混淆。最奇怪的是，一个用来解析协议类型的函数竟然顺带对skb的dev赋值，使得这个错误比较难被发现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c">skb-&gt;protocol = eth_type_trans(skb, dev);<br>__be16 <span class="hljs-title function_">eth_type_trans</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb, <span class="hljs-keyword">struct</span> net_device *dev)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _service_access_point;<br>	<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *sap;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ethhdr</span> *<span class="hljs-title">eth</span>;</span><br><br>	skb-&gt;dev = dev;<br>	skb_reset_mac_header(skb);<br><br>	eth = (<span class="hljs-keyword">struct</span> ethhdr *)skb-&gt;data;<br>	skb_pull_inline(skb, ETH_HLEN);<br><br>	<span class="hljs-keyword">if</span> (unlikely(is_multicast_ether_addr_64bits(eth-&gt;h_dest))) &#123;<br>		<span class="hljs-keyword">if</span> (ether_addr_equal_64bits(eth-&gt;h_dest, dev-&gt;broadcast))<br>			skb-&gt;pkt_type = PACKET_BROADCAST;<br>		<span class="hljs-keyword">else</span><br>			skb-&gt;pkt_type = PACKET_MULTICAST;<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely(!ether_addr_equal_64bits(eth-&gt;h_dest,<br>						   dev-&gt;dev_addr)))<br>		skb-&gt;pkt_type = PACKET_OTHERHOST;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Some variants of DSA tagging don&#x27;t have an ethertype field</span><br><span class="hljs-comment">	 * at all, so we check here whether one of those tagging</span><br><span class="hljs-comment">	 * variants has been configured on the receiving interface,</span><br><span class="hljs-comment">	 * and if so, set skb-&gt;protocol without looking at the packet.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(netdev_uses_dsa(dev)))<br>		<span class="hljs-keyword">return</span> htons(ETH_P_XDSA);<br><br>	<span class="hljs-keyword">if</span> (likely(eth_proto_is_802_3(eth-&gt;h_proto)))<br>		<span class="hljs-keyword">return</span> eth-&gt;h_proto;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 *      This is a magic hack to spot IPX packets. Older Novell breaks</span><br><span class="hljs-comment">	 *      the protocol design and runs IPX over 802.3 without an 802.2 LLC</span><br><span class="hljs-comment">	 *      layer. We look for FFFF which isn&#x27;t a used 802.2 SSAP/DSAP. This</span><br><span class="hljs-comment">	 *      won&#x27;t work for fault tolerant netware but does for the rest.</span><br><span class="hljs-comment">	 */</span><br>	sap = skb_header_pointer(skb, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*sap), &amp;_service_access_point);<br>	<span class="hljs-keyword">if</span> (sap &amp;&amp; *sap == <span class="hljs-number">0xFFFF</span>)<br>		<span class="hljs-keyword">return</span> htons(ETH_P_802_3);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 *      Real 802.2 LLC</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">return</span> htons(ETH_P_802_2);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="九：运算符优先级"><a href="#九：运算符优先级" class="headerlink" title="九：运算符优先级"></a>九：运算符优先级</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">int</span> type = <span class="hljs-number">0x80001</span>;<br>  <span class="hljs-keyword">if</span> (type &amp; <span class="hljs-number">0xf</span> == <span class="hljs-number">0x1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 1\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type &amp; <span class="hljs-number">0xf</span> == <span class="hljs-number">0x2</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 2\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 3\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ((type &amp; <span class="hljs-number">0xf</span>) == <span class="hljs-number">0x1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 1\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((type &amp; <span class="hljs-number">0xf</span>) == <span class="hljs-number">0x2</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 2\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;branch 3\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %d\n&quot;</span>, <span class="hljs-number">0xf</span> == <span class="hljs-number">0x1</span>, type &amp; <span class="hljs-number">0xf</span> == <span class="hljs-number">0x1</span>);<br>&#125;<br><span class="hljs-comment">// branch 3</span><br><span class="hljs-comment">// branch 1</span><br><span class="hljs-comment">// 0 0</span><br></code></pre></td></tr></table></figure>
<p>相等运算符优先级高于位运算符，故先执行&#x3D;&#x3D;，得到结果0，再与type进行与。<br><img src="https://img-blog.csdnimg.cn/cfe293f755fe4d40b10dcd7d7ca065f1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="十：网卡驱动提供修改MTU接口"><a href="#十：网卡驱动提供修改MTU接口" class="headerlink" title="十：网卡驱动提供修改MTU接口"></a>十：网卡驱动提供修改MTU接口</h2><p>提供简单Set方法，并在探测函数中设置min_mtu max_mtu mtu值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 示例代码 r8169.c</span><br>.ndo_change_mtu		= rtl8169_change_mtu,<br><span class="hljs-number">5855</span>  <span class="hljs-type">static</span> <span class="hljs-type">int</span> rtl8169_change_mtu(<span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-type">int</span> new_mtu)<br><span class="hljs-number">5856</span>  &#123;<br><span class="hljs-number">5864</span>  	dev-&gt;mtu = new_mtu;<br><span class="hljs-number">5867</span>  	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">5868</span>  &#125;<br><br><span class="hljs-number">7626</span>  	<span class="hljs-comment">/* MTU range: 60 - hw-specific max */</span><br><span class="hljs-number">7627</span>  	dev-&gt;min_mtu = ETH_ZLEN;<br><span class="hljs-number">7629</span>  	dev-&gt;max_mtu = jumbo_max;<br></code></pre></td></tr></table></figure>
<h2 id="十一：收包与napi"><a href="#十一：收包与napi" class="headerlink" title="十一：收包与napi"></a>十一：收包与napi</h2><p>由于网卡对于收包速度要求较高，且并没有实现中断功能，故只能通过轮询的方式收包。<br>有两种方式实现该功能：<br>1 使用kthread_run另开一个线程，持续查询是否有数据包到来<br>2 使用napi机制<br>在刚开始的时候我错误理解了napi poll的时机，采用的是定时器+napi的方式，每次在定时器过期时调用napi_schedule_irqoff函数，启动轮询，而在每次轮询中调用napi_complete函数并返回1。但问题是定时器中断频率太低，远远达不到性能需求。后面看了看napi相关文章才发现，只要轮询函数中每次返回的值为当前权值&#x2F;额度，内核就会认为网卡还有消息包需要处理，会将该任务重新加入轮询队列，故没必要使用定时器,也没必要在轮询函数中调用napi_complete函数。<br>复制粘贴一些napi相关函数注释加深印象（源码在线查询网站：<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source">bootlin</a>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * netif_napi_add() - initialize a NAPI context</span><br><span class="hljs-comment"> * @dev:  network device</span><br><span class="hljs-comment"> * @napi: NAPI context</span><br><span class="hljs-comment"> * @poll: polling function</span><br><span class="hljs-comment"> * @weight: default weight</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * netif_napi_add() must be used to initialize a NAPI context prior to calling</span><br><span class="hljs-comment"> * *any* of the other NAPI-related functions.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">netif_napi_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-keyword">struct</span> napi_struct *napi,</span><br><span class="hljs-params">	       <span class="hljs-type">int</span> (*poll)(<span class="hljs-keyword">struct</span> napi_struct *, <span class="hljs-type">int</span>), <span class="hljs-type">int</span> weight)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	napi_enable - enable NAPI scheduling</span><br><span class="hljs-comment"> *	@n: NAPI context</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Resume NAPI from being scheduled on this context.</span><br><span class="hljs-comment"> * Must be paired with napi_disable.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">napi_enable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *n)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	napi_schedule - schedule NAPI poll</span><br><span class="hljs-comment"> *	@n: NAPI context</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Schedule NAPI poll routine to be called if it is not already</span><br><span class="hljs-comment"> * running.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">napi_schedule</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *n)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (napi_schedule_prep(n))<br>		__napi_schedule(n);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	napi_schedule_irqoff - schedule NAPI poll</span><br><span class="hljs-comment"> *	@n: NAPI context</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Variant of napi_schedule(), assuming hard irqs are masked.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">napi_schedule_irqoff</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *n)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (napi_schedule_prep(n))<br>		__napi_schedule_irqoff(n);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	napi_schedule_prep - check if napi can be scheduled</span><br><span class="hljs-comment"> *	@n: napi context</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Test if NAPI routine is already running, and if not mark</span><br><span class="hljs-comment"> * it as running.  This is used as a condition variable to</span><br><span class="hljs-comment"> * insure only one NAPI poll instance runs.  We also make</span><br><span class="hljs-comment"> * sure there is no pending NAPI disable.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">napi_schedule_prep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *n)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	napi_complete - NAPI processing complete</span><br><span class="hljs-comment"> *	@n: NAPI context</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Mark NAPI processing as complete.</span><br><span class="hljs-comment"> * Consider using napi_complete_done() instead.</span><br><span class="hljs-comment"> * Return false if device should avoid rearming interrupts.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">napi_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *n)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> napi_complete_done(n, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> sk_buff *<span class="hljs-title function_">napi_alloc_skb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *napi,</span><br><span class="hljs-params">					     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __napi_alloc_skb(napi, length, GFP_ATOMIC);<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	__napi_alloc_skb - allocate skbuff for rx in a specific NAPI instance</span><br><span class="hljs-comment"> *	@napi: napi instance this buffer was allocated for</span><br><span class="hljs-comment"> *	@len: length to allocate</span><br><span class="hljs-comment"> *	@gfp_mask: get_free_pages mask, passed to alloc_skb and alloc_pages</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	Allocate a new sk_buff for use in NAPI receive.  This buffer will</span><br><span class="hljs-comment"> *	attempt to allocate the head from a special reserved region used</span><br><span class="hljs-comment"> *	only for NAPI Rx allocation.  By doing this we can save several</span><br><span class="hljs-comment"> *	CPU cycles by avoiding having to disable and re-enable IRQs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	%NULL is returned if there is no free memory.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *__<span class="hljs-title">napi_alloc_skb</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">napi_struct</span> *<span class="hljs-title">napi</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">len</span>,</span><br><span class="hljs-class">				 <span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>)</span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-title">int</span> <span class="hljs-title">netif_rx</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *<span class="hljs-title">skb</span>);</span><br><span class="hljs-type">int</span> __netif_rx(<span class="hljs-keyword">struct</span> sk_buff *skb);<br><span class="hljs-type">int</span> <span class="hljs-title function_">netif_receive_skb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">netif_receive_skb_core</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">netif_receive_skb_list_internal</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *head)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">netif_receive_skb_list</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *head)</span>;<br><span class="hljs-type">gro_result_t</span> <span class="hljs-title function_">napi_gro_receive</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *napi, <span class="hljs-keyword">struct</span> sk_buff *skb)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	netif_rx	-	post buffer to the network code</span><br><span class="hljs-comment"> *	@skb: buffer to post</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	This function receives a packet from a device driver and queues it for</span><br><span class="hljs-comment"> *	the upper (protocol) levels to process via the backlog NAPI device. It</span><br><span class="hljs-comment"> *	always succeeds. The buffer may be dropped during processing for</span><br><span class="hljs-comment"> *	congestion control or by the protocol layers.</span><br><span class="hljs-comment"> *	The network buffer is passed via the backlog NAPI device. Modern NIC</span><br><span class="hljs-comment"> *	driver should use NAPI and GRO.</span><br><span class="hljs-comment"> *	This function can used from interrupt and from process context. The</span><br><span class="hljs-comment"> *	caller from process context must not disable interrupts before invoking</span><br><span class="hljs-comment"> *	this function.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	return values:</span><br><span class="hljs-comment"> *	NET_RX_SUCCESS	(no congestion)</span><br><span class="hljs-comment"> *	NET_RX_DROP     (packet was dropped)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">netif_rx</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	netif_receive_skb - process receive buffer from network</span><br><span class="hljs-comment"> *	@skb: buffer to process</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	netif_receive_skb() is the main receive data processing function.</span><br><span class="hljs-comment"> *	It always succeeds. The buffer may be dropped during processing</span><br><span class="hljs-comment"> *	for congestion control or by the protocol layers.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	This function may only be called from softirq context and interrupts</span><br><span class="hljs-comment"> *	should be enabled.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	Return values (usually ignored):</span><br><span class="hljs-comment"> *	NET_RX_SUCCESS: no congestion</span><br><span class="hljs-comment"> *	NET_RX_DROP: packet was dropped</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">netif_receive_skb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span><br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *	netif_receive_skb_core - special purpose version of netif_receive_skb</span><br><span class="hljs-comment"> *	@skb: buffer to process</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	More direct receive version of netif_receive_skb().  It should</span><br><span class="hljs-comment"> *	only be used by callers that have a need to skip RPS and Generic XDP.</span><br><span class="hljs-comment"> *	Caller must also take care of handling if ``(page_is_)pfmemalloc``.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	This function may only be called from softirq context and interrupts</span><br><span class="hljs-comment"> *	should be enabled.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *	Return values (usually ignored):</span><br><span class="hljs-comment"> *	NET_RX_SUCCESS: no congestion</span><br><span class="hljs-comment"> *	NET_RX_DROP: packet was dropped</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">netif_receive_skb_core</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sk_buff *skb)</span><br><br><span class="hljs-type">gro_result_t</span> <span class="hljs-title function_">napi_gro_receive</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> napi_struct *napi, <span class="hljs-keyword">struct</span> sk_buff *skb)</span><br>&#123;<br>	<span class="hljs-type">gro_result_t</span> ret;<br><br>	skb_mark_napi_id(skb, napi);<br>	trace_napi_gro_receive_entry(skb);<br><br>	skb_gro_reset_offset(skb, <span class="hljs-number">0</span>);<br><br>	ret = napi_skb_finish(napi, skb, dev_gro_receive(napi, skb));<br>	trace_napi_gro_receive_exit(ret);<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>相关博客：</strong><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7d4e36c0abe8">NAPI机制</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zgy666/article/details/106952430">Linux NAPI机制分析</a></p>
<h2 id="十二：mac设置问题"><a href="#十二：mac设置问题" class="headerlink" title="十二：mac设置问题"></a>十二：mac设置问题</h2><p>在编写网卡驱动代码时，并没有仔细设置mac地址的值，在完成网卡驱动大致功能时，发现只能通过UDP进行通信（禁用arp时），而无法使用TCP进行通信。使用tcpdump -i 指定网卡 追踪网卡数据包时发现client向server发起第一次握手，但server迟迟没有回应，client一次次重复发送SYN数据包，最终TCP连接失败，同时也能看见一些ARP数据包显示oui unknown。使用arp -a显示当前ip与mac地址映射，发现对应IP地址的mac地址显示incomplete </p>
<p>问题原因：有时候设备随机设置的mac不是单播地址，mac地址无效。需设置成有效的mac地址（复制现有网卡mac地址前24位，后24位随便打即可）<br><img src="https://img-blog.csdnimg.cn/7d4a5a44feb34590ad735dfeb87c4790.png" srcset="/img/loading.gif" lazyload><br>组织唯一标识符（OUI）由IEEE（电气和电子工程师协会）分配给厂商，它包含24位。厂商再用剩下的24位（EUI，扩展唯一标识符）为其生产的每个网卡分配一个全球唯一的全局管理地址，一般来说大厂商都会购买多个OUI。</p>
<p>I&#x2F;G（Individual&#x2F;Group）位，如果I&#x2F;G&#x3D;0，则是某台设备的MAC地址，即单播地址；如果I&#x2F;G&#x3D;1，则是多播地址（组播+广播&#x3D;多播）。</p>
<p>G&#x2F;L（Global&#x2F;Local，也称为U&#x2F;L位，其中U表示Universal）位，如果G&#x2F;L&#x3D;0，则是全局管理地址，由IEEE分配；如果G&#x2F;L&#x3D;1，则是本地管理地址，是网络管理员为了加强自己对网络管理而指定的地址。<br><strong>参考博客：</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31146399/article/details/122075416">arp详细讲解</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lsgxeva/p/13932262.html">MAC地址格式详解</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/songwenlong/p/6103406.html">TCP&#x2F;IP协议——ARP详解</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shuai7boy/p/11387990.html">linux中ifconfig 命令详解详解</a><br><strong>内核相关函数：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * is_valid_ether_addr - Determine if the given Ethernet address is valid</span><br><span class="hljs-comment"> * @addr: Pointer to a six-byte array containing the Ethernet address</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Check that the Ethernet address (MAC) is not 00:00:00:00:00:00, is not</span><br><span class="hljs-comment"> * a multicast address, and is not FF:FF:FF:FF:FF:FF.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return true if the address is valid.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Please note: addr must be aligned to u16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">is_valid_ether_addr</span><span class="hljs-params">(<span class="hljs-type">const</span> u8 *addr)</span><br>&#123;<br>	<span class="hljs-comment">/* FF:FF:FF:FF:FF:FF is a multicast address so we don&#x27;t need to</span><br><span class="hljs-comment">	 * explicitly check for it here. */</span><br>	<span class="hljs-keyword">return</span> !is_multicast_ether_addr(addr) &amp;&amp; !is_zero_ether_addr(addr);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * eth_random_addr - Generate software assigned random Ethernet address</span><br><span class="hljs-comment"> * @addr: Pointer to a six-byte array containing the Ethernet address</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Generate a random Ethernet address (MAC) that is not multicast</span><br><span class="hljs-comment"> * and has the local assigned bit set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">eth_random_addr</span><span class="hljs-params">(u8 *addr)</span><br>&#123;<br>	get_random_bytes(addr, ETH_ALEN);<br>	addr[<span class="hljs-number">0</span>] &amp;= <span class="hljs-number">0xfe</span>;	<span class="hljs-comment">/* clear multicast bit */</span><br>	addr[<span class="hljs-number">0</span>] |= <span class="hljs-number">0x02</span>;	<span class="hljs-comment">/* set local assignment bit (IEEE802) */</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="十三：BAR基址寄存器与总线地址"><a href="#十三：BAR基址寄存器与总线地址" class="headerlink" title="十三：BAR基址寄存器与总线地址"></a>十三：BAR基址寄存器与总线地址</h2><p>摘录：<br><strong>物理地址与总线地址</strong></p>
<ol>
<li>物理地址是与CPU相关的。在CPU的地址信号线上产生的就是物理地址。在程序指令中的虚拟地址经过段映射和页面映射后，就生成了物理地址，这个物理地址被放到CPU的地址线上。 （从CPU端看）</li>
<li>总线地址，顾名思义，是与总线相关的，就是总线的地址线或在地址周期上产生的信号。 外设使用的是总线地址。（从设备端看）</li>
<li>物理地址与总线地址之间的关系由系统的设计决定的。在x86平台上，物理地址与PCI总线地址是相同的。 在其他平台上，也许会有某种转换，通常是线性的转换。</li>
</ol>
<p>对于处理器来说，虚拟地址 逻辑地址都是一个输入源，处理器对这些地址进行转换（比如利用MMU），转换为物理地址，真正处理器发出的地址是物理地址。</p>
<p>假如某个PCI设备具有DMA能力，要去操作RAM，这时该设备看到的RAM的地址就应该是由系统总线映射到PCI总线上的总线地址。<br>映射关系由PCI控制器地址窗口来配置，一般是一个偏移量，所以这时映射到PCI总线上的RAM的总线地址就不是RAM在处理器系统地址空间上的物理地址（也可以称为系统总线地址）了。<br>因此总线地址  ！&#x3D;  物理地址。<br>当然PCI控制器地址窗口可以配置为平映射，这时总线地址就跟物理地址相同了。</p>
<p>TLP能根据地址被路由到对应设备的BAR空间中去。比如说现在有一个mem read request，如果路由地址（地址信息包含在TLP中）是0x71000000，而有一个设备func0的mem空间范围是0x70000000~0x80000000，那么这个TLP就会被这个func处理。从func0的0x71000000对应的地址读取相应数据。这就是TLP中的地址字段和BAR空间的地址之间的关系<br>TLP中的地址哪里来？ATU(Address Translation Unit)转换过来的。这个问题就是这么的简单。ATU是什么？是一个地址转换单元，负责将一段存储器域的地址转换到PCIe总线域地址，除了地址转换外，还能提供访问类型等信息，这些信息都是ATU根据总线上的信号自己做的，数据都打包到TLP中，不用软件参与。软件需要做的是配置ATU，所以如果ATU配置完成，并且能正常工作，那么CPU访问PCIe空间就和访问本地存储器空间方法是一样的，只要读写即可。</p>
<p> <strong>BAR寄存器数据的初始化</strong><br>   BAR寄存器的数据是怎么初始化，由谁进行初始化的？因为初始化的数据是PCIE设备所在的总线域的地址空间，所以肯定不会是EP自己进行初始化，因为如果这样EP是不知道其他PCIE设备对应的总线地址空间的，所以可能会引起总线地址空间的冲突，所以BAR寄存器的初始化是由内核进行初始化的，在系统开机时，内核会遍历查找各个PCIE设备，然后为PCIE设备分配对应的总线地址空间。<br><strong>BAR寄存器存储的总线地址和应用程序内存地址的关系</strong><br>   BAR寄存器存储的总线地址，应用程序是不能直接利用的，应用程序首先要做的就是读出BAR寄存器的值，然后用mmap函数建立应用程序内存空间和总线地址空间的映射关系。这样应用程序往PCIE设备内存读写数据的时候，直接利用PCIE设备映射到应用程序中的内存地址即可。但是应用程序的内存地址该由谁解析到PCIE设备对应的总线空间给EP呢，这个工作是由北桥或者是RC(root complex)来完成的，解析到总线地址空间之后，EP会把总线的地址空间解析成PCIE设备对应的设备内存地址。<br>   <img src="https://img-blog.csdnimg.cn/af2a3e79b4534f7e8b86e227ffe5a796.png" srcset="/img/loading.gif" lazyload><br>RC访问EP演示样例（黑色箭头）：<br>（1）首先，RC端需要配置outbound(一般内核中配好)，EP端须要inbound(0x5b000000 inbound到BAR2)，这样就建立了RC端0x20100000（BAR2）到EP端0x5b000000的映射<br>（2）在EP端改动0x5b000000内存的内容，在RC端0x20100000能够看到对应的变化，从RC端读&#x2F;写0x20100000和从EP端读&#x2F;写0x5b000000，结果是一样的</p>
<p>对于EP，inbound一般是将BAR空间的总线地址与存储器域相应地址区间映射起来，outbound一般是访问主机内存地址。以linux 为RC+块设备为EP举例，在上电时linux内核会为块设备的各个BAR空间分配总线地址，块设备驱动的探测函数将总线地址与主机虚拟地址映射起来，EP自动将总线地址与存储器域相应分配的地址区间映射起来（配置inbound寄存器）。当主机想要读&#x2F;写块设备数据时，将申请一块DMA缓冲区，并将缓冲区物理地址传递给块设备，这个物理地址就是PCI域的总线地址。以写操作为例，块设备若想读取主机内存中DMA缓冲区的数据，需进行一次映射，将相应的存储器域地址区间与DMA缓冲区物理地址进行一次映射（注意这两端地址区间不相同）。一般来说有两个相关的寄存器进行这样的偏移&#x2F;映射（inbound寄存器与outbound寄存器），不搞固件 逻辑什么的，不太了解细节。</p>
<p>Generally speaking, if your card has SoC, the FW on the SoC will configure the iATU mapping with BAR match mode. And don’t let host side driver to configure it.<br><strong>参考博客：</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zyboy2000/article/details/52003160">物理地址和总线地址区别</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/renlonggg/article/details/82684407">什么是物理地址、虚拟地址、总线地址</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35399548/article/details/123275918">PCI设备配置空间、BAR空间、BUS总线的理解整理</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/abcamus/article/details/74157026">PCIe实践之路：BAR空间和TLP</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/kunkliu/article/details/108751452?utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-2.no_search_link">PCIE BAR空间</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/erhu-67786482/p/14034807.html">pcie inbound和outbound关系</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alex_mianmian/article/details/120240748">PCI&#x2F;PCIe iATU</a></p>
<h2 id="十四-诡异的问题-【未解决】"><a href="#十四-诡异的问题-【未解决】" class="headerlink" title="十四 诡异的问题 【未解决】"></a>十四 诡异的问题 【未解决】</h2><p>在实现网卡驱动的数据收发功能时，使用start_xmit  napi poll函数完成协议栈数据的收发，使用ioctl完成用户自定义数据收发。二者使用不同的消息通道，但大致功能一样，故将两个功能集成在一个函数中，使用参数type区分协议栈与用户自定义数据。<br>大致代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROCOTOL_TYPE 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOCTL_TYPE 1</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">send_recv_api</span><span class="hljs-params">(xxx,<span class="hljs-type">int</span> type)</span>&#123;<br>	<span class="hljs-keyword">if</span>(type==PROCOTOL_TYPE)&#123;<br>		<span class="hljs-comment">// 处理数据</span><br>		hardware_api(data，type1)	<br>	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type==IOCTL_TYPE)&#123;<br>		<span class="hljs-comment">// 处理数据</span><br>		hardware_api(data，type2)	<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后网卡驱动加载，在未开启arp时，程序运行正常，实际上此时协议栈也未对数据进行处理与回复，两台主机加载驱动模块，不能相互ping通，主机并不会响应另一台主机的ARP request。而后将两个网卡的ARP功能打开，再次ping，接收ARP request的主机便当场死机。<br>由于暂时未调用用户自定义数据收发，故type一定为PROCOTOL_TYPE，故在函数前面加上判断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROCOTOL_TYPE 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IOCTL_TYPE 1</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">send_recv_api</span><span class="hljs-params">(xxx,<span class="hljs-type">int</span> type)</span>&#123;<br>	<span class="hljs-keyword">if</span>(type!=PROCOTOL_TYPE)&#123;<br>		<span class="hljs-comment">// 打印错误信息</span><br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(type==PROCOTOL_TYPE)&#123;<br>		<span class="hljs-comment">// 处理数据</span><br>		hardware_api(data，type1)	<br>	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type==IOCTL_TYPE)&#123;<br>		<span class="hljs-comment">// 处理数据</span><br>		hardware_api(data，type2)	<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>而后程序就能正常进行通信了，但问题在于错误信息并没有被打印，也就是说并没有进入这个分支<br>故将return语句注释掉，然后程序又崩溃了，而且崩溃时并未打印相关信息。<br>控制变量几次都是一样的效果，这就非常令人迷惑。不考虑问题的原因，单看问题的表象。<br><strong>既然return语句有用，证明进入了该分支，那就应该有相应的打印语句<br>既然没有打印相关信息，证明就没进入过该分支</strong><br>然后我怀疑打印函数是不是有问题，故在if语句前后打印信息，都打印成功。<br>由于函数基本逻辑比较简单，一般的想法便是程序哪块有点细节上的问题，例如赋值运算符与相等运算符，逗号运算符，运算符优先级等，但一直没找到程序的问题在哪里，而且越找类似的悖论就越多。<br><strong>为什么进入这个分支却不打印信息呢？</strong> kgdb看崩溃时的输出也没看到进入其他分支的打印信息<br>搞了很久都没有解决这个问题，终于决定放弃了。最后想不如写成两个函数算了，没用几分钟就写完了。蚌</p>
<h2 id="十五：利用信号量实现同步-互斥"><a href="#十五：利用信号量实现同步-互斥" class="headerlink" title="十五：利用信号量实现同步&#x2F;互斥"></a>十五：利用信号量实现同步&#x2F;互斥</h2><p>场景：块设备一次只能处理一条命令，待一个请求执行完成后才能执行下一个请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">请求开始<br>执行必要的数据传输（写类型命令）<br>发送请求至块设备进行处理<br>等待设备返回请求执行结果<br>执行必要的数据传输（读类型命令）<br>请求完成<br></code></pre></td></tr></table></figure>
<p>协议栈请求可直接使用blk_mq_start_request函数开始请求，blk_mq_end_request函数结束请求，对于ioctl用户自定义请求，我刚开始的实现方式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">代表用户进程执行的内核ioctl处理函数（进程上下文）：<br>	解析用户请求<br>	申请内核缓冲区<br>	将请求数据从用户空间拷贝至内核缓冲区（写类型请求）<br>	发送请求至请求通道：<br>		当前请求通道空闲：<br>			将请求数据从内核缓冲区拷贝至DMA缓冲区（写类型请求）<br>			发送给块设备执行请求<br>		当前请求通道忙碌：压入内核FIFO队列<br>	每隔一段时间查看当前请求是否完成<br>	将请求数据从内核缓冲区拷贝至用户空间（读类型请求）<br>	请求完成<br>定时器轮询函数（中断上下文）：<br>	定时接收块设备的请求执行结果<br>	若请求执行完成：<br>		将请求数据从DMA缓冲区拷贝至内核缓冲区（读类型请求）<br>		标识请求已经完成<br>		若FIFO队列存在请求，发送下一请求给块设备<br></code></pre></td></tr></table></figure>
<p>申请内核缓冲区，并进行额外数据拷贝的原因是：请求并不是一开始就执行，它有可能被压入FIFO队列，在定时器轮询函数（中断上下文）执行请求，而在中断上下文又无法访问用户空间（参见 <strong>二：用户空间访问问题</strong>）。虽然以上的实现方式可以基本实现预期功能，但额外的数据拷贝，内核缓冲区，FIFO队列总是显得笨拙。在重新审视代码设计后发现，<strong>这个场景不就是同步与互斥吗</strong>？故修改代码，使用信号量完成预期功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">同步信号量：sync （初值为<span class="hljs-number">0</span>）  等待请求执行完成<br>互斥信号量：mutex （初值为<span class="hljs-number">1</span>） 请求通道同一时间只能由一个进程访问<br>代表用户进程执行的内核ioctl处理函数（进程上下文）：<br>	down_interruptible(&amp;mutex)<br>	解析用户请求<br>	将请求数据从用户空间拷贝至DMA缓冲区（写类型请求）<br>	发送请求至块设备：<br>	down_interruptible(&amp;sync)<br>	将请求数据从DMA缓冲区拷贝至用户空间（读类型请求）<br>	请求完成<br>	up(&amp;mutex)<br>定时器轮询函数（中断上下文）：<br>	定时接收块设备的请求执行结果<br>	若请求执行完成：<br>		up(&amp;sync)<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 信号量</span><br><span class="hljs-comment">// jiffies指超时时间</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> __must_check <span class="hljs-title function_">down_timeout</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> semaphore *sem, <span class="hljs-type">long</span> jiffies)</span>;<br><br><span class="hljs-type">int</span> __init <span class="hljs-title function_">down_timeout_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">long</span> iffies = <span class="hljs-number">1000</span>;                    <span class="hljs-comment">//1000个时钟节拍，即是4s</span><br>    sema_init( &amp;sema, <span class="hljs-number">5</span> );                 <span class="hljs-comment">//信号量初始化，count = 5</span><br><br>    <span class="hljs-comment">/* 输出初始化后信号量的信息 */</span><br>    printk(<span class="hljs-string">&quot;after sema_init, sema.count: %d\n&quot;</span>, sema.count);<br>    ret = down_timeout( &amp;sema, iffies); <span class="hljs-comment">//获取信号量</span><br><br>    <span class="hljs-comment">/* 输出down_timeout操作后信号量的信息 */</span><br>    printk(<span class="hljs-string">&quot;first down_timeout, ret = %d\n&quot;</span>, ret);<br>    printk(<span class="hljs-string">&quot;first down_timeout, sema.count: %d\n&quot;</span>, sema.count);<br><br>    sema_init( &amp;sema, <span class="hljs-number">0</span> );                <span class="hljs-comment">//信号量初始化，count = 0</span><br>    ret = down_timeout( &amp;sema, iffies);<br><br>    printk(<span class="hljs-string">&quot;second down_timeout, ret = %d\n&quot;</span>, ret);<br>    printk(<span class="hljs-string">&quot;second down_timeout, sema.count: %d\n&quot;</span>, sema.count);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 定时器</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_list</span> &#123;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * All fields that change during normal runtime grouped to the</span><br><span class="hljs-comment">	 * same cacheline</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_node</span>	<span class="hljs-title">entry</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		expires;  <span class="hljs-comment">// 过期时间</span><br>	<span class="hljs-type">void</span>			(*function)(<span class="hljs-keyword">struct</span> timer_list *);<br>	u32			flags;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_LOCKDEP</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lockdep_map</span>	<span class="hljs-title">lockdep_map</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/time.h&gt;</span></span><br> <br><span class="hljs-comment">/* 定义一个定时器指针 */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_list</span> <span class="hljs-title">timer</span> =</span> <span class="hljs-literal">NULL</span>;<br> <br><span class="hljs-comment">/* 参数是timer中的变量data */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">function_handle</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data)</span>&#123;<br>    <span class="hljs-comment">/* 做你想做的事 */</span><br>    ......<br> <br>    <span class="hljs-comment">/* 因为内核定时器是一个单次的定时器,所以如果想要多次重复定时需要在定时器绑定的函数结尾重新装载时间,并启动定时 */</span><br>    <span class="hljs-comment">/* Kernel Timer restart */</span><br>    mod_timer(&amp;timer, jiffies + HZ);<br>&#125;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">xxxx_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>    <span class="hljs-comment">/* 具体任务的注册等 */</span><br>    ......<br><br>    init_timer(&amp;timer);                  <span class="hljs-comment">/* 初始化定时器 */</span> <br>    timer.function = function_handle;    <span class="hljs-comment">/* 绑定定时时间到后的执行函数 */</span><br>    timer.expires = jiffies + HZ;        <span class="hljs-comment">/* 定时的时间点，HZ是jiffies时钟的周期，当前时间的1s之后 */</span><br>    timer.data = <span class="hljs-number">0</span>;                      <span class="hljs-comment">/* function_handle的参数*/</span><br>    add_timer(&amp;timer);                   <span class="hljs-comment">/* 添加并启动定时器 */</span><br>&#125;<br> <br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">xxxx_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>    <span class="hljs-comment">/* 具体任务的卸载等 */</span><br>    ......<br>    <br>    <span class="hljs-comment">/* 删除定时器 */</span><br>    del_timer(&amp;timer);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>两者时间的使用方式不同</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361018645">Linux内核定时器</a><br><a target="_blank" rel="noopener" href="https://deepinout.com/linux-kernel-api/linux-kernel-api-synchronization-mechanism/linux-kernel-api-down_timeout.html">Linux内核API down_timeout</a><br><a target="_blank" rel="noopener" href="https://www.51cto.com/article/630938.html">聊聊Linux内核信号量</a><br><a target="_blank" rel="noopener" href="https://deepinout.com/linux-kernel-api">Linux内核API</a></p>
<h2 id="十六：内核线程"><a href="#十六：内核线程" class="headerlink" title="十六：内核线程"></a>十六：内核线程</h2><p>承接第七点，使用内核线程进行轮询<br>打印相关信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">dbg(<span class="hljs-string">&quot;poll task:%d  irq:%d  atomic:%d&quot;</span>,in_task(),in_interrupt(),in_atomic());<br><span class="hljs-comment">// poll task:1  irq:0  atomic:0</span><br></code></pre></td></tr></table></figure>
<p>可以看出创建的内核线程处于进程上下文，不属于中断上下文，也不属于原子上下文，可以放心使用休眠函数，每执行一次轮询都可以调用msleep进行一次休眠。<br>在卸载驱动时，一直卡在rmmod操作处，发现忘了在remove函数中stop内核线程，但即使stop了内核线程，也还是卡在卸载驱动处。<br>阅读<a target="_blank" rel="noopener" href="https://blog.csdn.net/wangkai6666/article/details/121724586">kthread_stop问题探讨</a>才知道要在内核线程的while循环中调用kthread_should_stop()函数，查询是否应该退出线程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">demo_thread1</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span> &#123;<br>	pr_info(<span class="hljs-string">&quot;%s ===&gt;\n&quot;</span>, __func__);<br>	<span class="hljs-keyword">while</span>(!kthread_should_stop()) &#123;<br>		pr_info(<span class="hljs-string">&quot;%s, I am alive\n&quot;</span>, __func__);<br>	&#125;<br>	pr_info(<span class="hljs-string">&quot;%s &lt;===\n&quot;</span>, __func__);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">23</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="十七：竞争"><a href="#十七：竞争" class="headerlink" title="十七：竞争"></a>十七：竞争</h2><p>在编写简单的块设备驱动时，使用轮询而不是中断的方式接收返回结果。在发送SQ后，定时轮询特定的BAR空间位置，获取对应的CQ。如何判断收到CQ呢？每次收到CQ后将该位置清零，若下次发现相应位置的数据的命令ID位恰好为期望的命令ID，则表示收到CQ。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">data = readl(addr);<br>cid = data &amp; CID_MASK &gt;&gt; CID_OFFSET<br><span class="hljs-keyword">if</span>(cid==expect_cid)&#123;<br>	接收处理<br>&#125;<br></code></pre></td></tr></table></figure>
<p>以上的处理流程似乎没有啥问题，但CQ由多个32位数组成，cid所属32位数写入成功并不代表所有的CQ都写入完成。故程序运行几十分钟会出现一次异常情况：其他32位数为0（即还没有写入，32位是写入数据的基本单位）。<br>可选的解决方案有：</p>
<ol>
<li>使用中断告知数据已到达</li>
<li>对所有32位数都进行非零判断（需保证数据永远不为0）</li>
<li>增加一个标志位，在全部数据写入成功后设置该标志位</li>
</ol>
<h2 id="十八：调试相关"><a href="#十八：调试相关" class="headerlink" title="十八：调试相关"></a>十八：调试相关</h2><p>一：通过编译输出找出可能的问题(make gcc相关）<br>利用gcc 警告选项组合与标准错误重定向分析代码问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#示例</span><br>EXTRA_CFLAGS :=  -g  -Wint-to-pointer-cast  -Wno-unused-parameter -Wno-sign-compare -Wno-unused-function  -Wno-format-extra-args -Wall-w <br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bandaoyu/article/details/115419255">【GCC】gcc警告选项汇总–编辑中|gcc编译选项</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make xxx 2&gt; build_output.txt<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jamesf/p/4751517.html">将Linux 标准输出，错误输出重定向到文件</a></p>
<p>make -n：仅输出指令调用，但不执行，便于观察Makefile的修改是否生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">- Call the first target specified <span class="hljs-keyword">in</span> the Makefile (usually named <span class="hljs-string">&quot;all&quot;</span>):<br>  make<br><br>- Call a specific target:<br>  make &#123;&#123;target&#125;&#125;<br><br>- Call a specific target, executing 4 <span class="hljs-built_in">jobs</span> at a time <span class="hljs-keyword">in</span> parallel:<br>  make -j&#123;&#123;4&#125;&#125; &#123;&#123;target&#125;&#125;<br><br>- Use a specific Makefile:<br>  make --file &#123;&#123;file&#125;&#125;<br><br>- Execute make from another directory:<br>  make --directory &#123;&#123;directory&#125;&#125;<br><br>- Force making of a target, even <span class="hljs-keyword">if</span> <span class="hljs-built_in">source</span> files are unchanged:<br>  make --always-make &#123;&#123;target&#125;&#125;<br><br>- Override variables defined <span class="hljs-keyword">in</span> the Makefile by the environment:<br>  make --environment-overrides &#123;&#123;target&#125;&#125;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/81196596#:~:text=%E8%BF%99%E6%98%AF%20make%20%E5%B7%A5%E5%85%B7%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%8C%E4%B8%8B%E9%9D%A2%E7%9C%8B%E7%9C%8B%E5%B8%B8%E7%94%A8%E7%9A%84%E9%80%89%E9%A1%B9%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9A%20-b%20%E6%88%96%20-m,%E5%BF%BD%E7%95%A5%E5%85%B6%E4%BB%96%E7%89%88%E6%9C%AC%20make%20%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7%E3%80%82,%E6%88%96%20%E2%80%93-always-make%20%EF%BC%8C%E9%87%8D%E7%BC%96%E8%AF%91%E3%80%82%20-C%20%E6%88%96%20--directory=,%E6%8C%87%E5%AE%9A%E8%AF%BB%E5%8F%96%20makefile%20%E7%9A%84%E7%9B%AE%E5%BD%95%E3%80%82">make-选项</a></p>
<p>Makefile设置头文件路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">目录结构<br>--driver<br>----src(源文件目录)<br>------Makefile<br>----include(头文件目录)<br></code></pre></td></tr></table></figure>
<p>通过Makefile位置找到头文件位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkfile_path := $(abspath $(lastword $(MAKEFILE_LIST)))<br>include_dir := $(abspath $(mkfile_path)/../../include)<br>ccflags-y += -g -I$(include_dir)<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/ask/sof/61768">如何获取Makefile的当前相对目录？</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012811546/article/details/45541937">Makefile 关于realpath的研究</a></p>
<p>二：运行调试</p>
<p>自定义内核打印函数，方便调试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 输出函数</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEBUG_OPT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_DBG(format, arg...) printk(KERN_DEBUG format, ##arg);</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_DBG(format, arg...)                                                                                      \</span><br><span class="hljs-meta">    do                                                                                                                 \</span><br><span class="hljs-meta">    &#123;                                                                                                                  \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> WARN_OPT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_WARN(format, arg...) printk(KERN_WARNING format, ##arg);</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_WARN(format, arg...)                                                                                     \</span><br><span class="hljs-meta">    do                                                                                                                 \</span><br><span class="hljs-meta">    &#123;                                                                                                                  \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> INFO_OPT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_INFO(format, arg...) printk(KERN_INFO format, ##arg);</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_INFO(format, arg...)                                                                                     \</span><br><span class="hljs-meta">    do                                                                                                                 \</span><br><span class="hljs-meta">    &#123;                                                                                                                  \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">obj-m			+= test.o<br><span class="hljs-comment"># -DINFO_OPT -DDEBUG_OPT -DWARN_OPT 输出选项</span><br>ccflags-y := -DWARN_OPT <br>test-y := test1.o test2.o<br>all:<br>	make -C /lib/modules/$(shell <span class="hljs-built_in">uname</span> -r)/build/ M=$(PWD) modules<br>clean:<br>	make -C /lib/modules/$(shell <span class="hljs-built_in">uname</span> -r)/build/ M=$(PWD) clean<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lanxuezaipiao/p/3535626.html">do {…} while (0) 在宏定义中的作用</a><br>使用dmesg查看内核打印信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">dmesg -w -T -H	<span class="hljs-comment"># 实时查看dmesg输出</span><br>Usage:<br> dmesg [options]<br><br>Display or control the kernel ring buffer.<br><br>Options:<br> -C, --clear                 clear the kernel ring buffer<br> -c, --read-clear            <span class="hljs-built_in">read</span> and clear all messages<br> -D, --console-off           <span class="hljs-built_in">disable</span> printing messages to console<br> -E, --console-on            <span class="hljs-built_in">enable</span> printing messages to console<br> -F, --file &lt;file&gt;           use the file instead of the kernel <span class="hljs-built_in">log</span> buffer<br> -f, --facility &lt;list&gt;       restrict output to defined facilities<br> -H, --human                 human readable output<br> -k, --kernel                display kernel messages<br> -L, --color[=&lt;when&gt;]        colorize messages (auto, always or never)<br>                               colors are enabled by default<br> -l, --level &lt;list&gt;          restrict output to defined levels<br> -n, --console-level &lt;level&gt; <span class="hljs-built_in">set</span> level of messages printed to console<br> -P, --nopager               <span class="hljs-keyword">do</span> not pipe output into a pager<br> -p, --force-prefix          force timestamp output on each line of multi-line messages<br> -r, --raw                   <span class="hljs-built_in">print</span> the raw message buffer<br> -S, --syslog                force to use syslog(2) rather than /dev/kmsg<br> -s, --buffer-size &lt;size&gt;    buffer size to query the kernel ring buffer<br> -u, --userspace             display userspace messages<br> -w, --follow                <span class="hljs-built_in">wait</span> <span class="hljs-keyword">for</span> new messages<br> -x, --decode                decode facility and level to readable string<br> -d, --show-delta            show time delta between printed messages<br> -e, --reltime               show <span class="hljs-built_in">local</span> time and time delta <span class="hljs-keyword">in</span> readable format<br> -T, --ctime                 show human-readable timestamp (may be inaccurate!)<br> -t, --notime                don<span class="hljs-string">&#x27;t show any timestamp with messages</span><br><span class="hljs-string">     --time-format &lt;format&gt;  show timestamp using the given format:</span><br><span class="hljs-string">                               [delta|reltime|ctime|notime|iso]</span><br><span class="hljs-string">Suspending/resume will make ctime and iso timestamps inaccurate.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> -h, --help                  display this help</span><br><span class="hljs-string"> -V, --version               display version</span><br><span class="hljs-string"></span><br><span class="hljs-string">Supported log facilities:</span><br><span class="hljs-string">    kern - kernel messages</span><br><span class="hljs-string">    user - random user-level messages</span><br><span class="hljs-string">    mail - mail system</span><br><span class="hljs-string">  daemon - system daemons</span><br><span class="hljs-string">    auth - security/authorization messages</span><br><span class="hljs-string">  syslog - messages generated internally by syslogd</span><br><span class="hljs-string">     lpr - line printer subsystem</span><br><span class="hljs-string">    news - network news subsystem</span><br><span class="hljs-string"></span><br><span class="hljs-string">Supported log levels (priorities):</span><br><span class="hljs-string">   emerg - system is unusable</span><br><span class="hljs-string">   alert - action must be taken immediately</span><br><span class="hljs-string">    crit - critical conditions</span><br><span class="hljs-string">     err - error conditions</span><br><span class="hljs-string">    warn - warning conditions</span><br><span class="hljs-string">  notice - normal but significant condition</span><br><span class="hljs-string">    info - informational</span><br><span class="hljs-string">   debug - debug-level messages</span><br><span class="hljs-string"></span><br><span class="hljs-string">For more details see dmesg(1).</span><br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/406631271">kmsg日志的存储与读取</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Wang20122013/article/details/108446180">linux内核调试之kmsg和dmesg</a></p>
<p><img src="https://img-blog.csdnimg.cn/5be32e992f7b495586ff3e8c3627fb2c.png" srcset="/img/loading.gif" lazyload></p>
<p>在<strong>调试环境</strong>下，或许可以删除之前的日志便于之后的日志查看</p>
<p>至今我都没有成功的方法获取内核崩溃前日志<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/happen23/article/details/120225341">获取Linux内核卡死前的日志</a></p>
<p>调试方法：<br>1 检查异常情况，打印相关信息，<strong>立即返回</strong>（面向printk开机关机编程）<br>2 配置kgdb，使用kgdb打印内核崩溃时输出信息或通过断点调试<br>kgdb使用经验：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">开发机：开发代码，运行驱动进行测试<br>调试机：使用kgdb通过串口调试开发机<br><br>两机器开发目录的绝对路径保持一致，将开发机代码拷贝至调试机同一位置<br>1 开发机<br><span class="hljs-built_in">echo</span> g &gt; /proc/sysrq-trigger<br>此时开发机卡死<br>2 调试机<br>gdb vmlinux<br><span class="hljs-built_in">set</span> serial baud 115200<br>target remote /dev/ttyAMA1<br>看到输出后按c继续运行<br>此时开发机恢复正常<br>3 开发机<br>加载驱动 insmod xx.ko<br>查看插入驱动后代码段位置<br><span class="hljs-built_in">cat</span> /sys/module/驱动名/sections/.text<br>得到地址0x123456789<br><span class="hljs-built_in">echo</span> g &gt; /proc/sysrq-trigger<br>4 调试机<br>add-symbol-file ko文件绝对路径 0x123456789<br>使用b打断点<br>按c继续运行<br>5 开发机<br>运行测试方法，击中断点<br>6 调试机<br>触发断点，打印相关信息<br><br>不过不知道为什么，按n有时候会进入中断(entry handler)，导致无法调试<br>相关命令：<br>lx-dmesg<br>lx-symbols<br></code></pre></td></tr></table></figure>
<p>注意驱动初始化时不能有错误，要不然无法得到驱动符号地址，为了方便，我们将测试的函数放在remove函数中，然后通过rmmod xx来触发断点。</p>
<p>调试过程中，被调试的内核运行在目标机上，GDB 调试器运行在开发机上。<br><img src="https://img-blog.csdnimg.cn/77cc6d8372e745dc934384169d06776e.png" srcset="/img/loading.gif" lazyload></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bendsha/p/6099255.html">使用 KGDB 调试 Kernel On Red Hat Linux</a></p>
<h2 id="十九：调试经历"><a href="#十九：调试经历" class="headerlink" title="十九：调试经历"></a>十九：调试经历</h2><p>有些时候与其他开发人员沟通比一个人调试高效，但需确保自己已完全理解问题，可以完整表述问题且尝试了许多方法仍未解决<br>有可能程序实现并没有问题，程序已准确实现你心中的概念，但你对业务的理解有偏差，故不能单纯靠代码调试解决问题<br><strong>调试经历1</strong><br>我编写的驱动在openEuler上运行，但一插入驱动就报空指针错误，开始远程调试</p>
<p>编译运行环境，在x64 Ubuntu上交叉编译，在arm 嵌入式openEuler运行</p>
<p>1：首先dmesg查看内核日志，但很奇怪的是没有任何打印，驱动一加载就显示空指针错误，没有模块初始化时我加的的输出语句<br>检查日志输出级别也正常，可以输出info级别的消息，这相当于还没进入任何我编写的驱动部分就空指针异常了，而且崩溃时调用栈也全是不认识的函数。</p>
<p>所以我提出使用hello world简单驱动程序测试当前编译运行环境是否正常，而后发现hello world驱动程序出现同样的问题，后对方进行一些调整，解决问题</p>
<p>2：驱动插入时对BAR空间的信息全部错误（BAR起始地址，结束地址，标志位，大小），即pci_dev的resource成员的信息都很奇怪，但从lspci -v看来又是正确的，非常奇怪，怀疑是linux底层pci枚举出现问题，后想先将ioremap函数参数写成定值，暂时跳过该步，但接下来device_add_disk有发送非法地址访问错误，觉得BAR问题应该饶不开了，只能先解决这个问题</p>
<p>先切换运行环境内核版本为4.19，驱动运行正常，故代码没有太大问题，还是出在运行环境上，后应该是通过分离内核源码，配置方式重新编译驱动，不再统一编译，解决了该问题，我也不太了解</p>
<p>交叉编译，嵌入式，国产全是bug多发地</p>
<p><strong>调试经历2</strong><br>进行块设备驱动的验收，采用的数据收发流程和nvme类似，写sq，读cq。由于没有实现中断，只能轮询相应位置读取cq命令。但诡异的是用一个简单程序（在初始化函数中写sq，然后while循环读cq，直至读到相应cq命令）可以正常收发数据，而我的内核线程却一直轮询不到正确的数据，但观察串口打印确实执行了相应命令，cq相应位置的数据也确实发生了改变，唯独缺少了那个正确的数据。<br>示例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">cq位置<br>我的程序输出<br>x<br>x<br>x<br>y<br>y<br>y<br><br>测试程序输出<br>x<br>x<br>x<br>z<br>y<br>y<br>y<br></code></pre></td></tr></table></figure>
<p>后面对测试程序进行修改，和我内核线程一样使用一定的休眠延时，同样没有收到cq。合理推测这数据会过期，只能在一定时间内取到，但不理解为什么要把cq数据设置为定时的数据。直到后面与固件开发人员交流后才发现原来cq逻辑是这样的：cq对应位置是一个fifo，刚开始数据确实在fifo中，但随即device会将fifo数据传递给host的fifo，所以我们本不应该在cq fifo读到数据，只是频率太高，凑巧读到了。</p>
<p><strong>调试经历3</strong><br> 由于块设备驱动一次只能发送一条指令，对于协议栈请求，我的处理方式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> allow = <span class="hljs-number">1</span>;<br><br>请求到达<br><span class="hljs-keyword">if</span>(allow==<span class="hljs-number">1</span>)&#123;<br>    allow = <span class="hljs-number">0</span>;<br>	执行请求<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>	将请求入队<br>&#125;<br><br>请求处理完成<br>allow = <span class="hljs-number">1</span>;<br>下一个请求出队，处理该请求<br></code></pre></td></tr></table></figure>
<p>请求队列的tagset.queue_depth设的比较大，一次可能有多个请求到达。所以问题就很明显了，并发导致竞态。<br>当执行mkfs命令格式化文件系统时，一时间有多个请求到达，可能有多个请求同时进入了allow&#x3D;&#x3D;1分支，导致向SQ写入的命令非常诡异</p>
<p>解决方法也比较简单，就是使用原子变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">atomic_t</span> allow;<br><span class="hljs-type">atomic_set</span>(&amp;allow, <span class="hljs-number">1</span>);<br>请求到达<br><span class="hljs-comment">// atomic_cmpxchg(v, old, new)</span><br><span class="hljs-comment">// 执行原子比较交换，如果原子变量v的值等于old，那么把原子变量v的值设置为new，返回值总是原子变量v的旧值</span><br><span class="hljs-keyword">if</span>(atomic_cmpxchg(&amp;allow,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)==<span class="hljs-number">1</span>)&#123;	<br>	执行请求<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>	将请求入队<br>&#125;<br><br>请求处理完成<br><span class="hljs-type">atomic_set</span>(&amp;allow, <span class="hljs-number">1</span>);<br>下一个请求出队，处理该请求<br></code></pre></td></tr></table></figure>
<p>这种模式的问题如果放在多线程专题的实验或者锁专题的实验里面一眼就能看出来了，但实际工程中却比较容易犯，因为在写项目代码中没有人暗示需要进行处理并发问题，就比如运算符优先级问题，&#x3D;&#x3D;与&#x3D;之类的，理论上都不会犯，但实际写代码时就是容易写出类似的代码，这也是工程实践的意义</p>
<h2 id="二十：设置文件系统块大小"><a href="#二十：设置文件系统块大小" class="headerlink" title="二十：设置文件系统块大小"></a>二十：设置文件系统块大小</h2><p>由于块设备驱动最小只支持64K数据读取，修改内核设置页大小又觉得有点麻烦，后面看到在mkfs就有设置块大小的选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkfs.ext4: invalid option -- <span class="hljs-string">&#x27;-&#x27;</span><br>Usage: mkfs.ext4 [-c|-l filename] [-b block-size] [-C cluster-size]<br>        [-i bytes-per-inode] [-I inode-size] [-J journal-options]<br>        [-G flex-group-size] [-N number-of-inodes] [-d root-directory]<br>        [-m reserved-blocks-percentage] [-o creator-os]<br>        [-g blocks-per-group] [-L volume-label] [-M last-mounted-directory]<br>        [-O feature[,...]] [-r fs-revision] [-E extended-option[,...]]<br>        [-t fs-type] [-T usage-type ] [-U UUID] [-e errors_behavior][-z undo_file]<br>        [-jnqvDFSV] device [blocks-count]<br></code></pre></td></tr></table></figure>
<p>示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkfs.ext4   -b 65536 /dev/nvme1n1p1<br>Warning: blocksize 65536 not usable on most systems.<br>mke2fs 1.45.5 (07-Jan-2020)<br>/dev/nvme1n1p1 contains a ext4 file system<br>        created on Fri Apr 21 17:00:47 2023<br>Proceed anyway? (y,N) y<br>mkfs.ext4: 65536-byte blocks too big <span class="hljs-keyword">for</span> system (max 4096)<br>Proceed anyway? (y,N) y<br>Warning: 65536-byte blocks too big <span class="hljs-keyword">for</span> system (max 4096), forced to <span class="hljs-built_in">continue</span><br>Creating filesystem with 163824 64k blocks and 164352 inodes<br>Filesystem UUID: 0d389dff-8d36-43b1-8362-2482ef7002b7<br>Superblock backups stored on blocks: <br>        65528<br><br>Allocating group tables: <span class="hljs-keyword">done</span>                            <br>Writing inode tables: <span class="hljs-keyword">done</span>                            <br>Creating journal (4096 blocks): <span class="hljs-keyword">done</span><br>Writing superblocks and filesystem accounting information: <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>
<p>本来以为大功告成了，但挂载时出错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mount -t ext4   /dev/nvme1n1p1 <span class="hljs-built_in">test</span><br>mount: <span class="hljs-built_in">test</span>: wrong fs <span class="hljs-built_in">type</span>, bad option, bad superblock on /dev/nvme1n1p1, missing codepage or helper program, or other error.<br><br>dmesg输出<br>[18738.045713] EXT4-fs (nvme1n1p1): bad block size 65536<br></code></pre></td></tr></table></figure>
<p>当时想研究一下ext4文件系统的实现细节，看一看哪个环节出了错误，后面才看到有现成的命令输出文件系统信息，所以说遇到问题先找工具，看看有没有现成的，不要重复造轮子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">tldr dumpe2fs<br>dumpe2fs<br>Print the super block and blocks group information <span class="hljs-keyword">for</span> ext2/ext3/ext4 filesystems.Unmount the partition before running this <span class="hljs-built_in">command</span> using umount &#123;&#123;device&#125;&#125;.More information: https://manned.org/dumpe2fs.<br><br> - Display ext2, ext3 and ext4 filesystem information:<br>   dumpe2fs &#123;&#123;/dev/sdXN&#125;&#125;<br><br> - Display the blocks <span class="hljs-built_in">which</span> are reserved as bad <span class="hljs-keyword">in</span> the filesystem:<br>   dumpe2fs -b &#123;&#123;/dev/sdXN&#125;&#125;<br><br> - Force display filesystem information even with unrecognizable feature flags:<br>   dumpe2fs -f &#123;&#123;/dev/sdXN&#125;&#125;<br><br> - Only display the superblock information and not any of the block group descriptor detail information:<br>   dumpe2fs -h &#123;&#123;/dev/sdXN&#125;&#125;<br><br> - Print the detailed group information block numbers <span class="hljs-keyword">in</span> hexadecimal format:<br>   dumpe2fs -x &#123;&#123;/dev/sdXN&#125;&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash">dumpe2fs /dev/nvme1n1p1<br>dumpe2fs 1.45.5 (07-Jan-2020)<br>Filesystem volume name:   &lt;none&gt;<br>Last mounted on:          &lt;not available&gt;<br>Filesystem UUID:          0d389dff-8d36-43b1-8362-2482ef7002b7<br>Filesystem magic number:  0xEF53<br>Filesystem revision <span class="hljs-comment">#:    1 (dynamic)</span><br>Filesystem features:      has_journal ext_attr resize_inode dir_index filetype extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum<br>Filesystem flags:         signed_directory_hash <br>Default mount options:    user_xattr acl<br>Filesystem state:         clean<br>Errors behavior:          Continue<br>Filesystem OS <span class="hljs-built_in">type</span>:       Linux<br>Inode count:              164352<br>Block count:              163824<br>Reserved block count:     8191<br>Free blocks:              159068<br>Free inodes:              164341<br>First block:              0<br>Block size:               65536<br>Fragment size:            65536<br>Group descriptor size:    64<br>Reserved GDT blocks:      2<br>Blocks per group:         65528<br>Fragments per group:      65528<br>Inodes per group:         54784<br>Inode blocks per group:   214<br>Flex block group size:    16<br>Filesystem created:       Sun Apr 23 11:16:03 2023<br>Last mount time:          n/a<br>Last write time:          Sun Apr 23 11:16:03 2023<br>Mount count:              0<br>Maximum mount count:      -1<br>Last checked:             Sun Apr 23 11:16:03 2023<br>Check interval:           0 (&lt;none&gt;)<br>Lifetime writes:          261 kB<br>Reserved blocks uid:      0 (user root)<br>Reserved blocks gid:      0 (group root)<br>First inode:              11<br>Inode size:               256<br>Required extra isize:     32<br>Desired extra isize:      32<br>Journal inode:            8<br>Default directory <span class="hljs-built_in">hash</span>:   half_md4<br>Directory Hash Seed:      bd1ab816-317b-43f9-b664-1d1f1bf2962a<br>Journal backup:           inode blocks<br>Checksum <span class="hljs-built_in">type</span>:            crc32c<br>Checksum:                 0x4a3a900f<br>Journal features:         (none)<br>Journal size:             256M<br>Journal length:           4096<br>Journal sequence:         0x00000001<br>Journal start:            0<br><br><br>Group 0: (Blocks 0-65527) csum 0x3132<br>  Primary superblock at 0, Group descriptors at 1-1<br>  Reserved GDT blocks at 2-3<br>  Block bitmap at 4 (+4), csum 0x0e2f600d<br>  Inode bitmap at 7 (+7), csum 0x5eb14e2c<br>  Inode table at 10-223 (+10)<br>  64872 free blocks, 54773 free inodes, 2 directories, 54773 unused inodes<br>  Free blocks: 656-65527<br>  Free inodes: 12-54784<br>Group 1: (Blocks 65528-131055) csum 0x80b5 [INODE_UNINIT]<br>  Backup superblock at 65528, Group descriptors at 65529-65529<br>  Reserved GDT blocks at 65530-65531<br>  Block bitmap at 5 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 5), csum 0x1c5bc20f</span><br>  Inode bitmap at 8 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 8), csum 0x00000000</span><br>  Inode table at 224-437 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 224)</span><br>  61428 free blocks, 54784 free inodes, 0 directories, 54784 unused inodes<br>  Free blocks: 69628-131055<br>  Free inodes: 54785-109568<br>Group 2: (Blocks 131056-163823) csum 0x06dc [INODE_UNINIT]<br>  Block bitmap at 6 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 6), csum 0xa7a42c48</span><br>  Inode bitmap at 9 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 9), csum 0x00000000</span><br>  Inode table at 438-651 (<span class="hljs-built_in">bg</span> <span class="hljs-comment">#0 + 438)</span><br>  32768 free blocks, 54784 free inodes, 0 directories, 54784 unused inodes<br>  Free blocks: 131056-163823<br>  Free inodes: 109569-164352<br></code></pre></td></tr></table></figure>
<p>常规的方法行不通，就去网上找找有没有其他方法，然后就看到了这篇帖子<br><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/73536/how-can-i-mount-filesystems-with-4kb-block-sizes">How can I mount filesystems with &gt; 4KB block sizes?</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/106719192">5分钟搞懂用户空间文件系统FUSE工作原理</a></p>
<p>使用用户文件系统的方式挂载分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">fuseext2 /dev/nvme1n1p1 test_dir -o rw+<br>fuse-umfuse-ext2: version:<span class="hljs-string">&#x27;0.4&#x27;</span>, fuse_version:<span class="hljs-string">&#x27;29&#x27;</span> [main (fuse-ext2.c:331)]<br>fuse-umfuse-ext2: enter [do_probe (do_probe.c:30)]<br>fuse-umfuse-ext2: leave [do_probe (do_probe.c:55)]<br>fuse-umfuse-ext2: opts.device: /dev/nvme1n1p1 [main (fuse-ext2.c:358)]<br>fuse-umfuse-ext2: opts.mnt_point: test_dir [main (fuse-ext2.c:359)]<br>fuse-umfuse-ext2: opts.volname:  [main (fuse-ext2.c:360)]<br>fuse-umfuse-ext2: opts.options: rw+ [main (fuse-ext2.c:361)]<br>fuse-umfuse-ext2: parsed_options: rw,fsname=/dev/nvme1n1p1 [main (fuse-ext2.c:362)]<br>fuse-umfuse-ext2: mounting read-write [main (fuse-ext2.c:376)]<br></code></pre></td></tr></table></figure>
<p>此时就可以正常使用分区且lsblk可以看到挂载目录</p>
<h2 id="二十一：数据落盘"><a href="#二十一：数据落盘" class="headerlink" title="二十一：数据落盘"></a>二十一：数据落盘</h2><p>背景：块设备为保证数据落盘，关机前需发送shutdown指令，执行完shutdown指令后设备不再处理请求<br>第一个解决方案：关机前执行程序，手动发送shutdown指令<br>由于执行完shutdown指令后协议栈仍然会下发请求，故需记录当前是否执行shutdown指令，若执行了shutdown指令则直接结束请求。<br>这种方式的问题在于：①手动执行shutdown指令比较麻烦 ②关机时操作系统会将页缓存的数据刷入硬盘，若执行了shutdown指令则请求不能执行<br>第二个解决方案：驱动关机时自动发送shutdown指令<br>刚开始的时候我觉得驱动在关机的时候也会执行remove函数（不知道为什么），所以我在remove函数中向设备发送shutdown指令，但关机时看设备的串口打印并没有看到执行shutdown指令，故关机并不会执行remove函数，后在nvme驱动代码中找了一下，看到了shutdown函数，故在shutdown函数中发送shutdown指令并等待执行执行完成。这样实现后就能从串口中看到关机时首先执行了许多write指令，最后执行一个shutdown指令。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span>;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * struct pci_driver - PCI driver structure</span><br><span class="hljs-comment"> * @node:	List of driver structures.</span><br><span class="hljs-comment"> * @name:	Driver name.</span><br><span class="hljs-comment"> * @id_table:	Pointer to table of device IDs the driver is</span><br><span class="hljs-comment"> *		interested in.  Most drivers should export this</span><br><span class="hljs-comment"> *		table using MODULE_DEVICE_TABLE(pci,...).</span><br><span class="hljs-comment"> * @probe:	This probing function gets called (during execution</span><br><span class="hljs-comment"> *		of pci_register_driver() for already existing</span><br><span class="hljs-comment"> *		devices or later if a new device gets inserted) for</span><br><span class="hljs-comment"> *		all PCI devices which match the ID table and are not</span><br><span class="hljs-comment"> *		&quot;owned&quot; by the other drivers yet. This function gets</span><br><span class="hljs-comment"> *		passed a &quot;struct pci_dev \*&quot; for each device whose</span><br><span class="hljs-comment"> *		entry in the ID table matches the device. The probe</span><br><span class="hljs-comment"> *		function returns zero when the driver chooses to</span><br><span class="hljs-comment"> *		take &quot;ownership&quot; of the device or an error code</span><br><span class="hljs-comment"> *		(negative number) otherwise.</span><br><span class="hljs-comment"> *		The probe function always gets called from process</span><br><span class="hljs-comment"> *		context, so it can sleep.</span><br><span class="hljs-comment"> * @remove:	The remove() function gets called whenever a device</span><br><span class="hljs-comment"> *		being handled by this driver is removed (either during</span><br><span class="hljs-comment"> *		deregistration of the driver or when it&#x27;s manually</span><br><span class="hljs-comment"> *		pulled out of a hot-pluggable slot).</span><br><span class="hljs-comment"> *		The remove function always gets called from process</span><br><span class="hljs-comment"> *		context, so it can sleep.</span><br><span class="hljs-comment"> * @suspend:	Put device into low power state.</span><br><span class="hljs-comment"> * @suspend_late: Put device into low power state.</span><br><span class="hljs-comment"> * @resume_early: Wake device from low power state.</span><br><span class="hljs-comment"> * @resume:	Wake device from low power state.</span><br><span class="hljs-comment"> *		(Please see Documentation/power/pci.rst for descriptions</span><br><span class="hljs-comment"> *		of PCI Power Management and the related functions.)</span><br><span class="hljs-comment"> * @shutdown:	Hook into reboot_notifier_list (kernel/sys.c).</span><br><span class="hljs-comment"> *		Intended to stop any idling DMA operations.</span><br><span class="hljs-comment"> *		Useful for enabling wake-on-lan (NIC) or changing</span><br><span class="hljs-comment"> *		the power state of a device before reboot.</span><br><span class="hljs-comment"> *		e.g. drivers/net/e100.c.</span><br><span class="hljs-comment"> * @sriov_configure: Optional driver callback to allow configuration of</span><br><span class="hljs-comment"> *		number of VFs to enable via sysfs &quot;sriov_numvfs&quot; file.</span><br><span class="hljs-comment"> * @err_handler: See Documentation/PCI/pci-error-recovery.rst</span><br><span class="hljs-comment"> * @groups:	Sysfs attribute groups.</span><br><span class="hljs-comment"> * @driver:	Driver model structure.</span><br><span class="hljs-comment"> * @dynids:	List of dynamically added device IDs.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">node</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span>		*name;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_device_id</span> *<span class="hljs-title">id_table</span>;</span>	<span class="hljs-comment">/* Must be non-NULL for probe to be called */</span><br>	<span class="hljs-type">int</span>  (*probe)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id);	<span class="hljs-comment">/* New device inserted */</span><br>	<span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> pci_dev *dev);	<span class="hljs-comment">/* Device removed (NULL if not a hot-plug capable driver) */</span><br>	<span class="hljs-type">int</span>  (*suspend)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">pm_message_t</span> state);	<span class="hljs-comment">/* Device suspended */</span><br>	<span class="hljs-type">int</span>  (*suspend_late)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">pm_message_t</span> state);<br>	<span class="hljs-type">int</span>  (*resume_early)(<span class="hljs-keyword">struct</span> pci_dev *dev);<br>	<span class="hljs-type">int</span>  (*resume)(<span class="hljs-keyword">struct</span> pci_dev *dev);	<span class="hljs-comment">/* Device woken up */</span><br>	<span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> pci_dev *dev);<br>	<span class="hljs-type">int</span>  (*sriov_configure)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">int</span> num_vfs); <span class="hljs-comment">/* On PF */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_error_handlers</span> *<span class="hljs-title">err_handler</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">groups</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_driver</span>	<span class="hljs-title">driver</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_dynids</span>	<span class="hljs-title">dynids</span>;</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nvme_shutdown</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pci_dev *pdev)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nvme_dev</span> *<span class="hljs-title">dev</span> =</span> pci_get_drvdata(pdev);<br>	nvme_dev_disable(dev, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> <span class="hljs-title">nvme_driver</span> =</span> &#123;<br>	.name		= <span class="hljs-string">&quot;nvme&quot;</span>,<br>	.id_table	= nvme_id_table,<br>	.probe		= nvme_probe,<br>	.remove		= nvme_remove,<br>	.shutdown	= nvme_shutdown,<br>	.driver		= &#123;<br>		.pm	= &amp;nvme_dev_pm_ops,<br>	&#125;,<br>	.sriov_configure = pci_sriov_configure_simple,<br>	.err_handler	= &amp;nvme_err_handler,<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="二十二-kfifo误区"><a href="#二十二-kfifo误区" class="headerlink" title="二十二 kfifo误区"></a>二十二 kfifo误区</h2><p>写块设备驱动代码时使用kfifo保证一次只发一个请求，搜Kfifo用法时候看到“内核无锁队列”这几个词，自然而然没有对Kfifo加锁，但驱动写完测试的时候出队的结果千奇百怪，刚开始还找是不是其他模块出了问题，通过打印发现就是队列取出的数据有问题，所以看一看Kfifo源码，看到了以下注释：<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.3.18/source/include/linux/kfifo.h#L319">include&#x2F;linux&#x2F;kfifo.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Note about locking: There is no locking required until only one reader</span><br><span class="hljs-comment"> * and one writer is using the fifo and no kfifo_reset() will be called.</span><br><span class="hljs-comment"> * kfifo_reset_out() can be safely used, until it will be only called</span><br><span class="hljs-comment"> * in the reader thread.</span><br><span class="hljs-comment"> * For multiple writer and one reader there is only a need to lock the writer.</span><br><span class="hljs-comment"> * And vice versa for only one writer and multiple reader there is only a need</span><br><span class="hljs-comment"> * to lock the reader.</span><br><span class="hljs-comment"> */</span><br><br> <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfifo_in_spinlocked - put data into the fifo using a spinlock for locking</span><br><span class="hljs-comment"> * @fifo: address of the fifo to be used</span><br><span class="hljs-comment"> * @buf: the data to be added</span><br><span class="hljs-comment"> * @n: number of elements to be added</span><br><span class="hljs-comment"> * @lock: pointer to the spinlock to use for locking</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This macro copies the given values buffer into the fifo and returns the</span><br><span class="hljs-comment"> * number of copied elements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	kfifo_in_spinlocked(fifo, buf, n, lock) \</span><br><span class="hljs-meta">(&#123; \</span><br><span class="hljs-meta">	unsigned long __flags; \</span><br><span class="hljs-meta">	unsigned int __ret; \</span><br><span class="hljs-meta">	spin_lock_irqsave(lock, __flags); \</span><br><span class="hljs-meta">	__ret = kfifo_in(fifo, buf, n); \</span><br><span class="hljs-meta">	spin_unlock_irqrestore(lock, __flags); \</span><br><span class="hljs-meta">	__ret; \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfifo_out_spinlocked - get data from the fifo using a spinlock for locking</span><br><span class="hljs-comment"> * @fifo: address of the fifo to be used</span><br><span class="hljs-comment"> * @buf: pointer to the storage buffer</span><br><span class="hljs-comment"> * @n: max. number of elements to get</span><br><span class="hljs-comment"> * @lock: pointer to the spinlock to use for locking</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This macro get the data from the fifo and return the numbers of elements</span><br><span class="hljs-comment"> * copied.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	kfifo_out_spinlocked(fifo, buf, n, lock) \</span><br><span class="hljs-meta">__kfifo_uint_must_check_helper( \</span><br><span class="hljs-meta">(&#123; \</span><br><span class="hljs-meta">	unsigned long __flags; \</span><br><span class="hljs-meta">	unsigned int __ret; \</span><br><span class="hljs-meta">	spin_lock_irqsave(lock, __flags); \</span><br><span class="hljs-meta">	__ret = kfifo_out(fifo, buf, n); \</span><br><span class="hljs-meta">	spin_unlock_irqrestore(lock, __flags); \</span><br><span class="hljs-meta">	__ret; \</span><br><span class="hljs-meta">&#125;) \</span><br><span class="hljs-meta">)</span><br></code></pre></td></tr></table></figure>
<p>所以说有多个写者&#x2F;读者的时候还是需要加锁的，只是单个读者+单个写者不需要加锁<br>相关博客推荐：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44062361/article/details/108749870">linux内核之无锁缓冲队列kfifo原理（结合项目实践）</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/500070147">kfifo（内核无锁队列）</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">                                               |&lt;--写入--&gt;|<br>+--------------------------------------------------------------+<br>|                        |&lt;----------data-----&gt;|               |<br>+--------------------------------------------------------------+<br>                         |&lt;--读取--&gt;|<br>                         ^                     ^               ^<br>                         |                     |               |<br>                        out                   <span class="hljs-keyword">in</span>              size<br><br></code></pre></td></tr></table></figure>

<h2 id="二十三-kmalloc-vmalloc-kvmalloc"><a href="#二十三-kmalloc-vmalloc-kvmalloc" class="headerlink" title="二十三 kmalloc vmalloc kvmalloc"></a>二十三 kmalloc vmalloc kvmalloc</h2><p>由于刚开始写驱动代码，所有的内存申请都使用kmalloc。在块设备驱动中ioctl请求需申请内核缓冲区存放中间数据，有时候发现申请内存失败。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[  720.936419] 8_ioctl_rw_test: page allocation failure: order:10, mode:0x40cc0(GFP_KERNEL|__GFP_COMP), nodemask=(null),cpuset=/,mems_allowed=0<br>[  720.936427] CPU: 3 PID: 5741 Comm: 8_ioctl_rw_test Tainted: G           OE     5.4.18-35-generic <span class="hljs-comment">#21-KYLINOS</span><br>[  720.936429] Hardware name: GITSTAR GITSTAR-MF20A/GM9-2665, BIOS 03.12 02/15/22 23:09:42<br>[  720.936430] Call trace:<br>[  720.936435]  dump_backtrace+0x0/0x178<br>[  720.936437]  show_stack+0x14/0x20<br>[  720.936440]  dump_stack+0xac/0xd0<br>[  720.936444]  warn_alloc+0xec/0x158<br>[  720.936446]  __alloc_pages_slowpath+0x9ec/0xa18<br>[  720.936447]  __alloc_pages_nodemask+0x244/0x2a8<br>[  720.936449]  alloc_pages_current+0x7c/0xe8<br>[  720.936452]  kmalloc_order+0x1c/0x88<br>[  720.936454]  __kmalloc+0x1cc/0x208<br>[  720.936461]  hps_ioctl_cmd+0x60/0x308 [Hps]<br>[  720.936463]  hps_ioctl+0xe8/0xf8 [Hps]<br>[  720.936466]  blkdev_ioctl+0x4b0/0xac0<br>[  720.936469]  block_ioctl+0x34/0x40<br>[  720.936471]  do_vfs_ioctl+0x370/0x7a8<br>[  720.936472]  ksys_ioctl+0x78/0xa8<br>[  720.936474]  sys_ioctl+0xc/0x18<br>[  720.936476]  el0_svc_naked+0x30/0x34<br>[  720.936477] Mem-Info:<br>[  720.936481] active_anon:259253 inactive_anon:130401 isolated_anon:0<br>                active_file:173204 inactive_file:345209 isolated_file:0<br>                unevictable:16 dirty:1 writeback:0 unstable:0<br>                slab_reclaimable:16313 slab_unreclaimable:22005<br>                mapped:113679 shmem:12956 pagetables:7084 bounce:0<br>                free:19674 free_pcp:1903 free_cma:326<br></code></pre></td></tr></table></figure>
<p>使用cat &#x2F;proc&#x2F;buddyinfo发现高阶内存比较少，确实很可能出现申请不到内存的现象<br>相关博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/MissMango0820/article/details/128480885">Linux | 内存 | 由内存页不足（page allocation failure）引起程序杀死（OOM Killer）</a><br>没找到啥具有可行性的方法，并且这错误也不是稳定出现，就没咋管，后面请求密集了发现这问题稳定复现了，就不得不想想怎么解决了。<br>刚开始我的代码申请失败直接返回，没有啥错误处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *buffer = kmalloc(length, GFP_KERNEL); <br><span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">NULL</span>)<br>&#123;<br>    PRINT_WARN(<span class="hljs-string">&quot;alloc kernel buffer failed.&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>后面想想为啥申请几M内存会申请不了，难道kmalloc和dma_alloc_coherent一样要求物理内存连续吗？搜一搜发现还真是，并且发现了kvmalloc这个智能函数，把kmalloc kfree改成kvmalloc kvfree了<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/337216805">vmalloc &amp; kmalloc</a><br><strong>最终测试的时候会将之前默认的选择重新审视一遍</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">kvmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> kvmalloc_node(size, flags, NUMA_NO_NODE);<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kvmalloc_node - attempt to allocate physically contiguous memory, but upon</span><br><span class="hljs-comment"> * failure, fall back to non-contiguous (vmalloc) allocation.</span><br><span class="hljs-comment"> * @size: size of the request.</span><br><span class="hljs-comment"> * @flags: gfp mask for the allocation - must be compatible (superset) with GFP_KERNEL.</span><br><span class="hljs-comment"> * @node: numa node to allocate from</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Uses kmalloc to get the memory but if the allocation fails then falls back</span><br><span class="hljs-comment"> * to the vmalloc allocator. Use kvfree for freeing the memory.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Reclaim modifiers - __GFP_NORETRY and __GFP_NOFAIL are not supported.</span><br><span class="hljs-comment"> * __GFP_RETRY_MAYFAIL is supported, and it should be used only if kmalloc is</span><br><span class="hljs-comment"> * preferable to the vmalloc fallback, due to visible performance drawbacks.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Please note that any use of gfp flags outside of GFP_KERNEL is careful to not</span><br><span class="hljs-comment"> * fall back to vmalloc.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return: pointer to the allocated memory of %NULL in case of failure</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">kvmalloc_node</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)</span><br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * vmalloc - allocate virtually contiguous memory</span><br><span class="hljs-comment"> * @size:    allocation size</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Allocate enough pages to cover @size from the page level</span><br><span class="hljs-comment"> * allocator and map them into contiguous kernel virtual space.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * For tight control over page level allocator and protection flags</span><br><span class="hljs-comment"> * use __vmalloc() instead.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return: pointer to the allocated memory or %NULL on error</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">vmalloc</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> __vmalloc_node_flags(size, NUMA_NO_NODE,<br>				    GFP_KERNEL);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kmalloc - allocate memory</span><br><span class="hljs-comment"> * @size: how many bytes of memory are required.</span><br><span class="hljs-comment"> * @flags: the type of memory to allocate.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * kmalloc is the normal method of allocating memory</span><br><span class="hljs-comment"> * for objects smaller than page size in the kernel.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The allocated object address is aligned to at least ARCH_KMALLOC_MINALIGN</span><br><span class="hljs-comment"> * bytes. For @size of power of two bytes, the alignment is also guaranteed</span><br><span class="hljs-comment"> * to be at least to the size.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The @flags argument may be one of the GFP flags defined at</span><br><span class="hljs-comment"> * include/linux/gfp.h and described at</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/mm-api.rst &lt;mm-api-gfp-flags&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The recommended usage of the @flags is described at</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/memory-allocation.rst &lt;memory-allocation&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Below is a brief outline of the most useful GFP flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_KERNEL</span><br><span class="hljs-comment"> *	Allocate normal kernel ram. May sleep.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_NOWAIT</span><br><span class="hljs-comment"> *	Allocation will not sleep.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_ATOMIC</span><br><span class="hljs-comment"> *	Allocation will not sleep.  May use emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_HIGHUSER</span><br><span class="hljs-comment"> *	Allocate memory from high memory on behalf of user.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Also it is possible to set different flags by OR&#x27;ing</span><br><span class="hljs-comment"> * in one or more of the following additional @flags:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_HIGH</span><br><span class="hljs-comment"> *	This allocation has high priority and may use emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOFAIL</span><br><span class="hljs-comment"> *	Indicate that this allocation is in no way allowed to fail</span><br><span class="hljs-comment"> *	(think twice before using).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NORETRY</span><br><span class="hljs-comment"> *	If memory is not immediately available,</span><br><span class="hljs-comment"> *	then give up at once.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOWARN</span><br><span class="hljs-comment"> *	If allocation fails, don&#x27;t issue any warnings.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> *	Try really hard to succeed the allocation but fail</span><br><span class="hljs-comment"> *	eventually.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br></code></pre></td></tr></table></figure>
<h2 id="二十三-延时函数相关博客"><a href="#二十三-延时函数相关博客" class="headerlink" title="二十三 延时函数相关博客"></a>二十三 延时函数相关博客</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15994603/how-to-sleep-in-the-linux-kernel">How to sleep in the Linux kernel?</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs c">delays - Information on the various kernel delay / sleep mechanisms<br>-------------------------------------------------------------------<br><br>This document seeks to answer the common question: <span class="hljs-string">&quot;What is the</span><br><span class="hljs-string">RightWay (TM) to insert a delay?&quot;</span><br><br>This question is most often faced by driver writers who have to<br>deal with hardware delays and who may not be the most intimately<br>familiar with the inner workings of the Linux Kernel.<br><br><br>Inserting Delays<br>----------------<br><br>The first, and most important, question you need to ask is <span class="hljs-string">&quot;Is my</span><br><span class="hljs-string">code in an atomic context?&quot;</span>  This should be followed closely by <span class="hljs-string">&quot;Does</span><br><span class="hljs-string">it really need to delay in atomic context?&quot;</span> If so...<br><br>ATOMIC CONTEXT:<br>	You must use the *delay family of functions. These<br>	functions use the jiffie estimation of clock speed<br>	and will busy wait <span class="hljs-keyword">for</span> enough loop cycles to achieve<br>	the desired delay:<br><br>	ndelay(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nsecs)<br>	udelay(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> usecs)<br>	mdelay(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> msecs)<br><br>	udelay is the generally preferred API; ndelay-level<br>	precision may not actually exist on many non-PC devices.<br><br>	mdelay is macro wrapper around udelay, to account <span class="hljs-keyword">for</span><br>	possible overflow when passing large arguments to udelay.<br>	In general, use of mdelay is discouraged and code should<br>	be refactored to allow <span class="hljs-keyword">for</span> the use of msleep.<br><br>NON-ATOMIC CONTEXT:<br>	You should use the *sleep[_range] family of functions.<br>	There are a few more options here, <span class="hljs-keyword">while</span> any of them may<br>	work correctly, using the <span class="hljs-string">&quot;right&quot;</span> sleep function will<br>	help the scheduler, power management, and just make your<br>	driver better :)<br><br>	-- Backed by busy-wait loop:<br>		udelay(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> usecs)<br>	-- Backed by hrtimers:<br>		usleep_range(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> max)<br>	-- Backed by jiffies / legacy_timers<br>		<span class="hljs-title function_">msleep</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> msecs)</span><br>		<span class="hljs-title function_">msleep_interruptible</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> msecs)</span><br><br>	Unlike the *delay family, the underlying mechanism<br>	driving each of these calls varies, thus there are<br>	quirks you should be aware of.<br><br><br>	SLEEPING FOR &quot;A FEW&quot; <span class="hljs-title function_">USECS</span> <span class="hljs-params">( &lt; ~<span class="hljs-number">10u</span>s? )</span>:<br>		* Use udelay<br><br>		- Why not usleep?<br>			On slower systems, <span class="hljs-params">(embedded, OR perhaps a speed-</span><br><span class="hljs-params">			stepped PC!)</span> the overhead of setting up the hrtimers<br>			<span class="hljs-keyword">for</span> usleep *may* not be worth it. Such an evaluation<br>			will obviously depend on your specific situation, but<br>			it is something to be aware of.<br><br>	SLEEPING FOR ~USECS OR SMALL <span class="hljs-title function_">MSECS</span> <span class="hljs-params">( <span class="hljs-number">10u</span>s - <span class="hljs-number">20</span>ms)</span>:<br>		* Use usleep_range<br><br>		- Why not msleep <span class="hljs-title function_">for</span> <span class="hljs-params">(<span class="hljs-number">1</span>ms - <span class="hljs-number">20</span>ms)</span>?<br>			Explained originally here:<br>				http:<span class="hljs-comment">//lkml.org/lkml/2007/8/3/250</span><br>			<span class="hljs-title function_">msleep</span><span class="hljs-params">(<span class="hljs-number">1</span>~<span class="hljs-number">20</span>)</span> may not <span class="hljs-keyword">do</span> what the caller intends, and<br>			will often sleep <span class="hljs-title function_">longer</span> <span class="hljs-params">(~<span class="hljs-number">20</span> ms actual sleep <span class="hljs-keyword">for</span> any</span><br><span class="hljs-params">			value given in the <span class="hljs-number">1</span>~<span class="hljs-number">20</span>ms range)</span>. In many cases this<br>			is not the desired behavior.<br><br>		- Why is there no &quot;usleep&quot; / What is a good range?<br>			Since usleep_range is built on top of hrtimers, the<br>			wakeup will be very <span class="hljs-title function_">precise</span> <span class="hljs-params">(ish)</span>, thus a simple<br>			usleep function would likely introduce a large number<br>			of undesired interrupts.<br><br>			With the introduction of a range, the scheduler is<br>			<span class="hljs-built_in">free</span> to coalesce your wakeup with any other wakeup<br>			that may have happened <span class="hljs-keyword">for</span> other reasons, or at the<br>			worst <span class="hljs-keyword">case</span>, fire an interrupt <span class="hljs-keyword">for</span> your upper bound.<br><br>			The larger a range you supply, the greater a chance<br>			that you will not trigger an interrupt; this should<br>			be balanced with what is an acceptable upper bound on<br>			delay / performance <span class="hljs-keyword">for</span> your specific code path. Exact<br>			tolerances here are very situation specific, thus it<br>			is left to the caller to determine a reasonable range.<br><br>	SLEEPING FOR LARGER <span class="hljs-title function_">MSECS</span> <span class="hljs-params">( <span class="hljs-number">10</span>ms+ )</span><br>		* Use msleep or possibly msleep_interruptible<br><br>		- What&#x27;s the difference?<br>			msleep sets the current task to TASK_UNINTERRUPTIBLE<br>			whereas msleep_interruptible sets the current task to<br>			TASK_INTERRUPTIBLE before scheduling the sleep. In<br>			<span class="hljs-type">short</span>, the difference is whether the sleep can be ended<br>			early by a signal. In general, just use msleep unless<br>			you know you have a need <span class="hljs-keyword">for</span> the interruptible variant.<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/450089796">一文入门linux内核高精度定时器hrtimer机制</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/myz348/article/details/117712008">usleep_range()函数</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kaosine/p/13066811.html">LINUX内核中使用USLEEP_RANGE(MIN, MAX)的注意事项</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoahong/p/10802102.html">上下文切换</a></p>
<blockquote>
<p>根据 Tsuna 的测试报告，每次上下文切换都需要几十纳秒到到微秒的CPU时间，这些时间对CPU来说，<br>就好比人类对1分钟或10分钟的感觉概念。在分秒必争的计算机处理环境下，浪费太多时间在切换上，<br>只能会降低真正处理任务的时间，表象上导致延时、排队、卡顿现象发生。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/f721247f4e3d4042bfac17813b6aebe5.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="二十四-奇怪的255扇区"><a href="#二十四-奇怪的255扇区" class="headerlink" title="二十四 奇怪的255扇区"></a>二十四 奇怪的255扇区</h2><p><a href="https://www.jiasun.top/blog/fio%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98.html">fio引发的一些问题</a></p>
<h2 id="二十五-内核调试工具-crash"><a href="#二十五-内核调试工具-crash" class="headerlink" title="二十五 内核调试工具 crash"></a>二十五 内核调试工具 crash</h2><p><a href="https://www.jiasun.top/blog/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7crash%E4%BD%BF%E7%94%A8.html">内核调试工具crash使用</a></p>
<h2 id="二十六-未知的bug"><a href="#二十六-未知的bug" class="headerlink" title="二十六 未知的bug"></a>二十六 未知的bug</h2><p>&emsp;编写的块设备驱动在运行fio测试时电脑会卡死，鼠标动不了，键盘没反应。本来以为有了crash这个工具后一切bug都会迎刃而解，但实际上并没有任何变化，并没有自动重启，&#x2F;var&#x2F;crash也没有任何新增文件。<br>&emsp;那是不是crash并没有成功安装呢？ 就像<a href="https://www.jiasun.top/blog/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7crash%E4%BD%BF%E7%94%A8.html">内核调试工具crash使用</a>一样，自己写一个bug，在请求大小为100k时设置req为空。然后进行fio测试，bs&#x3D;100k时内核panic，自动重启，&#x2F;var&#x2F;crash目录下新增相关的文件，证明crash还是有效的。<br>&emsp;买了一本《Debug Hacks中文版—深入调试的技术和工具》影印版，只要16块钱，看了看相关博客：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Longyu_wlz/article/details/126565853">解读内核 sysctl 配置中 panic、oops 相关项目</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/whatday/article/details/88016972">Linux Watchdog 机制</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/choumin/article/details/111307946">使用sysctl配置内核参数</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaoxinfan/article/details/125054064">FT2000+模块在麒麟系统下串口输出功能调试</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xingmuxin/p/9023505.html">每日一小时linux(1)–sysRq</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7120196858613350430">【开发工具】【sysrq】魔术键（sysRq）的使用</a><br><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15015138/2556920">宋宝华： Kernel Oops和Panic是一回事吗？</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42837669/article/details/117968045">串口通信简介——发展历史与基本概念</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lpwsw/article/details/120153643">linux下查看与设置串口（或串口终端）信息和属性</a></p>
<p>&emsp;我想到了3个找到bug的途径：① 将串口输出至另一台主机 ② 开启watchdog功能 ③ sysrq魔术键</p>
<p>首先是串口打印，飞腾主板上是RS232（DB9）接口的串口，刚开始没找到相应的串口线，后面使用一个双母线+RS232转usb线连接到笔记本，但ttyS0一直没反应，相关命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash"> dmesg | grep ttyS0<br>[    0.946297] 00:04: ttyS0 at I/O 0x3f8 (irq = 4, base_baud = 115200) is a 16550A<br> <br><span class="hljs-built_in">cat</span> /proc/tty/driver/serial<br>serinfo:1.0 driver revision:<br>0: uart:16550A port:000003F8 irq:4 tx:64 rx:0 RTS|CTS|DTR|DSR|CD<br>1: uart:unknown port:000002F8 irq:3<br>2: uart:unknown port:000003E8 irq:4<br>3: uart:unknown port:000002E8 irq:3<br>4: uart:unknown port:00000000 irq:0<br>5: uart:unknown port:00000000 irq:0<br>6: uart:unknown port:00000000 irq:0<br>7: uart:unknown port:00000000 irq:0<br>8: uart:unknown port:00000000 irq:0<br>9: uart:unknown port:00000000 irq:0<br><br><span class="hljs-built_in">cat</span> /proc/tty/drivers<br>/dev/tty             /dev/tty        5       0 system:/dev/tty<br>/dev/console         /dev/console    5       1 system:console<br>/dev/ptmx            /dev/ptmx       5       2 system<br>/dev/vc/0            /dev/vc/0       4       0 system:vtmaster<br>ttyprintk            /dev/ttyprintk   5       3 console<br>max310x              /dev/ttyMAX   204 209-224 serial<br>serial               /dev/ttyS       4 64-111 serial<br>pty_slave            /dev/pts      136 0-1048575 pty:slave<br>pty_master           /dev/ptm      128 0-1048575 pty:master<br>unknown              /dev/tty        4 1-63 console<br><br><br>可以用<span class="hljs-built_in">stty</span>指令，查看或设置某个串口的波特率等信息。<br><br>用<span class="hljs-built_in">stty</span>查看串口参数：       <span class="hljs-built_in">stty</span> -F /dev/ttySn -a          <span class="hljs-comment">#ttySn为要查看的串口</span><br><br>用<span class="hljs-built_in">stty</span>设置串口参数：       <br><br><span class="hljs-built_in">stty</span> -F /dev/ttyS0 ispeed 115200 ospeed 115200 cs8 -parenb -cstopb  -<span class="hljs-built_in">echo</span><br>该命令将串口1（/dev/ttyS0）输入输出都设置成115200波特率，8位数据模式，<br><br>奇偶校验位-parenb，停止位-cstopb,同时-<span class="hljs-built_in">echo</span>禁止终端回显。<br><br>一般情况下设置波特率和数据模式这两个参数就可以了，如果显示数据乱码，可能还需要设置其它参数，使用man查看<span class="hljs-built_in">stty</span>其它设置选项。<br></code></pre></td></tr></table></figure>
<p>问了问客服，换成ttyAMA1接口，好像arm的就是ttyAMA1<br>使用stty -F &#x2F;dev&#x2F;ttyAMA1 -a查看波特率<br><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/307390/what-is-the-difference-between-ttys0-ttyusb0-and-ttyama0-in-linux">What is the difference between ttyS0, ttyUSB0 and ttyAMA0 in Linux?</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ttyS0 is the device <span class="hljs-keyword">for</span> the first UART serial port on x86 and x86_64 architectures. If you have a PC motherboard with serial ports you<span class="hljs-string">&#x27;d be using a ttySn to attach a modem or a serial console.</span><br><span class="hljs-string">ttyUSB0 is the device for the first USB serial convertor. If you have an USB serial cable you&#x27;</span>d be using a ttyUSBn to connect to the serial port of a router.<br>ttyAMA0 is the device <span class="hljs-keyword">for</span> the first serial port on ARM architecture. If you have an ARM-based TV box with a serial console and running Android or OpenELEC, you<span class="hljs-string">&#x27;d be using a ttyAMAn to attach a console to it.</span><br></code></pre></td></tr></table></figure>
<p>虽然现在串口可以用了，但修改启动选项更改console一直没有生效，好像一直是printk：ttyAMA0 enabled，暂时放弃该方法。</p>
<p>而后尝试第二个方法，watchdog。理论上只有Hardlockup中断不可响应，sysrq魔术键也无法生效，故只需要把SoftLockup检测机制，Hardlockup检测机制都打开，并且设置lockup时panic应该所有问题都能解决吧。<br>linux虚拟机相关内核编译选项<br><img src="https://img-blog.csdnimg.cn/9a4dadd6118e447b9c5b0116f23a3705.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/3961c63acffc46f88653be6e939cd073.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> /proc/sys/kernel/ | grep <span class="hljs-string">&quot;watchdog&quot;</span><br>nmi_watchdog<br>soft_watchdog<br>watchdog<br>watchdog_cpumask<br>watchdog_thresh<br><br><span class="hljs-built_in">ls</span> /proc/sys/kernel/ | grep <span class="hljs-string">&quot;panic&quot;</span><br>hardlockup_panic<br>hung_task_panic<br>panic<br>panic_on_io_nmi<br>panic_on_oops<br>panic_on_rcu_stall<br>panic_on_unrecovered_nmi<br>panic_on_warn<br>panic_print<br>softlockup_panic<br>unknown_nmi_panic<br></code></pre></td></tr></table></figure>


<p>但问题是在麒麟系统+飞腾处理器的主机上显示的结果不是这样，grep “watchdog”没有任何显示。出师未捷身先死！ 看了看系统的config，只开启了softlockup detector选项，<strong>竟然没有hardlockup detector选项</strong>，只能感慨一句国产的真是好啊！ watchdog方法胎死腹中。</p>
<p>第三个方法sysrq实际上我已经预感到没啥用了，cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sysrq刚开始显示176，后在 &#x2F;etc&#x2F;sysctl.conf中写入kernel.sysrq&#x3D;1，正常使用电脑时使用alt+sysrq+c确实能自动重启，但当电脑卡死时sysrq键没有任何反应，失败！</p>
<p>既然以上3个方法都没啥用，就尝试其他方法：① 重新编译内核 ② 查看块设备固件代码 ③ 寻找正确设置串口打印的方法</p>
<p>麒麟操作系统切换内核有太多不可控的因素了，之前切换内核后全是问题，如果不是实在没办法了都不想动内核一点。设备固件代码调试起来比较麻烦，修改后还要烧录，比较耗时。至于串口，打算使用vmware来实验一下串口功能，可惜vmware好像不能虚拟arm的主机，而且我有点怀疑<strong>卡死的时候真有内核打印吗？</strong></p>
<p>解决问题的路上总是有一系列失败的尝试，但我认为这些经历比那些成功的经历更有意义！</p>
<p><strong>串口虚拟机测试</strong><br>使用输出文件的方式使用vmware的串口 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33406883/article/details/106549466">VMware虚拟串口的设置与使用</a><br>发现新增的串口是ttyS1而不是ttyS0<br>修改&#x2F;etc&#x2F;default&#x2F;grub</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GRUB_CMDLINE_LINUX_DEFAULT=<span class="hljs-string">&quot;quiet splash console=ttyS1,115200 debug loglevel=7&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 修改grub前</span><br>dmesg | grep console<br>[    0.171761] printk: console [tty0] enabled<br>[    3.699707] systemd[1]: Starting Set the console keyboard layout...<br><br><span class="hljs-comment"># 修改grub后</span><br>dmesg | grep console<br>[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-5.4.0 root=UUID=5a55429a-0931-4339-814e-a532007c5cc4 ro quiet splash console=ttyS1,115200 debug loglevel=7 crashkernel=512M-:192M<br>[    0.096099] Kernel <span class="hljs-built_in">command</span> line: BOOT_IMAGE=/boot/vmlinuz-5.4.0 root=UUID=5a55429a-0931-4339-814e-a532007c5cc4 ro quiet splash console=ttyS1,115200 debug loglevel=7 crashkernel=512M-:192M<br>[    1.144103] printk: console [ttyS1] enabled<br>[    7.214703] systemd-sysv-generator[408]: Native unit <span class="hljs-keyword">for</span> console-setup.service already exists, skipping.<br>[    7.225267] systemd-sysv-generator[408]: Ignoring S01console-setup.sh symlink <span class="hljs-keyword">in</span> rc2.d, not generating console-setup.service.<br>[    7.225654] systemd-sysv-generator[408]: Ignoring S01console-setup.sh symlink <span class="hljs-keyword">in</span> rc3.d, not generating console-setup.service.<br>[    7.225979] systemd-sysv-generator[408]: Ignoring S01console-setup.sh symlink <span class="hljs-keyword">in</span> rc4.d, not generating console-setup.service.<br>[    7.226323] systemd-sysv-generator[408]: Ignoring S01console-setup.sh symlink <span class="hljs-keyword">in</span> rc5.d, not generating console-setup.service.<br>[    7.231177] systemd[1]: unit_file_build_name_map: normal unit file: /lib/systemd/system/console-getty.service<br></code></pre></td></tr></table></figure>
<p>串口的输出文件显示了内核打印信息<br><img src="https://img-blog.csdnimg.cn/d7811b86dfae49aa984e7db7e261386a.png" srcset="/img/loading.gif" lazyload></p>
<p>所以说什么时候输出了printk: console [ttyAMA1] enabled，什么时候我的串口设置就成功了</p>
<p><mark>可惜没找到方法，不论怎么设置都是printk: console [ttyAMA0] enabled，无奈</mark></p>
<p>既然找不到问题原因，就只能大刀阔斧重构代码了，就当刚开始写代码，重新写一份再修bug</p>
<p>———————-很久之后的更新—————</p>
<p>实习几个月后回来继续搞项目，发现之前的主机卡死问题再也没有出现了，而驱动代码并没有任何改变，合理推测主机卡死问题是由设备固件方面导致的。调试方法对应程序开发来说真的很重要！！！</p>
<h2 id="二十七-测量驱动执行时间"><a href="#二十七-测量驱动执行时间" class="headerlink" title="二十七 测量驱动执行时间"></a>二十七 测量驱动执行时间</h2><p>参考博客：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/21cnbao/article/details/79156953">宋宝华：关于Ftrace的一个完整案例</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lssbq/article/details/73497079">perf-tools</a></p>
<p>一般驱动开发到最后都会有测试驱动各部分执行时间，找到性能瓶颈的需求，实际上perf-tools中的funcgraph就够用了，在nvme驱动nvme_queue_rq函数中插入dump_stack，使用fio测试，获取函数调用栈（可以采用<a href="https://www.jiasun.top/blog/fio%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98.html">fio引发的一些问题</a>中的方法在虚拟机中测试），然后找一个上层函数监听即可（例如aio_write）</p>
<p>libaio引擎</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">[  +<span class="hljs-number">0.000000</span>] Hardware name: VMware, Inc. VMware Virtual Platform/<span class="hljs-number">440B</span>X Desktop Reference Platform, BIOS <span class="hljs-number">6.00</span> <span class="hljs-number">07</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2020</span><br>[  +<span class="hljs-number">0.000001</span>] Call Trace:<br>[  +<span class="hljs-number">0.000001</span>]  dump_stack+<span class="hljs-number">0x6d</span>/<span class="hljs-number">0x9a</span><br>[  +<span class="hljs-number">0.000002</span>]  nvme_queue_rq.cold+<span class="hljs-number">0x28</span>/<span class="hljs-number">0x97</span> [nvme]<br>[  +<span class="hljs-number">0.000002</span>]  __blk_mq_try_issue_directly+<span class="hljs-number">0x116</span>/<span class="hljs-number">0x1c0</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_request_issue_directly+<span class="hljs-number">0x4b</span>/<span class="hljs-number">0xe0</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_try_issue_list_directly+<span class="hljs-number">0x46</span>/<span class="hljs-number">0xb0</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_sched_insert_requests+<span class="hljs-number">0xae</span>/<span class="hljs-number">0x100</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_flush_plug_list+<span class="hljs-number">0x1e8</span>/<span class="hljs-number">0x290</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_flush_plug_list+<span class="hljs-number">0xe3</span>/<span class="hljs-number">0x110</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_finish_plug+<span class="hljs-number">0x26</span>/<span class="hljs-number">0x34</span><br>[  +<span class="hljs-number">0.000001</span>]  blkdev_write_iter+<span class="hljs-number">0xbd</span>/<span class="hljs-number">0x140</span><br>[  +<span class="hljs-number">0.000001</span>]  aio_write+<span class="hljs-number">0xec</span>/<span class="hljs-number">0x1a0</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __switch_to_asm+<span class="hljs-number">0x40</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __check_object_size+<span class="hljs-number">0x5d</span>/<span class="hljs-number">0x150</span><br>[  +<span class="hljs-number">0.000001</span>]  ? _copy_to_user+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x30</span><br>[  +<span class="hljs-number">0.000001</span>]  ? aio_read_events+<span class="hljs-number">0x215</span>/<span class="hljs-number">0x320</span><br>[  +<span class="hljs-number">0.000001</span>]  ? _cond_resched+<span class="hljs-number">0x19</span>/<span class="hljs-number">0x30</span><br>[  +<span class="hljs-number">0.000001</span>]  ? io_submit_one+<span class="hljs-number">0x7b</span>/<span class="hljs-number">0xb50</span><br>[  +<span class="hljs-number">0.000001</span>]  io_submit_one+<span class="hljs-number">0x449</span>/<span class="hljs-number">0xb50</span><br>[  +<span class="hljs-number">0.000000</span>]  ? wait_woken+<span class="hljs-number">0x80</span>/<span class="hljs-number">0x80</span><br>[  +<span class="hljs-number">0.000002</span>]  __x64_sys_io_submit+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x180</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __x64_sys_io_submit+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x180</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __x64_sys_io_getevents+<span class="hljs-number">0x5f</span>/<span class="hljs-number">0xb0</span><br>[  +<span class="hljs-number">0.000001</span>]  ? exit_to_usermode_loop+<span class="hljs-number">0x8f</span>/<span class="hljs-number">0x160</span><br>[  +<span class="hljs-number">0.000001</span>]  do_syscall_64+<span class="hljs-number">0x57</span>/<span class="hljs-number">0x190</span><br>[  +<span class="hljs-number">0.000001</span>]  entry_SYSCALL_64_after_hwframe+<span class="hljs-number">0x44</span>/<span class="hljs-number">0xa9</span><br>[  +<span class="hljs-number">0.000000</span>] RIP: <span class="hljs-number">0033</span>:<span class="hljs-number">0x7f27ccbd473d</span><br></code></pre></td></tr></table></figure>



<p>sync引擎</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">[  +<span class="hljs-number">0.000001</span>] Hardware name: VMware, Inc. VMware Virtual Platform/<span class="hljs-number">440B</span>X Desktop Reference Platform, BIOS <span class="hljs-number">6.00</span> <span class="hljs-number">07</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2020</span><br>[  +<span class="hljs-number">0.000001</span>] Workqueue: kblockd blk_mq_run_work_fn<br>[  +<span class="hljs-number">0.000001</span>] Call Trace:<br>[  +<span class="hljs-number">0.000001</span>]  dump_stack+<span class="hljs-number">0x6d</span>/<span class="hljs-number">0x9a</span><br>[  +<span class="hljs-number">0.000002</span>]  nvme_queue_rq.cold+<span class="hljs-number">0x5</span>/<span class="hljs-number">0xa</span> [nvme]<br>[  +<span class="hljs-number">0.000002</span>]  blk_mq_dispatch_rq_list+<span class="hljs-number">0x93</span>/<span class="hljs-number">0x550</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000000</span>]  ? __switch_to_asm+<span class="hljs-number">0x40</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000001</span>]  ? blk_mq_flush_busy_ctxs+<span class="hljs-number">0x18d</span>/<span class="hljs-number">0x1c0</span><br>[  +<span class="hljs-number">0.000002</span>]  blk_mq_sched_dispatch_requests+<span class="hljs-number">0x162</span>/<span class="hljs-number">0x180</span><br>[  +<span class="hljs-number">0.000001</span>]  __blk_mq_run_hw_queue+<span class="hljs-number">0x5a</span>/<span class="hljs-number">0x110</span><br>[  +<span class="hljs-number">0.000000</span>]  blk_mq_run_work_fn+<span class="hljs-number">0x1b</span>/<span class="hljs-number">0x20</span><br>[  +<span class="hljs-number">0.000002</span>]  process_one_work+<span class="hljs-number">0x1eb</span>/<span class="hljs-number">0x3b0</span><br>[  +<span class="hljs-number">0.000000</span>]  worker_thread+<span class="hljs-number">0x4d</span>/<span class="hljs-number">0x400</span><br>[  +<span class="hljs-number">0.000002</span>]  kthread+<span class="hljs-number">0x104</span>/<span class="hljs-number">0x140</span><br>[  +<span class="hljs-number">0.000001</span>]  ? process_one_work+<span class="hljs-number">0x3b0</span>/<span class="hljs-number">0x3b0</span><br>[  +<span class="hljs-number">0.000001</span>]  ? kthread_park+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x90</span><br>[  +<span class="hljs-number">0.000001</span>]  ret_from_fork+<span class="hljs-number">0x22</span>/<span class="hljs-number">0x40</span><br></code></pre></td></tr></table></figure>
<p>选择aio_write作为监听函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">./kernel/funcgraph aio_write &gt; write.txt<br>Tracing <span class="hljs-string">&quot;aio_write&quot;</span>... Ctrl-C to end.<br>   1)               |  <span class="hljs-function"><span class="hljs-title">aio_write</span></span>() &#123;<br>   1)   ==========&gt; |<br>   1)               |    <span class="hljs-function"><span class="hljs-title">smp_irq_work_interrupt</span></span>() &#123;<br>   1)               |      <span class="hljs-function"><span class="hljs-title">irq_enter</span></span>() &#123;<br>   1)   0.121 us    |        rcu_irq_enter();<br>   1)   0.391 us    |      &#125;<br>   1)               |      <span class="hljs-function"><span class="hljs-title">__wake_up</span></span>() &#123;<br>   1)               |        <span class="hljs-function"><span class="hljs-title">__wake_up_common_lock</span></span>() &#123;<br>   1)   0.091 us    |          _raw_spin_lock_irqsave();<br>   1)               |          <span class="hljs-function"><span class="hljs-title">__wake_up_common</span></span>() &#123;<br>   1)               |            <span class="hljs-function"><span class="hljs-title">autoremove_wake_function</span></span>() &#123;<br>   1)               |              <span class="hljs-function"><span class="hljs-title">default_wake_function</span></span>() &#123;<br>   1)               |                <span class="hljs-function"><span class="hljs-title">try_to_wake_up</span></span>() &#123;<br>   1)   0.091 us    |                  _raw_spin_lock_irqsave();<br>   1)               |                  <span class="hljs-function"><span class="hljs-title">select_task_rq_fair</span></span>() &#123;<br>   1)               |                    <span class="hljs-function"><span class="hljs-title">select_idle_sibling</span></span>() &#123;<br>   1)   0.101 us    |                      available_idle_cpu();<br>   1)   0.341 us    |                    &#125;<br>   1)   0.591 us    |                  &#125;<br>   1)   0.091 us    |                  _raw_spin_lock();<br>   1)   0.210 us    |                  update_rq_clock();<br>   1)               |                  <span class="hljs-function"><span class="hljs-title">ttwu_do_activate</span></span>() &#123;<br>   1)               |                    <span class="hljs-function"><span class="hljs-title">activate_task</span></span>() &#123;<br>   1)               |                      <span class="hljs-function"><span class="hljs-title">psi_task_change</span></span>() &#123;<br>   1)   0.100 us    |                        record_times();<br>   1)   0.260 us    |                        record_times();<br>   1)   0.231 us    |                        record_times();<br>   1)   0.100 us    |                        record_times();<br>   1)   1.533 us    |                      &#125;<br>   ...<br></code></pre></td></tr></table></figure>
<p>也可以考虑使用ktime_get_ns函数手动计算各函数执行时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ktime_t</span> <span class="hljs-title function_">ktime_get</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>CLOCK_MONOTONIC<br><br>Useful <span class="hljs-keyword">for</span> reliable timestamps and measuring <span class="hljs-type">short</span> time intervals accurately. Starts at system boot time but stops during suspend.<br><br><span class="hljs-type">ktime_t</span> <span class="hljs-title function_">ktime_get_boottime</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>CLOCK_BOOTTIME<br><br>Like <span class="hljs-title function_">ktime_get</span><span class="hljs-params">()</span>, but does not stop when suspended. This can be used e.g. <span class="hljs-keyword">for</span> key expiration times that need to be synchronized with other machines across a suspend operation.<br><br><span class="hljs-type">ktime_t</span> <span class="hljs-title function_">ktime_get_real</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>CLOCK_REALTIME<br><br>Returns the time in relative to the UNIX epoch starting in 1970 using the Coordinated Universal <span class="hljs-title function_">Time</span> <span class="hljs-params">(UTC)</span>, same as <span class="hljs-title function_">gettimeofday</span><span class="hljs-params">()</span> user space. This is used <span class="hljs-keyword">for</span> all timestamps that need to persist across a reboot, like inode times, but should be avoided <span class="hljs-keyword">for</span> internal uses, since it can jump backwards due to a leap second update, NTP adjustment <span class="hljs-title function_">settimeofday</span><span class="hljs-params">()</span> operation from user space.<br><br><span class="hljs-type">ktime_t</span> <span class="hljs-title function_">ktime_get_clocktai</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>CLOCK_TAI<br><br>Like <span class="hljs-title function_">ktime_get_real</span><span class="hljs-params">()</span>, but uses the International Atomic <span class="hljs-title function_">Time</span> <span class="hljs-params">(TAI)</span> reference instead of UTC to avoid jumping on leap second updates. This is rarely useful in the kernel.<br><br><span class="hljs-type">ktime_t</span> <span class="hljs-title function_">ktime_get_raw</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>CLOCK_MONOTONIC_RAW<br><br>Like <span class="hljs-title function_">ktime_get</span><span class="hljs-params">()</span>, but runs at the same rate as the hardware clocksource <span class="hljs-title function_">without</span> <span class="hljs-params">(NTP)</span> adjustments <span class="hljs-keyword">for</span> clock drift. This is also rarely needed in the kernel.<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/core-api/timekeeping.html">https://www.kernel.org/doc/html/latest/core-api/timekeeping.html</a></p>
<p>也可以考虑使用控制变量法，例如对应驱动内存拷贝时间占比，可以注释掉拷贝语句，然后测试性能，计算之间的差值。</p>
<p>测试preempt_count，BUG_ON(), WARN_ON()和panic()，dump_stack常用调试函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (blk_rq_bytes(req) == <span class="hljs-number">100</span> * <span class="hljs-number">1024</span>) &#123;<br>	dump_stack();<br>&#125;<br>BUG_ON(blk_rq_bytes(req) == <span class="hljs-number">101</span> * <span class="hljs-number">1024</span>);<br>WARN_ON(blk_rq_bytes(req) == <span class="hljs-number">102</span> * <span class="hljs-number">1024</span>);<br>printk(KERN_WARNING <span class="hljs-string">&quot;nvme_queue_rq preempt_count:%d&quot;</span>, preempt_count());<br></code></pre></td></tr></table></figure>


<p>BUG_ON输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c">[  <span class="hljs-number">361.694454</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.694464</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.694476</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.694503</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695012</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695434</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695448</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695451</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695456</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695473</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695479</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695490</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.695499</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.697490</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.697516</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.697529</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.697539</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.697598</span>] nvme_queue_rq preempt_count:<span class="hljs-number">0</span><br>[  <span class="hljs-number">361.769666</span>] ------------[ cut here ]------------<br>[  <span class="hljs-number">361.769668</span>] kernel BUG at /root/kernel/linux<span class="hljs-number">-5.4</span>/drivers/nvme/host/pci.c:<span class="hljs-number">934</span>!<br>[  <span class="hljs-number">361.769676</span>] invalid opcode: <span class="hljs-number">0000</span> [#<span class="hljs-number">1</span>] SMP NOPTI<br>[  <span class="hljs-number">361.769678</span>] CPU: <span class="hljs-number">0</span> PID: <span class="hljs-number">356</span> Comm: kworker/<span class="hljs-number">0</span>:<span class="hljs-number">1</span>H Kdump: loaded Tainted: G        W  OE     <span class="hljs-number">5.4</span><span class="hljs-number">.0</span> #<span class="hljs-number">1</span><br>[  <span class="hljs-number">361.769679</span>] Hardware name: VMware, Inc. VMware Virtual Platform/<span class="hljs-number">440B</span>X Desktop Reference Platform, BIOS <span class="hljs-number">6.00</span> <span class="hljs-number">07</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2020</span><br>[  <span class="hljs-number">361.769684</span>] Workqueue: kblockd blk_mq_run_work_fn<br>[  <span class="hljs-number">361.769688</span>] RIP: <span class="hljs-number">0010</span>:nvme_queue_rq+<span class="hljs-number">0x13d</span>/<span class="hljs-number">0x1d0</span> [nvme]<br>[  <span class="hljs-number">361.769689</span>] Code: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 ff <span class="hljs-number">74</span> <span class="hljs-number">24</span> <span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> a0 <span class="hljs-number">41</span> <span class="hljs-number">81</span> <span class="hljs-number">7</span>c <span class="hljs-number">24</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">90</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0f</span> <span class="hljs-number">84</span> <span class="hljs-number">4</span>d <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">41</span> <span class="hljs-number">81</span> <span class="hljs-number">7</span>c <span class="hljs-number">24</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">94</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0f</span> <span class="hljs-number">85</span> <span class="hljs-number">48</span> <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> &lt;<span class="hljs-number">0f</span>&gt; <span class="hljs-number">0b</span> <span class="hljs-number">4</span>c <span class="hljs-number">89</span> e6 <span class="hljs-number">4</span>c <span class="hljs-number">89</span> ff <span class="hljs-number">41</span> bd <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e8 f0 d8 ff ff <span class="hljs-number">4</span>c <span class="hljs-number">89</span> e7<br>[  <span class="hljs-number">361.769690</span>] RSP: <span class="hljs-number">0018</span>:ffffb9f900af7cd8 EFLAGS: <span class="hljs-number">00010246</span><br>[  <span class="hljs-number">361.769691</span>] RAX: <span class="hljs-number">0000000000008801</span> RBX: ffffb9f900af7d98 RCX: ffffeb84c6c27c80<br>[  <span class="hljs-number">361.769692</span>] RDX: <span class="hljs-number">0000000000000000</span> RSI: <span class="hljs-number">0000000000000000</span> RDI: ffff905f20db2060<br>[  <span class="hljs-number">361.769692</span>] RBP: ffffb9f900af7d48 R08: ffff905f20db2080 R09: <span class="hljs-number">00000001b</span>09f9000<br>[  <span class="hljs-number">361.769693</span>] R10: ffff905f20db20a0 R11: ffff905f00228000 R12: ffff905ec515c780<br>[  <span class="hljs-number">361.769694</span>] R13: <span class="hljs-number">0000000000000000</span> R14: ffff905ec55a0100 R15: ffff905f0e2a8000<br>[  <span class="hljs-number">361.769695</span>] FS:  <span class="hljs-number">0000000000000000</span>(<span class="hljs-number">0000</span>) GS:ffff905f2f000000(<span class="hljs-number">0000</span>) knlGS:<span class="hljs-number">0000000000000000</span><br>[  <span class="hljs-number">361.769695</span>] CS:  <span class="hljs-number">0010</span> DS: <span class="hljs-number">0000</span> ES: <span class="hljs-number">0000</span> CR0: <span class="hljs-number">0000000080050033</span><br>[  <span class="hljs-number">361.769696</span>] CR2: <span class="hljs-number">00007f</span>f8baf2f024 CR3: <span class="hljs-number">000000033</span>ea30000 CR4: <span class="hljs-number">0000000000340</span>ef0<br>[  <span class="hljs-number">361.769719</span>] Call Trace:<br>[  <span class="hljs-number">361.769724</span>]  blk_mq_dispatch_rq_list+<span class="hljs-number">0x93</span>/<span class="hljs-number">0x550</span><br>[  <span class="hljs-number">361.769727</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  <span class="hljs-number">361.769728</span>]  ? __switch_to_asm+<span class="hljs-number">0x40</span>/<span class="hljs-number">0x70</span><br>[  <span class="hljs-number">361.769728</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  <span class="hljs-number">361.769729</span>]  ? blk_mq_flush_busy_ctxs+<span class="hljs-number">0x18d</span>/<span class="hljs-number">0x1c0</span><br>[  <span class="hljs-number">361.769731</span>]  blk_mq_sched_dispatch_requests+<span class="hljs-number">0x162</span>/<span class="hljs-number">0x180</span><br>[  <span class="hljs-number">361.769732</span>]  __blk_mq_run_hw_queue+<span class="hljs-number">0x5a</span>/<span class="hljs-number">0x110</span><br>[  <span class="hljs-number">361.769733</span>]  blk_mq_run_work_fn+<span class="hljs-number">0x1b</span>/<span class="hljs-number">0x20</span><br>[  <span class="hljs-number">361.769735</span>]  process_one_work+<span class="hljs-number">0x1eb</span>/<span class="hljs-number">0x3b0</span><br>[  <span class="hljs-number">361.769736</span>]  worker_thread+<span class="hljs-number">0x4d</span>/<span class="hljs-number">0x400</span><br>[  <span class="hljs-number">361.769738</span>]  kthread+<span class="hljs-number">0x104</span>/<span class="hljs-number">0x140</span><br>[  <span class="hljs-number">361.769739</span>]  ? process_one_work+<span class="hljs-number">0x3b0</span>/<span class="hljs-number">0x3b0</span><br>[  <span class="hljs-number">361.769740</span>]  ? kthread_park+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x90</span><br>[  <span class="hljs-number">361.769741</span>]  ret_from_fork+<span class="hljs-number">0x22</span>/<span class="hljs-number">0x40</span><br>[  <span class="hljs-number">361.769743</span>] Modules linked in: nvme(OE) nvme_core(OE) xt_conntrack xt_MASQUERADE nf_conntrack_netlink nfnetlink xfrm_user xfrm_algo xt_addrtype iptable_filter iptable_nat nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 libcrc32c bpfilter br_netfilter bridge stp llc overlay vmw_vsock_vmci_transport vsock nls_iso8859_1 crct10dif_pclmul ghash_clmulni_intel snd_ens1371 snd_ac97_codec gameport ac97_bus snd_pcm aesni_intel crypto_simd cryptd glue_helper snd_seq_midi snd_seq_midi_event snd_rawmidi binfmt_misc snd_seq vmw_balloon snd_seq_device input_leds joydev snd_timer serio_raw snd soundcore vmw_vmci mac_hid sch_fq_codel vmwgfx ttm drm_kms_helper drm fb_sys_fops syscopyarea sysfillrect sysimgblt msr parport_pc ramoops ppdev lp parport reed_solomon efi_pstore ip_tables x_tables autofs4 hid_generic usbhid hid crc32_pclmul mptspi mptscsih mptbase psmouse e1000 scsi_transport_spi ahci libahci i2c_piix4 pata_acpi [last unloaded: nvme_core]<br></code></pre></td></tr></table></figure>




<p>WARN_ON输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">[  +<span class="hljs-number">0.000005</span>] WARNING: CPU: <span class="hljs-number">0</span> PID: <span class="hljs-number">355</span> at /root/kernel/linux<span class="hljs-number">-5.4</span>/drivers/nvme/host/pci.c:<span class="hljs-number">935</span> nvme_queue_rq+<span class="hljs-number">0xd3</span>/<span class="hljs-number">0x1d0</span> [nvme]<br>[  +<span class="hljs-number">0.000000</span>] Modules linked in: nvme(OE) nvme_core(OE) xt_conntrack xt_MASQUERADE nf_conntrack_netlink nfnetlink xfrm_user xfrm_algo xt_addrtype iptable_filter iptable_nat nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 libcrc32c bpfilter br_netfilter bridge stp llc overlay vmw_vsock_vmci_transport vsock nls_iso8859_1 crct10dif_pclmul ghash_clmulni_intel aesni_intel crypto_simd cryptd glue_helper snd_ens1371 snd_ac97_codec gameport ac97_bus snd_pcm snd_seq_midi snd_seq_midi_event vmw_balloon snd_rawmidi snd_seq binfmt_misc joydev input_leds snd_seq_device serio_raw snd_timer snd vmw_vmci soundcore mac_hid sch_fq_codel vmwgfx ttm drm_kms_helper drm fb_sys_fops syscopyarea sysfillrect sysimgblt msr parport_pc efi_pstore ppdev ramoops lp parport reed_solomon ip_tables x_tables autofs4 hid_generic usbhid hid crc32_pclmul psmouse mptspi mptscsih mptbase e1000 scsi_transport_spi ahci libahci i2c_piix4 pata_acpi [last unloaded: nvme_core]<br>[  +<span class="hljs-number">0.000025</span>] CPU: <span class="hljs-number">0</span> PID: <span class="hljs-number">355</span> Comm: kworker/<span class="hljs-number">0</span>:<span class="hljs-number">1</span>H Kdump: loaded Tainted: G        W  OE     <span class="hljs-number">5.4</span><span class="hljs-number">.0</span> #<span class="hljs-number">1</span><br>[  +<span class="hljs-number">0.000001</span>] Hardware name: VMware, Inc. VMware Virtual Platform/<span class="hljs-number">440B</span>X Desktop Reference Platform, BIOS <span class="hljs-number">6.00</span> <span class="hljs-number">07</span>/<span class="hljs-number">22</span>/<span class="hljs-number">2020</span><br>[  +<span class="hljs-number">0.000002</span>] Workqueue: kblockd blk_mq_run_work_fn<br>[  +<span class="hljs-number">0.000002</span>] RIP: <span class="hljs-number">0010</span>:nvme_queue_rq+<span class="hljs-number">0xd3</span>/<span class="hljs-number">0x1d0</span> [nvme]<br>[  +<span class="hljs-number">0.000001</span>] Code: <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">75</span> <span class="hljs-number">7</span>c <span class="hljs-number">41</span> <span class="hljs-number">8b</span> <span class="hljs-number">44</span> <span class="hljs-number">24</span> <span class="hljs-number">28</span> <span class="hljs-number">3</span>d <span class="hljs-number">00</span> <span class="hljs-number">90</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0f</span> <span class="hljs-number">84</span> be <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">3</span>d <span class="hljs-number">00</span> <span class="hljs-number">94</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0f</span> <span class="hljs-number">84</span> e2 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">3</span>d <span class="hljs-number">00</span> <span class="hljs-number">98</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0f</span> <span class="hljs-number">85</span> b7 <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> &lt;<span class="hljs-number">0f</span>&gt; <span class="hljs-number">0b</span> e9 b0 <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">41</span> bd <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">48</span> <span class="hljs-number">8b</span> <span class="hljs-number">45</span> d0 <span class="hljs-number">65</span> <span class="hljs-number">48</span> <span class="hljs-number">33</span> <span class="hljs-number">04</span> <span class="hljs-number">25</span><br>[  +<span class="hljs-number">0.000000</span>] RSP: <span class="hljs-number">0018</span>:ffffbd5b80aefcd0 EFLAGS: <span class="hljs-number">00010246</span><br>[  +<span class="hljs-number">0.000001</span>] RAX: <span class="hljs-number">0000000000019800</span> RBX: ffffbd5b80aefd98 RCX: <span class="hljs-number">0000000000018800</span><br>[  +<span class="hljs-number">0.000000</span>] RDX: <span class="hljs-number">0000000000000000</span> RSI: <span class="hljs-number">0000000000000000</span> RDI: ffff98adcadfa400<br>[  +<span class="hljs-number">0.000000</span>] RBP: ffffbd5b80aefd48 R08: ffff98ade7b19000 R09: <span class="hljs-number">00000001</span>c138f000<br>[  +<span class="hljs-number">0.000001</span>] R10: ffff98ade7b19020 R11: ffff98adcadfa300 R12: ffff98ad88ab0a80<br>[  +<span class="hljs-number">0.000000</span>] R13: <span class="hljs-number">0000000000000000</span> R14: ffff98ad87530100 R15: ffff98ade2d64000<br>[  +<span class="hljs-number">0.000001</span>] FS:  <span class="hljs-number">0000000000000000</span>(<span class="hljs-number">0000</span>) GS:ffff98adef000000(<span class="hljs-number">0000</span>) knlGS:<span class="hljs-number">0000000000000000</span><br>[  +<span class="hljs-number">0.000001</span>] CS:  <span class="hljs-number">0010</span> DS: <span class="hljs-number">0000</span> ES: <span class="hljs-number">0000</span> CR0: <span class="hljs-number">0000000080050033</span><br>[  +<span class="hljs-number">0.000000</span>] CR2: <span class="hljs-number">0000349586b</span>16000 CR3: <span class="hljs-number">0000000307660000</span> CR4: <span class="hljs-number">0000000000340</span>ef0<br>[  +<span class="hljs-number">0.000002</span>] Call Trace:<br>[  +<span class="hljs-number">0.000003</span>]  blk_mq_dispatch_rq_list+<span class="hljs-number">0x93</span>/<span class="hljs-number">0x550</span><br>[  +<span class="hljs-number">0.000002</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000000</span>]  ? __switch_to_asm+<span class="hljs-number">0x40</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000001</span>]  ? __switch_to_asm+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span><br>[  +<span class="hljs-number">0.000001</span>]  ? blk_mq_flush_busy_ctxs+<span class="hljs-number">0x18d</span>/<span class="hljs-number">0x1c0</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_sched_dispatch_requests+<span class="hljs-number">0x162</span>/<span class="hljs-number">0x180</span><br>[  +<span class="hljs-number">0.000001</span>]  __blk_mq_run_hw_queue+<span class="hljs-number">0x5a</span>/<span class="hljs-number">0x110</span><br>[  +<span class="hljs-number">0.000001</span>]  blk_mq_run_work_fn+<span class="hljs-number">0x1b</span>/<span class="hljs-number">0x20</span><br>[  +<span class="hljs-number">0.000001</span>]  process_one_work+<span class="hljs-number">0x1eb</span>/<span class="hljs-number">0x3b0</span><br>[  +<span class="hljs-number">0.000001</span>]  worker_thread+<span class="hljs-number">0x4d</span>/<span class="hljs-number">0x400</span><br>[  +<span class="hljs-number">0.000002</span>]  kthread+<span class="hljs-number">0x104</span>/<span class="hljs-number">0x140</span><br>[  +<span class="hljs-number">0.000000</span>]  ? process_one_work+<span class="hljs-number">0x3b0</span>/<span class="hljs-number">0x3b0</span><br>[  +<span class="hljs-number">0.000001</span>]  ? kthread_park+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x90</span><br>[  +<span class="hljs-number">0.000001</span>]  ret_from_fork+<span class="hljs-number">0x22</span>/<span class="hljs-number">0x40</span><br>[  +<span class="hljs-number">0.000001</span>] ---[ end trace a60efe659916a654 ]---<br></code></pre></td></tr></table></figure>

<h2 id="二十八-fio下发的请求大小不确定"><a href="#二十八-fio下发的请求大小不确定" class="headerlink" title="二十八 fio下发的请求大小不确定"></a>二十八 fio下发的请求大小不确定</h2><p><a href="https://www.jiasun.top/blog/fio%E4%B8%8B%E5%8F%91%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%A7%E5%B0%8F%E4%B8%8D%E7%A1%AE%E5%AE%9A.html">fio下发的请求大小不确定</a></p>
<p>通过设置max_segments参数值似乎解决了该问题</p>
<h2 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h2><ol>
<li>使用iperf测试tcp udp性能，使用tcpdump进行网络抓包，apt若由于其他软件锁死依赖，可删除不需要的软件再进行安装。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt autoremove<br>apt -f install<br>apt update<br>apt upgrade<br></code></pre></td></tr></table></figure></li>
<li>不同网卡ip最好位于不同的网段，不然会引起许多奇奇怪怪的问题。+</li>
<li>gcc时使用-D指定宏</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">CFLAGS += -DM1 -DM2<br>test:test.c<br>	gcc test.c -o test  $(CFLAGS)<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> main() &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> M1</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;M1\n&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> M2</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;M1\n&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>
<ol start="4">
<li><p>可以通过手机USB共享网络（手机热点有USB共享网络选项），连接至linux后设置IP即可联网。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DeepRS/p/15812385.html">Linux通过手机USB网络共享上网</a><br>相关命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">route<br>arp -a<br>ifconfig<br>tcpdump -i 网卡名<br>ip route add default via 192.168.xxx.xxx dev 网卡名<br></code></pre></td></tr></table></figure>
<p>相连的电脑只要一个电脑能够上网，其余电脑可将该电脑IP设置为默认路由，正确设置dns服务器即可上网，最好使用出名的DNS服务器（114.114.114.114  8.8.8.8）。<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/53958870">盘点国内外优秀公共DNS</a></p>
</li>
<li><p>UDP丢包率测试<br>server使用recvfrom接收数据包，返回值小于指定长度则退出while循环，输出接收数据包数目。<br>client使用sendto向server发送指定长度的数据包。<br>end程序向server发送一个小于指定长度的数据包，指示测试过程结束。<br>对比server接收的数据包数目与client发送的数据包数目，计算丢包率，client可开多个线程同时发送</p>
</li>
<li><p>宏定义常量时可以定义生僻的值而不是0 1之类常见的值</p>
</li>
<li><p>注意相等运算符别少写一个&#x3D;，可以使用0&#x3D;&#x3D;n的方式避免出错</p>
</li>
<li><p>printf是一个行缓冲函数，先写到缓冲区，满足条件后，才将缓冲区刷到对应文件中，刷缓冲区的条件如下：</p>
<blockquote>
<p>1 缓冲区填满<br>2 写入的字符中有”\n” “\r”<br>3 调用fflush手动刷新缓冲区<br>4 调用scanf要从缓冲区中读取数据时，也会将缓冲区内的数据刷新<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/alfiy/article/details/120732998">C printf()函数不显示输出内容</a></p>
</blockquote>
</li>
</ol>
<p>不过十四中提到的输出不打印的问题不是因为这个，因为在宏实现中已经加了换行符</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> printf(fmt, arg...) printk(KERN_ALERT <span class="hljs-string">&quot;%s&gt; &quot;</span> fmt <span class="hljs-string">&quot;\n&quot;</span>, __FUNCTION__, ##arg)</span><br></code></pre></td></tr></table></figure>

<ol start="11">
<li>使用U盘复制文件，原本6G的文件，只复制了4G，最后发现是文件系统本身（FAT32）的限制，可以重新格式化U盘或拆分该文件</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011198687/article/details/121576591">ubuntu系统关闭unattended upgrades无人值守更新功能</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt remove unattended-upgrades<br></code></pre></td></tr></table></figure></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46244851/article/details/106563776">移动硬盘无法弹出，显示被进程占用（system占用）</a><br><img src="https://img-blog.csdnimg.cn/23700c9673af4620a960cdca5749984a.png" srcset="/img/loading.gif" lazyload><br>关掉索引选项</li>
</ol>
<p>一些命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=file4 bs=1G count=1 <span class="hljs-comment"># 创建指定容量文件</span><br>scp file  yy@192.168.2.168:/home/yy/kylin/test_driver/test<br><span class="hljs-built_in">chmod</span> 777 . -R    <span class="hljs-comment"># 将当前目录所有文件rwx全部设置</span><br><span class="hljs-built_in">chown</span> yy:yy  . -R <span class="hljs-comment"># 设置当前目录所有文件拥有者</span><br>sysctl -w net.core.rmem_default=1821440<br>sysctl -w net.core.wmem_default=1821440<br>lsof -i:7890 <span class="hljs-comment"># 查看7890端口监听进程信息，有时候需要root权限</span><br></code></pre></td></tr></table></figure>

<p>使用FileZilla传输文件，Failed to convert command to 8 bit charset<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34372728/article/details/85924444">FileZilla出现Failed to convert command to 8 bit charset</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DengGao/p/6478164.html">linux-网络数据包抓取-tcpdump</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DengGao/p/tcp_parameter.html">tcp参数设置</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/penzchan/article/details/41682411">linux socket 缓存: core rmem_default rmem_max</a></p>
<p>重启解决部分问题，关机再开机解决大部分问题<br>重装系统解决绝大部分问题，换新设备解决一切问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">undef</span> MACRO_NAME <span class="hljs-comment">// 取消宏定义</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE1_BASE 100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE1_1 ERROR_TYPE1_BASE + 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE1_2 ERROR_TYPE1_BASE + 2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE2_BASE 200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE2_1 ERROR_TYPE2_BASE + 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE2_2 ERROR_TYPE2_BASE + 2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_TYPE3_BASE 300</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ERROR_TYPE3</span> &#123;</span> ERROR_TYPE3_1 = ERROR_TYPE3_BASE + <span class="hljs-number">1</span>, ERROR_TYPE3_2 &#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %d %d %d %d %d&quot;</span>, ERROR_TYPE1_1, ERROR_TYPE1_2, ERROR_TYPE2_1, ERROR_TYPE2_2, ERROR_TYPE3_1, ERROR_TYPE3_2); &#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">101 102 201 202 301 302</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>
<p>错误返回值可以不同类型定义在不同区间，枚举设置起始值，这样即使函数层层嵌套都能迅速找到错误位置。</p>
<p>在定义宏时记得加上括号，确保运算时的优先级，避免一些奇奇怪怪的问题。</p>
<p>Q：银河麒麟桌面操作系统V10 SP1（2107版本之后）安装应用时会反复提示安全授权认证，如何才能取消呢？<br>A：可以调整“检测应用程序来源”的级别状态为“关闭”来去除反复提示的安全授权认证，具体操作步骤：开始菜单-&gt;设置-&gt;安全与更新-&gt;安全中心-&gt;应用控制与保护-&gt;检查应用程序来源，选择“关闭任何来源的应用程序均可以安装”选项。</p>
<blockquote>
<p>quiet - this option tells the kernel to NOT produce any output (a.k.a. Non verbose mode). If you boot without this option, you’ll see lots of kernel messages such as drivers&#x2F;modules activations, filesystem checks and errors. Not having the quiet parameter may be useful when you need to find an error.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/716957/what-do-the-nomodeset-quiet-and-splash-kernel-parameters-mean">What do the nomodeset, quiet and splash kernel parameters mean?</a></p>
<p>Linux kernel - SSE register return with SSE disabled<br>SSE ： streaming SIMD extensions</p>
<p>这是 Intel 在 1999年推出 Pentium 3 时， 所推出的一种 SIMD 指令集.<br>新增八个 128bit 暂存器 xmm0~xmm7， 用来存放四个 32bit 单精准度的浮点数</p>
<p>Linux kernel 做 context switch 时， 需要储存所有暂存器， 这会增加 overhead，<br>因此在 kernel 会倾向不使用浮点数计算， 而在 kernel compile 时， 也会带上 compile options：</p>
<p>-mno-sse -mno-mmx -mno-sse2</p>
<p><a target="_blank" rel="noopener" href="https://njiot.blogspot.com/2019/12/linux-kernel-sse-register-return-with.html">Linux kernel - SSE register return with SSE disabled</a></p>
<p>在驱动开发过程中，需要明确自己的工作步骤，遇到的问题以及解决问题的思路与方法，在遇到瓶颈时可以尝试与周围人沟通探讨问题原因，与领导交流工作进展，有些时候沟通比死写代码更能解决问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">tldr <span class="hljs-built_in">df</span><br><span class="hljs-built_in">df</span><br>Gives an overview of the filesystem disk space usage.More information: https://www.gnu.org/software/coreutils/df.<br><br> - Display all filesystems and their disk usage:<br>   <span class="hljs-built_in">df</span><br><br> - Display all filesystems and their disk usage <span class="hljs-keyword">in</span> human-readable form:<br>   <span class="hljs-built_in">df</span> -h<br><br> - Display the filesystem and its disk usage containing the given file or directory:<br>   <span class="hljs-built_in">df</span> &#123;&#123;path/to/file_or_directory&#125;&#125;<br><br> - Display statistics on the number of free inodes:<br>   <span class="hljs-built_in">df</span> -i<br><br> - Display filesystems but exclude the specified types:<br>   <span class="hljs-built_in">df</span> -x &#123;&#123;squashfs&#125;&#125; -x &#123;&#123;tmpfs&#125;&#125;<br></code></pre></td></tr></table></figure>

<h3 id="网卡ioctl用户程序"><a href="#网卡ioctl用户程序" class="headerlink" title="网卡ioctl用户程序"></a>网卡ioctl用户程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if_arp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/route.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEST_CMD 0x89F3</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifreq</span> <span class="hljs-title">ifr</span> =</span> &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-built_in">memset</span>(&amp;ifr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ifr));<br>  ifr.ifr_addr.sa_family = AF_INET;<br>  <span class="hljs-type">int</span> data = <span class="hljs-number">1</span>;<br>  ifr.ifr_ifru.ifru_data = (<span class="hljs-type">void</span> *)&amp;data; <span class="hljs-comment">// 传递用户数据</span><br>  <span class="hljs-built_in">strcpy</span>(ifr.ifr_name, <span class="hljs-string">&quot;网卡名&quot;</span>);<br>  <span class="hljs-type">int</span> fd = socket(AF_INET, SOCK_DGRAM, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (fd &lt;= <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;create socket fd failed&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-type">int</span> ret = ioctl(fd, TEST_CMD, &amp;ifr);<br>  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ioctl failed,%d %d\n&quot;</span>, ret, errno);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="UDP广播程序"><a href="#UDP广播程序" class="headerlink" title="UDP广播程序"></a>UDP广播程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 发送端</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">int</span> sock = <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">if</span> ((sock = socket(AF_INET, SOCK_DGRAM, <span class="hljs-number">0</span>)) == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;socket error&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> opt = <span class="hljs-number">1</span>;<br>  <span class="hljs-comment">//设置该套接字为广播类型，</span><br>  <span class="hljs-type">int</span> nb = <span class="hljs-number">0</span>;<br>  nb = setsockopt(sock, SOL_SOCKET, SO_BROADCAST, (<span class="hljs-type">char</span> *)&amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br>  <span class="hljs-keyword">if</span> (nb == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set socket error...&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-comment">//指定Server IP  和  发送给Client的端口</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addrto</span>;</span><br>  bzero(&amp;addrto, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>  addrto.sin_family = AF_INET;<br>  addrto.sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;192.168.2.255&quot;</span>);<br>  addrto.sin_port = htons(<span class="hljs-number">7890</span>);<br>  <span class="hljs-type">int</span> nlen = <span class="hljs-keyword">sizeof</span>(addrto);<br>  <span class="hljs-type">char</span> *msg = <span class="hljs-string">&quot;abcdef&quot;</span>;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//从广播地址发送消息</span><br>    <span class="hljs-type">int</span> ret = sendto(sock, msg, <span class="hljs-built_in">strlen</span>(msg), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;addrto, nlen);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;send error\n&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ok\n&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// 接收端</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/route.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if_arp.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXBUF 2000</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server_addr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client_addr</span>;</span><br>  <span class="hljs-type">int</span> addr_size = <span class="hljs-keyword">sizeof</span>(client_addr);<br>  <span class="hljs-type">char</span> buf[MAXBUF];<br>  <span class="hljs-type">int</span> cc;<br>  <span class="hljs-type">int</span> server_sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);<br><br>  <span class="hljs-built_in">memset</span>(&amp;server_addr, <span class="hljs-number">0</span>, addr_size);<br>  server_addr.sin_family = AF_INET;<br>  server_addr.sin_addr.s_addr = htons(INADDR_ANY); <span class="hljs-comment">// inet_addr(&quot;192.168.2.123&quot;);</span><br>  server_addr.sin_port = htons(<span class="hljs-number">7890</span>);<br>  cc = bind(server_sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_addr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr));<br>  <span class="hljs-keyword">if</span> (cc &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bind error\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bind success\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;listen packet\n&quot;</span>);<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    cc = recvfrom(server_sock, buf, MAXBUF, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_addr, &amp;addr_size);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; recv msg is %s\n&quot;</span>, buf);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>重点在于发送端调用setsockopt设置为广播类型，接收端绑定INADDR_ANY而不是特定网卡地址<br><img src="https://img-blog.csdnimg.cn/7262090144b340dcb73c29401af7cef4.png" srcset="/img/loading.gif" lazyload><br><img src="https://img-blog.csdnimg.cn/6df940482ea947b5bb44ef6a15d3be26.png" srcset="/img/loading.gif" lazyload><br>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_36750623/article/details/83575412">UDP之广播</a></p>
<h3 id="UDP组播"><a href="#UDP组播" class="headerlink" title="UDP组播"></a>UDP组播</h3><p>组播背景知识：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/27233903">组播IP地址到底是谁的IP？？</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/fengxingzhe008/article/details/128402917">组播IGMP-原理介绍+报文分析+配置示例</a></p>
<p>相关代码：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhizhengguan/article/details/109312144">Linux C&#x2F;C++编程：Udp组播（多播）</a></p>
<p>wireshark抓包显示：<br>发送端：192.168.252.135<br><img src="https://img-blog.csdnimg.cn/ae3d29df2c13471fb61b0b85e0416c57.png" srcset="/img/loading.gif" lazyload><br>接收端：192.168.252.141<br><img src="https://img-blog.csdnimg.cn/b6e58bc5d8f342b19f3bfd5bdc821010.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/downey-blog/p/10486907.html">linux内核可加载模块的makefile</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/downey-blog/p/10486863.html">linux内核makefile概览</a><br><a target="_blank" rel="noopener" href="https://runsisi.com/2020/03/09/kernel-module-includes/">内核模块中使用本地头文件</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/mayue_web/article/details/84571953">Linux下头文件搜索路径</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/aqing1987/p/4404223.html">linux 内核头文件及内核库文件</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiading/articles/12296147.html">Linux内核头文件</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Jimmy1988/p/7485133.html">Linux errno详解</a><br><a target="_blank" rel="noopener" href="https://deepinout.com/linux-kernel-api">Linux内核API</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/360960074">Linux Kernel 学习的一些资源</a><br><a target="_blank" rel="noopener" href="https://linux.cn/article-9665-1.html">如何编译 Linux 内核</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42915431/article/details/106614841">Ubuntu Linux内核版本升级或降级到指定版本（基于ubuntu 18.04示例）</a><br><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/block/blk-mq.html">Multi-Queue Block IO Queueing Mechanism (blk-mq)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%B8%A9%E5%9D%91%E6%97%A5%E8%AE%B0/" class="category-chain-item">踩坑日记</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/" class="category-chain-item">内核驱动开发记录</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E7%BD%91%E5%8D%A1%E9%A9%B1%E5%8A%A8-%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8-%E8%B8%A9%E5%9D%91/" class="print-no-link">#块设备驱动 网卡驱动 内核驱动 踩坑</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html" title="计算机读书笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">计算机读书笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/recv%E5%94%A4%E9%86%92%E6%97%B6%E6%9C%BA.html" title="recv唤醒时机">
                        <span class="hidden-mobile">recv唤醒时机</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"uU0wegCOTLXqtIgWmhAD3MFq-gzGzoHsz","appKey":"0e2MMh7ddBCGGytOe9UEy5NP","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://uu0wegco.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
